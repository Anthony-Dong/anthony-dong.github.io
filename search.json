[{"title":"ä½¿ç”¨Hexo+Nextæ­å»ºä¸ªäººåšå®¢","url":"/2022/03/17/093375c998745d381f00dcaac184ef81/","content":"åˆ†äº«ä¸€ä¸‹ä¸ªäººåšå®¢æ­å»ºï¼Œæœ¬äººæ˜¯æœ‰ä¸€ä¸ªä¸ªäººçš„ç§æœ‰ä»“åº“ï¼Œç„¶åå‘¢ç§æœ‰ä»“åº“å†…æœ‰äº›æ„Ÿè§‰å†™çš„å¯ä»¥æ–‡ç« ä¼šåˆ†äº«åˆ°è‡ªå·±çš„åšå®¢ä¸Šï¼Œä½†æ˜¯ç”¨Hexo+Nextä¸»é¢˜å§ï¼Œå‘ç°å“‡ä½¿ç”¨èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜éœ€è¦copyæ¥copyå»çš„ï¼Œæ‰€ä»¥è‡ªå·±å†™äº†ä¸€äº›è„šæœ¬æ–¹ä¾¿ä½¿ç”¨å’Œæ“ä½œï¼ä¸»è¦æ˜¯ä¸ºäº†å‚»ç“œå¼çš„ä½¿ç”¨ï¼åŒæ—¶å¸®åŠ©æ¢ä¸ªå·¥ä½œç”µè„‘å¯èƒ½å°±è·‘ä¸èµ·æ¥äº†ï¼Œæ‰€ä»¥å†™ä¸€ç¯‡æ–‡ç« è®°å½•ä¸‹ï¼åŒæ—¶æœ¬æ–‡ä¹Ÿä¼šåˆ†äº«ä¸€äº›Hexoçš„æ’ä»¶ï¼Œæ¯”å¦‚æ”¯æŒæµç¨‹å›¾å’ŒUMLï¼Œä»¥åŠä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨gulpå‹ç¼©ä»£ç ï¼\n\n\n1. ç¯å¢ƒ\nç¯å¢ƒï¼š Linux or Mac ï¼ˆåæœŸä¼šå¢åŠ Windowsç¯å¢ƒï¼Œä¸»è¦æ˜¯ä¸ä¼šå†™windowsçš„è„šæœ¬ï¼ï¼‰\nåˆ›å»ºä¸€ä¸ªè´¦å·ï¼šGitHub ä¸ªäººè´¦å·ï¼Œä¾‹å¦‚æˆ‘çš„ä¸ªäººè´¦å·æ˜¯ Anthony-Dong\nåˆ›å»ºä¸€ä¸ªä»“åº“ï¼šGitHubä»“åº“ï¼Œä¾‹å¦‚æˆ‘çš„ä»“åº“åæ˜¯ anthony-dong.github.ioï¼Œæ ¼å¼å°±æ˜¯&#123;ä¸ªäººè´¦å·åç§°&#125;.github.ioï¼Œæ³¨æ„éƒ½è¦å°å†™ï¼Œä»“åº“åœ°å€ https://github.com/Anthony-Dong/anthony-dong.github.io\nä¸‹è½½æˆ‘çš„åšå®¢æ¨¡ç‰ˆåˆ°æœ¬åœ°ï¼Œé¡¹ç›®åœ°å€: https://github.com/Anthony-Dong/blog_template\n\nwget https://github.com/Anthony-Dong/blog_template/archive/refs/heads/master.zipunzip master.zip\n\n\nå¯åŠ¨é¡¹ç›®\n\n\né…ç½®å‚æ•°( å¦‚æœä½ æœ¬åœ°æœ‰dockerä¸”å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œç›´æ¥ make init run èµ·æ¥äº†ï¼Œä¸‹é¢å¯ä»¥ä¸çœ‹äº†ï¼)\n\n\nå¦‚æœä½ çš„ç¯å¢ƒä¾èµ–æœ¬åœ°éƒ½æœ‰ï¼Œåªéœ€è¦æŠŠ EXEC_TYPE := docker æ”¹æˆ EXEC_TYPE := å³å¯\n\næ³¨æ„: å¦‚æœä½ ç”¨ç¯å¢ƒä¾èµ–æŒ‡çš„æ˜¯ node+hexoç¯å¢ƒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä½ éœ€è¦å®‰è£… node.js 16.3 ç‰ˆæœ¬ + hexo 4.3.0 ç‰ˆæœ¬ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„å®‰è£…æ–¹å¼ï¼\n\n# å®‰è£… node.jsï¼Œå¦‚æœä½ æ˜¯macç¯å¢ƒå®Œå…¨å¯ä»¥ä¸‹é¢è¿™æ ·å®‰è£…brew install node@16# å…¶ä»–ç¯å¢ƒï¼Œéœ€è¦ä¸‹è½½ https://nodejs.org/dist/v16.3.0/ æºç è¿›è¡Œå®‰è£…ï¼# å®‰è£… hexo, è¿™é‡Œé…ç½®taobaoçš„æºï¼Œæ¯”è¾ƒå¿«ï¼npm config set registry https://registry.npm.taobao.orgnpm install hexo-cli@4.3.0 -g# å®‰è£…gulp å‹ç¼©html/js/cssnpm install gulp-cli -g  # cli-version: 2.3.0, local-version: 4.0.2\n\n\nåˆå§‹åŒ–ç¯å¢ƒ: æ‰§è¡Œ make init run å³å¯ï¼\nå…·ä½“å¸®åŠ©å‘½ä»¤\n\nâœ  note-master git:(master) âœ— make push                  pushé¡¹ç›®åˆ°è¿œç¨‹ create                åˆ›å»ºåšå®¢æ–‡ä»¶çš„å¤´éƒ¨ä¿¡æ¯ init                  åˆå§‹åŒ–æ•´ä¸ªé¡¹ç›®[ç¬¬ä¸€æ¬¡æ‰§è¡Œä¼šæ¯”è¾ƒæ…¢] build                 é‡æ–°æ„å»ºç½‘ç«™ run                   å¯åŠ¨ç½‘ç«™ deploy                å‘å¸ƒåˆ°ä¸ªäººç½‘ç«™ help                  å¸®åŠ©\n\n2. å¿«é€Ÿä¿®æ”¹é…ç½®\nä¿®æ”¹é…ç½®æ–‡ä»¶hexo-home/_config.yml ï¼Œ åªéœ€è¦ä¿®æ”¹æˆ‘ä¸‹é¢æ ‡æ³¨çš„ï¼\n\n# Sitetitle: æŠ€æœ¯å°ç™½  # ç½‘ç«™æ ‡é¢˜subtitle: &#x27;æŠ€æœ¯å°ç™½çš„æŠ€æœ¯åšå®¢&#x27; # ç½‘ç«™ä»‹ç»keywords: # ç½‘ç«™å…³é”®è¯  - Hexo  - Node.js  - Flinkdescription: &#x27;æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹!&#x27; # ä¸ªæ€§ç­¾åauthor: xiao-bai # ä½œè€…åç§°# URL## Set your site url here. For example, if you use GitHub Page, set url as &#x27;https://username.github.io/project&#x27;url: https://xiao-bai.github.io/ # ä½ çš„åšå®¢åœ°å€ï¼Œä¸€èˆ¬ä½ éƒ¨ç½²åœ¨githubçš„è¯## Docs: https://hexo.io/docs/one-command-deploymentdeploy:  type: git  repo: git@github.com:xiao-bai/xiao-bai.github.io.git # ä½ ä»“åº“çš„åœ°å€  branch: master\n\n\nä¿®æ”¹é…ç½®æ–‡ä»¶ hexo-home/themes/next/_config.yml , ç®€å•ä½¿ç”¨åªéœ€è¦æ›¿æ¢ä»¥ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œé«˜çº§ä½¿ç”¨è¯·çœ‹å®˜æ–¹æ–‡æ¡£: https://github.com/iissnan/hexo-theme-next\n\n# ä¸‹é¢çš„è”ç³»åœ°å€å¯ä»¥æ”¹æˆä½ çš„ï¼ä½ ä¹Ÿå¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶æ·»åŠ social:  GitHub: https://github.com/anthony-dong || fab fa-github  E-Mail: mailto:fanhaodong516@gmail.com || fa fa-envelope  æ˜é‡‘: https://juejin.cn/user/4248168663101320 || fas fa-book  å›½å†…é‚®ç®±: mailto:fanhaodong516@163.com || fa fa-envelope  # è¿™ä¸ªæ›¿æ¢æˆçš„è¯æœ¯å°±è¡Œäº†ï¼Œä¸éœ€è¦çš„è¯å¯ä»¥ enable: false å…³é—­reward_settings:  # If true, reward will be displayed in every article by default.  enable: true  animation: false  comment: æœ¬äººåšæŒåŸåˆ›æŠ€æœ¯åˆ†äº«ï¼Œå¦‚æœä½ è§‰å¾—æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµ! å¦‚æœæœ‰éœ€è¦å’¨è¯¢çš„è¯·å‘é€åˆ°æˆ‘çš„é‚®ç®±! # ä½ çš„æ”¶æ¬¾ç ï¼Œä¸éœ€è¦çš„è¯å¯ä»¥æ³¨é‡Šæ‰ï¼reward:  wechatpay: /images/wechatpay.png  alipay: /images/alipay.png# è¿™ä¸ªæ›¿æ¢æˆä½ çš„githubå°±è¡Œäº†ï¼Œä¸éœ€è¦çš„è¯å¯ä»¥  enable: false å…³é—­github_banner:  enable: true  permalink: https://github.com/Anthony-Dong  title: Follow me on GitHub\n\n\nä¿®æ”¹ä»¥ä¸‹è·¯å¾„çš„å›¾ç‰‡ï¼Œæ›¿æ¢æˆä½ çš„å›¾ç‰‡\n\nhexo-home/themes/next/source/images/alipay.png   ä½ çš„æ”¯ä»˜å®æ”¶æ¬¾ç hexo-home/themes/next/source/images/wechatpay.png  ä½ çš„å¾®ä¿¡æ”¶æ¬¾ç hexo-home/themes/next/source/images/avatar.png  ä½ çš„å¤´åƒhexo-home/themes/next/source/images/favicon.ico ä½ ç½‘ç«™çš„icon\n\n\nä¿®æ”¹ä¸ªäººç®€ä»‹ï¼Œå¯ä»¥ä¿®æ”¹æ­¤æ–‡ä»¶: hexo-home/source/about/index.md å³å¯ï¼\nå¦‚æœå¼€å¯ç™¾åº¦ç»Ÿè®¡ï¼Œåªéœ€è¦ä¿®æ”¹hexo-home/themes/next/_config.ymlæ­¤æ–‡ä»¶å³å¯!  appidæ˜¯hm.src = &quot;https://hm.baidu.com/hm.js?&#123;app_id&#125;&quot;; æœ€åé‚£ä¸ªIDï¼\n\n# Baidu Analyticsbaidu_analytics: # &lt;app_id&gt;\n\n3. æ·»åŠ è¯„è®ºæ’ä»¶\né¦–å…ˆå‰å¾€é“¾æ¥: Register a new OAuth application åˆ›å»ºä¸€ä¸ª Auth APP , ç”³è¯·é¡µé¢å¦‚ä¸‹ï¼Œå¯ä»¥æ ¹æ®æˆ‘çš„æ³¨é‡Šè¿›è¡Œå¡«å†™\n\n\n\nç”³è¯·å®Œæˆåå¯ä»¥åœ¨é¡µé¢ä¸ŠæŸ¥çœ‹  client-id å’Œ secret-id\n\n\n\nç„¶åä¿®æ”¹hexo-home/themes/next/_config.ymlæ·»åŠ  gitalk è¯„è®ºç³»ç»Ÿ\n\n# Gitalk# For more information: https://gitalk.github.io, https://github.com/gitalk/gitalkgitalk:  enable: true  # æ˜¯å¦å¼€å¯  github_id: xiao-bai # ä½ çš„GitHubç”¨æˆ·å  repo: xiao-bai.github.io # ä½ ä»“åº“çš„åœ°å€  client_id: xxxx # ä¸Šé¢ç”³è¯·æ‹¿åˆ°çš„ client-id  client_secret: xxxxxx  # ä¸Šé¢ç”³è¯·æ‹¿åˆ°çš„ secret-id  admin_user: xiao-bai  # ä½ çš„GitHubåç§°ï¼Œæ³¨æ„å¤§å°å†™  distraction_free_mode: true # è®¾ç½®ä¸ºtrue  language: #ä¸ç”¨åŠ¨ï¼\n\nåŒæ—¶æ³¨æ„ä¸€ä¸‹çœ‹ä¸€ä¸‹æ˜¯å¦å­˜åœ¨hexo-home/themes/next/layout/_custom/sidebar.swigä»¥ä¸‹å†…å®¹ï¼Œä¸å­˜åœ¨å¯ä»¥å¤åˆ¶ä¸€ä¸‹\n&#123;% if page.comments and config.gitalk.enable %&#125;&#123;% endif %&#125;\n\n\næå®Œä»¥åè®°å¾—é‡æ–°buildä¸‹ make build ä¸‹ï¼Œç„¶å make run å¯åŠ¨å°±è¡Œäº†\næ‰“å¼€é¡µé¢ä¼šé‡åˆ°è¿™ç§æƒ…å†µ Related Issues not found , è¿™æ—¶å€™ä½ å…¶å®å·²ç»æˆåŠŸäº†ï¼Œmake deployå‘å¸ƒå°±è¡Œäº†ï¼\n\n\nè¿™æ—¶å€™éœ€è¦ä½ ç™»é™†ä½ çš„GitHubè´¦å·ï¼Œç„¶åä»–å°±ä¼šè‡ªåŠ¨å¸®ä½ åˆå§‹åŒ–issues!  \næ³¨æ„ï¼š \n\nä½ æ¯å‘å¸ƒä¸€ç¯‡æ–‡ç« éƒ½éœ€è¦ä½ æ‰“å¼€é¡µé¢åˆå§‹åŒ–ä¸‹ä¸€Issuesï¼\nä½ æœ¬åœ°http://localhost:4000 è®¿é—®æ— æ³•åˆ›å»ºIssuesçš„ï¼\n\n\næ‰“å¼€ä½ çš„ä»“åº“çš„Issuesé¡µé¢å°±å¯ä»¥çœ‹åˆ°åˆ›å»º issues äº†ï¼\n\n\n4. æ”¯æŒmermain(æµç¨‹å›¾)\nåœ¨ç›®å½• hexo-home æ‰§è¡Œ npm install hexo-filter-mermaid-diagrams --save ï¼Œ æˆ‘å®‰è£…çš„æ˜¯1.0.5^ç‰ˆæœ¬\nä¿®æ”¹é…ç½®æ–‡ä»¶hexo-home/themes/next/_config.yml \n\n# Mermaid tagmermaid:  enable: true  # Available themes: default | dark | forest | neutral  theme: forest\n\næ³¨æ„æ›´å¤šé…ç½®å¯ä»¥å‚è€ƒ: mermaid-js æ–‡æ¡£ , éœ€è¦é…åˆä¸€èµ·ä¿®æ”¹ hexo-home/themes/next/layout/_third-party/tags/mermaid.swig æ–‡ä»¶ï¼\n\nä¿®æ”¹cssæ ·å¼ï¼Œåœ¨æ–‡ä»¶ hexo-home/themes/next/source/css/_colors.styl æœ«å°¾æ·»åŠ \n\n.mermaid &#123; background: transparent; text-align: center;&#125;\n\n\nåˆ‡è®°ä¸€å®šè¦å…³é—­ pjax, éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶hexo-home/themes/next/_config.ymlï¼ŒåŸå› æ˜¯åˆ‡æ¢é¡µé¢éœ€è¦é‡æ–°æ¸²æŸ“æµç¨‹å›¾ï¼Œå¦‚æœå¼€å¯åˆ‡æ¢é¡µé¢çš„æ—¶å€™ä¸ä¼šå¸®ä½ æ¸²æŸ“ï¼ï¼\n\n# Easily enable fast Ajax navigation on your website.# Dependencies: https://github.com/theme-next/theme-next-pjaxpjax: false\n\n5. æ”¯æŒflowchart (æµç¨‹å›¾)\nåœ¨ç›®å½•hexo-home æ‰§è¡Œ npm install --save hexo-filter-flowchart  ï¼Œæˆ‘å®‰è£…çš„ç‰ˆæœ¬æ˜¯1.0.4ï¼\nä¿®æ”¹é…ç½®æ–‡ä»¶ hexo-home/_config.yml , é»˜è®¤çš„sdkç‰ˆæœ¬è¿‡ä½ï¼Œå¯èƒ½æ”¯æŒä¸å¤ªå¥½ï¼Œæ‰€ä»¥éœ€è¦æ›´æ¢ä¸€ä¸‹ï¼\n\n# flowchartä½¿ç”¨ hexo-filter-flowchart https://github.com/bubkoo/hexo-filter-flowchartflowchart:  raphael: &quot;https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js&quot;  # optional, the source url of raphael.js  flowchart: &quot;https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js&quot; # optional, the source url of flowchart.js  options: # options used for `drawSVG`    scale: 1    line-width: 2    line-length: 50    text-margin: 10    font-size: 12\n\n\nå…·ä½“æ›´å¤šé…ç½®å¯ä»¥å‚è€ƒæ–‡æ¡£: hexo-filter-flowchart\n\n6. å‹ç¼©HTMLã€JSã€CSSç›®å‰hexoç”Ÿæˆçš„ä»£ç ï¼Œå…¨éƒ¨éƒ½æ˜¯æœªå‹ç¼©ï¼Œç›®å‰å‰ç«¯ä¸»æµçš„æ–¹å¼éƒ½æ˜¯ä½¿ç”¨webpackå’Œgulpè¿›è¡Œå‹ç¼©ï¼Œä½†æ˜¯webpackè¿™å—æœ¬äººä¹Ÿæœªæœç´¢åˆ°ç›¸å…³èµ„æ–™ï¼Œæ‰€ä»¥ç”¨çš„gulpè¿›è¡Œå‹ç¼©ï¼\n\nå®‰è£… gulpï¼Œæ‰§è¡Œ npm install --global gulp-cli\nå®‰è£…å…¶ä»–æ’ä»¶\n\n\ngulp:  æ ¸å¿ƒæ¡†æ¶\ngulp-clean-css: å‹ç¼©cssä»£ç \ngulp-uglify: å‹ç¼©jsä»£ç ï¼Œè¿™ä¸ªä¸æ”¯æŒes6\n**gulp-uglify-es**ï¼šå‹ç¼©jsä»£ç ï¼Œæ”¯æŒes6\ngulp-htmlcleanï¼šå‹ç¼©htmlä»£ç ï¼Œæ¸…é™¤ç©ºæ ¼å’Œæ¢è¡Œç¬¦\ngulp-htmlminï¼šå‹ç¼©htmlçš„js/cssä»£ç ç­‰ï¼Œä½†æ˜¯æ”¯æŒåº¦ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œæ¯”å¦‚jsä»£ç æ— æ³•å‹ç¼©æˆè¡Œï¼\ngulp-html-minifier-terserï¼š å‹ç¼©htmlçš„js/cssä»£ç ï¼Œæ”¯æŒå‹ç¼©js(å…¼å®¹es6)\n\n\nå®‰è£…ä¾èµ–\n\nnpm install gulp gulp-clean-css gulp-uglify-es gulp-html-minifier-terser\n\n\né…ç½®æ–‡ä»¶\n\nvar gulp = require(&#x27;gulp&#x27;)var minifycss = require(&#x27;gulp-clean-css&#x27;);const uglify = require(&#x27;gulp-uglify-es&#x27;).default;const htmlmin = require(&#x27;gulp-html-minifier-terser&#x27;);gulp.task(&#x27;compress_css&#x27;, function () &#123;    return gulp.src(&#x27;./public/**/*.css&#x27;)        .pipe(minifycss(&#123; compatibility: &#x27;ie8&#x27; &#125;)) // å…¼å®¹åˆ°IE8        .pipe(gulp.dest(&#x27;./public&#x27;));&#125;);gulp.task(&#x27;compress_js&#x27;, function () &#123;    return gulp.src(&#x27;./public/**/*.js&#x27;)        .pipe(uglify())        .pipe(gulp.dest(&#x27;./public&#x27;))&#125;)// æ³¨æ„æŠ¥é”™å¯ä»¥æ’å‡ºç›®å½•ï¼é˜²æ­¢ç”Ÿæˆå¤±è´¥ï¼// å¯æ¥å—å‚æ•°çš„æ–‡æ¡£ï¼šhttps://github.com/terser/html-minifier-terser#options-quick-referencegulp.task(&#x27;compress_html&#x27;, function () &#123;    return gulp.src([&#x27;./public/**/*.html&#x27;, &#x27;!./public/2022/03/27/583186f06a088dc9967a483e3876b2a2/index.html&#x27;])        .pipe(htmlmin(            &#123;                removeComments: true, // ç§»é™¤æ³¨é‡Š                removeEmptyAttributes: true, // ç§»é™¤å€¼ä¸ºç©ºçš„å‚æ•°                removeRedundantAttributes: true, // ç§»é™¤å€¼è·Ÿé»˜è®¤å€¼åŒ¹é…çš„å±æ€§                collapseBooleanAttributes: true, // çœç•¥å¸ƒå°”å±æ€§çš„å€¼                collapseWhitespace: true, // ç§»é™¤ç©ºæ ¼å’Œç©ºè¡Œ                                minifyJS: true, // å‹ç¼©HTMLä¸­çš„JS                minifyCSS: true, // å‹ç¼©HTMLä¸­çš„CSS                minifyURLs: true, // å‹ç¼©HTMLä¸­çš„é“¾æ¥            &#125;        ))        .pipe(gulp.dest(&#x27;./public&#x27;))&#125;)// é»˜è®¤ä»»åŠ¡ï¼Œä¸å¸¦ä»»åŠ¡åè¿è¡Œgulpæ—¶æ‰§è¡Œçš„ä»»åŠ¡gulp.task(&#x27;default&#x27;, gulp.parallel(    &#x27;compress_css&#x27;, &#x27;compress_js&#x27;, &#x27;compress_html&#x27;));\n\n\nå‚è€ƒæ–‡ç« \n\nhttps://blog.inkuang.com/2021/405/\n7. å…¶ä»–BUGä¿®å¤1. å›¾ç‰‡è®¾ç½® style=&quot;zoom: 50%;&quot; å¯¼è‡´å›¾ç‰‡æ”¾å¤§å±•ç¤ºå¤±è´¥èƒŒæ™¯ï¼šç›®å‰typoraå…¶å®å¯ä»¥ç¼©æ”¾å›¾ç‰‡ï¼Œå¯¼è‡´ä½¿ç”¨ medium-zoom å¯èƒ½å‡ºç°bugï¼Œå‚è€ƒ issues#164 æˆ‘å¤§æ¦‚æ”¹äº†ä¸€ç‰ˆæœ¬ï¼\n\nä¿®æ”¹æ–‡ä»¶: hexo-home/themes/next/source/js/next-boot.js\n\n// ä¿®æ”¹æ­¤è¡Œä»£ç // CONFIG.mediumzoom &amp;&amp; window.mediumZoom(&#x27;.post-body :not(a) &gt; img, .post-body &gt; img&#x27;);// ä¸ºè¿™ä¸ªCONFIG.mediumzoom &amp;&amp; NexT.utils.mediumZoomFunc();\n\n\nä¿®æ”¹æ–‡ä»¶: hexo-home/themes/next/source/js/utils.js , æ·»åŠ mediumZoomFunc æ–¹æ³•ï¼\n\nmediumZoomFunc: function () &#123;  const zoom = mediumZoom(&#x27;.post-body :not(a) &gt; img, .post-body &gt; img&#x27;);  // å¼€å¯çš„æ—¶å€™å–æ¶ˆæ‰ style.zoom  zoom.on(&#x27;open&#x27;, event =&gt; &#123;    var curentNodeAlt = event.target.alt;    document.querySelectorAll(&#x27;.medium-zoom-image&#x27;).forEach(elem =&gt; &#123;      if (elem.style.zoom == &#x27;&#x27;) &#123;        return;      &#125;      if (elem.alt != curentNodeAlt) &#123;        return;      &#125;      elem.alt = elem.alt + &#x27;|&#x27; + elem.style.zoom      elem.style.zoom = &#x27;&#x27;    &#125;);  &#125;)  // å…³é—­çš„æ—¶å€™ é‡æ–°set style.zoom  zoom.on(&#x27;closed&#x27;, event =&gt; &#123;    var curentNodeAlt = event.target.alt;    document.querySelectorAll(&#x27;.medium-zoom-image&#x27;).forEach(elem =&gt; &#123;      if (elem.alt != curentNodeAlt) &#123;        return;      &#125;      var elemAltLastIndex = elem.alt.lastIndexOf(&#x27;|&#x27;)      if (elemAltLastIndex == -1) &#123;        return;      &#125;      elem.style.zoom = elem.alt.substring(elemAltLastIndex + 1)      elem.alt = elem.alt.substring(0, elemAltLastIndex)    &#125;);  &#125;)&#125;\n\n8. é…ç½® Tool ä¸€èµ·ä½¿ç”¨1. åˆ›å»ºä¸€ç¯‡æ–‡ç«  or æ ‡æ³¨ä¸€ç¯‡æ–‡ç« \næ‰§è¡Œä¸‹é¢å‘½ä»¤make create ï¼Œä¼šç”Ÿæˆä¸€ä¸ªé¡µçœ‰ï¼Œä½ åªéœ€è¦æŠŠè¿™ä¸ªä¸œè¥¿ copy åˆ°ä½ çš„æ–‡ç« ä¸­å»ï¼\n\n\n\næ‰¾åˆ°ä½ çš„æ–‡ç« ï¼Œå†™ä¸€äº›æè¿°ä¿¡æ¯ï¼Œä¾‹å¦‚æˆ‘è¿™ç¯‡æ–‡ç« å°±æ˜¯è¿™ä¹ˆå†™çš„ï¼\n\n\n2. å‘å¸ƒåˆ°ç½‘ç«™ä¸Š\næœ¬åœ°æ„å»ºä¸€ä¸‹make runï¼Œçœ‹çœ‹è¯¦æƒ…ä¿¡æ¯\n\nâœ  note-master git:(master) âœ— make runbin/go-tool hexo --dir ./ --target_dir ./hexo-home/source/_posts2022/03/17 21:53:00.668245 api.go:63: [INFO] [hexo] command load config:....13:53:40.106 DEBUG Processed: layout/_third-party/search/localsearch.swig13:53:40.366 DEBUG Generator: page13:53:40.367 DEBUG Generator: post13:53:40.367 DEBUG Generator: category13:53:40.367 DEBUG Generator: archive13:53:40.367 DEBUG Generator: json13:53:40.368 DEBUG Generator: index13:53:40.368 DEBUG Generator: tag13:53:40.371 DEBUG Generator: asset13:53:40.403 INFO  Hexo is running at http://localhost:4000 . Press Ctrl+C to stop.13:53:40.425 DEBUG Database saved13:53:59.402 DEBUG Rendering HTML index: index.html\n\n\nç„¶åè®¿é—® http://localhost:4000 å³å¯ï¼çœ‹åˆ°ç½‘é¡µ\n\n\n\næœ€åæ²¡é—®é¢˜ï¼Œæ‰§è¡Œmake deploy å³å¯å‘å¸ƒåˆ°è¿œç¨‹ç½‘ç«™äº†ï¼\n\nmake deploy\n\n3. é«˜çº§åŠŸèƒ½1. æ•æ„Ÿå…³é”®å­—è¿‡æ»¤è¿™ä¸ªæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå…¬å¸ä¼šæœ‰å®‰å…¨å›¢é˜Ÿæ‰«æå¼€æºä»“åº“ï¼Œå‡å¦‚ä½ æ¶‰åŠåˆ°å…¬å¸æ•æ„Ÿå­—çœ¼ä¹Ÿæ¯”è¾ƒæ¶å¿ƒï¼Œæ¯”å¦‚æŠŠä½ ä¸ªäººä¿¡æ¯æš´éœ²äº†ï¼ä½†æ˜¯è¦çŸ¥é“ä¸èƒ½å‘å¸ƒå…¬å¸å†…éƒ¨çš„æ–‡ç« ä¸Šä¼ å‡ºå»ï¼Œæˆ–è€…å…¬å¸å†…éƒ¨çš„ä»£ç ï¼Œè¿™ä¸ªæ˜¯ä»»ä½•å…¬å¸çš„çº¢çº¿ï¼åˆ‡è®°ï¼Œè¿™ä¸ªæ’ä»¶ä¸»è¦å°±æ˜¯è¿‡æ»¤ä¸€äº›å…¬å¸çš„åå­—è€Œå·²ï¼\né…ç½®æ–‡ä»¶åœ¨: ä½ åªéœ€è¦åˆ—å‡ºæ•æ„Ÿè¯å³å¯ï¼åœ¨KeyWordåœ°æ–¹ï¼\nHexo:  KeyWord:    - &quot;æ•æ„Ÿè¯&quot;    - &quot;æ•æ„Ÿè¯2&quot;  Ignore:    - hexo-home\n\n2. å›¾ç‰‡ä¸Šä¼ ç›®å‰æˆ‘ä½¿ç”¨çš„æ˜¯æˆ‘è‡ªå·±å†™çš„å·¥å…·ä¸Šä¼ å›¾ç‰‡ï¼Œä¸»è¦æ˜¯ç”¨çš„é˜¿é‡Œäº‘çš„OSSï¼ŒåŸºæœ¬ä¸Šä¸€å¹´èŠ±ä¸ªä¸åˆ°å‡ å—é’±å°±å¯ä»¥æå®šï¼\nå…·ä½“å¯ä»¥å‚è€ƒ Upload æ’ä»¶\nä½ åœ¨ä½ æœ¬åœ°çš„ .config/.go-tool.yaml æ–‡ä»¶ï¼Œé…ç½®ä¸€ä¸‹é…ç½®å³å¯ï¼\nUpload:  Bucket:    default:      AccessKeyId: xxxx      AccessKeySecret: ihDP2HkiTQGYwMY1udCtq8cBQNKP5N      Endpoint: oss-accelerate.aliyuncs.com      UrlEndpoint: xxx.oss-accelerate.aliyuncs.com      Bucket: xxxx      PathPrefix: image    pdf:      AccessKeyId: xxxxx      AccessKeySecret: xxxxx      Endpoint: oss-accelerate.aliyuncs.com      UrlEndpoint: xxxx.oss-accelerate.aliyuncs.com      Bucket: xxxx      PathPrefix: pdf\n\nç„¶åTyporaé…ç½®ä¸‹: \n\n3. ä¿®æ”¹ä¸ªäººä¸»é¡µä¿®æ”¹æœ¬åœ°æ–‡ä»¶hexo-home/source/about/index.md  å³å¯\n","categories":["å·¥å…·"],"tags":["å·¥å…·","Hexo","Next","Mermaid","Gulp"]},{"title":"å¦‚ä½•è°ƒè¯• envoy","url":"/2023/08/20/1f843b2e9cdc2e9eb8812867e097b659/","content":"envoy æ˜¯ç›®å‰é«˜æ€§èƒ½æ•°æ®å¹³é¢çš„åŸºæœ¬æ ‡å‡†äº†ï¼Œè™½ç„¶æœ‰äº›çœ‹ç€ç¬¨é‡ï¼Œä½†æ˜¯ç¤¾åŒºç‰›é€¼ï¼Œå…¶æ¬¡æ€§èƒ½ä¹Ÿå¾ˆé«˜ï¼Œç›®å‰å¤§éƒ¨åˆ†å…¬å¸çš„meshåŸºæœ¬éƒ½æ˜¯é€šè¿‡envoyæ„å»ºçš„ï¼Œæ‰€ä»¥å­¦ä¹ æ˜¯å¾ˆé‡è¦çš„ï¼Œæœ¬äººä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•debug envoyï¼Œæœ¬äººä¹Ÿæ˜¯è¸©å‘äº†å¤§åŠå¤©ï¼\n\n\nèƒŒæ™¯envoy æ˜¯ç›®å‰é«˜æ€§èƒ½æ•°æ®å¹³é¢çš„åŸºæœ¬æ ‡å‡†äº†ï¼Œè™½ç„¶æœ‰äº›çœ‹ç€ç¬¨é‡ï¼Œä½†æ˜¯ç¤¾åŒºç‰›é€¼ï¼Œå…¶æ¬¡æ€§èƒ½ä¹Ÿå¾ˆé«˜ï¼Œç›®å‰å¤§éƒ¨åˆ†å…¬å¸çš„meshåŸºæœ¬éƒ½æ˜¯é€šè¿‡envoyæ„å»ºçš„ï¼Œæ‰€ä»¥å­¦ä¹ æ˜¯å¾ˆé‡è¦çš„ï¼Œæœ¬äººä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•debug envoyï¼Œæœ¬äººä¹Ÿæ˜¯è¸©å‘äº†å¤§åŠå¤©ï¼\nC++çš„ä»£ç æœ€éš¾çš„å°±æ˜¯ä¸»æµçš„IDEå·¥å…·å¯¹ä»£ç é˜…è¯»ã€è°ƒè¯•éš¾åº¦æ¯”è¾ƒå¤§ï¼Œè¿™å‡ æœ¬å°±æŒ¡ä½äº†å¤§éƒ¨åˆ†äººçš„å­¦ä¹ åŠ¨åŠ›ï¼Œå…¶ä¸­clionå¯¹äºcmakeæ”¯æŒåº¦å¾ˆå¥½ï¼Œvscodeæ˜¯æ¯”è¾ƒæ–¹ä¾¿å’Œçµæ´»ï¼Œå¯ä»¥è¿œç¨‹ç›´æ¥debugï¼Œä¸€èˆ¬debug c++çš„æµç¨‹å°±æ˜¯å…ˆè¦ç¼–è¯‘æˆä¸€ä¸ªäºŒè¿›åˆ¶äº§ç‰©ï¼Œé€šè¿‡ gdb/lldb è¿›è¡Œdebugã€‚envoy é»˜è®¤åœ¨linuxä¸Šæ„å»ºæ˜¯ç”¨clangç¼–è¯‘çš„ï¼Œdebugçš„è¯æœ€å¥½ç”¨lldbï¼\nç¯å¢ƒ\næœ¬åœ°å¼€å‘ç¯å¢ƒæ˜¯ Mac\nè¿œç¨‹å¼€å‘ç¯å¢ƒæ˜¯ Linuxï¼ˆDebian10, 8C+16G, å…¬å¸æœ‰32c+64gçš„å•¥æ—¶å€™æˆ‘ç”³è¯·ä¸ªï¼ŒçœŸçš„æ˜¯ä¸å¥½æ„æ€ğŸ˜¬ï¼‰ã€å¦‚æœä½ æœ¬åœ°æœºå™¨æ€§èƒ½é«˜å¯ä»¥ä¸ç”¨è¿œç¨‹ï¼Œç›´æ¥æœ¬åœ°èµ·ä¸ªdockerå°±è¡Œäº†ã€‘\nç¼–è¯‘ç¯å¢ƒæ˜¯è¿œç¨‹çš„Docker ï¼ˆvscode remote ä¹Ÿåœ¨è¿™é‡Œè¿è¡Œï¼‰\nenvoy - v1.26.0 (æ„å»ºç¯å¢ƒæ˜¯ clang/lldb 14.0.0ï¼Œclangæ¯”gccæ„å»ºè¦å¿«å¾ˆå¤šâ€¦.)\næœ¬åœ° vscode\n\n\næ³¨æ„ï¼š\n\nenvoyè¿™ç§å¤§å‹é¡¹ç›®å®ƒå¯¹äºç¯å¢ƒä¾èµ–å¤ªé‡äº†ï¼Œæ‰€ä»¥åƒä¸‡åˆ«ç”¨æœ¬åœ°ç¯å¢ƒå»æ„å»ºï¼ŒåŸºæœ¬è¡Œä¸é€šï¼\n\nc++ debugå¯¹äºç¯å¢ƒä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜\n\næˆ‘æœ¬æ¥æƒ³è¯•è¯• lldbserver/gdbserver ç”¨ clion è¿›è¡Œ remote debugï¼Œå‘ç°äººå®¶äº§ç‰©1.4ä¸ªGï¼Œä¸‹è½½elfå¤ªå¢¨è¿¹äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯ç›´æ¥åœ¨dockerå®¹å™¨å†…è°ƒè¯•ç®—äº†\n\n\n\nè°ƒè¯•æµç¨‹ä¿®æ”¹è„šæœ¬\nrun_envoy_docker.sh \n\n\né…ç½® httpä»£ç†ï¼Œä¸ç„¶æ‹‰ä»£ç å¤ªå¢¨è¿¹äº†ï¼Œè‡ªå·±æ‰¾http/httpsä»£ç†\né…ç½®docker run æ·»åŠ å‚æ•° --cap-add=SYS_PTRACE --security-opt seccomp=unconfined  æ”¯æŒè°ƒè¯•\ndocker æœ€å¥½é™åˆ¶ä¸‹ cpuï¼Œé˜²æ­¢ç¼–è¯‘æŠŠç”µè„‘cpuæ‰“æ»¡äº†ï¼Œç›´æ¥æŒ‚äº†ï¼\nä¿®æ”¹bazel cacheçš„æŒ‚è½½ç›®å½•: DEFAULT_ENVOY_DOCKER_BUILD_DIR=$&#123;HOME&#125;/.cache/bazel_docker  ï¼ˆé»˜è®¤æ˜¯åœ¨/temp ç›®å½•ä¸‹é‡å¯ç”µè„‘å°±æ²¡äº†ï¼‰\n\n\nbuild_setup.sh è„šæœ¬æ³¨é‡Šæ‰  (é˜²æ­¢æŠŠæ„å»ºäº§ç‰©ç»™åˆ äº†)\n\n#cleanup#trap cleanup EXIT\n\n3.do_ci.sh æ³¨é‡Šæ‰ bazel_binary_build çš„ä¸€äº›å†…å®¹\n\nè¿›å…¥å®¹å™¨./ci/run_envoy_docker.sh &#x27;/bin/bash&#x27;\n\næ„å»ºæ‰§è¡Œ./ci/do_ci.sh bazel.debug.server_only  å³å¯ï¼Œ é¦–æ¬¡æ„å»ºåŸºæœ¬ä¸Šå¾—ä¸¤ä¸ªå°æ—¶å·¦å³ï¼Œåé¢å¢é‡æ„å»ºåŸºæœ¬ä¸Š2åˆ†é’Ÿå·¦å³ï¼\n# è¿™é‡Œå¯ä»¥çœ‹åˆ° --config=libc++ å®é™…ä¸Šå°±æ˜¯clang/usr/local/bin/bazel --output_user_root=/build/tmp/output build --verbose_failures --experimental_generate_json_trace_profile --test_output=errors --repository_cache=/build/repository_cache --experimental_repository_cache_hardlinks --action_env=CLANG_FORMAT --test_tmpdir=/build/tmp --config=libc++ --remote_download_toplevel -c dbg //source/exe:envoy-static\n\n\næœ€åè‡ªå·±æŠŠ cache æ–‡ä»¶å‹ç¼©ä¸€ä¸‹ï¼Œå¤‡ä»½ä¸€ä»½ï¼Œé˜²æ­¢æ‰‹æ®‹ç»™åˆ äº†ã€‚ã€‚ã€‚ã€‚\nenvoybuild@a66c8f90a687:/source$ ls -al bazel-bin/source/exe/total 1381592drwxrwxrwx 4 envoybuild envoybuild       4096 Aug 19 15:05 .drwxrwxrwx 6 envoybuild envoybuild       4096 Aug 19 13:18 ..-r-xr-xr-x 1 envoybuild envoybuild      56844 Aug 19 13:18 envoy_common_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       2096 Aug 19 13:18 envoy_main_common_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       1954 Aug 19 13:18 envoy_main_entry_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild 1413995968 Aug 19 15:05 envoy-static-r-xr-xr-x 1 envoybuild envoybuild     632368 Aug 19 10:40 envoy-static-2.paramsdrwxrwxr-x 3 envoybuild envoybuild       4096 Aug 19 15:03 envoy-static.runfiles-r-xr-xr-x 1 envoybuild envoybuild        141 Aug 19 10:41 envoy-static.runfiles_manifest-r-xr-xr-x 1 envoybuild envoybuild       3546 Aug 19 13:18 main_common_lib.cppmapdrwxrwxr-x 8 envoybuild envoybuild       4096 Aug 19 15:04 _objs-r-xr-xr-x 1 envoybuild envoybuild       1501 Aug 19 14:36 platform_header_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       1613 Aug 19 13:18 platform_impl_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       1803 Aug 19 14:36 platform_impl_lib_linux.cppmap-r-xr-xr-x 1 envoybuild envoybuild       2275 Aug 19 13:18 process_wide_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       1264 Aug 19 13:18 scm_impl_lib.cppmap-r-xr-xr-x 1 envoybuild envoybuild       1863 Aug 19 13:18 terminate_handler_lib.cppmap\n\nè°ƒè¯•\nenvoy æ ¸å¿ƒç”¨çš„libeventï¼Œæ‰€ä»¥å¤§é‡å›æ‰ä»£ç ï¼Œé˜…è¯»è°ƒè¯•æ¯”è¾ƒå›°éš¾ï¼\n\n\næ”¯æŒè°ƒè¯•æœ¬åœ°ä»£ç \n\n\n\næ”¯æŒè°ƒè¯•ä¾èµ–ä»£ç \n\n\n\næœ¬åœ°ä¸‹è½½ vscode æ’ä»¶\n\n\nRemote - SSH  å¯ä»¥è¿æ¥è¿œç¨‹è™šæ‹Ÿæœº\nDev Containers è¿æ¥è¿æ¥æœåŠ¡å™¨å†…çš„dockerå®¹å™¨\n\n\nè¿œç¨‹è¿æ¥åä¸‹è½½vscodeæ’ä»¶ CodeLLDB\n\né…ç½® /.vscode/launch.json æ–‡ä»¶ä¸­é…ç½®\n\n\n&#123;    &quot;version&quot;: &quot;0.2.0&quot;,    &quot;configurations&quot;: [        &#123;            &quot;type&quot;: &quot;lldb&quot;,            &quot;request&quot;: &quot;launch&quot;,            &quot;name&quot;: &quot;Launch&quot;,            &quot;program&quot;: &quot;/source/bazel-bin/source/exe/envoy-static&quot;,            &quot;args&quot;: [],            &quot;cwd&quot;: &quot;/source&quot;,            &quot;sourceMap&quot;:&#123;                &quot;/proc/self/cwd&quot;: &quot;/source&quot;,                &quot;/proc/self/cwd/external&quot;: &quot;/build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoy/external&quot;,            &#125;        &#125;    ]&#125;\n\n\næŒ‚è½½ç‚¹æ˜¯ï¼Œè‡ªè¡ŒæŸ¥çœ‹è‡ªå·±çš„æŒ‚è½½ç‚¹ bazel-source ç›®å½•å°±æ˜¯bazelçš„æ„å»ºç›®å½•\n\nenvoybuild@82990b41dce5:/source$ ls -altotal 464drwxr-xr-x 29 envoybuild envoybuild  4096 Aug 19 10:08 .drwxr-xr-x  1 root       root        4096 Aug 19 10:23 ..drwxr-xr-x  9 envoybuild envoybuild  4096 Aug 19 05:23 api-rw-r--r--  1 envoybuild envoybuild     6 Aug 19 05:23 API_VERSION.txtdrwxr-xr-x  3 envoybuild envoybuild  4096 Aug 19 05:23 .azure-pipelines-rw-r--r--  1 envoybuild envoybuild  2298 Aug 19 05:23 BACKPORTS.mddrwxr-xr-x  8 envoybuild envoybuild  4096 Aug 19 05:23 bazellrwxrwxrwx  1 envoybuild envoybuild    86 Aug 19 06:08 bazel-bin -&gt; /build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoy/bazel-out/k8-dbg/bindrwxr-xr-x  2 envoybuild envoybuild  4096 Aug 19 05:23 .bazelci-rw-r--r--  1 envoybuild envoybuild   152 Aug 19 05:23 .bazelignorelrwxrwxrwx  1 envoybuild envoybuild    75 Aug 19 06:08 bazel-out -&gt; /build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoy/bazel-out-rw-r--r--  1 envoybuild envoybuild 19921 Aug 19 05:23 .bazelrclrwxrwxrwx  1 envoybuild envoybuild    65 Aug 19 06:08 bazel-source -&gt; /build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoylrwxrwxrwx  1 envoybuild envoybuild    91 Aug 19 06:08 bazel-testlogs -&gt; /build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoy/bazel-out/k8-dbg/testlogs-rw-r--r--  1 envoybuild envoybuild     6 Aug 19 05:23 .bazelversion-rw-r--r--  1 envoybuild envoybuild  1454 Aug 19 05:23 BUILD\n\n\nè°ƒè¯•å®˜æ–¹demo https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/run-envoy\n\n\nä¸‹è½½é…ç½®\n\nwget https://www.envoyproxy.io/docs/envoy/latest/_downloads/92dcb9714fb6bc288d042029b34c0de4/envoy-demo.yaml\n\n\né…ç½®å¯åŠ¨å‚æ•°\n\n&#123;    &quot;version&quot;: &quot;0.2.0&quot;,    &quot;configurations&quot;: [        &#123;            &quot;type&quot;: &quot;lldb&quot;,            &quot;request&quot;: &quot;launch&quot;,            &quot;name&quot;: &quot;Launch&quot;,            &quot;program&quot;: &quot;/source/bazel-bin/source/exe/envoy-static&quot;,            &quot;args&quot;: [                &quot;-c&quot;,                &quot;/source/envoy-demo.yaml&quot;            ],            &quot;cwd&quot;: &quot;/source&quot;,            &quot;sourceMap&quot;:&#123;                &quot;/proc/self/cwd&quot;: &quot;/source&quot;, // cwdå¯ä»¥ç†è§£ä¸ºç¼–è¯‘çš„æ ¹è·¯å¾„(æ­»çš„), éœ€è¦æ”¹æˆä½ çš„é¡¹ç›®è·¯å¾„                &quot;/proc/self/cwd/external&quot;: &quot;/build/tmp/output/b570b5ccd0454dc9af9f65ab1833764d/execroot/envoy/external&quot;, // bazelä¸‹è½½çš„ä¸€äº›ä¾èµ–æŒ‚è½½ç‚¹             &#125;        &#125;    ]&#125;\n\n\nè°ƒè¯•ï¼Œ æµè§ˆå™¨å¯ä»¥æ‰“å¼€ http://localhost:10000/  (vscode yyds æ”¯æŒè½¬å‘ç«¯å£)\n\nbazel åŸºæœ¬ç”¨æ³•\nè¿™é‡Œæˆ‘ç”¨çš„clangï¼Œä¸å¤ªå–œæ¬¢ç”¨gccï¼Œ bazelçš„è¯ç›´æ¥ä¸‹è½½ https://github.com/bazelbuild/bazelisk ï¼Œä»–å¯ä»¥è‡ªåŠ¨ä¸‹è½½å¯¹åº”çš„bazelç‰ˆæœ¬ï¼Œæ ¹æ®é¡¹ç›®é‡Œçš„.bazelversion\n\n~ which clang++/usr/lib/llvm-13/bin/clang++~ which bazel # https://github.com/bazelbuild/bazelisk/releases /home/fanhaodong.516/go/bin/bazel\n\n\nè„šæœ¬\n\n.PHONY: fastbuild optbuild debug cleanall: fastbuildfastbuild: # å¿«é€Ÿæ„å»º\tbazel build --config clang //:mainoptbuild: # ä¼˜åŒ–æ„å»º\tbazel build --config clang -c opt //:main\tbazel build --config clang -c opt //:main.dwp\tls -al bazel-bin/clean: # æ¸…ç†bazelæ­¤é¡¹ç›®çš„æ„å»ºç¼“å­˜\tbazel cleandebug: # debugæ„å»ºï¼Œ --subcommands å¯ä»¥æŸ¥çœ‹æ„å»ºå‚æ•°ï¼Œéå¸¸æœ‰ç”¨æ’æŸ¥é—®é¢˜ã€‚  make debug 2&gt;&amp;1 | tee out.log\trm -rf bazel-bin\tbazel build --config clang -c dbg  //:main --subcommands\tbazel build --config clang -c dbg  //:main.dwp --subcommands\tls -al bazel-bin/\n\n\n.bazelrc æ–‡ä»¶é…ç½®æ„å»ºå‚æ•°\n\nbuild --cxxopt=-std=c++14 --host_cxxopt=-std=c++14build:linux --features=per_object_debug_infobuild:linux --fission=dbg,optbuild:clang --config=linuxbuild:clang --action_env=CC=clang --action_env=CXX=clang++\n\n\n.bazelversion é…ç½®bazelç‰ˆæœ¬\n\n6.2.1\n\n\nCodeLLDB é…ç½® lldbè„šæœ¬ .vscode/launch.json æ–‡ä»¶\n\n&#123;    &quot;version&quot;: &quot;0.2.0&quot;,    &quot;configurations&quot;: [        &#123;            &quot;type&quot;: &quot;lldb&quot;, // ä¸‹åŒ            &quot;request&quot;: &quot;custom&quot;,            &quot;name&quot;: &quot;Custom launch&quot;,            &quot;targetCreateCommands&quot;: [                &quot;target create /home/fanhaodong.516/go/src/github.com/anthony-dong/bazel_simple/bazel-bin/main&quot;,                &quot;setting append target.source-map /proc/self/cwd /home/fanhaodong.516/go/src/github.com/anthony-dong/bazel_simple&quot;,                &quot;setting append target.source-map /proc/self/cwd/external /home/fanhaodong.516/.cache/bazel/_bazel_fanhaodong.516/a3fbbe1bc80076bc1aaa5a9834db2f5d/execroot/bazel_simple/external&quot;            ],            &quot;processCreateCommands&quot;: [                &quot;settings set target.run-args 1 &#x27;2 3&#x27; &#x27;4 5&#x27;&quot;,                &quot;process launch&quot;            ]        &#125;,        &#123;            &quot;type&quot;: &quot;lldb&quot;,            &quot;request&quot;: &quot;launch&quot;,            &quot;name&quot;: &quot;Launch&quot;,            &quot;program&quot;: &quot;/home/fanhaodong.516/go/src/github.com/anthony-dong/bazel_simple/bazel-bin/main&quot;, // æ‰§è¡Œæ–‡ä»¶è·¯å¾„            &quot;args&quot;: [ // é…ç½®æ‰§è¡Œæ–‡ä»¶å¯åŠ¨å‚æ•°                &quot;ls&quot;,                &quot;-al&quot;            ],            &quot;cwd&quot;: &quot;/home/fanhaodong.516/go/src/github.com/anthony-dong/bazel_simple&quot;, // ä»£ç è·¯å¾„            &quot;sourceMap&quot;: &#123;                &quot;/proc/self/cwd&quot;: &quot;/home/fanhaodong.516/go/src/github.com/anthony-dong/bazel_simple&quot;, // æ–‡ä»¶mapï¼Œç¬¬ä¸€ä¸ªå¿…é¡»(bazelåœ¨linuxä¸‹æ„å»º PWD=/proc/self/cwdï¼Œå¼ºåˆ¶çš„)                &quot;/proc/self/cwd/external&quot;: &quot;/home/fanhaodong.516/.cache/bazel/_bazel_fanhaodong.516/a3fbbe1bc80076bc1aaa5a9834db2f5d/execroot/bazel_simple/external&quot;, // æ¬¡è¦é…ç½®ï¼Œçœ‹çœ‹ä½ éœ€ä¸éœ€è¦debugä¾èµ–ï¼Œå¯ä»¥é…ç½®å¤šä¸ª            &#125;        &#125;    ]&#125;\n\nbazel - fissionæ¨¡å¼\nè¿™ä¸ªæ¯”è¾ƒå‘ï¼Œéœ€è¦æ·±å…¥äº†è§£ä¸‹ï¼Œä¸ç„¶debugçš„è¯ä¼šæ˜¯å™©æ¢¦ï¼Œå¯ä»¥è‡ªå·±å†™ä¸ªå°é¡¹ç›®è¯•è¯•ï¼\n\n\nbazel æ„å»ºæ¨¡å¼ï¼šhttps://bazel.build/docs/user-manual#compilation-mode , é»˜è®¤æ˜¯fastbuild\nbazel è°ƒè¯•æ¨¡å¼ï¼šhttps://bazel.build/docs/user-manual#strip \n\n# è¿˜å¯ä»¥æ‰‹åŠ¨å†ç²¾ç®€ ã€‚ã€‚ã€‚strip bazel-bin/main -o ./main\n\n\nfission æ¨¡å¼ https://bazel.build/docs/user-manual#fission\n\n# --features=per_object_debug_info å¯é€‰å¯ä¸é€‰äº†ç°åœ¨ ï¼ˆæˆ‘çš„ç‰ˆæœ¬æ˜¯ 6.xï¼‰# fission æ”¯æŒ dbg,opt,fastbuild,yes(all),no(none)# åªæœ‰å¼€å¯äº† fission æ‰èƒ½å¤Ÿæ”¯æŒ bazel build //:xxx.dwpbuild:linux --features=per_object_debug_infobuild:linux --fission=dbg,opt\n\n\næ„å»ºæ–‡ä»¶\n\nbazel build --config clang -c dbg  //:main# æ²¡å¼€å¯ fission è¿™ä¸ªæ‰§è¡Œäº†ä¹Ÿæ²¡å•¥ç”¨... //:xxx.dwp åªåœ¨å¼€å¯fissionä¸‹ç”Ÿæ•ˆbazel build --config clang -c dbg  //:main.dwp\n\n\næœªå¼€å¯ fission (dbg) æ„å»º\n\ndrwxr-xr-x 5 fanhaodong.516 fanhaodong.516    4096 Aug 19 22:56 .drwxr-xr-x 4 fanhaodong.516 fanhaodong.516    4096 Aug 19 22:56 ..drwxrwxrwx 4 fanhaodong.516 fanhaodong.516    4096 Aug 19 22:56 external-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516 1274544 Aug 19 22:56 main-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516    3513 Aug 19 22:56 main-2.params-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516     674 Aug 19 22:56 main.cppmap-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516       0 Aug 19 22:56 main.dwpdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516    4096 Aug 19 22:56 main.runfiles-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516     162 Aug 19 22:56 main.runfiles_manifestdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516    4096 Aug 19 22:56 _objs\n\n\nå¼€å¯ fission (opt) æ˜æ˜¾èƒ½çœ‹å‡ºæ¥å¯æ‰§è¡Œæ–‡ä»¶å¤§å°é™ä½äº†ä¸å°‘  1274544 -&gt; 396626\n\nls -al bazel-bin/total 1676drwxr-xr-x 5 fanhaodong.516 fanhaodong.516    4096 Aug 19 23:00 .drwxr-xr-x 4 fanhaodong.516 fanhaodong.516    4096 Aug 19 23:00 ..drwxr-xr-x 4 fanhaodong.516 fanhaodong.516    4096 Aug 19 23:00 external-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516  396626 Aug 19 23:00 main-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516    3411 Aug 19 23:00 main-2.params-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516     674 Aug 19 23:00 main.cppmap-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516 1285592 Aug 19 23:00 main.dwpdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516    4096 Aug 19 23:00 main.runfiles-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516     162 Aug 19 23:00 main.runfiles_manifestdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516    4096 Aug 19 23:00 _objs\n\n\nå¼€å¯fission (dbg)     1274544 -&gt; 834808\n\ntotal 1808drwxr-xr-x 5 fanhaodong.516 fanhaodong.516   4096 Aug 19 23:00 .drwxr-xr-x 4 fanhaodong.516 fanhaodong.516   4096 Aug 19 23:00 ..drwxr-xr-x 4 fanhaodong.516 fanhaodong.516   4096 Aug 19 23:00 external-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516 834808 Aug 19 23:00 main-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516   3529 Aug 19 23:00 main-2.params-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516    674 Aug 19 23:00 main.cppmap-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516 980664 Aug 19 23:00 main.dwpdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516   4096 Aug 19 23:00 main.runfiles-r-xr-xr-x 1 fanhaodong.516 fanhaodong.516    162 Aug 19 23:00 main.runfiles_manifestdrwxr-xr-x 3 fanhaodong.516 fanhaodong.516   4096 Aug 19 23:00 _objs\n\n\næ€»ç»“ æœ€å¥½åˆ«å¼€ï¼Œæ”¯æŒåº¦ä¸å¤ªå¥½ï¼Œæ‰€ä»¥çœ‹åˆ° --fission å‚æ•°  æˆ–è€… bazelrc æ–‡ä»¶ä¸­é…ç½®äº†ï¼Œè¯·ç«‹é©¬æ³¨é‡Šæ‰å…³é—­äº†ï¼ï¼ï¼\n\nbazel - .bazelrc\nä¸€æ—¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶å°±å¾—é‡æ–°æ„å»º\n\n# é…ç½®c++ç‰ˆæœ¬build --cxxopt=-std=c++14 --host_cxxopt=-std=c++14# é…ç½® build çš„æ„å»ºå‚æ•°ï¼ˆå½“configä¸ºlinuxæ—¶ï¼‰# å¯ä»¥çœ‹ä¸Šé¢è§£é‡Šbuild:linux --features=per_object_debug_info# build:linux --fission=dbg,optbuild:linux --fission=no# --config=linux ç»§æ‰¿é…ç½®linuxçš„ï¼Œå¯ä»¥é…ç½®å¤šä¸ª --config ã€‚build:clang --config=linux# config=clangæ—¶ cc/gcc ä¸º clang / clang++# --action_env ä¸»è¦clang æ„å»ºæ—¶ä¼ é€’çš„envå‚æ•°build:clang --action_env=CC=clang --action_env=CXX=clang++# å¯é…å¯ä¸é…å§ï¼Œå‡å¦‚clangè·¯å¾„ä¸‹æœ‰ld.lldæ—¢ä¸éœ€è¦é…ç½®# build:clang --linkopt=-fuse-ld=lld# config=gccçš„æ„å»ºbuild:gcc --action_env=CC=gcc --action_env=CXX=g++\n\nå‚è€ƒ\nbazel å‘½ä»¤è¡Œä»‹ç» https://bazel.build/reference/command-line-reference\nbazel ç›®å½•ä»‹ç» https://bazel.build/remote/output-directories\nbazelrc ä»‹ç» https://bazel.build/run/bazelrc\nenvoy: https://www.envoyproxy.io/\nenvoy devp:  https://github.com/envoyproxy/envoy/tree/v1.26.0/ci\n\n","categories":["Linux","C++"],"tags":["Linux","C++","Envoy"]},{"title":"Dockerèµ„æºé™åˆ¶å’Œå¦‚ä½•ç›‘æ§","url":"/2021/01/28/1041c14319d758f789b79049f9abedad/","content":"â€‹    å®¹å™¨æ¯”è¾ƒå¼ºå¤§çš„åœ°æ–¹å°±æ˜¯ä½¿ç”¨æ–¹ä¾¿ï¼Œå¼ºå¤§çš„éš”ç¦»æ€§ï¼Œä½†æ˜¯ç”Ÿäº§ä¸Šå¾€å¾€éœ€è¦åšåˆ°ä¿æŠ¤ï¼Œæ¯”å¦‚aå®¹å™¨ä¸èƒ½å¯¹äºbå®¹å™¨é€ æˆä»»ä½•å½±å“ï¼Œæ¯”å¦‚aå®¹å™¨èµ„æºå ç”¨å¤ªé«˜ï¼Œå¯¼è‡´bå®¹å™¨æ— æ³•å“åº”ï¼Œè·å–aå®¹å™¨downæœºå½±å“å®¿ä¸»æœºæˆ–å…¶ä»–å®¹å™¨ç­‰ç­‰ï¼Œéƒ½æ˜¯ä¸å…è®¸çš„ï¼Œæ‰€ä»¥å®¹å™¨éš”ç¦»æŠ€æœ¯å°±è§£å†³äº†è¿™äº›é—®é¢˜ï¼\n\n\n1ã€cgroupç®€ä»‹cgroupæ˜¯Control Groupsçš„ç¼©å†™ï¼Œæ˜¯Linux å†…æ ¸æä¾›çš„ä¸€ç§å¯ä»¥é™åˆ¶ã€è®°å½•ã€éš”ç¦»è¿›ç¨‹ç»„æ‰€ä½¿ç”¨çš„ç‰©ç†èµ„æº(å¦‚ cpuã€memoryã€ç£ç›˜IOç­‰ç­‰) çš„æœºåˆ¶ï¼Œè¢«LXCã€dockerç­‰å¾ˆå¤šé¡¹ç›®ç”¨äºå®ç°è¿›ç¨‹èµ„æºæ§åˆ¶ã€‚cgroupå°†ä»»æ„è¿›ç¨‹è¿›è¡Œåˆ†ç»„åŒ–ç®¡ç†çš„ Linux å†…æ ¸åŠŸèƒ½ã€‚cgroupæœ¬èº«æ˜¯æä¾›å°†è¿›ç¨‹è¿›è¡Œåˆ†ç»„åŒ–ç®¡ç†çš„åŠŸèƒ½å’Œæ¥å£çš„åŸºç¡€ç»“æ„ï¼ŒI/O æˆ–å†…å­˜çš„åˆ†é…æ§åˆ¶ç­‰å…·ä½“çš„èµ„æºç®¡ç†åŠŸèƒ½æ˜¯é€šè¿‡è¿™ä¸ªåŠŸèƒ½æ¥å®ç°çš„ã€‚è¿™äº›å…·ä½“çš„èµ„æºç®¡ç†åŠŸèƒ½ç§°ä¸ºcgroupå­ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹å‡ å¤§å­ç³»ç»Ÿå®ç°ï¼š\n\nblkioï¼šè®¾ç½®é™åˆ¶æ¯ä¸ªå—è®¾å¤‡çš„è¾“å…¥è¾“å‡ºæ§åˆ¶ã€‚ä¾‹å¦‚:ç£ç›˜ï¼Œå…‰ç›˜ä»¥åŠusbç­‰ç­‰ã€‚\ncpuï¼šä½¿ç”¨è°ƒåº¦ç¨‹åºä¸ºcgroupä»»åŠ¡æä¾›cpuçš„è®¿é—®ã€‚\ncpuacctï¼šäº§ç”Ÿcgroupä»»åŠ¡çš„cpuèµ„æºæŠ¥å‘Šã€‚\ncpusetï¼šå¦‚æœæ˜¯å¤šæ ¸å¿ƒçš„cpuï¼Œè¿™ä¸ªå­ç³»ç»Ÿä¼šä¸ºcgroupä»»åŠ¡åˆ†é…å•ç‹¬çš„cpuå’Œå†…å­˜ã€‚\ndevicesï¼šå…è®¸æˆ–æ‹’ç»cgroupä»»åŠ¡å¯¹è®¾å¤‡çš„è®¿é—®ã€‚\nfreezerï¼šæš‚åœå’Œæ¢å¤cgroupä»»åŠ¡ã€‚\nmemoryï¼šè®¾ç½®æ¯ä¸ªcgroupçš„å†…å­˜é™åˆ¶ä»¥åŠäº§ç”Ÿå†…å­˜èµ„æºæŠ¥å‘Šã€‚\nnet_clsï¼šæ ‡è®°æ¯ä¸ªç½‘ç»œåŒ…ä»¥ä¾›cgroupæ–¹ä¾¿ä½¿ç”¨ã€‚\nnsï¼šå‘½åç©ºé—´å­ç³»ç»Ÿã€‚\nperf_eventï¼šå¢åŠ äº†å¯¹æ¯groupçš„ç›‘æµ‹è·Ÿè¸ªçš„èƒ½åŠ›ï¼Œå³å¯ä»¥ç›‘æµ‹å±äºæŸä¸ªç‰¹å®šçš„groupçš„æ‰€æœ‰çº¿ç¨‹ä»¥åŠè¿è¡Œåœ¨ç‰¹å®šCPUä¸Šçš„çº¿ç¨‹ã€‚\n\nç›®å‰dockeråªæ˜¯ç”¨äº†å…¶ä¸­ä¸€éƒ¨åˆ†å­ç³»ç»Ÿï¼Œå®ç°å¯¹èµ„æºé…é¢å’Œä½¿ç”¨çš„æ§åˆ¶ã€‚\n2ã€dockerå¦‚ä½•é™åˆ¶çš„ä½¿ç”¨çš„æ˜¯stressé•œåƒå‹æµ‹ ï¼šhttps://hub.docker.com/r/jfusterm/stress\ndocker pull jfusterm/stress\n\n1ã€å†…å­˜é™åˆ¶\n\n\né€‰é¡¹\næè¿°\n\n\n\n-m,--memory\nå†…å­˜é™åˆ¶ï¼Œæ ¼å¼æ˜¯æ•°å­—åŠ å•ä½ï¼Œå•ä½å¯ä»¥ä¸º b,k,m,gã€‚æœ€å°ä¸º 4M\n\n\n--memory-swap\nå†…å­˜+äº¤æ¢åˆ†åŒºå¤§å°æ€»é™åˆ¶ã€‚æ ¼å¼åŒä¸Šã€‚å¿…é¡»å¿…-mè®¾ç½®çš„å¤§\n\n\n--memory-reservation\nå†…å­˜çš„è½¯æ€§é™åˆ¶ã€‚æ ¼å¼åŒä¸Š\n\n\n--oom-kill-disable\næ˜¯å¦é˜»æ­¢ OOM killer æ€æ­»å®¹å™¨ï¼Œé»˜è®¤æ²¡è®¾ç½®\n\n\n--oom-score-adj\nå®¹å™¨è¢« OOM killer æ€æ­»çš„ä¼˜å…ˆçº§ï¼ŒèŒƒå›´æ˜¯[-1000, 1000]ï¼Œé»˜è®¤ä¸º 0\n\n\n--memory-swappiness\nç”¨äºè®¾ç½®å®¹å™¨çš„è™šæ‹Ÿå†…å­˜æ§åˆ¶è¡Œä¸ºã€‚å€¼ä¸º 0~100 ä¹‹é—´çš„æ•´æ•°\n\n\n--kernel-memory\næ ¸å¿ƒå†…å­˜é™åˆ¶ã€‚æ ¼å¼åŒä¸Šï¼Œæœ€å°ä¸º 4M\n\n\nä¸ºäº†å‹æµ‹æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªå®¹å™¨\n1ã€åªè®¾ç½® -m å‚æ•°ï¼Œå¯ä»¥å‘ç°å½“é™åˆ¶å†…å­˜åœ¨ 128mæ—¶ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥åˆ†é…128mçš„ï¼Œæ‰€ä»¥-må¹¶ä¸æ˜¯å…¨éƒ¨çš„é™åˆ¶\nâœ  ~ docker run -it --rm -m 128m  jfusterm/stress --vm 1 --vm-bytes 128m -t 5sstress: info: [1] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hddstress: info: [1] successful run completed in 5s\n\nå½“æˆ‘ä»¬ç»§ç»­å¢åŠ åˆ°åŸæ¥çš„ä¸¤å€ï¼Œå‘ç°è¿è¡Œå¤±è´¥\nâœ  ~ docker run -it --rm -m 128m  jfusterm/stress --vm 1 --vm-bytes 256m -t 5sstress: info: [1] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hddstress: FAIL: [1] (415) &lt;-- worker 6 got signal 9stress: WARN: [1] (417) now reaping child worker processesstress: FAIL: [1] (421) kill error: No such processstress: FAIL: [1] (451) failed run completed in 1s\n\nå½“æˆ‘ä»¬è®¾ç½®ä¸º 250m,å‘ç°è¿è¡ŒæˆåŠŸ\nâœ  ~ docker run -it --rm -m 128m  jfusterm/stress --vm 1 --vm-bytes 250m -t 5sstress: info: [1] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hddstress: info: [1] successful run completed in 5s\n\n2ã€è®¾ç½®--memory å’Œ--memory-swap å‚æ•°\nè®¾ç½® 128 &amp; 128 ï¼Œåˆ†é… 127æ—¶OKçš„ï¼Œ\nâœ  ~ docker run -it --rm --memory 128m  --memory-swap 128m jfusterm/stress --vm 1 --vm-bytes 127m -t 5sstress: info: [1] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hddstress: info: [1] successful run completed in 5s\n\nè®¾ç½®128 &amp; 128 ï¼Œåˆ†é…128 å¤±è´¥\nâœ  ~ docker run -it --rm --memory 128m  --memory-swap 128m jfusterm/stress --vm 1 --vm-bytes 128m -t 5sstress: info: [1] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hddstress: FAIL: [1] (415) &lt;-- worker 7 got signal 9stress: WARN: [1] (417) now reaping child worker processesstress: FAIL: [1] (421) kill error: No such processstress: FAIL: [1] (451) failed run completed in 1s\n\n2ã€å¦‚ä½•æŸ¥çœ‹å®¹å™¨çœŸå®å†…å­˜[root@centos-linux ~]# docker run --rm -it -m 128m alpine /bin/sh/ # free -m              total        used        free      shared  buff/cache   availableMem:           1980         266        1143          21         569        1559Swap:             0           0           0\n\nç»å¸¸é‡åˆ°è¿™ç§é—®é¢˜ï¼Œå®¹å™¨å†…çš„å†…å­˜å’ŒçœŸå®å†…å­˜å…¶å®ä¸ä¸€è‡´çš„ï¼ŒåŸå› æ˜¯å•¥ï¼Ÿ \nè¿™æ˜¯ç”±äºdockeräº§ç”Ÿçš„å®¹å™¨çš„éš”ç¦»æ€§ä¸è¶³é€ æˆçš„ã€‚dockeråˆ›å»ºå®¹å™¨æ—¶ï¼Œä¼šä¸ºå®¹å™¨æä¾›ä¸€äº›å¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œæ¯”å¦‚/procä¸‹çš„è‹¥å¹²æ–‡ä»¶ã€‚å…¶ä¸­/proc/meminfoæ–‡ä»¶dockerå¹¶æ²¡æœ‰ç›´æ¥æä¾›å…¶ç”Ÿæˆï¼Œè€Œæ˜¯å°†å®¿ä¸»æœºçš„/proc/meminfoæŒ‚è½½ç»™äº†å®¹å™¨ã€‚å› æ­¤å®¹å™¨çœ‹åˆ°çš„/proc/meminfoä¸å®¿ä¸»æœºçš„/proc/meminfoçš„å†…å®¹æ˜¯ä¸€æ ·çš„ã€‚è€Œfreeå‘½ä»¤ä¹Ÿä¸è¿‡æ˜¯æŸ¥çœ‹è¯¥æ–‡ä»¶çš„ä¿¡æ¯è€Œå·²ã€‚å¦‚æœæƒ³å¢å¼ºå…¶éš”ç¦»æ€§ï¼Œå¯ä»¥ä½¿ç”¨lxcfsçš„æ–¹å¼ã€‚\né‚£å¦‚ä½•è§£å†³äº†ï¼Ÿ\ndockerå…¶å®æœ¬èº«ä½¿ç”¨ cgroupè¿›è¡Œéš”ç¦»ï¼Œå…¶å®å®ƒç›‘æ§ä¹Ÿåªèƒ½ç›‘æ§cgroupï¼Œæœ¬æœºæ˜¯ CentOS Linux release 7.9.2009 (Core)\n[root@centos-linux ~]# ls /sys/fs/cgroup/memory/docker/9fc278a2cab2bde9f2aa10fb8eb58732f4d1f3ce0f988ed64cac4b4616a585f1/cgroup.clone_children           memory.kmem.tcp.max_usage_in_bytes  memory.oom_controlcgroup.event_control            memory.kmem.tcp.usage_in_bytes      memory.pressure_levelcgroup.procs                    memory.kmem.usage_in_bytes          memory.soft_limit_in_bytesmemory.failcnt                  memory.limit_in_bytes               memory.statmemory.force_empty              memory.max_usage_in_bytes           memory.swappinessmemory.kmem.failcnt             memory.memsw.failcnt                memory.usage_in_bytesmemory.kmem.limit_in_bytes      memory.memsw.limit_in_bytes         memory.use_hierarchymemory.kmem.max_usage_in_bytes  memory.memsw.max_usage_in_bytes     notify_on_releasememory.kmem.slabinfo            memory.memsw.usage_in_bytes         tasksmemory.kmem.tcp.failcnt         memory.move_charge_at_immigratememory.kmem.tcp.limit_in_bytes  memory.numa_stat\n\n\n\n\næ–‡ä»¶åç§°\nå«ä¹‰\n\n\n\nmemory.usage_in_bytes\nå·²ä½¿ç”¨çš„å†…å­˜é‡(åŒ…å«cacheå’Œbuffer)(å­—èŠ‚)ï¼Œç›¸å½“äºlinuxçš„used_meme\n\n\nmemory.limit_in_bytes\né™åˆ¶çš„å†…å­˜æ€»é‡(å­—èŠ‚)ï¼Œç›¸å½“äºlinuxçš„total_mem\n\n\nmemory.failcnt\nç”³è¯·å†…å­˜å¤±è´¥æ¬¡æ•°è®¡æ•°\n\n\nmemory.memsw.usage_in_bytes\nå·²ä½¿ç”¨çš„å†…å­˜å’Œswap(å­—èŠ‚)\n\n\nmemory.memsw.limit_in_bytes\né™åˆ¶çš„å†…å­˜å’Œswapå®¹é‡(å­—èŠ‚)\n\n\nmemory.memsw.failcnt\nç”³è¯·å†…å­˜å’Œswapå¤±è´¥æ¬¡æ•°è®¡æ•°\n\n\nmemory.stat\nå†…å­˜ç›¸å…³çŠ¶æ€\n\n\næŸ¥çœ‹\n[root@centos-linux ~]# docker stats 9fc278a2cab2bde9f2aa10fb8eb58732f4d1f3ce0f988ed64cac4b4616a585f1 --no-streamCONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT   MEM %     NET I/O       BLOCK I/O   PIDS9fc278a2cab2   elated_panini   0.00%     560KiB / 128MiB     0.43%     1.01kB / 0B   0B / 0B     1[root@centos-linux 9fc278a2cab2bde9f2aa10fb8eb58732f4d1f3ce0f988ed64cac4b4616a585f1]# cat memory.usage_in_bytes573440\n\næ‰€ä»¥å¯ä»¥çœ‹åˆ°ä¿©æ•°æ®åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“é€»è¾‘ï¼šhttps://github.com/opencontainers/runc/blob/v0.1.1/libcontainer/cgroups/fs/memory.go#L148\nå‚è€ƒï¼šDockerå®¹å™¨å†…å­˜ç›‘æ§\n","categories":["äº‘åŸç”Ÿ"],"tags":["Docker","ç›‘æ§"]},{"title":"Cmakeå­¦ä¹ ","url":"/2023/04/23/291f1489dc6255cedb0b626e74c04f9d/","content":"C/C++ çš„æ„å»º/ç¼–è¯‘å·¥å…·æœ‰å¾ˆå¤šï¼ŒCMakeåº”è¯¥å±äºç¬¬ä¸‰ä»£æ„å»ºå·¥å…·ï¼Œå…¶æ¬¡ä¸ªäººè§‰å¾—åº”è¯¥æ˜¯C++ç”Ÿæ€é¢†åŸŸä¸­æœ€å¹¿çš„ï¼Œä¸€äº›æ–°ä¸€ä»£çš„è™½å¥½ä½†æ˜¯ç”Ÿæ€ä¸è¡Œï¼Cmake-Demoåœ°å€: https://github.com/Anthony-Dong/cmake_demo\n\n\nä»‹ç»C/C++ çš„æ„å»º/ç¼–è¯‘å·¥å…·æœ‰å¾ˆå¤šï¼ŒCMakeåº”è¯¥å±äºç¬¬ä¸‰ä»£æ„å»ºå·¥å…·ï¼Œå…¶æ¬¡ä¸ªäººè§‰å¾—åº”è¯¥æ˜¯C++ç”Ÿæ€é¢†åŸŸä¸­æœ€å¹¿çš„ï¼Œä¸€äº›æ–°ä¸€ä»£çš„è™½å¥½ä½†æ˜¯ç”Ÿæ€ä¸è¡Œï¼\nç¬¬ä¸€ä»£ï¼šg++/gcc/clangï¼Œæœ€åŸå§‹äº†ï¼Œæ„å»ºä¾¿å¤§ç‚¹çš„é¡¹ç›®éå¸¸ç—›è‹¦\nç¬¬äºŒä»£ï¼šMakefileï¼Œé€šè¿‡Makefileè¯­æ³•è§„åˆ™ç®€åŒ–äº†å‘½ä»¤\nç¬¬ä¸‰ä»£ï¼šAutotools å’Œ CMake å…¶å®å°±æ˜¯çœç•¥äº†è‡ªå·±å†™Makefileçš„è¿‡ç¨‹ï¼\nç¬¬å››ä»£ï¼šBazel ã€Blade  é›†å¤§æˆè€…æ”¯æŒä»»ä½•è¯­è¨€çš„æ„å»ºï¼Œå¯¹äºæ„å»ºç¼“å­˜æ”¯æŒä¹Ÿå¥½ï¼\nå¿«é€Ÿå¼€å§‹\nmain.cpp æ–‡ä»¶\n\n#include &lt;iostream&gt;#include &lt;fmt/core.h&gt;int main() &#123;    std::cout &lt;&lt; &quot;hello world!&quot; &lt;&lt; std::endl;    fmt::print(&quot;hello &#123;&#125;!\\n&quot;, &quot;world&quot;);&#125;\n\n\nCMakeLists.txt æ–‡ä»¶\n\n# è®¾ç½®CMakeæœ€ä½ç‰ˆæœ¬cmake_minimum_required(VERSION 3.8.0)# è®¾ç½®é¡¹ç›®åç§°project(cmake_demo)## è®¾ç½®C++ç‰ˆæœ¬ å’Œ ç¼–è¯‘å™¨set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_COMPILER g++)## è®¾ç½®ç¼–è¯‘é€‰é¡¹## add_compile_options(-Wall -Wextra -pedantic -Werror)## è®¾ç½®å…¨å±€åŠ¨æ€é“¾æ¥åº“ç›®å½•link_directories(/usr/local/lib)## è®¾ç½®target ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶add_executable($&#123;PROJECT_NAME&#125; main.cpp)## å¼•ç”¨çš„å¤´æ–‡ä»¶åœ°å€target_include_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/include)## å¼•ç”¨çš„é“¾æ¥åº“target_link_libraries($&#123;PROJECT_NAME&#125; PUBLIC fmt)\n\n\næ‰§è¡Œ cmake . å³å¯ç¼–è¯‘\nå¤‡æ³¨: fmtåº“å¯ä»¥å‰å¾€ fmt å®˜ç½‘è‡ªè¡Œä¸‹è½½æ„å»º https://fmt.dev/latest/usage.html\n\nå…³é”®æ¦‚å¿µtargetCmakeçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å›´ç»•ç€ target èµ°äº†ï¼Œ target å¯ä»¥æ˜¯ å¯æ‰§è¡Œæ–‡ä»¶(executable)ã€é™æ€é“¾æ¥åº“ï¼ˆstaticï¼‰ã€åŠ¨æ€é“¾æ¥åº“(shared) !äº†è§£äº†è¿™äº›ä½ ä¼šå¾ˆæ–¹ä¾¿çš„ç†è§£Camkeçš„ç¼–å†™æ–¹å¼ï¼\n# å®šä¹‰å¯æ‰§è¡Œæ–‡ä»¶: targeä¸ºdemoadd_executable(demo make.cpp)# å®šä¹‰åŠ¨æ€é“¾æ¥åº“: targeä¸ºlib_utilsadd_library(lib_utils SHARED utils.cpp)# å®šä¹‰é™æ€é“¾æ¥åº“: targeä¸ºlib_randomadd_library($&#123;PROJECT_NAME&#125; STATIC random.cpp)\n\ntarget_xxx_directoriesæˆ‘å»ºè®®ç”³æ˜ä¸º PRIVATEï¼Œéµå¾ªä½¿ç”¨å†å¼•ç”¨çš„åŸåˆ™\n# å¤´æ–‡ä»¶å¼•ç”¨åœ°å€target_include_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/include)# åŠ¨æ€é“¾æ¥åº“lookupçš„åœ°å€target_link_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/lib)\n\ntarget_link_librariesè¿™é‡Œè¡¨ç¤ºæˆ‘å¼•ç”¨çš„é“¾æ¥åº“ï¼Œè¿™é‡Œæˆ‘å»ºè®®è®¾ç½®ä¸º PUBLIC ï¼Œä¸ç„¶åˆ«äººå¼•ç”¨ä½ çš„åº“ä¼šå‘ç°æ‰¾ä¸åˆ°æŸä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œé‚£å°±å°´å°¬äº†ï¼ŒæŠ¥é”™ï¼\nå¦‚æœæœ‰æ¯”è¾ƒå¥½çš„è§„èŒƒçš„è¯æˆ‘è§‰å¾—æ— æ‰€è°“ï¼\ntarget_link_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/lib)# å¼•ç”¨çš„é“¾æ¥åº“target_link_libraries($&#123;PROJECT_NAME&#125; PUBLIC fmt)\n\nå¤šæ¨¡å—ç®¡ç†ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ¨èä¸€ä¸ªç›®å½•å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œå› æ­¤å¦‚ä½•ç”¨Cmakeé…ç½®æ¨¡å—å°±æ˜¾å¾—å¾ˆé‡è¦äº†ï¼\nè¿™é‡Œæˆ‘å¤§æ¦‚å°±è‡ªå·±å†™äº†ä¸ªdemoï¼Œå¤§å®¶è‡ªè¡Œå‚è€ƒï¼Œdemoåœ°å€ï¼šhttps://github.com/Anthony-Dong/cmake_demo\n\nå­¦ä¼šç”¨cmakeè‡ªå·±å®‰è£…é“¾æ¥åº“ï¼Œè¿™é‡Œçš„ä¾‹å­æ˜¯protoc\n\nâ€‹    è¿™é‡Œå…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆè¿™äº›åº“ä¸€èˆ¬å¯¹äºcmakeéƒ½æ”¯æŒï¼Œå…¶æ¬¡å°±æ˜¯æ‰¾åˆ°ä»‹ç»æ–‡ä»¶ï¼Œçœ‹çœ‹å®ƒçš„CamkeLists.txt æ–‡ä»¶ï¼Œæœ€åè‡ªå·±çœ‹ä¸€ä¸‹å“ªäº›éœ€è¦å“ªäº›ä¸éœ€è¦ï¼Œæœ€åè‡ªå·±ç¼–è¯‘å³å¯ï¼å…·ä½“å¯ä»¥çœ‹: https://github.com/Anthony-Dong/cmake_demo \n\nä½¿ç”¨ protoc åº“\n\nproject(lib_idl)add_library($&#123;PROJECT_NAME&#125; SHARED model.pb.cc common.pb.cc utils.cpp)## link protobuftarget_include_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/include)target_link_directories($&#123;PROJECT_NAME&#125; PRIVATE /usr/local/lib)target_link_libraries($&#123;PROJECT_NAME&#125; PUBLIC protobuf)\n\n\nå®šä¹‰pbæ–‡ä»¶ï¼Œä½¿ç”¨protobufå¯ä»¥çœå»äº†è‡ªå·±å†™åºåˆ—åŒ–å‡½æ•°çš„æ—¶é—´ï¼Œæ‰§è¡Œå‘½ä»¤  protoc -I . --cpp_out=. common.proto model.proto\n\n\næ³¨æ„: protocç‰ˆæœ¬å¿…é¡»è¦å’Œé“¾æ¥åº“ç‰ˆæœ¬ä¸€è‡´ï¼Œä¸ç„¶é¡¹ç›®ç¼–è¯‘æŠ¥é”™ï¼\n\n//  model.protosyntax = &quot;proto2&quot;;package model.idl;import &quot;common.proto&quot;;enum Gendor &#123;  Female = 1;  Male = 2;&#125;message People &#123;  optional int64 ID = 1;  optional string Name = 2;  optional Gendor Gendor = 3;  repeated string ExtralList = 4;  map&lt;string, string&gt; Extra = 5;  optional ExtraInfo ExtraInfo = 6;  optional Status status = 7;&#125;message ExtraInfo &#123;optional string name = 1;&#125;// common.protosyntax = &quot;proto2&quot;;package model.idl;enum Status &#123;  On = 0;  Off = 1;&#125;\n\n\nä¸»å‡½æ•°\n\n#include &lt;fmt/core.h&gt;#include &lt;idl/model.pb.h&gt;#include &lt;idl/utils.h&gt;#include &lt;db/Class.h++&gt;#include &lt;iostream&gt;int main() &#123;    std::cout &lt;&lt; &quot;hello world!&quot; &lt;&lt; std::endl;    fmt::print(&quot;hello &#123;&#125;!\\n&quot;, &quot;world&quot;);    DB::Model::Class a(1, &quot;1314ç­&quot;);    fmt::print(&quot;id: &#123;&#125;, name: &#123;&#125;\\n&quot;, a.getId(), a.getName());    model::idl::People people&#123;&#125;;    people.set_name(&quot;tom&quot;);    people.set_id(1);    fmt::print(&quot;people: &#123;&#125;\\n&quot;, model::idl::toJson(people));    fmt::print(&quot;people: &#123;&#125;\\n&quot;, *model::idl::toJsonPtr(people));&#125;\n\nè¿œç¨‹è°ƒè¯•è¿œç¨‹è°ƒè¯•çš„èƒ½åŠ›ä¾èµ–äºgdbserverï¼Œå…¶æ¬¡ cmakeæ„å»ºçš„æ—¶å€™éœ€è¦æŒ‡å®š -DCMAKE_BUILD_TYPE=Debug \n\nDebugï¼šç”¨äºåœ¨æ²¡æœ‰ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¸¦æœ‰è°ƒè¯•ç¬¦å·æ„å»ºåº“æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶\n\n~/go/src/github.com/anthony-dong/cmake_demo gdbserver :10086 output/cmake_demoProcess output/cmake_demo created; pid = 149849Listening on port 10086Remote debugging from host 10.78.117.128now 2023-08-18 17:28:22hello world!\n\n2. æ•ˆæœ\n\n","categories":["C++"],"tags":["C++","Cmake"]},{"title":"å…³äºå®¹å™¨åŒ–çš„æ€è€ƒ","url":"/2020/10/06/33ea9e6f1ad28eb266559efefc7ac6a1/","content":"â€‹    æˆ‘æœ€è¿‘åŠä¸ªæœˆå†…ä¸€ç›´åœ¨çœ‹dockerï¼Œä½†æ˜¯çœ‹å®Œåå‘ç°ï¼Œå‘ç°å®ƒå¯¹äºæˆ‘æ¥è¯´åªæ˜¯ä¸ªcliçš„å·¥å…·ï¼Œcliæä¾›äº†buildï¼Œpushï¼Œpullï¼Œrunç­‰åŠŸèƒ½ï¼ŒåŒ…å«äº†æ„å»ºé•œåƒï¼Œæ‰“åŒ…å‘å¸ƒï¼Œæ‹‰å–ï¼Œè¿è¡Œã€‚å…¶å®ä¸è€ƒè™‘è¿™äº›ï¼Œå¯¹äºå…¬å¸çº§åˆ«çš„cicdå·¥å…·æ¥è¯´ï¼Œä¹Ÿæ˜¯è¿™å‡ ä¸ªæµç¨‹ï¼Œæ¯”å¦‚è¯´æˆ‘ä¸€ä¸ªgitä»“åº“åœ°å€ï¼Œå†é€šè¿‡Jenkinsç­‰ciå·¥å…·æ„å»ºï¼Œæ„å»ºå®Œæˆåå‘å¸ƒåˆ°å‘å¸ƒæœºå™¨ä¸Šï¼Œç­‰æˆ‘ä»¬å»å‘å¸ƒçš„æ—¶å€™ï¼Œå°±æ˜¯æ‹‰å–è¿™ä¸ªzipåŒ…/æˆ–è€…é•œåƒï¼Œè§£å‹/è¿è¡Œï¼Œç¨‹åºå»å¯åŠ¨åä¸åœ¨è€ƒè™‘èŒƒå›´å†…ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æœ€ç®€å•æœ€å¸¸è§çš„ã€‚\nâ€‹    æ‰€ä»¥dockeråªæ˜¯æä¾›äº†ä¸€ä¸ªå·¥å…·è¿›è¡Œè¿™ä¸ªæµç¨‹ã€‚æ¢äº†ä¸€ç§æ‰¿è½½æ–¹å¼ã€‚æ¢å¥è¯è¯´å®ƒç¡®å®šäº†è½¯ä»¶ç©¶ç«Ÿåº”è¯¥é€šè¿‡ä»€ä¹ˆæ ·çš„æ–¹å¼è¿›è¡Œäº¤ä»˜ã€‚dockerçš„åˆ›æ–°å°±æ˜¯å°†äº¤ä»˜è½¬å˜ä¸ºå®¹å™¨/é•œåƒï¼Œè§£å†³äº†å¼€å‘äººå‘˜çš„ç—›ç‚¹ã€‚\nâ€‹    æœ¬ç¯‡ä¸è®¨è®ºï¼Œå®šä¹‰å’Œç®¡ç†å®¹å™¨æŠ€æœ¯çš„OpenStack &amp; kubernetes &amp; Docker Swarm &amp; Containerdç­‰ï¼\nâ€‹    psï¼šå­¦ä¹ è¿™äº›åªæ˜¯çœ‹çœ‹è‡ªå·±é€‚ä¸é€‚åˆå­¦ä¹ å®¹å™¨åŒ–æ–¹å‘çš„æŠ€æœ¯ï¼Œæ¯ä¸€ä¸ªæŠ€æœ¯èƒŒåçš„æŠ€æœ¯éƒ½å¾ˆå¤šï¼Œå¦‚æœåªæ˜¯ä½¿ç”¨ï¼Œé‚£ä¹ˆäº†è§£å³å¯ã€‚ä¸ºå•¥è¦å­¦ä¹ å®¹å™¨åŒ–æŠ€æœ¯å‘¢ï¼Œè™½ç„¶ä½œä¸ºä¸€ä¸ªåç«¯å¼€å‘ï¼Œä¸éœ€è¦æŒæ¡å®¹å™¨åŒ–æŠ€æœ¯ï¼Œä½†æ˜¯äº†è§£åªæ˜¯ä¸ºäº†æ€è€ƒå’Œæˆé•¿ï¼\n\n\n1ã€ä»€ä¹ˆæ˜¯å®¹å™¨åŒ–å®¹å™¨åŒ–æ˜¯åº”ç”¨ç¨‹åºçº§åˆ«çš„è™šæ‹ŸåŒ–ï¼Œå…è®¸å•ä¸ªå†…æ ¸ä¸Šæœ‰å¤šä¸ªç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´å®ä¾‹ï¼ˆå®ƒæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯è¿›ç¨‹å†…éƒ¨ç¡®å®ä¸€ä¸ªå®Œæ•´çš„è¿è¡Œç¯å¢ƒï¼‰ã€‚è¿™äº›å®ä¾‹ç§°ä¸ºå®¹å™¨ã€‚\né‚£ä¹ˆè™šæ‹ŸåŒ–æ˜¯ä»€ä¹ˆï¼Ÿè™šæ‹ŸåŒ–æ˜¯æŒ‡ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰ä¸­åˆ›å»ºè™šæ‹Ÿæœºã€‚\nè™šæ‹ŸåŒ–ï¼šè™šæ‹Ÿæœºç›‘è§†å™¨ï¼ˆHypervisorï¼‰æ˜¯å®‰è£…åœ¨ç‰©ç†ç¡¬ä»¶ä¸Šçš„è½¯ä»¶å±‚ï¼Œå¯ä»¥å°†ç‰©ç†æœºé€šè¿‡è™šæ‹ŸåŒ–åˆ†æˆè®¸å¤šè™šæ‹Ÿæœºã€‚è¿™æ ·å¤šä¸ªæ“ä½œç³»ç»Ÿå¯ä»¥åœ¨ä¸€ä¸ªç‰©ç†ç¡¬ä»¶ä¸ŠåŒæ—¶è¿è¡Œã€‚å®‰è£…åœ¨è™šæ‹Ÿæœºä¸Šçš„æ“ä½œç³»ç»Ÿç§°ä¸ºè™šæ‹Ÿæ“ä½œç³»ç»Ÿï¼Œä¹Ÿç§°ä¸ºå®ä¾‹ã€‚æœ‰è™šæ‹Ÿæœºç›‘è§†å™¨è¿è¡Œçš„ç¡¬ä»¶ç§°ä¸ºä¸»æœºã€‚è™šæ‹Ÿæœºç®¡ç†æ§åˆ¶å°ï¼ˆä¹Ÿç§°ä¸ºè™šæ‹Ÿæœºç®¡ç†å‘˜ï¼ˆVMMï¼‰ï¼‰æ˜¯ä¸€ç§è®¡ç®—æœºè½¯ä»¶ï¼Œå¯ä»¥è½»æ¾ç®¡ç†è™šæ‹Ÿæœºã€‚å…³äºè™šæ‹Ÿæœºçš„åˆ†ç±»ï¼šhttps://www.alibabacloud.com/zh/knowledge/what-is-hypervisor\nå…³äºè™šæ‹Ÿæœºçš„å®ç°ï¼Œç›¸å…³è®¨è®ºï¼šhttps://www.zhihu.com/question/20848931 \n\nä¸Šå›¾æ˜¯è™šæ‹Ÿæœºä¸å®¹å™¨çš„åŒºåˆ«ï¼ï¼Œè¯¦ç»†å¯ä»¥çœ‹ï¼šhttps://www.alibabacloud.com/zh/knowledge/difference-between-container-and-virtual-machine ï¼Œ å¯ä»¥å‘ç°æ¯ä¸ªè™šæ‹Ÿæœºéƒ½æœ‰å•ç‹¬çš„æ“ä½œç³»ç»Ÿï¼Œè€Œå®¹å™¨æ˜¯ä¸éœ€è¦çš„ã€‚ä½†æ˜¯å®¹å™¨çœŸçš„ä¸éœ€è¦å•ç‹¬çš„æ“ä½œç³»ç»Ÿå—ï¼Œä½ è¿˜è®°å¾—dockerfileä¸­æ¯ä¸€ä¸ªé•œåƒéƒ½éœ€è¦åˆ¶å®šä¸€ä¸ªè¿è¡Œç¯å¢ƒã€‚é‚£ä¹ˆä¸Šé¢è¿™ä¸ªå›¾æ˜¯é”™è¯¯çš„å—ï¼Ÿï¼Ÿï¼Ÿ\nå…¶å®å¾ˆå¤šäººåº”è¯¥æ³¨æ„åˆ°ï¼Œè¿™ä¸ªé“¾æ¥æœ‰è§£é‡Šï¼šhttps://stackoverflow.com/questions/32841982/how-can-docker-run-distros-with-different-kernels\n\nThereâ€™s no kernel inside a container. Even if you install a kernel, it wonâ€™t be loaded when the container starts. The very purpose of a container is to isolate processes without the need to run a new kernel.\n\nå®¹å™¨å†…æ²¡æœ‰å†…æ ¸ã€‚å³ä½¿æ‚¨å®‰è£…äº†å†…æ ¸ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶ä¹Ÿä¸ä¼šåŠ è½½è¯¥å†…æ ¸ã€‚å®¹å™¨çš„çœŸæ­£ç›®çš„æ˜¯åœ¨ä¸è¿è¡Œæ–°å†…æ ¸çš„æƒ…å†µä¸‹éš”ç¦»è¿›ç¨‹ã€‚\né‚£ä¹ˆå®¹å™¨å®ç°çš„æŠ€æœ¯ï¼Œè¿™é‡Œä¹Ÿä¸è¯¦ç»†å±•å¼€äº†ï¼Œä¸»è¦æ˜¯ä¾èµ–äºlinuxç³»ç»Ÿæœ¬èº«è‡ªå¸¦çš„éš”ç¦»åŠŸèƒ½ï¼\n\n\nä¸»è¦æ ¸å¿ƒå°±æ˜¯èµ„æºéš”ç¦»(åšåˆ°å®¹å™¨äº’ä¸å½±å“å¾ˆå…³é”®)ï¼Œä½¿ç”¨æŠ€æœ¯å°±æ˜¯ cgroup å¯¹äºcpuã€memoryçš„é™åˆ¶ï¼Œä»¥åŠnamespaceç­‰ï¼Œå…¶å®è¿™äº›æŠ€æœ¯éƒ½æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ï¼Œå¯¹äºdockerçš„ä½œè€…ä¹Ÿæ˜¯åŸºäºè¿™äº›è¿›è¡Œå®ç°çš„ï¼Œæ‰€ä»¥dockerçš„æˆåŠŸæ˜¯å¯èƒ½å°±æ˜¯æœºé‡å§ï¼Œè€Œä¸æ˜¯dockerçš„æŠ€æœ¯ï¼ï¼dockerå…¬å¸å‰èº«å°±æ˜¯ä¸ªäº‘æœåŠ¡æä¾›å•†ï¼\næœ‰å…´è¶£å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼šå®¹å™¨å‘å±•ç®€å² ä»¥åŠ å®¹å™¨çš„éš”ç¦»ä¸é™åˆ¶ï¼Œ Cgroupä»‹ç»\nåšäº‘åŸç”Ÿå¼€å‘å·¥ç¨‹å¸ˆï¼Œéœ€è¦æŒæ¡Kubernetesï¼ŒDockerï¼ŒService Meshç­‰é¢†åŸŸç›¸å…³çš„çŸ¥è¯†ï¼Œå¹¶ä¸”æœ‰å®è·µï¼Œäº¤ä»˜ç»éªŒï¼Œé“é˜»ä¸”é•¿ï¼Œæœ¬äººä¹Ÿæ˜¯å…´è¶£ã€‚\n2ã€å®¹å™¨åŒ–å‘å±•å†å²\nâ€‹    è¿™ä¸€ç¯‡ä¸»è¦æ˜¯ä»‹ç»ï¼Œå®¹å™¨åŒ–èµ°è¿‡è¿™ä¹ˆå¤šå¹´ï¼Œéš¾é“çœŸçš„æ˜¯å› ä¸ºdockerå‡ºç”Ÿæ‰ç«çš„å—ï¼Œè¿˜æ˜¯æ—¶ä»£çš„è¶‹åŠ¿ï¼è™½ç„¶ docker æŠŠå®¹å™¨æŠ€æœ¯æ¨å‘äº†å·…å³°ï¼Œä½†å®¹å™¨æŠ€æœ¯å´ä¸æ˜¯ä» docker è¯ç”Ÿçš„ã€‚\n\n1ã€å®¹å™¨åŒ–å‘å±•å†å²\n1ã€Chroot Jailå°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ chroot å‘½ä»¤çš„ç”¨æ³•ã€‚å®ƒåœ¨ 1979 å¹´çš„æ—¶å€™å°±å‡ºç°äº†ï¼Œè¢«è®¤ä¸ºæ˜¯æœ€æ—©çš„å®¹å™¨åŒ–æŠ€æœ¯ä¹‹ä¸€ã€‚å®ƒå¯ä»¥æŠŠä¸€ä¸ªè¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿéš”ç¦»èµ·æ¥ã€‚\n2ã€The FreeBSD JailFreebsd Jail å®ç°äº†æ“ä½œç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«è™šæ‹ŸåŒ–æŠ€æœ¯çš„å…ˆé©±ä¹‹ä¸€ã€‚\n3ã€Linux VServerä½¿ç”¨æ·»åŠ åˆ° Linux å†…æ ¸çš„ç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–åŠŸèƒ½å®ç°çš„ä¸“ç”¨è™šæ‹ŸæœåŠ¡å™¨ã€‚\n4ã€Solaris Containerså®ƒä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä¸“ä¸º X86 å’Œ SPARC ç³»ç»Ÿè®¾è®¡ã€‚Solaris å®¹å™¨æ˜¯ç³»ç»Ÿèµ„æºæ§åˆ¶å’Œé€šè¿‡ â€œåŒºåŸŸâ€ æä¾›è¾¹ç•Œéš”ç¦»çš„ç»„åˆã€‚\n5ã€OpenVZOpenVZ æ˜¯ä¸€ç§ Linux ä¸­æ“ä½œç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚ å®ƒå…è®¸åˆ›å»ºå¤šä¸ªå®‰å…¨éš”ç¦»çš„ Linux å®¹å™¨ï¼Œå³ VPSã€‚\n6ã€Process ContainersProcess å®¹å™¨ç”± Google çš„å·¥ç¨‹å¸ˆå¼€å‘ï¼Œä¸€èˆ¬è¢«ç§°ä¸º cgroupsã€‚\n7ã€LXC2008å¹´ï¼Œé€šè¿‡å°† Cgroups çš„èµ„æºç®¡ç†èƒ½åŠ›å’Œ Linux Namespace çš„è§†å›¾éš”ç¦»èƒ½åŠ›ç»„åˆåœ¨ä¸€èµ·ï¼ŒLXCï¼ˆLinux Containerï¼‰è¿™æ ·çš„å®Œæ•´çš„å®¹å™¨æŠ€æœ¯å‡ºç°åœ¨äº† Linux å†…æ ¸å½“ä¸­ã€‚ï¼ˆ0.9ä¸€ä¸‹çš„ä½ç‰ˆæœ¬çš„dockerå°±æ˜¯åˆ©ç”¨çš„è¿™ä¸ªæŠ€æœ¯ï¼ï¼ï¼‰\n8ã€Wardenåœ¨æœ€åˆé˜¶æ®µï¼ŒWarden ä½¿ç”¨ LXC ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚ å¦‚ä»Šå·²è¢« CloudFoundy ï¼ˆ VMware å…¬å¸äº 2011 å¹´å®£å¸ƒäº†è¿™ä¸ªé¡¹ç›®çš„å¼€æºï¼Œç¬¬ä¸€æ¬¡å¯¹ PaaS çš„æ¦‚å¿µå®Œæˆäº†æ¸…æ™°è€Œå®Œæ•´çš„å®šä¹‰ï¼ŒPaaS é¡¹ç›®é€šè¿‡å¯¹åº”ç”¨çš„ç›´æ¥ç®¡ç†ã€ç¼–æ’å’Œè°ƒåº¦è®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€ŒéåŸºç¡€è®¾æ–½ï¼‰å–ä»£ã€‚\n9ã€LMCTFYLMCTY æ˜¯ Let me contain that for you çš„ç¼©å†™ã€‚å®ƒæ˜¯ Google çš„å®¹å™¨æŠ€æœ¯æ ˆçš„å¼€æºç‰ˆæœ¬ã€‚Google çš„å·¥ç¨‹å¸ˆä¸€ç›´åœ¨ä¸ docker çš„ libertainer å›¢é˜Ÿåˆä½œï¼Œå¹¶å°† libertainer çš„æ ¸å¿ƒæ¦‚å¿µè¿›è¡ŒæŠ½è±¡å¹¶ç§»æ¤åˆ°æ­¤é¡¹ç›®ä¸­ã€‚è¯¥é¡¹ç›®çš„è¿›å±•ä¸æ˜ï¼Œä¼°è®¡ä¼šè¢« libcontainer å–ä»£ã€‚ï¼ˆ0.9ä»¥ä¸Šçš„é«˜ç‰ˆæœ¬çš„dockerå°±æ˜¯åˆ©ç”¨çš„libcontainerï¼Œå…¶å®å°±æ˜¯å¯¹äºlxcçš„å°è£…ï¼Œç”¨goå†™çš„ï¼Œå¼€å‘èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼‰\n10ã€Docker\nDocker æ˜¯ä¸€ä¸ªå¯ä»¥å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°å‡ ä¹å¯ä»¥åœ¨ä»»ä½•æœåŠ¡å™¨ä¸Šè¿è¡Œçš„å®¹å™¨çš„å·¥å…·ã€‚ï¼ˆdotCloudå…¬å¸å¼€æºçš„è‡ªå·±çš„å®¹å™¨åŒ–æŠ€æœ¯ï¼Œæœ€åå…¬å¸ç›´æ¥æ”¹åå­—å«ä¸ºdockeräº†ï¼‰\n11ã€Docker-Swarm\nDockerå…¬å¸åœ¨2014å¹´12æœˆçš„DockerConä¸Šå‘å¸ƒSwarmçš„ä¸¾åŠ¨ï¼Œä½ å¯ä»¥å¾ˆè½»æ¾çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥å°†å®¹å™¨è°ƒåº¦åœ¨ä»»æ„ä¸€å°Swarmé›†ç¾¤çš„æœºå™¨ä¸Šã€‚dockerçš„è¡°è´¥ä¹Ÿæ˜¯å› ä¸ºåœ¨å®¹å™¨ç¼–æ’æŠ€æœ¯ä¹‹äº‰ä¸­è·Œè½ç¥å›çš„ã€‚\n12ã€Fig\ndockerçš„å¤§ç´«å¤§çº¢ï¼Œåæ¥æ”¶è´­äº†Figé¡¹ç›®ï¼Œä»–å¯ä»¥è§£å†³å®¹å™¨ä¹‹é—´ä¾èµ–çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„docker-composeé¡¹ç›®ï¼Œå‰èº«å°±æ˜¯Figã€‚\ndockeræˆåŠŸåï¼Œæ”¶è´­äº†å¾ˆå¤šå¥½çš„é¡¹ç›®ï¼Œä¸“é—¨è´Ÿè´£å¤„ç†å®¹å™¨ç½‘ç»œçš„SocketPlaneé¡¹ç›®ï¼Œä¸“é—¨è´Ÿè´£å¤„ç†å®¹å™¨å­˜å‚¨çš„Flockeré¡¹ç›®ï¼Œä¸“é—¨ç»™Dockeré›†ç¾¤åšå›¾å½¢åŒ–ç®¡ç†ç•Œé¢å’Œå¯¹å¤–æä¾›äº‘æœåŠ¡çš„Tutumé¡¹ç›®ã€‚\n13ã€RKTRKT æ˜¯ Rocket çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸“æ³¨äºå®‰å…¨å’Œå¼€æ”¾æ ‡å‡†çš„åº”ç”¨ç¨‹åºå®¹å™¨å¼•æ“ã€‚ï¼ˆåŸæ¥dockerçš„åˆä½œä¼™ä¼´CoreOSå…¬å¸ï¼ŒCoreOSå…¬å¸è‡ªå·±ç ”å‘çš„å®¹å™¨åŒ–å·¥å…·ï¼‰\n13ã€ç»ˆç»“è€…Kubernetes\nâ€‹    2017å¹´,  åŸºç¡€è®¾æ–½é¢†åŸŸçš„ç¿˜æ¥šGoogleå…¬å¸çªç„¶å‘åŠ›ï¼Œæ­£å¼å®£å‘Šäº†ä¸€ä¸ªåå«Kubernetesé¡¹ç›®çš„è¯ç”Ÿã€‚è¿™ä¸ªé¡¹ç›®ï¼Œä¸ä»…æŒ½æ•‘äº†å½“æ—¶çš„CoreOSå’ŒRedHatï¼Œè¿˜å¦‚åŒå½“å¹´Dockeré¡¹ç›®çš„æ¨ªç©ºå‡ºä¸–ä¸€æ ·ï¼Œå†ä¸€æ¬¡æ”¹å˜äº†æ•´ä¸ªå®¹å™¨å¸‚åœºçš„æ ¼å±€ã€‚å¹¶å°† CNCF è¿™ä¸ªä»¥â€œäº‘åŸç”Ÿâ€ä¸ºå…³é”®è¯çš„ç»„ç»‡å’Œç”Ÿæ€æ¨å‘äº†å·…å³°ã€‚\n2ã€å®¹å™¨åŒ–çš„ä¸€äº›åè¯å…¶å®çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å‘ç°å®¹å™¨åŒ–æŠ€æœ¯å‘å±•äº†è¿™ä¹ˆå¤šå¹´ï¼ŒæŠ€æœ¯å˜æ›´è¿™ä¹ˆå¿«çš„å¹´ä»£ï¼Œæœ€å¯æ€•çš„æ˜¯ï¼Œæˆ‘å­¦äº†ä¸€é—¨æŠ€æœ¯ï¼Œç«‹é©¬è¢«æ·˜æ±°äº†ï¼Œæ‰€ä»¥dockerä¹Ÿæ˜¯ï¼Œä¸ºäº†ä¿éšœdockerçš„æ ‡å‡†åŒ–ï¼Œåšå‡ºäº†ä¸€ç³»åˆ—çš„åŠªåŠ›ã€‚\n1ã€Docker &amp; LXCDocker çš„ç¬¬ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒæ˜¯ LXCï¼Œä½†ä»ç‰ˆæœ¬ 0.9 å¼€å§‹ LXC è¢« libcontainer å–ä»£ã€‚\n2ã€Docker &amp; libcontainerLibcontainer ä¸º docker å°è£…äº† Linux æä¾›çš„åŸºç¡€åŠŸèƒ½ï¼Œå¦‚ cgroupsï¼Œnamespacesï¼Œnetlink å’Œ netfilter ç­‰\n3ã€2015 - Docker ï¼† runC\n2015 å¹´ï¼Œdocker å‘å¸ƒäº† runCï¼Œä¸€ä¸ªè½»é‡çº§çš„è·¨å¹³å°çš„å®¹å™¨è¿è¡Œæ—¶ã€‚ è¿™åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå°å·¥å…·ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ libcontainer è¿è¡Œå®¹å™¨ï¼Œè€Œæ— éœ€é€šè¿‡ docker engineã€‚runC çš„ç›®æ ‡æ˜¯ä½¿æ ‡å‡†å®¹å™¨åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ç”¨ã€‚\n4ã€Docker &amp; The Open Containers Initiative(OCI)OCI æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¼€æ”¾å¼ç®¡ç†æ¶æ„ï¼Œç”± dockerï¼ŒCoreOS å’Œå®¹å™¨è¡Œä¸šçš„å…¶ä»–é¢†å¯¼å‚å•†äº 2015 å¹´å»ºç«‹ã€‚å®ƒç»´æŠ¤ä¸€äº›é¡¹ç›®ï¼Œå¦‚ runC ï¼Œè¿˜æœ‰å®¹å™¨è¿è¡Œæ—¶è§„èŒƒå’Œé•œåƒè§„èŒƒã€‚OCI çš„ç›®çš„æ˜¯å›´ç»•å®¹å™¨è¡Œä¸šåˆ¶å®šæ ‡å‡†ï¼Œæ¯”å¦‚ä½¿ç”¨ docker åˆ›å»ºçš„å®¹å™¨å¯ä»¥åœ¨ä»»ä½•å…¶ä»–å®¹å™¨å¼•æ“ä¸Šè¿è¡Œã€‚\n5ã€2016 - Docker &amp; containerd\n2016å¹´ï¼ŒDocker åˆ†æ‹†äº† containerd ï¼Œå¹¶å°†å…¶æèµ ç»™äº†ç¤¾åŒºã€‚å°†è¿™ä¸ªç»„ä»¶åˆ†è§£ä¸ºä¸€ä¸ªå•ç‹¬çš„é¡¹ç›®ï¼Œä½¿å¾— docker å°†å®¹å™¨çš„ç®¡ç†åŠŸèƒ½ç§»å‡º docker çš„æ ¸å¿ƒå¼•æ“å¹¶ç§»å…¥ä¸€ä¸ªå•ç‹¬çš„å®ˆæŠ¤è¿›ç¨‹(å³ containerd)ã€‚è¿™ä¸ªç»„ä»¶çš„å‰¥ç¦»å¾ˆå¥½çš„å®ç°äº†å¼€å‘è€…å¯ä»¥ä»¥ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†å®¹å™¨ï¼\n6ã€Docker Componentsåˆ†æ‹†å®Œ containerd åï¼Œdocker å„ç»„ä»¶çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n7ã€Docker å¦‚ä½•è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Ÿ\n\nDocker å¼•æ“åˆ›å»ºå®¹å™¨é•œåƒ(ociè§„èŒƒ)\nå°†å®¹å™¨æ˜ åƒä¼ é€’ç»™ containerd\ncontainerd è°ƒç”¨ containerd-shim\ncontainerd-shim ä½¿ç”¨ runC æ¥è¿è¡Œå®¹å™¨\ncontainerd-shim å…è®¸è¿è¡Œæ—¶(æœ¬ä¾‹ä¸­ä¸º runC)åœ¨å¯åŠ¨å®¹å™¨åé€€å‡º\n\nè¯¥æ¨¡å‹å¸¦æ¥çš„æœ€å¤§å¥½å¤„æ˜¯åœ¨å‡çº§ docker å¼•æ“æ—¶ä¸ä¼šä¸­æ–­å®¹å™¨çš„è¿è¡Œã€‚\n8ã€2017 - å®¹å™¨æˆä¸ºä¸»æµ\n2017 å¹´æ˜¯å®¹å™¨æˆä¸ºä¸»æµæŠ€æœ¯çš„ä¸€å¹´ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ docker åœ¨ Linux ä¹‹å¤–æ”¯æŒä¼—å¤šå¹³å°çš„åŸå› ï¼ˆDocker for Macï¼ŒDocker for Windowsï¼ŒDocker for AWSï¼ŒGCP ç­‰ï¼‰ã€‚\nå½“å®¹å™¨æŠ€æœ¯è¢«å¤§ä¼—æ¥å—åï¼ŒDocker å…¬å¸æ„è¯†åˆ°éœ€è¦æ–°çš„ç”Ÿäº§æ¨¡å‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒå¼€å§‹ Moby é¡¹ç›®ã€‚æœ€ä¸ºgoè¯­è¨€å¼€æºé¡¹ç›®çš„top3çš„é¡¹ç›®ï¼Œä¸€å¼€å§‹æˆ‘ä¹Ÿä¸çŸ¥é“mobyé¡¹ç›®æ˜¯åšå•¥äº†ã€‚ã€‚ã€‚\nå…¶å®å¯ä»¥å‘ç°ï¼Œåœ¨è¿™ä¸ªç™¾èŠ±é½æ”¾çš„æ“ä½œç³»ç»Ÿå¹³å°ä¸Šï¼Œå¦‚ä½•ä¸è¿›è¡Œcase by caseï¼Œé‡å¤é€ è½®å­ï¼Œå°±æ˜¯æ‹†åˆ†ï¼Œé€šç”¨ç»„ä»¶ï¼Œç°æˆçš„ç›´æ¥ä½¿ç”¨å°±è¡Œäº†ã€‚mobyå°±æ˜¯è¿™ä¸ª\n3ã€å®¹å™¨åŒ–åšçš„ä¸€äº›è½¬å˜ä¸»è¦è¿˜æ˜¯å¼€æºå‡ºmobyé¡¹ç›®ï¼Œhttps://github.com/moby/moby\nï¼ˆ1ï¼‰ContainerdContainerd æ˜¯ docker åŸºäºè¡Œä¸šæ ‡å‡†åˆ›å»ºçš„æ ¸å¿ƒå®¹å™¨è¿è¡Œæ—¶ã€‚å®ƒå¯ä»¥ç”¨ä½œ Linux å’Œ Windows çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ç®¡ç†æ•´ä¸ªå®¹å™¨ç”Ÿå‘½å‘¨æœŸã€‚\nï¼ˆ2ï¼‰LinuxkitLinuxkit æ˜¯ Moby é¡¹ç›®ä¸­çš„å¦ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒæ˜¯ä¸ºå®¹å™¨æ„å»ºå®‰å…¨ã€è·¨å¹³å°ã€ç²¾ç®€ç³»ç»Ÿçš„å·¥å…·ã€‚ç›®å‰å·²ç»æ”¯æŒçš„æœ¬åœ° hypervisor æœ‰ hyper-v å’Œ vmwareã€‚æ”¯æŒçš„äº‘å¹³å°æœ‰ AWSã€Azure ç­‰ã€‚\nï¼ˆ3ï¼‰InfrakitInfrakit ä¹Ÿæ˜¯ Moby é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚å®ƒæ˜¯åˆ›å»ºå’Œç®¡ç†å£°æ˜å¼ã€ä¸å¯å˜å’Œè‡ªæˆ‘ä¿®å¤åŸºç¡€æ¶æ„çš„å·¥å…·åŒ…ã€‚Infrakit æ—¨åœ¨è‡ªåŠ¨åŒ–åŸºç¡€æ¶æ„çš„è®¾ç½®å’Œç®¡ç†ï¼Œä»¥æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿå’Œæ›´é«˜çº§åˆ«çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿã€‚Infrakit å¯¹äºåƒ Docker Swarm å’Œ Kubernetes è¿™æ ·çš„ç¼–æ’å·¥å…·æˆ–è·¨è¶Š AWS ç­‰å…¬å…±äº‘åˆ›å»ºè‡ªåŠ¨ç¼©æ”¾ç¾¤é›†çš„ç”¨ä¾‹å¾ˆæœ‰ç”¨ã€‚\nï¼ˆ4ï¼‰LibnetworkLibnetwork æ˜¯ç”¨ Go è¯­è¨€å®ç°çš„å®¹å™¨ç½‘ç»œç®¡ç†é¡¹ç›®ã€‚å®ƒçš„ç›®æ ‡æ˜¯å®šä¹‰ä¸€ä¸ªå®¹å™¨ç½‘ç»œæ¨¡å‹(CNM)ï¼Œå¹¶ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€è‡´çš„ç¼–ç¨‹æ¥å£ä»¥åŠç½‘ç»œæŠ½è±¡ã€‚è¿™æ ·å°±å¯ä»¥æ»¡è¶³å®¹å™¨ç½‘ç»œçš„ â€œå¯ç»„åˆâ€ éœ€æ±‚ã€‚\nï¼ˆ5ï¼‰Docker &amp; Docker SwarmDocker Swarm æ˜¯ä¸€ä¸ªåœ¨ docker å¼•æ“ä¸­æ„å»ºçš„ç¼–æ’å·¥å…·ã€‚ä» docker 1.12 å¼€å§‹å®ƒå°±ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·è¢«åŸç”ŸåŒ…å«åœ¨ docker engine ä¸­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ docker cli é€šè¿‡ docker swarm åˆ›å»ºç¾¤é›†ï¼Œå¹¶éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ã€‚ä¸‹å›¾æè¿°äº† docker swarm åœ¨ docker ä½“ç³»ä¸­çš„ä½œç”¨(æ­¤å›¾æ¥è‡ªäº’è”ç½‘)ï¼š\nï¼ˆ6ï¼‰Dockerï¼†Kubernetesåœ¨ docker swarm ä¸ kubernetes çš„ç«äº‰ä¸­ï¼Œæ˜¾ç„¶æ˜¯ kubernetes å æ®äº†ä¼˜åŠ¿ã€‚æ‰€ä»¥ docker ç´§æ€¥æ‰å¤´ï¼Œå¼€å§‹åŸç”Ÿçš„æ”¯æŒä¸ kubernetes çš„é›†æˆã€‚è¿™å¯æ˜¯ 2017 å¹´å®¹å™¨ç•Œçš„ä¸€å¤§æ–°é—»å•Šï¼è‡³æ­¤ï¼Œdocker ç”¨æˆ·å’Œå¼€å‘äººå‘˜å¯ä»¥è‡ªç”±åœ°é€‰æ‹©ä½¿ç”¨ kubernetes æˆ–æ˜¯ swarm æ‰§è¡Œå®¹å™¨çš„ç¼–æ’å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸º docker ä¸ kubernetes è”å§»äº†ã€‚\n\næ–‡ç« å‚è€ƒï¼š https://www.cnblogs.com/along21/p/9183609.html\nèŒ«èŒ«çš„å®¹å™¨åŒ–æŠ€æœ¯ï¼Œä¸æ˜¯ä¸€ç¯‡æ–‡ç« èƒ½è¯´æ¸…æ¥šçš„ï¼Œç†è§£å…¶æœ¬è´¨ä¹Ÿä¸çŸ¥æ˜¯è¯´ï¼Œæˆ‘äº†è§£namespcaeå’Œcgropuså°±èƒ½è¯´äº†è§£çš„ã€‚\n3ã€å®¹å™¨åŒ–æŠ€æœ¯è§£å†³äº†ä»€ä¹ˆæˆ‘æƒ³å¾ˆå¤šå…¬å¸éƒ½åœ¨ä½¿ç”¨äº‘æœåŠ¡å•†æä¾›çš„è™šæ‹Ÿæœºï¼Œå…¶ä¸­èµ„æºæµªè´¹ç®€ç›´æ˜¯ä¸èƒ½çœ‹ï¼ŒåŸºæœ¬èµ„æºåˆ©ç”¨ç‡åœ¨80-90%ä¹‹é—´ï¼Œæ‰€ä»¥æ€¥éœ€ä¸€ä¸ªè½»é‡çº§çš„è¿è¡Œæ—¶ã€‚å®¹å™¨æä¾›äº†å°†åº”ç”¨ç¨‹åºçš„ä»£ç ã€è¿è¡Œæ—¶ã€ç³»ç»Ÿå·¥å…·ã€ç³»ç»Ÿåº“å’Œé…ç½®æ‰“åŒ…åˆ°ä¸€ä¸ªå®ä¾‹ä¸­çš„æ ‡å‡†æ–¹æ³•ã€‚å®¹å™¨å…±äº«ä¸€ä¸ªå†…æ ¸ï¼ˆæ“ä½œç³»ç»Ÿï¼‰ï¼Œå®ƒå®‰è£…åœ¨ç¡¬ä»¶ä¸Šã€‚\nå¥½å¤„ï¼šï¼ˆæˆ‘è§‰å¾—å¾ˆå¤šäººéƒ½çŸ¥é“ï¼‰\nè½»ä¾¿å®¹å™¨å ç”¨çš„æœåŠ¡å™¨ç©ºé—´æ¯”è™šæ‹Ÿæœºå°‘ï¼Œé€šå¸¸åªéœ€å‡ ç§’é’Ÿå³å¯å¯åŠ¨ã€‚\n\nå¼¹æ€§å®¹å™¨å…·æœ‰é«˜å¼¹æ€§ï¼Œä¸éœ€è¦åˆ†é…ç»™å®šæ•°é‡çš„èµ„æºã€‚è¿™æ„å‘³ç€å®¹å™¨èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°åŠ¨æ€ä½¿ç”¨æœåŠ¡å™¨ä¸­çš„èµ„æºã€‚å½“ä¸€ä¸ªå®¹å™¨ä¸Šçš„éœ€æ±‚å‡å°‘æ—¶ï¼Œé‡Šæ”¾é¢å¤–çš„èµ„æºä¾›å…¶ä»–å®¹å™¨ä½¿ç”¨ã€‚\n\nå¯†åº¦å¯†åº¦æ˜¯æŒ‡ä¸€æ¬¡å¯ä»¥è¿è¡Œå•ä¸ªç‰©ç†æœåŠ¡å™¨çš„å¯¹è±¡æ•°ã€‚å®¹å™¨åŒ–å…è®¸åˆ›å»ºå¯†é›†çš„ç¯å¢ƒï¼Œå…¶ä¸­ä¸»æœºæœåŠ¡å™¨çš„èµ„æºè¢«å……åˆ†åˆ©ç”¨ä½†ä¸è¢«è¿‡åº¦åˆ©ç”¨ã€‚ä¸ä¼ ç»Ÿè™šæ‹ŸåŒ–ç›¸æ¯”ï¼Œå®¹å™¨åŒ–å…è®¸æ›´å¯†é›†çš„ç¯å¢ƒå®¹å™¨ä¸éœ€è¦æ‰˜ç®¡è‡ªå·±çš„æ“ä½œç³»ç»Ÿã€‚\n\næ€§èƒ½å½“èµ„æºå‹åŠ›å¾ˆå¤§æ—¶ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½è¿œè¿œé«˜äºä½¿ç”¨è™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„å®¹å™¨ã€‚å› ä¸ºä½¿ç”¨ä¼ ç»Ÿçš„è™šæ‹ŸåŒ–ï¼Œå®¢æˆ·æ“ä½œç³»ç»Ÿè¿˜å¿…é¡»æ»¡è¶³å…¶è‡ªèº«çš„å†…å­˜éœ€æ±‚ï¼Œä»ä¸»æœºä¸Šè·å–å®è´µçš„RAMã€‚\n\nç»´æŠ¤æ•ˆç‡åªæœ‰ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ“ä½œç³»ç»Ÿçº§åˆ«çš„æ›´æ–°æˆ–è¡¥ä¸åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œä»¥ä½¿æ›´æ”¹åœ¨æ‰€æœ‰å®¹å™¨ä¸­ç”Ÿæ•ˆã€‚è¿™ä½¿å¾—æœåŠ¡å™¨çš„æ“ä½œå’Œç»´æŠ¤æ›´åŠ é«˜æ•ˆã€‚\n\næ–¹ä¾¿åº”ç”¨ç¨‹åºç®¡ç†\nå®¹å™¨å—ç›Šè€…ï¼Œä¸»è¦è¿˜æ˜¯ç¯å¢ƒéš”ç¦»ï¼Œæ¯”å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œ1ã€éœ€è¦superviseå¯åŠ¨åº”ç”¨ç¨‹åº(å®ˆæŠ¤ç¨‹åº)ï¼Œ2ã€éœ€è¦logstash/Filebeatæ”¶é›†æ—¥å¿—ï¼Œ3ã€éœ€è¦nginx/å…¶ä»–Sadicarè¿›è¡Œä¸€äº›æœåŠ¡æ²»ç†çš„åŠŸèƒ½ï¼ŒæœåŠ¡å‘ç°/é™æµ/ç†”æ–­ç­‰ã€‚4ã€è¿˜éœ€è¦å¾ˆå¤šè¿è¡Œç¯å¢ƒã€‚æ‰€ä»¥å¯¹äºå¿«é€Ÿå‘å±•çš„å…¬å¸æ¥è¯´ï¼Œsreå¦‚æœè¿˜æ˜¯æ‰‹åŠ¨çš„åˆ›å»ºè™šæ‹Ÿæœºï¼Œé‚£ä¹ˆå’Œå®¹å™¨å¸¦æ¥çš„æ—¶é—´ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ã€‚5ã€è§£å†³äº†å¼€å‘äººå‘˜ä¸éœ€è¦ç™»é™†åˆ°æœºå­ä¸ŠæŸ¥çœ‹ç‰©ç†æœºä¿¡æ¯äº†ã€‚\n\nçœé’±ï¼Œçœæœºå™¨\nè™šæ‹Ÿæœºèµ„æºåˆ©ç”¨ç‡å¤ªä½äº†ï¼Œä½†æ˜¯é…åˆk8sç¼–æ’å·¥å…·ï¼Œå¾ˆå¥½çš„è§£å†³äº†èµ„æºçš„æµªè´¹ã€‚ä½†æ˜¯k8sæŠ€æœ¯å¯¹äºå…¬å¸ä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œç©ä¸å¥½æœåŠ¡ä¸ç¨³å®šï¼Œå¸¦æ¥çš„æŸå¤±è¿˜æ˜¯ä¸å¦‚èµ°ç‰©ç†æœº/è™šæ‹Ÿæœºã€‚\n\n\n4ã€å®¹å™¨åŒ–/äº‘åŸç”Ÿçš„æŠ€æœ¯1ã€OCIï¼ˆOpen Container Initiativeï¼‰ æ ‡å‡†ï¼Œéš”ç¦»äº†å®¹å™¨é•œåƒä¸runtineçš„å…³ç³»ï¼Œæä¾›çš„è§„èŒƒæ ‡å‡†ï¼Œ\n2ã€CNCFå…¨ç§°Cloud Native Computing Foundationï¼ˆäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼‰ï¼Œæˆç«‹äº 2015 å¹´7æœˆ21æ—¥ï¼Œç»„ç»‡å†…æŠ€æœ¯æ ˆï¼šhttps://www.cncf.io/projects/ï¼Œè‡´åŠ›äºï¼š\n\nå®¹å™¨åŒ–åŒ…è£…ã€‚\né€šè¿‡ä¸­å¿ƒç¼–æ’ç³»ç»Ÿçš„åŠ¨æ€èµ„æºç®¡ç†ã€‚\né¢å‘å¾®æœåŠ¡ã€‚(æ ¸å¿ƒè¿˜æ˜¯åˆ‡å…¥åˆ°çœŸå®ä¸šåŠ¡å¼€å‘ä¸­)\n\n3ã€Linuxèµ„æºéš”ç¦»æŠ€æœ¯äº†è§£\n4ã€Kubernetesç†Ÿæ‚‰ï¼Œæœ‰Operatoræ‰©å±•æˆ–ç›¸å…³äº§å“ç ”å‘ç»éªŒä¼˜å…ˆ\n5ã€ Dockerçš„ç›¸å…³çš„ç½‘ç»œå’Œå­˜å‚¨æŠ€æœ¯ï¼Œæœ‰ç”Ÿäº§ç¯å¢ƒçš„å®è·µ\n6ã€äº‘åŸç”ŸæŠ€æœ¯æ ˆï¼ŒPrometheusï¼ŒEnvoyç­‰ï¼Œæ›´å¤šçš„è¿˜æ˜¯CNCFçš„æ¯•ä¸šçš„é¡¹ç›®çš„ã€‚\n7ã€æ›´å¤šçš„è¿˜æ˜¯ Iassï¼ŒPassç³»ç»Ÿå¼€å‘è€…ç»éªŒï¼Œç©ºè°ˆæŠ€æœ¯ä¸åŠ¡å®ï¼Œå°±æ˜¯æœ€æ‰¯æ·¡çš„ã€‚\n5ã€å®¹å™¨åŒ–æŠ€æœ¯é¢ä¸´çš„æŒ‘æˆ˜â€‹    ä½œä¸ºä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå®¹å™¨ä½¿ç”¨æ–¹ä¾¿ã€æ“ä½œä¾¿æ·ï¼Œå¤§å¤§æé«˜å¼€å‘äººå‘˜çš„å·¥ä½œæ•ˆç‡ï¼Œå¹¶å¾—åˆ°ä¸šå†…çš„å¹¿æ³›ä½¿ç”¨ã€‚ä½†ä¸æ­¤åŒæ—¶ï¼Œå®¹å™¨å®‰å…¨äº‹æ•…é¢‘å‘ï¼ŒåŒ…æ‹¬ä¸å®‰å…¨çš„é•œåƒæºã€å®¹å™¨å…¥ä¾µäº‹ä»¶ã€è¿è¡Œç¯å¢ƒçš„å®‰å…¨é—®é¢˜ç­‰ç­‰ã€‚\n1. ä¸å®‰å…¨çš„é•œåƒæºâ€‹    å¼€å‘è€…é€šå¸¸ä¼šåœ¨ Docker å®˜æ–¹çš„ Docker Hub ä»“åº“ä¸‹è½½é•œåƒï¼Œè¿™äº›é•œåƒä¸€éƒ¨åˆ†æ¥æºäºå¼€å‘é•œåƒå†…ç›¸åº”è½¯ä»¶çš„å®˜æ–¹ç»„ç»‡ï¼Œè¿˜æœ‰å¤§é‡é•œåƒæ¥è‡ªç¬¬ä¸‰æ–¹ç»„ç»‡ç”šè‡³ä¸ªäººã€‚ä»è¿™äº›é•œåƒä»“åº“ä¸­è·å–é•œåƒçš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚ä¾‹å¦‚ï¼Œä¸‹è½½é•œåƒå†…è½¯ä»¶æœ¬èº«æ˜¯å¦å°±åŒ…å«æ¼æ´ï¼Œä¸‹è½½çš„é•œåƒæ˜¯å¦è¢«æ¶æ„æ¤å…¥åé—¨ï¼Œé•œåƒåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ç¯¡æ”¹ã€‚å…¶æ¬¡å°±æ˜¯å®¹å™¨çš„æ„å»ºå…¨è¿‡ç¨‹æ˜¯å¯¹äºå¼€å‘è€…æ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼\n2. å®¹å™¨å…¥ä¾µäº‹ä»¶â€‹    ç”± docker æœ¬èº«çš„æ¶æ„ä¸æœºåˆ¶å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼Œè¿™ä¸€æ”»å‡»åœºæ™¯ä¸»è¦äº§ç”Ÿåœ¨é»‘å®¢å·²ç»æ§åˆ¶äº†å®¿ä¸»æœºä¸Šçš„ä¸€äº›å®¹å™¨ï¼ˆæˆ–è€…é€šè¿‡åœ¨å…¬æœ‰äº‘ä¸Šå»ºç«‹å®¹å™¨çš„æ–¹å¼è·å¾—è¿™ä¸ªæ¡ä»¶ï¼‰ï¼Œç„¶åå¯¹å®¿ä¸»æœºæˆ–å…¶ä»–å®¹å™¨å‘èµ·æ”»å‡»æ¥äº§ç”Ÿå½±å“ï¼Œè¿™ä¸ªä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¤–ç½‘æœåŠ¡ä¸å…è®¸ä½¿ç”¨å®¹å™¨ï¼\n3. è¿è¡Œç¯å¢ƒçš„å®‰å…¨â€‹    é™¤ docker æœ¬èº«å­˜åœ¨çš„é—®é¢˜å¤–ï¼Œdocker è¿è¡Œç¯å¢ƒå­˜åœ¨çš„é—®é¢˜åŒæ ·ç»™ docker çš„ä½¿ç”¨å¸¦æ¥é£é™©ã€‚\nâ€‹    ç”±äºå®¹å™¨æ˜¯ä»‹äºåŸºç¡€è®¾æ–½å’Œå¹³å°ä¹‹é—´çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå› æ­¤é¢å‘åŸºç¡€è®¾æ–½è™šæ‹ŸåŒ–çš„ä¼ ç»Ÿäº‘å®‰å…¨è§£å†³æ–¹æ¡ˆæ— æ³•å®Œå…¨è§£å†³å‰è¿°å®‰å…¨é—®é¢˜ã€‚å¦‚ä»¥å®¹å™¨ä¸ºæ”¯æ’‘æŠ€æœ¯æ„å»º DevOps ç¯å¢ƒï¼Œå°±éœ€è¦è®¾è®¡æ¶µç›–ä»å®¹å™¨é•œåƒçš„åˆ›å»ºåˆ°æŠ•äº§ä¸Šçº¿çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å®¹å™¨å®‰å…¨æ–¹æ¡ˆã€‚\n4ã€æ€§èƒ½â€‹    ç°åœ¨å®¹å™¨çš„å®¿ä¸»æœºå¾€å¾€éƒ½æ˜¯ 128G+64C çš„ç»„åˆè¿˜æœ‰æ›´é«˜çš„ï¼Œä½†æ˜¯å•æœºçš„ç“¶é¢ˆè¿˜æ˜¯æœ‰çš„ï¼Œæ¯”å¦‚å¦‚ä½•è§£å†³ç½‘ç»œ/ç£ç›˜IOçš„æ€§èƒ½é—®é¢˜ï¼Œåˆç†çš„ç½‘ç»œæŠ€æœ¯å®ç°è·¨å®¿ä¸»æœºè®¿é—®ï¼Œå®ç°å¯é çš„cicdå¹³å°ï¼\n6ã€æ€»ç»“â€‹    æœ€åè®°ä½ï¼Œè¿™äº›æ‰€æœ‰çš„ä¸€åˆ‡ï¼Œåªæ˜¯ä¸ºäº†æé«˜ç ”å‘æ•ˆç‡ï¼Œä¿è¯äº§ç ”è´¨é‡ï¼\nå¯ä»¥çœ‹çœ‹è¿™ä¸ªPPTï¼šhttps://docs.qq.com/pdf/DU290V1dSU2NMTHlw\nå‚è€ƒäº‘è®¡ç®—å›¾å¿—\n40 å¹´å›é¡¾ï¼Œä¸€æ–‡è¯»æ‡‚å®¹å™¨å‘å±•å²\nä¸ºä»€ä¹ˆè¯´ 2019ï¼Œæ˜¯å±äºå®¹å™¨æŠ€æœ¯çš„æ—¶ä»£ï¼Ÿ\nCNCF chinal\nå‘½ä»¤å¼å’Œå£°æ˜å¼åŒºåˆ«\n","categories":["äº‘åŸç”Ÿ"],"tags":["Docker","å®¹å™¨åŒ–"]},{"title":"èŠä¸€èŠHTTPåè®®","url":"/2022/05/19/14ae618744ce995daa153156bee2d2e6/","content":"â€‹     å¦‚ä»Šäº’è”ç½‘å·²ç»ä¸æˆ‘ä»¬å¯†ä¸å¯åˆ†äº†ï¼Œè´­ç‰©ã€é‡‘èã€ç¤¾äº¤ã€å¨±ä¹ç­‰éƒ½ä¾èµ–äºäº’è”ç½‘ï¼Œå…¶ä¸­ä¸»è¦ä¾èµ–çš„å‡ é¡¹æŠ€æœ¯å°±åŒ…å«HTTPï¼ˆHyperText Transfer Protocolï¼Œ è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ã€‚æœ¬æ–‡æ ¸å¿ƒå°±æ˜¯ä»‹ç»HTTPå‘å±•å†å²ä»¥åŠHTTP/2åè®®ï¼\n\n\nHTTPå‘å±•å†å²\nHTTP/0.9HTTPåè®®çš„ç¬¬ä¸€ä¸ªè§„èŒƒæ˜¯1991å¹´å‘å¸ƒçš„0.9ç‰ˆæœ¬ï¼Œæ­¤è§„èŒƒæ–‡æ¡£ä¸è¶³700ä¸ªå•è¯ï¼Œå…¶ä¸­è§„èŒƒä¸­æŒ‡å‡ºäº†é€šè¿‡TCP/IP ï¼ˆæˆ–ç±»ä¼¼çš„é¢å‘è¿æ¥çš„æœåŠ¡ï¼‰ä¸æœåŠ¡å™¨å’Œç«¯å£å»ºç«‹è¿æ¥ï¼è§„èŒƒç”³æ˜é”™è¯¯ç±»å‹ä»¥å¯è¯»æ–‡æœ¬æ˜¾ç¤ºHTMLè¯­æ³•ï¼Œä»¥åŠè¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼\n\nç›®å‰å·²ç»æ²¡æœ‰ç½‘ç«™å’Œæµè§ˆå™¨æ”¯æŒ http/0.9 åè®®äº†ï¼\n\nè¯·æ±‚æ ¼å¼ï¼šåªæœ‰GETæ–¹æ³•ï¼ŒæŠ¥æ–‡å¦‚ä¸‹ï¼š\nGET /doc/index.heml\n\nå“åº”å†…å®¹ï¼šåªæœ‰HTMLæ–‡æœ¬ï¼Œæ‰€ä»¥æ— æ³•ä¼ è¾“å…¶ä»–ç±»å‹æ–‡ä»¶ï¼\n&lt;HTML&gt;è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„HTMLé¡µé¢&lt;/HTML&gt;\n\nHTTP/1.0åœ¨1991-1995å¹´ï¼Œäººä»¬ç”±äºä¸æ»¡è¶³HTTP/0.9ï¼Œäºæ˜¯æäº†ä¸€äº›æ–°æ‰©å±•ï¼Œä½†æ˜¯è¿™äº›æ–°æ‹“å±•å¹¶æ²¡æœ‰è¢«å¼•å…¥åˆ°æ ‡å‡†ä¸­ã€‚ç›´åˆ°1996å¹´11æœˆï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œä¸€ä»½æ–°æ–‡æ¡£ï¼ˆRFC 1945ï¼‰è¢«å‘è¡¨å‡ºæ¥ï¼Œç”¨ä»¥æè¿°å¦‚ä½•æ“ä½œå®è·µè¿™äº›æ–°æ‰©å±•åŠŸèƒ½ã€‚\nä¸»è¦æ–°å¢å†…å®¹å¦‚ä¸‹ï¼š\n\nå¼•å…¥äº† POSTã€HEADæ–¹æ³•\nè¯·æ±‚ä¸å“åº”éƒ½å¼•å…¥äº† HTTP å¤´/é¦–éƒ¨ï¼ˆHeaderï¼‰ï¼Œä¸ºæ­¤ä¹Ÿæ”¯æŒäº†å…¶ä»–ä¼ è¾“ç±»å‹ï¼ˆå›¾ç‰‡ç­‰ï¼‰\nå¼•å…¥å“åº”çŠ¶æ€ç \n\nâœ  ~ curl --http1.0 www.baidu.com -v*   Trying 220.181.38.149:80...* Connected to www.baidu.com (220.181.38.149) port 80 (#0)&gt; GET / HTTP/1.0&gt; Host: www.baidu.com&gt; User-Agent: curl/7.77.0&gt; Accept: */*&gt;* Mark bundle as not supporting multiuse* HTTP 1.0, assume close after body&lt; HTTP/1.0 200 OK&lt; Accept-Ranges: bytes&lt; Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform&lt; Content-Length: 2381&lt; Content-Type: text/html# .... çœç•¥\n\nHTTP/1.1HTTP/1.0 å¤šç§ä¸åŒçš„å®ç°æ–¹å¼åœ¨å®é™…è¿ç”¨ä¸­æ˜¾å¾—æœ‰äº›æ··ä¹±ï¼Œè‡ª1995å¹´å¼€å§‹ï¼Œå³HTTP/1.0æ–‡æ¡£å‘å¸ƒçš„ä¸‹ä¸€å¹´ï¼Œå°±å¼€å§‹ä¿®è®¢HTTPçš„ç¬¬ä¸€ä¸ªæ ‡å‡†åŒ–ç‰ˆæœ¬ã€‚äºæ˜¯åœ¨1997å¹´åˆï¼ŒHTTP1.1 æ ‡å‡†å‘å¸ƒã€‚\nä¸»è¦æ–°å¢å†…å®¹å¦‚ä¸‹ï¼šï¼ˆä¸‹åˆ—å†…å®¹éƒ¨åˆ†ä¹Ÿåœ¨HTTP/1.0ä¸­æœ‰æ”¯æŒï¼Œæ‰€ä»¥å’ŒHTTP/1.1ç»Ÿç§°ä¸ºHTTP/1.Xï¼‰\n\nè¿æ¥å¤ç”¨ (å¼•å…¥ Keep-Alive Header)\nå¢åŠ ç®¡çº¿åŒ–ï¼ˆç®¡é“åŒ–ï¼‰æŠ€æœ¯ï¼Œå…è®¸åœ¨ç¬¬ä¸€ä¸ªåº”ç­”è¢«å®Œå…¨å‘é€ä¹‹å‰å°±å‘é€ç¬¬äºŒä¸ªè¯·æ±‚ï¼Œä»¥é™ä½é€šä¿¡å»¶è¿Ÿã€‚\næ”¯æŒå“åº”åˆ†å—(chunkedç¼–ç )\nå¼•å…¥é¢å¤–çš„ç¼“å­˜æ§åˆ¶æœºåˆ¶\nå¼•å…¥å†…å®¹åå•†æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯­è¨€ï¼Œç¼–ç ï¼Œç±»å‹ç­‰ï¼Œå¹¶å…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çº¦å®šä»¥æœ€åˆé€‚çš„å†…å®¹è¿›è¡Œäº¤æ¢\nå‡­å€ŸHostå¤´ï¼Œèƒ½å¤Ÿä½¿ä¸åŒåŸŸåé…ç½®åœ¨åŒä¸€ä¸ªIPåœ°å€çš„æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å¼ºåˆ¶è¦æ±‚å®¢æˆ·ç«¯è¯·æ±‚å¿…é¡»æºå¸¦Hostã€‚ä¾‹å¦‚Nginxè¿™ç§åå‘ä»£ç†å·¥å…·ï¼Œå¯èƒ½æ ¹æ®Hostè¿›è¡Œåå‘ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ä¸€å°æœåŠ¡å™¨æ‰¿è½½å¤šä¸ªåŸŸåï¼\næ”¯æŒåŒ…å«GETã€POSTã€PUTã€PATCHã€DELETEã€HEADã€CONNECTã€OPTIONSã€TRACE è¯·æ±‚æ–¹æ³•\n\nâœ  ~ curl --http1.1 www.baidu.com -v*   Trying 220.181.38.149:80...* Connected to www.baidu.com (220.181.38.149) port 80 (#0)&gt; GET / HTTP/1.1&gt; Host: www.baidu.com&gt; User-Agent: curl/7.77.0&gt; Accept: */*&gt;* Mark bundle as not supporting multiuse&lt; HTTP/1.1 200 OK&lt; Accept-Ranges: bytes&lt; Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform&lt; Connection: keep-alive&lt; Content-Length: 2381&lt; Content-Type: text/html&lt; Date: Mon, 23 May 2022 09:57:28 GMT&lt; Etag: &quot;588604c8-94d&quot;&lt; Last-Modified: Mon, 23 Jan 2017 13:27:36 GMT&lt; Pragma: no-cache&lt; Server: bfe/1.0.8.18&lt; Set-Cookie: BDORZ=27315; max-age=86400; domain=.baidu.com; path=/\n\nç”±äºHTTPåè®®çš„å¯æ‰©å±•æ€§ â€“ åˆ›å»ºæ–°çš„å¤´éƒ¨å’Œæ–¹æ³•æ˜¯å¾ˆå®¹æ˜“çš„ â€“ å³ä½¿ HTTP/1.1 åè®®è¿›è¡Œè¿‡ä¸¤æ¬¡ä¿®è®¢ï¼ŒRFC 2616 å‘å¸ƒäº 1999 å¹´ 6 æœˆï¼Œè€Œå¦å¤–ä¸¤ä¸ªæ–‡æ¡£ RFC 7230-RFC 7235 å‘å¸ƒäº 2014 å¹´ 6 æœˆï¼ˆåœ¨ HTTP/2 å‘å¸ƒä¹‹å‰ï¼‰ã€‚HTTP/1.1 åè®®å·²ç»ç¨³å®šä½¿ç”¨è¶…è¿‡ 15 å¹´äº†ã€‚\n1. HTTP/1.1 ä¿®è®¢è®°å½•HTTP/1.1 åè®®å‘å¸ƒäº1997å¹´çš„1æœˆä»½ï¼Œåé¢ç»è¿‡ä¸‰æ¬¡ä¿®è®¢ï¼æœ€åä¸€æ¬¡ä¿®è®¢æ—¶é—´æ˜¯2014å¹´6æœˆä»½ï¼å…·ä½“ä¿®è®¢å†…å®¹å¯ä»¥ç‚¹å‡»ä¸‹é¢é“¾æ¥è¿›è¡ŒæŸ¥çœ‹ï¼HTTP1.1çš„å²æ•°å’Œæˆ‘å·®ä¸å¤šï¼\n\né¦–å‘ 1997å¹´ rfc2068\nç¬¬ä¸€æ¬¡ä¿®è®¢ 1999å¹´ rfc2616\nç¬¬äºŒæ¬¡ä¿®è®¢ 2014å¹´ rfc7230 (æƒ³è¦è¯¦ç»†äº†è§£HTTPåè®®ç¼–ç å¯ä»¥çœ‹è¿™ä¸ª)\nç¬¬ä¸‰æ¬¡ä¿®è®¢ 2014å¹´ rfc7235\n\n2. æœåŠ¡ç«¯ä¼˜åŒ–æ‰‹æ®µ1. keep-aliveå¼•å…¥keep-alive å¯ä»¥æœ‰æ•ˆçš„é™ä½äº†TCPå»ºç«‹è¿æ¥çš„å¼€é”€ï¼ˆåŒ…å«TCPæ¡æ‰‹å’ŒTCPæ…¢å¯åŠ¨ï¼Œå…¶å®TCPä¸€å¼€å§‹çª—å£æŒºå¤§çš„ï¼Œé»˜è®¤14KBï¼‰ï¼Œå…¶æ¬¡å°±æ˜¯æœ‰æ•ˆçš„é™ä½äº†ç³»ç»Ÿå¼€é”€ï¼Œå¦‚TCPè¿æ¥æ•°ç­‰ï¼\nåœ¨HTTP/1.0ä¸­é»˜è®¤æ˜¯å…³é—­å¼€å¯ keep-alive çš„ï¼Œå¿…é¡»åœ¨è¯·æ±‚å¤´éƒ¨æ·»åŠ Connection: keep-aliveæ‰å¯ä»¥ï¼›ä½†æ˜¯åœ¨HTTP/1.1ä¸­é»˜è®¤æ˜¯å¼€å¯keep-aliveï¼Œéœ€è¦åœ¨å“åº”å¤´åŠ å…¥Connection: closeæ‰å¯ä»¥å…³é—­ï¼ä¸‹å›¾æ˜¯ä¸¤è€…çš„å·®å¼‚ï¼š\n\nä½†æ˜¯ä¹Ÿä¼šå­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼ŒåŸæ¥æ˜¯è¯·æ±‚-&gt;å“åº”ç›´æ¥å…³é—­è¿æ¥å¾ˆå®¹æ˜“æ‹†åŒ…ï¼Œä½†æ˜¯å‡ºç°äº†è¿æ¥å¤ç”¨ï¼Œé‚£ä¹ˆå¦‚ä½•æ‹†åŒ…å‘¢ï¼ŸHTTP/1.xä¸­å¦‚æœæˆ‘ä»¬å¼€å¯äº†keep-aliveå¿…é¡»åœ¨è¯·æ±‚å¤´å’Œå“åº”å¤´ä¸­åŠ å…¥content-lengthæ¥æ ‡è¯†è¯·æ±‚ä½“/å“åº”ä½“çš„å¤§å°ï¼ï¼ˆchunkedä¼ è¾“ç¼–ç é™¤å¤–ï¼‰\n\n æµ‹è¯•\n\n# HTTP/1.1ï¼Œä¸‹å›¾ä¸ºHTTP/1.1çš„æŠ“åŒ…å›¾curl  --url http://localhost:8888/api/test/req1     --url http://localhost:8888/api/test/req2   --data-raw &#x27;hello world&#x27; -v# HTTP/1.0curl  --url http://localhost:8888/api/test/req1     --url http://localhost:8888/api/test/req2   --data-raw &#x27;hello world&#x27;  -H &#x27;Connection: keep-alive&#x27; --http1.0 -v\n\n\n\nå…³äºå¦‚ä½•å®ç°HTTPçš„ keep-aliveï¼Œä¸€èˆ¬serverç«¯è®¾ç½®è¯»è¶…æ—¶å³å¯ï¼Œclientç«¯ç»´æŠ¤å°±æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥é˜…è¯»ä¸€äº›æºç çœ‹ä¸€ä¸‹å³å¯ï¼Œå…¶æ¬¡å°±æ˜¯ç”¨çš„è¿æ¥æ± ï¼\nç›®å‰å­—èŠ‚å†…éƒ¨çš„TLBåšä»£ç†çš„æ—¶å€™ç»´æŠ¤å•ä¸ªè¯·æ±‚è¿æ¥çš„æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´è¿æ¥ä¸ä¼šè¢«é”€æ¯ï¼Œä¹Ÿå°±æ˜¯ç»å¸¸ä¼šå‡ºç°åç«¯æœåŠ¡ï¼ˆup streamï¼‰å‡ºç°å¤§é‡çš„ TCP ESTABLISHED ï¼Œå…¶ä¸»è¦åŸå› ä¹Ÿæ˜¯å› ä¸ºclientä¾§ä¸æ–­å¼€è¿æ¥ï¼Œserverä¾§ä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥æ–­å¼€ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåé¢HTTP/2åšäº†è‡ªå·±çš„keep-aliveæœºåˆ¶äº†ï¼\nkeep-alive å¦å¤–è¿˜æ˜¯é¢å¤–çš„ä¸¤ä¸ªé…ç½®ï¼Œä¸€ä¸ªæ˜¯ timeout ä¸€ä¸ªæ˜¯maxï¼Œä¾‹å¦‚Keep-Alive: timeout=5, max=1000 ï¼Œ å…·ä½“å¯ä»¥çœ‹ï¼š https://tools.ietf.org/id/draft-thomson-hybi-http-timeout-01.html ï¼å¯ä»¥å‚è€ƒNginxçš„å®ç°!\nå¦‚æœå“åº”å¤´é‡Œç”³æ˜ Connection=close ï¼Œåˆ™ä¼šå…³é—­è¿æ¥ï¼\n\n2. è¯·æ±‚ä½“å‹ç¼©ä¸€èˆ¬å‹ç¼©æ˜¯æ ¹æ® Content-Encoding è¿›è¡ŒåŒºåˆ†Bodyä½“ä½¿ç”¨å“ªç§å‹ç¼©æ–¹å¼ï¼Œè¯·æ±‚çš„æ—¶å€™ä¼šæºå¸¦Accept-Encodingæ¥æ ‡è¯†æ”¯æŒçš„å‹ç¼©æ–¹å¼ï¼ å¸¸è§å°±æ˜¯ gzipã€trã€deflate å‹ç¼©ï¼Œå­—èŠ‚å†…éƒ¨ä¹Ÿæœ‰ä¸€äº›å‹ç¼©ç‡æ¯”è¾ƒé«˜çš„å‹ç¼©ç®—æ³•ï¼Œæ¯”å¦‚ ttzip åŸºäºzstdä¼˜åŒ–åçš„ï¼\nGET /api/test HTTP/1.1Host: localhost:8888Connection: keep-aliveAccept: */*Accept-Encoding: gzip, deflate, brHTTP/1.1 200 OKContent-Encoding: gzipDate: Wed, 11 May 2022 14:39:27 GMTContent-Length: 343...............!...Y..@.....[Z...........b......zP.1&#125;.JjFKw.......g....oO.Z......./.\tOXwJ..S..%.......7...F3.pF.|B.*....E.-o..ObpT2..6J..5.S....0.u.R.&#x27;Ce....,.......&gt;C..(|.8D=.:_...X..$.=....l..1..m.P..s.%.....s....)T.wiyN9_^p.|la@.D/.t.@.&gt;...._/$..=Sz&#125;k.O.......Al..m...j......M..,. ..:g...:.6Q.......T..c..z..jU...u...jWn.J..N.?............\n\n3. Chunked ç¼–ç ï¼ˆåˆ†å—ä¼ è¾“ï¼‰åˆ†å—ç¼–ç æ˜¯HTTP/1.1æ–°å¢çš„ä¼ è¾“æŠ¥æ–‡æ ¼å¼ï¼Œå“åº”ä¼šæºå¸¦Transfer-Encoding: chunkedï¼Œå…¶æ¬¡å“åº”ä½“æ˜¯ä¸ä¼šæœ‰content-lengthçš„ï¼Œå› ä¸ºchunkedç¼–ç é•¿åº¦éƒ¨åˆ†è®°å½•åœ¨ä¸€ä¸ª 16è¿›åˆ¶ç¼–ç å•ç‹¬çš„æ–‡æœ¬è¡Œä¸Šï¼Œç„¶åå†å†™å“åº”å†…å®¹ï¼Œå¦‚æœä»ç„¶æœ‰å†…å®¹ç»§ç»­é‡å¤æ“ä½œå³å¯ï¼ç»ˆæ­¢ç¬¦æ˜¯ 0\\r\\n\\r\\nï¼ä¸‹å›¾æ˜¯chunkedç¼–ç çš„æŠ“åŒ…å›¾ï¼Œå…¶ä¸­12å…¶å®è¡¨ç¤º0x12ä¹Ÿå°±æ˜¯ä¸ºåè¿›åˆ¶çš„18!\n\nä½¿ç”¨åœºæ™¯:  å…¶ä¸­åˆ†å—ç¼–ç å¯ä»¥èŠ‚çº¦ç”¨æˆ·é¦–å±åŠ è½½æ—¶é—´ï¼Œå…ˆåŠ è½½ä¸€éƒ¨åˆ†æ¸²æŸ“ï¼å®é™…ä¸šåŠ¡ä¸­å¯ä»¥åšä¸€äº› å®æ—¶è¿›åº¦æ¡å±•ç¤ºã€æ—¥å¿—å±•ç¤ºã€æµå¼æ‹‰å–ã€å¤§æ–‡ä»¶ä¼ è¾“ç­‰ï¼æ¯”å¦‚æŠ–éŸ³çš„é¦–å±é¢„æµ‹æ–¹æ¡ˆå°±æ˜¯åŸºäºchunkedç¼–ç å®ç°çš„ï¼Œå…·ä½“å¯ä»¥çœ‹æ–‡ç« å°¾éƒ¨çš„å‚è€ƒæ–‡ç« ï¼\næ³¨æ„1:  å‡å¦‚ä½ ä½¿ç”¨Goè¯­è¨€é»˜è®¤HTTP Serverï¼Œå½“å“åº”ä½“å¤§äº2KBçš„æ—¶å€™å°±ä¼šé»˜è®¤å‡çº§ä¸º chunked ç¼–ç ï¼ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ å“åº”header Transfer-Encoding: chunked!\næ³¨æ„2ï¼šå¯¹äºL7 Proxyæ¥è¯´ï¼Œchunkedç¼–ç å¤„ç†ä¸å¾—å½“å¾ˆå¯èƒ½é€ æˆä¸šåŠ¡çš„OOMï¼Œæ‰€ä»¥å¯ä»¥å‚è€ƒä¸€äº›chunkedåŒ…è½¬å‘å’ŒæŠ“å–çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå°½å¯èƒ½çš„é™ä½å†…å­˜æ‹·è´æ¬¡æ•°å’Œç»´æŠ¤çš„bufferå¤§å°ï¼\nä¸Šé¢ç¬¬äºŒã€ç¬¬ä¸‰èŠ‚è®²å®Œäº†ï¼Œå¯ä»¥å‘ç°ä¼šå­˜åœ¨ä¸¤ä¸ªHeaderï¼Œ Content-Encoding å’Œ Transfer-Encodingï¼Œ è¿™é‡Œå¯ä»¥æ ¹æ®å¥é¢æ„æ€ï¼Œå¯ä»¥çŸ¥é“ Content-Encoding æ˜¯è¡¨ç¤ºå†…å®¹ç¼–ç æ ¼å¼ï¼ŒTransfer-Encoding è¡¨ç¤ºä¼ è¾“æ ¼å¼ï¼ ä¸¤è€…æ˜¯å¯ä»¥åŒæ—¶ä½¿ç”¨çš„ï¼\n3. å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¼˜åŒ–æ‰‹æ®µ1. åˆå¹¶èµ„æºåˆå¹¶èµ„æºè¿™ä¸ªæˆ‘ç†è§£å¤§éƒ¨åˆ†éƒ½æˆ–å¤šå¤šå°‘çš„äº†è§£è¿‡ï¼Œå› ä¸ºè¯·æ±‚3ä¸ªèµ„æºçš„è€—æ—¶ä¸€èˆ¬éƒ½ä¼šå¤§äºåˆå¹¶æˆä¸€ä¸ªèµ„æºçš„è¯·æ±‚è€—æ—¶ï¼ä¾‹å¦‚å‰ç«¯ä¹Ÿæœ‰å¾ˆå¤šé™æ€èµ„æºï¼ˆjs/cssï¼‰çš„æ‰“åŒ…å·¥å…·ï¼Œæ¯”å¦‚webpackã€gulp ç­‰èµ„æºåˆå¹¶å·¥å…·ï¼å…¶æ¬¡ä¸€äº›å°çš„Imageå¯ä»¥ä½¿ç”¨ç²¾çµå›¾ï¼\nè¿™ä¸ªä¸œè¥¿æœ‰åˆ©ä¹Ÿæœ‰å¼Šç«¯ï¼Œæ¯”å¦‚æˆ‘åŸæ¥20ä¸ªæ–‡ä»¶ï¼Œåˆå¹¶æˆäº†ä¸€ä¸ªï¼Œæˆ‘æ”¹åŠ¨ä¸€ä¸ªï¼Œé‚£ä¹ˆå…¨éƒ¨èµ„æºéƒ½æ˜¯éœ€è¦é‡æ–°reloadï¼Œæµè§ˆå™¨ç¼“å­˜çš„æ•ˆæœå°±ä¸¢å¤±äº†ï¼Œä¸è¿‡è¿™ä¸ªç›®å‰ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆï¼\n\n2. åŸŸååˆ†ç‰‡æµè§ˆå™¨å…¶å®æœ‰åŒåŸŸåè¯·æ±‚çš„æœ€å¤§å¹¶å‘æ•°é™åˆ¶ï¼Œä¾‹å¦‚ä¸»æµçš„æµè§ˆå™¨Chrome å…¶å®ä¼šå¯¹äºåŒåŸŸåä¸‹æœ€å¤§å¹¶å‘æ•°é™åˆ¶åœ¨6ä¸ªï¼\n\nåŸŸååˆ†ç‰‡å°±æ˜¯è®²ä¸€ä¸ªåŸŸååˆ’åˆ†ä¸ºå¤šä¸ªï¼Œæ¯”å¦‚ www.google.com,  www.gstatic.com, è¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„è§£å†³æµè§ˆå™¨çš„é™åˆ¶ï¼\n3. ç®¡é“åŒ–ä¸‹å›¾æ˜¯ä½¿ç”¨ç®¡é“åŒ–å’Œæœªä½¿ç”¨çš„å·®åˆ«ï¼Œå¯ä»¥å‘ç°ä»–å¯ä»¥è§£å†³http/1.x è¯·æ±‚é˜»å¡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½è§£å†³å“åº”é˜»å¡çš„é—®é¢˜ï¼è¿™ä¸ªä¸»è¦è¿˜æ˜¯ç”±äºæœåŠ¡ç«¯HTTPè¯·æ±‚å¤„ç†æ˜¯ä¸²è¡Œçš„ï¼æ³¨æ„åªæœ‰æ”¯æŒå¹‚ç­‰çš„è¯·æ±‚ä¸”å¼€å¯keep-aliveæ‰ä¼šæ”¯æŒç®¡é“åŒ–ï¼å…¶æ¬¡è¿™ä¸ªæŠ€æœ¯ä¸»è¦åœ¨æµè§ˆå™¨ä¾§å®ç°ï¼ä½†æ˜¯ç”±äºkeep-aliveæŒä¹…è¿æ¥å®ç°ä¸Šå¹¶ä¸å¯é ï¼Œæ‰€ä»¥ç®¡é“åŒ–ä¹Ÿéœ€è¦æ”¯æŒé‡è¯•ç­‰ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåªå…è®¸å¹‚ç­‰è¯·æ±‚äº†ï¼\n\n4. é•¿è¿æ¥â€‹        è¿™ä¸ªæ”¾åœ¨è¿™é‡Œï¼Œæ„Ÿè§‰ä¹Ÿä¸åˆç†ï¼Œä¸»è¦æ˜¯ç›®å‰ä¹Ÿå­˜åœ¨è¿™ç§åœºæ™¯ï¼Œæ¯”å¦‚åœ¨çº¿ç¼–è¾‘ã€åœ¨çº¿èŠå¤©ç­‰ä¸€äº›åœ¨çº¿è½¯ä»¶å¯¹äºå®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œè½®è®­çš„è¯ä¹Ÿä¸å¤ªå¥½ï¼Œå› ä¸ºHTTPå»ºè¿å¼€é”€æ¯”è¾ƒå¤§ï¼Œå…¶æ¬¡å¯¹äºæœåŠ¡å™¨å‹åŠ›ä¹Ÿæ¯”è¾ƒå¤§ï¼ˆæ¯”å¦‚æ— æ•ˆçš„è¯·æ±‚ï¼Œç±»ä¼¼äºç©ºè½¬ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿™æ¡è·¯ä¸Šè¯ç”Ÿäº†å¾ˆå¤šçš„æŠ€æœ¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸‹WebSocketï¼\nâ€‹        WebSocketæ˜¯HTML5å¼€å§‹æä¾›çš„ä¸€ç§åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ï¼Œä½äºOSIæ¨¡å‹çš„åº”ç”¨å±‚ã€‚WebSocketåè®®åœ¨2008å¹´è¯ç”Ÿï¼Œäº2011å¹´ç”±IETFæ ‡å‡†åŒ–ä¸º RFC 6455 ï¼Œåç”± RFC 7936 è¡¥å……è§„èŒƒã€‚\næ³¨æ„ï¼šWebSocket å’Œ HTTPåŒä¸ºåº”ç”¨å±‚åè®®ï¼WebSocketæ˜¯åˆ©ç”¨HTTPåè®®è¿›æ¡æ‰‹çš„ï¼\n\n4. æ³¨æ„ç‚¹1. ç½‘å…³æ–¹å‘ä¸Šè¯‰æˆ‘ä»¬è®²çš„å¯èƒ½æ˜¯åå‘äºä¸šåŠ¡æ–¹é¢ä¸€äº›æŠ€å·§ï¼Œå¯¹äºç½‘å…³/LBæ¥è¯´ï¼Œå¾€å¾€åœ¨HTTPé“¾è·¯ä¸­æ‹…ä»»ç€ä¸€ä¸ªä»£ç†è§’è‰²ï¼Œé‚£ä¹ˆä»£ç†å°±ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘è¦ä»£ç†å“ªäº›ä¸œè¥¿ï¼Œå“ªäº›ä¸œè¥¿ä¸å¯ä»£ç†ï¼\n\nHop-by-hop headers (ç‚¹åˆ°ç‚¹)\n\nå…·ä½“å¯ä»¥è§ https://www.rfc-editor.org/rfc/rfc7230.txtï¼Œ å¤§æ¦‚æè¿°äº†é€çº§è·³çš„æ—¶å€™ä¸€ä¸ª header æ˜¯ä¸èƒ½ä¼ é€’çš„ï¼\nConnectionProxy-ConnectionKeep-AliveProxy-AuthenticateProxy-AuthorizationTeTrailerTransfer-EncodingUpgrade\n\nä¸Šè¯‰è¿™äº›header ä¸»è¦æ˜¯å’Œåè®®æœ‰å…³ï¼Œå…¶ä¸­ä¸å°‘ç½‘å…³ç›´æ¥ä¸æ”¯æŒä¸Šè¯‰åŠŸèƒ½ä»£ç†ï¼Œ\n\næ¯”å¦‚ Transfer-Encoding=chunkedï¼Œå¾ˆå¤šä¸šåŠ¡ä½¿ç”¨chunkedç¼–ç è¿›è¡Œåˆ†æ®µä¼ è¾“ï¼Œæ¥å®ç°å•å‘é•¿é“¾æ¥ï¼Œä½†æ˜¯å¯èƒ½ç»è¿‡ç½‘å…³åä¼šremoveæ‰è¿™ä¸ªä¼ è¾“åè®®ï¼Œå› æ­¤ä½¿ç”¨ chunkedå¾ˆå¯èƒ½åœ¨ç½‘ç»œä¼ è¾“æŸä¸ªèŠ‚ç‚¹ä¸¢å¤±äº†frc-4.1.1 . æ‰€ä»¥å¾ˆå¤šä¸šåŠ¡ä¼šè‡ªå®šä¹‰ chunkedç¼–ç ï¼Œå‘å­—èŠ‚å†…éƒ¨å°±å¼€å‘äº†ä¸€ä¸ªNext-Chunkedç¼–ç è§£å†³ä¼ è¾“è¿‡ç¨‹ä¸­ chunked åˆ†æ®µç¼–ç ä¸¢å¤±é—®é¢˜.ï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯åœ¨payloadä¸­è¿›è¡Œåˆ†æ®µï¼‰\nConnectionã€Keep-Alive ç­‰éƒ½æ˜¯ä¸€äº›è¿æ¥å¤ç”¨ä¼˜åŒ–ç­–ç•¥ï¼Œæœ¬è´¨ä¸Šä¸Šä¸‹æ¸¸å¹¶ä¸å¯ä¿¡ï¼Œå¯¹äºè¿æ¥. \nå…¶æ¬¡è¿˜æœ‰ä¸€äº›Headerï¼Œæ¯”å¦‚Upgradeç”¨ä½œåè®®åˆ‡æ¢ï¼Œä¹Ÿæ˜¯ä¸å¯ä»¥è¿›è¡Œé€ä¼ çš„ã€‚\n\n\nEnd-to-End ï¼ˆç«¯åˆ°ç«¯ï¼‰\n\nå°±æ˜¯å¾ˆå¸¸è§çš„ä¸šåŠ¡header\n\næ­£å‘ä»£ç†\n\nä¸»è¦æ˜¯ä»£ç†å®¢æˆ·ç«¯ï¼ˆClientï¼‰è¯·æ±‚ï¼Œä¾‹å¦‚VPNã€æŠ“åŒ…å·¥å…·ã€åŒ¿åè®¿é—®ã€æé«˜è®¿é—®é€Ÿåº¦ ç­‰\n\næ˜¯â€ä»£ç†æœåŠ¡å™¨â€ä»£ç†äº†â€å®¢æˆ·ç«¯â€ï¼Œå»å’Œâ€ç›®æ ‡æœåŠ¡å™¨â€è¿›è¡Œäº¤äº’ï¼Œç›®æ ‡æœåŠ¡å™¨æ˜¯ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯æ˜¯è°çš„\n\n\nåå‘ä»£ç†\n\nä¸»è¦æ˜¯ä»£ç†æœåŠ¡ç«¯ï¼ˆServerï¼‰ç«¯è¯·æ±‚ï¼Œä¾‹å¦‚LB\n\næ˜¯â€ä»£ç†æœåŠ¡å™¨â€ä»£ç†äº†â€ç›®æ ‡æœåŠ¡å™¨â€ï¼Œå»å’Œâ€å®¢æˆ·ç«¯â€è¿›è¡Œäº¤äº’ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“çœŸæ­£çš„ç›®æ ‡æœåŠ¡å™¨æ˜¯è°çš„\n\nå‚è€ƒ: https://oxylabs.cn/blog/reverse-proxy-vs-forward-proxy \n2. form-data ç¼–ç  (bodyç¯¡æ”¹)è¿™é‡Œæˆ‘ç”³æ˜ä¸€ä¸ªåè¯(é€æ˜ä»£ç†)ï¼Œåœ¨å®é™…ä¸šåŠ¡ä¸­å¾€å¾€ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å®¢æˆ·ç«¯+æœåŠ¡ç«¯ä¼ è¾“çš„æ—¶å€™ä¼šè¿›è¡Œä¸€ä¸ª body/headeråŠ å¯†+checksumæ¥é˜²æ­¢è¢«ç¯¡æ”¹(checksumå¾€å¾€ä¼šä½¿ç”¨åŠ å¯†é˜²æ­¢ä¸­é€”è¢«ç¯¡æ”¹)ï¼Œè¿™ç§caseéå¸¸åœºæ™¯.\né‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œform-data åœ¨å¾ˆå¤šåº”ç”¨ä¸­ä¼šå¾ˆå®¹æ˜“å‡ºç°ä¸¢å¤±headerä¿¡æ¯å’Œä¹±åº.å…·ä½“å…³äº form-dataç¼–ç å¯ä»¥çœ‹  rfc2056\næ‰€ä»¥é€æ˜ä»£ç†å¾€å¾€æ˜¯ä¸ä¼šä¿®æ”¹æ•´ä½“çš„httpè¯·æ±‚æŠ¥æ–‡ï¼Œä¾‹å¦‚æ­£å‘ä»£ç†ä¸­çš„æŠ“åŒ…ï¼Œå°±å……å½“äº†ä¸€ä¸ªé€æ˜ä»£ç†ï¼Œå®ƒå¹¶ä¸ä¼šä¿®æ”¹ä½ çš„æµé‡ï¼Œå…¶å®å°±æ˜¯ä¸ä¼šä¿®æ”¹åº”ç”¨å±‚æµé‡ï¼ˆè¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯ä»£ç†æŠ“åŒ…ï¼Œä»…ä½œä¸º4å±‚ä»£ç†ï¼Œå…¶å®ä¹Ÿä¸æ˜¯ç—…ä¸èƒ½ç§°ä¸º4å±‚ï¼‰\nPOST /api/v1/test/codec?ce=gzip&amp;te=chunked HTTP/1.1Host: xxx-xx.xxx.netUser-Agent: curl/7.77.0Accept: */*Content-Length: 413Content-Type: multipart/form-data; boundary=------------------------8ca4ceae80dc1105--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test2.log&quot;Content-Type: application/octet-streamhello world1hello world2--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;k1&quot;v1--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;k2&quot;v2--------------------------8ca4ceae80dc1105--\n\nä¹±åºå å¯èƒ½ä¼šå‡ºç°: \nPOST /api/v1/test/codec?ce=gzip&amp;te=chunked HTTP/1.1User-Agent: curl/7.77.0Host: xxx-xx.xxx.netContent-Type: multipart/form-data; boundary=------------------------8ca4ceae80dc1105Content-Length: 413Accept: */*--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;k1&quot;v1--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;k2&quot;v2--------------------------8ca4ceae80dc1105Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test2.log&quot;Content-Type: application/octet-streamhello world1hello world2--------------------------8ca4ceae80dc1105--\n\n3. æµå¼ä¼ è¾“\næœ‰äº›åº”ç”¨ä½¿ç”¨ é•¿è½®è®­ ï¼Œä»£ç†å±‚ä¼šè¯»è¶…æ—¶\næœ‰äº›åº”ç”¨ä½¿ç”¨ åˆ†æ®µä¼ è¾“ï¼Œä»£ç†å±‚ä¼šè¯»å–å…¨éƒ¨æ•°æ®åå†ä¼ è¾“ ï¼ˆä¸ºäº†å®‰å…¨é™åˆ¶è¯»å–çš„æœ€å¤§sizeï¼Œé™¤éæ”¯æŒè½¬å‘chunkedç¼–ç ï¼‰\n\n4. æ€»ç»“æ ¹æ®ä¸Šè¯‰æè¿°ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘ç°åšä¸€æ¬¾ä¼˜ç§€çš„HTTPä»£ç†å·¥å…·ï¼Œå¹¶ä¸æ˜¯ç®€ç®€å•å•çš„ä¸€ä»¶äº‹æƒ…ï¼Œéœ€è¦å¾ˆæ·±å…¥çš„äº†è§£HTTPåè®®çš„ç»†èŠ‚ï¼Œä»¥åŠå°½å¯èƒ½çš„æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œæ‰€ä»¥ä¼˜ç§€çš„HTTPä»£ç†å·¥å…·ï¼Œæ¯”å¦‚apacheï¼Œnginxç­‰éƒ½æ˜¯ä¸æ–­çš„è¿­ä»£å’Œæ»¡è¶³ä¸šåŠ¡ç°çŠ¶ï¼æ‰€ä»¥ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ é€šç”¨å‹ä»£ç†å·¥å…· + åå‘äºç‰¹å®šä¸šåŠ¡åœºæ™¯çš„ä»£ç†å·¥å…·ï¼\nHTTPSè¿™ä¸ªå¹¶ä¸æ˜¯HTTPåè®®ï¼Œåªæ˜¯åœ¨HTTPå‘å±•è·¯ä¸Šé‡åˆ°çš„é—®é¢˜ï¼Œéšç€äº’è”ç½‘å‘å±•ï¼Œè¶Šæ¥è¶Šå¤šçš„äººæ³¨æ„åˆ°æ•°æ®å®‰å…¨ï¼Œæ¯”å¦‚ç”¨æˆ·æ•æ„Ÿä¿¡æ¯éœ€è¦åŠ å¯†ï¼Œä¸€äº›æ¶æ„è½¯ä»¶çš„æ”»å‡»ï¼Œä»¥åŠæ¶æ„æ‹¦æˆªç­‰ï¼æ‰€ä»¥HTTPSå°±è¯ç”Ÿäº†ï¼è¿™é‡Œæˆ‘ä»¬åªæ˜¯å¼•å…¥è€Œå·²ï¼Œä¸ä¼šæ·±å…¥è®²è§£ï¼HTTPSï¼ˆHypertext Transfer Protocol Secureï¼‰ æ˜¯ HTTP  åè®®å¤–é¢åŒ…è£¹äº†ä¸€å±‚ TLS/SSLï¼\nSSLï¼ˆSecure Sockets Layerï¼Œå®‰å…¨å¥—æ¥å­—å±‚ï¼‰ï¼Œå®ƒæ˜¯ç”±ç½‘æ™¯å…¬å¸(Netscape)è®¾è®¡çš„ä¸»è¦ç”¨äºWebçš„å®‰å…¨ä¼ è¾“åè®®ï¼Œç›®çš„æ˜¯ä¸ºç½‘ç»œé€šä¿¡æä¾›æœºå¯†æ€§ã€è®¤è¯æ€§åŠæ•°æ®å®Œæ•´æ€§ä¿éšœã€‚å¦‚ä»Šï¼ŒSSLå·²ç»æˆä¸ºäº’è”ç½‘ä¿å¯†é€šä¿¡çš„å·¥ä¸šæ ‡å‡†ã€‚SSLæœ€åˆçš„å‡ ä¸ªç‰ˆæœ¬(SSL 1.0ã€SSL2.0ã€SSL 3.0)ç”±ç½‘æ™¯å…¬å¸è®¾è®¡å’Œç»´æŠ¤ï¼Œä»3.1ç‰ˆæœ¬å¼€å§‹ï¼ŒSSLåè®®ç”±å› ç‰¹ç½‘å·¥ç¨‹ä»»åŠ¡å°ç»„(IETF)æ­£å¼æ¥ç®¡ï¼Œå¹¶æ›´åä¸ºTLS(Transport Layer Security)ï¼Œå‘å±•è‡³ä»Šå·²æœ‰TLS 1.0ã€TLS1.1ã€TLS1.2ã€TLS1.3 è¿™å‡ ä¸ªç‰ˆæœ¬ã€‚\nå¦‚TLSåå­—æ‰€è¯´ï¼ŒSSL/TLSåè®®ä»…ä¿éšœä¼ è¾“å±‚å®‰å…¨ã€‚åŒæ—¶ï¼Œç”±äºåè®®è‡ªèº«ç‰¹æ€§(æ•°å­—è¯ä¹¦æœºåˆ¶)ï¼ŒSSL/TLSä¸èƒ½è¢«ç”¨äºä¿æŠ¤å¤šè·³(multi-hop)ç«¯åˆ°ç«¯é€šä¿¡ï¼Œè€Œåªèƒ½ä¿æŠ¤ç‚¹åˆ°ç‚¹é€šä¿¡ã€‚\nSSL/TLSå‘å±•å†ç¨‹å¦‚ä¸‹å›¾ï¼š\n\n\n\n\nåè®®\nä½¿ç”¨æƒ…å†µ\n\n\n\nSSLv3.0ä»¥ä¸‹\næœ‰å®‰å…¨é—®é¢˜ï¼Œä¸”å·²è¢«åºŸå¼ƒï¼Œä¸å»ºè®®ä½¿ç”¨\n\n\nTLSv1.0/v1.1\nè¿‡æ¸¡ç‰ˆæœ¬ï¼Œä¸å»ºè®®ä½¿ç”¨\n\n\nTLSv1.2\nç›®å‰ç»å¤§å¤šæ•°éƒ½åœ¨ä½¿ç”¨\n\n\nTLSv1.3\næœ€æ–°çš„æ›´å¿«æ›´å®‰å…¨çš„åè®®ï¼ˆå˜æ›´æœ€å¤§çš„ä¸€æ¬¡åè®®ï¼Œå¯ä»¥å®ç°1RTTï¼‰\n\n\nå…¶æ¬¡TLSåŠ è§£å¯†ä¼šéå¸¸çš„æ¶ˆè€—CPUï¼Œå…¶æ¬¡åŠ å¯†ä¹Ÿä¼šé¢å¤–æ¶ˆè€—å¸¦å®½ï¼Œä¸è¿‡ä¸»è¦å¼€é”€éƒ½åœ¨TLSæ¡æ‰‹è¿™å—ï¼Œå› ä¸ºç°åœ¨ä¸»æµCPUéƒ½ä¼šå¯¹å¸¸è§åŠ å¯†ç®—æ³•åšç¡¬ä»¶åŠ é€Ÿï¼Œæ‰€ä»¥ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®åŒ…è¿™å—å¼€é”€ä¸å¤§ï¼ç›®å‰ä¸€èˆ¬å†…ç½‘éƒ½ä¼šå¸è½½æ‰TLSï¼å…¶æ¬¡TLSæ¡æ‰‹è¿‡ç¨‹ä¹Ÿä¼šå¾ˆé•¿ï¼Œä¸»è¦åŒ…å«è¯ä¹¦è®¤è¯å’Œç¡®è®¤åŠ å¯†ç®—æ³•ï¼å…¶ä¸­TLSå‘å±•è¿‡ç¨‹ä¸­ä¹Ÿç»å†äº†ä¸æ–­çš„è¿­ä»£ï¼Œå‘å±•æ–¹å‘ä¸»è¦æ˜¯ä¸ºäº†æ›´åŠ å®‰å…¨ã€æ•ˆç‡æ›´é«˜ï¼ä¸‹å›¾æ˜¯ç°åœ¨ä¸»æµTLSv1.2çš„æ¡æ‰‹æµç¨‹ï¼Œç›¸æ¯”äºè£¸TCPï¼Œä¼šå¤šä¸¤å€çš„æ—¶é—´å¼€é”€ï¼\n\næ³¨: TLSæ¡æ‰‹ä¸­å¾ˆå¤šæµç¨‹æ˜¯å¯é€‰çš„ï¼Œä¸Šå›¾å¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå…¶æ¬¡å°±æ˜¯è¿˜ä¼šåˆ†ä¸ºå…¨å®Œæ¡æ‰‹å’Œç®€åŒ–æ¡æ‰‹ï¼\nå¯¹äºTLSæ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªåè®®è§„èŒƒï¼Œå…·ä½“æˆ‘ä»¬åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½®æˆ–è€…éœ€è¦ç¨‹åºæ¥æ”¯æŒï¼å¸¸è§å¼€æºå®ç°ä¸»è¦æœ‰  OpenSSLï¼ˆä¸»æµï¼‰ã€JSSEï¼ˆJavaç‰ˆå®ç°ï¼‰ã€NSSï¼ˆæµè§ˆå™¨ä¸­å¹¿æ³›ä½¿ç”¨ï¼‰ï¼Œä¸‹å›¾æ˜¯äº›å¸¸è§è½¯ä»¶ä»¥åŠå®ƒä»¬æ‰€ä½¿ç”¨çš„SSL/TLSå¼€æºå®ç°çš„æƒ…å†µï¼å¯¹äºå®‰å…¨ï¼ˆTLS/SSLï¼‰æ¥è¯´ä¹Ÿæ˜¯ä¸æ–­åœ¨è¿›æ­¥ä¸­ï¼ŒåŒæ—¶ä¹Ÿæœ‰æ¼æ´ä¸æ–­æŒ–å‡ºï¼\n\nHTTP/2  &amp; HTTP/3éšç€è¿‘20å¹´æ¥äº’è”ç½‘çš„é«˜é€Ÿå‘å±•ï¼Œé¡µé¢æ„ˆåŠ å¤æ‚ï¼Œæœ‰äº›ç”šè‡³æ¼”å˜æˆäº†ç‹¬ç«‹çš„åº”ç”¨ï¼Œä¸€ä¸ªé¡µé¢ä¼šåŠ è½½å¤§é‡çš„èµ„æºï¼Œå¢è¿›äº¤äº’çš„è„šæœ¬å¤§å°ä¹Ÿå¢åŠ äº†è®¸å¤šï¼Œæ›´å¤šçš„æ•°æ®é€šè¿‡HTTPè¯·æ±‚è¢«ä¼ è¾“ã€‚HTTP/1.1é“¾æ¥éœ€è¦è¯·æ±‚ä»¥æ­£ç¡®çš„é¡ºåºå‘é€ï¼Œç†è®ºä¸Šå¯ä»¥ç”¨ä¸€äº›å¹¶è¡Œçš„é“¾æ¥ï¼Œå¸¦æ¥çš„æˆæœ¬å’Œå¤æ‚æ€§å ªå¿§ã€‚æ¯”å¦‚ï¼ŒHTTPç®¡çº¿åŒ–ï¼ˆpipeliningï¼‰å°±æˆä¸ºäº†Webå¼€å‘çš„è´Ÿæ‹…ã€‚\nåœ¨2009å¹´åˆ°2015å¹´ï¼Œè°·æ­Œé€šè¿‡å®è·µäº†ä¸€ä¸ªå®éªŒæ€§çš„SPDYåè®®ï¼ˆ2011å¹´Googleçš„å…¨éƒ¨æœåŠ¡å°±æ·»åŠ äº†SPDYï¼‰ï¼Œè¯æ˜äº†ä¸€ä¸ªåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯äº¤æ¢æ•°æ®çš„å¦ç±»æ–¹å¼ã€‚å…¶æ”¶é›†äº†æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯çš„å¼€å‘è€…çš„ç„¦ç‚¹é—®é¢˜ã€‚æ˜ç¡®äº†å“åº”æ•°é‡çš„å¢åŠ å’Œè§£å†³å¤æ‚çš„æ•°æ®ä¼ è¾“ï¼ŒSPDYæˆä¸ºäº†HTTP/2åè®®çš„åŸºç¡€ã€‚åœ¨2015å¹´5æœˆHTTP/2æ­£å¼æ ‡å‡†åŒ–åï¼Œå–å¾—äº†æå¤§çš„æˆåŠŸï¼ç›®å‰æ¥çœ‹SPDYå·²ç»å®Œå…¨è¢«HTTP/2æ‰€å–ä»£ï¼ç„¶åGoogleå…¶å®æ—©èµ·å·²ç»å¯¹äºTCPåšäº†ä¼˜åŒ–ï¼Œå«åšQUICï¼Œæ‰€ä»¥å°±è€ƒè™‘æŠŠHTTPè¿è¡Œåœ¨QUICä¸Šï¼Œäºæ˜¯è¯ç”Ÿäº†åé¢çš„HTTP/3ï¼\nHTTP/2 ç›¸æ¯”HTTP/1.1 æ¯”è¾ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¤šè·¯å¤ç”¨ï¼Œæœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬web serverç”±HTTPæœåŠ¡å‡çº§ä¸ºRPCæœåŠ¡ï¼Œå¸¦æ¥çš„æå‡ï¼ä»æµè§ˆå™¨è§†è§’çœ‹çš„è¯ï¼Œä¸‹å›¾æ˜¯169å¼ å›¾æ¸²æŸ“ä¸€å¼ å›¾æµè§ˆå™¨åŠ è½½çš„è€—æ—¶ï¼Œç»“æœæ˜¯HTTP/2 ä¸º1.53sï¼Œ HTTP1.1ä¸º 2.47sï¼\n\nHTTP/2 ä»‹ç»ä¸»è¦ç‰¹æ€§\n\näºŒè¿›åˆ¶åè®® (frameå¸§)\nå¤šè·¯å¤ç”¨ (stream æµ)\næµé‡æ§åˆ¶\næ•°æ®æµä¼˜å…ˆçº§\né¦–éƒ¨å‹ç¼©ï¼ˆHPACKï¼‰\næœåŠ¡ç«¯æ¨é€ ï¼ˆPushï¼‰\n\nè™½ç„¶æœ‰è¿™ä¹ˆå¤šç‰¹æ€§ï¼Œå¯¹äºHTTPçš„è¯­ä¹‰æ¥è¯´ï¼Œå…¶å®å¹¶æ²¡æœ‰å¤ªå¤§çš„å˜æ›´ï¼\nç†è§£æµå¯¹äºHTTP/1.xåè®®æ¥è¯´ä¸€ä¸ªè¿æ¥ä¸Šçš„è¯·æ±‚ã€å“åº”æ˜¯ä¸²è¡Œçš„å¤„ç†ï¼Œä½†æ˜¯HTTP/2å¼•å…¥æµçš„æ¦‚å¿µï¼ŒæŠŠè¯·æ±‚ã€å“åº”çš„è¿‡ç¨‹æŠ½è±¡æˆæµï¼Œä¸€ä¸ªè¿æ¥ä¸Šå¯ä»¥æœ‰å¤šä¸ªæµï¼ŒæŠŠæ•°æ®åŒ…æŠ½è±¡æˆå¸§ï¼Œå¸§åœ¨å»ºç«‹çš„è¿æ¥ä¸Šä¼ è¾“ï¼\nä¸€ä¸ªæµçš„ç”Ÿå‘½å‘¨æœŸåªæ˜¯ä¸€æ¬¡è¯·æ±‚ã€å“åº”ï¼Œä¸å­˜åœ¨å¤ç”¨ï¼ˆå³å¦å¤–ä¸€ä¸ªè¯·æ±‚ä¸èƒ½å¤ç”¨ä¹‹å‰çš„æµï¼Œå…³é—­å³é”€æ¯ï¼‰ï¼Œå…·ä½“å¯ä»¥çœ‹æµçš„ç”Ÿæˆå‘¨æœŸï¼\n\næµçš„ç”Ÿå‘½å‘¨æœŸ\nä¸‹å›¾æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå¯¹äºä¸€ä¸ªæ™®é€šçš„è¯·æ±‚ã€å“åº”æ¥è¯´ï¼Œä¸€èˆ¬ç»å†æœ‰å››ä¸ªé˜¶æ®µ\n\n\nç©ºé—²(idle): è¿™é‡Œå¯ä»¥ç†è§£ä¸ºåˆå§‹åŒ–ä¸€ä¸ªstreamåçš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å¯ä»¥ç†è§£ä¸ºå¾ˆçŸ­ï¼\nå¼€å¯(open) : å½“å®¢æˆ·ç«¯å¼€å§‹å†™headerçš„æ—¶å€™ï¼ˆåŒ…å«æœåŠ¡ç«¯è¯»headerï¼‰ï¼Œä¼šæµè½¬åˆ°è¿™ä¸ªçŠ¶æ€ï¼ è¿™é‡Œä¹Ÿå°±æ˜¯\nåŠå…³é—­çŠ¶æ€(half closed): å®¢æˆ·ç«¯å†™å®Œæ•°æ®ï¼Œå‘é€END_STREAM   flagsæ—¶ï¼ˆå†™å®Œè¯·æ±‚æ—¶ï¼‰å°±ä¼šå˜æˆè¿™ä¸ªçŠ¶æ€ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯çš„æµä¸èƒ½å†å†™æ•°æ®ï¼å¯¹äºæœåŠ¡ç«¯è€Œè¨€å°±æ˜¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„END_STREAM flagsï¼Œå°±å¤„äºæ­¤çŠ¶æ€ï¼\nå…³é—­(closed): å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œæ”¶åˆ°æœåŠ¡ç«¯å“åº”å‘æ¥çš„END_STREAM ä¼šå˜ä¸ºæ­¤çŠ¶æ€ï¼›å¯¹äºæœåŠ¡å™¨è€Œè¨€å‘é€END_STREAM ä¹Ÿä¼šå˜ä¸ºæ­¤çŠ¶æ€ï¼\n\n\nåªè¦å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯å‘é€æˆ–è€…æ¥æ”¶åˆ° RST_STREAM å¸§æ—¶å°±ä¼šç›´æ¥å˜ä¸º closed çŠ¶æ€ï¼\nå¯¹äºæœåŠ¡ç«¯æ¨é€æ¥è¯´æˆ‘ä»¬åæ–‡ä¼šè®²åˆ°ï¼\nGRPCåŒå‘æµï¼ˆstream msgï¼‰å®ç°åŸç†å…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¯·æ±‚ã€å“åº”æ¨¡å‹ï¼Œæ ¹æ®ä¸Šé¢å››ä¸ªé˜¶æ®µä¹Ÿèƒ½å¤§æ¦‚äº†è§£å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼å³å®¢æˆ·ç«¯å‘å®Œè¯·æ±‚å¹¶æ²¡æœ‰ç›´æ¥å‘é€ END_STREAMï¼Œè€Œæ˜¯ä¸€ç›´å¤„äºopençŠ¶æ€ï¼Œä¸”æœåŠ¡ç«¯ä¹Ÿæ˜¯ï¼åªæœ‰å®¢æˆ·ç«¯/æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­æ‰å¯ä»¥å…³é—­streamï¼Œæˆ–è€…åŒæ–¹é€šè¿‡è‡ªå®šä¹‰åè®®çº¦å®šæ‰å¯ä»¥ï¼\n\n                         +--------+                 send PP |        | recv PP                ,--------|  idle  |--------.               /         |        |         \\              v          +--------+          v       +----------+          |           +----------+       |          |          | send H /  |          |,------| reserved |          | recv H    | reserved |------.|      | (local)  |          |           | (remote) |      ||      +----------+          v           +----------+      ||          |             +--------+             |          ||          |     recv ES |        | send ES     |          ||   send H |     ,-------|  open  |-------.     | recv H   ||          |    /        |        |        \\    |          ||          v   v         +--------+         v   v          ||      +----------+          |           +----------+      ||      |   half   |          |           |   half   |      ||      |  closed  |          | send R /  |  closed  |      ||      | (remote) |          | recv R    | (local)  |      ||      +----------+          |           +----------+      ||           |                |                 |           ||           | send ES /      |       recv ES / |           ||           | send R /       v        send R / |           ||           | recv R     +--------+   recv R   |           || send R /  `-----------&gt;|        |&lt;-----------&#x27;  send R / || recv R                 | closed |               recv R   |`-----------------------&gt;|        |&lt;----------------------&#x27;                         +--------+   send:   endpoint sends this frame   recv:   endpoint receives this frame   H:  HEADERS frame (with implied CONTINUATIONs)   PP: PUSH_PROMISE frame (with implied CONTINUATIONs)   ES: END_STREAM flag   R:  RST_STREAM frame\n\nå¦‚ä½•å»ºç«‹HTTP/2è¿æ¥é¦–å…ˆå»ºç«‹è¿æ¥éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ”¯æŒHTTP/2åè®®ï¼Œæ‰å¯ä»¥ä½¿ç”¨HTTP/2ï¼\nä½¿ç”¨HTTPSåå•† (h2)ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªcurl è¯·æ±‚å…¶å®æ˜¯æ¨¡æ‹Ÿäº†ä¸€ä¸ªä½¿ç”¨HTTPSå‘é€HTTP/2 åè®®çš„è¯·æ±‚\nâœ  ~ curl --http2 https://www.toutiao.com/ -v -o s/dev/null*   Trying 240e:b1:9801:407:3::3f6:443...* Connected to www.toutiao.com (240e:b1:9801:407:3::3f6) port 443 (#0)* ALPN, offering h2* ALPN, offering http/1.1* successfully set certificate verify locations:*  CAfile: /etc/ssl/cert.pem*  CApath: none* TLSv1.2 (OUT), TLS handshake, Client hello (1):* TLSv1.2 (IN), TLS handshake, Server hello (2):* TLSv1.2 (IN), TLS handshake, Certificate (11):* TLSv1.2 (IN), TLS handshake, Server key exchange (12):* TLSv1.2 (IN), TLS handshake, Server finished (14):* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):* TLSv1.2 (OUT), TLS handshake, Finished (20):* TLSv1.2 (IN), TLS change cipher, Change cipher spec (1):* TLSv1.2 (IN), TLS handshake, Finished (20):* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256* ALPN, server accepted to use h2* Server certificate:*  subject: CN=*.toutiao.com*  start date: Jul 23 00:00:00 2021 GMT*  expire date: Aug 23 23:59:59 2022 GMT*  subjectAltName: host &quot;www.toutiao.com&quot; matched cert&#x27;s &quot;*.toutiao.com&quot;*  issuer: C=US; O=DigiCert Inc; CN=RapidSSL TLS DV RSA Mixed SHA256 2020 CA-1*  SSL certificate verify ok.* Using HTTP2, server supports multi-use* Connection state changed (HTTP/2 confirmed)* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0* Using Stream ID: 1 (easy handle 0x7f7d21011e00)&gt; GET / HTTP/2&gt; Host: www.toutiao.com&gt; user-agent: curl/7.77.0&gt; accept: */*&gt;* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!&lt; HTTP/2 200&lt; server: Tengine&lt; content-type: text/html&lt; content-length: 72772&lt; date: Sun, 15 May 2022 10:30:06 GMT.... \n\nä¸Šé¢æˆ‘ä»¬åªéœ€è¦æ ¸å¿ƒå…³æ³¨\n## ALPNå®¢æˆ·ç«¯æ”¯æŒåˆ—è¡¨* ALPN, offering h2* ALPN, offering http/1.1## æœåŠ¡ç«¯é€‰æ‹©* ALPN, server accepted to use h2\n\n\n\nè¿™é‡Œå…¶å®åˆ©ç”¨äº†TLSçš„  ALPN (Application-Layer Protocol Negotiation åº”ç”¨å±‚åè®®åå•†) æ‰©å±•å­—æ®µä»¥åŠè¯†åˆ« HTTP/2 over TLS ï¼å…¶ä¸­HTTP/2 å°±æ˜¯ ALPN æœ€ä½³å®è·µï¼\nå…¶ä¸­åŸç†å°±æ˜¯ALNPç»™Client hello å’Œ Server hello æ¶ˆæ¯åŠ äº†ä¸ªæ‹“å±•åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ¥ç”³æ˜æˆ‘æ”¯æŒçš„åº”ç”¨å±‚åè®®ï¼ˆå—¨ï¼Œæˆ‘æ”¯æŒh2å’Œhttp/1ï¼Œä½ ç”¨å“ªä¸ªéƒ½è¡Œï¼‰ï¼ŒæœåŠ¡ç«¯å¯ä»¥ç”¨å®ƒæ¥ç¡®è®¤åœ¨HTTPSåå•†åçš„åº”ç”¨å±‚åè®®ï¼ˆå¥½å§ï¼Œæˆ‘ä»¬ç”¨h2å§ï¼‰ï¼\næ›´å¤šALPNå¯ä»¥å‚è€ƒæ–‡ç« : https://datatracker.ietf.org/doc/html/rfc7301#section-3 ï¼\nå¦å¤–å…¶å®åœ¨ ALPN åè®®ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªNPNï¼ˆNext Protocol Negotiation ä¸‹ä¸€ä»£åè®®åå•†ï¼‰å…¶å®ä½œç”¨å’ŒALPNä¸€æ ·ï¼Œä½†æ˜¯å‘¢è¿‡ç¨‹ä¸ä¸€æ ·ï¼Œå…¶ä¸­æˆ‘è¿™é‡Œç›´æ¥æ‹ç…§å§ï¼Œå°±æ˜¯å®ƒåˆ†ä¸ºä¸‰æ­¥ï¼Œé€‰æ‹©æƒåˆ©åœ¨å®¢æˆ·ç«¯ï¼Œå…¶ä¸­é€‰æ‹©çš„åè®®æ˜¯åŠ å¯†çš„ï¼æ‰€ä»¥è¿™ä¹ˆä¸€çœ‹å…¶å®NPNæ›´åŠ å®‰å…¨å¯é ï¼ä½†æ˜¯æƒ³ä¸€æƒ³å¢åŠ è¿™å‡ æ­¥æœ‰å¿…è¦å—ï¼Ÿå…¶å®æ²¡æœ‰å¿…è¦ï¼Œæ‰€ä»¥ALPNæˆä¸ºäº†è§„èŒƒï¼\n\næœ¬å›¾ç‰‡å¼•ç”¨è‡ª &lt;HTTP/2 in Action&gt;, æœ‰å…´è¶£å¯ä»¥çœ‹ä¸€ä¸‹ï¼\næ³¨æ„è¿™é‡Œæœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å‡å¦‚æœåŠ¡å™¨ä¸æ”¯æŒHTTP2ä½†æ˜¯å®¢æˆ·ç«¯æ”¯æŒï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢æµç¨‹é€‰æ‹©HTTP/1.1å°±å¯ä»¥äº†ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªå›¾ï¼Œæœ€åé€‰æ‹©çš„æ˜¯HTTP/1.1ã€‚ \n\nä½†æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å¦‚æœ server helloä¸­ä¸è¿”å›ALNPï¼Œæ¯”å¦‚ä¸¾ä¸ªä¾‹å­æœåŠ¡ç«¯TLSç‰ˆæœ¬è¿‡ä½ä¸æ”¯æŒANLPï¼Œæ‰€ä»¥æ­¤æ—¶ç›®å‰å¤§éƒ¨åˆ†æµè§ˆå™¨åšæ³•å°±æ˜¯é»˜è®¤é™çº§æˆHTTP/1.1ï¼å…·ä½“å¯ä»¥çœ‹ï¼šhttps://stackoverflow.com/questions/47758705/http-2-h2-with-no-alpn-support-in-serverï¼\næ³¨æ„: ä¸Šé¢è®²è¯‰çš„è¿‡ç¨‹æ˜¯åŸºäºTLS/1.2çš„ï¼Œå…¶ä¸­1.3ä¼šæœ‰éƒ¨åˆ†å·®å¼‚ï¼å…¶æ¬¡å°±æ˜¯h2å»ºç«‹è¦æ±‚æœ€ä½TLS/v1.2ç‰ˆæœ¬ï¼\nä½¿ç”¨ h2c åå•†æˆ‘ä»¬çŸ¥é“HTTPåè®®æ˜¯å¯ä»¥åšåè®®åå•†çš„ï¼Œé‚£ä¹ˆh2cçš„å»ºç«‹æµç¨‹å’Œè¿™ä¸ªå¤§åŒå°å¼‚ï¼ç›®å‰h2cçš„ä¸»è¦ä½¿ç”¨åœºæ™¯å°±æ˜¯åç«¯æœåŠ¡å¸Œæœ›HTTP/2æ¥å¸¦æ¥æ€§èƒ½æå‡ï¼Œè€Œä¸”å¤§éƒ¨åˆ†åœºæ™¯ä¹Ÿä¸éœ€è¦tlsåŠ å¯†ï¼Œæ‰€ä»¥h2cå°±è¯ç”Ÿäº†ï¼\næ³¨æ„h2c æœ‰ä¸¤ç§å®ç°ï¼Œä¸€ç§æ˜¯åŸºäºHTTP/1.1åè®®å‡çº§ï¼Œä¸€ç§å°±æ˜¯h2çš„æµç¨‹ä½†æ˜¯ç§»é™¤äº†tlsï¼\n1. æ–¹å¼ä¸€(HTTP/1.1å‡çº§)\n ç›®å‰ä¸»æµæµè§ˆå™¨éƒ½ä¸æ”¯æŒh2cï¼Œæ‰€ä»¥è¿™ä¸ªåŸºæœ¬ä¸Šæ²¡åŠæ³•æµ‹è¯•ï¼Œå¦‚æœæƒ³è¦æµ‹è¯•å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘å†™çš„æµ‹è¯•ç”¨ä¾‹: h2c_example\n\n\n\næµè§ˆå™¨å‘èµ·è¯·æ±‚\n\nGET / HTTP/1.1Host: server.example.comConnection: Upgrade, HTTP2-SettingsUpgrade: h2cHTTP2-Settings: &lt;base64url encoding of HTTP/2 SETTINGS payload&gt;\n\n\nå¦‚æœæœåŠ¡ç«¯æ”¯æŒåˆ™ä¼šå“åº”å¦‚ä¸‹æŠ¥æ–‡ï¼Œå¦‚æœä¸æ”¯æŒæ­£å¸¸è¿”å›å³å¯ï¼å…¶ä¸­ä¸‹é¢å¯ä»¥çœ‹åˆ°ä¼šæºå¸¦ HTTP/2é¦–å¸§ï¼è¿™é‡Œåé¢ä¼šè®²è§£ï¼\n\nHTTP/1.1 101 Switching ProtocolsConnection: UpgradeUpgrade: h2c[ HTTP/2 connection ...\n\n\nå…³äº HTTP2-Settings éœ€è¦äº†è§£HTTP/2æ¶‰åŠåˆ°çš„åŸºæœ¬æ¦‚å¿µï¼Œä¸€ä¸ªæ ¸å¿ƒçš„å°±æ˜¯ SETTTINGS å¸§, å¿…é¡»åœ¨å»ºè¿çš„æ—¶å€™å‘é€ï¼Œè¿™ä¸ªheaderä¹Ÿå°±æ˜¯ SETTTINGS å¸§ çš„å†…å®¹ï¼Œç†è§£è¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯æŠŠ SETTTINGS å¸§ base64ç¼–ç äº†ä¸€ä¸‹ï¼ç”¨äºå‘é€å®¢æˆ·ç«¯å»ºç«‹çš„åˆå§‹åŒ–è®¾ç½®ï¼\n[ HTTP/2 connection ... åç»­æµç¨‹æ˜¯å®¢æˆ·ç«¯ä¼šå…ˆå‘é€è¿æ¥å‰å¥ã€ä½†æ˜¯ä¸éœ€è¦å‘é€SETTINGSå¸§äº†ï¼Œå…¶ä»–å°±å’Œh2æµç¨‹å·®ä¸å¤šï¼\nè¿™é‡Œæˆ‘ä»¬ä¸èƒ½æŠ“åŒ…äº†ï¼Œæ‰€ä»¥ç›´æ¥çœ‹æˆ‘å†™çš„æµ‹è¯•ç”¨ä¾‹è¾“å‡ºå§\n\nâœ  h2c_client git:(master) âœ— go run main.goHTTP/1.1 101 Switching ProtocolsConnection: UpgradeUpgrade: h2c[FrameHeader SETTINGS len=24][FrameHeader WINDOW_UPDATE len=4][FrameHeader HEADERS flags=END_HEADERS stream=1 len=49][FrameHeader DATA flags=END_STREAM stream=1 len=12][FrameHeader RST_STREAM stream=1 len=4]\n\n2. æ–¹å¼äºŒ(h2c)è¿™ç§æ˜¯grpc(without tls)é‡‡ç”¨çš„æ–¹å¼ï¼Œå°±æ˜¯æˆ‘ä»¬å·²ç»çŸ¥é“å¯¹é¢æ˜¯HTTP/2æœåŠ¡å™¨äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨h2cé‚£ç§é€šè¿‡ http/1.1å‡çº§ä¸ºhttp/2è¿™ä¸ªæµç¨‹ï¼å®ƒçš„è¿‡ç¨‹å’Œh2çš„è¿‡ç¨‹ä¸€æ¨¡ä¸€æ ·ï¼ å…·ä½“å¯ä»¥è‡ªè¡ŒæŠ“åŒ…æŸ¥çœ‹ï¼\nå¸§ä»‹ç»ä¸‹å›¾æ˜¯ä¸€ä¸ªHTTP2 over httpsï¼ˆh2ï¼‰ çš„æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°HTTP2 ä¸»è¦åŒ…å«æœ‰å‡ ä¸ªç‰¹æ®Šæ ‡è¯†\n\nMagic\nSettings\nWindows_Update\nHeaders\nData\n\né‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢ä¼šä¾æ¬¡ä»‹ç»ï¼æˆ‘ä»¬æŠŠè¿™äº›éƒ½æˆä¸ºå¸§ï¼Œè¿™äº›å¸§éƒ½æœ‰ç€ä¸åŒçš„ä½œç”¨ï¼\n\nå¦‚æœä½ ç”¨ nghttp2, å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š nghttp -vo https://www.toutiao.com | more\nè¿æ¥å‰å¥æ ¹æ®ä¸Šå›¾å¯ä»¥çœ‹åˆ°åœ¨ h2 æˆ–è€… h2c å‡çº§å®Œæˆï¼Œä¸‹é¢ç´§æ¥ç€å°±è·Ÿç€ä¸€ä¸ª è¿æ¥å‰å¥ï¼ˆå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€çš„ï¼‰ï¼Œè¿™ä¸ªå†…å®¹æ˜¯å›ºå®šçš„ï¼Œä¸»è¦æ˜¯æœ‰24ä¸ªå­—èŠ‚ç»„æˆï¼Œ16è¿›åˆ¶æ ‡è¯†æ³•å¦‚ä¸‹ï¼Œå±•ç¤ºæˆå­—ç¬¦ä¸²å°±æ˜¯ PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n !  \n0000   50 52 49 20 2a 20 48 54 54 50 2f 32 2e 30 0d 0a   PRI * HTTP/2.0..0010   0d 0a 53 4d 0d 0a 0d 0a                           ..SM....\n\næ³¨æ„: å…·ä½“è¿™ä¹ˆè®¾è®¡çš„åŸå› ä¹Ÿæ˜¯æœ‰çš„ï¼Œæ¯”å¦‚å‘ä¸€ä¸ªä¸æ”¯æŒHTTP2çš„æœåŠ¡å™¨ï¼ˆHTTP/1.xï¼‰æ¥æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡ï¼Œæ˜¯å¯ä»¥æ­£å¸¸è§£æä¸ºHTTPè¯·æ±‚æŠ¥æ–‡çš„ï¼Œå¦‚æœä¸æ”¯æŒå°±ç›´æ¥è¿”å›å¼‚å¸¸ä¸æ”¯æŒäº†ï¼\nå¸§æ ¼å¼ä»‹ç»è¿æ¥å‰å¥ç´§è·Ÿç€å°±æ˜¯ SETTINGS å¸§äº†, ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªHTTP SETTINGS å¸§çš„æŠ¥æ–‡ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆè¡¥å……ä½“ä¸‹å¸§çš„æŠ¥æ–‡æ ¼å¼ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„ç†è§£ï¼è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆHTTP/2æ˜¯äºŒè¿›åˆ¶åè®®äº†ï¼ŒåŒæ—¶ä¹Ÿèƒ½é¿å…HTTP/1.xåè®®é€šè¿‡çº¯æ–‡æœ¬ç­‰è¿›è¡Œåè®®åˆ†å¸§çš„å°´å°¬äº†ï¼\n\nå¸§æŠ¥æ–‡å¦‚ä¸‹ï¼š\n# å¸§æ ¼å¼, å¤´éƒ¨å›ºå®š9å­—èŠ‚, æ‰€ä»¥ 9+ bytes:+-----------------------------------------------+|                 Length (24)                   |+---------------+---------------+---------------+|   Type (8)    |   Flags (8)   |+-+-------------+---------------+-------------------------------+|R|                 Stream Identifier (31)                      |+=+=============================================================+|                   Frame Payload (0...)                      ...+---------------------------------------------------------------+\n\n\nLength: å›ºå®šä¸º3å­—èŠ‚ï¼Œæ‰€ä»¥å¸§æœ€å¤§é•¿åº¦ä¸º 1 &lt;&lt; 24 -1 ï¼Œ æ³¨æ„è¿™ä¸ªé•¿åº¦=len(frame_content)\nType: å³å¸§çš„ç±»å‹ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼Œä¾‹å¦‚ SETTINGSå¸§å°±æ˜¯ 0x04ï¼Œå…¶ä¸­è¿™ä¸ªç±»å‹ç›®å‰ä»ç„¶åœ¨ä¸æ–­æ‹“å±•ä¸­ï¼å¸¸è§çš„å°±æ˜¯è¿™9ç§ï¼\n\n+---------------+------+--------------+| Frame Type    | Code | Section      |+---------------+------+--------------+| DATA          | 0x0  | Section 6.1  || HEADERS       | 0x1  | Section 6.2  || PRIORITY      | 0x2  | Section 6.3  || RST_STREAM    | 0x3  | Section 6.4  || SETTINGS      | 0x4  | Section 6.5  || PUSH_PROMISE  | 0x5  | Section 6.6  || PING          | 0x6  | Section 6.7  || GOAWAY        | 0x7  | Section 6.8  || WINDOW_UPDATE | 0x8  | Section 6.9  || CONTINUATION  | 0x9  | Section 6.10 |+---------------+------+--------------+\n\n\nFlags: å³æ ‡å¿—ä½ï¼Œè¿™ä¸ªä¸å¤ªæ–¹ä¾¿ç†è§£ï¼Œä½ å¯ä»¥ç†è§£ä¸º å¸§çš„ç‰¹æ®Šæ ‡è®°ï¼ä¾‹å¦‚ SETTINGSå¸§ ä¼šæœ‰ä¸€ä¸ª ACK Falgsï¼ å¤šä¸ªfalgsé€šè¿‡ bitmap è¿›è¡Œè®¾ç½®ï¼\n\nR: è¿™ä¸ªæ˜¯ä¿ç•™ä½ï¼ˆreserved bitï¼‰ï¼Œå ç”¨1bitï¼Œå¿…é¡»æ˜¯0\n\nStream Identifier:  å³æµIDï¼Œå ç”¨31bitï¼Œä¸ºæ— ç¬¦å·æ•´æ•°ï¼é¡¾åæ€ä¹‰å’ŒRPCçš„seq id å¾ˆåƒï¼è¿™é‡Œæ³¨æ„å®¢æˆ·ç«¯å‘èµ·çš„stream_idå¿…é¡»ä¸ºå¥‡æ•°ï¼ŒæœåŠ¡ç«¯å‘èµ·çš„ä¸ºå¶æ•°ï¼ä¾‹å¦‚ä¸Šé¢é‚£ä¸ªcaseï¼Œå®¢æˆ·ç«¯å‘èµ·çš„stream_id=13!  \n\nFrame Payload å³ payloadï¼Œå…è®¸ä¸ºç©ºï¼\n\n\nSETTINGS å¸§åœ¨å»ºç«‹è¯·æ±‚è¿‡ç¨‹ä¸­ï¼ŒMagicå¸§åé¢å°±ä¼šç«‹é©¬è·Ÿä¸€ä¸ªSETTINGS å¸§ï¼å¦‚ä¸‹å›¾ï¼Œè¿™ä¸ªå¸§ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†åˆå§‹åŒ–è¿æ¥çš„é…ç½®ä¿¡æ¯ï¼\n\nå…¶ä¸­SETTINGS å¸§å°±æ˜¯ä¸€å¯¹å¯¹KVç»„æˆï¼Œå¦‚ä¸‹å›¾ï¼Œå¤šä¸ªKVçš„è¯ï¼Œé¡ºåºå†™å³å¯ï¼\n+-------------------------------+|       Identifier (16)         |+-------------------------------+-------------------------------+|                        Value (32)                             |+---------------------------------------------------------------+\n\n\nIdentifierï¼šæ ‡è¯†ç¬¦ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼Œå¯ä»¥ç†è§£ä¸ºkey \n\nSETTINGS_HEADER_TABLE_SIZE (0x1): è®¾ç½®HPACKä¸­åŠ¨æ€è¡¨çš„å¤§å°ï¼Œé»˜è®¤æ˜¯4096ä¸ªå­—èŠ‚SETTINGS_ENABLE_PUSH (0x2): æ˜¯å¦å…è®¸æœåŠ¡ç«¯æ¨é€ï¼Œé»˜è®¤ä¸º0è¡¨ç¤ºå…³é—­ï¼Œ1è¡¨ç¤ºå¼€å¯SETTINGS_MAX_CONCURRENT_STREAMS (0x3): è¡¨ç¤ºä¸€ä¸ªè¿æ¥ä¸Šæœ€å¤§çš„å¹¶å‘æ•°é‡ï¼Œæ— é»˜è®¤å€¼ï¼Œä¾‹å¦‚å¤´æ¡ä¸»ç«™å°±æ˜¯è®¾ç½®çš„128SETTINGS_INITIAL_WINDOW_SIZE (0x4): åˆå§‹åŒ–çª—å£çš„å¤§å°ï¼Œç”¨äºæµé‡æ§åˆ¶ï¼Œé»˜è®¤å€¼æ˜¯65535, æœ€å¤§ä¸º 2&lt;&lt;31 - 1SETTINGS_MAX_FRAME_SIZE (0x5): æœ€å¤§çš„å¸§å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯ 16384ï¼Œæœ€å¤§ä¸º2&lt;&lt;24 - 1SETTINGS_MAX_HEADER_LIST_SIZE (0x6): è¿™é‡Œè¡¨ç¤ºè¯·æ±‚headerçš„æœ€å¤§é•¿åº¦\n\n\nValueï¼š å€¼ï¼Œå››ä¸ªå­—èŠ‚ï¼Œéƒ½æ˜¯intå€¼\n\næ³¨æ„ï¼š\n\nå¦‚æœä¸€ä¸ªç«¯éœ€è¦å‘èµ·è®¾ç½®ï¼Œé‚£ä¹ˆå®ƒéœ€è¦æ ‡è®° falgs Ack=0, ç„¶åæºå¸¦ä¸Šé…ç½®ï¼Œå¦å¤–ä¸€ç«¯æ¥æ”¶åä¼šå“åº”ä¸€ä¸ªfalgs Ack=1ï¼Œä¸” payload ä¸ºç©ºï¼ ä¾‹å¦‚ä¸‹é¢æµç¨‹ï¼š\n\n## æ”¶åˆ°settingså¸§[  0.083] recv SETTINGS frame &lt;length=18, flags=0x00, stream_id=0&gt;          (niv=3)          [SETTINGS_MAX_CONCURRENT_STREAMS(0x03):128]          [SETTINGS_INITIAL_WINDOW_SIZE(0x04):65536]          [SETTINGS_MAX_FRAME_SIZE(0x05):16777215]## å‘é€ackå¸§          [  0.083] send SETTINGS frame &lt;length=0, flags=0x01, stream_id=0&gt;          ; ACK          (niv=0)\n\n\nSETTINGS å¸§çš„ stream_id å›ºå®šä¸º0 ï¼\n\nWINDOW_UPDATE å¸§ ï¼ˆæµé‡æ§åˆ¶ï¼‰WINDOW_UPDATE å¸§ ä¸»è¦æ˜¯ç”¨äºæµé‡æ§åˆ¶ï¼ˆFlow Controlï¼‰ï¼Œè¿™ä¸ªåè¯åœ¨TCPä¹Ÿæœ‰ï¼ä¸è¿‡ HTTP/1.x å¹¶æœªåŒ…å«æµæ§æœºåˆ¶ï¼Œä¾é  TCP çš„æµæ§ä¹Ÿå·¥ä½œå¾—å¾ˆå¥½ï¼Œé‚£ä¸ºä»€ä¹ˆ HTTP/2 éœ€è¦æ·»åŠ å‘¢ï¼ŸåŸå› å¾ˆæ˜æ˜¾ï¼Œå› ä¸º HTTP/2 å¼•å…¥äº† streamï¼ˆæµï¼‰ å’Œ multiplexing(å¤šè·¯å¤ç”¨) ï¼Œæƒ³è®©ä¼—å¤š stream ååŒå·¥ä½œï¼Œå°±éœ€è¦ä¸€ç§æ§åˆ¶æœºåˆ¶ï¼Œé˜²æ­¢æŸä¸ªæµé˜»å¡å…¶ä»–æµï¼\nå…·ä½“åŸç†å¦‚ä¸‹ï¼šsenderå‘é€æ•°æ®ä¼šé™ä½çª—å£å¤§å°ï¼Œéœ€è¦receiveræ–¹é€šçŸ¥senderæ¥æ¢å¤çª—å£ï¼Œè¿™å°±éœ€è¦WINDOW_UPDATE å¸§ äº†!  å…¶ä¸­æµæ§ç®—æ³•å®˜æ–¹å¹¶æ²¡æœ‰æå‡ºå®ç°è§„èŒƒï¼æ³¨æ„ sender æŒ‡çš„æ•°æ®å‘é€æ–¹ï¼ˆå¯ä»¥æ˜¯serverã€ä¹Ÿå¯ä»¥æ˜¯clientï¼‰ã€‚ æ•´ä½“æ€»ç»“å°±æ˜¯ï¼šæ¥æ”¶è€…æ¥æä¾›æ§åˆ¶ï¼\n\nâ€‹    è¿™é‡Œç†è§£æ¯”è¾ƒæŠ½è±¡ï¼Œæ¯”å¦‚ç°åœ¨å‡å¦‚ä¸€ä¸ªè¿æ¥æœ‰å¤šä¸ªæµï¼ŒæµAå’ŒæµBâ€¦xxxï¼Œå‡å¦‚æ­¤æ—¶å®¢æˆ·ç«¯å‹åŠ›æ¯”è¾ƒå¤§ï¼ˆæ¯”å¦‚å¤„ç†ä¸è¿‡æ¥æ¶ˆæ¯æˆ–è€…æœºå™¨è´Ÿè½½è¿‡é«˜ï¼‰ï¼Œå®¢æˆ·ç«¯æ£€æµ‹åˆ°äº†ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æµé‡æ§åˆ¶å»å®ç°ï¼\n\n\nå…·ä½“HTTP/2å¦‚ä½•å®ç°æµæ§çš„ï¼Œä¸»è¦æ˜¯ç”±äºHTTP/2 çš„æµæ§åˆ†ä¸ºäº†ä¸¤ç±»ï¼Œstream flow-control window(sfw) å’Œ connection flow-control window (cfw)ï¼Œ å…¶ä¸­æ¯ä¸ªstreamä¼šç»´æŠ¤è‡ªå·±çš„sfwï¼Œæ‰€æœ‰çš„streamå…±ç”¨ä¸€ä¸ªcfw ï¼å‘é€å¤šå°‘åŒ…çª—å£å°±å‡å°‘å¤šå°‘ï¼Œcfwå’Œsfwéƒ½ä¼šå‡å°‘ï¼é‚£ä¹ˆå¢åŠ å‘¢æ˜¯å•ç‹¬å¢åŠ ï¼è¦ä¹ˆæ˜¯cfwã€è¦ä¹ˆæ˜¯sfwï¼å…¶æ¬¡cfwã€sfwåªé’ˆå¯¹äºDATAå¸§çš„å†…å®¹ï¼\nä¾‹å¦‚ï¼šGRPCä¸­åœ¨å½“æ¥æ”¶çš„åŒ…çš„æ€»å¤§å°(è‡ªå·±åšçš„receive flow-control)å¤§äºcfw/sfwå¤§å°çš„1/4çš„æ—¶å€™ï¼Œå°±ä¼šå‘é€window_updateå¸§ï¼Œç„¶åé‡ç½®receive sizeï¼Œæˆ–è€…å‘é€PINGåŒ…çš„æ—¶å€™ä¹Ÿä¼šæºå¸¦å‘é€window_update å¸§ï¼å…·ä½“é€»è¾‘å¯ä»¥çœ‹: senderé€»è¾‘ ã€  server ç«¯receiveré€»è¾‘ ã€ client receiveré€»è¾‘ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ï¼ç›®å‰HTTP/2åº”ç”¨æ¯”è¾ƒå¹¿æ³›çš„åº”è¯¥æ˜¯GRPCã€Nginx(L7)ã€æµè§ˆå™¨ï¼\nWINDOW_UPDATEå¸§ åè®®åŒ…æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¼ è¾“Window Size Incrementï¼Œè¿™ä¸ªå€¼æ˜¯å¢åŠ cfw  or sfwçš„å¤§å°ï¼ å¦‚æœè°ƒæ•´ sfwåˆ™éœ€è¦ä¼ é€’ stream_id ï¼\n+-+-------------------------------------------------------------+|R|              Window Size Increment (31)                     |+-+-------------------------------------------------------------+\n\nè¯´åˆ°è¿™é‡Œï¼Œå¯èƒ½è¿˜å¾—çŸ¥é“ï¼Œåˆå§‹åŒ–çª—å£ï¼š å½“ä¸€ä¸ªè¿æ¥åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsfwå’Œcfwéƒ½æ˜¯65535ï¼Œå¦‚æœéœ€è¦è°ƒæ•´sfw çš„åˆå§‹åŒ–çª—å£å¤§å°åˆ™éœ€è¦éœ€è¦å‘é€Settingå¸§ ï¼ˆè¿™ä¸ªæ˜¯é’ˆå¯¹æ‰€æœ‰streamï¼‰ï¼Œå¦‚æœéœ€è¦è°ƒæ•´cfwå¤§å°ï¼ˆæ‰€ä»¥åˆå§‹åŒ–æ—¶å€™cfwä¸€å®šæ˜¯65535ï¼‰éœ€è¦å‘é€window_updateå¸§!\nHEADERS å¸§ä¸€ä¸ªHTTP/2 è¯·æ±‚ä» HEADERS å¸§ å¼€å§‹å‘é€çš„ï¼ä¾‹å¦‚è¿™ä¸ªæ˜¯ä¸€ä¸ªHTTP/2 Headers å¸§çš„æŠ“åŒ…å›¾ï¼š\n\nå…¶ä¸­headerçš„ç¼–ç æ¯”è¾ƒå¤æ‚ï¼Œåç»­æˆ‘ä»¬ä¼šè®²è§£HPACKï¼Œæ‰€ä»¥è¿™é‡Œåªè¦çŸ¥é“æœ‰è¿™ä¸ªheaderå¸§ä¸»è¦åŒ…å«å“ªäº›å†…å®¹å³å¯ï¼\n+---------------+|Pad Length? (8)|+-+-------------+-----------------------------------------------+|E|                 Stream Dependency? (31)                     |+-+-------------+-----------------------------------------------+|  Weight? (8)  |+-+-------------+-----------------------------------------------+|                   Header Block Fragment (*)                 ...+---------------------------------------------------------------+|                           Padding (*)                       ...+---------------------------------------------------------------+\n\n\nPad Lengthï¼š è¡¨ç¤ºå°¾éƒ¨Paddingçš„é•¿åº¦ï¼Œä¸ºå¯é€‰å­—æ®µï¼ˆæ³¨æ„æ ‡è®°?çš„ä¸ºå¯é€‰å­—æ®µï¼‰\nEï¼š1bitï¼Œè¡¨ç¤ºå½“å‰æµæ˜¯å¦æ’ä»–çš„ (ä¸ PRIORITY å¸§æœ‰å…³)\nStream Dependencyï¼š è¡¨ç¤ºä¾èµ–äºå“ªä¸ªæµ  (ä¸ PRIORITY å¸§æœ‰å…³)\nWeightï¼šæµçš„æƒé‡  (ä¸ PRIORITY å¸§æœ‰å…³)\nHeader Block Fragmentï¼š è¯·æ±‚çš„é¦–éƒ¨ï¼Œä½¿ç”¨HPACKç¼–ç \nPaddingï¼šè¡¥é½å†…å®¹ï¼Œç”¨0å¡«å……\n\nä¾‹å¦‚æŠ¥æ–‡å¦‚ä¸‹ï¼š\n0000   00 00 1f 01 05 00 00 00 01 82 84 87 41 8b f1 e3   ............A...0010   c2 f3 1c f3 50 55 c8 7a 7f 7a 88 25 b6 50 c3 ab   ....PU.z.z.%.P..0020   ba ea e0 53 03 2a 2f 2a                           ...S.*/*\n\n\n00 00 1f 01 05 00 00 00 01:  å‰9ä¸ªå­—æ®µä¸ºFrameçš„å¤´éƒ¨ï¼Œpayloadé•¿åº¦ä¸º31ï¼Œä¸ºHeaderså¸§ï¼Œflagä¸º5ï¼Œstream_id=1\nå…¶ä¸­åé¢31ä¸ªå­—èŠ‚å°±æ˜¯å¤´éƒ¨çš„headerå†…å®¹äº†ï¼Œ è¿™é‡Œé‡‡ç”¨äº† HPACK ç¼–ç ï¼æ‰€ä»¥éœ€è¦äº†è§£ä¸‹HPACKç¼–ç ï¼Œè¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºæ¥ä¸‹æ–‡æ˜¯Headerçš„å†…å®¹ï¼Œä¸€å…±æ˜¯100ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ä½¿ç”¨HPACKç¼–ç ååªå ç”¨äº†31ä¸ªå­—èŠ‚ï¼ æ•´æ•´èŠ‚çº¦äº†70%çš„ç¼–ç ï¼\n\n:method: GET:path: /:scheme: https:authority: www.google.comuser-agent: curl/7.77.0accept: */*\n\nè¿™é‡Œæˆ‘ä»¬è¦è§£ç è€…31ä¸ªå­—èŠ‚éœ€è¦ç›´æ¥è·³è½¬åˆ° HPACKé‚£ä¸€èŠ‚å§ï¼\næ³¨æ„ï¼š\n\nHTTP/2 å’Œ HTTP/1.x åè®®æœ‰äº›headeræ˜¯ä¸å…¼å®¹çš„ï¼Œæ¯”å¦‚Keep-Alive å’Œ Connection ç­‰åœ¨HTTP/2ä¸­ç›´æ¥æ²¡æœ‰ï¼\nHTTPçš„headeræ˜¯æ”¯æŒ header: v1;v2è¡¨ç¤ºå¤šä¸ª ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ header: k1,header:k2 ï¼Œåœ¨HTTP/2ä¸­åœ¨ç¼–ç çš„æ—¶å€™ä¼šä½¿ç”¨åè€…ï¼åŒæ—¶header nameæ¨èå…¨éƒ¨å°å†™ï¼ˆçœ‹å®ŒHPACKå°±ä¼šç†è§£ï¼‰ï¼\n\nDATA å¸§dataå¸§å¯¹åº”ç€ HTTPçš„Bodyï¼Œå¦‚æœæ²¡æœ‰å“åº”ä½“çš„è¯æ˜¯ä¸éœ€è¦ä¼ è¾“çš„ï¼\n+---------------+|Pad Length? (8)|+---------------+-----------------------------------------------+|                            Data (*)                         ...+---------------------------------------------------------------+|                           Padding (*)                       ...+---------------------------------------------------------------+\n\n\nPad Lengthï¼š è¡¨ç¤ºpaddingé•¿åº¦ï¼Œ åªæœ‰å­˜åœ¨ PADDED flagsæ‰æœ‰è¿™ä¸ªå€¼ï¼\nDataï¼š çœŸæ­£çš„æ•°æ®\nPadding : è¡¨ç¤ºpaddingæ•°æ®ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶çš„paddingç®—æ³•ï¼Œä¹Ÿå°±æ˜¯ä½ å‘å‡ºçš„æ•°æ®å¯ä»¥ä¸paddingï¼\n\nè¿™é‡Œ DATA å¸§ä¼šæœ‰ä¸¤ä¸ªæ ‡è¯†ï¼Œä¸€ä¸ªæ˜¯ END_STREAM ã€ä¸€ä¸ªæ˜¯ PADDED\nPRIORITYå¸§ (è¯·æ±‚ä¼˜å…ˆçº§)è¿™ä¸ªå¸§å¯ä»¥å®šä¹‰è¯·æ±‚ï¼ˆstreamï¼‰çš„ä¼˜å…ˆçº§ï¼Œä½†æ˜¯è¿™ä¸ªä¼˜å…ˆçº§åªæ˜¯å®¢æˆ·ç«¯å‘æ¥çš„æè®®ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä¸å»æ”¯æŒï¼ä¸‹é¢å°±æ˜¯æŠ¥æ–‡æ ¼å¼ï¼š\n+-+-------------------------------------------------------------+|E|                  Stream Dependency (31)                     |+-+-------------+-----------------------------------------------+|   Weight (8)  |+-+-------------+\n\n\nEï¼šæ˜¯å¦ç‹¬å ï¼ˆæ’ä»–ï¼‰ï¼Œç‹¬å ä¾èµ–çš„æµï¼ˆå½¢è±¡ç‚¹å°±æ˜¯æˆ‘ç‹¬å å®ƒï¼ŒåŸæ¥ä¾èµ–å®ƒçš„äººå…¨éƒ¨å¾—ä¾èµ–æˆ‘ï¼‰\nStream Dependencyï¼šæµä¾èµ–\nWeightï¼šæµæƒé‡ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€å¥½ç†è§£çš„ï¼Œæƒé‡è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼\n\nè¿™é‡Œåæ§½ä¸€å¥ï¼šä½¿ç”¨HTTP/1.xï¼Œæµè§ˆå™¨å¯ä»¥å®Œå…¨æ§åˆ¶èµ„æºåŠ è½½é¡ºåºï¼HTTP/2è®©è¿™äº›äº‹æƒ…å˜å¾—æ›´å¥½ä¹Ÿæ›´å¤æ‚äº†ï¼ä½†æ˜¯ä¹ˆè¿˜æ˜¯å€¼å¾—å­¦ä¹ ä¸€ä¸‹çš„ï¼\nå…·ä½“å®ç°å°±è®¾è®¡åˆ°ç®—æ³•äº†ï¼Œå› ä¸ºæ—¢è¦è¦æ±‚æ€§èƒ½é«˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ±‚å‡†ç¡®æ€§ï¼å…³äºç®—æ³•å¯ä»¥çœ‹ RFC7540-5.3ï¼Œå®ç°çš„è¯å¯ä»¥çœ‹ä¸‹NGINXæˆ–è€…ç†Ÿæ‚‰è¯­è¨€ã€æ¡†æ¶çš„SDKï¼ä¸‹é¢æˆ‘å°±å°±å•ä»‹ç»ä¸€ä¸‹ï¼\n\nç®€å•çš„ä¾èµ–ï¼Œæ¯”å›¾ Bå’ŒCä¾èµ–äºAï¼Œæ­¤æ—¶æ’å…¥ä¸ªDä¹Ÿä¾èµ–äºAé‚£ä¹ˆå°±æ˜¯ä¸‹é¢è¿™ä¸ªæ•ˆæœï¼æ³¨æ„Dçš„ä½ç½®å¯ä»¥ä»»æ„ï¼\n\n  A                 A / \\      ==&gt;      /|\\B   C             B D C\n\n\nç‹¬å æƒ…å†µï¼Œè¿˜æ˜¯ä¸Šé¢çš„å…³ç³»ï¼Œå‡å¦‚Dç‹¬å Aï¼Œé‚£ä¹ˆå°±ä¼šå˜ä¸ºä¸‹é¢è¿™ä¸ªå›¾\n\n                    A  A                 | / \\      ==&gt;       DB   C              / \\                  B   C\n\n\næƒé‡ï¼Œä¸»è¦æ˜¯è§£å†³å…·æœ‰ç›¸åŒçˆ¶æµçš„æµåº”è¯¥æ ¹æ®æƒé‡æ¯”ä¾‹åˆ†é…èµ„æºï¼æ¯”å¦‚è¿™ä¸ªå›¾å‡å¦‚AåŠ è½½å®Œæˆåï¼Œé‚£ä¹ˆBåº”è¯¥ä¼˜å…ˆå¤„ç†ï¼Œæ‰ä¼šå¤„ç†Cï¼\n\n     A     /   \\  /     \\     B(12)   C(4) \n\n\nåŠ¨æ€è°ƒæ•´ï¼Œä¾‹å¦‚ä¸‹å›¾åˆå§‹åŒ–æ˜¯å›¾ä¸€ï¼Œå‡å¦‚æ­¤æ—¶Aä¾èµ–äºDï¼Œé‚£ä¹ˆDç›´æ¥æ›¿æ¢Açš„ä½ç½®(è¿™é‡Œçœ‹ç€æ“ä½œæ˜¯Dæ”¾åˆ°äº†å’ŒAä¸€æ ·çš„çˆ¶äº²ä¸‹é¢ï¼Œå˜æˆäº†å›¾intermediate)ï¼Œç„¶åAçš„å­ä¾èµ–å…³ç³»ä¸å˜ï¼ŒæŒªåŠ¨ä¸€ä¸‹ï¼Œå°±å˜æˆäº†å›¾non-exclusive ï¼å‡å¦‚Aç‹¬å Däº†ï¼Œå°±å˜æˆäº† å›¾exclusive !\n\n   x                x                x                 x   |               / \\               |                 |   A              D   A              D                 D  / \\            /   / \\            / \\                | B   C     ==&gt;  F   B   C   ==&gt;    F   A       OR      A    / \\                 |             / \\             /|\\   D   E                E            B   C           B C F   |                                     |             |   F                                     E             E(å›¾ä¸€)        (intermediate)   (non-exclusive)    (exclusive)\n\nå…¶ä»–å¸§\nPINGå¸§ ï¼Œä¸»è¦æ˜¯ç”¨æ¥ç»´æŒä¸€ä¸ªç©ºé—²è¿æ¥çš„ï¼Œä»¥åŠå¯ä»¥è®¡ç®—ä¸€æ¬¡RTTæ—¶é—´ï¼\n\nGOAWAYå¸§ ï¼Œä¸»è¦æ˜¯ç”¨æ¥å…³é—­è¿æ¥çš„ï¼ŒåŒæ—¶å…è®¸æºå¸¦å‘é€ä¸€ä¸ªé”™è¯¯ç ï¼\n\nRST_STREAM å¸§ï¼Œä¸»è¦æ˜¯ç”¨æ¥å…³é—­æµçš„ï¼ŒåŒæ—¶å…è®¸æºå¸¦å‘é€ä¸€ä¸ªé”™è¯¯ç ï¼\n\nCONTINUATION å¸§ï¼Œä¸»è¦æ˜¯è§£å†³å½“ HEADERå¸§ è¶…å‡ºäº†é™åˆ¶MAX_FRAME_SIZEçš„å¤§å°æ¥è·å–å®Œæ•´çš„HTTPé¦–éƒ¨çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å‘é€ CONTINUATION å¸§ï¼ŒåŒæ—¶CONTINUATIONå¸§ä¹Ÿéœ€è¦åœ¨MAX_FRAME_SIZEå¤§å°ä¹‹å†…ï¼Œæ‰€ä»¥å¯èƒ½è·Ÿéšå¤šä¸ª CONTINUATION å¸§ï¼ å®ƒæœ‰ä¸ªEND_HEADERS æ ‡è®°æ¥æ ‡è®°æ˜¯å¦ç»“æŸï¼æ‰€ä»¥å‡å¦‚å‡ºç°è¿™ä¸ªcaseé‚£ä¹ˆ Headerå¸§å°±éœ€è¦æ ‡è®°END_HEADERS=Falseäº†ï¼ å…¶å®PUSH_PROMISEå¸§ ä¸å¤Ÿå¤§ï¼ˆè¿™ä¸ªåé¢ä¼šè®²åˆ°ï¼‰ï¼Œåé¢ä¹Ÿå¾—ç”¨ CONTINUATION å¸§!\n\n\nHPACK ç¼–ç æˆ‘ä»¬çŸ¥é“HTTP/1.xå…¶å®å¯ä»¥å¯¹Bodyéƒ¨åˆ†è¿›è¡Œå‹ç¼©ï¼Œä½†æ˜¯å¤´éƒ¨éƒ¨åˆ†æ˜¯æ— æ³•å‹ç¼©çš„ï¼æ‰€ä»¥HTTP/2ä¸­å¼•å…¥äº†HPACK ä¸»è¦æ˜¯ç”¨æ¥å‹ç¼©HTTPçš„å¤´éƒ¨çš„ï¼Œä¸»è¦æ˜¯é‡‡ç”¨é™æ€è¡¨+åŠ¨æ€è¡¨+å‹ç¼©ç®—æ³•ç»„æˆï¼ç„¶åå°±æ˜¯HTTP/2ä¸­æŠŠè¯·æ±‚è¡Œ/å“åº”è¡Œéƒ¨åˆ†ç§»åˆ°äº†å…¨éƒ¨è½¬ç§»åˆ°äº†Headeréƒ¨åˆ†ï¼å¯¹ç…§å…³ç³»æ˜¯:\nmethod -&gt; :methodpath -&gt; :pathstatus -&gt; :status\n\né™æ€è¡¨é™æ€è¡¨ï¼ˆStatic Tableï¼‰ï¼Œä¸€å…±61å¯¹ï¼Œåº”è¯¥å¾ˆå¥½ç†è§£ï¼Œæ¯”å¦‚ method=GETï¼Œé‚£ä¹ˆä¼šæŠŠå®ƒè½¬æ¢æˆä¸€ä¸ªæ•°å­—ï¼Œä¾‹å¦‚:authority=www.google.com ä¼šè½¬æ¢ä¸€ä¸ªæ•°å­— + å­—ç¬¦ä¸²ï¼ˆä¸ä¸€å®šï¼‰ï¼\n+-------+-----------------------------+---------------+| Index | Header Name                 | Header Value  |+-------+-----------------------------+---------------+| 1     | :authority                  |               || 2     | :method                     | GET           || 3     | :method                     | POST          || 4     | :path                       | /             || 5     | :path                       | /index.html   || 6     | :scheme                     | http          || 7     | :scheme                     | https         || 8     | :status                     | 200           || 9     | :status                     | 204           || 10    | :status                     | 206           || 11    | :status                     | 304           || 12    | :status                     | 400           || 13    | :status                     | 404           || 14    | :status                     | 500           || 15    | accept-charset              |               || 16    | accept-encoding             | gzip, deflate || 17    | accept-language             |               |............| 58    | user-agent                  |               || 59    | vary                        |               || 60    | via                         |               || 61    | www-authenticate            |               |+-------+-----------------------------+---------------+\n\næ³¨æ„ï¼šè¿™é‡Œè™½ç„¶æ²¡æœ‰:method  ä¸” Header Value ä¸ºç©ºçš„è¿™ç§æƒ…å†µï¼Œå…¶å®å®é™…å¤„ç†çš„æ—¶å€™:method=Delete è¿™ç§å®é™…ä¸Š :methodä¼šç¼–ç ä¸º3ï¼Œå¦‚æœæ²¡æœ‰åˆ™å–keyç›¸åŒæœ€å¤§çš„indexï¼\nåŠ¨æ€è¡¨åŠ¨æ€è¡¨(Header Table)ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯åŠ¨æ€ç”Ÿæˆè¡¨ï¼Œç„¶åæœ€ç»ˆå½¢å¼ä¸Šå’Œä¸Šé¢é™æ€è¡¨å·®ä¸å¤šï¼å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€ä¸ªè¿æ¥ä¸Šï¼ˆæ³¨æ„ä¸€ä¸ªè¿æ¥å¯ä»¥æœ‰å¤šä¸ªè¯·æ±‚/å“åº”ï¼‰ï¼\nç”±äºåŠ¨æ€è¡¨æ—¶åŠ¨æ€ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆå¯¹äºå•æœºç»´æŠ¤çš„è¿æ¥æ•°è¿‡å¤šï¼Œæ­¤æ—¶åŠ¨æ€è¡¨ä¼šå¾ˆå å†…å­˜ï¼Œå‡å¦‚æ­¤æ—¶æˆ‘ä»¬ä¸è¿›è¡Œå†…å­˜é™åˆ¶ï¼Œå¾ˆå®¹æ˜“è¢«æ”»å‡»å¯¼è‡´å†…å­˜OOMï¼Œé‚£ä¹ˆæ‰€ä»¥åŠ¨æ€è¡¨ä¼šæœ‰ä¸€ä¸ªå¤§å°é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡ SETTINGS å¸§ä¸‹å‘HEADER_TABLE_SIZE=4096, å•ä½æ˜¯å­—èŠ‚ï¼Œæ¥å®ç°åŠ¨æ€è¡¨å†…å­˜é™åˆ¶ï¼é‚£ä¹ˆä¸€ä¸ªHeaderçš„Keyå’ŒValueçš„å¤§å°æ˜¯å¤šå°‘äº†ï¼Ÿè®¡ç®—å…¬å¼æ˜¯ len(key)+len(value)+32  , ä¸ºä»€ä¹ˆåŠ 32äº†ï¼Œæ˜¯å› ä¸ºå¤§éƒ¨åˆ†è¯­è¨€ï¼Œå­˜å‚¨stringä¼šé¢å¤–æ¶ˆè€—16å­—èŠ‚ç”¨æ¥å­˜å‚¨æ•°ç»„æŒ‡é’ˆå’Œæ•°ç»„é•¿åº¦ï¼\né‚£ä¹ˆå‡å¦‚åŠ¨æ€è¡¨åœ¨æˆ‘ä»¬å†™headerçš„æ—¶å€™ï¼Œå‘ç°å¤§å°è¶…å‡ºäº† HEADER_TABLE_SIZE æ€ä¹ˆåŠäº†ï¼Œå…·ä½“ç®—æ³•å°±æ˜¯ä¸ªFIFOæ¨¡å‹ï¼Œé˜Ÿåˆ—å¤§å°ç¡®å®šï¼Œæ‰€ä»¥å¤§æ¦‚æµç¨‹å°±æ˜¯ä¸‹é¢è¿™ä¸ªï¼š\n// è¯·æ±‚1// set max_size=32 + 4 + 32 + 4 + 32 + 4 + 32// è®¡ç®—index(key,value)å…¬å¼ = arr_index(key,value) + 61 + 1addHeader(&quot;k1&quot;, &quot;v1&quot;) // write k1-v1, arr=[k1-v1]addHeader(&quot;k2&quot;, &quot;v2&quot;) // write k2-v2, arr=[k2-v2, k1-v1]addHeader(&quot;k3&quot;, &quot;v3&quot;) // write k3-v3, arr=[k3-v3, k2-v2, k1-v1]addHeader(&quot;k4&quot;, &quot;v4&quot;) // write k4-v4, arr=[k4-v4, k3-v3, k2-v2]// è¯·æ±‚2addHeader(&quot;k3&quot;, &quot;v3&quot;) // write index=63addHeader(&quot;k1&quot;, &quot;v1&quot;) // write k1-v1, arr=[k1-v1, k4-v4, k3-v3]addHeader(&quot;k3&quot;, &quot;v3&quot;) // write index=64addHeader(&quot;k4&quot;, &quot;v4&quot;) // write index=63addHeader(&quot;k1&quot;, &quot;v1&quot;) // write index=62\n\nç¼–ç åœ¨HTTP/2ä¸­ç¼–ç é‡‡ç”¨çš„ç®—æ³•ä¸»è¦æ˜¯ varintç¼–ç  å’Œ  éœå¤«æ›¼ç¼–ç  ï¼ˆHuffman Coding ä¹Ÿå«åšå“ˆå¤«æ›¼ç¼–ç ï¼‰\næ¦‚å¿µï¼š\n\nvarint ç¼–ç æ˜¯æ•°å­—å‹ç¼©ç®—æ³•ä¸­å¸¸è§çš„ä¸€ç§ï¼Œä¸»è¦æ˜¯é‡‡ç”¨å˜é•¿æ¥å­˜å‚¨æ•°å­—ï¼Œæ¯”å¦‚è™½ç„¶å€¼å®šä¹‰çš„æ˜¯8å­—èŠ‚ï¼Œä½†æ˜¯æ¯”å¦‚æ•°å­—1å¯ä»¥ç”¨1ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç ï¼Œä¸»è¦åŸç†å°±æ˜¯åˆ©ç”¨ msb (the Most Significant Bit æœ€é«˜æœ‰æ•ˆä½)!\néœå¤«æ›¼ç¼–ç æ˜¯æ–‡æœ¬å‹ç¼©ç®—æ³•ä¸­å¸¸è§çš„ä¸€ç§ï¼Œæ˜¯åŸºäºå­—ç¬¦å‡ºç°çš„æ¬¡æ•°ä¸ºæƒé‡ï¼ˆå¢’ç¼–ç ï¼‰è¿›è¡Œçš„æ„å»ºå­—å…¸ï¼Œè¿›è€Œæ„å»ºéœå¤«æ›¼æ ‘ï¼Œç„¶åæ ¹æ®éœå¤«æ›¼æ ‘æ¥ç¡®å®šå­—ç¬¦çš„äºŒè¿›åˆ¶ç¼–ç ã€‚ä½†æ˜¯å¦‚æœå­—ç¬¦ä¸é‡å¤ï¼Œä¸”å­—ç¬¦è¿˜å¾ˆå¤šï¼Œå¯¼è‡´éœå¤«æ›¼æ ‘å¾ˆæ·±ï¼Œé‚£ä¹ˆéœå¤«æ›¼ç¼–ç çš„æ„ä¹‰å°±ä¸å¤§äº†ï¼\n\næ³¨æ„:\n\nHTTP/2 ä¸­é‡‡ç”¨çš„ varint ç¼–ç å¹¶ä¸æ˜¯æ ‡å‡†çš„ï¼Œå› ä¸ºä»–éœ€è¦æ ¹æ®ä½ä½ç¬¬ä¸€ä¸ªå­—èŠ‚æ ‡è®°falg, æ‰€ä»¥è§£å†³æ€è·¯å°±æ˜¯å‡å»ç¬¬ä¸€ä¸ªå­—èŠ‚å®šä¹‰çš„æœ€å¤§å€¼ï¼ˆåŒºé—´æ˜¯ 1 åˆ° 1&lt;&lt;7-1ï¼‰ï¼Œå‰©ä½™çš„å€¼ç”¨çš„varintç¼–ç ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ: https://datatracker.ietf.org/doc/html/rfc7541#section-5.1ï¼Œ ä¼ªä»£ç å¦‚ä¸‹: \n\n# ä¼ªä»£ç if num &lt; max&#123;\t return num&#125;[Max,varint(num-max) ...]# case: # ä¾‹å¦‚max=1&lt;&lt;7-1, num=126(0b01111110), é‚£ä¹ˆè¾“å‡º [0x7e]# ä¾‹å¦‚max=1&lt;&lt;7-1, num=127(0b01111111)ï¼Œé‚£ä¹ˆè¾“å‡º [0x7f, 0x00]# ä¾‹å¦‚max=1&lt;&lt;7-1, num=127+128(0b10000000), é‚£ä¹ˆè¾“å‡º [0x7f, 0x80, 0x01]# ä¸‹æ–‡ä¸­å« (7+)varint è¡¨ç¤ºmax=1&lt;&lt;7-1 ä¹Ÿå°±æ˜¯ä¸Šé¢è¿™ä¸ªcase, ä¾‹å¦‚(6+)varint è¡¨ç¤ºmax=1&lt;&lt;6-1\n\n\nHTTP/2 ä¸­é‡‡ç”¨çš„ éœå¤«æ›¼ç¼–ç ä¹Ÿä¸æ˜¯æŒ‰ç…§æ ‡å‡†çš„ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯é™æ€è¡¨ï¼Œä¹Ÿå°±æ˜¯å®ƒçœå»äº†åŠ¨æ€ç”Ÿæˆéœå¤«æ›¼æ ‘çš„è¿‡ç¨‹ï¼ˆçœç•¥è®¡ç®—è¿‡ç¨‹å’ŒMapè¿‡ç¨‹ï¼‰ï¼Œè¿™ä¸ªæ ‘å°±æ˜¯ä¸ªé™æ€çš„ï¼å…·ä½“å¯ä»¥å‚è€ƒ: https://datatracker.ietf.org/doc/html/rfc7541#section-5.2 !\n\n1. Indexed Header Field Representationé‡‡ç”¨è¿™è¾¹ç¼–ç æƒ…å†µæ˜¯ï¼š header çš„ keyå’Œvalue éƒ½åœ¨ä¸­ï¼Œç„¶åå¯ä»¥æ‹¿åˆ°indexï¼ˆåŠ¨æ€è¡¨index=é™æ€è¡¨index+åç§»é‡ï¼‰ï¼Œæ¯”å¦‚method: GET\n+---+---+---+---+---+---+---+---+| 1 |        Index (7+)         |+---+---------------------------+\n\n\n1ï¼šæ ‡è¯†ç¬¦å·ï¼Œvarintç¼–ç åç¬¬ä¸€ä¸ªå­—èŠ‚çš„é«˜ä½8bitæ ‡è¯†ç¬¦æ˜¯1\nindex (7+):  è¡¨ç¤ºindexå€¼ï¼Œé‡‡ç”¨ (7+)varint ç®—æ³•\n\n2.1 Literal Header Field with Incremental Indexing - indexed Nameè¡¨ç¤º:  name åœ¨è¡¨ä¸­ï¼Œvalue ä¸åœ¨è¡¨ä¸­ï¼Œä¸”éœ€è¦æ·»åŠ åˆ°è¡¨ä¸­ï¼Œæ¯”å¦‚ Host: www.google.com\n  0   1   2   3   4   5   6   7+---+---+---+---+---+---+---+---+| 0 | 1 |      Index (6+)       |+---+---+-----------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+\n\n\n01+ Index (6+) ï¼Œä¸ºindexç¼–ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†ä¸Šé¢Indexed Header Field Representation çš„case\nHï¼š ä¸ºValue String æ˜¯å¦é‡‡ç”¨éœå¤«æ›¼ç¼–ç ç¼–ç ï¼ŒH=1 è¡¨ç¤ºé‡‡ç”¨éœå¤«æ›¼ç¼–ç \nValue Length(7+): è¡¨ç¤ºvalue stringçš„é•¿åº¦ï¼Œå…·ä½“ç®—æ³•å°±æ˜¯ (7+)varint  ç®—æ³•\nValue Stringï¼šéœå¤«æ›¼ç¼–ç  or åŸå€¼\n\n2.2  Literal Header Field with Incremental Indexing - New Nameè¡¨ç¤ºï¼š name ä¸åœ¨è¡¨ä¸­ï¼Œvalueä¹Ÿä¸åœ¨è¡¨ä¸­ï¼Œä½†æ˜¯éœ€è¦æ·»åŠ åˆ°è¡¨ä¸­ï¼ä¾‹å¦‚è‡ªå®šä¹‰header  X-Host: www.google.comï¼Œä¸”æˆ‘ä»¬å…è®¸ name å’Œ value æ·»åŠ åˆ°è¡¨ä¸­ï¼\n  0   1   2   3   4   5   6   7+---+---+---+---+---+---+---+---+| 0 | 1 |           0           |+---+---+-----------------------+| H |     Name Length (7+)      |+---+---------------------------+|  Name String (Length octets)  |+---+---------------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+\n\nè¿™é‡Œæˆ‘å°±ä¸è¿‡å¤šè®²è§£äº†ï¼Œé€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªè®²è§£ï¼Œåº”è¯¥å¤§å®¶éƒ½æœ‰æ‰€äº†è§£ï¼è¿™ä¸ªä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸€å®šæ˜¯ 0x40\n3.1 Literal Header Field without ï¼ˆNeverï¼‰ Indexing - Indexed Nameå’Œä¸Šé¢çš„Literal Header Field with Incremental Indexing - indexed Name çš„åŒºåˆ«åœ¨äºï¼Œè¿™ä¸ªä¸éœ€è¦è¢«æ·»åŠ åˆ°è¡¨ä¸­ï¼\nå…¶æ¬¡å°±æ˜¯ Literal Header Field without Indexing å’Œ Literal Header Field Never Indexing  ä¸»è¦åŒºåˆ«åœ¨äºé¦–å­—èŠ‚ï¼Œå‰è€…æ˜¯ 0000xxxxï¼Œåè€…æ˜¯0001xxxxï¼\n  0   1   2   3   4   5   6   7+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 0 |  Index (4+)   |+---+---+-----------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+\n\n3.2 Literal Header Field withoutï¼ˆNeverï¼‰ Indexing - New Nameå’Œä¸Šé¢çš„Literal Header Field with Incremental Indexing - indexed Name çš„åŒºåˆ«åœ¨äºï¼Œè¿™ä¸ªä¸éœ€è¦è¢«æ·»åŠ åˆ°è¡¨ä¸­ï¼\n\t0   1   2   3   4   5   6   7+---+---+---+---+---+---+---+---+| 0 | 0 | 0 | 0 |       0       |+---+---+-----------------------+| H |     Name Length (7+)      |+---+---------------------------+|  Name String (Length octets)  |+---+---------------------------+| H |     Value Length (7+)     |+---+---------------------------+| Value String (Length octets)  |+-------------------------------+\n\n4. Dynamic Table Size Updateæˆ‘ä»¬çŸ¥é“ SETTINGSå¸§çš„ SETTINGS_HEADER_TABLE_SIZE ä¹Ÿæ˜¯è®¾ç½® tables sizeå¤§å°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„å«ä¹‰å°±æ˜¯åŠ¨æ€å˜æ›´ sizeï¼Œä½†æ˜¯è¿™ä¸ªmax size å¿…é¡»å°äºæˆ–è€…ç­‰äº SETTINGS_HEADER_TABLE_SIZEï¼\n0   1   2   3   4   5   6   7+---+---+---+---+---+---+---+---+| 0 | 0 | 1 |   Max size (5+)   |+---+---------------------------+\n\n5. æ€»ç»“æ³¨æ„å…³äº Literal Header Field without Indexing å’Œ Literal Header Field Never Indexing   çš„åŒºåˆ«åœ¨äºå“ªé‡Œäº†ï¼Ÿå®˜æ–¹çš„è§£é‡Šå·®åˆ«å°±ä¸€å¥è¯  Intermediaries MUST use the same representation for encoding this header field., æ„æ€å°±æ˜¯å‡å¦‚æˆ‘ä»¬è¯·æ±‚ä¸­é—´æœ‰ä¸ªHTTP/2ä»£ç†ï¼ˆä¾‹å¦‚ nginxï¼‰ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯Never Indexed é‚£ä¹ˆä»£ç†ä¹Ÿå¿…é¡»åŸå°ä¸åŠ¨çš„è½¬å‘ !\nä½†æ˜¯ç›®å‰çœ‹Nginxå¹¶ä¸æ”¯æŒåç«¯æœåŠ¡(up stream)æ˜¯HTTP/2åè®®ï¼Œåªæ”¯æŒGRPCï¼ˆæ³¨æ„GRPCå¤„ç†æ¨¡å—å¯ä»¥å¤„ç†ä¸€äº›é€šç”¨çš„HTTP/2åè®®çš„è¯·æ±‚ï¼Œä½†æ˜¯æ”¯æŒåº¦å¹¶ä¸å¥½ï¼‰ï¼å…·ä½“å¯ä»¥å‚è€ƒ https://trac.nginx.org/nginx/ticket/923 !\næœåŠ¡å™¨æ¨é€ PUSH_PROMISE å¸§é¦–å…ˆè¦æ˜ç™½ï¼ŒHTTP/2ä¸ºä»€ä¹ˆä¼šæœ‰æœåŠ¡ç«¯æ¨é€ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸€ä¸ªæ™®é€šçš„åŠ è½½ç½‘é¡µçš„æµç¨‹ï¼Œä¼šè¿”å›ç½‘é¡µï¼Œç„¶åå†èµ·è¯·æ±‚ä¸€äº›é™æ€èµ„æºï¼Œæ‰€ä»¥æµè§ˆå™¨çš„æ•´ä¸ªæµç¨‹æ˜¯ä¸‹é¢è¿™ä¸ªæµç¨‹å¦‚ä¸‹å›¾å·¦ä¾§ï¼ä½†æ˜¯å¦‚æœæœ‰æœåŠ¡ç«¯æ¨é€çš„è¯åç»­åŠ è½½næ¬¡èµ„æºå°±ä¼šå‡å°‘næ¬¡RTTçš„æ—¶é—´ï¼Œå¦‚ä¸‹å›¾å³ä¾§ï¼é‚£ä¹ˆHTTP/2æ˜¯å¦‚ä½•å®ç°æœåŠ¡ç«¯æ¨é€çš„å‘¢ï¼Ÿ\n\né¦–å…ˆåœ¨è®²ä¸‹é¢æˆ‘ä»¬éœ€è¦å…ˆè¯´æ˜ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœå®ç°ä¸Šé¢çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰æµè§ˆå™¨è¦æ¨é€å“ªäº›èµ„æºï¼Œä¸ç„¶æˆ‘ä»¬å…ˆè¿”å›htmlæµè§ˆå™¨å°±æ¸²æŸ“htmlç›´æ¥å‘èµ·è¯·æ±‚åŠ è½½é™æ€æ–‡ä»¶äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¨é€å°±ç™½åšäº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦çŸ¥é“æ˜¯å“ªä¸ªæµå‘èµ·çš„åŠ è½½htmlçš„è¯·æ±‚ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæµå‘Šè¯‰æµè§ˆå™¨æˆ‘ä»¬è¦ä¸‹å‘ç»™ä½ å“ªäº›èµ„æºåœ¨è¿”å›HTMLä¹‹å‰ï¼\n# æœåŠ¡å™¨æ¨é€ä»æºæœåŠ¡å™¨çš„ Link æ ‡å¤´çš„ rel=preload å‚æ•°æå– URI å¼•ç”¨ï¼Œç„¶åå°†è¿™äº›é¢å¤– URI æä¾›ç»™å®¢æˆ·ç«¯Link: &lt;/images/image.png&gt;;rel=preload;Link: &lt;/css/main.css&gt;;rel=preload;\n\nPUSH_PROMISE å¸§æ˜¯æœåŠ¡å™¨å‘èµ·çš„è¯·æ±‚ï¼Œæ‰€ä»¥è¿™é‡Œçš„stream_idæ˜¯å¶æ•°ï¼\n+---------------+|Pad Length? (8)|+-+-------------+-----------------------------------------------+|R|                  Promised Stream ID (31)                    |+-+-----------------------------+-------------------------------+|                   Header Block Fragment (*)                 ...+---------------------------------------------------------------+|                           Padding (*)                       ...+---------------------------------------------------------------+\n\n\nR: ä¿ç•™ä½\nPromised Stream ID: è¿™ä¸ªå°±æ˜¯ä¸Šé¢è®²åˆ°çš„ï¼Œå…¶å®å°±æ˜¯Push stream idï¼ˆæ‰¿è¯ºè¦å‘é€çš„stream IDï¼‰\nHeader Block Fragmentï¼š è¯·æ±‚headerï¼Œå…¶å®å°±æ˜¯æŠŠæ¨é€çš„è¯·æ±‚ä½“å‘é€è¿‡å»äº†ï¼\n\næ³¨æ„ï¼šç”±äºæ¨é€ä¼šæ¶‰åŠåˆ°å¹‚ç­‰ã€å®‰å…¨ç­‰é—®é¢˜ï¼Œæ‰€ä»¥ä¸€èˆ¬å°±æ˜¯æ¨é€é™æ€èµ„æºï¼\næœåŠ¡å™¨æ¨é€çš„æ•´ä½“æµç¨‹è¿˜æ˜¯å¾ˆç®€å•ï¼Œå°±æ˜¯å“åº”HTMLä¹‹å‰å‘é€ PUSH_PROMISE å¸§ï¼Œè¿™ä¸ªå¸§ä¼šæºå¸¦pushèµ„æºçš„è¯·æ±‚å†…å®¹ï¼ç„¶åè¿”å›HTMLï¼Œç„¶åå†ç”¨Promised Stream ID å†™å“åº”å…³é—­æµå³å¯ï¼\næœåŠ¡ç«¯æ¨é€ç›¸æ¯”äºHTTP/2ä¸æ¨é€ï¼Œå‰ç«¯é¡µé¢æ•´ä½“çš„æå‡ç‡å¤§çº¦åœ¨8%å·¦å³ï¼Œå…·ä½“å¯ä»¥çœ‹ç›¸å…³æµ‹è¯„ ï¼ŒåŒæ—¶å¼€å¯åä¹Ÿä¼šå­˜åœ¨ä¸€å®šæµªè´¹å¸¦å®½çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å‡å¦‚æµè§ˆå™¨æœ‰ç¼“å­˜ä¸å°±ä¸ç”¨è¿”å›äº†ï¼ç›®å‰ä¸»æµçš„æ¶æ„éƒ½æ˜¯å°†é™æ€èµ„æºåŸºæœ¬æ”¾åœ¨CDNä¸Šï¼Œæ‰€ä»¥å¦‚æœéœ€è¦ä½¿ç”¨æœåŠ¡ç«¯æ¨é€ï¼Œéœ€è¦ç¡®å®šCDNå‚å•†æ˜¯å¦æ”¯æŒï¼\nä¸‹å›¾æ¥è‡ªäºåˆæ‹äº‘å…³äºDNS æœåŠ¡ç«¯æ¨é€ç›¸å…³çš„é¡µé¢ï¼Œå…·ä½“å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼š\n\nHTTP/3 ä»‹ç»â€‹    é€šè¿‡å­¦ä¹ ä¸Šé¢æˆ‘ä»¬å‘ç°HTTP/2å…¶å®åšäº†å¾ˆå¤šçš„ä¼˜åŒ–ï¼Œåœ¨æ•´ä¸ªä¼ è¾“å±‚ï¼Œä¸ä»…é™ä½äº†æ•°æ®åŒ…çš„å¤§å°ï¼ŒåŒæ—¶æµå’Œå¤šè·¯å¤ç”¨é™ä½äº†è¿æ¥ä¸Šçš„å¼€é”€ï¼Œæé«˜äº†é¡µé¢çš„åŠ è½½é€Ÿåº¦ï¼ä½†æ˜¯è¿™ç§ä¼˜åŒ–ä¹Ÿæ˜¯æœ‰å¼Šç«¯çš„ï¼ç°åœ¨ç§»åŠ¨äº’è”ç½‘æ¯”è¾ƒæ™®åŠï¼Œå¤§éƒ¨åˆ†æµé‡éƒ½æ¥è‡ªäºç§»åŠ¨è®¾å¤‡ï¼Œè€Œç§»åŠ¨è®¾å¤‡æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ç½‘ç»œé—®é¢˜ï¼è€ŒHTTP/2ä¾èµ–äºTCPï¼Œåœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼ŒTCPçš„æµæ§ä¼šå¯¼è‡´HTTP/2å˜æ…¢ï¼Œå¦‚æœå‘ç”Ÿä¸¢åŒ…ï¼Œå°±ä¼šå¯¼è‡´HoL (Head of Line Blocking å¤´éƒ¨é˜»å¡)ï¼Œ å¯¼è‡´ä¸€ä¸ªè¿æ¥ä¸Šæ‰€æœ‰çš„æµéƒ½éœ€è¦ç­‰å¾…ï¼\nâ€‹    å› æ­¤ä½œä¸ºHTTP/2å‰èº«SPDYçš„å‘æ˜è€…Googleï¼Œæ¯•ç«Ÿèµ°çš„è·¯æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥ä¹Ÿæå‡ºäº†æ¯”è¾ƒå¥½çš„è§£å†³æ€è·¯ï¼Œé‚£å°±æ˜¯æŠŠTCPæ›¿æ¢æ‰ï¼Œéšåå°±è¯ç”Ÿäº†QUICï¼QUIC ( Quick UDP Internet Connection) æ˜¯ Google ç ”å‘çš„ä¸€ç§åŸºäº UDP åè®®çš„ä½æ—¶å»¶äº’è”ç½‘ä¼ è¾“åè®®ã€‚åœ¨2018å¹´IETFä¼šè®®ä¸­ï¼ˆä¸»è¦åŸå› è¿˜æ˜¯TLS v1.3åŒå¹´æ­£å¼å‘å¸ƒï¼‰ï¼ŒHTTP-over-QUICåè®®è¢«é‡å‘½åä¸ºHTTP/3ï¼Œå¹¶æˆä¸º HTTP åè®®çš„ç¬¬ä¸‰ä¸ªæ­£å¼ç‰ˆæœ¬ï¼Œå¤§æ¦‚çš„å…³ç³»å°±æ˜¯ï¼š è¿è¡Œåœ¨ QUIC ä¹‹ä¸Šçš„ HTTP åè®®è¢«ç§°ä¸º HTTP/3ï¼\n**QUIC æ˜¯ä¼ è¾“å±‚åè®®(4å±‚åè®®)**ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªç‰ˆæœ¬ä¸€ä¸ªæ˜¯gQUIC(Google QUIC)å’ŒiQUIC(IETF QUIC)ï¼Œæ³¨æ„ä¸¤è€…å·®åˆ«ï¼æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹QUIC ä»‹ç»ï¼ŒQUIC[RFC 8999-9002]ï¼Œä»¥åŠ TLS1.3[RFC 8446]ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªå¤§æ¦‚çš„ä¸€ä¸ªæ¨¡å‹å›¾ï¼š\n\nç”±äºæœ¬æ–‡å‰é¢ç¯‡å¹…æœ‰ç‚¹é•¿äº†ï¼Œè€Œä¸”ä»HTTPå‘å±•å†å²ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œæ‰€ä»¥å¦‚æœæœ‰å…´è¶£çš„æƒ³æ·±å…¥äº†è§£çš„å¯ä»¥æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œä¸Šé¢å·²ç»æä¾›äº†å¾ˆå¤šäº†ï¼Œä¸‹é¢å°±åˆ—å‡ºæ¥äº†QUICçš„å‡ å¤§ç‰¹ç‚¹ï¼š\n\né™ä½äº†å»ºè¿æ—¶é—´ï¼ˆæ³¨æ„aä¸ºTLSå®Œå…¨æ¡æ‰‹ï¼Œbä¸ºTLSç®€åŒ–æ¡æ‰‹ï¼Œå¯ä»¥å®ç°0RTT æ¡æ‰‹ï¼‰\n\n\n\næ ¹æ®ç¬¬ä¸‰æ–¹æ•°æ®ä½¿ç”¨QUIC 0RTTç‡å¤§çº¦åœ¨55%å·¦å³ï¼Œå…·ä½“å¯ä»¥ç‚¹å‡»æ–‡ç« æŸ¥çœ‹è¯¦æƒ…ï¼\n\n\nä¼˜åŒ–äº†æµé‡æ§åˆ¶ç®—æ³•\nä¼˜åŒ–äº†æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆå…¶å®å’ŒTCPç”¨çš„æ˜¯ä¸€æ ·çš„éƒ½æ˜¯Cubicç®—æ³•ï¼‰\nç”¨æˆ·æ€åè®®ï¼Œä¸éœ€è¦å‡çº§orä¿®æ”¹å†…æ ¸ï¼Œå‡çº§è¿­ä»£å®¹æ˜“ï¼Œè™½ç„¶TCPæœ‰è®¸å¤šæ–°ç‰¹æ€§ï¼Œä½†æ˜¯æŠµæŒ¡ä¸ä½ä¸æ•¢éšæ„å‡çº§å†…æ ¸å“‡ï¼\n\nç›®å‰å¤–éƒ¨å¯¹äºQUICçš„å®ç°ä¹Ÿæ¯”è¾ƒå¤šï¼Œæ¯”å¦‚å­—èŠ‚çš„TTQUICï¼Œå¿«æ‰‹çš„KQUIC, ä»¥åŠå¾®è½¯çš„ msquic  ã€‚ä½†æ˜¯ç›®å‰æ¥çœ‹QUICä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¸»è¦é—®é¢˜è¿˜æ˜¯UDPå¸¦æ¥çš„é—®é¢˜ï¼Œå› ä¸ºä¸åŒè¿è¥å•†ä¼šå¯¹UDPè¿›è¡Œäº†ä¸€å®šçš„é™åˆ¶ï¼Œå…¶æ¬¡å°±æ˜¯å¤šä¸€å±‚ç”¨æˆ·æ€åè®®çš„å¼€é”€ä¹Ÿæ˜¯æœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—(CPUã€Memçš„å¼€é”€)ï¼Œæœ€åå°±æ˜¯ç›®å‰äººä»¬å¯¹äºTCPä¼˜åŒ–åšçš„å¤ªå¤šäº†ï¼ä¸è¿‡ç›¸ä¿¡è¿™äº›é—®é¢˜éƒ½æ˜¯å¯ä»¥ç”¨æ—¶é—´å»è§£å†³çš„ï¼Œç›¸ä¿¡æœªæ¥QUICå‘å±•çš„æ›´å¥½ï¼\nå‚è€ƒæ–‡ç« \nSSL/TLSå‘å±•å†å²å’ŒSSLv3.0åè®®è¯¦è§£\nHTTPSçš„æ€§èƒ½æ¶ˆè€—\næ·±å…¥è§£è¯»SSL/TLSçš„å®ç°\nRFC7540\nHTTP2æµé‡æ§åˆ¶ä»‹ç»\næŠ€æœ¯å¹²è´§ï¼šHTTP/2 ä¹‹æœåŠ¡å™¨æ¨é€ (Server Push) æœ€ä½³å®è·µ\næ­ç§˜QUICçš„äº”å¤§ç‰¹æ€§åŠå¤–ç½‘è¡¨ç°\nTCPæµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶\nHTTP/3 åŸç†å®æˆ˜\nQUIC with TLS1.3 ç®€ä»‹\n\n","categories":["HTTP"],"tags":["HTTP"]},{"title":"Thrift åè®®è®²è§£","url":"/2022/03/20/1fbc1901406195cf47c58e7436468f2e/","content":"æœ¬æ–‡ä¸»è¦æ˜¯ä»‹ç» Thriftåè®®ï¼ŒThrift åè®®å‘å±•å†å²å’Œå‘å±•èƒŒåçš„æ•…äº‹ï¼å†å…¶æ¬¡å°±æ˜¯ä»‹ç»å¦‚ä½•ç¼–è§£ç Thriftåè®®ï¼å¦‚æœä½ ä¹Ÿæƒ³äº†è§£PBï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« : PBåè®®è®²è§£.\n\n\næ•´ä½“ä»‹ç»\nThrift åè®®æ•´ä½“è®¾è®¡æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯å‘¢è¯­æ³•æ”¯æŒåº¦ä¹Ÿæ¯”è¾ƒé«˜ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡ç¼–å†™IDLæŠŠæ‰€æœ‰æ¥å£å®šä¹‰èƒ½åšçš„äº‹æƒ…éƒ½åšäº†ï¼è¿™ä¸ªæ˜¯åŒºåˆ«äºPBçš„ï¼Œä½†æ˜¯PBè§„èŒƒæ€§è¦å¥½äºThrift ä»¥åŠæ•´ä½“çš„ç”Ÿæ€æ”¯æŒã€ç¤¾åŒºä¸Šéƒ½æ˜¯ä¼˜ä¸Thriftï¼\n\nThrift åŒ…å«äº†RPCçš„åè®®å±‚ã€åºåˆ—åŒ–å±‚ï¼PBåªæä¾›äº†åºåˆ—åŒ–/ç¼–ç å±‚ï¼Œéœ€è¦GRPC/å…¶ä»–RPCæ¡†æ¶åè®®è¿›è¡Œä¼ è¾“ï¼\n\næ¶æ„å›¾å°±ä¸èŠäº†ï¼Œç½‘ä¸Šä¸€å †ï¼Œå°±ä¸€ä¸ªrpcé€šä¿¡æ¡†æ¶å…¶å®æ¶æ„å›¾éƒ½ä¸€æ ·ï¼ä¸‹æ–‡ä¸»è¦ä»‹ç»ï¼š æ¶ˆæ¯åè®®ï¼ˆåè®®å±‚ï¼‰ + ä¼ è¾“åè®®ï¼ˆä¼ è¾“å±‚ï¼‰ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ Kitex ã€GRPCã€Dubbo .\n\nThrift æ˜¯ facebook å¼€æºçš„ä¸€ä¸ªrpcåè®®ï¼Œè¯ç”Ÿæ—¶é—´æ¯”è¾ƒæ—©ï¼Œåº”è¯¥æ˜¯10å¹´ä¹‹å‰äº†ï¼Œæ‰€ä»¥å›½å†…äº’è”ç½‘å…¬å¸åŸºæœ¬ä¸Šéƒ½ç”¨çš„thriftåè®®ï¼ŒåŸå› å°±æ˜¯å‡ºæ¥çš„æ¯”è¾ƒæ—©çš„æˆç†Ÿçš„RPCæ¡†æ¶ï¼ä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¤è€çš„åè®®å¾€å¾€ä¸æ»¡è¶³ç°åœ¨çš„æœåŠ¡æ¶æ„ï¼Œæ‰€ä»¥åæœŸä¹Ÿåšäº†è¿›ä¸€æ­¥çš„å‡çº§ï¼Œä½†æ˜¯è€çš„ä¸šåŠ¡è¿˜åœ¨è·‘ï¼Œå‡çº§æ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿå°±å¯¼è‡´å¾ˆå¤šå…¬å¸Thriftå¹¶æ²¡æœ‰ç”¨åˆ°æ–°ç‰¹æ€§ï¼\n\nå¤§å®¶å¯ä»¥çœ‹ä¸‹GOçš„å®ç°https://github.com/apache/thrift/tree/master/lib/go ï¼\n\nThrift è¯­æ³•ä¸°å¯Œï¼Œè¯¦ç»†å¯ä»¥çœ‹æ–‡æ¡£ï¼šhttps://thrift.apache.org/docs/ !\n\n\ntypedef string Birthdayconst Birthday NationalDay=&#x27;1949-10-01&#x27;// å…¶ä»–ç±»å‹ i64 i32 i16 byte double bool binarystruct TestRequest &#123;     1: string Field_name = &#x27;default value&#x27; (api.tag=&#x27;xxxx&#x27;);    2: required string F_string_required;    3: optional string F_string_optional;    4: list&lt;string&gt; F_list_default;    5: map&lt;string,string&gt; F_map_default;    6: set&lt;string&gt; F_set_default;    7: optional Numberz F_enum = Numberz.Unknown,&#125;enum Numberz&#123;  Unknown = 0  ONE = 1  TWO&#125;struct TestResponse &#123; &#125;service ThriftTest&#123;\tTestResponse Test (1: TestRequest req),&#125;\n\næ¶ˆæ¯ï¼ˆç¼–ç ï¼‰åè®®ä¸»è¦æ˜¯è¯¦ç»†ä»‹ç»äº†æ¶ˆæ¯ä¼ è¾“çš„æ—¶å€™åè®®çš„ä¸»è¦ç¼–è§£ç æ–¹å¼ï¼Œæ³¨æ„thrifté‡‡ç”¨çš„æ˜¯å¤§ç«¯ç¼–ç ï¼\n1. TBinaryProtocolæ¶ˆæ¯åè®®ä»‹ç»ï¼Œæœ‰ä¸¤ç§åè®®æ ¼å¼ï¼ä¸»è¦æ˜¯ç”±äºå†å²åŸå› ï¼Œå¯¼è‡´æœ‰ä¸¤ç§åè®®å¹¶å­˜ï¼ä¸‹é¢ä»‹ç»åŸºå‚è€ƒè‡ªå®˜æ–¹æ–‡æ¡£: thrift-binary-protocol\n1. æ¶ˆæ¯åè®®ä¸€ï¼ˆæ–°ç¼–ç ï¼Œä¸¥æ ¼æ¨¡å¼ï¼‰Binary protocol Message, strict encoding, 12+ bytes:+--------+--------+--------+--------+--------+--------+--------+--------+--------+...+--------+--------+--------+--------+--------+|1vvvvvvv|vvvvvvvv|unused  |00000mmm| name length                       | name                | seq id                            |+--------+--------+--------+--------+--------+--------+--------+--------+--------+...+--------+--------+--------+--------+--------+\n\n\nå‰ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºç‰ˆæœ¬å·ï¼š**é«˜ä½ç¬¬ä¸€ä¸ªbitå›ºå®šä¸º1(å› ä¸ºä¸ºäº†åŒºåˆ†ä¸‹é¢åè®®äºŒ)**ï¼Œå…¶ä»–17ä¸ªbit(vvvvvvvvvvvvvvv)è¡¨ç¤ºç‰ˆæœ¬ã€‚\nç¬¬ä¸‰ä¸ªå­—èŠ‚ä¸ºæ— ç”¨å­—èŠ‚ï¼šunusedæ˜¯ä¸€ä¸ªè¢«å¿½ç•¥çš„å­—èŠ‚ã€‚\nç¬¬å››ä¸ªå­—èŠ‚ä¸ºæ¶ˆæ¯ç±»å‹ï¼š mmmæ˜¯æ¶ˆæ¯ç±»å‹ï¼Œä¸€ä¸ªæ— ç¬¦å·çš„ 3 ä½æ•´æ•°ï¼ŒåŒæ—¶é«˜ä½5bitå¿…é¡»ä¸º0(æœ‰äº›SDKä¼šæ ¡éªŒ)ã€‚\n\n// å–å¤´éƒ¨å››ä¸ªå­—èŠ‚: size = readInt32()// å–æ¶ˆæ¯ç±»å‹: size &amp; (1&lt;&lt;8)-1// å–ç‰ˆæœ¬å·:  siez &amp; 0xffff0000, ç‰ˆæœ¬åŸºæœ¬å°±æ˜¯1,ç›´æ¥ç¡¬ç¼–ç æ¯”è¾ƒå°±è¡Œäº†//  æ¶ˆæ¯ç±»å‹å ç”¨3bitCall: 1Reply: 2Exception: 3Oneway: 4\n\n\nname lengthï¼šæ¶ˆæ¯åé•¿åº¦ï¼Œå ç”¨4å­—èŠ‚ï¼å¤§ç«¯ï¼ï¼ˆæ³¨æ„å¤§å°ç«¯åªæ˜¯é’ˆå¯¹äºnumberç±»å‹ï¼Œè€Œä¸”å¤§å°ç«¯è½¬æ¢åŸºæœ¬æ— å¼€é”€ï¼‰\nname: æ¶ˆæ¯åï¼Œutf8ç¼–ç \nseq id:  å ç”¨å››å­—èŠ‚ï¼Œå¤§ç«¯ï¼ï¼ˆä¸€èˆ¬rpcå¤šè·¯å¤ç”¨éƒ½æœ‰ï¼Œå› ä¸ºè¦å¹¶å‘å‘é€è¯·æ±‚ä¹ˆï¼Œä¸èƒ½åŒä¸€ä¸ªè¿æ¥ å‘é€æ¥æ”¶å®Œ  A  å†å‘é€æ¥æ”¶ Bè¯·æ±‚ï¼Œ åƒHttp1.1å°±æ˜¯PingPongåè®®ï¼ŒHTTP2ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªseq id ï¼Œè¿™ä¸œè¥¿åšçš„ç®€å•ç‚¹å°±å…¨å±€è‡ªå¢ä¸€ä¸ªidå³å¯ï¼ï¼‰\n\n\nè¿™é‡Œè¡¥å……ä¸‹ä½è¿ç®—ï¼Œä½è¿ç®—ä¸­ &amp;ä¸€èˆ¬ä½œç”¨å°±æ˜¯å–å€¼ï¼Œ |ä¸€èˆ¬ä½œç”¨å°±æ˜¯Setå€¼ï¼\n\n2. æ¶ˆæ¯åè®®äºŒ ï¼ˆæ—§ç¼–ç ï¼Œéä¸¥æ ¼æ¨¡å¼ï¼‰\nè¿™ä¸ªå‡å¦‚å®¢æˆ·ç«¯/serverç«¯å¼€å¯äº†ä¸¥æ ¼æ¨¡å¼ï¼Œåˆ™ä¸èƒ½å…¼å®¹æ¬¡åè®®\n\nBinary protocol Message, old encoding, 9+ bytes:+--------+--------+--------+--------+--------+...+--------+--------+--------+--------+--------+--------+| name length                       | name                |00000mmm| seq id                            |+--------+--------+--------+--------+--------+...+--------+--------+--------+--------+--------+--------+\n\n\nname length(å››å­—èŠ‚): è¿™é‡Œä¸ºäº†å…¼å®¹ä¸Šé¢åè®®ä¸€ï¼Œæ‰€ä»¥é«˜ä½ç¬¬ä¸€ä¸ªbitå¿…é¡»ä¸º0ï¼ä¹Ÿå°±æ˜¯name lengthå¿…é¡»è¦æœ‰ç¬¦å·çš„æ­£æ•°ï¼\nnameï¼šæ¶ˆæ¯åç§°\nmmm:  æ¶ˆæ¯ç±»å‹ï¼ŒåŒä¸Š\nseq id: æ¶ˆæ¯ID\n\n3. ç±»å‹ç¼–ç åè®®è¿™ä¸ªåè®®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸ªåŸºæœ¬çš„ç¼–ç åè®®ï¼ï¼ï¼å…¶å®å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ tlv ç¼–ç ï¼\n1. structBinary protocol field header and field value:+--------+--------+--------+--------+...+--------+|tttttttt| field id        | field value         |+--------+--------+--------+--------+...+--------+Binary protocol stop field:+--------+|00000000|+--------+\n\n\nttttttttå­—æ®µç±»å‹ï¼Œå¸¦ç¬¦å·çš„ 8 ä½æ•´æ•°ã€‚ä¸€ä¸ªå­—èŠ‚ï¼\nfield idfield-idï¼Œä¸€ä¸ªå¤§ç«¯åºçš„æœ‰ç¬¦å· 16 ä½æ•´æ•°ã€‚ä¸¤ä¸ªå­—èŠ‚ï¼\nfield-valueç¼–ç çš„å­—æ®µå€¼ï¼\n\n# å­—æ®µç±»å‹BOOL, encoded as 2I8, encoded as 3DOUBLE, encoded as 4I16, encoded as 6I32, encoded as 8I64, encoded as 10BINARY, used for binary and string fields, encoded as 11STRUCT, used for structs and union fields, encoded as 12MAP, encoded as 13SET, encoded as 14LIST, encoded as 15\n\n2. list / setBinary protocol list (5+ bytes) and elements:+--------+--------+--------+--------+--------+--------+...+--------+|tttttttt| size                              | elements            |+--------+--------+--------+--------+--------+--------+...+--------+\n\n\nttttttttè¡¨ç¤ºå…ƒç´ ç±»å‹ï¼Œç¼–ç ä¸º int8\nsize è¡¨ç¤ºå…¨éƒ¨å…ƒç´ ä¸ªæ•°ï¼Œç¼–ç ä¸º int32ï¼Œä»…æ­£å€¼\nelements å…¨éƒ¨å…ƒç´ ï¼Œé¡ºåºæ’åˆ—\n\n3. mapBinary protocol map (6+ bytes) and key value pairs:+--------+--------+--------+--------+--------+--------+--------+...+--------+|kkkkkkkk|vvvvvvvv| size                              | key value pairs     |+--------+--------+--------+--------+--------+--------+--------+...+--------+\n\n\nkkkkkkkkæ˜¯å…³é”®å…ƒç´ ç±»å‹ï¼Œç¼–ç ä¸º int8\nvvvvvvvvæ˜¯å€¼å…ƒç´ ç±»å‹ï¼Œç¼–ç ä¸º int8\nsizeæ˜¯ mapçš„sizeï¼Œç¼–ç ä¸º int32ï¼Œä»…æ­£å€¼\nkey value pairsæ˜¯ç¼–ç çš„é”®å’Œå€¼ï¼Œæ„æ€å°±æ˜¯å…ˆè¯»keyï¼Œå†è¯»valueï¼Œå†è¯»keyï¼Œå†è¯»value\n\n4. string/binaryBinary protocol, binary data, 4+ bytes:+--------+--------+--------+--------+--------+...+--------+| byte length                       | bytes                |+--------+--------+--------+--------+--------+...+--------+\n\n\nbyte lengthæ˜¯å­—èŠ‚æ•°ç»„çš„é•¿åº¦\nbytesæ˜¯å­—èŠ‚æ•°ç»„çš„å­—èŠ‚\n\nstring ç±»å‹å°±æ˜¯utf-8 ç¼–ç ä¸ºå­—èŠ‚æµï¼Œç„¶åä¼ è¾“çš„æ—¶å€™ç”¨ binary ç±»å‹å³å¯ï¼ \n5. å…¶ä»–ç±»å‹åŸºæœ¬ç±»å‹å°±æ˜¯å ç”¨å›ºå®šå­—èŠ‚ï¼æ¯”å¦‚booleanä¸€ä¸ªå­—èŠ‚ï¼Œi64æ˜¯8ä¸ªå­—èŠ‚ä¹‹ç±»çš„ï¼ï¼ æšä¸¾ç­‰åŒäºi32ï¼\n2. TCompactProtocol ï¼ˆæ”¹è¿›åè®®ï¼Œå’ŒPBåŸºæœ¬ç±»ä¼¼ï¼ï¼‰åå­—æ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯ç”¨æ¥å‹ç¼©çš„ï¼Œå‹ç¼©ç®—æ³•å’Œpbå¾ˆåƒï¼Œå°±æ˜¯ zigzagï¼ˆæ•´æ•°å‹ç¼©ç®—æ³•ï¼‰+ varint ç®—æ³•, è¿™ä¿©ä¸œè¥¿å¯ä»¥çœ‹æˆ‘è®²çš„PBåè®®çš„æ–‡ç«   ï¼Œä¸è¿‡ä¹Ÿåšäº†å¾ˆå¤šå–å·§çš„åœ°æ–¹ï¼Œä¸‹é¢å†…å®¹åŸºæœ¬æ¥è‡ªå®˜æ–¹æ–‡æ¡£: thrift-compact-protocol\n1. æ¶ˆæ¯åè®®Compact protocol Message (4+ bytes):+--------+--------+--------+...+--------+--------+...+--------+--------+...+--------+|pppppppp|mmmvvvvv| seq id              | name length         | name                |+--------+--------+--------+...+--------+--------+...+--------+--------+...+--------+\n\nè¿™ä¸ªåè®®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ›´ç´§å‡‘\n\nç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š åè®®IDï¼ŒTCompactProtocol IDä¸º 130ï¼ŒäºŒè¿›åˆ¶ç¼–ç ä¸º 10000010\nç¬¬äºŒä¸ªå­—èŠ‚:  version + typeï¼Œ å…¶ä¸­versionæ˜¯ä½5bitï¼Œtypeæ˜¯é«˜3bit ï¼Œ å…¶ä¸­ COMPACT_VERSION = 1\nseq id 4å­—èŠ‚ï¼Œvar int ç¼–ç \nname len ä¸º4å­—èŠ‚ï¼Œä¹Ÿæ˜¯var int ç¼–ç \nname: æ¶ˆæ¯åç§°\n\n// æ¶ˆæ¯ç±»å‹Call: 1Reply: 2Exception: 3Oneway: 4\n\n2. ç±»å‹ç¼–ç åè®®1. structCompact protocol field header (short form) and field value:+--------+--------+...+--------+|ddddtttt| field value         |+--------+--------+...+--------+Compact protocol field header (1 to 3 bytes, long form) and field value:+--------+--------+...+--------+--------+...+--------+|0000tttt| field id            | field value         |+--------+--------+...+--------+--------+...+--------+Compact protocol stop field:+--------+|00000000|+--------+\n\n\nddddæ˜¯å­—æ®µ  deltaï¼Œä¸€ä¸ªæ— ç¬¦å·çš„ 4 ä½æ•´æ•°ï¼Œä¸¥æ ¼æ­£æ•°ã€‚\nttttæ˜¯å­—æ®µç±»å‹ idï¼Œä¸€ä¸ªæ— ç¬¦å·çš„ 4 ä½æ•´æ•°ã€‚\nfield idå­—æ®µ idï¼Œä¸€ä¸ªæœ‰ç¬¦å·çš„ 16 ä½æ•´æ•°ï¼Œç¼–ç ä¸º zigzag intï¼\nfield-valueç¼–ç çš„å­—æ®µå€¼ã€‚\n\n# å­—æ®µçš„ç±»å‹ï¼Œå…¶ä¸­ä¸‹é¢çš„ map/list ç±»å‹ï¼Œä¹Ÿå¾ˆç®€å•å°±æ˜¯å¯ä»¥æŠŠBOOLEAN_FALSEå½“ä½œBOOLç±»å‹å³å¯ï¼Œå°±ä¸é‡å¤å†™äº†ï¼BOOLEAN_TRUE, encoded as 1BOOLEAN_FALSE, encoded as 2I8, encoded as 3I16, encoded as 4I32, encoded as 5I64, encoded as 6DOUBLE, encoded as 7BINARY, used for binary and string fields, encoded as 8LIST, encoded as 9SET, encoded as 10MAP, encoded as 11STRUCT, used for both structs and union fields, encoded as 12\n\nè¿™é‡Œæ¯”è¾ƒç‰¹æ®Šçš„å°±æ˜¯ï¼šboolç±»å‹æ˜¯ä¸å ç”¨field value å­—èŠ‚çš„ï¼Œå…¶æ¬¡å°±æ˜¯æœ‰ä¸¤ç§ç¼–ç åè®®ï¼Œå®ƒçš„åŸç†ç¡®å®æ¯”pb è¿˜è¦å–å·§ï¼Œå“ˆå“ˆå“ˆï¼\né¦–å…ˆæˆ‘ä»¬åœ¨ç¼–ç çš„æ—¶å€™ï¼Œfield_id ä¸€èˆ¬éƒ½æ˜¯é¡ºåºè‡ªå¢çš„ï¼ä¹Ÿå°±æ˜¯åŸºæœ¬ä¸Šæ˜¯1,2,3â€¦n , è¿™æ—¶å€™ç”±äºtypeå ç”¨4bitï¼Œæ­¤æ—¶å¯ä»¥ç”¨å‰©ä½™çš„4bitå­˜å‚¨field_idçš„å¢é‡å³å¯ï¼è¿™é‡Œå¢é‡å¤„ç†è¯´å®è¯æ¯”PBç¼–ç è¿˜è¦å·§å¦™!\n// start last_field_id=0// write fieldif field_id &gt; last_field_id &amp; field_id-last_field_id&lt;=15 &#123;   // use delta&#125;else&#123;   // use normal&#125;last_field_id=field_id\n\nä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸€ä¸ªç»“æ„ä½“å®šä¹‰çš„field_idä¸º1,2,3,4,5,30,31,32\n+--------+--------+--------+--------+|0000tttt| field id| field value     |+--------+--------+--------+--------+0000tttt, 1     # 1 (æ‡’å¾—ç”¨äºŒè¿›åˆ¶ç¼–ç è¡¨ç¤ºäº†)0001tttt,       # 2 (è¿™é‡Œç”¨0001æ˜¯å› ä¸ºå­—æ®µIDå¢é‡æ˜¯1)0001tttt,       # 30001tttt,       # 40001tttt,       # 50000tttt, 30    # 30(è¿™é‡Œé‡åˆ¶æ˜¯å› ä¸º30-5&gt;15äº†,æ‰€ä»¥é‡ç½®äº†)0001tttt,       # 310001tttt,       # 32\n\nè¿™é‡Œè¿˜æœ‰ä¸ªç»†èŠ‚ç‚¹å°±æ˜¯ bool ç±»å‹ï¼bool ç±»å‹æ˜¯ä¸å ç”¨ field_value çš„ï¼\n2. list/setCompact protocol list header (1 byte, short form) and elements:+--------+--------+...+--------+|sssstttt| elements            |+--------+--------+...+--------+Compact protocol list header (2+ bytes, long form) and elements:+--------+--------+...+--------+--------+...+--------+|1111tttt| size                | elements            |+--------+--------+...+--------+--------+...+--------+\n\n\nssssæ˜¯å¤§å°ï¼Œ4 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå€¼0-14\nttttæ˜¯å…ƒç´ ç±»å‹ï¼Œä¸€ä¸ª 4 ä½æ— ç¬¦å·æ•´æ•°\nsizeæ˜¯å¤§å°ï¼Œvar int (int32)ï¼Œæ­£å€¼15æˆ–æ›´é«˜\nelementsæ˜¯ç¼–ç å…ƒç´ \n\nè¿™ä¸ªå…¶å®æˆ‘å°±ä¸ç”¨è¯´äº†ï¼Œå‡å¦‚size&lt;=15çš„è¯é‚£ä¹ˆå¯ä»¥ä½¿ç”¨ç¬¬ä¸€ç§äº†ï¼\n3. mapCompact protocol map header (1 byte, empty map):+--------+|00000000|+--------+Compact protocol map header (2+ bytes, non empty map) and key value pairs:+--------+...+--------+--------+--------+...+--------+| size                |kkkkvvvv| key value pairs     |+--------+...+--------+--------+--------+...+--------+\n\n\nsizeæ˜¯å¤§å°ï¼Œä¸€ä¸ª var int (int32)ï¼Œä¸¥æ ¼çš„æ­£å€¼\nkkkkæ˜¯å…³é”®å…ƒç´ ç±»å‹ï¼Œä¸€ä¸ª 4 ä½æ— ç¬¦å·æ•´æ•°\nvvvvæ˜¯å€¼å…ƒç´ ç±»å‹ï¼Œä¸€ä¸ª 4 ä½æ— ç¬¦å·æ•´æ•°\nkey value pairsæ˜¯ç¼–ç çš„é”®å’Œå€¼\n\nå…¶å®è¿™ä¸ªæ›´ä¸ç”¨è¯´äº†ï¼Œå°±æ˜¯å½“sizeç­‰äº0æ—¶ï¼Œå°±å†™å…¥ç¬¬ä¸€ç§åè®®ï¼\n4. binaryã€stringBinary protocol, binary data, 1+ bytes:+--------+...+--------+--------+...+--------+| byte length         | bytes               |+--------+...+--------+--------+...+--------+\n\n\nbyte length é‡‡ç”¨varintï¼Œ å››å­—èŠ‚ç¼–ç \nbytes body\n\nstringç±»å‹ä¼ è¾“çš„æ—¶å€™æ˜¯utf8ç¼–ç çš„binaryç±»å‹ï¼\n5. å…¶ä»–ç±»å‹å ç”¨å›ºå®šå­—èŠ‚ï¼Œé‡‡ç”¨varintç¼–ç \næ¶ˆæ¯ï¼ˆä¼ è¾“ï¼‰åè®®å…¶å®ä¸Šé¢éƒ¨åˆ†è®²åˆ°çš„æ¶ˆæ¯åè®®å·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„åè®®ï¼Œä½ ç›´æ¥åŸºäºtcpæµå‘é€è¯·æ±‚å“åº”åè®®å³å¯ï¼ä½†æ˜¯ä¸ºå•¥è¿™å—è¿˜è·‘å‡ºä¸ªä¼ è¾“åè®®ï¼å¯¹çš„ä¸Šé¢åè®®å…¶å®æ˜¯æœ‰å±€é™æ€§çš„ï¼å› æ­¤ä¸‹åˆ—åˆ—å‡ºäº†å‡ ä¸ªä¼ è¾“åè®®ï¼ä¸‹é¢è¿™å—å†…å®¹åŸºæœ¬æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£: rpc åè®®ä»‹ç»\nFramed åè®® &amp; Bufferd(Unframed) åè®® ï¼ˆä¼ ç»ŸRPCåè®®ï¼‰Bufferdåè®®å°±æ˜¯æˆ‘ä»¬éœ€è¦ä¸æ–­çš„è¯»å–socketï¼Œç„¶åè¿›è¡Œåè®®æ‹†è§£ï¼\nç°åœ¨é—®é¢˜å°±æ˜¯å¼‚æ­¥æ¯”è¾ƒæµè¡Œï¼Œæ‰€ä»¥éœ€è¦å†å‘é€æ•°æ®çš„æ—¶å€™é‡‡ç”¨Framedç¼–ç ï¼Œå…ˆå†™sizeï¼Œå†å†™payloadï¼å½“serverç«¯å¤„ç†çš„æ—¶å€™å¯ä»¥æ ¹æ®frame_sizeæ¥è·å–payloadï¼Œç„¶åäº¤ç»™ processså¤„ç†ï¼å®˜æ–¹çš„è§£é‡Šæ˜¯ä¸ºäº†æ”¯æŒ async ç¼–ç¨‹ï¼å…¶å®æˆ‘è§‰å¾—å°±æ˜¯ä¸ºäº†æ›´åŠ é«˜æ•ˆç½¢äº†ï¼Œä¸éœ€è¦æŠŠæ•´ä¸ªåŒ…è§£æå‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯ä¼ è¾“å±‚å¯ä»¥èŠ‚çœå¾ˆå¤šæ€§èƒ½å¼€é”€ï¼\n\nå…¶å®è¿™ä¸ªåè®®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå°±æ˜¯å‡å¦‚æ¶ˆæ¯ä½“è¿‡å¤§çš„è¯ï¼é‚£ä¹ˆå†…å­˜å¼€é”€å°±æ¯”è¾ƒå¤§ï¼Œå› ä¸ºéœ€è¦å…ˆå†™åˆ°å†…å­˜é‡Œï¼Œç„¶åå†å¤´éƒ¨åŠ å››ä¸ªå­—èŠ‚ï¼\nTHeader åè®®éšç€æŠ€æœ¯/éœ€æ±‚/ä¸šåŠ¡ä¸æ–­å‘å±•ï¼Œä¼ ç»Ÿçš„æ¶æ„ä¸èƒ½æ»¡è¶³ä¸šåŠ¡å¿«é€Ÿå‘å±•ï¼Œæ™®é€šçš„ä¼ è¾“åè®®ä¸æ»¡è¶³äºç°çŠ¶ï¼Œå› æ­¤å½“å‡ºç°service meshçš„æ–°ä¸€ä»£å¾®æœåŠ¡æ¶æ„çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡Meshå»åšæµé‡æ²»ç†ï¼ˆè€Œä¸æ˜¯æ¡†æ¶ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åè®®é‡Œæ³¨å…¥ä¸€äº›æœåŠ¡ä¿¡æ¯è¿›è¡Œæµé‡æ²»ç†ç­‰ç­‰ï¼Œå› æ­¤åæ¥Facebookæ¨å‡ºäº†THeaderProtocolã€‚å…¶å®åŸæ¥çš„è€åè®®ä¹Ÿèƒ½åšï¼Œé‚£å°±æ˜¯å¯ä»¥åœ¨ messageä¸­å®šä¹‰ä¸€äº› å…¬å…±å­—æ®µæ¥æ³¨å…¥æµé‡ä¿¡æ¯ï¼Œä½†æ˜¯å­˜åœ¨é—®é¢˜å°±æ˜¯éœ€è¦æŠŠæ•´ä¸ªåŒ…è§£å‡ºæ¥ï¼Œæµªè´¹æ€§èƒ½ï¼Œè€Œä¸”æ¯”è¾ƒéº»çƒ¦ï¼æ³¨æ„è¿™é‡Œè®²åˆ°çš„THeaderProtocolæ˜¯æœ‰åŒºåˆ«äºå­—èŠ‚å†…éƒ¨çš„TTHeader åè®®çš„ä»¥åŠMeshåè®®ç­‰ï¼\nåè®®å¦‚ä¸‹: \n  0 1 2 3 4 5 6 7 8 9 a b c d e f 0 1 2 3 4 5 6 7 8 9 a b c d e f+----------------------------------------------------------------+| 0|                          LENGTH                             |+----------------------------------------------------------------+| 0|       HEADER MAGIC          |            FLAGS              |+----------------------------------------------------------------+|                         SEQUENCE NUMBER                        |+----------------------------------------------------------------+| 0|     Header Size(/32)        | ...+---------------------------------                  Header is of variable size:                   (and starts at offset 14)+----------------------------------------------------------------+|         PROTOCOL ID  (varint)  |   NUM TRANSFORMS (varint)     |+----------------------------------------------------------------+|      TRANSFORM 0 ID (varint)   |        TRANSFORM 0 DATA ...+----------------------------------------------------------------+|         ...                              ...                   |+----------------------------------------------------------------+|        INFO 0 ID (varint)      |       INFO 0  DATA ...+----------------------------------------------------------------+|         ...                              ...                   |+----------------------------------------------------------------+|                                                                ||                              PAYLOAD                           ||                                                                |+----------------------------------------------------------------+\n\nå…·ä½“ç»†èŠ‚æˆ‘å°±ä¸è®²äº†ï¼Œå…¶å®å°±æ˜¯å¯ä»¥æºå¸¦ä¸€äº›headerä¿¡æ¯ï¼Œåœ¨ä¼ è¾“çš„æ—¶å€™å¯ä»¥æºå¸¦ä¸Šï¼Œç„¶åå¤´éƒ¨æœ‰å¤´éƒ¨ç¼–ç çš„åè®®ï¼\nheaderä¿¡æ¯å¯ä»¥åšäº›ä»€ä¹ˆå‘¢ï¼Œå®ƒåŒ…å«ä¸€äº› traceã€aclã€envã€æœåŠ¡ä¼˜å…ˆçº§ä¹‹ç±»çš„ï¼\nå…¶æ¬¡å°±æ˜¯meshå…¶å®åªéœ€è¦å…³æ³¨äºè¿™äº›ä¿¡æ¯ï¼Œpayloadéƒ¨åˆ†å®ƒä¸å…³å¿ƒï¼Œæ‰€ä»¥ä»–ä¸éœ€è¦è§£pyload éƒ¨åˆ†ï¼\nå¦‚ä½•è§£ç ä¸Šé¢ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬å‘ç°Thrift ç¼–ç åè®®+ä¼ è¾“åè®®æœ‰å¾ˆå¤šï¼Œé‚£ä¹ˆé—®é¢˜æ˜¯æˆ‘ä¸€ä¸ªclient/serveréœ€è¦å…¨éƒ¨æ”¯æŒï¼Œæ€ä¹ˆè§£ç å‘¢ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¥äº†å¦‚ä½•è§£ç æ˜¯éº»çƒ¦äº‹ï¼Ÿ è¿™é‡Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹æˆ‘çš„å¤§ä½“å®ç°é€»è¾‘ï¼ä»…ä¾›å‚è€ƒï¼šæºç \n// buffered readertype reader interface &#123;   io.Reader   Peek(int) ([]byte, error)&#125;// Unframed: Bufferedåè®®// Framed: Framedåè®®// Header: å¼€æºçš„THeaderåè®®// TTHeader: å­—èŠ‚çš„TTHeaderåè®®// MeshHeader: å­—èŠ‚çš„MeshHeaderåè®®func GetProtocol(ctx context.Context, reader reader) (Protocol, error) &#123;   if IsUnframedHeader(reader, 0) &#123;      return UnframedHeader, nil   &#125;   if IsUnframedHeader(reader, FrameHeaderSize) &#123;      return FramedHeader, nil   &#125;   if IsUnframedBinary(reader, 0) &#123;      return UnframedBinary, nil   &#125;   if IsUnframedBinary(reader, FrameHeaderSize) &#123;      return FramedBinary, nil   &#125;   if IsUnframedUnStrictBinary(reader, 0) &#123;      return UnframedUnStrictBinary, nil   &#125;   if IsUnframedUnStrictBinary(reader, FrameHeaderSize) &#123;      return FramedUnStrictBinary, nil   &#125;   if IsUnframedCompact(reader, 0) &#123;      return UnframedCompact, nil   &#125;   if IsUnframedCompact(reader, FrameHeaderSize) &#123;      return FramedCompact, nil   &#125;   if kitex.IsTTHeader(reader) &#123;      meatInfo := GetMateInfo(ctx)      size, err := kitex.ReadTTHeader(reader, meatInfo)      if err != nil &#123;         return UnknownProto, err      &#125;      if IsUnframedBinary(reader, size) &#123;         _ = commons.SkipReader(reader, size)         return UnframedBinaryTTHeader, nil      &#125;      if IsFramedBinary(reader, size) &#123;         _ = commons.SkipReader(reader, size)         return FramedBinaryTTHeader, nil      &#125;   &#125;   if kitex.IsMeshHeader(reader) &#123;      meatInfo := GetMateInfo(ctx)      size, err := kitex.ReadMeshHeader(reader, meatInfo)      if err != nil &#123;         return UnknownProto, err      &#125;      if IsUnframedBinary(reader, size) &#123;         _ = commons.SkipReader(reader, size)         return UnframedBinaryMeshHeader, nil      &#125;      if IsFramedBinary(reader, size) &#123;         _ = commons.SkipReader(reader, size)         return FramedBinaryMeshHeader, nil      &#125;   &#125;   return UnknownProto, thrift.NewTProtocolExceptionWithType(      thrift.UNKNOWN_PROTOCOL_EXCEPTION,      errors.New(&quot;unknown protocol&quot;),   )&#125;\n\n\nå‚è€ƒ\nthrift doc \ngo thrift\nthrift\npb åè®®è®²è§£\n\n","categories":["RPC"],"tags":["Thrift","GRPC","API"]},{"title":"Golangçš„GCçš„å›æ”¶","url":"/2021/04/01/3a1ab3f1f398e2c69489c00767a5a560/","content":"â€‹    Golang Gcç›¸å…³ï¼\n\n\nç¨‹åºå¯åŠ¨\nâ€‹    Goç¨‹åºå¯åŠ¨ï¼Œé¦–å…ˆç»å¯¹æ˜¯åˆå§‹åŒ–ä¸€å †èµ„æºï¼Œå…³äºå¦‚ä½•å¯åŠ¨éœ€è¦çœ‹Goçš„è½¬æ±‡ç¼–ä»£ç äº† ï¼\n\n// The bootstrap sequence is:////\tcall osinit//\tcall schedinit//\tmake &amp; queue new G//\tcall runtimeÂ·mstart//// The new G calls runtimeÂ·main.func schedinit() &#123;\t// raceinit must be the first call to race detector.\t// In particular, it must be done before mallocinit below calls racemapshadow.//...\tgcinit()//...&#125;\n\né¦–å…ˆåœ¨ä¸€ä¸ªGoç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨ https://golang.org/src/runtime/proc.go ï¼Œå¤§è‡´å¯åŠ¨é€»è¾‘å°±å’Œè¿™ä¸ªæ³¨é‡Šä¸Šä¸€æ ·ï¼Œä¼šå…ˆå¯åŠ¨osï¼Œç„¶åschedleï¼Œç„¶åå†å¯åŠ¨\ngcåˆå§‹åŒ–func gcinit() &#123;\tif unsafe.Sizeof(workbuf&#123;&#125;) != _WorkbufSize &#123;\t\tthrow(&quot;size of Workbuf is suboptimal&quot;)\t&#125;\t// No sweep on the first cycle.\tmheap_.sweepdone = 1\t// Set a reasonable initial GC trigger. æ ¸å¿ƒå…³æ³¨ä¸è¿™ä¸ªï¼å°±æ˜¯è§¦å‘GCå›æ”¶çš„é˜ˆå€¼ï¼Œé»˜è®¤æ˜¯0.875\tmemstats.triggerRatio = 7 / 8.0\t// Fake a heap_marked value so it looks like a trigger at\t// heapminimum is the appropriate growth from heap_marked.\t// This will go into computing the initial GC goal.\tmemstats.heap_marked = uint64(float64(heapminimum) / (1 + memstats.triggerRatio))\t// Set gcpercent from the environment. This will also compute\t// and set the GC trigger and goal.\t_ = setGCPercent(readgogc())\twork.startSema = 1\twork.markDoneSema = 1&#125;\n\n1ã€triggerRatio Set a reasonable initial GC trigger. æ ¸å¿ƒå…³æ³¨ä¸è¿™ä¸ªï¼å°±æ˜¯è§¦å‘GCå›æ”¶çš„é˜ˆå€¼ï¼Œé»˜è®¤æ˜¯0.875ï¼Œå«ä¹‰æ˜¯è¿™æ¬¡å †ä¸­å­˜æ´»çš„å¯¹è±¡æ˜¯ä¸Šä¸€æ¬¡çš„ 1+(7/0.8)å€¼è¦å¤§çš„æ—¶å€™å°±å›æ”¶\nå‡å¦‚ä¸Šæ¬¡å®Œæˆåå †å†…å­˜æ˜¯ 100M ç°åœ¨æ˜¯ 200Mï¼Œæ­¤æ—¶ (200M-100M)/100M&gt;7/0.8çš„ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå›æ”¶ï¼\nå…·ä½“è¿™ä¸ªå€¼å¯ä»¥æ ¹æ®GOGC/100  è¿›è¡Œè®¾ç½®ï¼Œæ ¹æ®å…·ä½“ä¸šåŠ¡æ¥ï¼ŒGOGC = off å°†å®Œå…¨ç¦ç”¨åƒåœ¾æ”¶é›†\n2ã€heapminimumheapminimumæ˜¯è§¦å‘GCçš„æœ€å°å †å¤§å°ã€‚ \nåœ¨åˆå§‹åŒ–æœŸé—´ï¼Œæ­¤è®¾ç½®ä¸º4MB * GOGC / 100\nGCæ‰§è¡Œåˆ†ç±»gogc æ‰§è¡Œä¼šåˆ†é…ä¸‹é¢å¤§è‡´å‡ ç±» \n\ngcTriggerHeap\ngcTriggerTime\ngcTriggerCycle\n\n\nfunc (t gcTrigger) test() bool &#123;\tif !memstats.enablegc || panicking != 0 || gcphase != _GCoff &#123;\t\treturn false\t&#125;\tswitch t.kind &#123;\tcase gcTriggerHeap:\t\t// Non-atomic access to heap_live for performance. If\t\t// we are going to trigger on this, this thread just\t\t// atomically wrote heap_live anyway and we&#x27;ll see our\t\t// own write.    return memstats.heap_live &gt;= memstats.gc_trigger // heapä¸­å­˜æ´»çš„å¯¹è±¡å¤§äºgcéœ€è¦è§¦å‘çš„é˜ˆå€¼(è¿™ä¸ªé˜ˆå€¼æ—¶ä¸Šä¸€æ¬¡gcè®¾ç½®çš„)\tcase gcTriggerTime:\t\tif gcpercent &lt; 0 &#123;\t\t\treturn false\t\t&#125;\t\tlastgc := int64(atomic.Load64(&amp;memstats.last_gc_nanotime))\t\treturn lastgc != 0 &amp;&amp; t.now-lastgc &gt; forcegcperiod // å½“å‰æ—¶é—´ä¸ä¸Šæ¬¡gcæ—¶é—´ç›¸å·®2åˆ†é’Ÿ\tcase gcTriggerCycle:\t\t// t.n &gt; work.cycles, but accounting for wraparound.\t\treturn int32(t.n-work.cycles) &gt; 0\t&#125;\treturn true&#125;\n\n1ã€å‘¨æœŸæ€§GCfunc forcegchelper() &#123;\tforcegc.g = getg()\tfor &#123;\t\tlock(&amp;forcegc.lock)\t\tif forcegc.idle != 0 &#123;\t\t\tthrow(&quot;forcegc: phase error&quot;)\t\t&#125;\t\tatomic.Store(&amp;forcegc.idle, 1)\t\tgoparkunlock(&amp;forcegc.lock, waitReasonForceGGIdle, traceEvGoBlock, 1)\t\t// this goroutine is explicitly resumed by sysmon\t\tif debug.gctrace &gt; 0 &#123;\t\t\tprintln(&quot;GC forced&quot;)\t\t&#125;\t\t// Time-triggered, fully concurrent.\t\tgcStart(gcTrigger&#123;kind: gcTriggerTime, now: nanotime()&#125;)\t&#125;&#125;\n\nå¯ä»¥çœ‹åˆ°å½“è°ƒç”¨çš„æ—¶å€™è‡ªå·±ç»™è‡ªå·±åŠ äº†æŠŠé”ï¼Œç„¶åæŠŠè‡ªå·±æŒ‚èµ·ç­‰å¾…åˆ«äººå”¤é†’å»æ‰§è¡Œgcï¼Œç„¶åçœ‹ä¸€ä¸‹ sysmonå‡½æ•°,è¿™ä¸ªå€¼ä¸€èˆ¬ä¸ä¼šæ”¹å˜ï¼\n// forcegcperiod is the maximum time in nanoseconds between garbage// collections. If we go this long without a garbage collection, one// is forced to run.//// This is a variable for testing purposes. It normally doesn&#x27;t change.var forcegcperiod int64 = 2 * 60 * 1e9// Always runs without a P, so write barriers are not allowed.////go:nowritebarrierrecfunc sysmon() &#123;  // ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\t\t// check if we need to force a GC  // è¦æ±‚ç¬¬ä¸€ç¬¦åˆgcå‘¨æœŸï¼Œç¬¬äºŒ forcegc.idle ä¸ä¸º0\t\tif t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != 0 &#123;\t\t\tlock(&amp;forcegc.lock)\t\t\tforcegc.idle = 0\t\t\tvar list gList\t\t\tlist.push(forcegc.g)\t\t\tinjectglist(&amp;list)\t\t\tunlock(&amp;forcegc.lock)\t\t&#125;  ////ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&#125;\n\n2ã€malloc gc// Allocate an object of size bytes.// Small objects are allocated from the per-P cache&#x27;s free lists.// Large objects (&gt; 32 kB) are allocated straight from the heap.func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer &#123;\t// ........  // æ˜¯å¦éœ€è¦gc\tshouldhelpgc := false\tif size &lt;= maxSmallSize &#123; // å°äº32k\t\tif noscan &amp;&amp; size &lt; maxTinySize &#123; //å°äº16å­—èŠ‚\t\t&#125; else &#123;\t\t&#125; else &#123;\t\tvar s *mspan\t\tshouldhelpgc = true\t\tsystemstack(func() &#123;\t\t\ts = largeAlloc(size, needzero, noscan)\t\t&#125;)\t\ts.freeindex = 1\t\ts.allocCount = 1\t\tx = unsafe.Pointer(s.base())\t\tsize = s.elemsize\t&#125;\t// ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\tif shouldhelpgc &#123;\t\tif t := (gcTrigger&#123;kind: gcTriggerHeap&#125;); t.test() &#123;\t\t\tgcStart(t)\t\t&#125;\t&#125;\treturn x&#125;\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°éœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œgcï¼Œå¤§è‡´å¦‚æœåˆ†é…å¤§äº32kçš„å¯¹è±¡æ—¶éƒ½ä¼šå»checkä¸€ä¸‹gc\n3ã€å¼ºåˆ¶GCè¿™ä¸ªè¡Œä¸ºä¸€èˆ¬ä¸æ¨èç”¨æˆ·è‡ªå·±å»æ‰§è¡Œï¼Œé¦–å…ˆä»–ä¼šå¼ºåˆ¶çš„é˜»å¡ç¨‹åºï¼æ‰€ä»¥ä¸æ¨èï¼Œç¬¬äºŒä¸ªå°±æ˜¯goçš„GCå¹¶ä¸ä¼šå›æ”¶å®é™…åˆ†é…çš„ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥ä¾æ—§æ˜¯ä¾èµ–äºç³»ç»Ÿå»å¼ºåˆ¶å›æ”¶ï¼\n// GC runs a garbage collection and blocks the caller until the// garbage collection is complete. It may also block the entire// program.func GC() &#123;\t// We consider a cycle to be: sweep termination, mark, mark\t// termination, and sweep. This function shouldn&#x27;t return\t// until a full cycle has been completed, from beginning to\t// end. Hence, we always want to finish up the current cycle\t// and start a new one. That means:\t//\t// 1. In sweep termination, mark, or mark termination of cycle\t// N, wait until mark termination N completes and transitions\t// to sweep N.\t//\t// 2. In sweep N, help with sweep N.\t//\t// At this point we can begin a full cycle N+1.\t//\t// 3. Trigger cycle N+1 by starting sweep termination N+1.\t//\t// 4. Wait for mark termination N+1 to complete.\t//\t// 5. Help with sweep N+1 until it&#x27;s done.\t//\t// This all has to be written to deal with the fact that the\t// GC may move ahead on its own. For example, when we block\t// until mark termination N, we may wake up in cycle N+2.\t// Wait until the current sweep termination, mark, and mark\t// termination complete.\tn := atomic.Load(&amp;work.cycles)\tgcWaitOnMark(n)\t// We&#x27;re now in sweep N or later. Trigger GC cycle N+1, which\t// will first finish sweep N if necessary and then enter sweep\t// termination N+1.\tgcStart(gcTrigger&#123;kind: gcTriggerCycle, n: n + 1&#125;)\t// Wait for mark termination N+1 to complete.\tgcWaitOnMark(n + 1)// .......&#125;\n\nGCæµ‹è¯•1ã€å†…å­˜æ‰©å®¹GCæµ‹è¯•è¿™é‡Œæ¥æµ‹è¯•ä¸€ä¸‹ malloc çš„æ–¹æ³•\npackage mainimport (\t&quot;fmt&quot;\t&quot;time&quot;)var (\tappender = make([][]byte, 0, 100))// GODEBUG=gctrace=1func main() &#123;\tticker := time.NewTicker(time.Second * 1)\tcount := 0\talloc := 4 &lt;&lt; 20\tfor &#123;\t\t&lt;-ticker.C\t\tappender = append(appender, make([]byte, alloc))\t\tcount++\t\tfmt.Printf(&quot;ç¬¬%dæ¬¡åˆ†é…ç©ºé—´: %dm\\n&quot;, count, alloc&gt;&gt;20)\t&#125;&#125;\n\n1ã€æ‰§è¡Œï¼Œé…ç½® GOGC=100 GODEBUG=gctrace=1ï¼Œ æ›´å¤šå…³äºGODEBUGçš„é…ç½®æ˜¯ https://golang.org/src/runtime/extern.go\nâœ  gc git:(master) âœ— GOGC=100 GODEBUG=gctrace=1 bin/appç¬¬1æ¬¡åˆ†é…ç©ºé—´: 4mgc 1 @1.001s 0%: 0.010+0.19+0.023 ms clock, 0.12+0.11/0.060/0.11+0.28 ms cpu, 4-&gt;4-&gt;4 MB, 5 MB goal, 12 Pç¬¬2æ¬¡åˆ†é…ç©ºé—´: 4mgc 2 @2.003s 0%: 0.003+0.082+0.024 ms clock, 0.040+0.060/0.019/0.059+0.29 ms cpu, 8-&gt;8-&gt;8 MB, 9 MB goal, 12 Pç¬¬3æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬4æ¬¡åˆ†é…ç©ºé—´: 4mgc 3 @4.005s 0%: 0.021+0.20+0.009 ms clock, 0.25+0.10/0.099/0.12+0.11 ms cpu, 16-&gt;16-&gt;16 MB, 17 MB goal, 12 Pç¬¬5æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬6æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬7æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬8æ¬¡åˆ†é…ç©ºé—´: 4mgc 4 @8.005s 0%: 0.005+0.19+0.008 ms clock, 0.061+0.10/0.074/0.086+0.10 ms cpu, 32-&gt;32-&gt;32 MB, 33 MB goal, 12 Pç¬¬9æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬10æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬11æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬12æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬13æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬14æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬15æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬16æ¬¡åˆ†é…ç©ºé—´: 4mgc 5 @16.005s 0%: 0.015+0.21+0.011 ms clock, 0.18+0.14/0.062/0.15+0.13 ms cpu, 64-&gt;64-&gt;64 MB, 65 MB goal, 12 P\n\n2ã€è¿™é‡Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡åˆ†é…å°±è¿›è¡Œäº†GCï¼Œå®Œå…¨ç¬¦åˆé»˜è®¤çš„è®¾ç½®ï¼Œå½“å†…å­˜ç¬¬äºŒæ¬¡åˆ†é…çš„æ—¶å€™ï¼Œç”±äº8/4&gt;1è¿›è¡Œäº†gcï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡è§¦å‘çš„é˜ˆå€¼å°±ä¼šæ˜¯ 16ï¼Œå‡å¦‚æˆ‘ä»¬å°† GOGC=50ï¼Œç»§ç»­æ‰§è¡Œ\nâœ  gc git:(master) âœ— GOGC=50 GODEBUG=gctrace=1 bin/appgc ç¬¬1æ¬¡åˆ†é…ç©ºé—´: 4m1 @1.000s 0%: 0.011+0.18+0.016 ms clock, 0.13+0.10/0.024/0.16+0.19 ms cpu, 4-&gt;4-&gt;4 MB, 5 MB goal, 12 Pç¬¬2æ¬¡åˆ†é…ç©ºé—´: 4mgc 2 @2.002s 0%: 0.006+0.27+0.010 ms clock, 0.078+0.12/0.12/0.12+0.12 ms cpu, 8-&gt;8-&gt;8 MB, 9 MB goal, 12 Pç¬¬3æ¬¡åˆ†é…ç©ºé—´: 4mgc 3 @3.001s 0%: 0.006+0.21+0.010 ms clock, 0.083+0.10/0.12/0.11+0.12 ms cpu, 12-&gt;12-&gt;12 MB, 13 MB goal, 12 Pç¬¬4æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬5æ¬¡åˆ†é…ç©ºé—´: 4mgc 4 @5.005s 0%: 0.006+0.24+0.012 ms clock, 0.080+0.10/0.055/0.22+0.14 ms cpu, 20-&gt;20-&gt;20 MB, 21 MB goal, 12 P\n\nå¯ä»¥çœ‹åˆ°ç¬¬3æ¬¡gcçš„å†…å­˜æ˜¯12mï¼ŒåŸå› æ˜¯ä¸Šæ¬¡gcåå †å†…å­˜ä¸º8m,é‚£ä¹ˆä¸‹ä¸€æ¬¡å°±æ˜¯ 8m*1.5=12mï¼Œæ‰€ä»¥å®Œå…¨ç¬¦åˆï¼\n3ã€å‡å¦‚å…³é—­åƒåœ¾å›æ”¶\nâœ  gc git:(master) âœ— GOGC=off GODEBUG=gctrace=1 bin/appç¬¬1æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬2æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬3æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬4æ¬¡åˆ†é…ç©ºé—´: 4mç¬¬5æ¬¡åˆ†é…ç©ºé—´: 4m\n\nå…³äºgcæ—¥å¿—å­¦ä¹ gctrace: setting gctrace=1 causes the garbage collector to emit a single line to standarderror at each collection, summarizing the amount of memory collected and thelength of the pause. The format of this line is subject to change.Currently, it is:  gc # @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #-&gt;#-&gt;# MB, # MB goal, # Pwhere the fields are as follows:  gc #        the GC number, incremented at each GC  @#s         time in seconds since program startï¼Œè·ç¦»ç¨‹åºçš„å¯åŠ¨æ—¶é—´ï¼Œå•ä½s  #%          percentage of time spent in GC since program startï¼ŒèŠ±è´¹æ—¶é—´çš„ç™¾åˆ†æ¯”  #+...+#     wall-clock/CPU times for the phases of the GCï¼Œ cpuèŠ±è´¹çš„æ—¶é—´  #-&gt;#-&gt;# MB  heap size at GC start, at GC end, and live heapï¼Œgcå¼€å§‹-gcç»“æŸ-å­˜æ´»çš„å¯¹è±¡ ï¼ˆå †å†…å­˜ï¼‰  # MB goal   goal heap size ï¼ˆå…¨å±€å †å†…å­˜å¤§å°ï¼‰  # P         number of processors used pçš„æ•°é‡\n\n2ã€å¼ºåˆ¶gcpackage mainimport (\t&quot;runtime&quot;\t&quot;time&quot;)// GOGC=100 GODEBUG=gctrace=1func main() &#123;\t_ = make([]byte, 0, 3&lt;&lt;20)\truntime.GC()\ttime.Sleep(time.Second * 100)&#125;\n\næ‰§è¡Œ\nâœ  gc git:(master) âœ— GOGC=100 GODEBUG=gctrace=1 bin/appgc 1 @0.000s 2%: 0.003+0.11+0.006 ms clock, 0.037+0/0.089/0.10+0.080 ms cpu, 3-&gt;3-&gt;0 MB, 4 MB goal, 12 P (forced)^C\n\nå¯ä»¥çœ‹åˆ°ç»“æœæ˜¯å †ä¸­æœ€åå­˜æ´»çš„å¯¹è±¡æ˜¯  0Mï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬ç”³æ˜çš„é‚£ä¸ª3må¯¹è±¡è¢«å›æ”¶ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘ç³»ç»Ÿmemå›æ”¶ï¼\n3ã€å‘¨æœŸæ¸…ç†è¿™ä¸ªå…¶å®ä¸å¥½æµ‹è¯•ï¼Œå› ä¸ºé‚£ä¸ªå‘¨æœŸå€¼æ— æ³•åšé…ç½®ï¼\npackage mainimport (\t&quot;time&quot;)// GOGC=100 GODEBUG=gctrace=1func main() &#123;\t_ = make([]byte, 0, 3&lt;&lt;20)\ttime.Sleep(time.Second * 130)&#125;\n\nç­‰å¾…120sçš„åˆ°æ¥ï¼â€¦â€¦â€¦.. ç»“æœæ²¡æœ‰\nè·å–Runtimeä¿¡æ¯\nâ€‹    ä½¿ç”¨prometheus è·å– procä¿¡æ¯ï¼Œå¿…é¡»æ˜¯linux/windowsï¼Œæ‰€ä»¥macä¸èƒ½ä½¿ç”¨\n\n1ã€memä¿¡æ¯package mainimport (\t&quot;fmt&quot;\t&quot;github.com/prometheus/procfs&quot;\t&quot;os&quot;\t&quot;runtime&quot;)// GOGC=100 GODEBUG=gctrace=1func main() &#123;\tmemInfo()\t_ = make([]byte, 0, 3&lt;&lt;20)\tmemInfo()\truntime.GC()\tmemInfo()&#125;func memInfo() &#123;\tstats := runtime.MemStats&#123;&#125;\truntime.ReadMemStats(&amp;stats)\tfmt.Printf(&quot;%+v\\n&quot;, stats)\tprocMem()&#125;func procMem() &#123;\tp, err := procfs.NewProc(os.Getpid())\tif err != nil &#123;\t\tpanic(err)\t&#125;\tprocStat, err := p.Stat()\tif err != nil &#123;\t\tpanic(err)\t&#125;\tprocStat.ResidentMemory() // è¿›ç¨‹æ‰€å ç”¨çš„RES\tprocStat.VirtualMemory()  // è¿›ç¨‹æ‰€å ç”¨çš„VIRT\tfmt.Printf(&quot;res: %dM, virt: %dM\\n&quot;, procStat.ResidentMemory()&gt;&gt;20, procStat.VirtualMemory()&gt;&gt;20)&#125;\n\næ‰§è¡Œä¸Šé¢å‡½æ•°ä»¥ä¸‹ç»“æœ\nâœ  gc git:(master) âœ— GOGC=100 GODEBUG=gctrace=1  bin/app&#123;Alloc:158760 TotalAlloc:158760 Sys:69928960 Lookups:0 Mallocs:173 Frees:3 HeapAlloc:158760 HeapSys:66879488 HeapIdle:66535424 HeapInuse:344064 HeapReleased:66469888 HeapObjects:170 StackInuse:229376 StackSys:229376 MSpanInuse:5168 MSpanSys:16384 MCacheInuse:20832 MCacheSys:32768 BuckHashSys:2203 GCSys:2240512 OtherSys:528229 NextGC:4473924 LastGC:0 PauseTotalNs:0 PauseNs:[0 0...] PauseEnd:[0 0 .....] NumGC:0 NumForcedGC:0 GCCPUFraction:0 EnableGC:true DebugGC:false BySize:[&#123;Size:0 Mallocs:0 Frees:0&#125; &#123;Size:8 Mallocs:5 Frees:0&#125; &#123;Size:16 Mallocs:42 Frees:0&#125; ......]&#125;res: 3M, virt: 211M&#123;Alloc:3328688 TotalAlloc:3328688 Sys:69928960 Lookups:0 Mallocs:406 Frees:111 HeapAlloc:3328688 HeapSys:66879488 HeapIdle:63250432 HeapInuse:3629056 HeapReleased:63250432 HeapObjects:295 StackInuse:229376 StackSys:229376 MSpanInuse:6528 MSpanSys:16384 MCacheInuse:20832 MCacheSys:32768 BuckHashSys:2203 GCSys:2240512 OtherSys:528229 NextGC:4473924 LastGC:0 PauseTotalNs:0 PauseNs:[0 0 ......] PauseEnd:[0 0 .......] NumGC:0 NumForcedGC:0 GCCPUFraction:0 EnableGC:true DebugGC:false BySize:[&#123;Size:0 Mallocs:0 Frees:0&#125; &#123;Size:8 Mallocs:6 Frees:0&#125; &#123;Size:16 Mallocs:151 Frees:0&#125; .....]&#125;res: 3M, virt: 211Mgc 1 @0.002s 0%: 0.006+0.17+0.004 ms clock, 0.075+0/0.098/0.20+0.052 ms cpu, 3-&gt;3-&gt;0 MB, 4 MB goal, 12 P (forced)&#123;Alloc:158248 TotalAlloc:3345520 Sys:70256640 Lookups:0 Mallocs:656 Frees:484 HeapAlloc:158248 HeapSys:66781184 HeapIdle:66,396,160 HeapInuse:385,024 HeapReleased:62,996,480 HeapObjects:172 StackInuse:327680 StackSys:327680 MSpanInuse:7072 MSpanSys:16384 MCacheInuse:20832 MCacheSys:32768 BuckHashSys:2203 GCSys:2312192 OtherSys:784229 NextGC:4194304 LastGC:1617196841921944000 PauseTotalNs:10675 PauseNs:[10675 0 0 ......] PauseEnd:[1617196841921944000 0 0 0......] NumGC:1 NumForcedGC:1 GCCPUFraction:0.007580984200182396 EnableGC:true DebugGC:false BySize:[&#123;Size:0 Mallocs:0 Frees:0&#125; &#123;Size:8 Mallocs:6 Frees:1&#125; ........]&#125;res: 3M, virt: 283M\n\nå¯ä»¥çœ‹åˆ°gcå‰å†…å­˜æ˜¯3mï¼Œgcåå†…å­˜æ˜¯0m\n\nAlloc 158,760-&gt;3,328,688-&gt;158,248 ï¼ˆå’Œ HeapAlloc ä¸€æ ·ï¼‰\nTotalAlloc  158,760-&gt; 3,328,688-&gt; 3,345,520ï¼ˆä¸€å…±åˆ†é…çš„å†…å­˜ï¼‰\nSys 69,928,960-&gt;69,928,960-&gt;70,256,640ï¼ˆç³»ç»Ÿåˆ†é…çš„å†…å­˜ï¼Œå®ƒè¡¨ç¤ºå ç”¨æ“ä½œç³»ç»Ÿçš„å…¨éƒ¨å†…å­˜ï¼ï¼‰\nHeapAlloc  158,760-&gt;3,328,688-&gt;158,248 ï¼ˆå †åˆ†é…çš„å†…å­˜ï¼‰\nHeapSys  66,879,488-&gt;66,879,488-&gt;66,781,184\nHeapIdle  66,535,424-&gt;63,250,432-&gt;66,396,160ï¼ˆæœªè¢«ä½¿ç”¨çš„spanå­—èŠ‚æ ‘ï¼Œå…¶å®å°±æ˜¯æœªè¢«åˆ†é…çš„å †å†…å­˜ï¼Œå½“å†…å­˜è¢«å›æ”¶æ—¶è¿™ä¸ªæ•°é‡ä¼šå¢åŠ å›æ”¶çš„å†…å­˜ï¼‰\nHeapInuse  344,064-&gt;3,629,056-&gt;385,024 (æ­£åœ¨ä½¿ç”¨çš„å­—èŠ‚æ•°)\nHeapReleased  66,469,888-&gt;63,250,432-&gt;62,996,480 ï¼ˆè¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„å†…å­˜ï¼Œå®ƒç»Ÿè®¡äº†ä»idle spanä¸­è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œæ²¡æœ‰è¢«é‡æ–°è·å–çš„å†…å­˜å¤§å°.ï¼‰\nPauseNs è¡¨ç¤ºGCåœé¡¿æ—¶å¸¸ï¼Œ PauseNs[NumGC%256] è¡¨ç¤ºç¬¬å¤šå°‘æ¬¡GCçš„æ—¶é•¿ï¼Œè®°å½•æœ€è¿‘256æ¬¡çš„GCï¼\nNextGC  4,473,924-&gt; 4,473,924 -&gt; 4,194,304, è¡¨ç¤ºä¸‹æ¬¡GCè§¦å‘çš„é˜ˆå€¼\nGCSys  229,376-&gt;2,240,512-&gt;2,312,192\n\nå…¶ä»–æŒ‡æ ‡è®²è§£è¯·çœ‹ https://golang.org/src/runtime/mstats.go\n2ã€ç›‘æ§è¿›ç¨‹çš„æŒ‡æ ‡è¿™é‡Œéœ€è¦ä½¿ç”¨ github.com/prometheus/procfs  åŒ…ï¼Œå¾ˆå¥½çš„è§£å†³äº†è·¨å¹³å°é—®é¢˜ï¼\npackage mainimport (\t&quot;github.com/prometheus/procfs&quot;\t&quot;os&quot;)func main() &#123;\tp, err := procfs.NewProc(os.Getpid())\tif err != nil &#123;\t\tpanic(err)\t&#125;\tprocStat, err := p.Stat()\tif err != nil &#123;\t\tpanic(err)\t&#125;\tprocStat.ResidentMemory() // è¿›ç¨‹æ‰€å ç”¨çš„RES\tprocStat.VirtualMemory()  // è¿›ç¨‹æ‰€å ç”¨çš„VIRT&#125;\n\n3ã€ä½¿ç”¨prometheus ç›‘æ§ä¸‹é¢æ˜¯ä¸€ä¸ªçº¿ä¸ŠæœåŠ¡çš„metrics\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.# TYPE go_gc_duration_seconds summarygo_gc_duration_seconds&#123;quantile=&quot;0&quot;&#125; 5.6827e-05go_gc_duration_seconds&#123;quantile=&quot;0.25&quot;&#125; 8.1842e-05go_gc_duration_seconds&#123;quantile=&quot;0.5&quot;&#125; 9.8818e-05go_gc_duration_seconds&#123;quantile=&quot;0.75&quot;&#125; 0.000125499go_gc_duration_seconds&#123;quantile=&quot;1&quot;&#125; 0.000555719go_gc_duration_seconds_sum 0.247680951go_gc_duration_seconds_count 2366# HELP go_goroutines Number of goroutines that currently exist.# TYPE go_goroutines gaugego_goroutines 50# HELP go_info Information about the Go environment.# TYPE go_info gaugego_info&#123;version=&quot;go1.13.5&quot;&#125; 1# HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.# TYPE go_memstats_alloc_bytes gaugego_memstats_alloc_bytes 8.338104e+06# HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.# TYPE go_memstats_alloc_bytes_total countergo_memstats_alloc_bytes_total 1.3874634688e+10# HELP go_memstats_buck_hash_sys_bytes Number of bytes used by the profiling bucket hash table.# TYPE go_memstats_buck_hash_sys_bytes gaugego_memstats_buck_hash_sys_bytes 1.922436e+06# HELP go_memstats_frees_total Total number of frees.# TYPE go_memstats_frees_total countergo_memstats_frees_total 8.9915565e+07# HELP go_memstats_gc_cpu_fraction The fraction of this program&#x27;s available CPU time used by the GC since the program started.# TYPE go_memstats_gc_cpu_fraction gaugego_memstats_gc_cpu_fraction 5.2633836319412915e-06# HELP go_memstats_gc_sys_bytes Number of bytes used for garbage collection system metadata.# TYPE go_memstats_gc_sys_bytes gaugego_memstats_gc_sys_bytes 2.398208e+06# HELP go_memstats_heap_alloc_bytes Number of heap bytes allocated and still in use.# TYPE go_memstats_heap_alloc_bytes gaugego_memstats_heap_alloc_bytes 8.338104e+06# HELP go_memstats_heap_idle_bytes Number of heap bytes waiting to be used.# TYPE go_memstats_heap_idle_bytes gaugego_memstats_heap_idle_bytes 5.1625984e+07# HELP go_memstats_heap_inuse_bytes Number of heap bytes that are in use.# TYPE go_memstats_heap_inuse_bytes gaugego_memstats_heap_inuse_bytes 1.0829824e+07# HELP go_memstats_heap_objects Number of allocated objects.# TYPE go_memstats_heap_objects gaugego_memstats_heap_objects 42405# HELP go_memstats_heap_released_bytes Number of heap bytes released to OS.# TYPE go_memstats_heap_released_bytes gaugego_memstats_heap_released_bytes 4.9709056e+07# HELP go_memstats_heap_sys_bytes Number of heap bytes obtained from system.# TYPE go_memstats_heap_sys_bytes gaugego_memstats_heap_sys_bytes 6.2455808e+07# HELP go_memstats_last_gc_time_seconds Number of seconds since 1970 of last garbage collection.# TYPE go_memstats_last_gc_time_seconds gaugego_memstats_last_gc_time_seconds 1.6172457774344466e+09# HELP go_memstats_lookups_total Total number of pointer lookups.# TYPE go_memstats_lookups_total countergo_memstats_lookups_total 0# HELP go_memstats_mallocs_total Total number of mallocs.# TYPE go_memstats_mallocs_total countergo_memstats_mallocs_total 8.995797e+07# HELP go_memstats_mcache_inuse_bytes Number of bytes in use by mcache structures.# TYPE go_memstats_mcache_inuse_bytes gaugego_memstats_mcache_inuse_bytes 83328# HELP go_memstats_mcache_sys_bytes Number of bytes used for mcache structures obtained from system.# TYPE go_memstats_mcache_sys_bytes gaugego_memstats_mcache_sys_bytes 98304# HELP go_memstats_mspan_inuse_bytes Number of bytes in use by mspan structures.# TYPE go_memstats_mspan_inuse_bytes gaugego_memstats_mspan_inuse_bytes 142528# HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system.# TYPE go_memstats_mspan_sys_bytes gaugego_memstats_mspan_sys_bytes 196608# HELP go_memstats_next_gc_bytes Number of heap bytes when next garbage collection will take place.# TYPE go_memstats_next_gc_bytes gaugego_memstats_next_gc_bytes 1.0362992e+07# HELP go_memstats_other_sys_bytes Number of bytes used for other system allocations.# TYPE go_memstats_other_sys_bytes gaugego_memstats_other_sys_bytes 5.542772e+06# HELP go_memstats_stack_inuse_bytes Number of bytes in use by the stack allocator.# TYPE go_memstats_stack_inuse_bytes gaugego_memstats_stack_inuse_bytes 4.653056e+06# HELP go_memstats_stack_sys_bytes Number of bytes obtained from system for stack allocator.# TYPE go_memstats_stack_sys_bytes gaugego_memstats_stack_sys_bytes 4.653056e+06# HELP go_memstats_sys_bytes Number of bytes obtained from system.# TYPE go_memstats_sys_bytes gaugego_memstats_sys_bytes 7.7267192e+07# HELP go_threads Number of OS threads created.# TYPE go_threads gaugego_threads 48# HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.# TYPE process_cpu_seconds_total counterprocess_cpu_seconds_total 3875.24# HELP process_max_fds Maximum number of open file descriptors.# TYPE process_max_fds gaugeprocess_max_fds 1.048576e+06# HELP process_open_fds Number of open file descriptors.# TYPE process_open_fds gaugeprocess_open_fds 29# HELP process_resident_memory_bytes Resident memory size in bytes.# TYPE process_resident_memory_bytes gaugeprocess_resident_memory_bytes 7.5575296e+07# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.# TYPE process_start_time_seconds gaugeprocess_start_time_seconds 1.61709350436e+09# HELP process_virtual_memory_bytes Virtual memory size in bytes.# TYPE process_virtual_memory_bytes gaugeprocess_virtual_memory_bytes 2.018103296e+09# HELP process_virtual_memory_max_bytes Maximum amount of virtual memory available in bytes.# TYPE process_virtual_memory_max_bytes gaugeprocess_virtual_memory_max_bytes -1# HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.# TYPE promhttp_metric_handler_requests_in_flight gaugepromhttp_metric_handler_requests_in_flight 1# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.# TYPE promhttp_metric_handler_requests_total counterpromhttp_metric_handler_requests_total&#123;code=&quot;200&quot;&#125; 25373promhttp_metric_handler_requests_total&#123;code=&quot;500&quot;&#125; 0promhttp_metric_handler_requests_total&#123;code=&quot;503&quot;&#125; 0\n\næ ¸å¿ƒå…³æ³¨çš„æŒ‡æ ‡ï¼š \n\nâ€‹    7.5575296e+07 å«ä¹‰æ˜¯  7.5575296*10^7 ï¼Œæ‰€ä»¥è½¬æ¢ä¸º Mï¼Œå¿«é€Ÿè®¡ç®—åªéœ€è¦ / 10^6ï¼Œ æ‰€ä»¥å°± -6å³å¯ï¼Œä¹Ÿå°±æ˜¯7.5575296e+01 æ‰€ä»¥å°±æ˜¯ 75M\n\n\nprocess_resident_memory_bytes  - RES è¿›ç¨‹æ‰€å ç”¨çš„ç‰©ç†å†…å­˜ ï¼ˆ75Mï¼‰\nprocess_virtual_memory_bytes - VIRT è¿›ç¨‹æ‰€å ç”¨çš„è™šæ‹Ÿå†…å­˜ (Goçš„è™šæ‹Ÿå†…å­˜å¾€å¾€å¾ˆå¤§ï¼Œ2G)\ngo_memstats_heap_alloc_bytes - HeapAlloc å †å†…å­˜å¤§å°(å½“å‰å †å®é™…ä½¿ç”¨çš„å¤§å° , 8M)\ngo_memstats_next_gc_bytes - NextGC è¡¨ç¤ºä¸‹æ¬¡è§¦å‘GCçš„é˜ˆå€¼ ï¼ˆ10Mï¼‰\ngo_memstats_heap_idle_bytes  - HeapIdle è¡¨ç¤ºå †ä¸­ç©ºé—²çš„å†…å­˜( 59M)\ngo_memstats_heap_inuse_bytes  - HeapInuseè¡¨ç¤ºæ­£åœ¨ä½¿ç”¨çš„å †å†…å­˜ (10Mï¼Œå¯èƒ½åŒ…å«æœ‰ç¢ç‰‡ï¼Œè¿™ä¸ªå°±æ˜¯å®é™…å ç”¨çš„å†…å­˜ï¼Œå¯ä»¥å‚è€ƒçš„ï¼Œå› ä¸ºç©ºé—²å†…å­˜å¯èƒ½è¢«å›æ”¶/æœªè¢«åˆ†é…çš„ä¹Ÿæ˜¯å¯èƒ½å®é™…æ²¡æœ‰åˆ†é…)\nprocess_open_fds æ‰“å¼€çš„æ–‡ä»¶ ï¼ˆ29ï¼‰\ngo_goroutines è¡¨ç¤º goçš„goroutine ä¸ªæ•° (50)\ngo_memstats_buck_hash_sys_bytes è¡¨ç¤ºhashè¡¨ä¸­çš„æ•°æ® (8M)\n\nä¸‹é¢æ˜¯æˆ‘ä»¬å…¬å¸å¯¹äºGoæœåŠ¡çš„ç›‘æ§\nè¿™ä¸ªå®¹å™¨é‡Œæ”¾çš„æ˜¯ä¸€ä¸ªç«™å†…ä¿¡æœåŠ¡ï¼ŒæœåŠ¡éƒ¨ç½²åœ¨å®¹å™¨ä¸­4c_4gï¼ˆå®¿ä¸»æœºæ˜¯128G_64Cï¼‰ï¼Œå¯ä»¥çœ‹åˆ°24å°æ—¶å†…ï¼ŒæœåŠ¡çš„å†…å­˜è¿˜æ˜¯ç›¸å¯¹æ¥è¯´å¾ˆç¨³å®šçš„ï¼Œå †å†…å­˜åŸºæœ¬ç»´æŒåœ¨10m-15må·¦å³ï¼ŒgcåŸºæœ¬åœ¨100uså†…ï¼\n\n4ã€ä½¿ç”¨ net/http/pprofåªéœ€è¦å¼•å…¥ _ &quot;net/http/pprof&quot; \nç„¶ååŠ ä¸€è¡Œ\ngo func() &#123;   // æœªå ç”¨çš„ç«¯å£\thttp.ListenAndServe(&quot;:8080&quot;, nil)&#125;()\n\n1ã€memæœ€åæ‰§è¡Œä¸€ä¸‹ä¸‹é¢çš„ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„ runtime.MemStatsï¼Œ ä¸ç”¨è¯´æ ¸å¿ƒå…³æ³¨ HeapAlloc å’Œ HeapInuse ä»¥åŠ NextGC ,  PauseNs , NumGC\nâœ  ~ curl http://localhost:8080/debug/pprof/allocs\\?debug\\=1 -v# runtime.MemStats# Alloc = 457531928# TotalAlloc = 672404416# Sys = 556939512# Lookups = 0# Mallocs = 24449# Frees = 23362# HeapAlloc = 457531928# HeapSys = 536248320# HeapIdle = 77873152# HeapInuse = 458375168# HeapReleased = 44040192# HeapObjects = 1087# Stack = 622592 / 622592# MSpan = 29512 / 32768# MCache = 20832 / 32768# BuckHashSys = 1443701# GCSys = 17530880# OtherSys = 1028483# NextGC = 915023280# LastGC = 1617268469532778000# PauseNs = [35105 36373 34839 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]# PauseEnd = [1617268337687730000 1617268338545459000 1617268469532778000 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]# NumGC = 3# NumForcedGC = 0# GCCPUFraction = 1.2248226722456959e-06# DebugGC = false* Connection #0 to host localhost left intact* Closing connection 0\n\n2ã€goroutine / threadâœ  ~ curl http://localhost:8080/debug/pprof/goroutine\\?debug\\=1 -vgoroutine profile: total 6âœ  ~ curl http://localhost:8080/debug/pprof/threadcreate\\?debug\\=1 -vthreadcreate profile: total 14\n\n3ã€é…åˆgo tool pprof  å‘½ä»¤\nâ€‹    ä¸»è¦éœ€è¦åŠ å‚æ•° secondsï¼Œé»˜è®¤æ”¶é›†30sï¼Œä¸‹é¢ä¾‹å­æ˜¯10s\n\nâœ  ~ go tool  pprof -http &quot;:8888&quot;  http://localhost:62316/debug/pprof/allocs\\?seconds\\=10Fetching profile over HTTP from http://localhost:62316/debug/pprof/allocs?seconds=10Saved profile in /Users/fanhaodong/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.011.pb.gzServing web UI on http://localhost:8888\n\nå¯ä»¥çœ‹åˆ°é‡‡é›†10sæœ€åæ•ˆæœ\n\n1ã€æ¯”å¦‚æŸ¥æ‰¾goroutine ä½¿ç”¨ç‡è¾ƒé«˜ï¼æˆ‘ä»¬é¦–å…ˆè¦æŸ¥è¯¢ ä¸ªæ•°\nâœ  ~ curl http://localhost:62316/debug/pprof/goroutine\\?debug\\=1goroutine profile: total 100\n\nä¸ºå•¥è¿™ä¹ˆå¤šæ¥\nâœ  ~ go tool  pprof -http &quot;:8888&quot;  http://localhost:62316/debug/pprof/goroutine\\?seconds\\=10Fetching profile over HTTP from http://localhost:62316/debug/pprof/goroutine?seconds=10Saved profile in /Users/fanhaodong/pprof/pprof.goroutine.001.pb.gzServing web UI on http://localhost:8888\n\nå¯ä»¥æŸ¥çœ‹csvå›¾ï¼Œå‰ææ˜¯ä½ æ˜¯åœ¨æœ¬åœ°ï¼Œé¦–å…ˆå¦‚æœåœ¨çº¿ä¸ŠæœåŠ¡å™¨ï¼Œæ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ï¼çº¿ä¸Šéœ€è¦æ‰§è¡Œ\nâœ  ~ go tool pprof   http://localhost:62316/debug/pprof/goroutine\\?seconds\\=\n\nç„¶åå»æŸ¥çœ‹\n\næŸ¥çœ‹trace\nâœ  ~ go tool pprof   http://localhost:62316/debug/pprof/goroutine\\?seconds\\=5Fetching profile over HTTP from http://localhost:62316/debug/pprof/goroutine?seconds=5(pprof) treeShowing nodes accounting for 102, 98.08% of 104 totalShowing top 80 nodes out of 129----------------------------------------------------------+-------------      flat  flat%   sum%        cum   cum%   calls calls% + context----------------------------------------------------------+-------------                                                53 51.96% |   runtime.selectgo                                                26 25.49% |   runtime.goparkunlock                                                23 22.55% |   runtime.netpollblock       102 98.08% 98.08%        102 98.08%                | runtime.gopark----------------------------------------------------------+-------------         0     0% 98.08%         54 51.92%                | github.com/apache/rocketmq-client-go/v2/primitive.WithRecover                                                 9 16.67% |   github.com/apache/rocketmq-client-go/v2/internal/remote.(*remotingClient).connect.func1                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*pushConsumer).pullMessage.func1                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func1                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func2                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func3                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func4                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func5                                                 5  9.26% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func6                                                 2  3.70% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.2                                                 2  3.70% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.3                                                 2  3.70% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.4                                                 2  3.70% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.5                                                 2  3.70% |   github.com/apache/rocketmq-client-go/v2/internal.(*traceDispatcher).Start.func1----------------------------------------------------------+-------------                                                 5  9.43% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func1                                                 5  9.43% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func2                                                 5  9.43% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func3                                                 5  9.43% |   github.com/apache/rocketmq-client-go/v2/consumer.(*statsItemSet).init.func4                                                 5  9.43% |   github.com/apache/rocketmq-client-go/v2/internal/remote.(*ResponseFuture).waitResponse                                                 5  9.43% |   net/http.(*persistConn).writeLoop                                                 2  3.77% |   database/sql.(*DB).connectionOpener                                                 2  3.77% |   database/sql.(*DB).connectionResetter                                                 2  3.77% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.2                                                 2  3.77% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.3                                                 2  3.77% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.4                                                 2  3.77% |   github.com/apache/rocketmq-client-go/v2/internal.(*rmqClient).Start.func1.5                                                 2  3.77% |   github.com/apache/rocketmq-client-go/v2/internal.(*traceDispatcher).process                                                 2  3.77% |   github.com/go-sql-driver/mysql.(*mysqlConn).startWatcher.func1                                                 1  1.89% |   github.com/SkyAPM/go2sky/reporter/grpc/management.(*managementServiceClient).KeepAlive                                                 1  1.89% |   github.com/apache/rocketmq-client-go/v2/consumer.(*pushConsumer).Start.func1.1                                                 1  1.89% |   github.com/nacos-group/nacos-sdk-go/common/http_agent.post         0     0% 98.08%         53 50.96%                | runtime.selectgo                                                53   100% |   runtime.gopark\n\n\n\næ€»ç»“Goçš„å†…å­˜æ¨¡å‹å’ŒGCç­–ç•¥æ€»ç»“ä¸€ä¸‹ï¼Œå †å±äºGoæœ€å¤§çš„ç©ºé—´ï¼Œå †å¤§å°åŸºæœ¬ç”¨ä¸å®Œï¼Œå¯¹äºGCæ¥è¯´(å› ä¸ºåˆ†é…çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼ŒåŒæ—¶ä¼šå®šæœŸé‡Šæ”¾å†…å­˜)ï¼ŒGoé‡‡ç”¨çš„æ˜¯èƒ½å¤ç”¨å³å¤ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘å¼€è¾Ÿäº†3Mç„¶åå›æ”¶äº†3Mä¸‹æ¬¡å°±å¤ç”¨è¿™ç©ºé—´ï¼Œå…¶æ¬¡å°±æ˜¯Goçš„å †å†…å­˜å¹¶ä¸ä¼šå›æ”¶ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘æŸä¸€æ—¶åˆ»å †ç©ºé—´å¼€è¾Ÿäº†å¾ˆå¤§çš„ç©ºé—´ï¼Œå…¶å®å¯¹äºç¨‹åºæ¥è¯´ï¼Œå†…å­˜å¹¶ä¸ä¼šå›æ”¶ï¼\nGoçš„GCæ—¶é—´ä¸»è¦æ˜¯æ ¹æ®å †çš„å¤§å°æœ‰å…³ï¼Œæˆ‘ä»¬çº¿ä¸Šæ¥è¯´ï¼ŒGoçš„å †å¤§å°åŸºæœ¬å¾ˆå°ï¼Œä¸åˆ°100Mï¼Œæ‰€ä»¥GCæ—¶é•¿ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼\nGoçš„GCä¼˜åŒ–å°±æ˜¯èƒ½å›æ”¶çš„åœ¨ç¨‹åº/è¯·æ±‚è¿è¡Œç»“æŸå°±ç«‹é©¬å›æ”¶ï¼Œå¦‚æœå¼€è¾Ÿå¤§é‡å†…å­˜ä»‹æ„ç”¨sync.Poolï¼\nå…¶æ¬¡å‡å°‘GCé¢‘ç‡å¯ä»¥åœ¨ç¨‹åºåˆå§‹åŒ–çš„æ—¶å€™å…ˆå¼€è¾Ÿä¸€ä¸ªå’Œç¨‹åºç¨³å®šè¿è¡Œæ—¶å¤§å°çš„ä¸€ä¸ªç©ºé—´ï¼Œé‚£ä¹ˆå¯¹äºGoæ¥è¯´ï¼Œä¼šå‡å°‘GCå›æ”¶çš„æ¬¡æ•°ï¼Œä½†æ˜¯GCå›æ”¶çš„æ—¶é—´å°±ä¼šå¢åŠ ï¼\nGoçš„GCå›æ”¶æ—¶é—´ä¸»è¦æ˜¯å—æœºå™¨çš„CPUé™åˆ¶ï¼Œcpuè¶Šç‰›é€¼çš„æœºå™¨å›æ”¶è¶Šå¿«ï¼\nå¤‡æ³¨mem ä¿¡æ¯å­—æ®µ// A MemStats records statistics about the memory allocator.type MemStats struct &#123;\t// å¸¸è§„ç»Ÿè®¡ã€‚\t// Alloc æ˜¯å·²åˆ†é…çš„å †å†…å­˜å¯¹è±¡å ç”¨çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\t//\t// è¿™ä¸ªå€¼å’Œ åŸºæœ¬å’ŒHeapAlloc ä¸€è‡´ï¼ˆçœ‹ä¸‹é¢ï¼‰ã€‚\tAlloc uint64\t// TotalAlloc æ˜¯ç´¯ç§¯çš„å †å†…å­˜å¯¹è±¡åˆ†é…çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\t//\t// TotalAlloc ä¼šéšç€å †å†…å­˜å¯¹è±¡åˆ†é…æ…¢æ…¢å¢é•¿ï¼Œä½†ä¸åƒ Alloc å’Œ HeapAllocï¼Œ\t// è¿™ä¸ªå€¼ä¸ä¼šéšç€å¯¹è±¡è¢«é‡Šæ”¾è€Œç¼©å°ã€‚\tTotalAlloc uint64\t// Sys æ˜¯ä» OS è·å¾—çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// Sys æ˜¯ä¸‹é¢åˆ—å‡ºçš„ XSys å­—æ®µçš„ç»¼åˆã€‚Sys ç»´æŠ¤ç€ä¸º Go è¿è¡Œæ—¶é¢„ç•™çš„è™šæ‹Ÿå†…å­˜ç©ºé—´åœ°å€ï¼Œ\t// é‡Œé¢åŒ…å«äº†ï¼šå †ã€æ ˆï¼Œä»¥åŠå…¶ä»–å†…éƒ¨æ•°æ®ç»“æ„ã€‚\tSys uint64\t// Lookups æ˜¯ runtime æ‰§è¡Œçš„æŒ‡é’ˆæŸ¥è¯¢çš„æ•°é‡ã€‚\t//\t// è¿™ä¸»è¦åœ¨é’ˆå¯¹ runtime å†…éƒ¨è¿›è¡Œ debugging çš„æ—¶å€™æ¯”è¾ƒæœ‰ç”¨ã€‚\tLookups uint64\t// Mallocs æ˜¯ç´¯ç§¯è¢«åˆ†é…çš„å †å†…å­˜å¯¹è±¡æ•°é‡ã€‚\t// å­˜æ´»å †å†…å­˜å¯¹è±¡æ•°é‡æ˜¯ Mallocs - Freesã€‚\tMallocs uint64\t// Frees æ˜¯ç´¯ç§¯è¢«é‡Šæ”¾æ‰çš„å †å†…å­˜å¯¹è±¡æ•°é‡ã€‚\tFrees uint64\t// å †å†…å­˜ç»Ÿè®¡ã€‚\t//\t// ç†è§£å †å†…å­˜ç»Ÿè®¡éœ€è¦ä¸€äº› Go æ˜¯å¦‚ä½•ç®¡ç†å†…å­˜çš„çŸ¥è¯†ã€‚Go å°†å †å†…å­˜è™šæ‹Ÿå†…å­˜ç©ºé—´ä»¥ &quot;spans&quot; ä¸ºå•ä½è¿›è¡Œåˆ†å‰²ã€‚\t// spans æ˜¯ 8Kï¼ˆæˆ–æ›´å¤§ï¼‰çš„è¿ç»­å†…å­˜ç©ºé—´ã€‚ä¸€ä¸ª span å¯èƒ½ä¼šåœ¨ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š\t//\t// ä¸€ä¸ª &quot;ç©ºé—² idle&quot; çš„ span å†…éƒ¨ä¸å«ä»»ä½•å¯¹è±¡æˆ–å…¶ä»–æ•°æ®ã€‚\t// å ç”¨ç‰©ç†å†…å­˜ç©ºé—´çš„ç©ºé—²çŠ¶æ€ span å¯ä»¥è¢«é‡Šæ”¾å› OSï¼ˆä½†è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸ä¼šï¼‰ï¼Œ\t// æˆ–è€…ä¹Ÿå¯ä»¥è¢«è½¬åŒ–æˆä¸º &quot;ä½¿ç”¨ä¸­ in use&quot; æˆ– &quot;å †æ ˆ stack&quot; çŠ¶æ€ã€‚\t//\t// ä¸€ä¸ª &quot;ä½¿ç”¨ä¸­ in use&quot; span åŒ…å«äº†è‡³å°‘ä¸€ä¸ªå †å†…å­˜å¯¹è±¡ä¸”å¯èƒ½è¿˜æœ‰å¯Œä½™çš„ç©ºé—´å¯ä»¥åˆ†é…æ›´å¤šçš„å †å†…å­˜å¯¹è±¡ã€‚\t//\t// ä¸€ä¸ª &quot;å †æ ˆ stack&quot; span æ˜¯è¢«ç”¨ä½œ goroutine stack çš„ å†…å­˜ç©ºé—´ã€‚\t// å †æ ˆçŠ¶æ€çš„ span ä¸è¢«è§†ä½œæ˜¯å †å†…å­˜çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ª span å¯ä»¥åœ¨å †å†…å­˜å’Œæ ˆå†…å­˜ä¹‹é—´åˆ‡æ¢ï¼›\t// ä½†ä¸å¯èƒ½åŒæ—¶ä½œä¸ºä¸¤è€…ã€‚\t// HeapAlloc æ˜¯å·²åˆ†é…çš„å †å†…å­˜å¯¹è±¡å ç”¨çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\t//\t// &quot;å·²åˆ†é…&quot;çš„å †å†…å­˜å¯¹è±¡åŒ…å«äº†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œä»¥åŠæ‰€æœ‰åƒåœ¾å›æ”¶å™¨å·²çŸ¥ä½†ä»æœªå›æ”¶çš„ä¸å¯è¾¾å¯¹è±¡ã€‚\t// ç¡®åˆ‡çš„è¯´ï¼ŒHeapAlloc éšç€å †å†…å­˜å¯¹è±¡åˆ†é…è€Œå¢é•¿ï¼Œå¹¶éšç€å†…å­˜æ¸…ç†ã€ä¸å¯è¾¾å¯¹è±¡çš„é‡Šæ”¾è€Œç¼©å°ã€‚\t// æ¸…ç†ä¼šéšç€ GC å¾ªç¯æ¸è¿›å‘ç”Ÿï¼Œæ‰€æœ‰å¢é•¿å’Œç¼©å°è¿™ä¸¤ä¸ªæƒ…å†µæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œ\t// ä½œä¸ºç»“æœ HeapAlloc çš„å˜åŠ¨è¶‹åŠ¿æ˜¯å¹³æ»‘çš„ï¼ˆä¸ä¼ ç»Ÿçš„ stop-the-world å‹åƒåœ¾å›æ”¶å™¨çš„é”¯é½¿çŠ¶è¶‹åŠ¿æˆå¯¹æ¯”ï¼‰ã€‚\tHeapAlloc uint64\t// HeapSys æ˜¯å †å†…å­˜ä» OS è·å¾—çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// HeapSys ç»´æŠ¤ç€ä¸ºå †å†…å­˜è€Œä¿ç•™çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚è¿™åŒ…æ‹¬è¢«ä¿ç•™ä½†å°šæœªä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œ\t// è¿™éƒ¨åˆ†æ˜¯ä¸å ç”¨å®é™…ç‰©ç†å†…å­˜çš„ï¼Œä½†è¶‹å‘äºç¼©å°ï¼Œ\t// å’Œé‚£äº›å ç”¨ç‰©ç†å†…å­˜ä½†åç»­å› ä¸å†ä½¿ç”¨è€Œé‡Šæ”¾å› OS çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸€æ ·ã€‚ï¼ˆæŸ¥çœ‹ HeapReleased ä½œä¸ºæ ¡å¯¹ï¼‰\t//\t// HeapSys ç”¨æ¥è¯„ä¼°å †å†…å­˜æ›¾ç»åˆ°è¿‡çš„æœ€å¤§å°ºå¯¸ã€‚\tHeapSys uint64\t// HeapIdle æ˜¯å¤„äº&quot;ç©ºé—²çŠ¶æ€ï¼ˆæœªä½¿ç”¨ï¼‰&quot;çš„ spans å ç”¨çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// ç©ºé—²çŠ¶æ€çš„ spans å†…éƒ¨ä¸å«å¯¹è±¡ã€‚è¿™äº› spans å¯ä»¥ï¼ˆå¹¶å¯èƒ½å·²ç»è¢«ï¼‰é‡Šæ”¾å› OSï¼Œ\t// æˆ–è€…å®ƒä»¬å¯ä»¥åœ¨å †å†…å­˜åˆ†é…ä¸­é‡æ–°è¢«åˆ©ç”¨èµ·æ¥ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¢«é‡æ–°ä½œä¸ºæ ˆå†…å­˜åˆ©ç”¨èµ·æ¥ã€‚\t//\t// HeapIdle å‡å» HeapReleased ç”¨æ¥è¯„ä¼°å¯ä»¥è¢«é‡Šæ”¾å› OS çš„å†…å­˜æ€»é‡ï¼Œ\t// ä½†å› ä¸ºè¿™äº›å†…å­˜å·²ç»è¢« runtime å ç”¨äº†ï¼ˆå·²ç»ä» OS ç”³è¯·ä¸‹æ¥äº†ï¼‰æ‰€ä»¥å †å†…å­˜å¯ä»¥é‡æ–°ä½¿ç”¨è¿™äº›å†…å­˜ï¼Œ\t// å°±ä¸ç”¨å†å‘ OS ç”³è¯·æ›´å¤šå†…å­˜äº†ã€‚å¦‚æœè¿™ä¸ªå·®å€¼æ˜¾è‘—å¤§äºå †å†…å­˜å°ºå¯¸ï¼Œè¿™æ„å‘³ç€è¿‘æœŸå †å†…å­˜å­˜æ´»å¯¹è±¡æ•°é‡å­˜åœ¨ä¸€ä¸ªçŸ­æ—¶å³°å€¼ã€‚\tHeapIdle uint64\t// HeapInuse æ˜¯å¤„äº&quot;ä½¿ç”¨ä¸­&quot;çŠ¶æ€çš„ spans å ç”¨çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// ä½¿ç”¨ä¸­çš„ spans å†…éƒ¨å­˜åœ¨è‡³å°‘ä¸€ä¸ªå¯¹è±¡ã€‚è¿™äº› spans ä»…å¯ä»¥è¢«ç”¨æ¥å­˜å‚¨å…¶ä»–å°ºå¯¸æ¥è¿‘çš„å¯¹è±¡ã€‚\t//\t// HeapInuse å‡å» HeapAlloc ç”¨æ¥è¯„ä¼°è¢«ç”¨æ¥å­˜å‚¨ç‰¹å®šå°ºå¯¸å¯¹è±¡çš„å†…å­˜ç©ºé—´çš„æ€»é‡ï¼Œ\t// ä½†ç›®å‰å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ã€‚è¿™æ˜¯å†…å­˜ç¢ç‰‡çš„ä¸Šç•Œï¼Œä½†é€šå¸¸æ¥è¯´è¿™äº›å†…å­˜ä¼šè¢«é«˜æ•ˆé‡ç”¨ã€‚\tHeapInuse uint64\t// HeapReleased æ˜¯è¢«é‡Šæ”¾å› OS çš„ç‰©ç†å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// è¿™ä¸ªå€¼è®¡ç®—ä¸ºå·²ç»è¢«é‡Šæ”¾å› OS çš„ç©ºé—²çŠ¶æ€çš„ spans å †å†…å­˜ç©ºé—´ï¼Œä¸”å°šæœªé‡æ–°è¢«å †å†…å­˜åˆ†é…ã€‚\tHeapReleased uint64\t// HeapObjects æ˜¯å †å†…å­˜ä¸­çš„å¯¹è±¡æ€»é‡ã€‚\t//\t// å’Œ HeapAlloc ä¸€æ ·ï¼Œè¿™ä¸ªå€¼éšç€å¯¹è±¡åˆ†é…è€Œä¸Šæ¶¨ï¼Œéšç€å †å†…å­˜æ¸…ç†ä¸å¯è¾¾å¯¹è±¡è€Œç¼©å°ã€‚\tHeapObjects uint64\t// æ ˆå†…å­˜ç»Ÿè®¡ã€‚\t//\t// æ ˆå†…å­˜ä¸è¢«è®¤ä¸ºæ˜¯å †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œä½† runtime ä¼šå°†ä¸€ä¸ªå †å†…å­˜ä¸­çš„ span ç”¨ä½œä¸ºæ ˆå†…å­˜ï¼Œåä¹‹äº¦ç„¶ã€‚\t// StackInuse æ˜¯æ ˆå†…å­˜ä½¿ç”¨çš„ spans å ç”¨çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// ä½¿ç”¨ä¸­çŠ¶æ€çš„æ ˆå†…å­˜ spans å…¶ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ ˆå†…å­˜ã€‚è¿™äº› spans åªèƒ½è¢«ç”¨æ¥å­˜å‚¨å…¶ä»–å°ºå¯¸æ¥è¿‘çš„æ ˆå†…å­˜ã€‚\t//\t// å¹¶ä¸å­˜åœ¨ StackIdleï¼Œå› ä¸ºæœªä½¿ç”¨çš„æ ˆå†…å­˜ spans ä¼šè¢«é‡Šæ”¾å›å †å†…å­˜ï¼ˆå› æ­¤è¢«è®¡å…¥ HeapIdleï¼‰ã€‚\tStackInuse uint64\t// StackSys æ˜¯æ ˆå†…å­˜ä» OS è·å¾—çš„å†…å­˜æ€»é‡ï¼ˆbytesï¼‰ã€‚\t//\t// StackSys æ˜¯ StackInuse åŠ ä¸Šä¸€äº›ä¸ºäº† OS çº¿ç¨‹æ ˆè€Œç›´æ¥ä» OS è·å–çš„å†…å­˜ï¼ˆåº”è¯¥å¾ˆå°ï¼‰ã€‚\tStackSys uint64\t// å †å¤–ï¼ˆoff-heapï¼‰å†…å­˜ç»Ÿè®¡ã€‚\t//\t// ä¸‹åˆ—çš„ç»Ÿè®¡ä¿¡æ¯æè¿°äº†å¹¶ä¸ä¼šä»å †å†…å­˜è¿›è¡Œåˆ†é…çš„è¿è¡Œæ—¶å†…éƒ¨ï¼ˆruntime-internalï¼‰ç»“æ„ä½“ï¼ˆé€šå¸¸å› ä¸ºå®ƒä»¬æ˜¯å †å†…å­˜å®ç°çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚\t// ä¸åƒå †å†…å­˜æˆ–æ ˆå†…å­˜ï¼Œä»»ä½•è¿™äº›ç»“æ„ä½“çš„å†…å­˜åˆ†é…ä»…åªæ˜¯ä¸ºè¿™äº›ç»“æ„æœåŠ¡ã€‚\t//\t// è¿™äº›ç»Ÿè®¡ä¿¡æ¯å¯¹ debugging runtime å†…å­˜é¢å¤–å¼€é”€éå¸¸æœ‰ç”¨ã€‚\t// MSpanInuse æ˜¯ mspan ç»“æ„ä½“åˆ†é…çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tMSpanInuse uint64\t// MSpanSys æ˜¯ä¸º mspan ç»“æ„ä½“ä» OS ç”³è¯·è¿‡æ¥çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tMSpanSys uint64\t// MCacheInuse æ˜¯ mcache ç»“æ„ä½“åˆ†é…çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tMCacheInuse uint64\t// MCacheSys æ˜¯ä¸º mcache ç»“æ„ä½“ä» OS ç”³è¯·è¿‡æ¥çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tMCacheSys uint64\t// BuckHashSys æ˜¯ç”¨æ¥ profiling bucket hash tables çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tBuckHashSys uint64\t// GCSys æ˜¯åœ¨åƒåœ¾å›æ”¶ä¸­ä½¿ç”¨çš„ metadata çš„å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚ \tGCSys uint64\t// OtherSys æ˜¯å„ç§å„æ ·çš„ runtime åˆ†é…çš„å †å¤–å†…å­˜é‡ï¼ˆbytesï¼‰ã€‚\tOtherSys uint64\t// åƒåœ¾å›æ”¶ç»Ÿè®¡ã€‚\t// NextGC æ˜¯ä¸‹ä¸€æ¬¡ GC å¾ªç¯çš„ç›®æ ‡å †å†…å­˜å°ºå¯¸ã€‚\t//\t// åƒåœ¾å›æ”¶å™¨çš„ç›®æ ‡æ˜¯ä¿æŒ HeapAlloc â‰¤ NextGCã€‚\t// åœ¨æ¯ä¸€è½® GC å¾ªç¯æœ«å°¾ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯çš„ç›®æ ‡å€¼ä¼šåŸºäºå½“å‰å¯è¾¾å¯¹è±¡æ•°æ®é‡ä»¥åŠ GOGC çš„å€¼æ¥è¿›è¡Œè®¡ç®—ã€‚\tNextGC uint64\t// LastGC æ˜¯ä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶å®Œæˆçš„æ—¶é—´ï¼Œå…¶å€¼ä¸ºè‡ª 1970 å¹´çº¸å·¾çš„ nanosecondsï¼ˆUNIX epochï¼‰ã€‚\tLastGC uint64\t// PauseTotalNs æ˜¯è‡ªç¨‹åºå¯åŠ¨å¼€å§‹ï¼Œåœ¨ GC stop-the-world ä¸­æš‚åœçš„ç´¯ç§¯æ—¶é•¿ï¼Œä»¥ nanoseconds è®¡æ•°ã€‚\t//\t// åœ¨ä¸€æ¬¡ stop-the-world æš‚åœæœŸé—´ï¼Œæ‰€æœ‰çš„ goroutines éƒ½ä¼šè¢«æš‚åœï¼Œä»…åƒåœ¾å›æ”¶å™¨åœ¨è¿è¡Œã€‚\tPauseTotalNs uint64\t// PauseNs æ˜¯æœ€è¿‘çš„ GC stop-the-world æš‚åœè€—æ—¶çš„ç¯å½¢ç¼“å†²åŒºï¼ˆä»¥ nanoseconds è®¡æ•°ï¼‰ã€‚\t//\t// æœ€è¿‘ä¸€æ¬¡çš„æš‚åœè€—æ—¶åœ¨ PauseNs[(NumGC+255)%256] è¿™ä¸ªä½ç½®ã€‚\t// é€šå¸¸æ¥è¯´ï¼ŒPauseNs[N%256] è®°å½•ç€æœ€è¿‘ç¬¬ N%256th æ¬¡ GC å¾ªç¯çš„æš‚åœè€—æ—¶ã€‚\t// åœ¨æ¯æ¬¡ GC å¾ªç¯ä¸­å¯èƒ½ä¼šæœ‰å¤šæ¬¡æš‚åœï¼›è¿™æ˜¯åœ¨ä¸€æ¬¡å¾ªç¯ä¸­çš„æ‰€æœ‰æš‚åœæ—¶é•¿çš„æ€»åˆã€‚\tPauseNs [256]uint64\t// PauseEnd æ˜¯æœ€è¿‘çš„ GC æš‚åœç»“æŸæ—¶é—´çš„ç¯å½¢ç¼“å†²åŒºï¼Œå…¶å€¼ä¸ºè‡ª 1970 å¹´çº¸å·¾çš„ nanosecondsï¼ˆUNIX epochï¼‰ã€‚\t//\t// è¿™ä¸ªç¼“å†²åŒºçš„å¡«å……æ–¹å¼å’Œ PauseNs æ˜¯ä¸€è‡´çš„ã€‚\t// æ¯æ¬¡ GC å¾ªç¯å¯èƒ½æœ‰å¤šæ¬¡æš‚åœï¼›è¿™ä¸ªç¼“å†²åŒºè®°å½•çš„æ˜¯æ¯ä¸ªå¾ªç¯çš„æœ€åä¸€æ¬¡æš‚åœçš„ç»“æŸæ—¶é—´ã€‚\tPauseEnd [256]uint64\t// NumGC æ˜¯å®Œæˆè¿‡çš„ GC å¾ªç¯çš„æ•°é‡ã€‚\tNumGC uint32\t// NumForcedGC æ˜¯åº”ç”¨ç¨‹åºç»ç”±è°ƒç”¨ GC å‡½æ•°æ¥å¼ºåˆ¶å‘èµ·çš„ GC å¾ªç¯çš„æ•°é‡ã€‚\tNumForcedGC uint32\t// GCCPUFraction æ˜¯è‡ªç¨‹åºå¯åŠ¨ä»¥æ¥ï¼Œåº”ç”¨ç¨‹åºçš„å¯ç”¨ CPU æ—¶é—´è¢« GC æ¶ˆè€—çš„æ—¶é•¿éƒ¨åˆ†ã€‚\t//\t// GCCPUFraction æ˜¯ä¸€ä¸ª 0 å’Œ 1 ä¹‹é—´çš„æ•°å­—ï¼Œ0 ä»£è¡¨ GC å¹¶æ²¡æœ‰æ¶ˆè€—è¯¥åº”ç”¨ç¨‹åºçš„ä»»ä½• CPUã€‚\t// ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„å¯ç”¨ CPU æ—¶é—´å®šä¹‰ä¸ºï¼šè‡ªåº”ç”¨ç¨‹åºå¯åŠ¨ä»¥æ¥ GOMAXPROCS çš„ç§¯åˆ†ã€‚\t// ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœ GOMAXPROCS æ˜¯ 2 ä¸”åº”ç”¨ç¨‹åºå·²ç»è¿è¡Œäº† 10 ç§’ï¼Œé‚£ä¹ˆ&quot;å¯ç”¨ CPU æ—¶é•¿&quot;å°±æ˜¯ 20 ç§’ã€‚\t// GCCPUFraction å¹¶æœªåŒ…å«å†™å±éšœè¡Œä¸ºæ¶ˆè€—çš„ CPU æ—¶é•¿ã€‚\t//\t// è¯¥å€¼å’Œç»ç”± GODEBUG=gctrace=1 æŠ¥å‘Šå‡ºæ¥çš„ CPU æ—¶é•¿æ˜¯ä¸€è‡´çš„ã€‚ \tGCCPUFraction float64\t// EnableGC æ˜¾ç¤º GC æ˜¯å¦è¢«å¯ç”¨äº†ã€‚è¯¥å€¼æ°¸è¿œä¸ºçœŸï¼Œå³ä¾¿ GOGC=off è¢«å¯ç”¨ã€‚\tEnableGC bool\t// DebugGC ç›®å‰å¹¶æœªè¢«ä½¿ç”¨ã€‚\tDebugGC bool\t// BySize æ±‡æŠ¥äº†æŒ‰å¤§å°åˆ’åˆ†çš„ span çº§åˆ«å†…å­˜åˆ†é…ç»Ÿè®¡ä¿¡æ¯ã€‚\t//\t// BySize[N] ç»™å‡ºäº†å°ºå¯¸ S å¯¹è±¡çš„å†…å­˜åˆ†é…ç»Ÿè®¡ä¿¡æ¯ï¼Œå°ºå¯¸å¤§å°æ˜¯ï¼š\t// BySize[N-1].Size &lt; S â‰¤ BySize[N].Sizeã€‚\t//\t// è¿™ä¸ªç»“æ„é‡Œçš„æ•°æ®å¹¶æœªæ±‡æŠ¥å°ºå¯¸å¤§äº BySize[60].Size çš„å†…å­˜åˆ†é…æ•°æ®ã€‚\tBySize [61]struct &#123;\t\t// Size æ˜¯å½“å‰å°ºå¯¸çº§åˆ«å¯å®¹çº³çš„æœ€å¤§å¯¹è±¡çš„ byte å¤§å°ã€‚\t\tSize uint32\t\t// Mallocs æ˜¯åˆ†é…åˆ°è¿™ä¸ªå°ºå¯¸çº§åˆ«çš„å †å†…å­˜å¯¹è±¡çš„ç´¯ç§¯æ•°é‡ã€‚\t\t// ç´¯ç§¯åˆ†é…çš„å†…å­˜å®¹é‡ï¼ˆbytesï¼‰å¯ç”¨ï¼šSize*Mallocs è¿›è¡Œè®¡ç®—ã€‚\t\t// å½“å‰å°ºå¯¸çº§åˆ«å†…å­˜æ´»çš„å¯¹è±¡æ•°é‡å¯ä»¥ç”¨ Mallocs - Frees è¿›è¡Œè®¡ç®—ã€‚\t\tMallocs uint64\t\t// Frees æ˜¯å½“å‰å°ºå¯¸çº§åˆ«ç´¯ç§¯é‡Šæ”¾çš„å †å†…å­˜å¯¹è±¡çš„æ•°é‡ã€‚\t\tFrees uint64\t&#125;&#125;\n\nä½¿ç”¨åˆå§‹åŒ–å†…å­˜ï¼Œå‡å°‘gcå‘¨æœŸæµ‹è¯•ä»£ç \nâ€‹    å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»£ç å¾ˆè‡ªç”±åˆå§‹åŒ–240må†…å­˜çš„æ—¶å€™è§¦å‘äº†GCï¼Œæ‰€ä»¥åç»­åˆ†é…å†…å­˜æ²¡æœ‰å‘ç”Ÿä¸€æ¬¡GC\n\nvar (\tbuffer = makeArr(240 &lt;&lt; 20) // 240m ,æ„æ€å°±æ˜¯å †2*240Mæ˜¯ä¸ä¼šè§¦å‘gcçš„)var (\tappender = make([][]byte, 0, 100))// GODEBUG=gctrace=1func main() &#123;\tcount := 0\talloc := 4 &lt;&lt; 20\tfor x := 0; x &lt; 100; x++ &#123;\t\tappender = append(appender, makeArr(alloc))\t\tcount++\t\ttime.Sleep(time.Millisecond * 10)\t\t// åˆ°50å°±å›æ”¶å†å²çš„æ•°æ®ï¼Œé‚£ä¹ˆå†…å­˜è¾¾åˆ° 480mçš„æ—¶å€™å°±ä¼šè§¦å‘gcï¼Œæ‰€ä»¥è¿™ä¸ªç¨‹åºç»“æŸåå†…å­˜ä½¿ç”¨ä¸€èˆ¬æ˜¯åœ¨480må·¦å³\t\tif x == 50 &#123;\t\t\tfor index := range appender &#123;\t\t\t\tappender[index] = nil\t\t\t&#125;\t\t\tprintln(len(appender))\t\t&#125;\t&#125;&#125;func makeArr(len int) []byte &#123;\tfmt.Printf(&quot;åˆ†é…å †å†…å­˜: %dM\\n&quot;, len&gt;&gt;20)\tbytes := make([]byte, len)\tfor index, _ := range bytes &#123;\t\tbytes[index] = &#x27;x&#x27;\t&#125;\treturn bytes&#125;\n\nå¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨bufferå’Œä¸ä½¿ç”¨bufferçš„gcæ€»æ—¶é—´\nåˆ†é…bufferçš„gcæ¬¡æ•°ä¸¤æ¬¡\ngc 1 @0.009s 0%: 0.016+191+0.034 ms clock, 0.064+0.007/0.13/191+0.13 ms cpu, 240-&gt;240-&gt;240 MB, 241 MB goal, 4 Pgc 2 @1.251s 0%: 0.030+8.8+0.025 ms clock, 0.12+0/0.13/8.6+0.10 ms cpu, 468-&gt;468-&gt;264 MB, 480 MB goal, 4 P# gcæ—¶é—´283700 302700 =586400 ns\n\næœªåˆ†é…bufferçš„gc\n# å·¥9æ¬¡gc122800 81400 55000 78900 103200 39400 88400 66800 33900  = 669800 ns# æœ€åä¸€æ¬¡gcgc 9 @1.830s 0%: 0.016+2.2+0.017 ms clock, 0.066+0/0/2.2+0.069 ms cpu, 188-&gt;188-&gt;188 MB, 192 MB goal, 4 Pres: 263M, virt: 355M\n\næ‰€ä»¥æ•´ä½“æ¥è¯´ï¼Œgcæ—¶é—´åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯é™ä½gcæ¬¡æ•°ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©\nå‚è€ƒhttps://xenojoshua.com/2019/03/golang-memory/\n","categories":["Golang"],"tags":["Golang","GC"]},{"title":"pythonå­¦ä¹ ç¬”è®°(åŸºæœ¬è¯­æ³•+è„šæœ¬)","url":"/2021/11/21/3f563fcaf31a49a8ecd1b956a4aa695a/","content":"â€‹    ä¸ªäººå­¦ä¹ pythonçš„ç¬”è®°ï¼åŸºäº python3 ! ç›¸å…³æ–‡æ¡£å¯ä»¥å‚è€ƒ: https://docs.python.org/zh-cn/3/library/index.html , æœ¬åœ°å¯ä»¥æ‰§è¡Œpython3 -m pydoc -p 1234 æ‰“å¼€æ–‡æ¡£\n\n\nåŸºæœ¬è¯­æ³•1. ç®€å•æ§åˆ¶è¯­å¥\nå­—ç¬¦ä¸²æ¨èç”¨ &#39;&#39; å•å¼•å·å¼•ç”¨\n\nlist: List[int] = [1, 2, 3]for elem in list:    if elem &gt; 1:        print(f&#x27;data &#123;elem&#125; &gt; 1&#x27;)  # è¿™é‡Œæ˜¯formatè¯­å¥ï¼Œå±äºè¯­æ³•ç³–    else:        print(f&#x27;data &#123;elem&#125; &lt; 1&#x27;)&#x27;&#x27;&#x27;data 1 &lt; 1data 2 &gt; 1data 3 &gt; 1&#x27;&#x27;&#x27;\n\n2. å¼‚å¸¸x = -1try:    if x &lt; 0:        raise Exception(&quot;Sorry, no numbers below zero&quot;)except Exception as err:    print(&quot;find err: %s&quot; % err)&#x27;&#x27;&#x27;find err: Sorry, no numbers below zero&#x27;&#x27;&#x27; \n\n3. æ¨å¯¼å¼(YYDS)\nå‚è€ƒï¼š https://www.cnblogs.com/desireyang/p/12160332.html\n\n\næ¨å¯¼å¼å¥½å¤„: æ•ˆç‡æ›´é«˜ï¼Œæœ‰ç‚¹åƒJavaçš„stream-apiï¼Œgoç¾¡æ…•çš„è¦æ­»\n\nlist = [-1,-2,-3,4,5,6]print([elem if elem&gt;0 else -elem for elem in list if elem %2==0])# output [2, 4, 6]\n\n1. åˆ—è¡¨æ¨å¯¼å¼ä¸€å…±ä¸¤ç§å½¢å¼ï¼š(å‚è€ƒ:  https://zhuanlan.zhihu.com/p/139621170) ï¼Œ å®ƒä¸»è¦æ˜¯è¾“å‡ºæ˜¯åˆ—è¡¨(list)\n\n[x for x in data if condition]  è¿™é‡Œçš„å«ä¹‰æ˜¯dataåªæœ‰æ»¡è¶³ifæ¡ä»¶ä¸­çš„æƒ…å†µæ‰ä¿ç•™ (if)\n\n[exp1 if condition else exp2 for x in data] ï¼Œ è¿™é‡Œçš„å«ä¹‰æ˜¯dataæ»¡è¶³ifæ¡ä»¶æ—¶æ‰§è¡Œexp1 å¦åˆ™ exp2 ï¼ˆif - elseï¼‰\n\n\nimport re&quot;&quot;&quot;è·å–æ‰€æœ‰çš„æ•°å­—&quot;&quot;&quot;list = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;]print([elem for elem in list if re.match(&quot;\\\\d&quot;, elem)])&#x27;&#x27;&#x27;[&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;]&#x27;&#x27;&#x27;&quot;&quot;&quot;è·å–æ‰€æœ‰çš„å­—æ¯&quot;&quot;&quot;print([elem for elem in list if re.match(&quot;[a-z]&quot;, elem)])&#x27;&#x27;&#x27;[&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]&#x27;&#x27;&#x27;&quot;&quot;&quot;å¦‚æœå…ƒç´ æ˜¯æ•°å­—åˆ™å­˜å‚¨ï¼Œå¦åˆ™åˆ™upper&quot;&quot;&quot;print([elem if re.match(&quot;\\\\d&quot;, elem) else elem.upper() for elem in list])&#x27;&#x27;&#x27;[&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]&#x27;&#x27;&#x27;\n\næœ€ä½³å®è·µï¼š å‚è€ƒ(https://github.com/httpie/httpie/blob/master/httpie/core.py#L235)\ndef decode_raw_args(        args: List[Union[str, bytes]],        stdin_encoding: str) -&gt; List[str]:    &quot;&quot;&quot;    Convert all bytes args to str    by decoding them using stdin encoding.    &quot;&quot;&quot;    return [        arg.decode(stdin_encoding)        if type(arg) is bytes else arg        for arg in args    ]def decode_raw_args_parse(        args: List[Union[str, bytes]],        stdin_encoding: str) -&gt; List[str]:    &quot;&quot;&quot;    Convert all bytes args to str    by decoding them using stdin encoding.    ä¸ä½¿ç”¨æ¨å¯¼å¼    &quot;&quot;&quot;    result: List[str] = []    for arg in args:        if type(arg) is bytes:            result.append(arg.decode(stdin_encoding))        else:            result.append(arg)    return result# arg.decode(stdin_encoding) if type(arg) is bytes else arg for arg in argsprint(decode_raw_args(args=[b&#x27;111&#x27;, b&#x27;222&#x27;], stdin_encoding=&quot;utf-8&quot;))print(decode_raw_args(args=[&quot;111&quot;, &quot;222&quot;], stdin_encoding=&quot;&quot;))&#x27;&#x27;&#x27;[&#x27;111&#x27;, &#x27;222&#x27;][&#x27;111&#x27;, &#x27;222&#x27;]&#x27;&#x27;&#x27;print(decode_raw_args_parse(args=[b&#x27;111&#x27;, b&#x27;222&#x27;], stdin_encoding=&quot;utf-8&quot;))print(decode_raw_args_parse(args=[&quot;111&quot;, &quot;222&quot;], stdin_encoding=&quot;&quot;))&#x27;&#x27;&#x27;[&#x27;111&#x27;, &#x27;222&#x27;][&#x27;111&#x27;, &#x27;222&#x27;]&#x27;&#x27;&#x27;\n\n2. å­—å…¸æ¨å¯¼å¼&#123; key_expr: value_expr for value in collection if condition &#125;  ï¼Œè¾“å‡ºæ˜¯ dict\n&quot;&quot;&quot;&#123; key_expr: value_expr for value in collection if condition &#125;åè½¬key valueï¼Œä¸”è·å– value ä¸ºåœ¨set &#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;&#125;ä¸­çš„å…ƒç´ &quot;&quot;&quot;dict_old = &#123;&#x27;a&#x27;: &#x27;A&#x27;, &#x27;b&#x27;: &#x27;B&#x27;, &#x27;c&#x27;: &#x27;C&#x27;, &#x27;d&#x27;: &#x27;D&#x27;&#125;print(&#123;dict_old[value]: value for value in dict_old if value in &#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;&#125;&#125;)&#x27;&#x27;&#x27;&#123;&#x27;A&#x27;: &#x27;a&#x27;, &#x27;B&#x27;: &#x27;b&#x27;, &#x27;C&#x27;: &#x27;c&#x27;&#125;&#x27;&#x27;&#x27;print(&#123;key: value for value, key in dict_old.items() if value in &#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;&#125;&#125;)&#x27;&#x27;&#x27;&#123;&#x27;A&#x27;: &#x27;a&#x27;, &#x27;B&#x27;: &#x27;b&#x27;, &#x27;C&#x27;: &#x27;c&#x27;&#125;&#x27;&#x27;&#x27;\n\n3. é›†åˆæ¨å¯¼å¼è¡¨è¾¾å¼:\n\n&#123; expr for value in collection if condition &#125; \n&#123;exp1 if condition else exp2 for x in data&#125;\n\n è¾“å‡ºæ˜¯ set\nå…¶å®å°±æ˜¯ä¸Šé¢åˆ—è¡¨æ¨å¯¼å¼ [] æ¢æˆ &#123;&#125; ï¼Œè¾“å‡ºç”± list å˜æˆäº† set\n4. for å¾ªç¯ è¿­ä»£å™¨import osfrom collections.abc import Iterablewith open(&quot;text.log&quot;, &quot;wt&quot;) as file:    file.truncate()    file.writelines(&quot;line 1&quot; + os.linesep)    file.writelines(&quot;line 2&quot; + os.linesep)    file.writelines(&quot;line 3&quot; + os.linesep)    passwith open(&quot;text.log&quot;, &quot;rt&quot;) as file:    for line in file:        print(&quot;type: &#123;type&#125;, isinstance: &#123;isinstance&#125;, line: &#123;line&#125;&quot;.format(type=type(file),                                                                            isinstance=isinstance(file, Iterable),                                                                            line=line))    pass&#x27;&#x27;&#x27;type: &lt;class &#x27;_io.TextIOWrapper&#x27;&gt;, isinstance: True, line: line 1type: &lt;class &#x27;_io.TextIOWrapper&#x27;&gt;, isinstance: True, line: line 2type: &lt;class &#x27;_io.TextIOWrapper&#x27;&gt;, isinstance: True, line: line 3&#x27;&#x27;&#x27;\n\nè¿™é‡Œé¢ _io.TextIOWrapper å®ç°äº†  __next__() æ–¹æ³•\næ¯”å¦‚æˆ‘ä»¬è‡ªå·±å®ç°ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡\n\nä¸‹é¢å¯ä»¥çœ‹åˆ°æˆ‘ä½¿ç”¨äº†ç±»å‹ç”³æ˜ List[str] å…¶å®è¿™ä¸ªpythonè¿è¡Œæ—¶å¹¶ä¸ä¼šæ£€æµ‹ï¼Œéœ€è¦å·¥å…·è¿›è¡Œæ£€æµ‹ï¼\nå˜é‡é»˜è®¤éƒ½æ˜¯ Any ç±»å‹ ï¼Œå…·ä½“å¯ä»¥çœ‹ https://docs.python.org/zh-cn/3/library/typing.html\n\nfrom typing import Listclass Items(object):    def __init__(self, list: List[str]):        self.list = list        self.index = 0    def __next__(self, *args, **kwargs):        &quot;&quot;&quot;        nextï¼Œæ²¡æœ‰æŠ›å‡ºStopIteration        &quot;&quot;&quot;        if self.index &gt;= len(self.list):            raise StopIteration        result = self.list[self.index]        self.index = self.index + 1        return result    def __iter__(self, *args, **kwargs):        &quot;&quot;&quot;        è¿”å›ä¸€ä¸ªè¿­ä»£å™¨        &quot;&quot;&quot;        return selfdata = Items([&quot;1&quot;, &quot;2&quot;, &quot;3&quot;])for x in data:    print(x)&#x27;&#x27;&#x27;123&#x27;&#x27;&#x27;\n\n5. åŒ…ç®¡ç†from ..a import foo  # ä¸Šçº§ç›®å½•from .a import foo_a  # å½“å‰ç›®å½•import sys  # å¼•ç”¨æºç æˆ–è€…libfrom copy import deepcopy  # å¼•ç”¨æºç æˆ–è€…libfrom pygments.formatters.terminal import TerminalFormatter  # å¼•ç”¨ lib.lib.fileimport demo.utils.adef c_foo():    demo.utils.a.foo_a()    TerminalFormatter()    deepcopy()    print(sys.api_version)def b_foo():    foo()\n\nåŸºæœ¬æ•°æ®ç±»å‹1. å®šä¹‰æ–¹å¼\nmylist: list[str] = [&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;]\nmylist=[&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;]\n\n\n\n\nText Type:\nstr\n\n\n\nNumeric Types:\nint, float, complex\n\n\nSequence Types:\nlist, tuple, range\n\n\nMapping Type:\ndict\n\n\nSet Types:\nset, frozenset\n\n\nBoolean Type:\nbool\n\n\nBinary Types:\nbytes, bytearray, memoryview\n\n\n2. æ•°å­—åŸºæœ¬ç±»å‹x = 1  # inty = 1.1  # floatz = 1j  # å¤æ•°(complex)a = complex(1, 2)  # å¤æ•°(complex)print(type(x))print(type(y))print(type(z))print(z.imag, z.real)print(type(a))print(a.imag, a.real)&#x27;&#x27;&#x27;&lt;class &#x27;int&#x27;&gt;&lt;class &#x27;float&#x27;&gt;&lt;class &#x27;complex&#x27;&gt;1.0 0.0&lt;class &#x27;complex&#x27;&gt;2.0 1.0&#x27;&#x27;&#x27;\n\n3. å­—ç¬¦ä¸²str = &quot;hello&quot;print(str)print(str[0:])print(str[:5])print(str[:-1])print(str[0:5])print(str[0:5:1])print(str[0:5:2])&#x27;&#x27;&#x27;hellohellohellohellhellohellohlo&#x27;&#x27;&#x27;# formatprint(&quot;My name is &#123;&#125; and age is &#123;&#125;&quot;.format(&quot;tom&quot;, 18))&#x27;&#x27;&#x27;My name is tom and age is 18&#x27;&#x27;&#x27;quantity = 3itemno = 567price = 49.95myorder = &quot;I want to pay &#123;2&#125; dollars for &#123;0&#125; pieces of item &#123;1&#125;.&quot;print(myorder.format(quantity, itemno, price))&#x27;&#x27;&#x27;I want to pay 49.95 dollars for 3 pieces of item 567.&#x27;&#x27;&#x27;# funcstr = &quot;hello world! &quot;print(str.upper())print(str.lower())print(str.strip())print(str + &quot; ...&quot;)&#x27;&#x27;&#x27;HELLO WORLD! hello world! hello world!hello world!  ...&#x27;&#x27;&#x27;# formatmyorder = &quot;I have a &#123;carname&#125;, it is a &#123;model&#125;.&quot;print(myorder.format(carname=&quot;Ford&quot;, model=&quot;Mustang&quot;))&#x27;&#x27;&#x27;I have a Ford, it is a Mustang.&#x27;&#x27;&#x27;\n\n4. lambdaå…¶å®å°±æ˜¯ä¸€ä¸ªfunc\ndef add(num):    return lambda x: x + numprint(add(10)(10))&#x27;&#x27;&#x27;20&#x27;&#x27;&#x27;\n\nlanbda ä¾‹å­2\nimport jsonclass Obj:    def __init__(self):        self.name = &quot;tom&quot;        self.age = 1print(json.dumps(Obj(), default=lambda obj: obj.__dict__))&#x27;&#x27;&#x27;&#123;&quot;name&quot;: &quot;tom&quot;, &quot;age&quot;: 1&#125;&#x27;&#x27;&#x27;\n\né›†åˆlist, tuple, range, dict, set, frozenset\n\nlist , ä¾‹å¦‚: mylist = [&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;]\ntuple æ˜¯ç‰¹æ®Šçš„æ•°ç»„ï¼Œå°±æ˜¯ä¸èƒ½æ”¹å˜ï¼Œ ä¾‹å¦‚ mytuple = (&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;)\nrange å¯ä»¥ç†è§£æ˜¯ä¸ªè¿­ä»£å™¨, ä¾‹å¦‚ï¼š \ndict å°±æ˜¯ä¸ªmapï¼Œ ä¾‹å¦‚ï¼š thisdict = &#123;&quot;brand&quot;: &quot;Ford&quot;, &quot;model&quot;: &quot;Mustang&quot;, &quot;year&quot;: 1964&#125;\nset å°±æ˜¯ä¸ªå»é‡å¤çš„list , ä¾‹å¦‚ï¼š myset = &#123;&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;&#125;\n\n1. listmylist = [&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;]# åˆ‡ç‰‡print(mylist[0])print(mylist[2])print(mylist[-1])print(mylist[0:3:2])&#x27;&#x27;&#x27;applecherrycherry[&#x27;apple&#x27;, &#x27;cherry&#x27;]&#x27;&#x27;&#x27;# åŸºæœ¬æ“ä½œmylist.append(&quot;orange&quot;)print(mylist)&#x27;&#x27;&#x27;[&#x27;apple&#x27;, &#x27;banana&#x27;, &#x27;cherry&#x27;, &#x27;orange&#x27;]&#x27;&#x27;&#x27;mylist.insert(0, &quot;mango&quot;)print(mylist)&#x27;&#x27;&#x27;[&#x27;mango&#x27;, &#x27;apple&#x27;, &#x27;banana&#x27;, &#x27;cherry&#x27;, &#x27;orange&#x27;]&#x27;&#x27;&#x27;# å¾ªç¯for x in mylist:    print(x)&#x27;&#x27;&#x27;applebananacherryorange&#x27;&#x27;&#x27;for index in range(len(mylist)):    print(&quot;index: %d&quot; % index)&#x27;&#x27;&#x27;index: 0index: 1index: 2index: 3index: 4&#x27;&#x27;&#x27;if &quot;apple&quot; in mylist:    print(&quot;success!&quot;)&#x27;&#x27;&#x27;success!&#x27;&#x27;&#x27;# [æ‰§è¡Œè¡¨è¾¾å¼(ä¹Ÿå°±æ˜¯forå¾ªç¯ä¸­çš„ï¼Œå¦‚æœæœ‰ifåˆ™æ˜¯ifä¸­æ‰§è¡Œçš„), for item in list æ¡ä»¶è¡¨è¾¾å¼]new_list = [elem.upper() for elem in mylist if &quot;a&quot; in elem]  # contains &#x27;a&#x27; char elem strprint(new_list)&#x27;&#x27;&#x27;[&#x27;MANGO&#x27;, &#x27;APPLE&#x27;, &#x27;BANANA&#x27;, &#x27;ORANGE&#x27;]&#x27;&#x27;&#x27;newList = []for elem in mylist:    if &#x27;a&#x27; in elem:        newList.append(elem.upper())print(newList)&#x27;&#x27;&#x27;[&#x27;MANGO&#x27;, &#x27;APPLE&#x27;, &#x27;BANANA&#x27;, &#x27;ORANGE&#x27;]&#x27;&#x27;&#x27;\n\n2. mapthisdict = &#123;&quot;brand&quot;: &quot;Ford&quot;, &quot;model&quot;: &quot;Mustang&quot;, &quot;year&quot;: 1964&#125;for key, value in thisdict.items():    print(&quot;key: &#123;&#125;, value: &#123;&#125;&quot;.format(key, value))&#x27;&#x27;&#x27;key: brand, value: Fordkey: model, value: Mustangkey: year, value: 1964&#x27;&#x27;&#x27;for key in thisdict:    print(&quot;key: &#123;&#125;, value: &#123;&#125;&quot;.format(key, thisdict[key]))&#x27;&#x27;&#x27;key: brand, value: Fordkey: model, value: Mustangkey: year, value: 1964&#x27;&#x27;&#x27;\n\n3. range# range ä¼šç”Ÿæˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œ(start,end,sep) ï¼Œ å·¦é—­å³å¼€for x in range(6):  # [0,1,2,3,4,5]    print(&quot;x is %d&quot; % x)&#x27;&#x27;&#x27;x is 0x is 1x is 2x is 3x is 4x is 5&#x27;&#x27;&#x27;for x in range(2, 6):    print(&quot;x is %d&quot; % x)&#x27;&#x27;&#x27;x is 2x is 3x is 4x is 5&#x27;&#x27;&#x27;for x in range(1, 6, 2):    print(&quot;x is %d&quot; % x)&#x27;&#x27;&#x27;x is 1x is 3x is 5&#x27;&#x27;&#x27;\n\næ–¹æ³•1. å®šä¹‰ä¸€ä¸ªç©ºæ–¹æ³•def func_1():    pass  # ç©ºæ–¹æ³•å¿…é¡»ç”³æ˜passfunc_1()\n\n2. å‚æ•°# name ä¸ºå¿…é¡»æ·»çš„å‚æ•°ï¼Œä¸ç„¶ä¸ºç©ºä¼šæŠ¥é”™# age ä¸ºé»˜è®¤å‚æ•°# agrs ä¸ºå¯å˜å‚æ•°# kwargs ä¸º k v å‚æ•°def func_1(name, age=1, *args, **kwargs):    print(&quot;name: %s&quot; % name)    print(&quot;age: %d&quot; % age)    print(&quot;len(args): &#123;&#125;, type: &#123;&#125;&quot;.format(len(args), type(args)))    for value in args:        print(&quot;args value: &#123;&#125;&quot;.format(value))    print(&quot;len(kwargs): &#123;&#125;, type: &#123;&#125;&quot;.format(len(kwargs), type(kwargs)))    for key, value in kwargs.items():        print(&quot;kwargs key: &#123;&#125;, value: &#123;&#125;&quot;.format(key, value))func_1(name=&quot;tom&quot;, age=10, args=&quot;1&quot;, kwargs=&quot;2&quot;)&#x27;&#x27;&#x27;name: tomage: 10len(args): 0len(kwargs): 0, type: &lt;class &#x27;tuple&#x27;&gt;len(kwargs): 2, type: &lt;class &#x27;dict&#x27;&gt;kwargs key: args, value: 1kwargs key: kwargs, value: 2&#x27;&#x27;&#x27;# è¿™é‡Œæ³¨æ„ç”±äºdictæ‰€ä»¥ä¸èƒ½ç”³æ˜kvfunc_1(&quot;tom&quot;, 10, &quot;1&quot;, &quot;2&quot;, args=&quot;1&quot;, kwargs=&quot;2&quot;)&#x27;&#x27;&#x27;name: tomage: 10len(args): 2, type: &lt;class &#x27;tuple&#x27;&gt;args value: 1args value: 2len(kwargs): 2, type: &lt;class &#x27;dict&#x27;&gt;kwargs key: args, value: 1kwargs key: kwargs, value: 2&#x27;&#x27;&#x27;\n\n3. ç±»å‹\nç”³æ˜è¾“å…¥è¾“å‡ºç±»å‹\n\nfrom typing import List, Uniondef decode_raw_args(    args: List[Union[str, bytes]],    stdin_encoding: str) -&gt; List[str]:    &quot;&quot;&quot;    Convert all bytes args to str    by decoding them using stdin encoding.    &quot;&quot;&quot;    return [        arg.decode(stdin_encoding)        if type(arg) is bytes else arg        for arg in args    ]\n\nç±»1. å®šä¹‰ç±»å’Œæ–¹æ³•# å¦‚æœæ²¡æœ‰çˆ¶ç±»ç»§æ‰¿ï¼Œè¿™é‡Œé€‰æ‹© objectï¼Œæ¯”è¾ƒè§„èŒƒclass Person(object):    # gender none, male or female    gender = &quot;none&quot;    # æ„é€ å™¨    def __init__(self, name, age):        self.name = name        self.age = age    def my_name(self):        return self.namep = Person(name=&quot;tome&quot;, age=1)print(p.my_name())\n\n2. ç±»å‹çš„ç»§æ‰¿import jsonclass Person(object):    # gender none, male or female    gender = &quot;none&quot;    # æ„é€ å™¨    def __init__(self, name, age):        self.name = name        self.age = age    def my_name(self):        return self.namep = Person(name=&quot;tome&quot;, age=1)print(p.my_name())class Mail(Person):    def __init__(self, name, age):        super(Mail, self).__init__(name, age)        self.gender = &quot;mail&quot;    def my_name(self):        return self.name + &quot;_mail&quot;p = Mail(name=&quot;tome&quot;, age=1)print(json.dumps(p, default=lambda obj: obj.__dict__))print(p.my_name())\n\n3. ç±» __new__ å‡½æ•°\nä¸»è¦æ˜¯__init__ æ‰§è¡Œå‰ä¼šè°ƒç”¨\n\n#!/usr/bin/pythonimport jsonclass Person(object):    def __new__(cls, *args, **kwargs):        instance = object.__new__(cls)        instance.job = &quot;it&quot;        return instance    # construct    def __init__(self, name, age):        self.name = name        self.age = age    def to_json(self):        return json.dumps(self, default=lambda obj: obj.__dict__)p = Person(name=&quot;tome&quot;, age=1)print(p.to_json()) # &#123;&quot;age&quot;: 1, &quot;job&quot;: &quot;it&quot;, &quot;name&quot;: &quot;tome&quot;&#125;\n\n\n\nå…¶ä»–ç”¨æ³•æŠ€å·§1. æ–­è¨€if type(1) is int:    print(&quot;args is int&quot;)    ...  # ç­‰æ•ˆ pass&#x27;&#x27;&#x27;args is int&#x27;&#x27;&#x27;\n\n2.  æµ‹è¯• &lt;&lt;&lt;å¯ä»¥å‚è€ƒæ–‡ä»¶: https://segmentfault.com/q/1010000010389542 , å±äºdoctest\ndef humanize_bytes(n, precision=2):    # Author: Doug Latornell    # Licence: MIT    # URL: https://code.activestate.com/recipes/577081/    &quot;&quot;&quot;Return a humanized string representation of a number of bytes.    &gt;&gt;&gt; humanize_bytes(1)    &#x27;1 B&#x27;    &gt;&gt;&gt; humanize_bytes(1024, precision=1)    &#x27;1.0 kB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 123, precision=1)    &#x27;123.0 kB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 12342, precision=1)    &#x27;12.1 MB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 12342, precision=2)    &#x27;12.05 MB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 1234, precision=2)    &#x27;1.21 MB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 1234 * 1111, precision=2)    &#x27;1.31 GB&#x27;    &gt;&gt;&gt; humanize_bytes(1024 * 1234 * 1111, precision=1)    &#x27;1.3 GB&#x27;    &quot;&quot;&quot;    abbrevs = [        (1 &lt;&lt; 50, &#x27;PB&#x27;),        (1 &lt;&lt; 40, &#x27;TB&#x27;),        (1 &lt;&lt; 30, &#x27;GB&#x27;),        (1 &lt;&lt; 20, &#x27;MB&#x27;),        (1 &lt;&lt; 10, &#x27;kB&#x27;),        (1, &#x27;B&#x27;)    ]    if n == 1:        return &#x27;1 B&#x27;    for factor, suffix in abbrevs:        if n &gt;= factor:            break    # noinspection PyUnboundLocalVariable    return f&#x27;&#123;n / factor:.&#123;precision&#125;f&#125; &#123;suffix&#125;&#x27;\n\n3. yield\nå‚è€ƒ: https://zhuanlan.zhihu.com/p/268605982\n\nå…¶å®ç±»ä¼¼äºç¨‹åºçš„æ–­ç”µï¼Œæ¯”å¦‚ç¨‹åºè¿è¡Œåˆ°é‚£é‡Œå…¶å®æ˜¯è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œç„¶åå½“ä½ ä¸‹ä¸€æ­¥æ˜¯æ‰ä¼šæ‰§è¡Œï¼Œæ¯”è¾ƒèŠ‚çœå†…å­˜\nfrom typing import Listdef new(size: int = 1024 * 1024):    yield new_data(size)def new_data(size: int) -&gt; List[int]:    return [0] * sizedata = new()print(type(data))print(len(next(data)))  # åªèƒ½æ‰§è¡Œä¸€æ¬¡ nextä¸ç„¶æŠ¥é”™&#x27;&#x27;&#x27;&lt;class &#x27;generator&#x27;&gt;1048576&#x27;&#x27;&#x27;\n\n\n\nè„šæœ¬base64è¾“å‡ºecho &quot;aGVsbG8gcHl0aG9uCg==&quot; | python -c &quot;import sys,base64; print(sys.stdin.read())&quot;-&gt;echo &quot;aGVsbG8gcHl0aG9uCg==&quot; | python -c &quot;import sys,base64; print(base64.b64decode(sys.stdin.read()))&quot;-&gt; stdout:b&#x27;hello python\\n&#x27;\n\næ–‡ä»¶æ“ä½œ\nr , w, x ,aå››ç§ç±»å‹(a: append, w=truncate+create, x=truncate+create if not exit)\nb,t æ–‡ä»¶ç±»å‹\n\nç¬¬ä¸€åˆ—å¯ä»¥å’Œç¬¬äºŒåˆ—æ–‡ä»¶ç±»å‹ç»„åˆï¼Œç¬¬ä¸€åˆ—ä¸å…è®¸å¹¶å­˜\nimport oswith open(&quot;file.log&quot;, &quot;w&quot;) as file:    for x in range(0, 100):        file.write(&quot;hello world&quot;+os.linesep)with open(&quot;file.log&quot;,&quot;r&quot;) as file:    for line in file.readlines():        print(line)\n\njsonimport jsonprint(json.dumps(&#123;&quot;k1&quot;: &quot;v1&quot;, &quot;k2&quot;: [1, 2, 3]&#125;))print(json.loads(&#x27;&#123;&quot;k1&quot;: &quot;v1&quot;, &quot;k2&quot;: [1, 2, 3]&#125;&#x27;))\n\nå¦‚æœæ˜¯classï¼Œéœ€è¦ç»§æ‰¿ JSONEncoderå’ŒJSONDecoderå®ç°å­ç±» ï¼Œæˆ–è€…\nimport json, datetimeclass Demo(object):    def __init__(self, name: str, age: int, birthday: datetime.date):        self.name = name        self.agw = age        self.birthday = birthday    def to_json(self, _):        return &#123;&quot;name&quot;: self.name, &quot;age&quot;: self.agw, &quot;birthday&quot;: self.birthday.strftime(&quot;%Y-%m-%d&quot;)&#125;data = Demo(&quot;tom&quot;, 18, datetime.date(2001, 1, 1))print(json.dumps(data, default=data.to_json))\n\ntyping (ç”³æ˜ç±»å‹)å®˜æ–¹æ–‡æ¡£ï¼š https://docs.python.org/zh-cn/3/library/typing.html\nå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š https://sikasjc.github.io/2018/07/14/type-hint-in-python/\nå¯¹äºå–œæ¬¢é™æ€ç±»å‹çš„è¯­è¨€ï¼Œæˆ‘è§‰å¾—æ˜¯éå¸¸niceçš„\nfrom typing import Dict, Listdef test(data: Dict[str, str]) -&gt; List[str]:    return [x for x in data]print(test(&#123;&quot;k1&quot;: &quot;v1&quot;, &quot;k2&quot;: &quot;v2&quot;&#125;))\n\n","categories":["Python"],"tags":["Python"]},{"title":"Java-ThreadLocalå’ŒInheritableThreadLocalçš„å±€é™æ€§ä»¥åŠå¦‚ä½•åœ¨çº¿ç¨‹æ± æ¨¡å‹ä¸­ä¼ é€’ä¸Šä¸‹æ–‡","url":"/2021/03/10/4d9d26e79dde722bc37676b188b2f254/","content":"è·¨çº¿ç¨‹ä½¿ç”¨ThreadLocal å¦‚ä½•åšï¼Ÿï¼Ÿï¼Ÿ\n\n\nThreadLocal1ã€ä½¿ç”¨@Testpublic void testThreadLocal() &#123;    final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;();    new Thread(            () -&gt; &#123;                threadLocal.set(Thread.currentThread().getName());                System.out.println(&quot;current thread: &quot; + threadLocal.get()); // current thread: thread-1                threadLocal.remove();            &#125;            , &quot;thread-1&quot;)            .start();    new Thread(            () -&gt; &#123;                threadLocal.set(Thread.currentThread().getName());                System.out.println(&quot;current thread: &quot; + threadLocal.get()); // current thread: thread-2                threadLocal.remove();            &#125;            , &quot;thread-2&quot;)            .start();&#125;\n\næ‰§è¡Œ\ncurrent thread: thread-1current thread: thread-2\n\nå¯ä»¥çœ‹åˆ°çº¿ç¨‹æ˜¯å¯ä»¥æ‹¿åˆ° threadlocalä¸­çš„å˜é‡\n2ã€threadlocalæ˜¯å¦è·¨çº¿ç¨‹ï¼Ÿ@Testpublic void testThreadLocalWithChild() &#123;    final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;();    new Thread(            () -&gt; &#123;                threadLocal.set(Thread.currentThread().getName());                System.out.println(&quot;current thread: &quot; + threadLocal.get()); // current thread: thread-1                new Thread(() -&gt; &#123;                    System.out.println(&quot;child thread current thread: &quot; + threadLocal.get()); // child thread current thread: null                &#125;, &quot;thread-child-1&quot;).start();                threadLocal.remove();            &#125;            , &quot;thread-1&quot;)            .start();&#125;\n\nè¾“å‡º\ncurrent thread: thread-1current thread: thread-2\n\nå¯ä»¥çœ‹åˆ°è·¨çº¿ç¨‹åï¼Œæˆ‘ä»¬æ— æ³•æ‹¿åˆ°çˆ¶äº²çº¿ç¨‹çš„å˜é‡ï¼Œæ‰€ä»¥threadæ— æ³•è§£å†³è·¨çº¿ç¨‹\n3ã€é—®é¢˜\nä½¿ç”¨ç®€å•ï¼Œæ¨¡å‹ç®€å•ï¼Œå¦‚æœæ™®é€šä¸šåŠ¡å®Œå…¨æ»¡è¶³ï¼Œå¯¹äºæ²¡æœ‰å¼‚æ­¥æ“ä½œçš„ä¸šåŠ¡éƒ½æ»¡è¶³\nå±€é™æ€§å°±æ˜¯å¤šçº¿ç¨‹å¼‚æ­¥æ“ä½œï¼\n\nInheritableThreadLocal1ã€ç®€å•å®ç”¨\nâ€‹    å®ƒå¯ä»¥ä¼ é€’çˆ¶çº¿ç¨‹çš„å˜é‡\n\n@Testpublic void testInheritableThreadLocal() &#123;    final InheritableThreadLocal&lt;Object&gt; threadLocal = new InheritableThreadLocal&lt;&gt;();    threadLocal.set(Thread.currentThread().getName());    Thread thread = new Thread(() -&gt; &#123;        System.out.println(&quot;current thread: &quot; + threadLocal.get());//current thread: main    &#125;);    thread.start();&#125;\n\nè¾“å‡º\ncurrent thread: main\n\nå¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥æ‹¿åˆ°ç»“æœçš„ï¼Œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ\n2ã€InheritableThreadLocal åŸç†1ã€OBJECT_INHERITABLE_THREAD_LOCAL.set(Thread.currentThread().getName()); åˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆ\njava.lang.ThreadLocal#set æ–¹æ³•ï¼š\npublic void set(T value) &#123;// è·å–å½“å‰çº¿ç¨‹ä¸ºmain    Thread t = Thread.currentThread();// å»è·å–å½“å‰çº¿ç¨‹çš„map -&gt; t.threadLocals  æ˜¾ç„¶æ˜¯æ²¡æœ‰ï¼Œå› ä¸ºæ²¡æœ‰threadlocalå»ç»‘å®šåˆ°mainçº¿ç¨‹é‡Œ    ThreadLocalMap map = getMap(t);    if (map != null)      // æœ‰çš„è¯ï¼Œå°±è®¾ç½® thradlocal=&gt;value        map.set(this, value);    else    // å»åˆ›å»ºä¸€ä¸ªmap        createMap(t, value);&#125;\n\njava.lang.InheritableThreadLocal#createMap é‡å†™äº† java.lang.ThreadLocal#createMap \n# java.lang.ThreadLocal#createMapvoid createMap(Thread t, T firstValue) &#123;  // t.threadLocals  è¿›è¡Œèµ‹å€¼ï¼Œæ˜¾ç„¶æ˜¯çº¿ç¨‹æ†ç»‘å¯¹è±¡ç½¢äº†    t.threadLocals = new ThreadLocalMap(this, firstValue);&#125;void createMap(Thread t, T firstValue) &#123;    t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue);&#125;\n\nç»“è®ºå°±æ˜¯ï¼ŒinheritableThreadLocalè¿›è¡Œsetçš„æ—¶å€™ä¼šåƒthreadçº¿ç¨‹ç»‘å®šä¸€ä¸ª k-v å¯¹è±¡ï¼Œkå°±æ˜¯ inheritableThreadLocal , vå°±æ˜¯æˆ‘ä»¬è¦çš„å¯¹è±¡ï¼Œç„¶åå¦‚æœçº¿ç¨‹çš„ inheritableThreadLocals ä¸ºç©ºå°±åˆå§‹åŒ–ä¸€ä¸‹ã€‚æ³¨æ„ThreadLocalMapé‡Œæœ‰è¶£çš„WeakReferenceï¼Œå€¼å¾—æµ‹è¯•ä¸€å“ˆï¼Œå¦‚æœçœŸçš„å†…å­˜æ»¡äº†ï¼Œä¼šå›æ”¶çº¿ç¨‹çš„å˜é‡ä¹ˆï¼Ÿ\n2ã€new Thread()\npublic Thread(Runnable target) &#123;        init(null, target, &quot;Thread-&quot; + nextThreadNum(), 0);&#125;\n\nç»§ç»­\nprivate void init(ThreadGroup g, Runnable target, String name,                  long stackSize) &#123;    init(g, target, name, stackSize, null, true);&#125;\n\nç»§ç»­\nprivate void init(ThreadGroup g, Runnable target, String name,                  long stackSize, AccessControlContext acc,                  boolean inheritThreadLocals) &#123;    if (name == null) &#123;        throw new NullPointerException(&quot;name cannot be null&quot;);    &#125;    this.name = name;    Thread parent = currentThread(); \t\t/// ................çœç•¥  \t  // å¦‚æœæ”¯æŒinheritThreadLocals &amp;&amp; çˆ¶çº¿ç¨‹çš„inheritableThreadLocalsä¸ä¸ºç©ºï¼Œæ˜¾ç„¶è°ƒç”¨è¿‡java.lang.InheritableThreadLocal#setæ˜¯ä¼šè¿›è¡Œåˆå§‹åŒ–çš„    if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null)      // è®¾ç½®å½“å‰çº¿ç¨‹çš„inheritableThreadLocalsä¸ºçˆ¶ç±»çš„ï¼Œä¸‹é¢å…¶å®å°±æ˜¯ä¸€ä¸ªmapæ‹·è´        this.inheritableThreadLocals =            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);    /* Stash the specified stack size in case the VM cares */    this.stackSize = stackSize;    /* Set thread ID */    tid = nextThreadID();&#125;\n\n3ã€å±€é™æ€§æµ‹è¯•1ã€æµ‹è¯•æ˜¯å¦æ”¯æŒçº¿ç¨‹ä¼ é€’\n@Testpublic void testInheritableThreadLocalQuestion() throws InterruptedException &#123;    final InheritableThreadLocal&lt;Object&gt; threadLocal = new InheritableThreadLocal&lt;&gt;();    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(2, 10, 1000000, TimeUnit.SECONDS, new SynchronousQueue&lt;&gt;());    threadPoolExecutor.execute(() -&gt; &#123;        // çˆ¶çº¿ç¨‹setä¸€ä¸ªå˜é‡        threadLocal.set(&quot;parent&quot;);        threadPoolExecutor.execute(() -&gt; &#123;            // å­çº¿ç¨‹å»æ‹¿ï¼Œæœ€åç§»é™¤            System.out.println(&quot;child get thread name: &quot; + threadLocal.get());            threadLocal.remove();        &#125;);        // æœ€åçˆ¶çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å»åˆ é™¤å½“å‰çº¿ç¨‹å˜é‡        threadLocal.remove();    &#125;);    if (!threadPoolExecutor.awaitTermination(5, TimeUnit.SECONDS)) &#123;        threadPoolExecutor.shutdown();    &#125;&#125;\n\nè¾“å‡ºï¼š child get thread name: parent\nè¿™ä¸ªç°è±¡æ˜¾ç„¶æ˜¯æ”¯æŒçº¿ç¨‹ä¼ é€’çš„ï¼Œå› ä¸ºåœ¨ä¼ é€’è¿‡ç¨‹ä¸­å‡ºç°äº†åˆ›å»ºçº¿ç¨‹ï¼Œæ‰§è¡Œç¬¬äºŒä¸ªexecuteæ—¶å‡ºç°äº†çº¿ç¨‹æ± æ²¡æœ‰çº¿ç¨‹ï¼Œç„¶åå»åˆ›å»ºä¸€ä¸ªï¼Œå°±å¯ä»¥ä¼ é€’äº†ï¼ŒçœŸå®ä¸­çº¿ç¨‹æ± æ˜¯åŸºæœ¬ä¿æ´»çš„\n2ã€å†æ¬¡æ¨¡æ‹Ÿ\n@Testpublic void testInheritableThreadLocalQuestion2() throws InterruptedException &#123;    final InheritableThreadLocal&lt;Object&gt; threadLocal = new InheritableThreadLocal&lt;&gt;();    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(2, 2, 1000000, TimeUnit.SECONDS, new SynchronousQueue&lt;&gt;());    // åˆå§‹åŒ–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹    threadPoolExecutor.execute(() -&gt; &#123;        try &#123;            TimeUnit.SECONDS.sleep(1);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;);    threadPoolExecutor.execute(() -&gt; &#123;        try &#123;            TimeUnit.SECONDS.sleep(1);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;);    TimeUnit.SECONDS.sleep(2);    // æµ‹è¯•    threadPoolExecutor.execute(() -&gt; &#123;        threadLocal.set(&quot;parent&quot;);        threadPoolExecutor.execute(() -&gt; &#123;            System.out.println(&quot;child get thread name: &quot; + threadLocal.get());            threadLocal.remove();        &#125;);        threadLocal.remove();    &#125;);    if (!threadPoolExecutor.awaitTermination(5, TimeUnit.SECONDS)) &#123;        threadPoolExecutor.shutdown();    &#125;&#125;\n\nè¾“å‡ºï¼š\nchild get thread name: null\n\nå¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœä¸ºnullï¼Œæ˜¯å› ä¸ºåœ¨æ‰§è¡Œæµ‹è¯•ä»»åŠ¡çš„ç¬¬äºŒä¸ªexecuteçš„æ—¶å€™æ²¡æœ‰åˆ›å»ºçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿä¼ é€’\n4ã€é—®é¢˜\nè™½ç„¶InheritableThreadLocalå¯ä»¥è§£å†³è·¨çº¿ç¨‹ä¼ é€’çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒçš„å±€é™æ€§å°±æ˜¯åœ¨äºè·¨çº¿ç¨‹æ˜¯å¿…é¡»åˆ›å»ºæ–°çš„çº¿ç¨‹\nä¸šåŠ¡ä¸­é€šå¸¸ä½¿ç”¨çº¿ç¨‹æ± æ¨¡å‹(è¿™é‡Œå°±ä¸åšè§£é‡Šäº†)ï¼Œå¤§å¤šæ•°å®ç°çš„çº¿ç¨‹æ± æ— æ³•æ»¡è¶³è°ƒç”¨æ—¶çº¿ç¨‹é‡å¤åˆ›å»ºï¼Œæ‰€ä»¥æ— æ³•\n\nçº¿ç¨‹æ± å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ï¼Ÿå‚è€ƒGolangä¸­çš„context.Contextçš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°å¦‚æœä¾èµ–ThreadLocal å’Œ  InheritableThreadLocal æ˜¯ä¸è§£å†³é—®é¢˜çš„ï¼Œé™¤éæˆ‘ä»¬ä¿®æ”¹äº† ThreadPoolExecutor çš„æºç ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå°†çº¿ç¨‹å˜é‡ä¼ é€’è¿›å»ï¼Œå…¶å®ä¹Ÿåªèƒ½é€šè¿‡ Runnableå‡½æ•°è¿›è¡Œä¼ é€’äº†ï¼Œå› ä¸ºå¯¹äºçº¿ç¨‹æ± è¿˜æ˜¯çº¿ç¨‹æ¥è¯´ä»–ä»¬éƒ½éœ€è¦ä¼ é€’ Runnableå‡½æ•°ï¼Œæ‰€ä»¥è€ƒè™‘è¿™ä¸ªé€šç”¨æ€§æœ€å¥½ï¼\n1ã€ä»£ç å®ç°\nâ€‹    å±€é™æ€§å°±æ˜¯ä¾èµ–å‚æ•°ä¼ é€’ThreadLocalï¼Œæ‰€ä»¥åæœŸå¯ä»¥è€ƒè™‘åŠ å…¥å¤šä¸ªThreadLocal æˆ–è€… ä¸šåŠ¡ä¸­é€šå¸¸ä¾èµ–äºSpringè¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥å¯ä»¥å¯¹ThreadLocalè¿›è¡Œbeançš„æ³¨å…¥ï¼Œå…¨å±€ä½¿ç”¨springçš„beanè¿›è¡Œåˆå§‹åŒ–ThreadLocalRunnableï¼Œé‚£ä¹ˆå‚æ•°ä¼ é€’å…¶å®åªéœ€è¦ä¸€ä¸ªApplicationContext\n\nprivate static class ThreadLocalRunnable&lt;T&gt; implements Runnable &#123;    private ThreadLocal&lt;T&gt; local;    private T args;    private Runnable runnable;    public ThreadLocalRunnable(ThreadLocal&lt;T&gt; local, Runnable runnable) &#123;        if (local == null || runnable == null) &#123;            throw new RuntimeException(&quot;new ThreadLocalRunnable find args has null arg&quot;);        &#125;        this.local = local;        // åˆå§‹åŒ–çš„æ—¶å€™è·å–ç»‘å®šçš„çº¿ç¨‹å˜é‡        this.args = local.get();        this.runnable = runnable;    &#125;    /**     * è¢«newçš„çº¿ç¨‹/çº¿ç¨‹æ± ä¸­è°ƒåº¦çš„çº¿ç¨‹è°ƒç”¨     */    @Override    public void run() &#123;        try &#123;            // è®¾ç½®ç»‘å®šçš„çº¿ç¨‹å˜é‡            local.set(args);            runnable.run();        &#125; finally &#123;            // ç§»é™¤ç»‘å®šçš„çº¿ç¨‹å˜é‡            local.remove();        &#125;    &#125;&#125;\n\n2ã€æµ‹è¯•ä»£ç @Testpublic void testThreadLocalRunnable() throws InterruptedException &#123;    final ThreadLocal&lt;Object&gt; threadLocal = new ThreadLocal&lt;&gt;();    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(2, 2, 1000000, TimeUnit.SECONDS, new SynchronousQueue&lt;&gt;());    // åˆå§‹åŒ–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹    threadPoolExecutor.execute(() -&gt; &#123;        try &#123;            TimeUnit.SECONDS.sleep(1);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;);    threadPoolExecutor.execute(() -&gt; &#123;        try &#123;            TimeUnit.SECONDS.sleep(1);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;);    TimeUnit.SECONDS.sleep(2);    threadLocal.set(&quot;my name is main&quot;);    // æµ‹è¯•    threadPoolExecutor.execute(new ThreadLocalRunnable&lt;&gt;(threadLocal, () -&gt; &#123;        System.out.println(&quot;parent get thread name: &quot; + threadLocal.get());        threadLocal.set(&quot;my name is parent&quot;);        threadPoolExecutor.execute(new ThreadLocalRunnable&lt;&gt;(threadLocal, () -&gt; &#123;            System.out.println(&quot;child get thread name: &quot; + threadLocal.get());            threadLocal.remove();        &#125;));        threadLocal.remove();    &#125;));    if (!threadPoolExecutor.awaitTermination(5, TimeUnit.SECONDS)) &#123;        threadPoolExecutor.shutdown();    &#125;&#125;\n\nè¾“å‡º\nparent get thread name: my name is mainchild get thread name: my name is parent\n\n3ã€å‚è€ƒ springçš„ ThreadPoolTaskExecutorå…¶å®å°±æ˜¯ä¸€ä¸ªåŒ…è£…æ¨¡å¼çš„ä½¿ç”¨ï¼Œç»™ä½ ä¸€ä¸ªRunnableï¼Œç„¶åä½ å»åŒ…è£…ä¸€ä¸ªRunnableï¼Œä¾é é—­åŒ…å»å®ç°ï¼\n@Configurationpublic class Config &#123;    @Bean    public Executor executor() &#123;        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();        executor.setThreadNamePrefix(ASYNC_EXECUTOR_NAME);        executor.setCorePoolSize(5);        executor.setMaxPoolSize(5);        executor.setQueueCapacity(-1);        // è¿™é‡Œåœ¨æ¯æ¬¡å¼‚æ­¥è°ƒç”¨çš„æ—¶å€™, ä¼šåŒ…è£…ä¸€ä¸‹.        executor.setTaskDecorator(runnable -&gt; &#123;            // è¿™ä¸ªæ—¶å€™è¿˜æ˜¯åŒæ­¥çŠ¶æ€            RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();            // è¿”å›çš„è¿™ä¸ª runnableå¯¹è±¡ æ‰æ˜¯å»è°ƒç”¨çº¿ç¨‹æ± .            return () -&gt; &#123;                try &#123;                    // æˆ‘ä»¬set è¿›å» ,å…¶å®æ˜¯ä¸€ä¸ªThreadLocalç»´æŠ¤çš„.                    RequestContextHolder.setRequestAttributes(requestAttributes);                    runnable.run();                &#125; finally &#123;                    // æœ€åè®°å¾—é‡Šæ”¾å†…å­˜                    RequestContextHolder.resetRequestAttributes();                &#125;            &#125;;        &#125;);        return executor;    &#125;&#125;\n\n","categories":["Java"],"tags":["ThreadLocal","InheritableThreadLocal","çº¿ç¨‹æ± "]},{"title":"Cgoå­¦ä¹ ","url":"/2023/05/04/563272b471b5af82d27c85596b1e6342/","content":"Cgo çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç»§æ‰¿C/C++ç§¯ç´¯äº†åŠä¸ªä¸–çºªçš„è½¯ä»¶è´¢å¯Œï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„åœ¨Goé¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›è´¢å¯Œï¼å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ ï¼Œæœ¬æ–‡ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Cgoï¼Œå¦‚ä½•å°†C++é¡¹ç›®é›†æˆåˆ°Goä¸­ï¼Œæœ‰å…´è¶£å¯ä»¥ç›´æ¥çœ‹æˆ‘è‡ªå·±ç”¨Cgoå†™çš„ä¸€ä¸ªé¡¹ç›®ï¼Œæˆç†Ÿåº¦è¿˜å¯ä»¥: https://github.com/anthony-dong/protobuf\n\n\nCgo çœŸçš„å®Œç¾å—Cgo é¡¾åæ€ä¹‰ï¼Œæ˜¯Cä¸GOçš„ä¸€ä¸ªæ¡¥æ¢ï¼Œä½†æ˜¯Cä¸GOçš„è°ƒåº¦æ¨¡å‹ã€å†…å­˜æ¨¡å‹ä¸å¤ªä¸€æ ·ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªæ¡¥æ¢ä¼šæœ‰ä¸€äº›æ€§èƒ½ã€å†…å­˜æŸè€—ï¼Œä¾‹å¦‚Goçš„ç”¨æˆ·ä»£ç éƒ½è·‘åœ¨goroutine(æœ‰æ ˆåç¨‹)ä¸­ï¼Œä½†æ˜¯Cè·‘åœ¨åŸç”Ÿçš„çº¿ç¨‹ä¸­ï¼Œå°±ä¼šå¯¼è‡´è¦è¿›è¡Œä¸€æ¬¡çº¿ç¨‹çš„åˆ‡æ¢ï¼Œç”± goroutine -&gt; Native-Thread -&gt; goroutine ï¼Œæ‰€ä»¥åº”è¯¥å°½é‡é¿å…ä½¿ç”¨ä¸€äº›è€—æ—¶æ¯”è¾ƒé•¿çš„cç¨‹åºï¼\nTODOï¼šåç»­è¡¥å……JNIçš„æ€§èƒ½å¼€é”€ï¼ï¼\nä¸‹é¢æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ç®€å•çš„Goå’ŒCgoå·®å¼‚\npackage test/*int sum_c (int x, int y)&#123;\treturn x + y ;&#125;*/import &quot;C&quot;func sum(x, y int) int &#123;\treturn x + y&#125;func sum_c(x, y int) int &#123;\treturn int(C.sum_c(C.int(x), C.int(y)))&#125;\n\næ¥çœ‹ä¸‹benchmarkçš„ç»“æœï¼Œ\ngoos: linuxgoarch: amd64pkg: github.com/anthony-dong/protobuf/internal/pb_gencpu: Intel(R) Xeon(R) Platinum 8260 CPU @ 2.40GHzBenchmarkSUMBenchmarkSUM-8     \t1000000000\t         0.3557 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM-8     \t1000000000\t         0.3567 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM-8     \t1000000000\t         0.3626 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM-8     \t1000000000\t         0.3588 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM-8     \t1000000000\t         0.3540 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM_CBenchmarkSUM_C-8   \t14440388\t        79.73 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM_C-8   \t15093638\t        85.74 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM_C-8   \t14932076\t        85.33 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM_C-8   \t14808447\t        79.42 ns/op\t       0 B/op\t       0 allocs/opBenchmarkSUM_C-8   \t13486689\t        78.92 ns/op\t       0 B/op\t       0 allocs/opPASSok  \tgithub.com/anthony-dong/protobuf/internal/pb_gen\t8.531s\n\nç»“è®ºå°±æ˜¯ \n\nå¤§æ¦‚è°ƒåº¦ä¸Šæ˜¯3ä¸ªæ•°é‡çº§çš„æŸè€—ï¼Œå·®è·è¿‘åƒå€ï¼æ‰€ä»¥CGOä¸é€‚åˆåšé‚£ç§ç®€å•çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¦‚æœä»£ç å¯ä»¥å¾ˆç®€å•çš„é€šè¿‡Goç¨‹åºå®ç°ï¼Œé‚£ä¹ˆåŸåˆ™ä¸Šä¸è¦ç”¨CGOå»åšï¼Œé™¤éCæ€§èƒ½è¦è¿œé«˜äºGOæˆ–è€…GOå»å®ç°å¤ªè¿‡äºéº»çƒ¦ï¼\nCGOä½¿ç”¨åŸç”Ÿçš„Nativeçº¿ç¨‹ï¼Œå¦‚æœä½ çš„Cç¨‹åºè€—æ—¶æ¯”è¾ƒä¸¥é‡ï¼Œä¸”å¹¶å‘è¾ƒé«˜ï¼Œå¯¹äºGOç¨‹åºçš„å½±å“ä¹Ÿä¼šå¾ˆå¤§ï¼\næ³¨æ„GOé‡Œé¢å¯ä»¥é€šè¿‡ debug.SetMaxThreads(10) æ¥è®¾ç½®æœ€å¤§çš„çº¿ç¨‹æ•°ï¼Œä½†æ˜¯å‡å¦‚CGOè°ƒåº¦çš„çº¿ç¨‹ä¸å¤Ÿäº†ï¼Œé‚£ä¹ˆä¼šç›´æ¥ç¨‹åºæŒ‚æ‰ï¼Œæ‰€ä»¥ä¸è¦ä½¿ç”¨ é™åˆ¶æœ€å¤§çº¿ç¨‹æ•°çš„å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡channelç­‰å·¥å…·æ¥é™åˆ¶æœ€å¤§å¹¶å‘æ•°é‡ ï¼\n\n// main.go æ–‡ä»¶/*#include &lt;unistd.h&gt;int sum_c (int x, int y)&#123;\tsleep(60);\treturn x + y ;&#125;*/import &quot;C&quot;func sum_c(x, y int) int &#123;\treturn int(C.sum_c(C.int(x), C.int(y)))&#125;// main_test.gofunc TestCThread(t *testing.T) &#123;\tt.Log(&quot;pid: &quot;, os.Getpid())\tcurrentLock := make(chan bool, 10)\twg := sync.WaitGroup&#123;&#125;\twg.Add(100)\tfor x := 0; x &lt; 100; x++ &#123;\t\tcloneX := x\t\tgo func() &#123;\t\t\tcurrentLock &lt;- true\t\t\tdefer func() &#123;\t\t\t\t&lt;-currentLock\t\t\t\tdefer wg.Done()\t\t\t&#125;()\t\t\tt.Log(&quot;sum-start: &quot;, cloneX)\t\t\ts := sum_c(cloneX, cloneX+1)\t\t\tt.Log(&quot;sum-done: &quot;, cloneX, s)\t\t&#125;()\t&#125;\twg.Wait()&#125;// ps -mq $&#123;pid&#125; | wc -l\n\nç†Ÿæ‚‰CgoåŸºæœ¬å†™æ³•ä¾‹å­ä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯Cä»£ç ï¼ˆæ³¨æ„: å¿…é¡»æ˜¯Cï¼Œä¸èƒ½æ˜¯C++ï¼‰ï¼Œä¸€éƒ¨åˆ†æ˜¯Goä»£ç ï¼Œå…¶æ¬¡ä¸€å®šè¦ import &quot;C&quot;\npackage main/*#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;void c_print_str(const char* str)&#123;\tprintf(&quot;c_print_str: %s\\n&quot;,str);&#125;void c_print_str_size(const char* str,int len)&#123;\tprintf(&quot;c_print_str_size: &quot;);\tfor (int x=0; x&lt;len; x++)&#123;\t\tprintf(&quot;%c&quot;,*str);\t\tstr=str+1;\t&#125;\tprintf(&quot;\\n&quot;);&#125;int c_str_len(const char* str)&#123;\treturn strlen(str);&#125;const char* c_new_str() &#123;   char* str = (char*)malloc(5 * sizeof(char));   str[0] = &#x27;a&#x27;;   str[1] = &#x27;\\0&#x27;;   str[2] = &#x27;b&#x27;;   str[3] = &#x27;\\0&#x27;;   str[4] = &#x27;c&#x27;;   return str;&#125;typedef struct __CStruct &#123;    char* name;    int age;&#125; CStruct;void print_CStruct(CStruct* ss) &#123;    printf(&quot;name: %s, age: %d\\n&quot;, ss-&gt;name, ss-&gt;age);&#125;*/import &quot;C&quot;import (\t&quot;fmt&quot;\t&quot;unsafe&quot;)func main() &#123;\t&#123;\t\t// Cè¯­è¨€ä¸­è®¤ä¸º&#x27;\\0&#x27;æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„ç»“å°¾ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²ä¼šé¢å¤–å¤šä¸€ä¸ªsize(char)æ¥å­˜å‚¨&#x27;\\0&#x27;ï¼Œä½†æ˜¯Goè¯­è¨€ä¸æ˜¯ï¼\t\tgstr := &quot;hello world\\u00001111&quot;\t\t// åˆ›å»ºä¸€ä¸ªCçš„ char* å­—ç¬¦ä¸²ï¼Œè¿™é‡Œä¼šæ¶‰åŠåˆ°ä¸€æ¬¡å†…å­˜çš„æ‹·è´ï¼ŒåŸå› æ˜¯ä¸ºäº†å®‰å…¨ï¼ŒåŒæ—¶ä½ ä¹Ÿéœ€è¦freeæ‰ï¼\t\tcstr := C.CString(gstr)\t\tdefer C.free(unsafe.Pointer(cstr))\t\t// è°ƒç”¨Cå‡½æ•°\t\tC.c_print_str(cstr)\t\tC.c_print_str_size(cstr, C.int(len(gstr)))\t\t// æ³¨æ„: Cä¸­åŸºæœ¬ç±»å‹è½¬æ¢Goç›´æ¥å¼ºè½¬å³å¯ï¼Œæœ€å¥½è½¬æˆå¯¹åº”ç±»å‹\t\tfmt.Println(&quot;int(C.c_str_len(cstr)): &quot;, int(C.c_str_len(cstr)))\t\tfmt.Println(&quot;len(gstr): &quot;, len(gstr))\t&#125;\t&#123;\t\t// è·å–Cçš„å­—ç¬¦ä¸²\t\tcstr := C.c_new_str()\t\tdefer C.free(unsafe.Pointer(cstr))\t\t// é»˜è®¤GoStringéµå¾ªçš„Cçš„å®ç°ï¼Œä¹Ÿå°±æ˜¯é‡åˆ°&#x27;\\0&#x27;å°±æˆªæ–­äº†ï¼Œæ‰€ä»¥è¾“å‡ºäº† a\t\tprintStr(&quot;C.GoString(cstr)&quot;, C.GoString(cstr))\t\t// å°±æ˜¯ç”±äºä¸Šè¯‰çš„åŸå› ï¼Œå› æ­¤äººå®¶å¼€å‘äº†ä¸€ä¸ªC.GoStringNå‡½æ•°ï¼Œå°±æ˜¯ä½ éœ€è¦æ˜¾ç¤ºå‘Šè¯‰æˆ‘Cä¸­char*çš„é•¿åº¦ï¼\t\tprintStr(&quot;C.GoStringN(cstr, 5)&quot;, C.GoStringN(cstr, 5))\t\t// char* -&gt; []byte è½¬æ¢\t\tvar data []byte = C.GoBytes(unsafe.Pointer(cstr), C.int(5))\t\tfor _, elem := range data &#123;\t\t\tfmt.Printf(&quot;char: %U\\n&quot;, elem)\t\t&#125;\t\t// å®ƒæ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼\t\t// æ³¨æ„ï¼šåˆ‡ç‰‡ä¹Ÿå¯ä»¥è½¬æ¢æˆcharæ•°ç»„\t\tvar data2 = data[:1]\t\tprintStr(&quot;data2&quot;, string(data2))\t&#125;\t&#123;\t\tvar ss C.CStruct\t\tss.name = C.CString(&quot;tom&quot;)\t\tss.age = C.int(1)\t\tC.print_CStruct(&amp;ss)\t&#125;&#125;func printStr(name, value string) &#123;\tfmt.Printf(`%s: &quot;%s&quot;, len: %d`+&quot;\\n&quot;, name, value, len(value))&#125;\n\næ‰§è¡Œ CGO_ENABLED=1  go run -v main.go ï¼Œè¾“å‡ºï¼š\nc_print_str: hello worldc_print_str_size: hello world1111int(C.c_str_len(cstr)):  11len(gstr):  16C.GoString(cstr): &quot;a&quot;, len: 1C.GoStringN(cstr, 5): &quot;abc&quot;, len: 5char: U+0061char: U+0000char: U+0062char: U+0000char: U+0063data2: &quot;a&quot;, len: 1name: tom, age: 1\n\næ€»ç»“\nfunc C.CString(string) *C.char è¿™ä¸ªå‡½æ•°è½¬æ¢æˆCçš„å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæ²¡æœ‰è€ƒè™‘ \\0 ç»“å°¾ç¬¦å·çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™ç‚¹ä¸€å®šè¦æ³¨æ„ï¼\nfunc C.GoString(*C.char) string çš„å®ç°è€ƒè™‘äº†\\0ç»“å°¾ç¬¦å·çš„é—®é¢˜ï¼Œå› æ­¤å®ƒå®é™…ä¸Šå°±æ˜¯æ‹·è´äº† strlen é•¿åº¦çš„Cå­—ç¬¦ä¸²åˆ°Goçš„å­—ç¬¦ä¸²\nfunc C.GoStringN(*C.char, C.int) string  è§£å†³äº†\\0ç»“å°¾ç¬¦å·çš„é—®é¢˜ï¼Œéœ€è¦æ˜¾ç¤ºæŒ‡å®š Cè¯­è¨€ä¸­å­—ç¬¦ä¸²çš„é•¿åº¦ï¼\nfunc C.GoBytes(unsafe.Pointer, C.int) []byte  å’Œ func C.CBytes([]byte) unsafe.Pointer å¯ä»¥å®ç°æ•°ç»„çš„è½¬æ¢\nå…¶ä»–åŸºç¡€ç±»å‹éƒ½æ”¯æŒè½¬æ¢ï¼Œå…·ä½“çœ‹æ–‡æ¡£ï¼šå®˜æ–¹æ–‡æ¡£\n\nå¦‚ä½•é™ä½å¼€é”€ä½¿ç”¨åŸç”Ÿçš„APIï¼Œgo-&gt;c  å’Œ c-&gt;go éƒ½éœ€è¦æ¶‰åŠåˆ°æ•°æ®çš„æ‹·è´ï¼\nimport &quot;C&quot;const cStrEnd = string(&#x27;\\u0000&#x27;)// unsafe string GO -&gt; C func unsafeCString(str string) *C.char &#123;\t// Cè¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯ä»¥\\u0000 ç»“å°¾çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ³¨æ„äº†. éœ€è¦æ‰‹åŠ¨åŠ ä¸€ä¸ªç»“å°¾ç¬¦å·\tif index := strings.IndexByte(str, &#x27;\\u0000&#x27;); index == -1 &#123;\t\tstr = str + cStrEnd\t&#125;\theader := (*reflect.StringHeader)(unsafe.Pointer(&amp;str))\treturn (*C.char)(unsafe.Pointer(header.Data))&#125;// unsafe []byte GO -&gt; C// æ³¨æ„ []byte é•¿åº¦å¤§äº0func unsafeCBytes(str []byte) *C.char &#123;\treturn (*C.char)(unsafe.Pointer(&amp;str[0]))&#125;// unsafeGoBytes []byte C-&gt;GOfunc unsafeGoBytes(arr *C.char, arrSize C.int) []byte &#123;\theader := reflect.SliceHeader&#123;\t\tData: uintptr(unsafe.Pointer(arr)),\t\tLen:  int(arrSize),\t\tCap:  int(arrSize),\t&#125;\treturn *(*[]byte)(unsafe.Pointer(&amp;header))&#125;\n\nè°ƒè¯•å·¥å…·å¯ä»¥ä½¿ç”¨ go tool cgo main.go æŸ¥çœ‹cgoç”Ÿæˆçš„æ–‡ä»¶, å…¶å®æˆ‘ä»¬ç”¨æ³¨é‡Šå†™Cä»£ç ï¼Œç¼–è¯‘å™¨å¹¶ä¸ä¼šè¯†åˆ«ï¼Œè€Œæ˜¯GOç¼–è¯‘æœŸé—´æœ‰ä¸ªé¢„å¤„ç†çš„é˜¶æ®µ ç”Ÿæˆäº† go tool cgo çš„äº§ç‰©ï¼\nå¤§æ¦‚ä¼šç”Ÿæˆä¸€ä»½ C -&gt; GO è½¬æ¢çš„ä»£ç ï¼Œå…·ä½“å¯ä»¥è‡ªå·±è°ƒè¯•ä¸€ä¸‹ï¼\nå¦‚ä½•é›†æˆC++C++ ä¸ Cçš„å…³ç³»æˆ‘ä»¬çŸ¥é“C++ å®é™…ä¸Šæ˜¯å®Œå…¨å…¼å®¹ Cçš„ï¼Œå…¶æ¬¡C++ä¸Cæ˜¯å¯ä»¥ç›¸äº’è°ƒç”¨çš„ï¼Œé‚£ä¹ˆå»ºç«‹è¿™äº›å‰æçš„å°±æ˜¯ è¦æ˜ç¡®å‘Šè¯‰ c/c++ ç¼–è¯‘å™¨ï¼Œæˆ‘è¿™ä¸ªä»£ç æ˜¯Cè¯­è¨€çš„ï¼Œå› æ­¤éœ€è¦ extern &quot;C&quot; æ¥å‘Šè¯‰ C++ æˆ‘è¿™ä¸ªä»£ç æ˜¯Cè¯­è¨€çš„ï¼Œç¼–è¯‘å™¨å°±ä¼šæŒ‰ç…§Cè¯­è¨€çš„è§„èŒƒå»é“¾æ¥ï¼\nè¿”è¿‡æ¥ï¼ŒCè¯­è¨€ä»–æ²¡æœ‰ extern &quot;C&quot; è¿™ä¸ªå…³é”®è¯ï¼Œé‚£ä¹ˆC++å¼•ç”¨äº†Cå‡½æ•°çš„ä»£ç ï¼Œå› æ­¤éœ€è¦ extern &quot;C&quot; å¯ä»¥ä¿®é¥° #include $&#123;cçš„å¤´æ–‡ä»¶&#125;ï¼Œä¹Ÿå°±æ˜¯è¯´å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™äº›ç”³æ˜ç”¨Cè¯­è¨€çš„è§„èŒƒå»é“¾æ¥ï¼\nå…¶å®ä¸Šé¢éå¸¸çš„ç»•ï¼Œéœ€è¦å¤§å®¶äº²è‡ªä½“ä¼šä¸€ä¸‹ï¼å…¶æ¬¡Cä¸C++è¯­æ³•ä¸å®Œå…¨ä¸€æ ·ï¼Œæœ‰äº›æ—¶å€™åœ¨åšè¿™ç§é›†æˆå¼€å‘çš„æ—¶å€™å®¹æ˜“æ··äº†ï¼\nä¸‹é¢è¿™é‡Œæœ‰ä¸ªä¾‹å­ï¼Œå°±æ˜¯é›†æˆ libprotobuf å®ç°è§£æ protobuf æ–‡ä»¶ï¼Œç›®å‰åº”è¯¥Goå¼€æºç¤¾åŒºé‡Œé¢æ²¡æœ‰åšé›†æˆçš„ï¼\nå‰ç½®å‡†å¤‡\nä¸‹è½½ protobuf, å…·ä½“å¦‚ä½•æœ¬åœ°æ„å»ºprotobufçš„é“¾æ¥åº“ï¼Œå¯ä»¥ç›´æ¥çœ‹æˆ‘ä»¬çš„è¿™ä¸ªé¡¹ç›®\nå­¦ä¼šç”¨CMakeç­‰å·¥å…·æ„å»ºä»£ç \næŒæ¡C/C++/Goçš„åŸºæœ¬è¯­æ³•\né¡¹ç›®åœ°å€: https://github.com/anthony-dong/protobuf\n\né¡¹ç›®ç»“æ„â”œâ”€â”€ CMakeLists.txtâ”œâ”€â”€ README.mdâ”œâ”€â”€ cgo.go # cgo goè¯­è¨€å®ç°â”œâ”€â”€ cgo.h # cgo cå¤´æ–‡ä»¶â”œâ”€â”€ deps # ä¾èµ–â”‚Â Â  â”œâ”€â”€ README.mdâ”‚Â Â  â”œâ”€â”€ darwin_x86_64â”‚Â Â  â”œâ”€â”€ include # å¼•ç”¨çš„ç¬¬ä¸‰æ–¹å¤´æ–‡ä»¶â”‚Â Â  â””â”€â”€ linux_x86_64 # é™æ€ä¾èµ–â”‚Â Â      â”œâ”€â”€ libprotobuf.aâ”‚Â Â      â””â”€â”€ vendor.go # è§£å†³go vendor é—®é¢˜â”œâ”€â”€ errors.goâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ option.goâ”œâ”€â”€ pb_include.hâ”œâ”€â”€ pb_parser.cpp # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘â”œâ”€â”€ pb_parser.go # å¯¹å¤–æ¥å£â”œâ”€â”€ pb_parser.h # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘â”œâ”€â”€ utils.go â””â”€â”€ vendor.go  # è§£å†³go vendor é—®é¢˜\n\nå¤§æ¦‚å°±æ˜¯C++å†™ä¸šåŠ¡é€»è¾‘ï¼Œç„¶å C++ çš„æ¥å£ è½¬æˆ Cæ¥å£ï¼Œ C-&gt;GOçš„ç¿»è¯‘ï¼\nå®ç°åŠŸèƒ½package mainimport (\t&quot;fmt&quot;\t&quot;github.com/anthony-dong/protobuf&quot;)func main() &#123;\ttree, err := protobuf.NewProtobufDiskSourceTree(&quot;internal/test/idl_example&quot;)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tidlConfig := new(protobuf.IDLConfig)\tidlConfig.IDLs = tree\tidlConfig.Main = &quot;service/im.proto&quot;\tidlConfig.IncludePath = []string&#123;&quot;desc&quot;, &quot;.&quot;&#125;\tdesc, err := protobuf.ParsePBMultiFileDesc(idlConfig,\t\tprotobuf.WithJsonTag(),\t\tprotobuf.WithSourceCodeInfo(),\t\tprotobuf.WithGoogleProtobuf(),\t\tprotobuf.WithRequireSyntaxIdentifier(),\t)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tfmt.Println(protobuf.MessageToJson(desc, true))&#125;// è¿è¡Œ: CGO_ENABLED=1 go run main.go\n\næ³¨æ„ç‚¹\nå°½å¯èƒ½çš„ä½¿ç”¨ unsafe æ“ä½œé¿å…å†…å­˜æ‹·è´ï¼Œå°¤å…¶æ˜¯æ•°æ®å¤§çš„æƒ…å†µï¼Œæ•ˆæœä¼˜ç§€\nç®€å•å‡½æ•°å°½å¯èƒ½çš„ç”¨GOå®ç°\næ³¨æ„å†…å­˜ç®¡ç†å’Œå›æ”¶ï¼Œé¿å…ç›´æ¥æš´éœ²ç»™ä½¿ç”¨è€…\nC++çš„æŠ€å·§å¯ä»¥å‚è€ƒæˆ‘çš„è¿™ç¯‡æ–‡ç« : https://anthony-dong.github.io/2023/04/06/fd8e40efcdb71f2be44fb720dc582d67/\nC è¯­è¨€å®é™…ä¸Šæ²¡æœ‰å¤ªå¤šè¦å­¦ä¹ çš„ï¼Œæ˜¯æœ€ç®€å•çš„è¯­è¨€äº†ï¼Œæ²¡å•¥éš¾åº¦ï¼Œæ— éæ³¨æ„å†…å­˜åˆ†é…ï¼\nC++ ç¿»è¯‘ C ä¼šå­˜åœ¨æœ‰äº›ç±»å¯¹è±¡è½¬æ¢ä¸æ¥æˆ–è€…æ‹·è´ä»£ä»·å¤ªé«˜ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨voidæŒ‡é’ˆé¿å…æ‹·è´ï¼\n\nå‚è€ƒ\nCgo å®˜æ–¹æ–‡æ¡£ï¼š https://pkg.go.dev/cmd/cgo@go1.17\nGoè¯­è¨€é«˜çº§ç¼–ç¨‹ï¼šhttps://chai2010.cn/advanced-go-programming-book/ch2-cgo/index.html\n\n","categories":["Golang"],"tags":["C++","Golang","Cgo"]},{"title":"ç”¨markdownç”»æµç¨‹å›¾å’Œæ—¶åºå›¾","url":"/2022/03/27/583186f06a088dc9967a483e3876b2a2/","content":"â€‹    markdown ç›®å‰å·²ç»æˆä¸ºè½»é‡çº§ç¼–è¾‘å™¨çš„ä»£è¡¨ï¼Œä¾é markdownå¯ä»¥è§£å†³æ—¥å¸¸ç”Ÿæ´»ä¸­å†™æ–‡æ¡£çš„åŸºæœ¬éœ€æ±‚ï¼Œå¹¶ä¸”å¯¹äºä¸€äº›æ—¥å¸¸ä½¿ç”¨çš„æµç¨‹å›¾å’Œåºåˆ—å›¾ä¹Ÿæœ‰ä¸€å®šçš„æ”¯æŒï¼ç›®å‰æœ¬äººä½¿ç”¨çš„æ˜¯ Typora å†™ä¸ªäººæ–‡ç« ï¼Œåœ¨å…¬å¸å†…ç”¨çš„æ˜¯é£ä¹¦æ–‡æ¡£ï¼ŒåŸºæœ¬éƒ½æ˜¯markdownè¯­æ³•ï¼è€Œä½¿ç”¨ç›®å‰æ¯”è¾ƒå¥½ç”¨çš„ProcessOnï¼ˆç½‘é¡µç‰ˆï¼‰ã€Visio/PowerPoint(microsoft) ã€Draw.io(å¼€æº)ä½¿ç”¨ä¸‹æ¥çš„ä½“éªŒå°±æ˜¯æ–‡ç« å’Œæµç¨‹å›¾åˆ†ç¦»ï¼ä¹Ÿå°±æ˜¯å¯¼è‡´ä½¿ç”¨ä½“éªŒå¤§æ‰“æŠ˜æ‰£ï¼Œç›®å‰é£ä¹¦æ–‡æ¡£æ”¯æŒçš„PlantUMLå¾ˆä¸é”™ï¼æˆ‘ä¸ªäººä¸€èˆ¬æ˜¯PlantUMLå’ŒMermaidï¼\n\n\n1. UML1. åŸºæœ¬ä»‹ç»â€‹    UML æ˜¯ç»Ÿä¸€å»ºæ¨¡è¯­è¨€çš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€ç§ç”±ä¸€æ•´å¥—å›¾è¡¨ç»„æˆçš„æ ‡å‡†åŒ–å»ºæ¨¡è¯­è¨€ã€‚UMLç”¨äºå¸®åŠ©ç³»ç»Ÿå¼€å‘äººå‘˜é˜æ˜ï¼Œå±•ç¤ºï¼Œæ„å»ºå’Œè®°å½•è½¯ä»¶ç³»ç»Ÿçš„äº§å‡ºã€‚UMLä»£è¡¨äº†ä¸€ç³»åˆ—åœ¨å¤§å‹è€Œå¤æ‚ç³»ç»Ÿå»ºæ¨¡ä¸­è¢«è¯æ˜æ˜¯æˆåŠŸçš„åšæ³•ï¼Œæ˜¯å¼€å‘é¢å‘å¯¹è±¡è½¯ä»¶å’Œè½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚UMLä¸»è¦ä½¿ç”¨å›¾å½¢ç¬¦å·æ¥è¡¨ç¤ºè½¯ä»¶é¡¹ç›®çš„è®¾è®¡ï¼Œä½¿ç”¨UMLå¯ä»¥å¸®åŠ©é¡¹ç›®å›¢é˜Ÿæ²Ÿé€šã€æ¢ç´¢æ½œåœ¨çš„è®¾è®¡å’ŒéªŒè¯è½¯ä»¶çš„æ¶æ„è®¾è®¡ã€‚ä»¥ä¸‹æˆ‘ä»¬å°†å‘æ‚¨è¯¦ç»†ä»‹ç»ä»€ä¹ˆæ˜¯UMLã€UMLçš„å†å²ä»¥åŠæ¯ä¸ªUMLå›¾ç±»å‹çš„æè¿°ï¼Œè¾…ä¹‹ä»¥UMLç¤ºä¾‹ã€‚\n2. ä½œç”¨\nä¸ºç”¨æˆ·æä¾›ç°æˆçš„ã€æœ‰è¡¨ç°åŠ›çš„å¯è§†åŒ–å»ºæ¨¡è¯­è¨€ï¼Œä¸»è¦å°±æ˜¯å¯è§†åŒ–ï¼Œç›´è§‚ï¼ï¼\né€»è¾‘æ€ç»´çš„æ•´ç†å§ï¼Œå¦‚æœä½ å¯ä»¥ç”»å›¾æ¸…æ™°çš„è¡¨è¿°å‡ºé€»è¾‘ï¼Œé‚£ä¹ˆä¸€å®šæ–¹æ¡ˆå¯æ‰§è¡Œä¼šå¾ˆå¥½ï¼\nç”»å›¾ä¹Ÿæ˜¯ä¸€é—¨å­¦é—®å’ŒæŠ€å·§ï¼\n\n3. åˆ†ç±»å¤§æ¦‚ä¸Šæœ‰13ç§ï¼Œä¸‹é¢æˆ‘åˆ—å‡ºæˆ‘ä»¬å¸¸ç”¨çš„ï¼\n\n1. ç»“æ„å›¾1. ç±»å›¾ (Class Diagram)\n\n\n2. è¡Œä¸ºæ€§å›¾1. æ´»åŠ¨å›¾ (Activity Diagram)\n è¿™é‡Œä¸»è¦å¤šäº†ä¸€ä¸ªæ¦‚å¿µå«åšæ³³é“ï¼Œæ³³é“å¯ä»¥å¾ˆå¥½çš„éš”ç¦»å¼€æµç¨‹ï¼\n\n\n\n2. çŠ¶æ€æœºå›¾ (State Machine Diagram)\nå…¶å®è¿™ä¸ªå°±å’Œæµç¨‹å›¾ï¼\n\n\n\n\n3. åºåˆ—å›¾ (Sequence Diagram)\n\n2. æµç¨‹å›¾ (Flow Chart)markdown æ”¯æŒæµç¨‹å›¾(Flow Chart) æ˜¯ç”¨çš„å¼€æºçš„ flowchart è¯­æ³•è¿›è¡Œçš„æ”¯æŒ!  æµç¨‹å›¾ä¸€èˆ¬æ˜¯ç”¨æ¥æ¸…æ™°çš„è¡¨è¾¾å‡ºæµç¨‹é€»è¾‘çš„ä¸€ä¸ªå¯è§†åŒ–å·¥å…·ï¼Œæ¯”å¦‚ä½ è¦è·ŸåŒäº‹æ²Ÿé€šä¸€ä¸ªæŠ€æœ¯æ–¹æ¡ˆï¼Œä½ æ–‡æ¡£æ–‡å­—å†™çš„æ»¡æ»¡çš„ï¼Œä½†æ˜¯å¯¼è‡´æœ‰äº›ä¸“ä¸šæ€§çš„éš”é˜‚æˆ–è€…ä½ è¡¨è¿°ä¸æ¸…æ™°ï¼Œå¯¼è‡´åŒäº‹å¾ˆéš¾ç†è§£ä½ åœ¨è¯´ä»€ä¹ˆï¼Œè¿™æ—¶å€™å¯èƒ½å°±éœ€è¦æµç¨‹å›¾è¿›è¡Œå¼¥è¡¥ä¸‹ï¼\n1. ç®€å•è¯­æ³•ä»‹ç»æµç¨‹å›¾ä¸€èˆ¬æœ‰å‡ ä¸ªå…³é”®çš„èŠ‚ç‚¹ï¼Œä¹Ÿä¸€èˆ¬æ˜¯å¼€å§‹å’Œç»“æŸä¸¤ä¸ªèŠ‚ç‚¹ï¼å…¶æ¬¡æ˜¯æœ‰å¤šä¸ªä¸åŒç±»å‹çš„èŠ‚ç‚¹ç»„æˆï¼å…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£: flowchart\nèŠ‚ç‚¹å®šä¹‰è¯­æ³•å¦‚ : èŠ‚ç‚¹åç§°=&gt;èŠ‚ç‚¹ç±»å‹: èŠ‚ç‚¹æ˜¾ç¤ºçš„å†…å®¹[:&gt; è¶…é“¾æ¥URL]  æ˜¯ç©ºæ ¼æ•æ„Ÿçš„ï¼\n1. èŠ‚ç‚¹ç±»å‹èŠ‚ç‚¹ç±»å‹ä¸»è¦æœ‰:  å¸¸ç”¨çš„å…¶å®å°±å‰5ä¸ª\n\nstart (å¼€å§‹)\n\nend ï¼ˆç»“æŸï¼‰\n\noperation ï¼ˆæ“ä½œèŠ‚ç‚¹ï¼Œè¡¨ç¤ºä½ è¦æ‰§è¡Œçš„æ­¥éª¤ï¼Œæ¯”å¦‚å¹³æ—¶é¡ºåºç»“æ„ æ­¥éª¤A-&gt;æ­¥éª¤B-&gt;æ­¥éª¤Cï¼‰\n\ncondition ï¼ˆæ¡ä»¶èŠ‚ç‚¹ï¼Œè¡¨ç¤ºåˆ¤æ–­æ¡ä»¶ï¼‰\n\ninputoutput ï¼ˆè¾“å…¥è¾“å‡ºèŠ‚ç‚¹ï¼Œç±»ä¼¼äºå‰ç«¯çš„inputæ¡†ï¼Œè¾“å…¥ä¸ªè´¦æˆ·åç§°å’Œå¯†ç ä¹‹ç±»çš„ï¼ï¼‰\n\nsubroutineï¼ˆå­æµç¨‹ï¼Œå³è¡¨ç¤ºä¸€ä¸ªæµç¨‹ï¼Œä½†æ˜¯æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç›´æ¥é€šè¿‡è‡ªæµç¨‹ä»£æ›¿ï¼Œè¡¨ç¤ºè¿™å—é€»è¾‘åªæ˜¯æ²¡æœ‰å±•å¼€è€Œå·²ï¼Œå…¶å®å¾ˆå¤æ‚ï¼ï¼‰\n\nparallel ï¼ˆå¹¶è¡Œæµï¼Œå…è®¸å¤šä¸ªæµç¨‹åŒæ—¶å‘ç”Ÿï¼‰\n\n\n2. æµç¨‹æ§åˆ¶ç±»å‹è¯´æ˜ç¬¦:\n\nåŸºæœ¬æ“ä½œæµ: startVar(&lt;direction&gt;)-&gt;nextNode\n\ndirection è¡¨ç¤ºæ–¹ä½ï¼Œæœ‰leftã€rightã€topã€bottom \n\npreviousNode-&gt;endVar\n\noperationVar(&lt;direction&gt;)-&gt;nextNode\n\ninputoutputVar(&lt;direction&gt;)-&gt;nextNode\n\nsubroutineVar(&lt;direction&gt;)-&gt;nextNode\n\nconditionalVar(yes, &lt;direction&gt;)-&gt;nextNode1\n\nconditionalVar(no,  &lt;direction&gt;)-&gt;nextNode2\n\nparallel æ§åˆ¶æµä»‹ç»\n\n\nparallelVar(path1, &lt;direction&gt;)-&gt;nextNode1parallelVar(path2, &lt;direction&gt;)-&gt;nextNode2parallelVar(path3, &lt;direction&gt;)-&gt;nextNode3\n\n\ncondition æ§åˆ¶æµä»‹ç»\n\n# @ è¡¨ç¤ºè¦†å†™æè¿°ï¼Œæ¯”å¦‚æ­£åœ¨è¿™ä¸ªlineä¸Šæè¿°çš„æ˜¯trueï¼Œ@å¯ä»¥è¦†å†™æè¿°ä¸º æ­£ç¡®cond(true@æ­£ç¡®)-&gt;io-&gt;e\n\n3. å®˜æ–¹ä¾‹å­ä»‹ç»ä¸‹å›¾ä¸ºå®˜æ–¹ä»‹ç»çš„æµç¨‹å›¾ï¼š\nst=&gt;start: Start:&gt;http://www.google.com[blank]e=&gt;end:&gt;http://www.google.comop1=&gt;operation: My Operationsub1=&gt;subroutine: My Subroutinecond=&gt;condition: Yesor No?:&gt;http://www.google.comio=&gt;inputoutput: catch something...para=&gt;parallel: parallel tasksst-&gt;op1-&gt;condcond(yes)-&gt;io-&gt;econd(no)-&gt;parapara(path1, bottom)-&gt;sub1(right)-&gt;op1para(path2, top)-&gt;op1\n\nå±•ç¤ºæ•ˆæœå¦‚ä¸‹: \n\n\n2. ç®€å•ä¾‹å­ä»‹ç»ä¾‹å¦‚ä¸€ä¸ªç½‘å…³å‘å¸ƒ(åˆ†çº§å‘å¸ƒ)çš„å‰ç½®æµç¨‹ï¼Œä¸»è¦å°±æ˜¯ç”¨æˆ·é€‰æ‹©å‘å¸ƒç‰ˆæœ¬ï¼Œç„¶åè¿›è¡Œåˆ¤æ–­ï¼Œæäº¤å‘å¸ƒä¿¡æ¯çš„æµç¨‹ï¼Œæµç¨‹å›¾å¦‚ä¸‹:\næˆ‘è§‰å¾—flowchartå¥½å¤„å°±æ˜¯å¯ä»¥åƒå†™ä»£ç ä¸€æ ·ï¼Œæ¸…æ™°çš„æè¿°æµç¨‹å›¾ï¼Œè¦æ¯” mermaidå®ç”¨çš„å¤šï¼\nstart=&gt;start: å¼€å§‹æµç¨‹end=&gt;end: ç»“æŸselect_publish_version=&gt;inputoutput: è¾“å…¥/é€‰æ‹©å‘å¸ƒç‰ˆæœ¬op_start_publish=&gt;operation: ç‚¹å‡»å¼€å§‹å‘å¸ƒcond_publish_version=&gt;condition: åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦å·²ç»å‘å¸ƒæµ‹è¯•ç¯å¢ƒop_throw_error=&gt;operation: æŠ›å‡ºå¼‚å¸¸(å½“å‰ç‰ˆæœ¬x.x.xæœªç»è¿‡æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œä¸å…è®¸å‘å¸ƒ)op_load_publish_list=&gt;operation: åŠ è½½æµ‹è¯•ç¯å¢ƒå‘å¸ƒæˆåŠŸçš„å·¥å•select_tlb_path=&gt;inputoutput: é€‰æ‹©TLBå‘å¸ƒé›†ç¾¤ä»¥åŠåˆ†æµç­–ç•¥select_agw_env=&gt;inputoutput: é€‰æ‹©AGWå‘å¸ƒç¯å¢ƒop_submit=&gt;operation: æäº¤å‘å¸ƒä¿¡æ¯start-&gt;select_publish_version-&gt;op_start_publish-&gt;cond_publish_versioncond_publish_version(no@å¦)-&gt;op_throw_error-&gt;endcond_publish_version(yes@æ˜¯)-&gt;op_load_publish_list-&gt;select_tlb_path-&gt;select_agw_env-&gt;op_submit-&gt;end\n\n\n\n\n\n\n\n3. PlantUMLï¼ˆUMLï¼‰markdown æ”¯æŒæ—¶åºå›¾åŸºæœ¬ä¸Šç”¨çš„éƒ½æ˜¯ PlantUML ï¼ ç›®å‰é£ä¹¦æ–‡æ¡£æ”¯æŒä½¿ç”¨ PlantUML ï¼Œä½†æ˜¯æˆ‘ä¸ªäººä½¿ç”¨çš„typoraä¸æ”¯æŒï¼Œè€Œä¸”æˆ‘çš„åšå®¢ä¹Ÿä¸æ”¯æŒï¼Œæ‰€ä»¥ç›®å‰ä¸»æµçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ç½‘ç«™:https://g.gravizo.com/  ç”» svg å®ç°ï¼\nä¸è¿‡å¯ä»¥é…åˆ vscodeè¿›è¡Œä½¿ç”¨ï¼ä¸è¿‡æˆ‘è§‰å¾—PlantUMLæ¸²æŸ“æ¯”è¾ƒæ£’ï¼\n@startuml;actor User;participant &quot;First Class&quot; as A;participant &quot;Second Class&quot; as B;participant &quot;Last Class&quot; as C;User -&gt; A: DoWork;activate A;A -&gt; B: Create Request;activate B;B -&gt; C: DoWork;activate C;C --&gt; B: WorkDone;destroy C;B --&gt; A: Request Created;deactivate B;A --&gt; User: Done;deactivate A;@enduml\n\n\n\n4. Mermaid ï¼ˆUMLï¼‰1. æµç¨‹å›¾(flowchart)\nå¤´éƒ¨éœ€è¦å®šä¹‰ graph|flowchart  [direction] ï¼Œ å…¶ä¸­direction ä¸»è¦ç”± LR å’Œ TB ç»„åˆä¸Šä¸‹å·¦å³ï¼\nå†…å®¹éƒ¨åˆ†åªéœ€è¦å®šä¹‰æµç¨‹å³å¯\na --&gt; b --&gt; c è¡¨ç¤º é¡ºåºå¼•ç”¨\na --&gt; |æ³¨é‡Š|b è¡¨ç¤º a -&gt; b ä¸­é—´éœ€è¦åŠ æ³¨é‡Š\na(show_name) è¡¨ç¤º aéœ€è¦é€šè¿‡ show_name è¿›è¡Œå±•ç¤ºï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹å†…å®¹\n\n\nå•å‘ç®­å¤´ä¸»è¦æœ‰ --&gt;å®çº¿ï¼Œ -.-&gt; è™šçº¿ï¼Œ==&gt; åŠ ç²—çº¿ï¼› åŒå‘ç®­å¤´å°±æ˜¯ &lt;==&gt;å’Œâ€¦ï¼Œ æ— ç®­å¤´æ˜¯ == ï¼Œå¾ˆå½¢è±¡ï¼\nèŠ‚ç‚¹å¯ä»¥é€šè¿‡ &#123;condition name&#125; å’Œ [operation name] å’Œ (start|end name) å’Œ ((multi condition name)) è¿›è¡Œæ¸²æŸ“å½¢çŠ¶ï¼\nå’Œä¸Šé¢æˆ‘ä»¬è®²çš„ flowchartåŒºåˆ«å°±æ˜¯ä»–ä¸éœ€è¦å†å»å®šä¹‰èŠ‚ç‚¹äº†ï¼ä½†æ˜¯è¿™ä¸ªæµç¨‹å›¾å®šä¹‰çš„å¹¶ä¸ä¸¥æ ¼ï¼\n\n1. æ™®é€šæµç¨‹å›¾ä¾‹å­1:\ngraph LR\ta--&gt;|æ³¨é‡Š|b(å¼€å§‹ç»“æŸç±»å‹)--&gt;c[operationç±»å‹] --&gt;d&#123;conditionç±»å‹&#125; -.-&gt;|è™šçº¿|e((åœ†å‹èŠ‚ç‚¹))==&gt;|åŠ ç²—çº¿|f &lt;--&gt; |åŒå‘ç®­å¤´|g(end)\n\ngraph LR\n    a-->|æ³¨é‡Š|b(å¼€å§‹ç»“æŸç±»å‹)-->c[operationç±»å‹] -->d{conditionç±»å‹} -.->|è™šçº¿|e((åœ†å‹èŠ‚ç‚¹))==>|åŠ ç²—çº¿|f  |åŒå‘ç®­å¤´|g(end)\n\nä¾‹å­2:\ngraph LR  A&#123;A&#125; --&gt; |a-&gt;bæ™®é€šçº¿|B(B)  B --&gt; C --&gt; F((F)) --&gt; |è¾“å…¥|G&gt;G] --&gt; D   C --&gt; D  A ==&gt; |a-&gt;d block|D(D)  A --&gt; |a-&gt;e æ³¨é‡Š|E[eæ³¨é‡Š]  E -.-&gt; |e-d è™šçº¿|D\n\ngraph LR\n  A{A} --> |a->bæ™®é€šçº¿|B(B)\n  B --> C --> F((F)) --> |è¾“å…¥|G>G] --> D \n  C --> D\n  A ==> |a->d block|D(D)\n  A --> |a->e æ³¨é‡Š|E[eæ³¨é‡Š]\n  E -.-> |e-d è™šçº¿|D\n\nä¾‹å­3:\nflowchart LRA[Hard] &lt;--&gt;|Text| B(Round)B --&gt; C&#123;Decision&#125;C --&gt;|One| D[Result 1]C --&gt;|Two| E[Result 2]\n\nflowchart LR\nA[Hard] |Text| B(Round)\nB --> C{Decision}\nC -->|One| D[Result 1]\nC -->|Two| E[Result 2]\n\nä¾‹å­4: å¯ä»¥é€šè¿‡å…³é”®å­— &amp; æ¥è¡¨ç¤º a-&gt;c , b-&gt;d, c-&gt;d\nflowchart LR   a --&gt; b &amp; c--&gt; d\n\nflowchart LR\n   a --> b & c--> d\n\n2. å­å›¾è¡¨å¯ä»¥é€šè¿‡ subgraph åç§°+endå…³é”®å­—æ¥æ„å»ºå­å›¾æ ‡ï¼Œä½ å¯ä»¥ç†è§£ä¸ºå°±æ˜¯åŠ äº†ä¸ªæ¡†æ¡†ï¼å¯ä»¥åŒºåˆ†æµç¨‹å›¾\ngraph LR\t\ta(a) --&gt; b\t\tsubgraph oneæ¨¡å—\t\tb --&gt; c\t\tend\t\tc --&gt; d\t\tsubgraph twoæ¨¡å—\t\td --&gt; e\t\tend\t\te --&gt; f(f)\n\ngraph LR\n        a(a) --> b\n        subgraph oneæ¨¡å—\n        b --> c\n        end\n        c --> d\n        subgraph twoæ¨¡å—\n        d --> e\n        end\n        e --> f(f)\n\n\n\n\n\n2. åºåˆ—å›¾ ï¼ˆSequence Diagramï¼‰æ—¶åºå›¾ç”±ç®€ç§°UMLå›¾ï¼Œ\n\né¦–å…ˆéœ€è¦å®šä¹‰å‚ä¸è€…ï¼š participant [name] as [show_name]  æˆ–è€…ç›´æ¥ participant name , æˆ–è€…å¯ä»¥ç›´æ¥ä¸å®šä¹‰participant\nè¿æ¥çº¿: -&gt;&gt; å®çº¿ï¼Œ--&gt;&gt; è™šçº¿ï¼Œä¸€èˆ¬è¯·æ±‚ç”¨å®çº¿ï¼Œreturn ç”¨è™šçº¿ï¼Œ\n + å’Œ -è¡¨ç¤ºåŠ å…¥ä¼šè¯[activate]å’Œç»“æŸä¼šè¯[deactivate]ï¼Œä¾‹å¦‚ a -&gt; + b è¡¨ç¤ºbå¼€å¯ä¼šè¯ï¼ˆä¼šè¯æ˜¯ä¿©äººéƒ½å¯ä»¥å¼€å¯çš„ï¼Œè¿™ä¸ªa-&gt;&gt;+båªæ˜¯è¡¨ç¤ºbå¼€å¯ï¼Œå¦‚æœaä¹Ÿè¦å¼€å¯ï¼Œéœ€è¦ activate aï¼‰ï¼Œä¾‹å¦‚ activate aè¡¨ç¤ºaå¼€å¯ä¼šè¯!\næ·»åŠ node: Note ä½ç½®æè¿° å‚ä¸è€…: æ ‡æ³¨æ–‡å­— \n\n# over a,b,c å¤šä¸ªäºº# left of a  å•ä¸ªäºº# right of a å•ä¸ªäººNote over John,Alice: note: å˜»å˜»å˜» ğŸ˜Šï¼Note left of John: Text in noteNote right of John: Text in note\n\n1. æ™®é€šåºåˆ—å›¾ä¾‹å­ä¸€ï¼š\nsequenceDiagram\tparticipant Alice as Alice # å®šä¹‰å‚ä¸è€…ï¼š participant [name] as [show_name]\tparticipant John # å®šä¹‰å‚ä¸è€…: participant [name]\tAlice-&gt;&gt; + John: Hello John, how are you? # è¡¨ç¤ºå’Œjohnè¿›è¡Œä¼šè¯ï¼ŒåŒæ—¶aå’Œjå¼€å§‹ä¼šè¯\tJohn--&gt;&gt; Alice: Great! \tNote over John,Alice: note: å˜»å˜»å˜»ï¼Œover ğŸ˜Šï¼ # è¡¨ç¤ºæ·»åŠ æ³¨é‡Š\tNote left of John: note: å˜»å˜»å˜», left ğŸ˜Š!\tNote right of John: note: å˜»å˜»å˜», wright ğŸ˜Š!\t\tAlice-&gt;&gt; John: Hi John, I can hear you!\tJohn--&gt;&gt; - Alice: I feel great! # è¡¨ç¤ºjohnæ–­å¼€äº†ä¼šè¯\n\n\n\nsequenceDiagram\n    participant Alice as Alice # å®šä¹‰å‚ä¸è€…ï¼š participant [name] as [show_name]\n    participant John # å®šä¹‰å‚ä¸è€…: participant [name]\n    Alice->> + John: Hello John, how are you? # è¡¨ç¤ºå’Œjohnè¿›è¡Œä¼šè¯ï¼ŒåŒæ—¶aå’Œjå¼€å§‹ä¼šè¯\n    John-->> Alice: Great! \n    Note over John,Alice: note: å˜»å˜»å˜»ï¼Œover ğŸ˜Šï¼ # è¡¨ç¤ºæ·»åŠ æ³¨é‡Š\n    Note left of John: note: å˜»å˜»å˜», left ğŸ˜Š!\n    Note right of John: note: å˜»å˜»å˜», wright ğŸ˜Š!    \n    Alice->> John: Hi John, I can hear you!\n    John-->> - Alice: I feel great! # è¡¨ç¤ºjohnæ–­å¼€äº†ä¼šè¯\n\n\n\n2. åºåˆ—å›¾ä¾‹å­ä¾‹å­2ï¼š \nsequenceDiagram\tparticipant fe as å°ç¨‹åº\tparticipant service as æœåŠ¡å™¨\tparticipant wx_service as å¾®ä¿¡æœåŠ¡å™¨\tloop å¤±è´¥é‡è¯•\t\tfe -&gt;&gt; fe: wx.login()è·å–code\tend\tfe -&gt;&gt; service: wx.request() å‘é€code\tactivate service\tservice -&gt;&gt; wx_service: å‘é€code+appid+ç­¾å\tactivate wx_service\twx_service --&gt;&gt; service: è¿”å›code id\tdeactivate wx_service\tservice -&gt;&gt; service: ç”Ÿæˆtoken\tservice --&gt;&gt; fe: è¿”å›token\tdeactivate service\n\nsequenceDiagram\n    participant fe as å°ç¨‹åº\n    participant service as æœåŠ¡å™¨\n    participant wx_service as å¾®ä¿¡æœåŠ¡å™¨\n    loop å¤±è´¥é‡è¯•\n        fe ->> fe: wx.login()è·å–code\n    end\n    fe ->> service: wx.request() å‘é€code\n    activate service\n    service ->> wx_service: å‘é€code+appid+ç­¾å\n    activate wx_service\n    wx_service -->> service: è¿”å›code id\n    deactivate wx_service\n    service ->> service: ç”Ÿæˆtoken\n    service -->> fe: è¿”å›token\n    deactivate service\n\n5. å‚è€ƒ\nUMLæ•´ä½“æ¦‚è¿°\nUMLæ—¶åºå›¾(Sequence Diagram)å­¦ä¹ ç¬”è®°st=>start: Start:> http://www.google.com[blank]\ne=>end: End :>http://www.google.com\nop1=>operation: My Operation\nsub1=>subroutine: My Subroutine\ncond=>condition: Yes\nor No?:>http://www.google.com\nio=>inputoutput: catch something...\npara=>parallel: parallel tasks\n\nst->op1->cond\ncond(yes)->io->e\ncond(no)->para\npara(path1, bottom)->sub1(right)->op1\npara(path2, top)->op1{\"scale\":1,\"line-width\":2,\"line-length\":50,\"text-margin\":10,\"font-size\":12}  var code = document.getElementById(\"flowchart-0-code\").value;  var options = JSON.parse(decodeURIComponent(document.getElementById(\"flowchart-0-options\").value));  var diagram = flowchart.parse(code);  diagram.drawSVG(\"flowchart-0\", options);start=>start: å¼€å§‹æµç¨‹\nend=>end: ç»“æŸ\nselect_publish_version=>inputoutput: è¾“å…¥/é€‰æ‹©å‘å¸ƒç‰ˆæœ¬\nop_start_publish=>operation: ç‚¹å‡»å¼€å§‹å‘å¸ƒ\ncond_publish_version=>condition: åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦\nå·²ç»å‘å¸ƒæµ‹è¯•ç¯å¢ƒ\nop_throw_error=>operation: æŠ›å‡ºå¼‚å¸¸\n(å½“å‰ç‰ˆæœ¬x.x.xæœªç»è¿‡æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œä¸å…è®¸å‘å¸ƒ)\nop_load_publish_list=>operation: åŠ è½½æµ‹è¯•ç¯å¢ƒå‘å¸ƒæˆåŠŸçš„å·¥å•\nselect_tlb_path=>inputoutput: é€‰æ‹©TLBå‘å¸ƒé›†ç¾¤ä»¥åŠåˆ†æµç­–ç•¥\nselect_agw_env=>inputoutput: é€‰æ‹©AGWå‘å¸ƒç¯å¢ƒ\nop_submit=>operation: æäº¤å‘å¸ƒä¿¡æ¯\n\nstart->select_publish_version->op_start_publish->cond_publish_version\ncond_publish_version(no@å¦)->op_throw_error->end\ncond_publish_version(yes@æ˜¯)->op_load_publish_list->select_tlb_path->select_agw_env->op_submit->end{\"scale\":1,\"line-width\":2,\"line-length\":50,\"text-margin\":10,\"font-size\":12}  var code = document.getElementById(\"flowchart-1-code\").value;  var options = JSON.parse(decodeURIComponent(document.getElementById(\"flowchart-1-options\").value));  var diagram = flowchart.parse(code);  diagram.drawSVG(\"flowchart-1\", options);\n\n","categories":["å·¥å…·"],"tags":["å·¥å…·","Mermaid","UML","æµç¨‹å›¾"]},{"title":"Dockerå­¦ä¹ ","url":"/2020/09/26/58eb7a52b940359a191f97578179026e/","content":"â€‹        å­¦ä¹ dockerçš„åŸºæœ¬ç»„ä»¶ã€dockerfileã€dockerå‘½ä»¤ç­‰ï¼\n\n\nå®˜æ–¹æ–‡ç« ï¼šhttps://docs.docker.com/\ndocker å®˜æ–¹é•œåƒåœ°å€ï¼š https://hub.docker.com/\næ¨èé˜…è¯»ä¸›ä¹¦ ï¼š Dockerå®æˆ˜(åšæ–‡è§†ç‚¹å‡ºå“) ï¼Œ ç¬¬ä¸€æœ¬Dockerä¹¦ ä¿®è®¢ç‰ˆ\ndocker å¿«é€Ÿå®‰è£…ï¼š curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun , è®°å¾—ç”¨æˆ·è®¾ç½®åœ¨dockerç”¨æˆ·ç»„ï¼ï¼Œæ¨èåœ¨émac os/windowsä¸Šç©ã€‚\n1ã€docker çš„ç»„æˆ\n1ã€runcruncå®è´¨ä¸Šæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€é’ˆå¯¹Libcontainerè¿›è¡Œäº†åŒ…è£…çš„å‘½ä»¤è¡Œäº¤äº’å·¥å…·( Libcontainerå–ä»£äº†æ—©æœŸDockeræ¶æ„ä¸­çš„LXC )ã€‚\nä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæ˜¯è¿è¡Œä¸€ä¸ªå®¹å™¨æœ€åŸºæœ¬çš„å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºå®¹å™¨ã€‚\ndockerä¸­åˆ›å»ºå®¹å™¨æ˜¯ï¼Œdocker create docker-image-name ï¼Œä½†æ˜¯éœ€è¦å¯¼å‡ºåˆ°æ–‡ä»¶ç³»ç»Ÿä¸­\n# create the top most bundle directorymkdir /mycontainercd /mycontainer# create the rootfs directorymkdir rootfs# export busybox via Docker into the rootfs directorydocker export $(docker create busybox) | tar -C rootfs -xvf -runc spec# run as rootcd /mycontainerrunc run mycontainerid\n\n2ã€containerdå¯¹äºdockerè¿›è¡Œæ‹†åˆ†åï¼Œå®¹å™¨æ‰§è¡Œé€»è¾‘è¢«é‡æ„åˆ°ä¸€ä¸ªæ–°çš„åä¸ºcontainerd (å‘éŸ³ä¸ºcontainer-dee) çš„å·¥å…·ä¸­ã€‚å®ƒçš„ä¸»è¦ä»»åŠ¡æ˜¯å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†â€”â€”â€”â€” start | stop | pause | rmâ€¦.\nDockerå¼•æ“æŠ€æœ¯æ ˆä¸­ï¼Œcontainerdä½äºdaemonå’Œruncæ‰€åœ¨çš„OCIå±‚ä¹‹é—´ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå®ƒè¢«èµ‹äºˆäº†æ›´å¤šçš„åŠŸèƒ½ï¼Œå¦‚é•œåƒç®¡ç†ã€‚è™½ç„¶åå«containerd, ä½†æ˜¯å®ƒå¹¶ä¸è´Ÿè´£åˆ›å»ºå®¹å™¨ï¼Œè€Œæ˜¯æŒ‡æŒ¥runcå»åšã€‚containerdå°†Dockeré•œåƒè½¬æ¢ä¸ºOCI bundle,å¹¶è®©runcåŸºäºæ­¤åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ã€‚ç„¶åï¼Œruncä¸æ“ä½œç³»ç»Ÿå†…æ ¸æ¥å£è¿›è¡Œé€šä¿¡ï¼ŒåŸºäºæ‰€æœ‰å¿…è¦çš„å·¥å…·( Namespaceã€CGroup ç­‰)æ¥åˆ›å»ºå®¹å™¨ã€‚å®¹å™¨è¿›ç¨‹ä½œä¸ºruncçš„å­è¿›ç¨‹å¯åŠ¨ï¼Œå¯åŠ¨å®Œæ¯•åï¼Œrunc å°†ä¼šé€€å‡ºã€‚\n\nâ€‹      å°†æ‰€æœ‰çš„ç”¨äºå¯åŠ¨ã€ç®¡ç†å®¹å™¨çš„é€»è¾‘å’Œä»£ç ä»daemonä¸­ç§»é™¤ï¼Œæ„å‘³ç€å®¹å™¨è¿è¡Œæ—¶ä¸Docker daemonæ˜¯è§£è€¦çš„ï¼Œæœ‰æ—¶ç§°ä¹‹ä¸ºâ€œæ— å®ˆæŠ¤è¿›ç¨‹çš„å®¹å™¨(daemonless container)â€,å¦‚æ­¤ï¼Œå¯¹Docker daemonçš„ç»´æŠ¤å’Œå‡çº§å·¥ä½œä¸ä¼šå½±å“åˆ°è¿è¡Œä¸­çš„å®¹å™¨ã€‚\n3ã€shimshimæ˜¯å®ç°æ— daemonçš„å®¹å™¨(ç”¨äºå°†è¿è¡Œä¸­çš„å®¹å™¨ä¸daemonè§£è€¦ï¼Œä»¥ä¾¿è¿›è¡Œdaemonå‡çº§ç­‰æ“ä½œ)ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚containerd æŒ‡æŒ¥runcæ¥åˆ›å»ºæ–°å®¹å™¨ã€‚äº‹å®ä¸Š,æ¯æ¬¡åˆ›å»ºå®¹å™¨æ—¶å®ƒéƒ½ä¼šforkä¸€ä¸ªæ–°çš„runcå®ä¾‹ã€‚ä¸è¿‡ï¼Œä¸€æ—¦å®¹å™¨åˆ›å»ºå®Œæ¯•ï¼Œå¯¹åº”çš„runcè¿›ç¨‹å°±ä¼šé€€å‡ºã€‚å› æ­¤ï¼Œå³ä½¿è¿è¡Œä¸Šç™¾ä¸ªå®¹å™¨ï¼Œä¹Ÿæ— é¡»ä¿æŒä¸Šç™¾ä¸ªè¿è¡Œä¸­çš„runcå®ä¾‹ã€‚ä¸€æ—¦å®¹å™¨è¿›ç¨‹çš„çˆ¶è¿›ç¨‹runcé€€å‡ºï¼Œç›¸å…³è”çš„containerd-shim è¿›ç¨‹å°±ä¼šæˆä¸ºå®¹å™¨çš„çˆ¶è¿›ç¨‹ã€‚\nä½œä¸ºå®¹å™¨çš„çˆ¶è¿›ç¨‹ï¼Œshim çš„éƒ¨åˆ†èŒè´£å¦‚ä¸‹ã€‚\n\nä¿æŒæ‰€æœ‰STDINå’ŒSTDOUTæµæ˜¯å¼€å¯çŠ¶æ€ï¼Œä»è€Œå½“daemoné‡å¯çš„æ—¶å€™,å®¹å™¨ä¸ä¼šå› ä¸ºç®¡é“( pipe)çš„å…³é—­è€Œç»ˆæ­¢ã€‚\nå°†å®¹å™¨çš„é€€å‡ºçŠ¶æ€åé¦ˆç»™daemonã€‚\n\n4ã€daemondaemonçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬é•œåƒç®¡ç†ã€é•œåƒæ„å»ºã€REST APIã€èº«ä»½éªŒè¯ã€å®‰å…¨ã€æ ¸å¿ƒç½‘ç»œä»¥åŠç¼–æ’ã€‚\n2ã€Dockerfile å­¦ä¹ \nâ€‹    å®˜æ–¹æ–‡æ¡£ï¼š https://docs.docker.com/engine/reference/builder/\n\n1ã€dockerfile æ–‡ä»¶ï¼ŒåŸºæœ¬ç©æ³•FROM alpine:latestMAINTAINER anthony-dong &quot;fanhaodong516@gamil.com&quot;RUN mkdir -p /opt/projectWORKDIR /opt/projectADD project.tar.gz .COPY run.sh .EXPOSE 8080VOLUME [ &quot;/opt/project&quot; ]ENV PROJECT_HOME /opt/projectENV PATH $PATH:$PROJECT_HOMECMD [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;run.sh&quot;]\n\næ‰§è¡Œï¼š\ndocker build -t test .docker run --rm -it test\n\n2ã€CMD å’Œ ENTRYPOINT çš„åŒºåˆ«\nCMD å’Œ ENTRYPOINT çš„åŒºåˆ«ï¼Œè¿™é‡Œå…¶å®åŒºåˆ«å¾ˆç®€å•ï¼Œ å¯ä»¥ç†è§£ä¸º åœ¨æ²¡æœ‰å¯åŠ¨å‘½ä»¤æ˜¯ ENTRYPOINT+ CMD ï¼ˆå¯åŠ¨docker runæ—¶è¿è¡Œçš„é»˜è®¤å‘½ä»¤ï¼‰\nå½“æˆ‘ä»¬ docker run image_name [cmd1] [cmd2] æ—¶ï¼Œå…¶å®å·²ç»æŠŠ Dokerfileä¸­é…ç½®çš„CMDå‘½ä»¤æ›¿æ¢æ‰äº†ï¼Œå…¶å®çœŸæ­£æ‰§è¡Œçš„æ˜¯  ENTRYPOINT+ [cmd1]+ [cmd2]  ï¼Œ ä½†æ˜¯è¿™ä¿©CMD å’Œ ENTRYPOINT  éƒ½å¯ä»¥ä¸ºç©º\næ ¹æ®ä¸Šé¢å¯ä»¥å‘ç° CMDå¯ä»¥é€šè¿‡ docker runå¯ä»¥æ›¿æ¢ï¼Œé‚£ä¹ˆ ENTRYPOINT ä¹Ÿæ˜¯å¯ä»¥æ›¿æ¢çš„ï¼Œå¯ä»¥é€šè¿‡ -entrypoint æŒ‡å®š\n\nFROM alpine:latestENTRYPOINT [ &quot;ls&quot;]CMD [&quot;-al&quot;]\n\næ¯”å¦‚ä¸Šé¢æ‰¾ä¸ªï¼Œæˆ‘ä»¬å¦‚æœé»˜è®¤æ‰§è¡Œçš„è¯ï¼Œä¼šæ˜¯ï¼š\nâœ  kubernetes docker run --rm demo                 total 64drwxr-xr-x    1 root     root          4096 Jan 26 12:50 .// ...drwxr-xr-x    2 root     root          4096 Jan 14 11:49 optdr-xr-xr-x  226 root     root             0 Jan 26 12:50 proc\n\nä½†æ˜¯å¦‚æœæˆ‘ä»¬æ·»åŠ äº†å‚æ•°ï¼š\nâœ  kubernetes docker run --rm demo -a...dockerenvbin//.... home\n\nä¿®æ”¹ ENTRYPOINT\nâœ  kubernetes docker run --rm --entrypoint env demoPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binHOSTNAME=4791b485ab53HOME=/root\n\n3ã€AND å’Œ COPYçš„åŒºåˆ«AND å¯ä»¥æ˜¯å¤šç§sourceæºï¼Œæ”¯æŒurl/tar/unzip/æ–‡ä»¶åŒ…ï¼Œæ‰€ä»¥çœ‹éœ€æ±‚é€‰æ‹©ï¼Œæ¯”å¦‚ä½¿ç”¨taråŒ…ä¼šè‡ªåŠ¨è§£å‹\nCOPY åªèƒ½copyæ–‡ä»¶ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¨ècopy\n4ã€build å¤±è´¥å¦‚ä½•ç»§ç»­ï¼Œå¦‚ä½•è°ƒè¯•ï¼ï¼FROM centos:centos7USER admin:adminCMD [ &quot;/bin/bash&quot; ]\n\nè¿™ä¸ªbuildæ˜¯å¯ä»¥é€šè¿‡çš„ï¼ï¼ï¼\nâœ  docker-file-test docker build -t test-1 .Sending build context to Docker daemon  25.09kBStep 1/3 : FROM centos:centos7 ---&gt; 7e6257c9f8d8Step 2/3 : USER admin:admin ---&gt; Running in f8ed46bdda32Removing intermediate container f8ed46bdda32 ---&gt; 9611a153742eStep 3/3 : CMD [ &quot;/bin/bash&quot; ] ---&gt; Running in abc32bd8e245Removing intermediate container abc32bd8e245 ---&gt; 0f0f0aeeec29Successfully built 0f0f0aeeec29Successfully tagged test-1:latest\n\nç„¶åè¿è¡Œ\nâœ  docker-file-test docker run --rm -it test-1docker: Error response from daemon: linux spec user: unable to find user admin: no matching entries in passwd file.\n\nå‘ç°è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦ä»Step 1/3å¼€å§‹ï¼ï¼ï¼\nâœ  docker-file-test docker run --rm -it  7e6257c9f8d8[root@532c8a693273 /]# useradd admin -p admin -d /home/admin --create-home -s /bin/bash[root@532c8a693273 /]# su admin[admin@532c8a693273 /]$ exitexit\n\nç„¶åæˆ‘ä»¬éœ€è¦ç»§ç»­æ”¹dockerfile\nFROM centos:centos7RUN useradd admin -p admin -d /home/admin --create-home -s /bin/bashUSER admin:adminCMD [ &quot;/bin/bash&quot; ]\n\nç»§ç»­è¿è¡Œ\nâœ  docker-file-test docker build -t test-1 .Sending build context to Docker daemon  25.09kBStep 1/4 : FROM centos:centos7 ---&gt; 7e6257c9f8d8Step 2/4 : RUN useradd admin -p admin -d /home/admin --create-home -s /bin/bash ---&gt; Running in f36f10b603bdRemoving intermediate container f36f10b603bd ---&gt; 843554e160f7Step 3/4 : USER admin:admin ---&gt; Running in 796341a1be27Removing intermediate container 796341a1be27 ---&gt; ab964ed78d8fStep 4/4 : CMD [ &quot;/bin/bash&quot; ] ---&gt; Running in 2c67de0242eaRemoving intermediate container 2c67de0242ea ---&gt; 17a4bc8d7206Successfully built 17a4bc8d7206Successfully tagged test-1:latestâœ  docker-file-test docker run --rm -it 17a4bc8d7206[admin@55f84f22acf6 /]$\n\nè¿™ä¸ªå°±æ˜¯ä¸€ä¸ªç®€å•çš„è¿‡ç¨‹ï¼ï¼ï¼ï¼ï¼ï¼ï¼Œè¿™ä¸ªå¥½å¤„æ˜¯ç±»ä¼¼äºè°ƒè¯•çš„è¿‡ç¨‹\nå…¶å®è¿˜å¯ä»¥é€šè¿‡ docker run -u æ¥åˆ¶å®šç”¨æˆ·ï¼Œåˆ‡è®°ä¸€ç‚¹ï¼Œåˆ«è®°å¿†å‘½ä»¤ï¼ï¼ï¼Œè¦è®°å¿†å¦‚ä½•å­¦ä¹ ï¼ï¼\nâœ  docker-file-test docker run -it --rm --user root test-1[root@6dbeb01f5329 /]#\n\n5ã€å®‰è£…ä¸€ä¸ªGoçš„ç¯å¢ƒFROM centos:centos7MAINTAINER anthony-dong &quot;fanhaodong516@gamil.com&quot;# æ·»åŠ æ–‡ä»¶åœ°å€ADD go1.13.15.linux-amd64.tar.gz /opt# é¡¹ç›®åœ°å€æ–‡ä»¶,å®‰è£…å·¥å…·RUN mkdir /opt/project \\    &amp;&amp; yum install -y vim \\    &amp;&amp; yum install  -y curl \\    &amp;&amp; yum install  -y git \\    &amp;&amp; yum install  -y wget# ç¯å¢ƒå˜é‡    ENV GO_HOME &quot;/opt/go&quot;ENV PATH $PATH:$GO_HOME/bin# exportç«¯å£EXPOSE 8080 EXPOSE 10010 # ç›´æ¥å¯åŠ¨bashCMD [ &quot;/bin/bash&quot;]\n\nç„¶åæ‰§è¡Œï¼Œ --tag å¯ä»¥å†™æˆ-t ï¼Œæ¯”å¦‚--tag go:1.13 æ„æ€å°±æ˜¯é•œåƒåç§°æ˜¯goï¼Œç‰ˆæœ¬æ˜¯1.13ï¼Œå¤§è‡´å°±æ˜¯è¿™ä¸ªæ ·å­ï¼ \ndocker build --file ./Dockerfile -p  --tag goenv1.13 .\n\næœ€åå¯åŠ¨éœ€è¦æŒ‡å®š-t ï¼Œæ„æ€å°±æ˜¯ --rmæ˜¯å®¹å™¨è¢«åœæ­¢åˆ™è¢«åˆ é™¤ï¼Œ-dæ˜¯deamonå¯åŠ¨ï¼Œ -itå°±æ˜¯holdä½ç±»ä¼¼äºå¼€å¯ä¸€ä¸ªç»ˆç«¯ï¼ˆiæ˜¯è¾“å‡ºï¼Œtæ˜¯ç»ˆç«¯ï¼Œç„¶åç¨‹åºå°±è¢«holdä½äº†ï¼‰ï¼Œ -Pæš´æ¼ç«¯å£éšæœºåˆ°å®¿ä¸»æœºä¸Šï¼Œ æœ€åæŒ‡å®šä½¿ç”¨çš„é•œåƒ\ndocker run --rm -d -it -P goenv1.13\n\nç„¶åæŸ¥çœ‹ä¸€ä¸‹\nâœ  test docker psCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                               NAMESf67a0f2bcb0e        goenv1.13           &quot;/bin/bash&quot;         21 seconds ago      Up 19 seconds       0.0.0.0:32769-&gt;8080/tcp, 0.0.0.0:32768-&gt;10010/tcp   heuristic_lumiere\n\n6ã€å¤šé˜¶æ®µæ„å»º\nâ€‹    Docker v17.05 å¼€å§‹æ”¯æŒå¤šé˜¶æ®µæ„å»º (multistage builds)ï¼Œ å‚è€ƒï¼šhttps://yeasy.gitbook.io/docker_practice/image/multistage-builds  , ä¸»è¦å‘½ä»¤å°±æ˜¯ COPY --from=builder /data/apps/project/bin/app bin/\nä½†æ˜¯ä¸šåŠ¡ä¸­ä¸æ¨èï¼Œå¾ˆå¤šæ—¶å€™è¦å»å®¹å™¨é‡Œæ“ä½œï¼\n\nè¿˜æ˜¯ä¸€ä¸ªGoé¡¹ç›®ï¼Œå‡å¦‚ä»¥ä¸€ä¸ªHttp-Server ä¸ºä¾‹å­\nâœ  pck tree -L 2.â”œâ”€â”€ Dockerfileâ”œâ”€â”€ cmdâ”‚   â””â”€â”€ main.goâ”œâ”€â”€ go.modâ””â”€â”€ go.sum\n\né¡¹ç›®æ–‡ä»¶ï¼š\npackage mainimport (\t&quot;github.com/gin-gonic/gin&quot;\t&quot;log&quot;\t&quot;net/http&quot;)func main() &#123;\trouter := gin.Default()\trouter.GET(&quot;/echo&quot;, func(context *gin.Context) &#123;\t\tcontext.JSON(http.StatusOK, gin.H&#123;\t\t\t&quot;code&quot;:    0,\t\t\t&quot;data&quot;:    &quot;hello world&quot;,\t\t\t&quot;message&quot;: &quot;success&quot;,\t\t&#125;)\t&#125;)\tlog.Fatal(router.Run(&quot;:8080&quot;))&#125;\n\nDockerfile\n# 1.11+ é»˜è®¤è‡ªåŠ¨æ”¯æŒGo mod,åˆ‡è®°builderçš„ç¼–è¯‘å’Œè¿è¡Œçš„ç¼–è¯‘å†…æ ¸ä¸€è‡´FROM  golang:1.13.15-alpine3.12 as builder# å…¨å±€å˜é‡ï¼Œé¡¹ç›®åç§°ARG GOPROXY=https://goproxy.cn,directENV GOPROXY=$&#123;GOPROXY&#125;WORKDIR /dataCOPY . .RUN go build -v -ldflags &quot;-s -w&quot; -o bin/app cmd/main.goFROM alpine:3.12 as runing# åˆ‡è®°ç¯å¢ƒå˜é‡ä¸èƒ½å…±äº«ARG PROJECT_NAME=projectARG PROJECT_PORT=8080WORKDIR /data/$&#123;PROJECT_NAME&#125;COPY . .# å«ä¹‰æ˜¯ copyä¸Šä¸€ä¸ªé•œåƒçš„ /data/$&#123;PROJECT_NAME&#125;/bin/app æ–‡ä»¶åˆ°å½“å‰ç›®å½•çš„binCOPY --from=builder /data/bin/app bin/# COPY --from=0 /opt/bin/app .EXPOSE $&#123;PROJECT_PORT&#125;CMD [ &quot;bin/app&quot; ]\n\nç¼–è¯‘ ï¼š(æ³¨æ„ alpineæ˜¯ä¸æ”¯æŒ race çš„ï¼Œä¼šç¼–è¯‘æŠ¥é”™ï¼‰\ndocker build -t test .\n\nå¯åŠ¨:\nâœ  my-docker docker run --rm -p 8080:8080 test  [GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.[GIN-debug] [WARNING] Running in &quot;debug&quot; mode. Switch to &quot;release&quot; mode in production. - using env:   export GIN_MODE=release - using code:  gin.SetMode(gin.ReleaseMode)[GIN-debug] GET    /echo                     --&gt; main.main.func1 (3 handlers)[GIN-debug] Listening and serving HTTP on :8080\n\næŸ¥çœ‹å¤§å°ï¼š\nâœ  my-docker docker imagesREPOSITORY              TAG                  IMAGE ID            CREATED             SIZEtest                    latest               fdbca700806f        8 minutes ago       17.8MBalpine                  latest               7731472c3f2a        6 days ago          5.61MB\n\nå…¶å®çœŸå®çš„Goçš„æ„å»ºä¸æ˜¯è¿™ç§ï¼Œä¸€èˆ¬éƒ½æœ‰æ‰“åŒ…æœºå™¨ï¼Œæ— é¡»æˆ‘ä»¬å»æ‰¾æœºå™¨ç¼–è¯‘å’Œè¿è¡Œ\n7ã€æ„å»ºå¤šç§ç³»ç»Ÿæ¶æ„æ”¯æŒçš„ Docker é•œåƒhttps://yeasy.gitbook.io/docker_practice/image/manifest\n3ã€Docker é™åˆ¶èµ„æºå‹æµ‹ç¨‹åº,ä¸å‡†ç¡®ï¼Œå› ä¸ºæ•°ç»„æ‰©å®¹ï¼Œæ˜¯ååˆ†æ¶ˆè€—å†…å­˜çš„ï¼Œå¦‚æœå†…å­˜æ»¡äº†ï¼Œæ— æ³•ç”³è¯·å†…å­˜ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ‰“å°æ¶ˆæ¯ï¼å¯ä»¥ä½¿ç”¨stresså·¥å…·æ¥æµ‹è¯•CPUå’Œå†…å­˜ã€‚è¿™é‡Œæˆ‘ä¹Ÿæ‡’å¾—ä¸‹è½½ï¼ï¼\npackage mainimport (\t&quot;fmt&quot;\t&quot;os&quot;\t&quot;strconv&quot;\t&quot;time&quot;)var (\tref []byte)func main() &#123;\tfmt.Println(os.Getpid())\tmem, _ := strconv.ParseInt(os.Args[1], 10, 64)\tfor &#123;\t\tif mem == 0 &#123;\t\t\tmem = 1\t\t&#125;\t\tsize := 1024 * 1024 * mem\t\tnewSlice(size)\t\ttime.Sleep(time.Second)\t&#125;&#125;func newSlice(size int64) &#123;\tadd := make([]byte, size)\tref = append(ref, add...)                                                        // åˆ†é…size\tfmt.Println(fmt.Sprintf(&quot;%s  %v\\n&quot;, time.Now().Format(&quot;15:04:05&quot;), os.Getpid())) // æ‰“å°æ¶ˆæ¯&#125;\n\nä¸‹é¢è¡¨ç¤ºï¼šè¡¨ç¤ºåœ¨ç°åœ¨çš„å†…å­˜æ˜¯200Mï¼Œcpué™åˆ¶æ˜¯1\nâœ  go-demo docker run -it --rm --memory  200M  --cpuset-cpus=&quot;1&quot;  --oom-kill-disable -v /Users/dong/go/version/go-1.13.5:/opt/project ce2534430fc2 /bin/bash\n\n[root@17d356297d5f project]# go build -o bin/main study/slice/main2.go // .. å¯ä»¥å‘ç°åœ¨45sçš„å¡å£³äº†ï¼Œä¹Ÿå°±æ˜¯å†…å­˜è¢«é™åˆ¶äº†08:52:44  10308:52:45  103top - 08:52:45 up  5:24,  0 users,  load average: 0.96, 1.45, 1.12Tasks:   4 total,   1 running,   3 sleeping,   0 stopped,   0 zombie%Cpu(s):  0.3 us,  3.0 sy,  0.0 ni, 93.3 id,  1.0 wa,  0.0 hi,  2.4 si,  0.0 stKiB Mem :  2046748 total,  1592784 free,   324656 used,   129308 buff/cache// è¿™äº›ä¿¡æ¯æ˜¯å‡çš„ï¼Œä¸èƒ½çœ‹KiB Swap:  1048572 total,   703508 free,   345064 used.  1582140 avail Mem  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND  103 root      20   0  645568 200120     68 S  18.9  9.8   0:01.31 main // 200 m    1 root      20   0   11836   2400   2400 S   0.0  0.1   0:00.15 bash   51 root      20   0   11836   2332   2332 S   0.0  0.1   0:00.05 bash   71 root      20   0   56188   2016   1924 R   0.0  0.1   0:00.03 top\n\næŸ¥çœ‹dockerå®¹å™¨çœŸå®çš„å†…å­˜ï¼Œå¯ä»¥\nâœ  ~ docker stats 17d356297d5fCONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS17d356297d5f        cocky_shaw          0.00%               199.4MiB / 200MiB   99.69%              1.18kB / 0B         357MB / 927MB       7\n\n1ã€å…³äºå†…å­˜è®¾ç½®è¿™å‡ ä¸ªå‚æ•°çš„å…³ç³»\n\n\né€‰é¡¹\næè¿°\n\n\n\n-m,--memory\nå†…å­˜é™åˆ¶ï¼Œæ ¼å¼æ˜¯æ•°å­—åŠ å•ä½ï¼Œå•ä½å¯ä»¥ä¸º b,k,m,gã€‚æœ€å°ä¸º 4M\n\n\n--memory-swap\nå†…å­˜+äº¤æ¢åˆ†åŒºå¤§å°æ€»é™åˆ¶ã€‚æ ¼å¼åŒä¸Šã€‚å¿…é¡»å¿…-mè®¾ç½®çš„å¤§\n\n\n--memory-reservation\nå†…å­˜çš„è½¯æ€§é™åˆ¶ã€‚æ ¼å¼åŒä¸Š\n\n\n--oom-kill-disable\næ˜¯å¦é˜»æ­¢ OOM killer æ€æ­»å®¹å™¨ï¼Œé»˜è®¤æ²¡è®¾ç½®\n\n\n--oom-score-adj\nå®¹å™¨è¢« OOM killer æ€æ­»çš„ä¼˜å…ˆçº§ï¼ŒèŒƒå›´æ˜¯[-1000, 1000]ï¼Œé»˜è®¤ä¸º 0\n\n\n--memory-swappiness\nç”¨äºè®¾ç½®å®¹å™¨çš„è™šæ‹Ÿå†…å­˜æ§åˆ¶è¡Œä¸ºã€‚å€¼ä¸º 0~100 ä¹‹é—´çš„æ•´æ•°\n\n\n--kernel-memory\næ ¸å¿ƒå†…å­˜é™åˆ¶ã€‚æ ¼å¼åŒä¸Šï¼Œæœ€å°ä¸º 4M\n\n\n â€“memory-swap å€¼å¿…é¡»æ¯”**â€“memory** å€¼å¤§ï¼Œå› ä¸ºï¼šâ€“memory-swapä¸æ˜¯äº¤æ¢åˆ†åŒºï¼Œè€Œæ˜¯å†…å­˜åŠ äº¤æ¢åˆ†åŒºçš„æ€»å¤§å°\n1. ä¸è®¾ç½®å¦‚æœä¸è®¾ç½®-m,â€“memoryå’Œâ€“memory-swapï¼Œå®¹å™¨é»˜è®¤å¯ä»¥ç”¨å®Œå®¿èˆæœºçš„æ‰€æœ‰å†…å­˜å’Œ swap åˆ†åŒºã€‚ä¸è¿‡æ³¨æ„ï¼Œå¦‚æœå®¹å™¨å ç”¨å®¿ä¸»æœºçš„æ‰€æœ‰å†…å­˜å’Œ swap åˆ†åŒºè¶…è¿‡ä¸€æ®µæ—¶é—´åï¼Œä¼šè¢«å®¿ä¸»æœºç³»ç»Ÿæ€æ­»ï¼ˆå¦‚æœæ²¡æœ‰è®¾ç½®â€“00m-kill-disable=trueçš„è¯ï¼‰ã€‚\n2. è®¾ç½®-m,â€“memoryï¼Œä¸è®¾ç½®â€“memory-swapç»™-mæˆ–â€“memoryè®¾ç½®ä¸€ä¸ªä¸å°äº 4M çš„å€¼ï¼Œå‡è®¾ä¸º aï¼Œä¸è®¾ç½®â€“memory-swapï¼Œæˆ–å°†â€“memory-swapè®¾ç½®ä¸º 0ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®¹å™¨èƒ½ä½¿ç”¨çš„å†…å­˜å¤§å°ä¸º aï¼Œèƒ½ä½¿ç”¨çš„äº¤æ¢åˆ†åŒºå¤§å°ä¹Ÿä¸º aã€‚å› ä¸º Docker é»˜è®¤å®¹å™¨äº¤æ¢åˆ†åŒºçš„å¤§å°å’Œå†…å­˜ç›¸åŒã€‚\nå¦‚æœåœ¨å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ªä¸€ç›´ä¸åœç”³è¯·å†…å­˜çš„ç¨‹åºï¼Œä½ ä¼šè§‚å¯Ÿåˆ°è¯¥ç¨‹åºæœ€ç»ˆèƒ½å ç”¨çš„å†…å­˜å¤§å°ä¸º 2aã€‚\næ¯”å¦‚$ docker run -m 1G ubuntu:16.04ï¼Œè¯¥å®¹å™¨èƒ½ä½¿ç”¨çš„å†…å­˜å¤§å°ä¸º 1Gï¼Œèƒ½ä½¿ç”¨çš„ swap åˆ†åŒºå¤§å°ä¹Ÿä¸º 1Gã€‚å®¹å™¨å†…çš„è¿›ç¨‹èƒ½ç”³è¯·åˆ°çš„æ€»å†…å­˜å¤§å°ä¸º 2Gã€‚\n3. è®¾ç½®-m,â€“memory=aï¼Œâ€“memory-swap=bï¼Œä¸”b &gt; aç»™-mè®¾ç½®ä¸€ä¸ªå‚æ•° aï¼Œç»™â€“memory-swapè®¾ç½®ä¸€ä¸ªå‚æ•° bã€‚a æ—¶å®¹å™¨èƒ½ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œbæ˜¯å®¹å™¨èƒ½ä½¿ç”¨çš„ å†…å­˜å¤§å° + swap åˆ†åŒºå¤§å°ã€‚æ‰€ä»¥ b å¿…é¡»å¤§äº aã€‚b -a å³ä¸ºå®¹å™¨èƒ½ä½¿ç”¨çš„ swap åˆ†åŒºå¤§å°ã€‚\næ¯”å¦‚$ docker run -m 1G â€“memory-swap 3G ubuntu:16.04ï¼Œè¯¥å®¹å™¨èƒ½ä½¿ç”¨çš„å†…å­˜å¤§å°ä¸º 1Gï¼Œèƒ½ä½¿ç”¨çš„ swap åˆ†åŒºå¤§å°ä¸º 2Gã€‚å®¹å™¨å†…çš„è¿›ç¨‹èƒ½ç”³è¯·åˆ°çš„æ€»å†…å­˜å¤§å°ä¸º 3Gã€‚\n4. è®¾ç½®-m,â€“memory=aï¼Œâ€“memory-swap=-1ç»™-må‚æ•°è®¾ç½®ä¸€ä¸ªæ­£å¸¸å€¼ï¼Œè€Œç»™â€“memory-swapè®¾ç½®æˆ -1ã€‚è¿™ç§æƒ…å†µè¡¨ç¤ºé™åˆ¶å®¹å™¨èƒ½ä½¿ç”¨çš„å†…å­˜å¤§å°ä¸º aï¼Œè€Œä¸é™åˆ¶å®¹å™¨èƒ½ä½¿ç”¨çš„ swap åˆ†åŒºå¤§å°ã€‚\nè¿™æ—¶å€™ï¼Œå®¹å™¨å†…è¿›ç¨‹èƒ½ç”³è¯·åˆ°çš„å†…å­˜å¤§å°ä¸º a + å®¿ä¸»æœºçš„ swap å¤§å°ã€‚\n2ã€cpué™åˆ¶âœ  ~ docker run --helpUsage:\tdocker run [OPTIONS] IMAGE [COMMAND] [ARG...]Run a command in a new containerOptions:      --add-host list                  Add a custom host-to-IP mapping (host:ip)  -c, --cpu-shares int                 CPU shares (relative weight)      --cpus decimal                   Number of CPUs      --cpuset-cpus string             CPUs in which to allow execution (0-3, 0,1)      --cpuset-mems string             MEMs in which to allow execution (0-3, 0,1)\n\n\n\n\né€‰é¡¹\næè¿°\n\n\n\n--cpuset-cpus=&quot;&quot;\nå…è®¸ä½¿ç”¨çš„ CPU é›†ï¼Œå€¼å¯ä»¥ä¸º 0-3,0,1\n\n\n-c,--cpu-shares=0\nCPU å…±äº«æƒå€¼ï¼ˆç›¸å¯¹æƒé‡ï¼‰\n\n\ncpu-period=0\né™åˆ¶ CPU CFS çš„å‘¨æœŸï¼ŒèŒƒå›´ä» 100ms~1sï¼Œå³[1000, 1000000]\n\n\n--cpu-quota=0\né™åˆ¶ CPU CFS é…é¢ï¼Œå¿…é¡»ä¸å°äº1msï¼Œå³ &gt;= 1000\n\n\n--cpuset-mems=&quot;&quot;\nå…è®¸åœ¨ä¸Šæ‰§è¡Œçš„å†…å­˜èŠ‚ç‚¹ï¼ˆMEMsï¼‰ï¼Œåªå¯¹ NUMA ç³»ç»Ÿæœ‰æ•ˆ\n\n\nå…³äºCFSçš„æ¦‚å¿µï¼š https://www.jianshu.com/p/1da5cfd5cee4 \nåç«¯åŸºæœ¬ä¸éœ€è¦å…³æ³¨cpuï¼Œå› ä¸ºæœ¬èº«ä¸æ˜¯cpuå¯†é›†å‹ä¸šåŠ¡ï¼ŒåŸºæœ¬éƒ½æ˜¯ioå¯†é›†å‹/å†…å­˜å¯†é›†å‹ã€‚\n4ã€docker push å‘½ä»¤\n1ã€docker hubï¼Œç±»ä¼¼äºgitä¸€æ ·ï¼Œæ¯”å¦‚å¾ˆå¤šç§äººä»“åº“ï¼Œé»˜è®¤æ˜¯ hub.docker.comï¼Œ æ¯”å¦‚è¦†ç›–åˆ™ docker login aliyun.docker.com ç­‰ç­‰\n\ndocker login\n\nè¾“å…¥å§“åï¼Œè¾“å…¥å¯†ç \n\n2ã€ æŸ¥çœ‹æ¨é€çš„é•œåƒ\n\ndocker images go1.13.15        latest       ce2534430fc2    26 minutes ago   769MB\n\n\n3ã€ç¬¬ä¸€æ­¥éœ€è¦æ‰“tag\n\nä¸€èˆ¬æ˜¯ : docker tag &lt;é•œåƒåç§°&gt; &lt;ç”¨æˆ·å&gt;/&lt;é•œåƒåç§°&gt;:&lt;é•œåƒç‰ˆæœ¬å·&gt;\ndocker tag go1.13.15 fanhaodong/go1.13.15:v1.0\n\n\n4ã€push\n\nå‘½ä»¤ï¼š docker push &lt;ç”¨æˆ·å&gt;/&lt;é•œåƒåç§°&gt;:&lt;é•œåƒç‰ˆæœ¬å·&gt;\ndocker push fanhaodong/go1.13.15:v1.0\n\n5ã€docker å…¶ä»–å‘½ä»¤1ã€docker builddocker build  --build-arg arg=value --file Dockerfile_path --tag name:version  build_path\nFROM alpine:latest# å˜é‡ = é»˜è®¤å€¼ARG IMG_V=1.0 ENV IMG_V=$&#123;IMG_V&#125;CMD [ &quot;sh&quot;,&quot;-c&quot;,&quot;env&quot; ]\n\næ‰§è¡Œï¼š\nâœ  docker-file-test docker build --tag test:v1 --file ./Dockerfile --build-arg IMG_V=2.0 .Sending build context to Docker daemon  20.99kBStep 1/4 : FROM alpine:latest ---&gt; a24bb4013296Step 2/4 : ARG IMG_V=1.0 ---&gt; Running in bd247961f4c5Removing intermediate container bd247961f4c5 ---&gt; 48608560ae13Step 3/4 : ENV IMG_V=$&#123;IMG_V&#125; ---&gt; Running in 0ccb1c5aef84Removing intermediate container 0ccb1c5aef84 ---&gt; 45d309fc4a52Step 4/4 : CMD [ &quot;sh&quot;,&quot;-c&quot;,&quot;env&quot; ] ---&gt; Running in 6d266d8d8301Removing intermediate container 6d266d8d8301 ---&gt; d4ccf528c0edSuccessfully built d4ccf528c0edSuccessfully tagged test:v1âœ  docker-file-test docker run --rm test:v1HOSTNAME=59991997b9beSHLVL=1HOME=/rootIMG_V=2.0PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binPWD=/\n\nå¯ä»¥çœ‹åˆ°æˆåŠŸ æ‰§è¡Œäº†ç¯å¢ƒå˜é‡ï¼\n2ã€docker runä¼ é€’envFROM alpine:latestaCMD [ &quot;sh&quot;,&quot;-c&quot;,&quot;env&quot; ]\n\n[admin@centos-linux docker-file-test]$ docker build -t test-1 .Sending build context to Docker daemon  23.04kBStep 1/2 : FROM alpine:latest ---&gt; a24bb4013296Step 2/2 : CMD [ &quot;sh&quot;,&quot;-c&quot;,&quot;env&quot; ] ---&gt; Running in 65c81ab9dc1fRemoving intermediate container 65c81ab9dc1f ---&gt; 027268ad86eeSuccessfully built 027268ad86eeSuccessfully tagged test-1:latest[admin@centos-linux docker-file-test]$ docker run --env demo=1 test-1HOSTNAME=d4504e8ef3beSHLVL=1HOME=/rootPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bindemo=1PWD=/\n\nä¼ é€’ç¯å¢ƒå˜é‡ï¼Œæ˜¯å¯ä»¥åˆ°è¿è¡Œæ—¶ï¼\n3ã€docker  start\n\nshellè„šæœ¬å¯åŠ¨#!/bin/bash# è·å–cidCID=$(docker create --rm test-1)# æ ¹æ®cidå¯åŠ¨docker start $CID# flagecho &quot;start success!!!!&quot;\n\nè¿è¡Œ\n[admin@centos-linux docker-file-test]$ bash new.shdd9159e2d3da614f6dc7f816300d75ad58c6acf673eb9bea1e8a3f3af60a4137start success!!!!\n\ngood å¯åŠ¨äº† ï¼ï¼ï¼\n5ã€æŒ‚è½½docker run --rm -v /opt test-3\nå¦‚æœå®¹å™¨é”€æ¯ï¼Œå®¿ä¸»æœºæ–‡ä»¶ä¹Ÿä¼šè¢«é”€æ¯ï¼ï¼ï¼ï¼\n&quot;Mounts&quot;: [  &#123;      &quot;Type&quot;: &quot;volume&quot;,      &quot;Name&quot;: &quot;79c49a14a84ce8f6ba852e11d91a109ac1c02a6649e83f68b316990404035148&quot;,      &quot;Source&quot;: &quot;/var/lib/docker/volumes/79c49a14a84ce8f6ba852e11d91a109ac1c02a6649e83f68b316990404035148/_data&quot;,// å®¿ä¸»æœºç›®å½•      &quot;Destination&quot;: &quot;/opt&quot;, // å®¹å™¨ç›®å½•      &quot;Driver&quot;: &quot;local&quot;,      &quot;Mode&quot;: &quot;&quot;,      &quot;RW&quot;: true,      &quot;Propagation&quot;: &quot;&quot;  &#125;],&quot;Volumes&quot;: &#123;      &quot;/home/admin/dong/docker/docker-file-test&quot;: &#123;&#125;  &#125;,\n\ndocker run --rm -v /home/admin/dong/docker/docker-file-te/:/opt test-3\n&quot;Mounts&quot;: [    &#123;        &quot;Type&quot;: &quot;bind&quot;,        &quot;Source&quot;: &quot;/home/admin/dong/docker/docker-file-test&quot;,        &quot;Destination&quot;: &quot;/opt&quot;,        &quot;Mode&quot;: &quot;&quot;,        &quot;RW&quot;: true,        &quot;Propagation&quot;: &quot;rprivate&quot;    &#125;],\n\n6ã€docker commit\nâ€‹    è¿™ä¸ªæ¯”è¾ƒé€‚åˆä¸ä¼šå†™docker fileçš„äººï¼Œè¿™é‡Œæˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªcentos:7\n\ndocker pull centos:7\n\nå…¶æ¬¡ï¼Œæˆ‘ä»¬è¦å®‰è£…ä¸€ä¸ªcurlå‘½ä»¤\nâœ  /data docker run --rm -it 7e6257c9f8d8  /bin/bash[root@bcdaea8354a6 /]# yum install -y curl[root@bcdaea8354a6 /]# curl www.baidu.com&lt;!DOCTYPE html&gt; // good\n\næ­¤æ—¶æˆ‘ä»¬åªéœ€è¦è¿›è¡Œ\nâœ  ~ docker ps -a -lCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMESbcdaea8354a6        7e6257c9f8d8        &quot;/bin/bash&quot;         2 minutes ago       Up 2 minutes                            happy_liskovâœ  ~ docker commit bcdaea8354a6  demo-2sha256:350fbf288cb1a47a29e3d8e441e2814726de6faf54d044a585fb80b7a1f38f83\n\nè¿™ä¸ªé•œåƒå°±OKäº†ï¼Œå°±å¯ä»¥ä½¿ç”¨ demo-2çš„é•œåƒäº†\n","categories":["äº‘åŸç”Ÿ"],"tags":["Docker"]},{"title":"Protobuf-SourceCodeInfo ä»‹ç»","url":"/2023/01/31/5c4904cd995fb585e97a439065161818/","content":"PB æ„Ÿè§‰å·¥å…·éå¸¸æˆç†Ÿï¼Œè¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯protoc æä¾›äº†å¾ˆå¤šæ ¸å¿ƒçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç›´æ¥æ‹¿æ¥å³ç”¨å³å¯ï¼Œprotocè§£æåçš„ FileDescriptorSet è¶³å¤Ÿæˆ‘ä»¬å»å®ç° ä»£ç ç”Ÿæˆã€ç”ŸæˆAPIæ–‡æ¡£ã€åè®®è½¬æ¢ ç­‰å…¨éƒ¨åŠŸèƒ½äº†ï¼Œè¿™é‡Œæˆ‘æ ¸å¿ƒè®²è§£ä¸€ä¸‹ SourceCodeInfo çš„è®¾è®¡ï¼Œå…¶ä»–éƒ¨åˆ†æ„Ÿè§‰å¾ˆå¥½ç†è§£ï¼\n\n\nSourceCodeInfo ä»‹ç»message SourceCodeInfo &#123;\t  // ä»ä½œç”¨åŸŸå¤§åˆ°å°+ä»å‰åˆ°åçš„é¡ºåº è¿›è¡Œæ’åº  repeated Location location = 1;     message Location &#123;    // è¿™ä¸ªè¡¨ç¤ºå…·ä½“çš„è·¯å¾„ï¼Œè¡¨ç¤ºæ¥å£å®šä¹‰ï¼Œå®é™…ä¸Šä¹Ÿä¸éš¾ç†è§£    // ä¾‹å¦‚ [5,0,2,1] è¡¨ç¤ºçš„æ˜¯ enum_type[0].value[1] å®ƒæ‰€åœ¨çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„æ˜¯ `Tow = 2;` å¯¹åº”çš„åŒºåŸŸ    //    // 5: è¡¨ç¤ºå­—æ®µ5ï¼Œå­—æ®µåç§°: enum_typeï¼Œå­—æ®µç±»å‹: list&lt;DescriptorProto&gt;    // 0: è¡¨ç¤ºç´¢å¼•ä¸º0ï¼ŒåŸå› æ˜¯å­—æ®µ5ç±»å‹æ˜¯æ•°ç»„    // 2: è¡¨ç¤ºå­—æ®µ2ï¼Œå­—æ®µåç§°: value, å­—æ®µç±»: list&lt;EnumValueDescriptorProto&gt;    // 1: è¡¨ç¤ºç´¢å¼•ä¸º1ï¼ŒåŸå› æ˜¯å­—æ®µ2ç±»å‹æ˜¯æ•°ç»„    //     // æ‰€ä»¥æˆ‘æ„Ÿè§‰æœ€æœ‰æ„æ€çš„å®é™…ä¸Šè¿˜æ˜¯pathè¿™ä¸ªè®¾è®¡ï¼Œç±»ä¼¼äºflat-jsonè¿™ç§json-pathï¼Œä½†æ˜¯å®ƒçš„è®¾å®šæ˜¯ç´§å‡‘ã€å·§å¦™ã€å‡†ç¡®çš„    repeated int32 path = 1 [packed = true];        // è¿™é‡Œè¡¨ç¤ºæŸä¸ª file/message/enum/field/method æ‰€åœ¨çš„ä½ç½®ï¼Œç”¨åæ ‡å›´èµ·æ¥    // å››åæ ‡[0,0,48,1] : èµ·å§‹è¡Œ: 0, èµ·å§‹åˆ—: 0, ç»“æŸè¡Œ: 48, ç»“æŸåˆ—: 1    // ä¸‰åæ ‡[2,0,42]: èµ·å§‹è¡Œ: 2, èµ·å§‹åˆ—: 0, ç»“æŸè¡Œ: 2, ç»“æŸåˆ—: 42    repeated int32 span = 2 [packed = true];        // è¿™é‡Œè¡¨ç¤ºå¤´éƒ¨çš„comment    optional string leading_comments = 3;        // è¿™é‡Œè¡¨ç¤ºå°¾éƒ¨çš„comment    optional string trailing_comments = 4;        // è¿™é‡Œè¡¨ç¤º ä¸å±äº/å®šä¹‰æ¨¡ç³Š/è„±ç¦» çš„comment ï¼ˆä¸€èˆ¬ä¸ä¼šå–è¿™éƒ¨åˆ†ä½œä¸ºè¿™ä¸ªå­—æ®µ/ç±»å‹çš„æ³¨é‡Šï¼‰    repeated string leading_detached_comments = 6;  &#125;&#125;message FileDescriptorSet &#123;  repeated FileDescriptorProto file = 1;&#125;// Describes a complete .proto file.message FileDescriptorProto &#123;  optional string name = 1;  optional string package = 2;  repeated string dependency = 3;  repeated int32 public_dependency = 10;  repeated int32 weak_dependency = 11;  repeated DescriptorProto message_type = 4;  repeated EnumDescriptorProto enum_type = 5;  repeated ServiceDescriptorProto service = 6;  repeated FieldDescriptorProto extension = 7;  optional FileOptions options = 8;  optional SourceCodeInfo source_code_info = 9;  optional string syntax = 12;&#125;// Describes an enum type.message EnumDescriptorProto &#123;  optional string name = 1;  repeated EnumValueDescriptorProto value = 2;  optional EnumOptions options = 3;  message EnumReservedRange &#123;    optional int32 start = 1;  // Inclusive.    optional int32 end = 2;    // Inclusive.  &#125;  repeated EnumReservedRange reserved_range = 4;  repeated string reserved_name = 5;&#125;\n\nå¦‚ä½•è·å– sourcecode info\nå®šä¹‰api.protoæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n\nsyntax = &quot;proto2&quot;;option java_package = &quot;com.byted.xxx.xxx&quot;;enum Num &#123;    // æ³¨é‡Š    One = 1; // æ³¨é‡Š    // æ³¨é‡Š    Tow = 2;    // Three = 3;    // 1111    // 222    // 333    Four = 4; // æ³¨é‡Š&#125;// 111message Request &#123;    // 1    // 2    optional string name = 1;    /**    * 123    */    repeated int32 nums = 3 [packed = true];    /* title    hello world    */    map&lt;string, int64&gt; kv = 4;    required Num num= 5;    optional  InlineRequest req = 6;    message InlineRequest &#123;    &#125;&#125;message Response &#123;&#125;service Demo &#123;    // 33    // 22    rpc MethodName (Request) returns (Response); // 11    // 44&#125;\n\n\nè·å– source-info\n\nprotoc  -I . --descriptor_set_out=out.pb --include_source_info  api.proto\n\n\nè§£æ out.pb æ–‡ä»¶ï¼Œè¿™é‡Œä»»ä½•è¯­è¨€éƒ½å¯ä»¥ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯Go\n\npackage codecimport (\t&quot;google.golang.org/protobuf/encoding/protojson&quot;\t&quot;google.golang.org/protobuf/proto&quot;\t&quot;google.golang.org/protobuf/types/descriptorpb&quot;\t&quot;io/ioutil&quot;\t&quot;testing&quot;)func TestProto(t *testing.T) &#123;\tset := descriptorpb.FileDescriptorSet&#123;&#125;\tfile, _ := ioutil.ReadFile(&quot;/Users/bytedance/data/pb_file/out.pb&quot;)\tif err := proto.Unmarshal(file, &amp;set); err != nil &#123;\t\tt.Fatal(err)\t&#125;\tt.Log(protojson.Format(&amp;set))&#125;\n\n\nè·å– source infoï¼Œæˆ‘è¿™é‡Œè¾“å‡ºçš„æ˜¯JSON\n\n&#123;    &quot;file&quot;: [        &#123;            &quot;name&quot;: &quot;api.proto&quot;,            &quot;messageType&quot;: [                &#123;                    &quot;name&quot;: &quot;Request&quot;,                    &quot;field&quot;: [                        &#123;                            &quot;name&quot;: &quot;name&quot;,                            &quot;number&quot;: 1,                            &quot;label&quot;: &quot;LABEL_OPTIONAL&quot;,                            &quot;type&quot;: &quot;TYPE_STRING&quot;,                            &quot;jsonName&quot;: &quot;name&quot;                        &#125;,                        &#123;                            &quot;name&quot;: &quot;nums&quot;,                            &quot;number&quot;: 3,                            &quot;label&quot;: &quot;LABEL_REPEATED&quot;,                            &quot;type&quot;: &quot;TYPE_INT32&quot;,                            &quot;jsonName&quot;: &quot;nums&quot;,                            &quot;options&quot;: &#123;                                &quot;packed&quot;: true                            &#125;                        &#125;,                        &#123;                            &quot;name&quot;: &quot;kv&quot;,                            &quot;number&quot;: 4,                            &quot;label&quot;: &quot;LABEL_REPEATED&quot;,                            &quot;type&quot;: &quot;TYPE_MESSAGE&quot;,                            &quot;typeName&quot;: &quot;.Request.KvEntry&quot;,                            &quot;jsonName&quot;: &quot;kv&quot;                        &#125;,                        &#123;                            &quot;name&quot;: &quot;num&quot;,                            &quot;number&quot;: 5,                            &quot;label&quot;: &quot;LABEL_REQUIRED&quot;,                            &quot;type&quot;: &quot;TYPE_ENUM&quot;,                            &quot;typeName&quot;: &quot;.Num&quot;,                            &quot;jsonName&quot;: &quot;num&quot;                        &#125;,                        &#123;                            &quot;name&quot;: &quot;req&quot;,                            &quot;number&quot;: 6,                            &quot;label&quot;: &quot;LABEL_OPTIONAL&quot;,                            &quot;type&quot;: &quot;TYPE_MESSAGE&quot;,                            &quot;typeName&quot;: &quot;.Request.InlineRequest&quot;,                            &quot;jsonName&quot;: &quot;req&quot;                        &#125;                    ],                    &quot;nestedType&quot;: [                        &#123;                            &quot;name&quot;: &quot;KvEntry&quot;,                            &quot;field&quot;: [                                &#123;                                    &quot;name&quot;: &quot;key&quot;,                                    &quot;number&quot;: 1,                                    &quot;label&quot;: &quot;LABEL_OPTIONAL&quot;,                                    &quot;type&quot;: &quot;TYPE_STRING&quot;,                                    &quot;jsonName&quot;: &quot;key&quot;                                &#125;,                                &#123;                                    &quot;name&quot;: &quot;value&quot;,                                    &quot;number&quot;: 2,                                    &quot;label&quot;: &quot;LABEL_OPTIONAL&quot;,                                    &quot;type&quot;: &quot;TYPE_INT64&quot;,                                    &quot;jsonName&quot;: &quot;value&quot;                                &#125;                            ],                            &quot;options&quot;: &#123;                                &quot;mapEntry&quot;: true                            &#125;                        &#125;,                        &#123;                            &quot;name&quot;: &quot;InlineRequest&quot;                        &#125;                    ]                &#125;,                &#123;                    &quot;name&quot;: &quot;Response&quot;                &#125;            ],            &quot;enumType&quot;: [                &#123;                    &quot;name&quot;: &quot;Num&quot;,                    &quot;value&quot;: [                        &#123;                            &quot;name&quot;: &quot;One&quot;,                            &quot;number&quot;: 1                        &#125;,                        &#123;                            &quot;name&quot;: &quot;Tow&quot;,                            &quot;number&quot;: 2                        &#125;,                        &#123;                            &quot;name&quot;: &quot;Four&quot;,                            &quot;number&quot;: 4                        &#125;                    ]                &#125;            ],            &quot;service&quot;: [                &#123;                    &quot;name&quot;: &quot;Demo&quot;,                    &quot;method&quot;: [                        &#123;                            &quot;name&quot;: &quot;MethodName&quot;,                            &quot;inputType&quot;: &quot;.Request&quot;,                            &quot;outputType&quot;: &quot;.Response&quot;                        &#125;                    ]                &#125;            ],            &quot;options&quot;: &#123;                &quot;javaPackage&quot;: &quot;com.byted.xxx.xxx&quot;            &#125;,            &quot;sourceCodeInfo&quot;: &#123;                &quot;location&quot;: [                    &#123;                        &quot;span&quot;: [ //è¡¨ç¤ºæ•´ä¸ªæ–‡ä»¶                            0,                            0,                            48,                            1                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            12                        ],                        &quot;span&quot;: [ // ç¬¬1è¡Œï¼Œå®šä¹‰äº†syntax                            0,                            0,                            18                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            8                        ],                        &quot;span&quot;: [ // ç¬¬3è¡Œï¼Œå®šä¹‰äº† FileOptions                            2,                            0,                            42                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [ //  ç¬¬3è¡Œï¼Œå®šä¹‰äº† FileOptions.java_package                            8,                            1                        ],                        &quot;span&quot;: [                            2,                            0,                            42                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [ // ç¬¬5è¡Œ-17è¡Œï¼Œå®šä¹‰äº†ç¬¬ä¸€ä¸ªæšä¸¾                            5,                            0                        ],                        &quot;span&quot;: [                            4,                            0,                            16,                            1                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [ // ç¬¬5è¡Œï¼Œå®šä¹‰äº†ç¬¬ä¸€ä¸ªæšä¸¾çš„åç§°                            5,                            0,                            1                        ],                        &quot;span&quot;: [                            4,                            5,                            8                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [ // ç¬¬7è¡Œï¼Œå®šä¹‰äº†ç¬¬ä¸€ä¸ªæšä¸¾çš„ç¬¬ä¸€ä¸ªæšä¸¾å€¼                            5,                            0,                            2,                            0                        ],                        &quot;span&quot;: [                            6,                            4,                            12                        ],                        &quot;leadingComments&quot;: &quot; æ³¨é‡Š\\n&quot;,                        &quot;trailingComments&quot;: &quot; æ³¨é‡Š\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            0,                            1                        ],                        &quot;span&quot;: [                            6,                            4,                            7                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            0,                            2                        ],                        &quot;span&quot;: [                            6,                            10,                            11                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            1                        ],                        &quot;span&quot;: [                            8,                            4,                            12                        ],                        &quot;leadingComments&quot;: &quot; æ³¨é‡Š\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            1,                            1                        ],                        &quot;span&quot;: [                            8,                            4,                            7                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            1,                            2                        ],                        &quot;span&quot;: [                            8,                            10,                            11                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            2                        ],                        &quot;span&quot;: [                            15,                            4,                            13                        ],                        &quot;leadingComments&quot;: &quot; 333\\n&quot;,                        &quot;trailingComments&quot;: &quot; æ³¨é‡Š\\n&quot;,                        &quot;leadingDetachedComments&quot;: [                            &quot; Three = 3;\\n 1111\\n 222\\n&quot;                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            2,                            1                        ],                        &quot;span&quot;: [                            15,                            4,                            8                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            5,                            0,                            2,                            2,                            2                        ],                        &quot;span&quot;: [                            15,                            11,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [ // ç¬¬20è¡Œ-39è¡Œ å®šä¹‰äº† ç¬¬ä¸€ä¸ªç»“æ„ä½“                            4,                            0                        ],                        &quot;span&quot;: [                            19,                            0,                            38,                            1                        ],                        &quot;leadingComments&quot;: &quot; 111\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            1                        ],                        &quot;span&quot;: [                            19,                            8,                            15                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            0                        ],                        &quot;span&quot;: [                            22,                            4,                            29                        ],                        &quot;leadingComments&quot;: &quot; 1\\n 2\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            0,                            4                        ],                        &quot;span&quot;: [                            22,                            4,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            0,                            5                        ],                        &quot;span&quot;: [                            22,                            13,                            19                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            0,                            1                        ],                        &quot;span&quot;: [                            22,                            20,                            24                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            0,                            3                        ],                        &quot;span&quot;: [                            22,                            27,                            28                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1                        ],                        &quot;span&quot;: [                            26,                            4,                            44                        ],                        &quot;leadingComments&quot;: &quot;*\\n 123\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            4                        ],                        &quot;span&quot;: [                            26,                            4,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            5                        ],                        &quot;span&quot;: [                            26,                            13,                            18                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            1                        ],                        &quot;span&quot;: [                            26,                            19,                            23                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            3                        ],                        &quot;span&quot;: [                            26,                            26,                            27                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            8                        ],                        &quot;span&quot;: [                            26,                            28,                            43                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            1,                            8,                            2                        ],                        &quot;span&quot;: [                            26,                            29,                            42                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            2                        ],                        &quot;span&quot;: [                            30,                            4,                            30                        ],                        &quot;leadingComments&quot;: &quot; title\\nhello world\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            2,                            6                        ],                        &quot;span&quot;: [                            30,                            4,                            22                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            2,                            1                        ],                        &quot;span&quot;: [                            30,                            23,                            25                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            2,                            3                        ],                        &quot;span&quot;: [                            30,                            28,                            29                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            3                        ],                        &quot;span&quot;: [                            32,                            4,                            24                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            3,                            4                        ],                        &quot;span&quot;: [                            32,                            4,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            3,                            6                        ],                        &quot;span&quot;: [                            32,                            13,                            16                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            3,                            1                        ],                        &quot;span&quot;: [                            32,                            17,                            20                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            3,                            3                        ],                        &quot;span&quot;: [                            32,                            22,                            23                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            4                        ],                        &quot;span&quot;: [                            34,                            4,                            36                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            4,                            4                        ],                        &quot;span&quot;: [                            34,                            4,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            4,                            6                        ],                        &quot;span&quot;: [                            34,                            14,                            27                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            4,                            1                        ],                        &quot;span&quot;: [                            34,                            28,                            31                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            2,                            4,                            3                        ],                        &quot;span&quot;: [                            34,                            34,                            35                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            3,                            1                        ],                        &quot;span&quot;: [                            35,                            4,                            37,                            5                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            0,                            3,                            1,                            1                        ],                        &quot;span&quot;: [                            35,                            12,                            25                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            1                        ],                        &quot;span&quot;: [                            40,                            0,                            19                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            4,                            1,                            1                        ],                        &quot;span&quot;: [                            40,                            8,                            16                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0                        ],                        &quot;span&quot;: [                            42,                            0,                            48,                            1                        ],                        &quot;trailingComments&quot;: &quot; 33\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0,                            1                        ],                        &quot;span&quot;: [                            42,                            8,                            12                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0,                            2,                            0                        ],                        &quot;span&quot;: [                            46,                            4,                            48                        ],                        &quot;leadingComments&quot;: &quot; 22\\n&quot;,                        &quot;trailingComments&quot;: &quot; 11\\n&quot;                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0,                            2,                            0,                            1                        ],                        &quot;span&quot;: [                            46,                            8,                            18                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0,                            2,                            0,                            2                        ],                        &quot;span&quot;: [                            46,                            20,                            27                        ]                    &#125;,                    &#123;                        &quot;path&quot;: [                            6,                            0,                            2,                            0,                            3                        ],                        &quot;span&quot;: [                            46,                            38,                            46                        ]                    &#125;                ]            &#125;        &#125;    ]&#125;\n\nå¦‚ä½•è§£æ/ä½¿ç”¨ SourceCodeInfoé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬éœ€è¦SourceCodeInfo åšå•¥äº†ï¼Œé‚£å½“ç„¶æ˜¯åš ä»£ç ç”Ÿæˆã€æ¥å£æ–‡æ¡£å±•ç¤ºã€IDEäº†ï¼\nå…·ä½“åšæ³•å¤§æ¦‚æœ‰ä¸¤ç§åšæ³•ï¼Œæ‡’åŠ è½½/é¢„åŠ è½½ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½å¯å–ï¼Œçœ‹å®é™…éœ€æ±‚å³å¯ï¼\né’ˆå¯¹äºåœºæ™¯ä¸€ä¸ªäººæ¯”è¾ƒæ¨èé¢„åŠ è½½ï¼Œå› ä¸ºæ‡’åŠ è½½éœ€è¦æ¯æ¬¡éƒ½éœ€è¦éå† SourceCodeInfoï¼Œè€Œé¢„åŠ è½½æ€§èƒ½ä¼šå¾ˆé«˜ï¼\næ‡’åŠ è½½æˆ‘ä»¬çŸ¥é“å¯¹äºä¸€ä¸ªå­—æ®µ/ç±»å‹æ¥è¯´ï¼Œå®ƒçš„ç´¢å¼•æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦å»SourceCodeInfoä¸­æŸ¥æ‰¾å³å¯ï¼Œä¸ºæ­¤å®ç°ä¼šå¾ˆç®€å•\nä¾‹å¦‚æˆ‘ä»¬è¦æŸ¥æ‰¾ Num.One çš„æ³¨é‡Šé‚£ä¹ˆæ ¹æ®ç´¢å¼•ï¼Œå¯ä»¥çŸ¥é“æ˜¯ ä¸€ä¸ªæšä¸¾çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå› æ­¤åæ ‡æ˜¯ [5,0,2,0]ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯\n&#123;    &quot;path&quot;: [        5,        0,        2,        0    ],    &quot;span&quot;: [        6,        4,        12    ],    &quot;leadingComments&quot;: &quot; æ³¨é‡Š\\n&quot;,    &quot;trailingComments&quot;: &quot; æ³¨é‡Š\\n&quot;&#125;\n\né¢„åŠ è½½å°±æ˜¯å…ˆéå†ï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬åªæ˜¯å¤„ç†å­—æ®µçš„æ³¨é‡Šï¼Œé‚£ä¹ˆåªéœ€è¦å¤„ç†ä»¥ä¸‹å‡ ä¸ªå¯¹å·å…¥åº§å³å¯ï¼\n\n[4,x,2,x]ï¼š è¡¨ç¤ºmessageå­—æ®µæ³¨é‡Š\n[5,x,2,x]ï¼šè¡¨ç¤ºenum å­—æ®µæ³¨é‡Š\n[6,x,2,x]ï¼šè¡¨ç¤ºmethod æ³¨é‡Š\n[4,x]ï¼šè¡¨ç¤ºmessage æ³¨é‡Š\n[5,x]ï¼šè¡¨ç¤ºenumæ³¨é‡Š\n[6,x]ï¼šè¡¨ç¤ºserviceæ³¨é‡Š\n\nå‚è€ƒæ–‡ç« \nBest way to parse SourceCodeInfo Data From Protobuf Files\n\n","categories":["RPC"],"tags":["Protobuf"]},{"title":"grpc","url":"/2021/11/29/5d738324e2189d8e9a1c3974d34f5a95/","content":"â€‹    å­¦ä¹ grpcæ–‡ä»¶\n\n\n1ã€rpc1ã€wikipediaæ¦‚å¿µåœ¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆè‹±è¯­ï¼šRemote Procedure Callï¼Œç¼©å†™ä¸º RPCï¼‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡åè®®ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªå¼€æ”¾ç½‘ç»œçš„ä¸€å°è®¡ç®—æœºï¼‰çš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜å°±åƒè°ƒç”¨æœ¬åœ°ç¨‹åºä¸€æ ·ï¼Œæ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ï¼ˆæ— éœ€å…³æ³¨ç»†èŠ‚ï¼‰ã€‚RPCæ˜¯ä¸€ç§æœåŠ¡å™¨-å®¢æˆ·ç«¯ï¼ˆClient/Serverï¼‰æ¨¡å¼ï¼Œç»å…¸å®ç°æ˜¯ä¸€ä¸ªé€šè¿‡å‘é€è¯·æ±‚-æ¥å—å›åº”è¿›è¡Œä¿¡æ¯äº¤äº’çš„ç³»ç»Ÿã€‚\nå¦‚æœæ¶‰åŠçš„è½¯ä»¶é‡‡ç”¨é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé‚£ä¹ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨äº¦å¯ç§°ä½œè¿œç¨‹è°ƒç”¨æˆ–è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œä¾‹ï¼šJava RMIã€‚\nRPCæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æ¨¡å¼ï¼Œç¨‹åºåˆ†å¸ƒåœ¨ä¸åŒçš„åœ°å€ç©ºé—´é‡Œã€‚å¦‚æœåœ¨åŒä¸€ä¸»æœºé‡Œï¼ŒRPCå¯ä»¥é€šè¿‡ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆå³ä¾¿ä½¿ç”¨ç›¸åŒçš„ç‰©ç†åœ°å€ï¼‰è¿›è¡Œé€šè®¯ï¼Œè€Œåœ¨ä¸åŒçš„ä¸»æœºé—´ï¼Œåˆ™é€šè¿‡ä¸åŒçš„ç‰©ç†åœ°å€è¿›è¡Œäº¤äº’ã€‚è®¸å¤šæŠ€æœ¯ï¼ˆå¸¸å¸¸æ˜¯ä¸å…¼å®¹ï¼‰éƒ½æ˜¯åŸºäºè¿™ç§æ¦‚å¿µè€Œå®ç°çš„ã€‚\n\n2ã€httpå’Œrpcçš„åŒºåˆ«1ã€httpæŒ‡çš„æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå®ƒæä¾›çš„åªæ˜¯ä¸€ä¸ªä¼ è¾“åè®®\n2ã€rpcè®²çš„æ˜¯ä¸€ä¸ªè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œä¸€ä¸ªrpcæ¶æ„åŒ…å«äº†å¤šä¸ªå±‚çº§ï¼Œä»¥dubboçš„æ¶æ„æ¥\nrpcå…¶å®æ¶æ„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸‹é¢ä¸€å›¾ï¼Œä½†æ˜¯å…·ä½“å®ç°ä¸Šå·®å¼‚è¿˜æ˜¯æœ‰ç‚¹ï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰€äº†è§£çš„ http + json åªèƒ½è¯´æ˜¯dubbo åªèƒ½è¯´æ˜¯dubboçš„æœ€ä¸‹å±‚å®ç°ï¼Œæ‰€ä»¥ rpcç›¸å¯¹æ¥è¯´åå‘äºæœåŠ¡æ²»ç†è¿™ä¸€å—\n\n\n3ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦rpcæ¡†æ¶ï¼Œhttp1.1 æä¾›çš„rest apiä¸è¡Œå—1ã€ä¸æ”¯æŒé•¿è¿æ¥ï¼Œkeepalive \n2ã€http1.1 ping-pang  client - server http , å»ºç«‹å¾ˆå¤šä¸ªè¿æ¥ (http tcp è¿æ¥æ…¢ï¼Œä¼ è¾“/çª—å£) \n3ã€rpc å¤šè·¯å¤ç”¨èƒ½åŠ› (http2/3) client - server (io) ï¼Œserver åŒ… (äºŒè¿›åˆ¶) -&gt; go  é¡ºåº http2 å¥‡å¶ \n4ã€å¹¶å‘æ€§\n5ã€rpc tcp ä¼ è¾“ -&gt; http1.1 çº¯æ–‡æœ¬  å¤´éƒ¨ï¼Œ rcp  hello  è¡Œå¤´ä½“ \n5ã€ json rpc \n4ã€æ¯”è¾ƒå‡ºåçš„rpcæ¡†æ¶\nJava: JNI ï¼Œ WebService ï¼Œ Dubbo ï¼ŒHSF ï¼Œspringçš„Feigné‚£ä¸€å¥—ï¼Œgrpc\nGolang: gorpc ï¼Œgrpc ç­‰\nC++ï¼šSvrkit ï¼Œgrpc ç­‰\n\nå¤§å‚ç”¨çš„å§ï¼Œå„å¤§å‚éƒ½æœ‰è‡ªå·±çš„è½®å­ï¼Œæ¯”å¦‚ thriftï¼Œgprcï¼ŒTarsï¼Œbrpc ï¼Œmotanï¼Œ dubbo    è¿˜æœ‰å¾ˆå¤šå§\nå…¶å®è½®ç”Ÿæ€çš„è¯ï¼Œç»å¯¹æ˜¯å¼€æºé¡¹ç›®çš„ç”Ÿæ€æ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥å¼€æºé¡¹ç›®ä¸­ç”Ÿæ€æ¯”è¾ƒå¥½çš„å°±æ˜¯  grpc,thrift,dubbo ï¼Œä½¿ç”¨éš¾åº¦ä¸Šæ¥çœ‹ dubboæ˜¯æœ€ç®€å•çš„ï¼Œå¦‚æœä½ ä»¬å…¨Javaçš„è¯å®ƒæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼\n2ã€grpcä»‹ç»\nâ€‹    gRPC æ˜¯ä¸€ä¸ªç°ä»£çš„å¼€æºé«˜æ€§èƒ½è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(Remote Procedure Callï¼ŒRPC)æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œã€‚å®ƒå¯ä»¥é«˜æ•ˆåœ°è¿æ¥æ•°æ®ä¸­å¿ƒå†…éƒ¨å’Œè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡ï¼Œå¹¶ä¸ºè´Ÿè½½å¹³è¡¡ã€è·Ÿè¸ªã€å¥åº·æ£€æŸ¥å’Œèº«ä»½éªŒè¯æä¾›å¯æ’æ‹”çš„æ”¯æŒã€‚å®ƒä¹Ÿé€‚ç”¨äºæœ€åä¸€è‹±é‡Œçš„åˆ†å¸ƒå¼è®¡ç®—è¿æ¥è®¾å¤‡ï¼Œç§»åŠ¨åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨çš„åç«¯æœåŠ¡ã€‚\n\n1ã€å¼€æºçš„grpcå®˜æ–¹ï¼Œä¸»è¦æä¾›çš„èƒ½åŠ›\n\næœåŠ¡è°ƒç”¨ï¼ˆæä¾›æœ‰streamæµï¼Œè¯·æ±‚å“åº”ç±»å‹çš„ï¼‰\nè´Ÿè½½å‡è¡¡ (æä¾›xsdåè®®)\næƒé™(å®‰å…¨æ–¹é¢)\n\n2ã€grpcä¸»è¦é‡‡ç”¨çš„æŠ€æœ¯\n\nä¼ è¾“å±‚ï¼šhttp2åè®®\nåºåˆ—åŒ–å±‚ï¼šprotobuf \nè´Ÿè½½å‡è¡¡ï¼šxsd\n\n3ã€æ¨èå­¦ä¹ æ–‡ç« ï¼Œå…¶å®grpcæ˜¯å¥”ç€ä¸€ä¸ªè§„èŒƒå»èµ°äº†ï¼Œæ‰€ä»¥åœ¨å¼€æºé¡¹ç›®ä¸­æ‰€ä½¿ç”¨grpcçš„é¡¹ç›®æœ‰å¾ˆå¤šï¼Œäº‘åŸç”Ÿä¸­å¤§é‡çš„é¡¹ç›®ä½¿ç”¨grpc\nå…³äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ€è€ƒ\nå…³äºHTTP2ç›¸å…³çŸ¥è¯†\nXDSæ ‡å‡†å¼•å…¥GRPC\nå…³äºxsdçš„å­¦ä¹ \nâœ  grpc-go git:(master) âœ— tree -L 2.â”œâ”€â”€ api ## pb é¡¹ç›®(ä¸åŒä¸šåŠ¡ç»„åç§°æ˜¯ä¸ä¸€æ ·çš„ï¼Œåƒæˆ‘ä»¬ç»„ç›´æ¥å«é¡¹ç›®åå­—ç›´æ¥å«api)â”‚Â Â  â”œâ”€â”€ Makefile ## è„šæœ¬â”‚Â Â  â”œâ”€â”€ bin ## protoc / protoc-gen-go/ protoc-gen-gofast è„šæœ¬ç”¨æ¥ç”Ÿæˆpbæ–‡ä»¶â”‚Â Â  â”œâ”€â”€ dto ## ä¼ è¾“å±‚æ•°æ®â”‚Â Â  â”œâ”€â”€ go.modâ”‚Â Â  â”œâ”€â”€ go.sumâ”‚Â Â  â””â”€â”€ third ## rpcæ¥å£ï¼Œæˆ‘ä»¬è¿™é‡Œå«åšthirdâ””â”€â”€ service ## ä¸šåŠ¡é¡¹ç›®    â”œâ”€â”€ client.go    â”œâ”€â”€ common ##common    â”œâ”€â”€ go.mods    â”œâ”€â”€ go.sum    â”œâ”€â”€ lbs-service.go    â”œâ”€â”€ service ## å…·ä½“ä¸šåŠ¡å±‚    â””â”€â”€ user-service.go\n\n3ã€protobuf ä»‹ç»1ã€ä»‹ç»å’Œæ–‡æ¡£\nâ€‹    Protocol Buffers æ˜¯ä¸€ç§è¯­è¨€æ— å…³ã€å¹³å°æ— å…³ã€å¯æ‰©å±•çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå®ƒå¯ç”¨äºï¼ˆæ•°æ®ï¼‰é€šä¿¡åè®®ã€æ•°æ®å­˜å‚¨ç­‰ã€‚Protocol Buffers æ˜¯ä¸€ç§çµæ´»ï¼Œé«˜æ•ˆï¼Œè‡ªåŠ¨åŒ–æœºåˆ¶çš„ç»“æ„æ•°æ®åºåˆ—åŒ–æ–¹æ³•ï¼å¯ç±»æ¯” XMLï¼Œä½†æ˜¯æ¯” XML æ›´å°ï¼ˆ3 ~ 10å€ï¼‰ã€æ›´å¿«ï¼ˆ20 ~ 100å€ï¼‰ã€æ›´ä¸ºç®€å•ã€‚ä½ å¯ä»¥å®šä¹‰æ•°æ®çš„ç»“æ„ï¼Œç„¶åä½¿ç”¨ç‰¹æ®Šç”Ÿæˆçš„æºä»£ç è½»æ¾çš„åœ¨å„ç§æ•°æ®æµä¸­ä½¿ç”¨å„ç§è¯­è¨€è¿›è¡Œç¼–å†™å’Œè¯»å–ç»“æ„æ•°æ®ã€‚ä½ ç”šè‡³å¯ä»¥æ›´æ–°æ•°æ®ç»“æ„ï¼Œè€Œä¸ç ´åç”±æ—§æ•°æ®ç»“æ„ç¼–è¯‘çš„å·²éƒ¨ç½²ç¨‹åºã€‚\n\n\nwiki: https://en.wikipedia.org/wiki/Protocol_Buffers\nprotobufæ˜¯ Google çš„è¯­è¨€ä¸­ç«‹ã€å¹³å°ä¸­ç«‹ã€å¯æ‰©å±•çš„ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–æœºåˆ¶\nç¼–è¯‘å™¨æ˜¯ç”¨ c + + ç¼–å†™ï¼Œé«˜æ€§èƒ½ï¼\næ”¯æŒå„ç§å¼€å‘è¯­è¨€ï¼Œæœ‰æ•ˆè§£å†³äº†è·¨å¹³å°é—®é¢˜ï¼Œè·¨å¹³å°å¼€å‘\nå…¶å®å°±æ˜¯ pb æ ¸å¿ƒçš„ä¸€ç‚¹ï¼šé«˜æ€§èƒ½ã€é«˜å‹ç¼©ç‡ã€å…¼å®¹æ€§æ¯”è¾ƒé«˜\nè¯­æ³•ç®€å•ï¼Œå­¦ä¹ éš¾åº¦è¾ƒä½\ngithubå®˜æ–¹åœ°å€ï¼šhttps://github.com/protocolbuffers/protobuf \nprotobuf go support ï¼ˆgolangï¼‰ï¼šhttps://github.com/golang/protobuf\nprotobuf go support ï¼ˆgogoï¼‰ï¼šhttps://github.com/gogo/protobuf\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://developers.google.com/protocol-buffers/\nç›¸å½“çš„ç«çƒ­ï¼Œåœ¨c/cpp/java/go/äº‘åŸç”Ÿ/Native App ä¸­ç«çƒ­ç¨‹åº¦å¾ˆé«˜ï¼Œä½¿ç”¨èŒƒå›´ä¹Ÿå¾ˆå¹¿, å­¦ä¹ åªæœ‰å¥½å¤„æ²¡æœ‰åå¤„\n\n2ã€åŸºç¡€å­¦ä¹ 1ã€åŸºæœ¬æ ¼å¼syntax = &quot;proto3&quot;; // é»˜è®¤èµ°çš„æ˜¯ proto2,æ‰€ä»¥éœ€è¦å¼ºåˆ¶æŒ‡å®šï¼Œpb3æ¯”pb2è¯­æ³•ä¸Šç®€å•package dto; //å½“å‰æ–‡ä»¶çš„packageï¼Œæˆ‘ä»¬é¡¹ç›®ä¸å–œæ¬¢ä½¿ç”¨å‰ç¼€ç±»ä¼¼äº project-name.dtoï¼Œå› ä¸ºæ ¹æœ¬ä¸ä¼šå­˜åœ¨å¤šä¸ªé¡¹ç›®äº’ç›¸å¼•ç”¨ï¼æ ¹æ®ä½ ä»¬éœ€æ±‚å»å†³å®šimport &quot;dto/demo.proto&quot;; // import å…¶ä»–æ–‡ä»¶ï¼Œç›¸å¯¹äº--proto_path è·¯å¾„çš„ç›¸å¯¹è·¯å¾„option java_multiple_files = true;option java_package = &quot;com.grpc.api.third&quot;; //javaåŒ…çš„è·¯å¾„option go_package=&quot;api/dto&quot;;// goçš„åŒ…è·¯å¾„(åˆ‡è®°ä¸€å®šè¦å†™å…¨ï¼Œå’Œgoçš„importæœ‰å…³ç³»ï¼Œå¦‚æœå†™ dtoï¼Œé‚£ä¹ˆåˆ«äººå¼•å…¥ä½ å°±æ˜¯ dtoäº†ï¼Œæ˜¾ç„¶æ˜¯å¼•å…¥ä¸åˆ°çš„ï¼Œä¸€å®šè¦å†™å…¨)message SearchRequest &#123;// æ¯ä¸ªå­—æ®µéƒ½æœ‰å››å—ç»„æˆ: å­—æ®µè§„åˆ™ï¼Œç±»å‹ï¼Œåç§°ï¼Œç¼–å·  string query = 1;  int32 page_number = 2;  int32 result_per_page = 3;  repeated string hobby = 4;&#125;\n\n2ã€ç±»å‹\nå­—ç¬¦ä¸²ï¼šstring ï¼Œï¼ˆé»˜è®¤ä¸ºâ€â€ï¼‰\næ•´å‹ï¼šint32, int64, uint32, uint64  ï¼ˆé»˜è®¤ä¸º0ï¼‰\næµ®ç‚¹ï¼š double, float ï¼ˆé»˜è®¤ä¸º0ï¼‰\nå­—èŠ‚æµï¼š bytes ï¼ˆé»˜è®¤ä¸ºnilï¼‰\nå¸ƒå°”ç±»å‹ï¼šbool ï¼Œï¼ˆé»˜è®¤falseï¼‰\næšä¸¾ï¼šenum ï¼ˆé»˜è®¤ä¸º0ï¼Œæšä¸¾çš„ç¬¬ä¸€ä¸ªå€¼å¿…é¡»æ˜¯0ï¼‰\nmapç±»å‹: æ¯”å¦‚ map&lt;string,string&gt; ï¼ˆé»˜è®¤ä¸ºnilï¼‰\noneof ç±»å‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯å®ƒå®šä¹‰ä½ ç»“æ„ä½“ä¸­åªèƒ½èµ‹å€¼ä¸€ä¸ªå­—æ®µï¼Œå°±ç®—ä½ æœ‰å¤šä¸ªå­—æ®µï¼(é»˜è®¤ä¸ºnil)\n\n3ã€ç¼–å·â€‹    æ¶ˆæ¯å®šä¹‰ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ã€‚è¿™äº›å­—æ®µç¼–å·ç”¨äºä»¥æ¶ˆæ¯äºŒè¿›åˆ¶æ ¼å¼æ ‡è¯†å­—æ®µï¼Œåœ¨ä½¿ç”¨æ¶ˆæ¯ç±»å‹åä¸åº”æ›´æ”¹ã€‚æ³¨æ„ï¼ŒèŒƒå›´1åˆ°15ä¸­çš„å­—æ®µç¼–å·éœ€è¦ä¸€ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç ï¼ŒåŒ…æ‹¬å­—æ®µç¼–å·å’Œå­—æ®µç±»å‹ã€‚èŒƒå›´16åˆ°2047çš„å­—æ®µç¼–å·é‡‡ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œåº”è¯¥ä¸ºç»å¸¸å‡ºç°çš„æ¶ˆæ¯å…ƒç´ ä¿ç•™æ•°å­—1åˆ°15ã€‚è®°ä½ä¸ºå°†æ¥å¯èƒ½æ·»åŠ çš„é¢‘ç¹å‡ºç°çš„å…ƒç´ ç•™å‡ºä¸€äº›ç©ºé—´ã€‚\n\nå¤§å°é™åˆ¶ï¼š1-2^29-1 ,  19000 through 19999 ä¸èƒ½ä½¿ç”¨\n\n4ã€å­—æ®µè§„åˆ™\nsingularï¼Œé»˜è®¤ç±»å‹å°±æ˜¯è¿™ä¸ªï¼Œä¸éœ€è¦ç”³æ˜\nrepeatedï¼Œ ç±»ä¼¼äºæ•°ç»„ï¼Œgoé‡Œé¢é»˜è®¤å°±è½¬æ¢æˆäº†æ•°ç»„ï¼Œæ˜¯ä¸ªlistæ‰€ä»¥ä¸ä¼šè‡ªåŠ¨å»é‡\n\n5ã€æ³¨é‡Šä¸¤ç§æ ¼å¼ï¼Œå’Œjava/c++/goä¿æŒä¸€è‡´\n/** æ³¨é‡Š*/// æ³¨é‡Š\n\n6ã€åˆ é™¤/ä¿ç•™å­—æ®µmessage SearchRequest &#123;  string query = 1;  int32 page_number = 2;  int32 result_per_page = 3;  repeated string hobby = 4;  reserved  15, 9 to 11;  reserved &quot;foo&quot;, &quot;bar&quot;;&#125;\t\n\n7ã€å…¶ä»–1ã€æ”¯æŒä»»æ„çš„ç»“æ„ä½“åµŒå¥—message Outer &#123;                  // Level 0  message MiddleAA &#123;  // Level 1    message Inner &#123;   // Level 2      int64 ival = 1;      bool  booly = 2;    &#125;  &#125;  message MiddleBB &#123;  // Level 1    message Inner &#123;   // Level 2      int32 ival = 1;      bool  booly = 2;    &#125;  &#125;&#125;\n\n2ã€ä»»æ„ç±»å‹\nâ€‹    è¿™é‡Œä»£è¡¨çš„ä¸æ˜¯ä»»æ„çš„æ•°æ®ç±»å‹ï¼ŒæŒ‡çš„æ˜¯ Message ç±»å‹ï¼\n\nsyntax=&quot;proto3&quot;;package dto;option java_multiple_files = true;option java_package = &quot;com.grpc.api.third&quot;;option go_package=&quot;dto&quot;;import &quot;google/protobuf/any.proto&quot;;message City &#123;    uint64 id=1;    string name=2;    // å¼•ç”¨åŒ…åç§°.ç±»å‹åç§°    google.protobuf.Any any = 9;&#125;\n\n3ã€mapç±»å‹message City &#123;    uint64 id=1;    string name=2;    // å¼•ç”¨åŒ…åç§°.ç±»å‹åç§°    google.protobuf.Any any = 9;    map&lt;string,uint64&gt; demo=10;&#125;\n\n4ã€oneof ç±»å‹ä¸‹é¢ä¸ºä¾‹å­ï¼Œå°±æ˜¯ä½ åªèƒ½é€‰æ‹© v3 æˆ–è€… v4    ï¼\nmessage BenchMarkModel &#123;    string v1=1;    uint64 v2=2;    oneof test_oneof &#123;        string v3 = 3;        uint32 v4 = 4;    &#125;&#125;\n\n8ã€import ä½œç”¨é¦–å…ˆ import æ˜¯å¼•ç”¨ è·¯å¾„çš„ï¼Œé‚£ä¸ªè·¯å¾„æ˜¯ç›¸å¯¹äºä½ çš„ --proto_path è·¯å¾„çš„è·¯å¾„\næ¯”å¦‚æˆ‘çš„é¡¹ç›®ä¸­ï¼Œå¼•ç”¨å°±æ˜¯ï¼Œé¡¹ç›®è·¯å¾„æ˜¯ /Users/fanhaodong/project/programing/grpc-go/api\nbin/protoc \\        --proto_path /Users/fanhaodong/project/programing/grpc-go/api \\        --proto_path /Users/fanhaodong/go/src/github.com/gogo/protobuf/protobuf \\        --plugin=protoc-gen-go=bin/protoc-gen-go \\        --go_out=. \\        ./dto/*.proto\n\né‚£ä¹ˆæˆ‘çš„import å¯ä»¥æ¥è‡ªäºä¸¤ä¸ªè·¯å¾„\nimport &quot;dto/city.proto&quot;;import &quot;google/protobuf/any.proto&quot;;\n\né¦–å…ˆ dto/city.proto  ï¼Œç»å¯¹è·¯å¾„æ˜¯ /Users/fanhaodong/project/programing/grpc-go/api/dto/city.proto æˆ‘ä»¬çš„ç¼–è¯‘ç›®å½•æ˜¯ /Users/fanhaodong/project/programing/grpc-go/api ï¼Œæ‰€ä»¥å»é™¤å‰ç¼€å°±æ˜¯ dto/city.proto\nç„¶åçœ‹google/protobuf/any.proto ä¹Ÿæ˜¯åŒç†\n9ã€package ä½œç”¨ä¸»è¦æ˜¯åŒºåˆ† package åŒºåˆ† import å¯èƒ½å¼•ç”¨äº†ç›¸åŒçš„ message ï¼Œæ‰€ä»¥å°±éœ€è¦ packageæŒ‡å®šï¼Œä¸€èˆ¬packageå‘½ä»¤ä¸ºæ¯”å¦‚æˆ‘çš„ç›®å½•æ˜¯ api/dtoï¼Œæ‰€ä»¥ä¸€èˆ¬å‘½åä¸º api.dto ï¼Œä¸€èˆ¬æ¥è¯´è·¨ä¸šåŠ¡ç»„æ˜¯ä¸å…è®¸ç›¸äº’å¼•ç”¨ï¼Œåªèƒ½å¼•ç”¨ä¸€äº›commonçš„ç»“æ„\næ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼Œæˆ‘å¼•ç”¨äº†ä¸¤ä¸ª æ–‡ä»¶ dto/demo.protoï¼Œ google/protobuf/any.proto\ndemo.proto å®šä¹‰äº† Any ç±»å‹\nmessage Any &#123;  string name=1;&#125;\n\nä½†æ˜¯æˆ‘è¿™æ—¶å€™æ²¡æœ‰å‘Šè¯‰æˆ‘åˆ°åº•ç”¨çš„å“ªä¸ª Anyï¼Œæ­¤æ—¶ç¼–è¯‘æœŸæ— æ³•è§£å†³\nsyntax=&quot;proto3&quot;;package dto;option java_multiple_files = true;option java_package = &quot;com.grpc.api.dto&quot;;option go_package=&quot;dto&quot;;import &quot;google/protobuf/any.proto&quot;;import &quot;dto/demo.proto&quot;;message City &#123;    uint64 id=1;    string name=2;    // å¼•ç”¨åŒ…åç§°.ç±»å‹åç§°    Any any = 9;    map&lt;string,uint64&gt; demo=10;&#125;\n\nå¯ä»¥çœ‹åˆ°\ntype City struct &#123;\tstate         protoimpl.MessageState\tsizeCache     protoimpl.SizeCache\tunknownFields protoimpl.UnknownFields\tId   uint64 `protobuf:&quot;varint,1,opt,name=id,proto3&quot; json:&quot;id,omitempty&quot;`\tName string `protobuf:&quot;bytes,2,opt,name=name,proto3&quot; json:&quot;name,omitempty&quot;`\t// å¼•ç”¨åŒ…åç§°.ç±»å‹åç§°\tAny  *Any              `protobuf:&quot;bytes,9,opt,name=any,proto3&quot; json:&quot;any,omitempty&quot;`\tDemo map[string]uint64 `protobuf:&quot;bytes,10,rep,name=demo,proto3&quot; json:&quot;demo,omitempty&quot; protobuf_key:&quot;bytes,1,opt,name=key,proto3&quot; protobuf_val:&quot;varint,2,opt,name=value,proto3&quot;`&#125;\n\næ‰€ä»¥å­˜åœ¨è¿™ç§é—®é¢˜ï¼Œæ­¤æ—¶å°±éœ€è¦ packageè§£å†³å¼•ç”¨çš„é—®é¢˜\nmessage City &#123;    uint64 id=1;    string name=2;    // å¼•ç”¨åŒ…åç§°.ç±»å‹åç§°    google.protobuf.Any any = 9;    map&lt;string,uint64&gt; demo=10;&#125;\n\n3ã€Protobufçš„ç¼–ç ç®—æ³•åŸç†Encoding\n4ã€ç¼–è¯‘å·¥å…·\nå®˜æ–¹ç¼–è¯‘å·¥å…·ï¼Œæ¯”å¦‚æˆ‘æ˜¯mac os ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ wget https://github.com/protocolbuffers/protobuf/releases/download/v3.9.0/protoc-3.9.0-osx-x86_64.zip\ngogoprotobuf ï¼Œå¯¹äºéœ€è¦ç¼–ç ä¸ºGolangæ—¶ï¼Œå…¶ç¼–ç æ•ˆç‡è´¼é«˜è€Œä¸”è¿˜çœå†…å­˜ï¼Œ å¯¹ç«‹é¡¹ç›®æ˜¯ https://github.com/golang/protobuf\nå¦‚ä½•ç¼–è¯‘äº† ï¼Ÿ  --proto_pathæŒ‡å®šinclude ç›®å½•ï¼Œ --plugin æŒ‡å®šéœ€è¦ç”¨çš„pluginï¼Œ æœ€åä¸€ä¸ªå‚æ•°æŒ‡çš„æ˜¯å¼•ç”¨çš„pbæ–‡ä»¶\n\nä½¿ç”¨æµ‹è¯•çš„pb æ–‡ä»¶\nsyntax=&quot;proto3&quot;;package dto;option java_multiple_files = true;option java_package = &quot;com.grpc.api.dto&quot;;option go_package=&quot;api/dto&quot;;import &quot;google/protobuf/any.proto&quot;;import &quot;google/protobuf/duration.proto&quot;;import &quot;google/protobuf/timestamp.proto&quot;;import &quot;google/protobuf/empty.proto&quot;;import &quot;google/protobuf/wrappers.proto&quot;;message BenchMarkModel &#123;    string v1=1;    uint64 v2=2;    int64 v3=3;    double v4=4;    float v5=5;    bool v6=6;    enum Corpus &#123;        UNIVERSAL = 0;        WEB = 1;        IMAGES = 2;        LOCAL = 3;        NEWS = 4;        PRODUCTS = 5;        VIDEO = 6;    &#125;    Corpus v7=7;    map&lt;string,uint32&gt; v8=8;    oneof test_oneof &#123;        string v9 = 9;        uint32 v10 = 10;    &#125;    bytes v11=11;    message Msg &#123;        string content=1;    &#125;    repeated Msg v12=12;    google.protobuf.Any v13 = 13;    google.protobuf.Duration v14=14;    google.protobuf.Empty v15=15;    google.protobuf.UInt64Value v16=16;    google.protobuf.Timestamp v17=17;&#125;\n\n\n\n2ã€æµ‹è¯•ä»£ç \npackage dtoimport (\t&quot;github.com/golang/protobuf/proto&quot;\t&quot;github.com/stretchr/testify/assert&quot;\t&quot;google.golang.org/protobuf/types/known/anypb&quot;\t&quot;google.golang.org/protobuf/types/known/durationpb&quot;\t&quot;google.golang.org/protobuf/types/known/emptypb&quot;\t&quot;google.golang.org/protobuf/types/known/timestamppb&quot;\t&quot;google.golang.org/protobuf/types/known/wrapperspb&quot;\t&quot;math&quot;\t&quot;testing&quot;\t&quot;time&quot;)func newModel(b testing.TB) *BenchMarkModel &#123;\tany := &amp;anypb.Any&#123;&#125;\tif err := any.MarshalFrom(wrapperspb.UInt64(math.MaxUint64)); err != nil &#123;\t\tb.Fatal(err)\t&#125;\treturn &amp;BenchMarkModel&#123;\t\tV1: &quot;hello 12345424234234&quot;,\t\tV2: math.MaxUint64,\t\tV3: math.MaxInt64,\t\tV4: math.MaxFloat64,\t\tV5: math.MaxFloat32,\t\tV6: true,\t\tV7: BenchMarkModel_PRODUCTS,\t\tV8: map[string]uint32&#123;&quot;1&quot;: 1, &quot;2&quot;: 2, &quot;3&quot;: 3&#125;,\t\tTestOneof: &amp;BenchMarkModel_V10&#123;\t\t\tV10: math.MaxUint32,\t\t&#125;,\t\tV11: []byte(&quot;hello 1234567890&quot;),\t\tV12: []*BenchMarkModel_Msg&#123;\t\t\t&#123;Content: &quot;1&quot;&#125;, &#123;Content: &quot;2&quot;&#125;, &#123;Content: &quot;3&quot;&#125;,\t\t&#125;,\t\tV13: any,\t\tV14: durationpb.New(time.Hour * 24),\t\tV15: &amp;emptypb.Empty&#123;&#125;,\t\tV16: wrapperspb.UInt64(math.MaxUint64),\t\tV17: timestamppb.Now(),\t&#125;&#125;func TestGo_Marshal(t *testing.T) &#123;\tmodel := newModel(t)\tprotoBufBody, err := proto.Marshal(model)\tif err != nil &#123;\t\tt.Fatal(err)\t&#125;\tnewModel := &amp;BenchMarkModel&#123;&#125;\tif err := proto.UnmarshalMerge(protoBufBody, newModel); err != nil &#123;\t\tt.Fatal(err)\t&#125;\tassertModel(t, model, newModel)&#125;func assertModel(t testing.TB, model *BenchMarkModel, newModel *BenchMarkModel) &#123;\tassert.Equal(t, model.V1, newModel.V1)\tassert.Equal(t, model.V2, newModel.V2)\tassert.Equal(t, model.V3, newModel.V3)\tassert.Equal(t, model.V4, newModel.V4)\tassert.Equal(t, model.V5, newModel.V5)\tassert.Equal(t, model.V6, newModel.V6)\tassert.Equal(t, model.V7, newModel.V7)\tassert.Equal(t, model.V8, newModel.V8)\tassert.Equal(t, model.TestOneof, newModel.TestOneof)\tassert.Equal(t, model.V11, newModel.V11)\tfor index, _ := range model.V12 &#123;\t\tassert.Equal(t, model.V12[index].Content, newModel.V12[index].Content)\t&#125;  \tassert.Equal(t, model.V13.Value, newModel.V13.Value)\tassert.Equal(t, model.V13.TypeUrl, newModel.V13.TypeUrl)\tassert.Equal(t, model.V14.Nanos, newModel.V14.Nanos)\tassert.Equal(t, model.V14.Seconds, newModel.V14.Seconds)\tassert.Equal(t, model.V15, newModel.V15)\tassert.Equal(t, model.V16.Value, newModel.V16.Value)\tassert.Equal(t, model.V17.Seconds, newModel.V17.Seconds)\tassert.Equal(t, model.V17.Nanos, newModel.V17.Nanos)&#125;\n\n1ã€ä½¿ç”¨protoc-gen-goè¿™é‡Œéœ€è¦çŸ¥é“çš„æ˜¯ --go_out éœ€è¦æ‰¾åˆ° protoc-gen-go çš„ä½ç½®ï¼Œå¦‚æœä½ çš„protoc-gen-goæ”¾åœ¨ PATHç›®å½•ä¸‹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šæ”¾åœ¨PATHç›®å½•ä¸‹ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®š --plugin=protoc-gen-go=bin/protoc-gen-goï¼Œæ„æ€å°±æ˜¯å‘Šè¯‰ä½ç½®æ‰€åœ¨\nbin/protoc \\        --proto_path . \\        --proto_path /Users/fanhaodong/go/grpc/include \\        --plugin=protoc-gen-go=bin/protoc-gen-go \\        --go_out=../ \\        ./dto/*.proto\n\nå¸®åŠ©\n--plugin=EXECUTABLE         Specifies a plugin executable to use.                            Normally, protoc searches the PATH for                            plugins, but you may specify additional                            executables not in the path using this flag.                            Additionally, EXECUTABLE may be of the form                            NAME=PATH, in which case the given plugin name                            is mapped to the given executable even if                            the executable&#x27;s own name differs.\n\nå…¶å®è§„åˆ™å°±æ˜¯\n--plugin=protoc-gen-go=bin/protoc-gen-go  å¯¹åº”çš„å¿…é¡»æ˜¯ --go_outï¼Œå®ƒèµ°çš„æ˜¯æ‹¼å‰ç¼€ï¼Œæ¯”å¦‚ä½ æ‰§è¡Œè¿™ä¸ªä¹ŸOKï¼Œå› ä¸ºæ˜¯çœ‹å‰ç¼€è¯´è¯\nbin/protoc \\        --proto_path . \\        --proto_path /Users/fanhaodong/go/grpc/include \\        --plugin=protoc-gen-go1=bin/protoc-gen-go \\        --go1_out=../ \\        ./dto/*.proto\n\nå¼€å§‹è¿›å…¥è¯é¢˜è¿›è¡Œbenchmark\nfunc BenchmarkGo_Marshal(b *testing.B) &#123;\tmodel := newModel(b)\tfor i := 0; i &lt; b.N; i++ &#123;\t\tif _, err := proto.Marshal(model); err != nil &#123;\t\t\tb.Fatal(err)\t\t&#125;\t&#125;&#125;func BenchmarkGo_UnMarshal(b *testing.B) &#123;\tmodel := newModel(b)\tresult, err := proto.Marshal(model)\tif err != nil &#123;\t\tb.Fatal(err)\t&#125;\tnewModel := &amp;BenchMarkModel&#123;&#125;\tfor i := 0; i &lt; b.N; i++ &#123;\t\tif err := proto.UnmarshalMerge(result, newModel); err != nil &#123;\t\t\tb.Fatal(err)\t\t&#125;\t&#125;&#125;\n\næµ‹è¯•ç»“æœ\nâœ  dto git:(master) âœ— go test -run=none -bench=BenchmarkGo_ -benchmem -count=4 . goos: darwingoarch: amd64pkg: api/dtoBenchmarkGo_Marshal-12            428138              2624 ns/op             600 B/op         17 allocs/opBenchmarkGo_Marshal-12            431756              2552 ns/op             600 B/op         17 allocs/opBenchmarkGo_Marshal-12            418332              2595 ns/op             600 B/op         17 allocs/opBenchmarkGo_Marshal-12            503637              2520 ns/op             600 B/op         17 allocs/opBenchmarkGo_UnMarshal-12          537661              2824 ns/op             555 B/op         19 allocs/opBenchmarkGo_UnMarshal-12          542142              2398 ns/op             554 B/op         19 allocs/opBenchmarkGo_UnMarshal-12          509076              2420 ns/op             563 B/op         19 allocs/opBenchmarkGo_UnMarshal-12          544599              2063 ns/op             553 B/op         19 allocs/opPASSok      api/dto 11.746s\n\n2ã€ä½¿ç”¨ protoc-gen-gofast1ã€é¦–å…ˆéœ€è¦å®‰è£…\ngo install github.com/gogo/protobuf/protoc-gen-gofast ## protoc-gen-gofast å·¥å…·go get github.com/gogo/protobuf ## ä»£ç ä¾èµ–\n\n2ã€è¿™é‡Œä½¿ç”¨äº†Anyç±»å‹ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åšgofastçš„å…¼å®¹ï¼Œè¿™ç‚¹æ¯”è¾ƒå‘ï¼Œå®˜ç½‘ä¹Ÿå†™äº†å¦‚ä½•è§£å†³ï¼šhttps://github.com/gogo/protobuf ï¼Œ å› æ­¤ç¼–è¯‘å‘½ä»¤éœ€è¦æ·»åŠ ä¸€äº›å‚æ•°ï¼\nbin/protoc \\        --proto_path . \\        --proto_path /Users/fanhaodong/go/src/github.com/gogo/protobuf/protobuf \\        --plugin=protoc-gen-gofast=bin/protoc-gen-gofast \\        --gofast_out=\\        Mgoogle/protobuf/any.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/duration.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/field_mask.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/struct.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/type.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/api.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/descriptor.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/empty.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/source_context.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/timestamp.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/wrappers.proto=github.com/gogo/protobuf/types:../ \\        ./dto/*.proto\n\n3ã€æœ€å‘çš„æ¥äº†ï¼Œä¹Ÿå°±æ˜¯å®ƒä¸ºå•¥ä¸å…¼å®¹çš„é—®é¢˜ï¼\n1ï¼‰åŸæ¥å®šä¹‰çš„anyç°åœ¨ä¸èƒ½ä½¿ç”¨äº†ï¼Œä¹Ÿå°±æ˜¯è¯´apiçš„ä½¿ç”¨æ–¹å¼ä¸Šå˜äº†!\nimport (\t&quot;encoding/json&quot;\t&quot;github.com/gogo/protobuf/types&quot;\t&quot;github.com/golang/protobuf/proto&quot;\t&quot;github.com/stretchr/testify/assert&quot;\t&quot;math&quot;\t&quot;testing&quot;\t&quot;time&quot;)func newModel(b testing.TB) *BenchMarkModel &#123;\tany, err := types.MarshalAny(&amp;types.UInt64Value&#123;\t\tValue: math.MaxUint64,\t&#125;)\tif err != nil &#123;\t\tb.Fatal(err)\t&#125;\treturn &amp;BenchMarkModel&#123;\t\tV1: &quot;hello 12345424234234&quot;,\t\tV2: math.MaxUint64,\t\tV3: math.MaxInt64,\t\tV4: math.MaxFloat64,\t\tV5: math.MaxFloat32,\t\tV6: true,\t\tV7: BenchMarkModel_PRODUCTS,\t\tV8: map[string]uint32&#123;&quot;1&quot;: 1, &quot;2&quot;: 2, &quot;3&quot;: 3&#125;,\t\tTestOneof: &amp;BenchMarkModel_V10&#123;\t\t\tV10: math.MaxUint32,\t\t&#125;,\t\tV11: []byte(&quot;hello 1234567890&quot;),\t\tV12: []*BenchMarkModel_Msg&#123;&#123;Content: &quot;1&quot;&#125;, &#123;Content: &quot;2&quot;&#125;, &#123;Content: &quot;3&quot;&#125;,&#125;,\t\tV13: any,\t\tV14: types.DurationProto(time.Hour * 24),\t\tV15: &amp;types.Empty&#123;&#125;,\t\tV16: &amp;types.UInt64Value&#123;\t\t\tValue: math.MaxUint64,\t\t&#125;,\t\tV17: types.TimestampNow(),\t&#125;&#125;\n\n3ã€benchmark \nâœ  dto git:(master) âœ— go test -run=none -bench=BenchmarkGoFast_ -benchmem -count=4 .goos: darwingoarch: amd64pkg: api/dtoBenchmarkGoFast_Marshal-12               1579309               748 ns/op             240 B/op          2 allocs/opBenchmarkGoFast_Marshal-12               1487350               840 ns/op             240 B/op          2 allocs/opBenchmarkGoFast_Marshal-12               1389932               765 ns/op             240 B/op          2 allocs/opBenchmarkGoFast_Marshal-12               1532866               784 ns/op             240 B/op          2 allocs/opBenchmarkGoFast_UnMarshal-12             1000000              1173 ns/op             382 B/op          7 allocs/opBenchmarkGoFast_UnMarshal-12             1235286              1001 ns/op             384 B/op          7 allocs/opBenchmarkGoFast_UnMarshal-12             1083085              1191 ns/op             371 B/op          7 allocs/opBenchmarkGoFast_UnMarshal-12             1000000              1144 ns/op             382 B/op          7 allocs/opPASSok      api/dto 14.907s\n\n3ã€æ€»ç»“1ã€ä»æ€§èƒ½ä¸Šæ¥çœ‹ç¡®å®æå‡è‡³å°‘æ˜¯ä¸€å€èµ·æ­¥ï¼ŒåŸºæœ¬å¸¦æ¥äº†ç¿»å€çš„æ”¶ç›Š(å®˜æ–¹ç»™çš„æ•°æ®æ˜¯5-10å€çš„æ€§èƒ½æå‡ï¼Œå®ƒè¿˜æä¾›äº†æ›´å¿«çš„ï¼1ï¼‰ï¼Œç„¶åä¸»è¦æ˜¯å†…å­˜åˆ†é…ä¸Šå¯ä»¥çœ‹åˆ°å†…å­˜ä¼˜åŠ¿å¾ˆå¤§ï¼\n2ã€ä½†ä»æ•ˆç‡ä¸Šæ¥è¯´å…¶å®å¯¹äºä¸šåŠ¡å¼€å‘å…¶å®æ˜¯ä¸å…³æ³¨å¤ªå¤šè¿™äº›çš„ï¼Œå¼€å‘æ•ˆç‡å’Œè´¨é‡å†³å®šä¸€åˆ‡ï¼\n3ã€å…³äºé€‰æ‹©protoc-gen-gofast è¿˜æ˜¯é€‰æ‹© protoc-gen-go ï¼Œçœ‹ä½ ä»¬ä¸šåŠ¡å·²å¼€å§‹ç”¨çš„ä»€ä¹ˆï¼Œå¦‚æœå¼€å§‹å°±é€‰æ‹© protoc-gen-gofast é‚£ä¹ˆå¯ä»¥ä¸€ç›´ç”¨ï¼Œä½†æ˜¯ä¸€å¼€å§‹å°±é€‰æ‹© protoc-gen-go é‚£å°±æ¶å¿ƒäº†ï¼ŒåŸºæœ¬ä¸Šæ— æ³•åˆ‡æ¢åˆ° protoc-gen-gofastï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ protoc-gen-gogo\n4ã€gRPC1ã€ä»‹ç»å’Œæ–‡æ¡£\nâ€‹        gRPC æ˜¯ä¸€ä¸ªç°ä»£çš„å¼€æºé«˜æ€§èƒ½è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(Remote Procedure Callï¼ŒRPC)æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œã€‚å®ƒå¯ä»¥é«˜æ•ˆåœ°è¿æ¥æ•°æ®ä¸­å¿ƒå†…éƒ¨å’Œè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡ï¼Œå¹¶ä¸ºè´Ÿè½½å¹³è¡¡ã€è·Ÿè¸ªã€å¥åº·æ£€æŸ¥å’Œèº«ä»½éªŒè¯æä¾›å¯æ’æ‹”çš„æ”¯æŒã€‚å®ƒä¹Ÿé€‚ç”¨äºæœ€åä¸€è‹±é‡Œçš„åˆ†å¸ƒå¼è®¡ç®—è¿æ¥è®¾å¤‡ï¼Œç§»åŠ¨åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨çš„åç«¯æœåŠ¡ã€‚\n\n\ncç³»åˆ—(å®˜æ–¹ç³»): https://github.com/grpc/grpc\njava ç³»ï¼šhttps://github.com/grpc/grpc-java\ngo ç³»ï¼šhttps://github.com/grpc/grpc-go\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://grpc.io/\nå¦‚ä½•ä½¿ç”¨ wireshark æŠ“å– grpc &amp;&amp; http2 åŒ…ï¼šhttps://grpc.io/blog/wireshark/\ngrcp å’Œ http2çš„å…³ç³»: https://grpc.io/blog/grpc-on-http2/\n\n2ã€å†™rpcæ¥å£ (IDL)ç¬¬ä¸€ä¸ªlbsæ¥å£æ˜¯ï¼š\nsyntax=&quot;proto3&quot;;package third;option java_multiple_files = true;option java_package = &quot;com.grpc.api.third&quot;;option go_package=&quot;api/third&quot;;import &quot;google/protobuf/wrappers.proto&quot;;import &quot;dto/city.proto&quot;;service LbsService &#123;    rpc getCityInfo (google.protobuf.UInt64Value) returns (dto.City);&#125;\n\nç¬¬äºŒä¸ªæ˜¯useræœåŠ¡æ¥å£ï¼š\nsyntax=&quot;proto3&quot;;package third;option java_multiple_files = true;option java_package = &quot;com.grpc.api.third&quot;;option go_package=&quot;api/third&quot;;import &quot;dto/user.proto&quot;;import &quot;google/protobuf/wrappers.proto&quot;;service UserService &#123;    rpc GetUserInfo (google.protobuf.UInt64Value) returns (dto.User);&#125;\n\n3ã€gofastç¼–è¯‘rcpæ¥å£å¦‚ä½•ç¼–è¯‘ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ gofastè¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€äº›å‚æ•°ï¼Œå…³äºå‚æ•°å¦‚ä½•ä½¿ç”¨çš„ï¼Œè¿™äº›ç»å¯¹ç™¾åº¦ä¸æ¥ï¼Œä¸»è¦æ˜¯çœ‹äººå®¶è¿™ä¸ªgofasté¡¹ç›®çš„æ–‡æ¡£å’Œexample\nè¿™é‡Œå°±æ˜¯éœ€è¦å‘Šè¯‰ä¸€ä¸‹ç¼–è¯‘çš„æ—¶å€™ä½¿ç”¨ plugin=grpc, ç„¶åè¿˜éœ€è¦æ”¹å˜ä¸€ä¸‹å¼•ç”¨ï¼Œæœ€åå°±æ˜¯æŒ‡å®šä¸€ä¸‹è¾“å‡ºç›®å½•\næ ¼å¼å°±æ˜¯ --&#123;pugin&#125;_out=k1=v1,k2=v2,k3=v3....,kn=vn:&#123;è¾“å‡ºç›®å½•&#125;\nbin/protoc \\        --proto_path . \\        --proto_path /Users/fanhaodong/go/src/github.com/gogo/protobuf/protobuf \\        --plugin=protoc-gen-gofast=bin/protoc-gen-gofast \\        --gofast_out=plugins=grpc,\\        Mgoogle/protobuf/any.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/duration.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/field_mask.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/struct.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/type.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/api.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/descriptor.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/empty.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/source_context.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/timestamp.proto=github.com/gogo/protobuf/types,\\        Mgoogle/protobuf/wrappers.proto=github.com/gogo/protobuf/types:../ \\        ./third/*.proto\n\n4ã€goå†™æ¥å£æœåŠ¡è°ƒç”¨1ã€æœåŠ¡ç«¯ä»£ç \npackage mainimport (\t&quot;api/dto&quot;\t&quot;api/third&quot;\t&quot;context&quot;\t&quot;fmt&quot;\t&quot;github.com/gogo/protobuf/types&quot;\t&quot;google.golang.org/grpc&quot;\t&quot;log&quot;\t&quot;net&quot;\t&quot;service/common&quot;\t&quot;time&quot;)type lbsServiceServer struct&#123;&#125;func (lbsServiceServer) GetCityInfo(ctx context.Context, cityId *types.UInt64Value) (*dto.City, error) &#123;\tif cityId.Value == 0 &#123;\t\treturn nil, fmt.Errorf(&quot;not found city: %d&quot;, cityId.Value)\t&#125;\treturn &amp;dto.City&#123;\t\tId:         cityId.Value,\t\tName:       fmt.Sprintf(&quot;beijing-%d&quot;, cityId.Value),\t\tProperties: map[string]string&#123;&quot;time&quot;: time.Now().Format(time.RFC3339)&#125;,\t\tMsg: &amp;dto.OneofMessage&#123;\t\t\tTestOneof: &amp;dto.OneofMessage_Name&#123;\t\t\t\tName: &quot;demo&quot;,\t\t\t&#125;,\t\t&#125;,\t&#125;, nil&#125;func main() &#123;\t// åˆ›å»ºä¸€ä¸ªtcp listener\tlis, err := net.Listen(&quot;tcp&quot;, common.LbsService)\tif err != nil &#123;\t\tlog.Fatalf(&quot;failed to listen: %v&quot;, err)\t&#125;\t// åˆ›å»ºä¸€ä¸ª grpc server\tser := grpc.NewServer()\t// æ³¨å†Œä¿¡æ¯\tthird.RegisterLbsServiceServer(ser, lbsServiceServer&#123;&#125;)\t// å¯åŠ¨æœåŠ¡\tif err := ser.Serve(lis); err != nil &#123;\t\tlog.Fatalf(&quot;failed to serve: %v&quot;, err)\t&#125;&#125;\n\n2ã€å®¢æˆ·ç«¯ä»£ç \npackage mainimport (\t&quot;api/third&quot;\t&quot;context&quot;\t&quot;github.com/gogo/protobuf/types&quot;\t&quot;google.golang.org/grpc&quot;\t&quot;log&quot;\t&quot;service/common&quot;)func main() &#123;\tconn, err := grpc.Dial(common.LbsService, grpc.WithInsecure(), grpc.WithBlock())\tif err != nil &#123;\t\tlog.Fatal(err)\t&#125;\tclient := third.NewLbsServiceClient(conn)\tcityInfo, err := client.GetCityInfo(context.Background(), &amp;types.UInt64Value&#123;Value: 1&#125;)\tif err != nil &#123;\t\tlog.Fatal(err)\t&#125;\tlog.Printf(&quot;%s&quot;, cityInfo)&#125;\n\nè¯·æ±‚ä¸€ä¸‹å¯ä»¥çœ‹åˆ°å®Œå…¨å¯ä»¥è°ƒé€š\n2021/04/16 20:10:48 id:1 name:&quot;beijing-1&quot; properties:&lt;key:&quot;time&quot; value:&quot;2021-04-16T20:10:48+08:00&quot; &gt; msg:&lt;name:&quot;demo&quot; &gt; \n\n5ã€å¦‚ä½•æŠ“åŒ…1ã€é…ç½®pbä½ç½®ï¼Œæ¯”å¦‚æˆ‘çš„å°±æ˜¯åœ¨ /Users/fanhaodong/project/programing/grpc-go/apiç›®å½•ä¸‹\n\n2ã€é€‰æ‹©æŠ“å–ç½‘å¡\næœ¬åœ°çš„è¯ä¸€èˆ¬æ˜¯å°±æ˜¯æœ¬åœ°å›ç¯ç½‘ç»œï¼Œæˆ‘çš„æœ¬åœ°ç½‘å¡å°±æ˜¯ lo0\n\nç„¶åé€‰æ‹©è¿‡æ»¤çš„ç«¯å£ï¼Œæ¯”å¦‚æˆ‘åˆšåˆšå¯åŠ¨çš„æœåŠ¡ç«¯å£æ˜¯ 8001ï¼Œ ç„¶åè®°å¾—å®¢æˆ·ç«¯è°ƒç”¨ä¸€æ¬¡æœåŠ¡ç«¯,å°±å¯ä»¥çœ‹åˆ°ä»¥ä¸‹çš„æµé‡åŒ…äº†\n\næ­¤æ—¶å¯ä»¥ç›‘æ§åˆ°æµé‡ï¼Œä½†æ˜¯æ˜¯tcpï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾çœ‹æ‡‚ï¼Œéœ€è¦éœ€è¦åˆ†æä¸€ä¸‹ï¼Œå› æ­¤éœ€è¦decodeä¸€ä¸‹åŒ…\n\næ‰€ä»¥å¤§æ¦‚ä½ å°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰åŒ…çš„æƒ…å†µäº†ï¼\n6ã€http27ã€grpc conn pool1ã€å¦‚æœå‘ç° []  conn\n2ã€å¦‚æœå‘ç° conn (http2  http3 ) \n3ã€\n5ã€ä½¿ç”¨go-micro æ­å»ºgrpcæœåŠ¡1ã€å®˜æ–¹æ–‡æ¡£https://github.com/Anthony-Dong/go-micro\n\nå¾®è§£å†³äº†åœ¨äº‘ä¸­æ„å»ºæœåŠ¡çš„å…³é”®éœ€æ±‚ã€‚å®ƒåˆ©ç”¨å¾®æœåŠ¡ä½“ç³»ç»“æ„æ¨¡å¼ï¼Œå¹¶æä¾›ä¸€ç»„ä½œä¸ºå¹³å°æ„å»ºå—çš„æœåŠ¡ã€‚å¾®å¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œå¹¶æä¾›æ›´ç®€å•çš„å¯ç¼–ç¨‹æŠ½è±¡ã€‚\n\nå…¶å®çœ‹èµ·æ¥å’Œé‚£ä¸ªç°åœ¨æ¯”è¾ƒç«çš„ dapr å¾ˆåƒï¼ŒæŠ½è±¡çš„çº§åˆ«å¾ˆé«˜ï¼Œæ›´åŠ å‚»ç“œå¼ï¼Œä½†æ˜¯ä½ è¦æ˜¯ç ”ç©¶çš„è¯å¾€å¾€ä¼šå¢å¤§å­¦ä¹ æˆæœ¬\n2ã€å¿«é€Ÿå¼€å§‹çš„è¯ï¼Œä½ å°±æ ¹æ®å®˜æ–¹æä¾›çš„å°±è¡Œäº†\n2ã€æä¾›çš„èƒ½åŠ›1ã€åŸºæœ¬ä¸Šäººå®¶å¸®ä»£ç ç»™ä½ å°è£…å¥½äº†ï¼Œç›´æ¥ç”¨\n2ã€æä¾›api-gateway æ–¹ä¾¿ä½¿ç”¨\n3ã€æä¾›æœ‰ ä¸€äº›å†…éƒ¨æä¾›çš„æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œéœ€è¦ç»†ç»†å­¦ä¹ \n4ã€æœ‰å…´è¶£å¯ä»¥å­¦ä¹ ä¸€ä¸‹\n","categories":["RPC"],"tags":["GRPC","Protobuf"]},{"title":"å¤šè¿›ç¨‹ - daemonè¿›ç¨‹å’Œä¼˜é›…é‡å¯","url":"/2023/08/14/62cb47bb883c0e290c18a7ebd8ff9b3a/","content":"æœ¬æ–‡ä¼šè¯¦ç»†ä»‹ç»ä¸»æµçš„daemonè¿›ç¨‹çš„å®ç°æ–¹æ¡ˆï¼Œä»¥åŠç½‘ç»œç¼–ç¨‹ä¸­å¦‚ä½•å®ç°ä¼˜é›…é‡å¯ï¼Œè¿™äº›éƒ½æ˜¯å¤šè¿›ç¨‹çš„ä¸€äº›ç¼–ç¨‹æŠ€å·§ï¼\n\n\nå¦‚ä½•åˆ›å»ºdaemonè¿›ç¨‹\nä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦daemonè¿›ç¨‹?\n\næˆ‘ä»¬å¹³æ—¶åšæœåŠ¡å™¨å¼€å‘éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªç¨‹åºï¼Œè¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªå‰å°ç¨‹åºï¼Œä½†æ˜¯å‰å°ç¨‹åºå®ƒä¸€ç›´åœ¨é‚£å¼€ç€ï¼Œæˆ‘æƒ³è®©ä»–åå°è¿è¡Œï¼Œä¾‹å¦‚mysqlçš„serverï¼Œé‚£ä¹ˆæ€ä¹ˆè§£å†³å‘¢ï¼Œæˆ‘è‡ªå·±æ€ä¹ˆå®ç°ä¸€ä¸ªdaemonè¿›ç¨‹å‘¢ï¼Ÿ\n\nå¸¸è§çš„æ‰‹æ®µ\n\n\nsystemctl æ˜¯linuxæœ€å¸¸è§çš„æ‰‹æ®µï¼Œå®ƒéœ€è¦è½¯ä»¶å®šä¹‰ä¸€ä¸ª .service æ–‡ä»¶ï¼Œæ¥å®šä¹‰å’Œç®¡ç† è½¯ä»¶çš„ç­‰ https://www.freedesktop.org/software/systemd/man/systemd.unit.html\nå¯ä»¥ç”¨ systemctl status æŸ¥çœ‹æ‰€æœ‰ systemctl çš„è¿›ç¨‹ï¼Œä½†æ˜¯è²Œä¼¼éœ€è¦rootæƒé™ç”¨èµ·æ¥ä¸å¤ªæ–¹ä¾¿â€¦.\n\n\n~ cat /lib/systemd/system/docker.service[Unit]Description=Docker Application Container EngineDocumentation=https://docs.docker.comAfter=network-online.target docker.socket firewalld.serviceWants=network-online.targetRequires=docker.socket[Service]Type=notify# the default is not to use systemd for cgroups because the delegate issues still# exists and systemd currently does not support the cgroup feature set required# for containers run by dockerExecStart=/usr/bin/dockerd -H fd://ExecReload=/bin/kill -s HUP $MAINPIDLimitNOFILE=1048576# Having non-zero Limit*s causes performance problems due to accounting overhead# in the kernel. We recommend using cgroups to do container-local accounting.LimitNPROC=infinityLimitCORE=infinity# Uncomment TasksMax if your systemd version supports it.# Only systemd 226 and above support this version.TasksMax=infinityTimeoutStartSec=0# set delegate yes so that systemd does not reset the cgroups of docker containersDelegate=yes# kill only the docker process, not all processes in the cgroupKillMode=process# restart the docker process if it exits prematurelyRestart=on-failureStartLimitBurst=3StartLimitInterval=60s[Install]WantedBy=multi-user.target\n\nå…¶å®å¤§æ¦‚æè¿°äº†ï¼Œå½“å‰è½¯ä»¶è¯¦æƒ…ä¿¡æ¯ï¼Œå¦‚ä½•å¯åŠ¨å½“å‰è½¯ä»¶ç­‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç«  https://segmentfault.com/a/1190000023029058\n\nnohup  å°±æ›´ç®€å•äº†ï¼Œåªéœ€è¦ nohup  å‘½ä»¤ä¸€ä¸‹å³å¯ï¼Œå…¶å®å®ƒæ‰€åšçš„å°±æ›´ç®€å•äº†ï¼Œå°±æ˜¯ä¸€ä¸ªåå°è¿è¡Œï¼Œå¹¶ä¸ä¼šæ¶‰åŠåˆ°é‡å¯ç­‰æ“ä½œ\n\nsupervisor æˆ‘ä¸ªäººæ„Ÿè§‰å°±å’Œ systemctlå·®ä¸å¤š\n\n\nå¦‚ä½•å®ç°ä¸€ä¸ªdaemonè¿›ç¨‹é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸ªè¿›ç¨‹çš„æœºåˆ¶ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨shellé‡Œæ‰§è¡Œäº†ä¸€ä¸ªå‘½ä»¤(énohup)ï¼Œé‚£ä¹ˆæ•´ä½“æµç¨‹æ˜¯ï¼Œshellè¿›ç¨‹å¯åŠ¨äº†æˆ‘ä»¬çš„è¿›ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å½“å‰è¿›ç¨‹çš„çˆ¶äº²è¿›ç¨‹å°±æ˜¯ shell è¿›ç¨‹ï¼Œå½“æˆ‘ä»¬æŠŠshellè¿›ç¨‹å…³äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è¿›ç¨‹ä¹Ÿæ²¡äº†ï¼\nä¸‹å›¾æ˜¯æˆ‘å†™äº†ä¸€ä¸ª Goä»£ç ï¼Œå…¶å®å°±æ˜¯è§£é‡Šäº†ä¸Šé¢è¯´çš„ï¼æ•´ä¸ªè¿›ç¨‹çš„å…³ç³»ï¼\n\næ ¹æ®ä¸Šé¢æè¿°åŸºæœ¬æ— è§£äº†ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Œå®é™…ä¸Šè¿™é‡Œå°±éœ€è¦ç”¨åˆ°å­¤å„¿è¿›ç¨‹ï¼Œå­¤å„¿è¿›ç¨‹çš„çˆ¶è¿›ç¨‹IDæ˜¯1ï¼Œä»–çš„å›æ”¶æƒå°±è½¬ç§»ç»™äº†initè¿›ç¨‹(è¿›ç¨‹IDä¸º1)ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ›å»ºä¸€ä¸ªå­¤å„¿è¿›ç¨‹äº†ï¼\nå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å½“çˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæ­¤æ—¶å­è¿›ç¨‹å°±æ˜¯å­¤å„¿è¿›ç¨‹äº†ï¼Œå­¤å„¿è¿›ç¨‹çš„çˆ¶äº²è¿›ç¨‹ä¸ºinitè¿›ç¨‹(è¿›ç¨‹ID=1)ï¼\nåƒµå°¸è¿›ç¨‹ï¼ˆzomibeï¼‰è¿›ç¨‹äº§ç”Ÿçš„åŸå› æ˜¯å› ä¸ºå­è¿›ç¨‹é€€å‡ºåï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰é€€å‡ºä½†æ˜¯ä¹Ÿæ²¡æœ‰åŠæ—¶æ¸…ç†å­è¿›ç¨‹çš„èµ„æºï¼Œå½“çˆ¶è¿›ç¨‹é€€å‡ºäº†åƒµå°¸è¿›ç¨‹ä¼šè‡ªåŠ¨å›æ”¶ï¼Œåƒµå°¸è¿›ç¨‹é€ æˆçš„é—®é¢˜å°±æ˜¯å ç”¨ç³»ç»Ÿèµ„æº(pidèµ„æº)ï¼\n#include &lt;iostream&gt;#include &lt;unistd.h&gt;#include &lt;cerrno&gt;#include &lt;cstring&gt;// g++ -std=c++14 main.cpp -o mainint main() &#123;    std::cout &lt;&lt; &quot;main start: &quot; &lt;&lt; getpid() &lt;&lt; &quot;\\n&quot;;    auto child_pid = fork();    if (child_pid &lt; 0) &#123;        std::cout &lt;&lt; &quot;fork find err: &quot; &lt;&lt; strerror(errno) &lt;&lt; &quot;\\n&quot;;    &#125;    if (child_pid == 0) &#123;        // å­è¿›ç¨‹        std::cout &lt;&lt; &quot;child pid &quot; &lt;&lt; getpid() &lt;&lt; &quot; start&quot; &lt;&lt; &quot;\\n&quot;;        sleep(1);        std::cout &lt;&lt; &quot;child pid &quot; &lt;&lt; getpid() &lt;&lt; &quot; end&quot; &lt;&lt; &quot;\\n&quot;;        return 0;    &#125;    std::cout &lt;&lt; &quot;main start wait child process success: &quot; &lt;&lt; child_pid &lt;&lt; &quot;\\n&quot;;    sleep(20); // è¿™é‡Œå­è¿›ç¨‹1sé€€å‡ºåå­è¿›ç¨‹èº«ä»½å°±æ ‡è®°ä¸ºåƒµå°¸è¿›ç¨‹äº†.//    if (waitpid(child_pid, nullptr, 0) != child_pid) &#123; // æ­£ç¡®åšæ³•æ˜¯åˆ†é…æœ‰é™çš„èµ„æºæˆ–è€…åŠæ—¶å›æ”¶//        std::cout &lt;&lt; &quot;main wait child process find err: &quot; &lt;&lt; strerror(errno) &lt;&lt; &quot;\\n&quot;;//        return 1;//    &#125;    std::cout &lt;&lt; &quot;main wait child process success: &quot; &lt;&lt; child_pid &lt;&lt; &quot;\\n&quot;; // å½“çˆ¶è¿›ç¨‹é€€å‡ºåƒµå°¸è¿›ç¨‹å°±ä¼šè¢«æ¸…ç†äº†.ï¼ˆå¦‚æœç³»ç»Ÿåˆ›å»ºå¤§é‡çš„å­è¿›ç¨‹ä¸”å­è¿›ç¨‹é€€å‡ºåæ²¡åŠæ—¶å›æ”¶å°±ä¼šé€ æˆç³»ç»Ÿè¿›ç¨‹æ— æ³•åˆ†é…ï¼‰&#125;\n\nå…·ä½“æ–‡ç« å¯ä»¥çœ‹: \n\nhttps://blog.csdn.net/a745233700/article/details/120715371\nhttps://segmentfault.com/a/1190000038820321\n\nç®€å•å®ç°ä¸€ä¸ªdaemonè¿›ç¨‹è¿™ä¸ªä¾‹å­æ˜¯å®ç°ä¸€ä¸ª http æœåŠ¡çš„daemonè¿›ç¨‹ï¼Œç›´æ¥è¿è¡Œåä¼šåå°å¯åŠ¨ä¸€ä¸ªhttpæœåŠ¡ï¼\npackage mainimport (\t&quot;fmt&quot;\t&quot;net/http&quot;\t&quot;os&quot;\t&quot;path/filepath&quot;)func main() &#123;\tfmt.Printf(&quot;å½“å‰ppid: %v, pid: %v, args: %#v\\n&quot;, os.Getppid(), os.Getpid(), os.Args)\tif len(os.Args) &gt; 1 &amp;&amp; os.Args[1] == &quot;child_process&quot; &#123; // å­è¿›ç¨‹\t\tfmt.Println(&quot;child process&quot;)\t\tif err := http.ListenAndServe(&quot;:10099&quot;, http.HandlerFunc(func(writer http.ResponseWriter, request *http.Request) &#123;\t\t\tfmt.Printf(&quot;method: %s, url: %s\\n&quot;, request.Method, request.URL)\t\t\t_, _ = writer.Write([]byte(`hello world`))\t\t&#125;)); err != nil &#123;\t\t\tpanic(err)\t\t&#125;\t\treturn\t&#125;\texecutable, err := os.Executable()\tif err != nil &#123;\t\tpanic(err)\t&#125;\tdir, err := os.Getwd()\tif err != nil &#123;\t\tpanic(err)\t&#125;\tfmt.Printf(&quot;dir: %s\\n&quot;, dir)\tstdout, err := os.OpenFile(filepath.Join(dir, &quot;child_process.log&quot;), os.O_CREATE|os.O_WRONLY, 0644)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tprocess, err := os.StartProcess(executable, []string&#123;os.Args[0], &quot;child_process&quot;&#125;, &amp;os.ProcAttr&#123;\t\tDir: dir,\t\tFiles: []*os.File&#123; // å…±äº«fd\t\t\tos.Stdin,  // stdin\t\t\tstdout, // stdout\t\t\tstdout, // std error\t\t&#125;,\t&#125;)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tpidFile, err := os.OpenFile(filepath.Join(dir, &quot;child_process.pid&quot;), os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0644)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tdefer pidFile.Close()\tif _, err := pidFile.WriteString(fmt.Sprintf(&quot;%d&quot;, process.Pid)); err != nil &#123;\t\tpanic(err)\t&#125;\tfmt.Printf(&quot;create child process %d\\n&quot;, process.Pid)\treturn\t// ä¸æ‰§è¡Œè¿™ä¸ªï¼Œç›´æ¥returnå°±æ˜¯å­¤å„¿è¿›ç¨‹äº†\tif _, err := process.Wait(); err != nil &#123;\t\tpanic(err)\t&#125;&#125;\n\n\næˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ª å­¤å„¿è¿›ç¨‹ï¼Œ å¦‚ä½•ç»“æŸå­¤å„¿è¿›ç¨‹äº†ï¼Œ ç›´æ¥ kill å­¤å„¿è¿›ç¨‹çš„è¿›ç¨‹IDå³å¯\nâœ  test git:(master) âœ— ps -ef | grep &#x27;./main&#x27;    502 48190     1   0  2:42PM ttys052    0:00.01 ./main child_process  502 48312 43352   0  2:42PM ttys052    0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox ./mainâœ  test git:(master) âœ— kill `cat child_process.pid`\n\næ³¨æ„ï¼šGoçš„StartProcessåº•å±‚æ˜¯fork + exec , forkå‡½æ•°æ˜¯åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œexecå‡½æ•°æ˜¯åŠ è½½ä¸€ä¸ªç¨‹åºè¦†ç›–å½“å‰ç¨‹åº(æ›¿æ¢æ•´ä¸ªç¨‹åº). ä¸æ‡‚å¾—å¯ä»¥ç™¾åº¦ä¸‹.. \nä»£ç åœ°å€: https://coliru.stacked-crooked.com/a/caed3826f0be8391\n#include &lt;iostream&gt;#include &lt;unistd.h&gt;#include &lt;sys/wait.h&gt;#include &lt;cstring&gt;#include &lt;cerrno&gt;int main() &#123;    std::cout &lt;&lt; &quot;main start process&quot; &lt;&lt; std::endl;    int count = 0;    pid_t cpid = fork();    if (cpid == 0) &#123;        // å­è¿›ç¨‹ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œ(fork å‡½æ•°ä¼šæœ‰å¾ˆå¤šä¼˜åŒ–ï¼Œæ ¸å¿ƒæ˜¯å†™æ—¶å¤åˆ¶ï¼Œæ‰€ä»¥forkå‡½æ•°å¼€é”€ä¸å¤§)      \t// copy on write https://wingsxdu.com/posts/linux/concurrency-oriented-programming/fork-and-cow/        count = count + 100;        std::cout &lt;&lt; &quot;child process start. pid: &quot; &lt;&lt; getpid() &lt;&lt; &quot; , count: &quot; &lt;&lt; count &lt;&lt; std::endl;        sleep(2); // sleep 2s        std::cout &lt;&lt; &quot;child process replace current exec process&quot; &lt;&lt; count &lt;&lt; std::endl;        // è¿™é‡Œçš„æ„æ€æ—¶å°†å­è¿›ç¨‹æ›¿æ¢æˆ ls è¿™ä¸ªç¨‹åº        if (execl(&quot;/bin/ls&quot;, &quot;ls&quot;, &quot;-a&quot;, NULL) == -1) &#123;            // æ›¿æ¢ç¨‹åºå¤±è´¥ä¼šæŠ¥é”™            std::cout &lt;&lt; &quot;child process error, err: &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;            return 1;        &#125;        // å­è¿›ç¨‹æ›¿æ¢æˆåŠŸåä¸‹é¢è¿™äº›ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œäº†(å› ä¸ºå·²ç»æ›¿æ¢äº†å®Œæ•´çš„ä»£ç æ®µ/æ•°æ®æ®µä¹‹ç±»çš„ï¼Œå®Œå…¨å’Œè¿™ä¸ªç¨‹åºæ— å…³äº†)    &#125; else if (cpid == -1) &#123;        std::cout &lt;&lt; &quot;fork err: &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;        return 1;    &#125; else &#123;        std::cout &lt;&lt; &quot;main process: &quot; &lt;&lt; getpid() &lt;&lt; &quot;, child process: &quot; &lt;&lt; cpid &lt;&lt; std::endl;        waitpid(cpid, nullptr, 0); // ç­‰å¾…å­è¿›ç¨‹ç»“æŸ        std::cout &lt;&lt; &quot;main process done, count: &quot; &lt;&lt; count &lt;&lt; std::endl;    &#125;    return 0;&#125;\n\nå°è£… daemon è¿›ç¨‹è¿™é‡Œæˆ‘å°±ä¸é€ è½®å­äº†ï¼Œå¤§æ¦‚å¯ä»¥çœ‹ä¸€ä¸‹ https://github.com/sevlyar/go-daemon  è¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘å¤§æ¦‚ä»‹ç»ä¸€äº›å‡ ä¸ªæ–¹æ³•çš„æ ¸å¿ƒåŸç†\n\nctx\n\nfunc (s *DaemonService) newCtx() *daemon.Context &#123;\treturn &amp;daemon.Context&#123;\t\tPidFileName: filepath.Join(s.homeDir, PidFile), // pidæ‰€åœ¨æ–‡ä»¶ï¼Œä¸»è¦æ˜¯è§£å†³å¦‚ä½•è·å–å­è¿›ç¨‹pidçš„é—®é¢˜\t\tPidFilePerm: 0644,\t\tLogFileName: filepath.Join(s.homeDir, LogFile), // æ›¿æ¢å­è¿›ç¨‹çš„stdout/stderr\t\tLogFilePerm: 0644,\t\tWorkDir:     s.homeDir, // å­è¿›ç¨‹å·¥ä½œç›®å½•\t\tUmask:       027, // æ–‡ä»¶æƒé™,æœ‰å…´è¶£å¯ä»¥æŸ¥ä¸€ä¸‹\t\tArgs:        os.Args, // å­è¿›ç¨‹å‚æ•°\t&#125;&#125;\n\n\nDaemonStart\n\nfunc (s *DaemonService) DaemonStart() error &#123;\tctx := s.newCtx()\t// Search\t// å…¶å®å°±æ˜¯è¯»å–pidæ–‡ä»¶ï¼Œåˆ¤æ–­è¿›ç¨‹æ˜¯å¦å­˜åœ¨\tsearch, err := ctx.Search()\tif err == nil &amp;&amp; search != nil &#123;\t\treturn fmt.Errorf(`the background program has started. PID: %d`, search.Pid)\t&#125;\t// Reborn\t// å¦‚æœæ˜¯çˆ¶è¿›ç¨‹ï¼Œåˆ™è¿”å› child process\t// å¦‚æœæ˜¯å­è¿›ç¨‹ï¼Œåˆ™è¿”å› ç©º (åˆ¤æ–­çˆ¶å­è¿›ç¨‹é€»è¾‘å¾ˆç®€å•å°±æ˜¯æ ¹æ®ç¯å¢ƒå˜é‡ _GO_DAEMON=1ï¼Œå­è¿›ç¨‹ä¼šè¢«æ³¨å…¥è¿™ä¸ªç¯å¢ƒå˜é‡)\tchildProcess, err := ctx.Reborn()\tif err != nil &#123;\t\treturn fmt.Errorf(&quot;unable to run background program, reason: %v&quot;, err)\t&#125;  // å­è¿›ç¨‹ä¸ä¸ºç©ºï¼Œè¯´æ˜æ˜¯çˆ¶è¿›ç¨‹ï¼Œç›´æ¥é€€å‡ºå³å¯ï¼ˆè¿™é‡Œå­è¿›ç¨‹å°±æ˜¯å­¤å„¿è¿›ç¨‹äº†ï¼‰\tif childProcess != nil &#123;\t\tlogs.Infof(&quot;start parent process success. pid: %d, cpid: %d&quot;, os.Getpid(), childProcess.Pid)\t\treturn nil\t&#125;\tdefer func() &#123;\t\t_ = ctx.Release() // é‡Šæ”¾ä¸€äº›å½“æ—¶åˆ›å»ºæ—¶åˆ†é…çš„èµ„æº\t&#125;()\tlogs.Infof(&quot;start child process success. ppid: %d, pid: %d&quot;, os.Getppid(), os.Getpid())\treturn s.run()&#125;\n\nå®ç°ä¼˜é›…é‡å¯tcpæœåŠ¡\nç°åœ¨å·²ç»æœ‰äº† k8s / è‡ªç ”çš„å‘å¸ƒå¹³å°éƒ½æ”¯æŒæ»šåŠ¨é‡å¯äº†ï¼Œæ»šåŠ¨é‡å¯é˜¶æ®µä¼šæ–°å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œç„¶åç­‰å¾…æ—§æœåŠ¡ç»“æŸã€‚ä½†æ˜¯å§ä»–æ¯”è¾ƒæ¶ˆè€—èµ„æºï¼Œå› ä¸ºå‡å¦‚ä½ æœåŠ¡1wå°ï¼Œæ»šåŠ¨ç²’åº¦æ—¶10%ï¼Œé‚£ä¹ˆéœ€è¦å†—ä½™1000å°æœåŠ¡å™¨çš„èµ„æºï¼\nåŸåœ°é‡å¯å§ï¼Œéœ€è¦å®ç°ä¼˜é›…é‡å¯æˆ–è€…æš´åŠ›é‡å¯äº†ï¼Œæš´åŠ›é‡å¯å¯èƒ½ä¼šçŸ­æš‚å½±å“slaï¼Œæ‰€ä»¥ä¼˜é›…é‡å¯ä¹Ÿéå¸¸é‡è¦ï¼\nä¼˜é›…é‡å¯çš„å¤§æ¦‚åŸç†å°±æ˜¯ï¼šå¤šè¿›ç¨‹çš„æ–‡ä»¶å…±äº«ï¼Œè¿™é‡Œå…±äº«çš„æ˜¯tcp socketçš„æ–‡ä»¶ï¼Œå½“éœ€è¦é‡å¯æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶åé€šçŸ¥æ—§è¿›ç¨‹å…³é—­ç›‘å¬socketæ–‡ä»¶ï¼Œä¸¤ä¸ªè¿›ç¨‹å…±äº«socketæ–‡ä»¶ï¼Œæ–°è¿›ç¨‹å¯åŠ¨åä¼šé‡æ–°ç›‘å¬å…±äº«çš„socketï¼Œé‚£ä¹ˆæ–°çš„è¿æ¥ä¼šæ‰“å‘æ–°è¿›ç¨‹ï¼Œæ—§è¿›ç¨‹ä¾ç„¶å¤„ç†æ—§çš„è¿æ¥ï¼Œæœ€åå¤„ç†å®Œåæ—§è¿›ç¨‹ä¼šé€€å‡ºï¼Œæœ€ç»ˆå®ç°ä¼˜é›…é‡å¯ï¼Œå®ƒå¾ˆå¥½çš„è§£å†³äº†æ–°è¿æ¥/æ—§è¿æ¥çš„å¤„ç†ï¼\n\né€ ä¸ªè½®å­è¿™ä¸ªä¾‹å­ï¼Œæˆ‘æ˜¯ä¸»è¿›ç¨‹æ­£å¸¸åˆ›å»ºå’Œç›‘å¬TCPListener,  å½“éœ€è¦é‡å¯çš„æ—¶å€™æ­¤æ—¶éœ€è¦å…³é—­ TCPListener ç„¶ååˆ›å»ºå­è¿›ç¨‹ç»§ç»­ç›‘å¬ï¼Œå½“å†ç›‘å¬åˆ°é‡å¯æ—¶åŒæ ·çš„éœ€è¦ä¸»è¿›ç¨‹å…³é—­å­è¿›ç¨‹ï¼\npackage mainimport (\t&quot;fmt&quot;\t&quot;net&quot;\t&quot;net/http&quot;\t&quot;os&quot;\t&quot;os/exec&quot;\t&quot;os/signal&quot;\t&quot;strings&quot;\t&quot;sync&quot;\t&quot;syscall&quot;\t&quot;time&quot;)func main() &#123;\tvar name string\tvar err error\tvar listen net.Listener\t// å¦‚æœæ˜¯å­è¿›ç¨‹çš„è¯ï¼Œlisten è·å–ä¸å¤ªä¸€æ ·\tif os.Getenv(&quot;is_slave&quot;) == &quot;true&quot; &#123;\t\tfile := os.NewFile(uintptr(3), &quot;&quot;)\t\tlisten, err = net.FileListener(file)\t\tname = fmt.Sprintf(&quot;slave-%d&quot;, os.Getpid())\t&#125; else &#123;\t\tlisten, err = net.Listen(&quot;tcp&quot;, &quot;:10086&quot;)\t\tname = &quot;master&quot;\t&#125;\tif err != nil &#123;\t\tpanic(fmt.Errorf(&quot;init (%s) listen err: %v&quot;, name, err))\t&#125;\tdebug(&quot;[%s] start&quot;, name)\tgo func() &#123;\t\tif isSlave(name) &#123;\t\t\treturn\t\t&#125;\t\tvar listenFd *os.File\t\tvar loadFD = sync.Once&#123;&#125;\t\tloadListenFd := func() *os.File &#123;\t\t\tloadFD.Do(func() &#123;\t\t\t\ttl := listen.(*net.TCPListener)\t\t\t\tfds, err := tl.File()\t\t\t\tif err != nil &#123;\t\t\t\t\tpanic(fmt.Errorf(&quot;tl.File() find err: %v\\n&quot;, err))\t\t\t\t&#125;\t\t\t\tif err := listen.Close(); err != nil &#123; // åªéœ€è¦å…³é—­ä¸€æ¬¡ï¼Œæ‰€ä»¥ç”¨sync.once\t\t\t\t\tpanic(err)\t\t\t\t&#125;\t\t\t\tlistenFd = fds\t\t\t&#125;)\t\t\treturn listenFd\t\t&#125;\t\t// çˆ¶äº²è¿›ç¨‹watch å˜æ›´\t\tdebug(&quot;[%s] watch file changed&quot;, name)\t\tvar command *exec.Cmd\t\tvar done chan bool\t\tvar errch chan error\t\tfor &#123;\t\t\t&lt;-time.After(time.Second * 3) // ç›‘å¬åˆ°éœ€è¦é‡å¯è¿›ç¨‹ (è¿™é‡Œå¯ä»¥æ¢æˆå®é™…ç¨‹åºçš„)\t\t\tif command != nil &#123;\t\t\t\t// é€šçŸ¥å­è¿›ç¨‹å…³é—­.\t\t\t\tif err := command.Process.Signal(syscall.SIGQUIT); err != nil &#123;\t\t\t\t\tpanic(err)\t\t\t\t&#125;\t\t\t\tselect &#123;\t\t\t\tcase err := &lt;-errch: // todo watch err.\t\t\t\t\tdebug(&quot;[%s] close slave-%d err: %v&quot;, name, command.Process.Pid, err)\t\t\t\t\tpanic(err)\t\t\t\tcase &lt;-done:\t\t\t\t\tdebug(&quot;[%s] close slave-%d success&quot;, name, command.Process.Pid)\t\t\t\t&#125;\t\t\t&#125;\t\t\t// å¯åŠ¨å­è¿›ç¨‹\t\t\tdone = make(chan bool, 0)\t\t\terrch = make(chan error, 0)\t\t\tif subCmd, err := startSlaveProcess(loadListenFd(), done, errch); err != nil &#123;\t\t\t\tpanic(err)\t\t\t&#125; else &#123;\t\t\t\tcommand = subCmd\t\t\t&#125;\t\t\tdebug(&quot;[%s] run slave-%d success&quot;, name, command.Process.Pid)\t\t&#125;\t&#125;()\t// å­è¿›ç¨‹å¦‚æœç›‘å¬åˆ°å…³é—­ï¼Œåˆ™éœ€è¦å…³é—­è¿æ¥\tdone := make(chan bool, 0)\tif isSlave(name) &#123;\t\tc := make(chan os.Signal)\t\tsignal.Notify(c, syscall.SIGQUIT)\t\tgo func() &#123;\t\t\tvv := &lt;-c\t\t\tif err := listen.Close(); err != nil &#123; // close ä¸ä¼˜é›…ï¼Œä¼˜é›…çš„è¯éœ€è¦ç”¨ wait-group\t\t\t\tpanic(err)\t\t\t&#125;\t\t\tdebug(&quot;[%s] close listen success, signal: %v&quot;, name, vv.String())\t\t\tclose(done)\t\t&#125;()\t&#125;\t// å¯åŠ¨ç›‘å¬\tif err := http.Serve(listen, newHandlerFunc(name)); err != nil &#123;\t\tif strings.Contains(err.Error(), &quot;use of closed network connection&quot;) &#123;\t\t\t&lt;-done\t\t\treturn\t\t&#125;\t\tpanic(err) // åˆ«çš„å¼‚å¸¸ç›´æ¥panic\t&#125;&#125;func newHandlerFunc(name string) http.HandlerFunc &#123;\treturn func(writer http.ResponseWriter, request *http.Request) &#123;\t\t_, err := writer.Write([]byte(fmt.Sprintf(&quot;name: %s, hello world&quot;, name)))\t\tif err != nil &#123;\t\t\tpanic(err)\t\t&#125;\t&#125;&#125;func isMaster(name string) bool &#123;\treturn name == &quot;master&quot;&#125;func isSlave(name string) bool &#123;\treturn strings.HasPrefix(name, &quot;slave&quot;)&#125;func debug(format string, v ...interface&#123;&#125;) &#123;\tfmt.Printf(format+&quot;\\n&quot;, v...)&#125;func startSlaveProcess(fd *os.File, done chan bool, errch chan error) (*exec.Cmd, error) &#123;\texecutable, err := os.Executable()\tif err != nil &#123;\t\treturn nil, err\t&#125;\tcommand := exec.Command(executable)\tcommand.Stdout = os.Stdout\tcommand.Stdin = os.Stdin\tcommand.Stderr = os.Stderr\tcommand.Env = append(os.Environ(), &quot;is_slave=true&quot;)\tcommand.ExtraFiles = append(command.ExtraFiles, fd) // å…±äº«fd\tif err := command.Start(); err != nil &#123;\t\treturn nil, err\t&#125;\tgo func() &#123;\t\tif err := command.Wait(); err != nil &#123;\t\t\terrch &lt;- err\t\t\treturn\t\t&#125;\t\tclose(done)\t&#125;()\treturn command, nil&#125;\n\nå¼€æºå®ç°\nhttps://github.com/jpillora/overseer  çˆ¶è¿›ç¨‹ä¸è´Ÿè´£ç›‘å¬ç«¯å£ï¼ˆè´Ÿè´£åˆ›å»ºç«¯å£/ç®¡ç†å­è¿›ç¨‹ï¼‰ï¼Œå­è¿›ç¨‹è´Ÿè´£ç›‘å¬ç«¯å£ï¼Œå½“çˆ¶è¿›ç¨‹ç›‘å¬åˆ°é‡å¯çš„æ—¶å€™ä¼šé‡å¯ å­è¿›ç¨‹ ï¼ˆåŒºåˆ«äºæˆ‘è¿™ä¸ªä¾‹å­ï¼‰ ã€æ¯”è¾ƒæ¨èï¼Œsdkä¹Ÿæ¯”è¾ƒæˆç†Ÿã€‘\nhttps://github.com/facebookarchive/grace  æ²¡æ€ä¹ˆç»†çœ‹\nhttps://github.com/fvbock/endless   è¿™ä¸ªåšæ³•æ›´æš´åŠ›äº†ï¼Œç›¸å½“äºå½“ç›‘å¬åˆ° SIGHUP ä¿¡å·æ—¶ï¼Œç›´æ¥å¯åŠ¨ä¸ªå­¤å„¿è¿›ç¨‹ï¼ˆå­è¿›ç¨‹ï¼‰ï¼Œå½“å‰è¿›ç¨‹å› ä¸ºè¢«closeï¼Œè‡ªå·±ä¸»åŠ¨é€€å‡ºï¼ä¸å¤ªé€‚ç”¨äºï¼\n\næ€»ç»“\nä¸Šé¢ä¾‹å­çš„ç¼ºé™·å°±æ˜¯ å­è¿›ç¨‹/çˆ¶è¿›ç¨‹ ç›´æ¥è°ƒç”¨ close æ–¹æ³•å»å…³é—­è¿æ¥ï¼Œç„¶åå­è¿›ç¨‹æ—¶ç›´æ¥é€€å‡ºè¿›ç¨‹äº†ï¼Œæ­¤æ—¶ä¼šå­˜åœ¨éƒ¨åˆ†å·²ç»å»ºç«‹è¿æ¥çš„è¯·æ±‚å¤±è´¥äº†ï¼Œéœ€è¦ä¼˜é›…å…³é—­ï¼Œä½†æ˜¯å®é™…ä¸Šä¼˜é›…å…³é—­ä¹Ÿä¼šå­˜åœ¨é—®é¢˜ï¼Œå°±æ˜¯waitçš„æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´åç»­æ–°å»ºçš„è¿æ¥å¤±è´¥(è¿æ¥è¶…æ—¶)ï¼Œæ‰€ä»¥å¯ä»¥é—´æ¥è¿‡åº¦ï¼Œä¹Ÿå°±å…ˆ close å…³é—­æ–°å»ºè¿æ¥ï¼Œç„¶ååˆ›å»ºå­è¿›ç¨‹ç»§ç»­ç›‘å¬ï¼Œç„¶åç­‰å¾…å‰é¢è¿™ä¸ªå­è¿›ç¨‹ä¼˜é›…é€€å‡ºå³å¯ï¼\nä¼˜é›…é‡å¯éƒ½å¼ºä¾èµ–äºsdkï¼Œå‡å¦‚ä½ çˆ¶è¿›ç¨‹çš„sdkæœ‰BUGè¿˜æ˜¯å¾—å¼ºåˆ¶å‡çº§çš„ï¼\n\nlinux å°æŠ€å·§æ—¥å¸¸ä¸­æˆ‘ä»¬ä¹Ÿä¸éœ€è¦ä¸Šé¢é‚£äº›å¤æ‚çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æˆ‘å°±æ˜¯æƒ³åå°æŒ‚èµ·å‡ ä¸ªè¿›ç¨‹æ˜¯ä¸æ˜¯ï¼Œè¿˜éœ€è¦æˆ‘è‡ªå·±é€ ä¸ªè½®å­ï¼Œå¤ªéº»çƒ¦äº†ï¼\nåå°è¿è¡Œpackage main//  go build -v -o main main.goimport (\t&quot;fmt&quot;\t&quot;log&quot;\t&quot;net/http&quot;\t&quot;net/http/httputil&quot;\t&quot;os&quot;)func main() &#123;\taddr := fmt.Sprintf(&quot;:%s&quot;, os.Args[1])\tfmt.Printf(&quot;ppid: %d, pid: %d, listen: %s\\n&quot;, os.Getppid(), os.Getpid(), addr)\tif err := http.ListenAndServe(addr, http.HandlerFunc(func(writer http.ResponseWriter, request *http.Request) &#123;\t\tdumpRequest, _ := httputil.DumpRequest(request, false)\t\tfmt.Printf(string(dumpRequest))\t\tif _, err := writer.Write([]byte(`hello world`)); err != nil &#123;\t\t\tlog.Printf(&quot;ERROR write conn find err: %v&quot;, err)\t\t&#125;\t&#125;)); err != nil &#123;\t\tlog.Fatal(err)\t&#125;&#125;\n\n\nåå°è¿è¡Œ (å½“ç»ˆç«¯å…³é—­çš„æ—¶å€™ä»–ä¹Ÿä¼šå…³é—­)\n\nâœ  test git:(master) âœ— ./main 10086 &amp;[1] 17195ppid: 12947, pid: 17195, listen: :10086                                                                                                                                                  âœ  test git:(master) âœ— echo $!                 17195\n\n\nnohub (not hang up) å½“ç»ˆç«¯å…³é—­å®ƒä¹Ÿä¸ä¼šå…³é—­\n\nâœ  test git:(master) âœ— nohup ./main 10086 &gt;nohub.log 2&gt;&amp;1 &amp;[1] 18193âœ  test git:(master) âœ— echo $!                                   18193\n\nåå°è¿è¡Œå¤šä¸ªè¿›ç¨‹ä¿¡å·ï¼š\nHUP     1    ç»ˆç«¯æ–­çº¿(ä½ æŠŠç»ˆç«¯å…³äº†ï¼Œå°±ä¼šæ”¶åˆ°è¿™ä¸ª)INT     2    ä¸­æ–­ï¼ˆåŒ Ctrl + Cï¼‰QUIT    3    é€€å‡ºï¼ˆåŒ Ctrl + \\ï¼‰TERM   15    ç»ˆæ­¢KILL    9    å¼ºåˆ¶ç»ˆæ­¢CONT   18    ç»§ç»­ï¼ˆä¸STOPç›¸åï¼Œ fg/bgå‘½ä»¤ï¼‰STOP   19    æš‚åœï¼ˆåŒ Ctrl + Zï¼‰\n\nè¿™é‡Œæˆ‘ä»¬è¿è¡Œå¤šä¸ªåå°è¿›ç¨‹ï¼Œå½“è„šæœ¬ç»“æŸçš„æ—¶å€™æ€æ­»åå°è¿›ç¨‹\n#!/usr/bin/env bashset -echild_pids=()function kill_child_process() &#123;    echo &quot;kill process ....&quot;    for elem in &quot;$&#123;child_pids[@]&#125;&quot; ; do        echo &quot;kill pid: $elem&quot;        kill -9 &quot;$elem&quot;    done&#125;# å½“è„šæœ¬é€€å‡ºæ—¶æ‰§è¡Œ kill_child_process (exitç±»ä¼¼äºdeferå‡½æ•°)trap kill_child_process EXIT# å½“æ”¶åˆ°INT/QUITä¿¡å·æ—¶æ‰§è¡Œ kill_child_process# trap kill_child_process INT QUIT# åˆ›å»ºå­è¿›ç¨‹1./main 10086 &amp;child_pids+=(&quot;$!&quot;)# åˆ›å»ºå­è¿›ç¨‹2./main 10010 &amp;child_pids+=(&quot;$!&quot;)echo &quot;åˆ›å»ºå­è¿›ç¨‹: $&#123;child_pids[*]&#125;&quot;# ç­‰å¾…å­è¿›ç¨‹ç»“æŸwait\n\næ€»ç»“æ–¹æ¡ˆæ²¡æœ‰ç»å¯¹çš„å¥½ä¸åï¼Œå–å†³äºå…·ä½“åœºæ™¯ï¼ŒæŒæ¡äº†å„ç§æ–¹æ¡ˆçš„åº•å±‚å®ç°ï¼Œä¼šæ–¹ä¾¿æˆ‘ä»¬é’ˆå¯¹äºå„ä¸ªåœºæ™¯åšå‡ºæ”¯æŒï¼\n","categories":["Linux"],"tags":["Linux"]},{"title":"dockerç½‘ç»œ","url":"/2021/01/26/62dbd7c2e00a1add795e54f9c9d4ee75/","content":"â€‹        å®¹å™¨ç½‘ç»œé€šä¿¡æ˜¯ä¸€å—å¾ˆå¤§çš„å†…å®¹ï¼ŒdockeråŸç”Ÿçš„ç½‘ç»œæ¨¡å¼å…¶å®å·²ç»å¾ˆå¼ºå¤§äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼æœ¬æ–‡åªæ˜¯é˜è¿°ä¸šåŠ¡ä¸­å¸¸ç”¨çš„å‡ ç§æ¨¡å¼ï¼\n\n\n\n\n1ã€bridgeæ¨¡å¼\nã€€åœ¨è¯¥æ¨¡å¼ä¸­ï¼ŒDocker å®ˆæŠ¤è¿›ç¨‹åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿä»¥å¤ªç½‘æ¡¥ docker0ï¼Œæ–°å»ºçš„å®¹å™¨ä¼šè‡ªåŠ¨æ¡¥æ¥åˆ°è¿™ä¸ªæ¥å£ï¼Œé™„åŠ åœ¨å…¶ä¸Šçš„ä»»ä½•ç½‘å¡ä¹‹é—´éƒ½èƒ½è‡ªåŠ¨è½¬å‘æ•°æ®åŒ…ã€‚\n[root@centos-linux ~]# ip addr show docker03: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default    link/ether 02:42:dd:54:2a:d4 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0       valid_lft forever preferred_lft forever    inet6 fe80::42:ddff:fe54:2ad4/64 scope link       valid_lft forever preferred_lft forever\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œå®ˆæŠ¤è¿›ç¨‹ä¼šåˆ›å»ºä¸€ä¸€å¯¹ç­‰è™šæ‹Ÿè®¾å¤‡æ¥å£ veth pairï¼Œå°†å…¶ä¸­ä¸€ä¸ªæ¥å£è®¾ç½®ä¸ºå®¹å™¨çš„ eth0 æ¥å£ï¼ˆå®¹å™¨çš„ç½‘å¡ï¼‰ï¼Œå¦ä¸€ä¸ªæ¥å£æ”¾ç½®åœ¨å®¿ä¸»æœºçš„å‘½åç©ºé—´ä¸­ï¼Œä»¥ç±»ä¼¼ vethxxx è¿™æ ·çš„åå­—å‘½åï¼Œä»è€Œå°†å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨éƒ½è¿æ¥åˆ°è¿™ä¸ªå†…éƒ¨ç½‘ç»œä¸Šã€‚\né¦–å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„ç½‘å¡ï¼Œeth0\n[fanhaodong@centos-linux ~]$ docker run --rm -it busybox /bin/sh/ # ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever6: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0       valid_lft forever preferred_lft forever       \n\nç„¶åå†çœ‹å®¿ä¸»æœºï¼Œç”±äºmacçš„ç½‘ç»œæ¨¡å‹å’Œlinuxå‘è¡Œç‰ˆæœ‰åŒºåˆ«ï¼Œæ‰€ä»¥ä½¿ç”¨çš„centos7çš„CentOS Linux release 7.9.2009\n[root@centos-linux ~]# ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host       valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000    link/ether 00:1c:42:b8:a6:b2 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.3/24 brd 192.168.56.255 scope global noprefixroute dynamic eth0       valid_lft 1769sec preferred_lft 1769sec    inet6 fdb2:2c26:f4e4:0:21c:42ff:feb8:a6b2/64 scope global noprefixroute dynamic       valid_lft 2591754sec preferred_lft 604554sec    inet6 fe80::21c:42ff:feb8:a6b2/64 scope link noprefixroute       valid_lft forever preferred_lft forever3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default    link/ether 02:42:dd:54:2a:d4 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0       valid_lft forever preferred_lft forever    inet6 fe80::42:ddff:fe54:2ad4/64 scope link       valid_lft forever preferred_lft forever7: veth132f35c@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default    link/ether 0e:5e:61:09:28:7c brd ff:ff:ff:ff:ff:ff link-netnsid 0    inet6 fe80::c5e:61ff:fe09:287c/64 scope link       valid_lft forever preferred_lft forever\n\n\nå¯ä»¥çœ‹åˆ°æœ¬åœ°ç½‘ç»œå¤šäº†ä¸€ä¸ªç½‘å¡7: veth132f35c@if6ï¼Œ\né€šè¿‡ä»¥ä¸Šçš„æ¯”è¾ƒå¯ä»¥å‘ç°ï¼Œè¯å®äº†ä¹‹å‰æ‰€è¯´çš„ï¼šå®ˆæŠ¤è¿›ç¨‹ä¼šåˆ›å»ºä¸€å¯¹å¯¹ç­‰è™šæ‹Ÿè®¾å¤‡æ¥å£ veth pairï¼Œå°†å…¶ä¸­ä¸€ä¸ªæ¥å£è®¾ç½®ä¸ºå®¹å™¨çš„ eth0 æ¥å£ï¼ˆå®¹å™¨çš„ç½‘å¡ï¼‰ï¼Œå¦ä¸€ä¸ªæ¥å£æ”¾ç½®åœ¨å®¿ä¸»æœºçš„å‘½åç©ºé—´ä¸­ï¼Œä»¥ç±»ä¼¼ vethxxx è¿™æ ·çš„åå­—å‘½åã€‚\nåŒæ—¶ï¼Œå®ˆæŠ¤è¿›ç¨‹è¿˜ä¼šä»ç½‘æ¡¥ docker0 çš„ç§æœ‰åœ°å€ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ª IP åœ°å€å’Œå­ç½‘ç»™è¯¥å®¹å™¨ï¼Œå¹¶è®¾ç½® docker0 çš„ IP åœ°å€ä¸ºå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚ä¹Ÿå¯ä»¥å®‰è£… yum install -y bridge-utils ä»¥åï¼Œé€šè¿‡ brctl show å‘½ä»¤æŸ¥çœ‹ç½‘æ¡¥ä¿¡æ¯ã€‚\n\n[fanhaodong@centos-linux ~]$ brctl showbridge name\tbridge id\t\tSTP enabled\tinterfacesdocker0\t\t8000.0242dd542ad4\tno\t\tveth132f35c\n\nå¯ä»¥çœ‹åˆ° interfacesæœ‰ä¸€ä¸ªå«åš veth132f35c\nå¯ä»¥é€šè¿‡  docker network inspect bridge æŸ¥çœ‹æ¨¡å¼\n[root@centos-linux ~]# docker network inspect bridge[    &#123;        &quot;Name&quot;: &quot;bridge&quot;,        &quot;Id&quot;: &quot;50e703932ca8d619016f1e08df21269ee09b3f9799c81f47e5df6e477ee3c341&quot;,        &quot;Created&quot;: &quot;2021-02-03T11:22:58.527865244+08:00&quot;,        &quot;Scope&quot;: &quot;local&quot;,        &quot;Driver&quot;: &quot;bridge&quot;,        &quot;EnableIPv6&quot;: false,        &quot;IPAM&quot;: &#123;            &quot;Driver&quot;: &quot;default&quot;,            &quot;Options&quot;: null,            &quot;Config&quot;: [                &#123;                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;                &#125;            ]        &#125;,        &quot;Internal&quot;: false,        &quot;Attachable&quot;: false,        &quot;Ingress&quot;: false,        &quot;ConfigFrom&quot;: &#123;            &quot;Network&quot;: &quot;&quot;        &#125;,        &quot;ConfigOnly&quot;: false,        &quot;Containers&quot;: &#123;            &quot;66949d48a6c0d1629240ab01c2601fd1c885e66b8e75b254b2e5537e7414914e&quot;: &#123;                &quot;Name&quot;: &quot;modest_tesla&quot;,                &quot;EndpointID&quot;: &quot;1012aaac090fa8dac5fababa3467338a255f867b581a97539abb67477da3036a&quot;,                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,                &quot;IPv6Address&quot;: &quot;&quot;            &#125;        &#125;,        &quot;Options&quot;: &#123;            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;        &#125;,        &quot;Labels&quot;: &#123;&#125;    &#125;]\n\nå¯ä»¥çœ‹åˆ° å®¹å™¨åç§°ä¸€æ ·,\n[root@centos-linux ~]# docker psCONTAINER ID   IMAGE     COMMAND     CREATED         STATUS         PORTS     NAMES66949d48a6c0   busybox   &quot;/bin/sh&quot;   2 minutes ago   Up 2 minutes             modest_tesla\n\næŸ¥çœ‹ network, docker inspect 66949d48a6c0  -f &#39;&#123;&#123;json .NetworkSettings.Networks.bridge&#125;&#125;&#39;\n[root@centos-linux ~]# docker inspect 66949d48a6c0  -f &#x27;&#123;&#123;json .NetworkSettings.Networks.bridge&#125;&#125;&#x27;&#123;    &quot;IPAMConfig&quot;: null,    &quot;Links&quot;: null,    &quot;Aliases&quot;: null,    &quot;NetworkID&quot;: &quot;50e703932ca8d619016f1e08df21269ee09b3f9799c81f47e5df6e477ee3c341&quot;,    &quot;EndpointID&quot;: &quot;1012aaac090fa8dac5fababa3467338a255f867b581a97539abb67477da3036a&quot;,    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,    &quot;IPPrefixLen&quot;: 16,    &quot;IPv6Gateway&quot;: &quot;&quot;,    &quot;GlobalIPv6Address&quot;: &quot;&quot;,    &quot;GlobalIPv6PrefixLen&quot;: 0,    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,    &quot;DriverOpts&quot;: null&#125;\n\næ³¨æ„ï¼š\nç½‘æ¡¥æ¨¡å¼ä¸‹ï¼Œå„ä¸ªå®¹å™¨æ˜¯å¯ä»¥äº’ç›¸pingé€šçš„ï¼Œå¯ä»¥é€šè¿‡ä¸»æœºIPç›¸äº’PINGé€šï¼ˆé»˜è®¤çš„ä¸æ”¯æŒä¸»æœºåç›¸äº’pingé€šï¼‰\n2ã€host ç½‘ç»œæ¨¡å¼\nâ€‹    è¿™ä¸ªæ¯”è¾ƒé€‚åˆç”¨äºæœ¬åœ°è½¯ä»¶å®‰è£…ï¼Œå•è½¯ä»¶ï¼Œç±»ä¼¼äºå¯åŠ¨ä¸€ä¸ªç¨‹åºï¼Œä½†æ˜¯éœ€è¦ç¯å¢ƒä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ª\n\n\nhost ç½‘ç»œæ¨¡å¼éœ€è¦åœ¨åˆ›å»ºå®¹å™¨æ—¶é€šè¿‡å‚æ•° --net host æˆ–è€… --network host æŒ‡å®šï¼›\né‡‡ç”¨ host ç½‘ç»œæ¨¡å¼çš„ Docker Containerï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ IP åœ°å€ä¸å¤–ç•Œè¿›è¡Œé€šä¿¡ï¼Œè‹¥å®¿ä¸»æœºçš„ eth0 æ˜¯ä¸€ä¸ªå…¬æœ‰ IPï¼Œé‚£ä¹ˆå®¹å™¨ä¹Ÿæ‹¥æœ‰è¿™ä¸ªå…¬æœ‰ IPã€‚åŒæ—¶å®¹å™¨å†…æœåŠ¡çš„ç«¯å£ä¹Ÿå¯ä»¥ä½¿ç”¨å®¿ä¸»æœºçš„ç«¯å£ï¼Œæ— éœ€é¢å¤–è¿›è¡Œ NAT è½¬æ¢ï¼›\nhost ç½‘ç»œæ¨¡å¼å¯ä»¥è®©å®¹å™¨å…±äº«å®¿ä¸»æœºç½‘ç»œæ ˆï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¤–éƒ¨ä¸»æœºä¸å®¹å™¨ç›´æ¥é€šä¿¡ï¼Œä½†æ˜¯å®¹å™¨çš„ç½‘ç»œç¼ºå°‘éš”ç¦»æ€§ã€‚\nhost æ¨¡å¼ä¸èƒ½è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œæ¯”å¦‚ping www.baidu.comæ˜¯è¡Œä¸é€šçš„\n\n[root@centos-linux .ssh]#  docker run --rm -it --network host  busybox ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host       valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast qlen 1000    link/ether 00:1c:42:b8:a6:b2 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.3/24 brd 192.168.56.255 scope global dynamic eth0       valid_lft 1128sec preferred_lft 1128sec    inet6 fdb2:2c26:f4e4:0:21c:42ff:feb8:a6b2/64 scope global dynamic       valid_lft 2591996sec preferred_lft 604796sec    inet6 fe80::21c:42ff:feb8:a6b2/64 scope link       valid_lft forever preferred_lft forever3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue    link/ether 02:42:dd:54:2a:d4 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0       valid_lft forever preferred_lft forever    inet6 fe80::42:ddff:fe54:2ad4/64 scope link       valid_lft forever preferred_lft forever\n\n3ã€none ç½‘ç»œæ¨¡å¼\nnone ç½‘ç»œæ¨¡å¼æ˜¯æŒ‡ç¦ç”¨ç½‘ç»œåŠŸèƒ½ï¼Œåªæœ‰ lo æ¥å£ local çš„ç®€å†™ï¼Œä»£è¡¨ 127.0.0.1ï¼Œå³ localhost æœ¬åœ°ç¯å›æ¥å£ã€‚åœ¨åˆ›å»ºå®¹å™¨æ—¶é€šè¿‡å‚æ•° --net none æˆ–è€… --network none æŒ‡å®šï¼›\nnone ç½‘ç»œæ¨¡å¼å³ä¸ä¸º Docker Container åˆ›å»ºä»»ä½•çš„ç½‘ç»œç¯å¢ƒï¼Œå®¹å™¨å†…éƒ¨å°±åªèƒ½ä½¿ç”¨ loopback ç½‘ç»œè®¾å¤‡ï¼Œä¸ä¼šå†æœ‰å…¶ä»–çš„ç½‘ç»œèµ„æºã€‚å¯ä»¥è¯´ none æ¨¡å¼ä¸º Docke Container åšäº†æå°‘çš„ç½‘ç»œè®¾å®šï¼Œä½†æ˜¯ä¿—è¯è¯´å¾—å¥½â€œå°‘å³æ˜¯å¤šâ€ï¼Œåœ¨æ²¡æœ‰ç½‘ç»œé…ç½®çš„æƒ…å†µä¸‹ï¼Œä½œä¸º Docker å¼€å‘è€…ï¼Œæ‰èƒ½åœ¨è¿™åŸºç¡€åšå…¶ä»–æ— é™å¤šå¯èƒ½çš„ç½‘ç»œå®šåˆ¶å¼€å‘ã€‚è¿™ä¹Ÿæ°å·§ä½“ç°äº† Docker è®¾è®¡ç†å¿µçš„å¼€æ”¾ã€‚\n\n[root@centos-linux .ssh]#  docker run --rm -it --network none  busybox ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever\n\n4ã€container ç½‘ç»œæ¨¡å¼\nContainer ç½‘ç»œæ¨¡å¼æ˜¯ Docker ä¸­ä¸€ç§è¾ƒä¸ºç‰¹åˆ«çš„ç½‘ç»œçš„æ¨¡å¼ã€‚åœ¨åˆ›å»ºå®¹å™¨æ—¶é€šè¿‡å‚æ•° --net container:å·²è¿è¡Œçš„å®¹å™¨åç§°/ID æˆ–è€… --network container:å·²è¿è¡Œçš„å®¹å™¨åç§°/ID æŒ‡å®šï¼›\nå¤„äºè¿™ä¸ªæ¨¡å¼ä¸‹çš„ Docker å®¹å™¨ä¼šå…±äº«ä¸€ä¸ªç½‘ç»œæ ˆï¼Œè¿™æ ·ä¸¤ä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥ä½¿ç”¨ localhost é«˜æ•ˆå¿«é€Ÿé€šä¿¡ã€‚\n\n[root@centos-linux .ssh]#  docker run --rm -it --name b1  busybox /bin/sh/ # ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever28: eth0@if29: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0       valid_lft forever preferred_lft forever\n\nä¸»æœº2\n[root@centos-linux ~]#  docker run --rm -it --name b2 --network container:b1  busybox ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever28: eth0@if29: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0       valid_lft forever preferred_lft forever\n\nå‡å¦‚æ­¤æ—¶ ä¸»æœºb1æ­»æœºäº†ï¼Œå…¶å®å®ƒçš„ç½‘å¡ä¹Ÿåªå‰©ä¸‹loç½‘å¡\nb2 ä¸»æœºå½“ b1 æŒ‚æ‰åä¼šå¦‚å›¾æ‰€ç¤ºï¼Œå½“ b1é‡å¯ï¼Œb2ä¹Ÿéœ€è¦é‡å¯æ‰èƒ½çœ‹åˆ°ç½‘å¡ä¿¡æ¯\n/ # ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever/ #\n\n5ã€è‡ªå®šä¹‰ç½‘ç»œ1ã€è‡ªå®šä¹‰åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼Œé»˜è®¤æ˜¯bridgeæ¨¡å¼ï¼\n[root@centos-linux /]# docker network create custom_network94a35aa31bdee048a0e5d8b178e4246b429d4525a4036d3d9287650933357c6e\n\n2ã€æŸ¥çœ‹ç½‘ç»œ\n[root@centos-linux /]# docker network inspect custom_network[    &#123;        &quot;Name&quot;: &quot;custom_network&quot;,        &quot;Id&quot;: &quot;94a35aa31bdee048a0e5d8b178e4246b429d4525a4036d3d9287650933357c6e&quot;,        &quot;Created&quot;: &quot;2021-03-26T14:35:27.907496817+08:00&quot;,        &quot;Scope&quot;: &quot;local&quot;,        &quot;Driver&quot;: &quot;bridge&quot;,        &quot;EnableIPv6&quot;: false,        &quot;IPAM&quot;: &#123;            &quot;Driver&quot;: &quot;default&quot;,            &quot;Options&quot;: &#123;&#125;,            &quot;Config&quot;: [                &#123;                    &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;,                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;                &#125;            ]        &#125;,        &quot;Internal&quot;: false,        &quot;Attachable&quot;: false,        &quot;Ingress&quot;: false,        &quot;ConfigFrom&quot;: &#123;            &quot;Network&quot;: &quot;&quot;        &#125;,        &quot;ConfigOnly&quot;: false,        &quot;Containers&quot;: &#123;&#125;,        &quot;Options&quot;: &#123;&#125;,        &quot;Labels&quot;: &#123;&#125;    &#125;]\n\n3ã€ä½¿ç”¨ customç½‘ç»œ\n[root@centos-linux /]# docker run --rm -d --name demo-1 --network custom_network alpine top93e04b37b6a7418131a1ff2ef21d45c807757746841a601a1438ffa5c6fa1061[root@centos-linux /]# docker run --rm -d --name demo-2 --network custom_network alpine topbe07cf3872c42a46dc564fa8f20dee696301e8cc24dc653ffa71cb52bd4c0de3\n\n4ã€æ˜¯å¦å¯ä»¥ç›¸äº’pingé€š\n\nå®¹å™¨é—´å¯ä»¥ç›¸äº’Pingé€š\n\n[root@centos-linux /]# docker exec -it demo-1 ping  -c 2 demo-2PING demo-2 (172.18.0.3): 56 data bytes64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.034 ms64 bytes from 172.18.0.3: seq=1 ttl=64 time=0.143 ms--- demo-2 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.034/0.088/0.143 ms[root@centos-linux /]# docker exec -it demo-2 ping -c 2 demo-1PING demo-1 (172.18.0.2): 56 data bytes64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.041 ms64 bytes from 172.18.0.2: seq=1 ttl=64 time=0.091 ms--- demo-1 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.041/0.066/0.091 ms\n\n\nping å®¿ä¸»æœº pass\n\n[root@centos-linux /]# docker exec -it demo-2 ping -c 2 192.168.56.3PING 192.168.56.3 (192.168.56.3): 56 data bytes64 bytes from 192.168.56.3: seq=0 ttl=64 time=0.082 ms64 bytes from 192.168.56.3: seq=1 ttl=64 time=0.121 ms--- 192.168.56.3 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.082/0.101/0.121 ms\n\n6ã€è·¨å®¿ä¸»æœºè®¿é—®â€‹    å®˜æ–¹æ–‡æ¡£: æŸäº›åº”ç”¨ç¨‹åºï¼Œå°¤å…¶æ˜¯æ—§ç‰ˆåº”ç”¨ç¨‹åºæˆ–ç›‘è§†ç½‘ç»œæµé‡çš„åº”ç”¨ç¨‹åºï¼ŒæœŸæœ›ç›´æ¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨macvlanç½‘ç»œé©±åŠ¨ç¨‹åºä¸ºæ¯ä¸ªå®¹å™¨çš„è™šæ‹Ÿç½‘ç»œæ¥å£åˆ†é…MACåœ°å€ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒæ˜¯ç›´æ¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œçš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚\nâ€‹    å¯¹äºSDNæ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯åŸºäºoverlayæ¨¡å¼ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨dockerä¸­ä¼šå‡ºç°è·¨ä¸»æœºå®¹å™¨æ— æ³•é€šä¿¡çš„é—®é¢˜ï¼Œdockeræä¾›ipvlanæŠ€æœ¯å®Œå…¨å¯ä»¥è§£å†³ï¼Œä½†æ˜¯éœ€è¦linuxå†…æ ¸ç‰ˆæœ¬&gt; 4.2ï¼Œå”¯ä¸€çš„å±€é™æ€§å°±æ˜¯éœ€è¦è‡ªå·±å®ç°å®¿ä¸»æœºä¸å®¹å™¨é—´é€šä¿¡çš„é—®é¢˜ï¼\nâ€‹    åƒæˆ‘ä»¬å…¬å¸å°±æ˜¯åŸºäºipvlanå®ç°çš„è·¨å®¿ä¸»æœºé€šä¿¡çš„é—®é¢˜\n1ã€macvlan æ¨¡å¼ä»‹ç»â€‹        macvlan æ˜¯åœ¨docker1.2ç‰ˆæœ¬ä¹‹åæ¨å‡ºçš„ï¼Œä¸»è¦æ˜¯è§£å†³ï¼šæ˜¯æ—§ç‰ˆåº”ç”¨ç¨‹åºæˆ–ç›‘è§†ç½‘ç»œæµé‡çš„åº”ç”¨ç¨‹åºï¼ŒæœŸæœ›ç›´æ¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œ(æ„æ€å°±æ˜¯ç›´æ¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œï¼Œå¯ä»¥ç›¸äº’pingé€š)\nâ€‹        åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨macvlanç½‘ç»œé©±åŠ¨ç¨‹åºä¸ºæ¯ä¸ªå®¹å™¨çš„è™šæ‹Ÿç½‘ç»œæ¥å£åˆ†é…MACåœ°å€ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒæ˜¯ç›´æ¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œçš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦åœ¨Dockerä¸»æœºä¸ŠæŒ‡å®šç”¨äºçš„ç‰©ç†æ¥å£macvlanï¼Œä»¥åŠçš„å­ç½‘å’Œç½‘å…³macvlanã€‚æ‚¨ç”šè‡³å¯ä»¥macvlanä½¿ç”¨ä¸åŒçš„ç‰©ç†ç½‘ç»œæ¥å£éš”ç¦»ç½‘ç»œã€‚è¯·è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š\n\nç”±äºIPåœ°å€è€—å°½æˆ–â€œ VLANä¼ æ’­â€ï¼Œå¾ˆå®¹æ˜“æ— æ„é—´æŸåæ‚¨çš„ç½‘ç»œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨çš„ç½‘ç»œä¸­æœ‰å¤§é‡ä¸æ­£ç¡®çš„å”¯ä¸€MACåœ°å€ã€‚\næ‚¨çš„ç½‘ç»œè®¾å¤‡éœ€è¦èƒ½å¤Ÿå¤„ç†â€œæ··æ‚æ¨¡å¼â€ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªç‰©ç†æ¥å£åˆ†é…å¤šä¸ªMACåœ°å€ã€‚\nå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ç½‘æ¡¥ï¼ˆåœ¨å•ä¸ªDockerä¸»æœºä¸Šï¼‰æˆ–è¦†ç›–ï¼ˆè·¨å¤šä¸ªDockerä¸»æœºè¿›è¡Œé€šä¿¡ï¼‰å·¥ä½œï¼Œé‚£ä¹ˆä»é•¿è¿œæ¥çœ‹ï¼Œè¿™äº›è§£å†³æ–¹æ¡ˆå¯èƒ½ä¼šæ›´å¥½ã€‚\n\nä½¿ç”¨1ã€æˆ‘çš„ä¸»æœºip\n[root@centos-linux ~]# ip addr show eth02: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000    link/ether 00:1c:42:b8:a6:b2 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.3/24 brd 192.168.56.255 scope global noprefixroute dynamic eth0       valid_lft 1098sec preferred_lft 1098sec    inet6 fdb2:2c26:f4e4:0:21c:42ff:feb8:a6b2/64 scope global noprefixroute dynamic       valid_lft 2591546sec preferred_lft 604346sec    inet6 fe80::21c:42ff:feb8:a6b2/64 scope link noprefixroute       valid_lft forever preferred_lft forever\n\n2ã€æ ¹æ®ä¸»æœºipå»åˆ›å»º macvlan\n[root@centos-linux ~]# docker network create -d macvlan \\--subnet=192.168.56.0/24 \\--gateway=192.168.56.1 \\-o parent=eth0 macvlan_net3adcc89a20a0a40b55b026ffcb9164990ca8c347d23445f367ed1a88f83ddd57\n\n3ã€æŸ¥çœ‹dockerç½‘ç»œä¿¡æ¯\næ‰€æœ‰ç½‘ç»œ\n[root@centos-linux ~]# docker network listNETWORK ID     NAME          DRIVER    SCOPE3505ceea1e1b   bridge        bridge    local892b017dd40d   host          host      local3adcc89a20a0   macvlan_net   macvlan   local69e3ce2179b5   none          null      local\n\nä¿¡æ¯\n[root@centos-linux ~]# docker network inspect macvlan_net[    &#123;        &quot;Name&quot;: &quot;macvlan_net&quot;,        &quot;Id&quot;: &quot;71e776d96002b0d6977a65b6e370b3d8b71283304239e16144cdf1298f7500cc&quot;,        &quot;Created&quot;: &quot;2021-03-05T19:59:54.375164139+08:00&quot;,        &quot;Scope&quot;: &quot;local&quot;,        &quot;Driver&quot;: &quot;macvlan&quot;,        &quot;EnableIPv6&quot;: false,        &quot;IPAM&quot;: &#123;            &quot;Driver&quot;: &quot;default&quot;,            &quot;Options&quot;: &#123;&#125;,            &quot;Config&quot;: [                &#123;                    &quot;Subnet&quot;: &quot;192.168.56.0/24&quot;,                    &quot;Gateway&quot;: &quot;192.168.56.1&quot;                &#125;            ]        &#125;,        &quot;Internal&quot;: false,        &quot;Attachable&quot;: false,        &quot;Ingress&quot;: false,        &quot;ConfigFrom&quot;: &#123;            &quot;Network&quot;: &quot;&quot;        &#125;,        &quot;ConfigOnly&quot;: false,        &quot;Containers&quot;: &#123;            &quot;2a2285139cd7fb92a93b437ad6bd00b9b2d80f1918b448f22cadc03a32cc5d12&quot;: &#123;                &quot;Name&quot;: &quot;gallant_nightingale&quot;,                &quot;EndpointID&quot;: &quot;7399fc4d01163d87b0ef078772c0abd3e1dd857eb6bcc692eb06d5cc9767008b&quot;,                &quot;MacAddress&quot;: &quot;02:42:c0:a8:38:20&quot;,                &quot;IPv4Address&quot;: &quot;192.168.56.32/24&quot;,                &quot;IPv6Address&quot;: &quot;&quot;            &#125;,            &quot;61e4e496c22ab5ca0f4bd7a44fd3c9b996f6ff81a33c6853ac94270608696974&quot;: &#123;                &quot;Name&quot;: &quot;nervous_mendeleev&quot;,                &quot;EndpointID&quot;: &quot;e238ca83dc06eff26cc6f862d431ffac8750815870bfb2eb7fc5a498c9a81cec&quot;,                &quot;MacAddress&quot;: &quot;02:42:c0:a8:38:1f&quot;,                &quot;IPv4Address&quot;: &quot;192.168.56.31/24&quot;,                &quot;IPv6Address&quot;: &quot;&quot;            &#125;        &#125;,        &quot;Options&quot;: &#123;            &quot;parent&quot;: &quot;eth0&quot;        &#125;,        &quot;Labels&quot;: &#123;&#125;    &#125;]\n\n4ã€åˆ›å»ºå®¹å™¨\n1)ç›´æ¥å¯åŠ¨\nå¯ä»¥çœ‹åˆ°IPæ˜¯ 192.168.56.2 ï¼Œå±äº 192.168.56.3/24 å­ç½‘ä¸‹é¢ï¼Œç”±äºæ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå®¹å™¨æ˜¯é¡ºåºåˆ›å»ºçš„ï¼Œipå°±æ˜¯2 (å­˜åœ¨çš„é—®é¢˜å°±æ˜¯å¯èƒ½å’Œå®¿ä¸»æœºipç›¸åŒï¼Œè¿™å°±å°´å°¬äº†)\nå®¹å™¨1\n[root@centos-linux ~]# docker run --rm -it --net=macvlan_net --ip 192.168.56.31 alpine /bin/sh/ # ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever8: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP    link/ether 02:42:c0:a8:38:1f brd ff:ff:ff:ff:ff:ff    inet 192.168.56.31/24 brd 192.168.56.255 scope global eth0       valid_lft forever preferred_lft forever\n\nå®¹å™¨2\n[root@centos-linux ~]# docker run --rm -it --net=macvlan_net --ip 192.168.56.32 alpine /bin/sh/ # ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever9: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP    link/ether 02:42:c0:a8:38:20 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.32/24 brd 192.168.56.255 scope global eth0       valid_lft forever preferred_lft forever\n\n2ï¼‰pingå®éªŒ\n1ã€åŒä¸€å®¿ä¸»æœºæ— æ³•PINGé€šå®¹å™¨ï¼š\n[root@centos-linux ~]# ping 192.168.56.31 -c 2PING 192.168.56.31 (192.168.56.31) 56(84) bytes of data.From 192.168.56.3 icmp_seq=1 Destination Host UnreachableFrom 192.168.56.3 icmp_seq=2 Destination Host Unreachable--- 192.168.56.31 ping statistics ---2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1002mspipe 2[root@centos-linux ~]# ping 192.168.56.32 -c 2PING 192.168.56.32 (192.168.56.32) 56(84) bytes of data.^[From 192.168.56.3 icmp_seq=1 Destination Host UnreachableFrom 192.168.56.3 icmp_seq=2 Destination Host Unreachable--- 192.168.56.32 ping statistics ---2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1007mspipe 2\n\nå…³äºï¼š Destination Host Unreachable ,å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼šhttps://www.eefocus.com/communication/426853 ,é—®é¢˜å°±æ˜¯  å±€åŸŸç½‘ä¸­æ— æ³•æ‰¾åˆ°å¯¹åº” IP çš„ MAC åœ°å€ï¼Œæ— æ³•å®Œæˆå°è£…ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°dockerçš„å®ç°å…¶å®å°±æ˜¯åšäº†ä¸€å±‚macåœ°å€çš„è½¬æ¢\n[root@centos-linux ~]# ip route get 192.168.56.32192.168.56.32 dev eth0 src 192.168.56.3 uid 0    cache# ä¸»è¦èµ°çš„æ˜¯é€šè¿‡ eth0     \n\n2ã€åŒä¸€ä¸ªå®¿ä¸»æœºé‚£å®¹å™¨æ— æ³•pingé€šå®¿ä¸»æœºï¼š\n/ # ping -c 2  192.168.56.3PING 192.168.56.3 (192.168.56.3): 56 data bytes^C--- 192.168.56.3 ping statistics ---2 packets transmitted, 0 packets received, 100% packet loss/ # ping -c 2  192.168.56.3PING 192.168.56.3 (192.168.56.3): 56 data bytes--- 192.168.56.3 ping statistics ---2 packets transmitted, 0 packets received, 100% packet loss\n\nåŸå› æ˜¯ä»€ä¹ˆï¼š\n3ã€åŒä¸€ä¸ªå®¿ä¸»æœºé‚£å®¹å™¨é—´é€šä¿¡\nå¯ä»¥çœ‹åˆ°åŒä¸€ä¸ªå®¿ä¸»æœºå†…çš„å®¹å™¨å¯ä»¥ç›¸äº’é€šä¿¡\n/ #  ping 192.168.56.32 -c 2PING 192.168.56.32 (192.168.56.32): 56 data bytes64 bytes from 192.168.56.32: seq=0 ttl=64 time=0.054 ms64 bytes from 192.168.56.32: seq=1 ttl=64 time=0.116 ms--- 192.168.56.32 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.054/0.085/0.116 ms/ # ping 192.168.56.31 -c 2PING 192.168.56.31 (192.168.56.31): 56 data bytes64 bytes from 192.168.56.31: seq=0 ttl=64 time=0.055 ms64 bytes from 192.168.56.31: seq=1 ttl=64 time=0.114 ms--- 192.168.56.31 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.055/0.084/0.114 ms\n\n4ã€åˆ›å»ºå®¿ä¸»æœº2\n[root@centos-4-5 ~]# ip addr show eth02: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000    link/ether 00:1c:42:79:65:9d brd ff:ff:ff:ff:ff:ff    inet 192.168.56.7/24 brd 192.168.56.255 scope global noprefixroute dynamic eth0       valid_lft 1475sec preferred_lft 1475sec    inet6 fdb2:2c26:f4e4:0:21c:42ff:fe79:659d/64 scope global noprefixroute dynamic       valid_lft 2591565sec preferred_lft 604365sec    inet6 fe80::21c:42ff:fe79:659d/64 scope link noprefixroute       valid_lft forever preferred_lft forever\n\n5ã€æµ‹è¯•ä¸»æœº1ä¸ä¸»æœº2é€šä¿¡ ,å®Œå…¨OK\n[root@centos-4-5 ~]# ping 192.168.56.3 -c 2PING 192.168.56.3 (192.168.56.3) 56(84) bytes of data.64 bytes from 192.168.56.3: icmp_seq=1 ttl=64 time=0.585 ms64 bytes from 192.168.56.3: icmp_seq=2 ttl=64 time=0.521 ms--- 192.168.56.3 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1043msrtt min/avg/max/mdev = 0.521/0.553/0.585/0.032 ms\n\n6ã€æµ‹è¯•ä¸»æœº2ä¸ä¸»æœº1çš„å®¹å™¨é€šä¿¡ï¼Œä¸å¯ç”¨\n[root@centos-4-5 ~]# ping 192.168.56.31 -c 2PING 192.168.56.31 (192.168.56.31) 56(84) bytes of data.--- 192.168.56.31 ping statistics ---2 packets transmitted, 0 received, 100% packet loss, time 1051ms\n\næ€»ç»“macvlan æ¨¡å¼çš„å±€é™æ€§è¾ƒå¤§ï¼Œåªèƒ½å®¿ä¸»æœºå†…å®¹å™¨ä¹‹é—´ç›¸äº’å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯ä¸èƒ½å®ç°è·¨ä¸»æœºå®¹å™¨çš„é€šä¿¡\n2ã€IpVlan æ¨¡å¼ipvlanå°±æ¯”è¾ƒå¼ºå¤§äº†ï¼Œå¯ä»¥æ”¯æŒè·¨å®¿ä¸»æœºé€šä¿¡ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„é…ç½®ï¼\nä½¿ç”¨[root@centos-linux ~]# docker network create -d ipvlan \\--subnet=192.168.56.0/24 \\--gateway=192.168.56.1 \\-o parent=eth0 ipvlan_net\n\nè¯¦æƒ…\n[root@centos-linux ~]# docker network inspect ipvlan_net[    &#123;        &quot;Name&quot;: &quot;ipvlan_net&quot;,        &quot;Id&quot;: &quot;22a8b5faf9ddc2b8a7a81d67467649b331c8ccaf2a7bc7aaf25dd7344d1fed26&quot;,        &quot;Created&quot;: &quot;2021-03-06T16:03:26.113213178+08:00&quot;,        &quot;Scope&quot;: &quot;local&quot;,        &quot;Driver&quot;: &quot;ipvlan&quot;,        &quot;EnableIPv6&quot;: false,        &quot;IPAM&quot;: &#123;            &quot;Driver&quot;: &quot;default&quot;,            &quot;Options&quot;: &#123;&#125;,            &quot;Config&quot;: [                &#123;                    &quot;Subnet&quot;: &quot;192.168.56.0/24&quot;,                    &quot;Gateway&quot;: &quot;192.168.56.1&quot;                &#125;            ]        &#125;,        &quot;Internal&quot;: false,        &quot;Attachable&quot;: false,        &quot;Ingress&quot;: false,        &quot;ConfigFrom&quot;: &#123;            &quot;Network&quot;: &quot;&quot;        &#125;,        &quot;ConfigOnly&quot;: false,        &quot;Containers&quot;: &#123;            &quot;80c8bb73c329f1c0c370514c72cd25979a1b5d8aa112b49c24385d558d2d4e53&quot;: &#123;                &quot;Name&quot;: &quot;recursing_leakey&quot;,                &quot;EndpointID&quot;: &quot;8055b00e4981d35b08f39565bde348142785565b3e43055fb719d9f7cef7fae5&quot;,                &quot;MacAddress&quot;: &quot;&quot;,                &quot;IPv4Address&quot;: &quot;192.168.56.32/24&quot;,                &quot;IPv6Address&quot;: &quot;&quot;            &#125;,            &quot;e1f96d16c0e5f9b04cc49b63cc991c89834ec6f0f599a64853bb6dddd26b3f51&quot;: &#123;                &quot;Name&quot;: &quot;confident_hodgkin&quot;,                &quot;EndpointID&quot;: &quot;d1347ff2d6f1d8c2070d1dccad5aa29f3e3c34bc982ab026a352f071f6626dd7&quot;,                &quot;MacAddress&quot;: &quot;&quot;,                &quot;IPv4Address&quot;: &quot;192.168.56.31/24&quot;,                &quot;IPv6Address&quot;: &quot;&quot;            &#125;        &#125;,        &quot;Options&quot;: &#123;            &quot;parent&quot;: &quot;eth0&quot;        &#125;,        &quot;Labels&quot;: &#123;&#125;    &#125;]\n\n1ã€ä¸»æœº1-&gt; å®¹å™¨1-2ï¼ˆä¸é€šï¼‰ / å®¹å™¨1-2 -&gt; ä¸»æœº1 (ä¸é€š)\n[root@centos-linux ~]# ping 192.168.56.32 -c 2PING 192.168.56.32 (192.168.56.32) 56(84) bytes of data.From 192.168.56.3 icmp_seq=1 Destination Host UnreachableFrom 192.168.56.3 icmp_seq=2 Destination Host Unreachable--- 192.168.56.32 ping statistics ---2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1072mspipe 2/ # ping 192.168.56.3 -c 2PING 192.168.56.3 (192.168.56.3): 56 data bytes--- 192.168.56.3 ping statistics ---2 packets transmitted, 0 packets received, 100% packet loss\n\n2ã€å®¹å™¨1-2-&gt;å®¹å™¨1-1 ï¼ˆé€šï¼‰\n/ # ping 192.168.56.31 -c 2PING 192.168.56.31 (192.168.56.31): 56 data bytes64 bytes from 192.168.56.31: seq=0 ttl=64 time=0.099 ms64 bytes from 192.168.56.31: seq=1 ttl=64 time=0.188 ms--- 192.168.56.31 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.099/0.143/0.188 ms\n\n3ã€ä¸»æœº2-&gt;ä¸»æœº1 ï¼ˆé€šï¼‰\n[root@centos-4-5 ~]# ping 192.168.56.3 -c 2PING 192.168.56.3 (192.168.56.3) 56(84) bytes of data.64 bytes from 192.168.56.3: icmp_seq=1 ttl=64 time=0.478 ms64 bytes from 192.168.56.3: icmp_seq=2 ttl=64 time=0.551 ms--- 192.168.56.3 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1064msrtt min/avg/max/mdev = 0.478/0.514/0.551/0.042 ms\n\n4ã€ä¸»æœº2å®¹å™¨2-&gt; ä¸»æœº1 ï¼ˆé€šï¼‰\n/ # ping 192.168.56.3 -c 2PING 192.168.56.3 (192.168.56.3): 56 data bytes64 bytes from 192.168.56.3: seq=0 ttl=64 time=0.469 ms64 bytes from 192.168.56.3: seq=1 ttl=64 time=0.605 ms--- 192.168.56.3 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.469/0.537/0.605 ms\n\n5ã€ä¸»æœº2å®¹å™¨2-2-&gt;ä¸»æœº1å®¹å™¨1-2 ï¼ˆé€šï¼‰\n/ # ping 192.168.56.32 -c 2PING 192.168.56.32 (192.168.56.32): 56 data bytes64 bytes from 192.168.56.32: seq=0 ttl=64 time=0.569 ms64 bytes from 192.168.56.32: seq=1 ttl=64 time=0.687 ms--- 192.168.56.32 ping statistics ---2 packets transmitted, 2 packets received, 0% packet lossround-trip min/avg/max = 0.569/0.628/0.687 ms\n\n6ã€ä¸»æœº2 -&gt; ä¸»æœº1å®¹å™¨1-2 ï¼ˆé€šï¼‰\n[root@centos-4-5 ~]# ping 192.168.56.32 -c 2PING 192.168.56.32 (192.168.56.32) 56(84) bytes of data.64 bytes from 192.168.56.32: icmp_seq=1 ttl=64 time=0.321 ms64 bytes from 192.168.56.32: icmp_seq=2 ttl=64 time=0.609 ms--- 192.168.56.32 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1022msrtt min/avg/max/mdev = 0.321/0.465/0.609/0.144 ms\n\næ€»ç»“\næ”¯æŒè·¨ä¸»æœºé—´å®¹å™¨é€šä¿¡(ä¾èµ–äºå®¿ä¸»æœºä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå…¶å®åªè¦åœ¨ä¸€ä¸ªå­ç½‘ä¸‹å³å¯)\nä¸æ”¯æŒå•æœºå†…çš„å®¿ä¸»æœºå®¹å™¨é—´çš„é€šä¿¡\n\n3ã€å‚è€ƒæ–‡ç« linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼š macvlan\nDocker è·¨ä¸»æœºå®¹å™¨é—´ç½‘ç»œé€šä¿¡ï¼ˆä¸€ï¼‰\nDockerç³»åˆ—ï¼ˆåä¸‰ï¼‰ï¼šDocker è·¨ä¸»æœºå®¹å™¨é—´ç½‘ç»œé€šä¿¡ï¼ˆäºŒï¼‰\nDockerç³»åˆ—ï¼ˆåå››ï¼‰ï¼šDocker Swarmé›†ç¾¤\n å®¹å™¨ç½‘ç»œï¼šç›˜ç‚¹ï¼Œè§£é‡Šä¸åˆ†æ\nMacvlanä¸ipvlan\n","categories":["äº‘åŸç”Ÿ"],"tags":["Docker","ç½‘ç»œ"]},{"title":"C++ ç»§æ‰¿çš„åº•å±‚è®¾è®¡ä¸åŸç†","url":"/2023/09/16/91c61c1043b15978e6cca833236c4694/","content":"C++ ä½œä¸ºé¢å‘å¯¹è±¡è¯­è¨€ï¼Œå…¶æ¬¡é¢å‘å¯¹è±¡è¯­è¨€çš„é‡è¦ç‰¹æ€§å°è£…ã€ç»§æ‰¿ã€å¤šæ€ï¼Œæ‰€ä»¥ç†è§£ç»§æ‰¿åº•å±‚è®¾è®¡å¯¹äºæˆ‘ä»¬å­¦ä¹ C++æ˜¯éå¸¸é‡è¦çš„ï¼Œå…¶æ¬¡ä»–æ˜¯C++çš„çµé­‚æ‰€åœ¨ï¼Œæœ¬äººä¹Ÿæ˜¯èµ°äº†äº›å¼¯è·¯æ‰€ä»¥æ‰“ç®—æ·±åº¦å­¦ä¹ ä¸€ä¸‹ï¼\n\n\nç¯å¢ƒ\nGCC  8.3.0ï¼ˆæœ¬äººçš„è¿è¡Œç¯å¢ƒï¼‰ \n\n\ngccå¼€å‘é€‰é¡¹ï¼š https://gcc.gnu.org/onlinedocs/gcc/Developer-Options.html\n\n# æŸ¥çœ‹classçš„ç»“æ„ä¿¡æ¯ï¼ˆDump class hierarchy informationï¼‰g++ -std=c++17 -O0 -fdump-lang-class main.cpp# ç¼–è¯‘  g++ -std=c++17 -O0 main.cpp -o main\n\n\nClang 13.0.0\n\n# æŸ¥çœ‹classçš„ç»“æ„ä¿¡æ¯clang++ -std=c++17 -O0 -c main.cpp -Xclang -fdump-vtable-layouts\n\nè™šè¡¨C++çš„è™šå‡½æ•°åº•å±‚å®ç°ä¸Šé‡‡ç”¨çš„éƒ½æ˜¯è™šè¡¨(virtual table)ï¼Œè™šè¡¨ä¸­ä¼šæŠŠè™šå‡½æ•°çœŸå®çš„å‡½æ•°åœ°å€è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿å‡½æ•°è°ƒç”¨ç›´æ¥ä½¿ç”¨ï¼Œå› æ­¤è™šå‡½æ•°çš„æ€§èƒ½ä¼šç•¥å·®ä¸€ä¸‹å› ä¸ºå¤šäº†ä¸€æ¬¡å¯»å€ï¼  æ³¨æ„: è¿™ä¸ªåªæ˜¯å¤§éƒ¨åˆ†ç¼–è¯‘å™¨çš„å®ç°ï¼Œä¾‹å¦‚GCCï¼\nä¾‹å¦‚ä¸‹é¢ä¾‹å­TestAå®šä¹‰äº†è™šå‡½æ•°foo1ï¼Œé‚£ä¹ˆTestAä¼šç”Ÿæˆä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œå…¶ä¸­å®šä¹‰äº† foo1 æŒ‡å‘ TestA::foo1 ï¼Œ å…¶ä¸­TestBç»§æ‰¿è‡ªAå®ƒä¼šç»§æ‰¿Açš„è™šå‡½æ•°è¡¨ï¼Œå¦‚æœé‡å†™ä¼šè¦†ç›–é‡å†™çš„å‡½æ•°ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­Bçš„è™šå‡½æ•°è¡¨ä¸­å®šä¹‰äº†ä¸€ä¸ª foo1 æŒ‡å‘ TestA::foo1 ï¼ŒTestCç»§æ‰¿äº†TestBï¼Œé‡å†™äº†foo1æ–¹æ³•ï¼Œå› æ­¤TestCçš„è™šè¡¨ä¸­å˜æˆäº†TestC::foo1 ã€‚\n#include &lt;iostream&gt;struct TestA &#123;    virtual void foo1() &#123;        std::cout &lt;&lt; &quot;TestA.foo1\\n&quot;;    &#125;&#125;;struct TestB : virtual TestA &#123;&#125;;struct TestC : virtual TestB &#123;    void foo1() &#123;        std::cout &lt;&lt; &quot;TestC.foo1\\n&quot;;    &#125;&#125;;int main() &#123;    TestA *ab = new TestB();    ab-&gt;foo1(); // ä¼šæŸ¥æ‰¾TestBè™šè¡¨ä¸­foo1å‡½æ•°åœ°å€(ä»£ç æ®µåœ°å€)ï¼Œå‘ç°foo1ä¸ºTestA::foo1ï¼Œæœ€ç»ˆæ‰§è¡Œè¾“å‡ºTestA.foo1    TestA *ac = new TestC();    ac-&gt;foo1();  // ä¼šæŸ¥æ‰¾TestCè™šè¡¨ä¸­foo1å‡½æ•°åœ°å€(ä»£ç æ®µåœ°å€)ï¼Œå‘ç°foo1ä¸ºTestC::foo1ï¼Œæœ€ç»ˆæ‰§è¡Œè¾“å‡ºTestC.foo1&#125;\n\nè™šè¡¨æ˜¯C++å…ƒä¿¡æ¯çš„ä½“ç°ï¼Œå®ƒè®°å½•äº†è™šå‡½æ•°çš„å‡½æ•°åœ°å€ï¼Œä½†æ˜¯C++æœ¬è´¨ä¸Šå¹¶ä¸ä¼šä¸ºruntimeé˜¶æ®µæä¾›ç±»å‹çš„å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚ç±»å‹çš„å­—æ®µã€å‡½æ•°ä¿¡æ¯ç­‰ï¼Œæ‰€ä»¥C++ä¸æ”¯æŒåå°„ã€‚ä½†æ˜¯c++æ˜¯ä¸€ä¸ªç›´æ¥é¢å‘å†…å­˜çš„è¯­è¨€ï¼Œåªè¦æ‹¿åˆ°äº†å†…å­˜ä»€ä¹ˆè¯­æ³•é™åˆ¶(private?const?)éƒ½ä¸å­˜åœ¨äº†ã€‚\nè™šå‡½æ•°è™šå‡½æ•°æ˜¯ç»§æ‰¿çš„æ ¸å¿ƒï¼Œæ´¾ç”Ÿç±»å…è®¸é‡å†™çˆ¶ç±»çš„è™šå‡½æ•°ï¼Œè¿›è€Œå®ç°å¤šæ€ï¼\nä»£ç ç¤ºä¾‹ï¼š https://godbolt.org/z/TEEsYra7f  æˆ–è€…  https://coliru.stacked-crooked.com/a/9895523dd69257b6\nå•ç»§æ‰¿#include &lt;iostream&gt;struct TestA &#123;    virtual void foo1() &#123;        std::cout &lt;&lt; &quot;TestA.foo1\\n&quot;;    &#125;    virtual void foo2() &#123;        std::cout &lt;&lt; &quot;TestA.foo2\\n&quot;;    &#125;    void foo3() &#123;        std::cout &lt;&lt; &quot;TestA.foo3\\n&quot;;    &#125;    long arr[3];&#125;;struct TestB : TestA &#123;    virtual void foo1() &#123;        std::cout &lt;&lt; &quot;TestB.foo1\\n&quot;;    &#125;    virtual void foo3() &#123;        std::cout &lt;&lt; &quot;TestB.foo3\\n&quot;;    &#125;    long arr[3];&#125;;struct TestC : TestB &#123;    virtual void foo4() &#123;        std::cout &lt;&lt; &quot;TestC.foo4\\n&quot;;    &#125;&#125;;// ç†è§£è¿™ä¸ªéœ€è¦ç†è§£ è™šå‡½æ•°ç»§æ‰¿çš„å®ç°æ–¹å¼å’Œç±»å¯¹è±¡çš„å†…å­˜ç»“æ„struct TestAMemory &#123;    struct TestATable &#123;        void (*foo1)(); // æŒ‡å‘ TestA.foo1 å‡½æ•° (offset=16)        void (*foo2)(); // æŒ‡å‘ TestA.foo2 å‡½æ•°    &#125;;    TestATable *vptr;    long arr[3];&#125;;// æ™®é€šç»§æ‰¿çš„å†…å­˜ç»“æ„// ä¼˜å…ˆå®šä¹‰åŸºç±»ï¼Œå†å®šä¹‰æ´¾ç”Ÿç±»struct TestBMemory &#123;    struct TestBTable &#123;        void (*foo1)(); // æŒ‡å‘ TestB.foo1 å‡½æ•° (offset=16)        void (*foo2)(); // æŒ‡å‘ TestA.foo2 å‡½æ•° (è¿™é‡Œå¯ä»¥çœ‹åˆ°è™šè¡¨ä¼šæ‹·è´åŸºç±»å…¨éƒ¨çš„è™šå‡½æ•°ï¼Œä¸ç®¡æ˜¯å¦é‡å†™)        void (*foo3)(); // æŒ‡å‘ TestB.foo3 å‡½æ•° (æ·»åŠ è‡ªå·±çš„è™šå‡½æ•°)    &#125;;    TestBTable *vptr;    // TestA.arr    long arra[3];    // TestB.arr    long arrb[3];&#125;;int main() &#123;    TestA *a = new TestB();    a-&gt;foo1(); // TestB.foo1    a-&gt;foo2(); // TestA.foo2    a-&gt;foo3(); // TestA.foo3    ((TestB *)a)-&gt;foo1(); // TestB.foo1    ((TestB *)a)-&gt;foo2(); // TestA.foo2    ((TestB *)a)-&gt;foo3(); // TestB.foo3    // TestBçš„å†…å­˜ç»“æ„ï¼Œè¿™ä¸ªå‚è€ƒå°±è¡Œäº† ... (å®é™…ä¸ŠTestBæˆå‘˜å‡½æ•°åœ°å€æ‹¿ä¸åˆ°çš„ï¼Œå› ä¸ºä»–æ˜¯ç¼–è¯‘ä¿¡æ¯.)    TestBMemory *bb = (TestBMemory *)(a);    bb-&gt;vptr-&gt;foo1(); // TestB.foo1    bb-&gt;vptr-&gt;foo2(); // TestA.foo2    bb-&gt;vptr-&gt;foo3(); // TestB.foo3    // ä¿®æ”¹æˆå‘˜å˜é‡    bb-&gt;arra[0] = 111;    bb-&gt;arrb[0] = 222;    // å½“åŸºç±»å’Œæ´¾ç”Ÿç±»å®šä¹‰ç±»ç›¸åŒçš„å­—æ®µ/å‡½æ•°ï¼Œé‚£ä¹ˆä¸»è¦æ˜¯çœ‹å½“å‰æŒ‡é’ˆçš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œç±»å‹æ˜¯åŸºç±»é‚£ä¹ˆå°±æ˜¯åŸºç±»çš„å‡½æ•°ï¼Œå¦åˆ™æ´¾ç”Ÿç±»çš„å‡½æ•°    std::cout &lt;&lt; &quot;(TestA)arr[0]: &quot; &lt;&lt; a-&gt;arr[0] &lt;&lt; &quot;\\n&quot;;            // (TestA)arr[0]: 111    std::cout &lt;&lt; &quot;(TestB)arr[0]: &quot; &lt;&lt; ((TestB *)a)-&gt;arr[0] &lt;&lt; &quot;\\n&quot;; // (TestB)arr[0]: 222    // åŒä¸Š    TestAMemory *aa = (TestAMemory *)(new TestA());    aa-&gt;vptr-&gt;foo1(); // TestA.foo1    aa-&gt;vptr-&gt;foo2(); // TestA.foo2&#125;\n\né‚£ä¹ˆå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ å¯ä»¥é€šè¿‡ g++ -O0 -fdump-lang-class main.cpp   dump ç±»ä¿¡æ¯\nVtable for TestATestA::_ZTV5TestA: 4 entries0     (int (*)(...))08     (int (*)(...))(&amp; _ZTI5TestA)16    (int (*)(...))TestA::foo124    (int (*)(...))TestA::foo2Class TestA   size=32 align=8 // TestA size = 32 = 8(vptr:TestA) + 24 (arr)   base size=32 base align=8TestA (0x0x7fdde31d2960) 0    vptr=((&amp; TestA::_ZTV5TestA) + 16) // è¡¨ç¤ºvtprçš„æŒ‡å‘ï¼ŒæŒ‡å‘ (TestA::_ZTV5TestA addr +16), å³TestA::foo1å‡½æ•°åœ°å€.  Vtable for TestBTestB::_ZTV5TestB: 5 entries0     (int (*)(...))08     (int (*)(...))(&amp; _ZTI5TestB)16    (int (*)(...))TestB::foo1 // é‡å†™åŸºç±»è™šå‡½æ•°24    (int (*)(...))TestA::foo2 // è¿™é‡Œæ³¨æ„ä¸‹. ä¼šæŠŠæœªé‡å†™åŸºç±»çš„copyè¿‡æ¥32    (int (*)(...))TestB::foo3 // æ·»åŠ è‡ªå·±å®šä¹‰çš„è™šå‡½æ•°Class TestB   size=56 align=8   base size=56 base align=8 // size = 56 = 8(vptr:TestB) + 24(a.arr) + 24(b.arr) TestB (0x0x7fdde322d068) 0    vptr=((&amp; TestB::_ZTV5TestB) + 16) // åŒä¸Š  TestA (0x0x7fdde31d2de0) 0      primary-for TestB (0x0x7fdde322d068) //  primary-for TestB è¡¨ç¤ºç»§æ‰¿å…³ç³»ï¼Œå¤šç»§æ‰¿éœ€è¦çœ‹è¿™ä¸ªå­—æ®µVtable for TestCTestC::_ZTV5TestC: 6 entries0     (int (*)(...))08     (int (*)(...))(&amp; _ZTI5TestC)16    (int (*)(...))TestB::foo124    (int (*)(...))TestA::foo232    (int (*)(...))TestB::foo340    (int (*)(...))TestC::foo4 // å¯ä»¥çœ‹åˆ°ç›´æ¥copyçš„åŸºç±»çš„å…¨éƒ¨è™šå‡½æ•°+è‡ªå·±å®šä¹‰çš„è™šå‡½æ•°Class TestC // c -&gt; b -&gt; a   size=56 align=8 // size = 8(vptr:TestC) + 24(a.arr) + 24(b.arr)   base size=56 base align=8TestC (0x0x7f639bfee680) 0    vptr=((&amp; TestC::_ZTV5TestC) + 16)  TestB (0x0x7f639bfee6e8) 0      primary-for TestC (0x0x7f639bfee680)    TestA (0x0x7f639bfd7780) 0        primary-for TestB (0x0x7f639bfee6e8)\n\næ€»ç»“ï¼š\n\nå¯ä»¥å‘ç°å½“å®šä¹‰äº†è™šå‡½æ•°é‚£ä¹ˆæ­¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œè™šå‡½è¡¨è®°å½•äº†è™šå‡½æ•°çš„å‡½æ•°åœ°å€ï¼Œä¾‹å¦‚ TestA å†…éƒ¨ä¼šå®šä¹‰ä¸€ä¸ª vptr æŒ‡å‘ Vtable for TestA  + 16 ï¼Œå³ (int (*)(...))TestA::foo1  å‡½æ•°å¼€å§‹\n\nTestB ç»§æ‰¿äº† TestAï¼ŒTestBå†…éƒ¨ä¹Ÿå®šä¹‰äº†ä¸€ä¸ª vptr æŒ‡å‘ Vtable for TestB  , å®šä¹‰äº†å…¶ç”³æ˜çš„è™šå‡½æ•°\n\nTestC ç»§æ‰¿ TestB ï¼Œæ­¤æ—¶ä¹Ÿåªä¼šæœ‰ä¸€ä»½vptræŒ‡å‘ vtable testc \n\nå•ç»§æ‰¿ä»…ä¼šæœ‰ä¸€ä¸ª vptr ï¼ŒæŒ‡å‘å…¶è‡ªå·±çš„ vtable\n\n\nå¤šç»§æ‰¿C++æ˜¯æ”¯æŒå¤šç»§æ‰¿çš„ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸Javaç­‰è¯­è¨€çš„åŒºåˆ«ï¼ˆC++ä¸æ”¯æŒæ¥å£Interfaceï¼‰ï¼Œå…¶æ¬¡å¤šç»§æ‰¿ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚æ¶‰åŠåˆ°äº¤å‰/è±å½¢ç»§æ‰¿çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹C++æ˜¯ç¬¦åˆå®ç°å¤šç»§æ‰¿çš„ï¼\nç»§ç»­ä¸Šé¢é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªç»“æ„ä½“ï¼Œ D ç»§æ‰¿è‡ªA/B/C\nstruct TestD : TestA, TestB, TestC &#123;    void foo1() &#123;        std::cout &lt;&lt; &quot;TestD.foo1\\n&quot;;    &#125;&#125;;// ç»§æ‰¿å…³ç³»/å¤šç»§æ‰¿/è±å½¢ç»§æ‰¿// D -&gt; A//   -&gt; B -&gt; A//   -&gt; C -&gt; B -&gt; A\n\næ­¤æ—¶è™šè¡¨ä¸ºå¦‚ä¸‹:\nVtable for TestDTestD::_ZTV5TestD: 15 entries0     (int (*)(...))08     (int (*)(...))(&amp; _ZTI5TestD)16    (int (*)(...))TestD::foo1 // vptr(TestD/TestA)24    (int (*)(...))TestA::foo232    (int (*)(...))-3240    (int (*)(...))(&amp; _ZTI5TestD)48    (int (*)(...))TestD::_ZThn32_N5TestD4foo1Ev // vptr(TestB) TestD::foo156    (int (*)(...))TestA::foo264    (int (*)(...))TestB::foo372    (int (*)(...))-8880    (int (*)(...))(&amp; _ZTI5TestD)88    (int (*)(...))TestD::_ZThn88_N5TestD4foo1Ev //vptr(TestC) TestD::foo196    (int (*)(...))TestA::foo2104   (int (*)(...))TestB::foo3112   (int (*)(...))TestC::foo4Class TestD   size=144 align=8 // size = 144 = vptr(TestD) + a.arr + vptr(TestB) + (a.arr,b.arr) + vptr(TestC) + (a.arr, b.arr)    base size=144 base align=8TestD (0x0x7efe8ac38d98) 0 //  vptr(TestD)åç§»é‡ä¸º0    vptr=((&amp; TestD::_ZTV5TestD) + 16)  TestA (0x0x7efe8acbe840) 0  // d::aå†…å­˜      primary-for TestD (0x0x7efe8ac38d98)  TestB (0x0x7efe8acd5750) 32 // vptr(TestB)åç§»é‡32      vptr=((&amp; TestD::_ZTV5TestD) + 48)    TestA (0x0x7efe8acbe8a0) 32 // b::a å†…å­˜        primary-for TestB (0x0x7efe8acd5750)  TestC (0x0x7efe8acd57b8) 88 // vptr(TestC)åç§»é‡88      vptr=((&amp; TestD::_ZTV5TestD) + 88)    TestB (0x0x7efe8acd5820) 88 // c::b å†…å­˜        primary-for TestC (0x0x7efe8acd57b8)      TestA (0x0x7efe8acbe900) 88 // c::a å†…å­˜          primary-for TestB (0x0x7efe8acd5820)\n\n\nTestD äº¤å‰ç»§æ‰¿é€ æˆç»“æ„çš„å¤§å°å‡çº§åˆ°äº† 144 ï¼Œå¯¼è‡´ Aå†—ä½™äº†2ä»½ï¼ŒB å†—ä½™äº†1ä»½ ï¼Œæ˜¯ä¸æ˜¯å‘ç°é—®é¢˜äº†ï¼Œè¿™ä¹ˆç»§æ‰¿çš„è¯é‡åˆ°é‡å¤ç»§æ‰¿åŸºç±»å¯¼è‡´å†…å­˜ä¼šæˆå€çš„å¢åŠ ï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Œä¸‹æ–‡ä¼šä»‹ç»åˆ°ï¼\nå¤šç»§æ‰¿ä¼šä¸ºæ¯ä¸ªåŸºç±»åˆ†é…ä¸€ä¸ª vptr æŒ‡é’ˆï¼\nvptr(TestD) åç§»é‡ 0\nvptr(TestB) åç§»é‡ 32\nvptr(TestC) åç§»é‡ 88\n\n\nå¤šç»§æ‰¿å½“æ¶‰åŠåˆ°ç±»å‹è½¬æ¢çš„æ—¶å€™(å‘ä¸Š/å‘ä¸‹)ç±»å‹è½¬æ¢çš„æ—¶å€™ä¼šæ¶‰åŠåˆ°æŒ‡é’ˆçš„ç§»åŠ¨(ä¸‹æ–‡ä¼šé™åˆ°)ï¼Œå…·ä½“çš„ç§»åŠ¨åç§»é‡å¯ä»¥å‚è€ƒä¸Šé¢çš„class dumpï¼Œå‘ä¸‹è½¬å‹éœ€è¦ä½¿ç”¨ dynamic_cast !   ä½†æ˜¯ä¸Šé¢çš„ä¾‹å­å¤šç±»å‹è½¬æ¢çš„æ—¶å€™ä¼šå­˜åœ¨äºŒä¹‰æ€§ï¼Œä¾‹å¦‚Då‘ä¸Šæ¢æˆAï¼Œä¼šå‘ç°Aå†…å­˜ä¸­æœ‰3ä»½åˆ°ä½æ˜¯å“ªä¸ªï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸ä¼šè®©ä½ è½¬æ¢ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…å­˜è¿›è¡Œéå®‰å…¨è½¬æ¢ï¼ï¼\nå¯ä»¥ç»“åˆä¸‹é¢è¿™ä¸ªä»£ç çœ‹ä¸‹\n\ntypedef void (*VoidFunc)();VoidFunc GetVoidFunc(void *ptr, int offset) &#123;    long *pptr = (long *)ptr;    long *table = (long *)(*pptr);    long *func = table + offset;    return (VoidFunc)(*func);&#125;// struct TestD : TestA, TestB, TestC &#123;&#125;// TestD = vptr(TestA) + a.arr + vptr(TestB) + (a.arr,b.arr) + vptr(TestC) + (a.arr, b.arr) = 144int main() &#123;    // å¤šç»§æ‰¿vpträ¼šæœ‰åç§»é‡    TestD d;    // vptråç§»é‡0 (TestD)    GetVoidFunc(&amp;d, 0)(); // TestD::foo1    GetVoidFunc(&amp;d, 1)(); // TestA::foo2    // vptråç§»é‡32(åŸºç±»ä¸ºTestB)    GetVoidFunc(((long *)&amp;d) + 4, 0)(); // TestD.foo1    GetVoidFunc(((long *)&amp;d) + 4, 1)(); // TestA.foo2    GetVoidFunc(((long *)&amp;d) + 4, 2)(); // TestB.foo3    // vptråç§»é‡88(åŸºç±»ä¸ºTestC)    GetVoidFunc(((long *)&amp;d) + 11, 0)(); // TestD.foo1    GetVoidFunc(((long *)&amp;d) + 11, 1)(); // TestA.foo2    GetVoidFunc(((long *)&amp;d) + 11, 2)(); // TestB.foo3    GetVoidFunc(((long *)&amp;d) + 11, 3)(); // TestC.foo4&#125;\n\nè™šç»§æ‰¿ä»£ç ç¤ºä¾‹ï¼š https://godbolt.org/z/rxeza5EEa æˆ–è€…  https://coliru.stacked-crooked.com/a/44776e393808d238\n#include &lt;iostream&gt;struct TestA &#123;    virtual void foo1() &#123;        std::cout &lt;&lt; &quot;TestA.foo1\\n&quot;;    &#125;    virtual void foo2() &#123;        std::cout &lt;&lt; &quot;TestA.foo2\\n&quot;;    &#125;    void foo3() &#123;        std::cout &lt;&lt; &quot;TestA.foo3\\n&quot;;    &#125;    long arr[3];&#125;;struct TestB : virtual TestA &#123;    virtual void foo1() &#123;        std::cout &lt;&lt; &quot;TestB.foo1\\n&quot;;    &#125;    void foo2() &#123;        std::cout &lt;&lt; &quot;TestB.foo2\\n&quot;;    &#125;    virtual void foo3() &#123;        std::cout &lt;&lt; &quot;TestB.foo3\\n&quot;;    &#125;    long arr[3];&#125;;struct TestC : virtual TestB &#123;    virtual void foo4() &#123;        std::cout &lt;&lt; &quot;TestC.foo4\\n&quot;;    &#125;&#125;;struct TestD : virtual TestB &#123;    virtual void foo4() &#123;        std::cout &lt;&lt; &quot;TestC.foo4\\n&quot;;    &#125;&#125;;// TestE ç»§æ‰¿å…³ç³»//       -&gt; C//   -&gt;        -&gt; B// E                -&gt; A//    -&gt;       -&gt; B//       -&gt; Dstruct TestE : virtual TestC, virtual TestD &#123;    void foo1() &#123;        std::cout &lt;&lt; &quot;TestD.foo1\\n&quot;;    &#125;&#125;;typedef void (*VoidFunc)();VoidFunc GetVoidFunc(void *ptr, int offset) &#123;    long *pptr = (long *)ptr;    long *table = (long *)(*pptr);    long *func = table + offset;    return (VoidFunc)(*func);&#125;VoidFunc GetVoidFunc(void *ptr, int size, int offset) &#123;    long *pptr = ((long *)ptr) + size; // æŒ‡é’ˆåç§»    long *table = (long *)(*pptr);    long *func = table + offset; // vtable åç§»    return (VoidFunc)(*func);&#125;// https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class// 72int main() &#123;    // (TestC)vptr + (TestB)vptr + 24 + (TestA)vptr + 24    TestC *c = new TestC();    GetVoidFunc(c, 0, 0)(); // TestC.foo4    GetVoidFunc(c, 1, 0)(); // TestB::foo1    GetVoidFunc(c, 1, 1)(); // TestB::foo2    GetVoidFunc(c, 1, 2)(); // TestB::foo3    GetVoidFunc(c, 5, 0)(); // TestB.foo1    GetVoidFunc(c, 5, 1)(); // TestB.foo2    // å †æ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€    // å¼ºåˆ¶ç±»å‹è½¬æ¢ä¼šç§»åŠ¨å‡½æ•°æŒ‡é’ˆ    TestB *b = c;    // åç§»é‡ä¸º8: 1ä¸ªå­—èŠ‚ = vptr(TestC)    std::cout &lt;&lt; ((long)b - (long)c) &lt;&lt; std::endl;    TestA *a = c;    // åç§»é‡ä¸º40: 5ä¸ªå­—èŠ‚ = vptr(TestC) + vptr(TestB) + 24    std::cout &lt;&lt; ((long)a - (long)c) &lt;&lt; std::endl;    TestE *d = new TestE(); // vptr(TestC) + vptr(TestB) + 24 + vptr(TestA) + 24 + vptr(TestD)    GetVoidFunc(d, 9, 0)(); // TestD::foo4    std::cout &lt;&lt; &quot;size: &quot; &lt;&lt; sizeof(TestA) &lt;&lt; &quot;\\n&quot;; // 32 = vptr(TestA) + 24    std::cout &lt;&lt; &quot;size: &quot; &lt;&lt; sizeof(TestB) &lt;&lt; &quot;\\n&quot;; // 64 = vptr(TestB) + 24 + vptr(TestA) + 24    std::cout &lt;&lt; &quot;size: &quot; &lt;&lt; sizeof(TestC) &lt;&lt; &quot;\\n&quot;; // 72 = vptr(TestC) + vptr(TestB) + 24 + vptr(TestA) + 24    std::cout &lt;&lt; &quot;size: &quot; &lt;&lt; sizeof(TestD) &lt;&lt; &quot;\\n&quot;; // 72 = vptr(TestD) + vptr(TestB) + 24 + vptr(TestA) + 24    std::cout &lt;&lt; &quot;size: &quot; &lt;&lt; sizeof(TestE) &lt;&lt; &quot;\\n&quot;; // 80 = vptr(TestE) + vptr(TestB) + 24 + vptr(TestA) + 24 + vptr(TestD)&#125;\n\n\nè™šç»§æ‰¿åå†…å­˜ä»…éœ€ 72ï¼Œåªéœ€è¦ç»´æŠ¤åŸºç±»çš„vptr å’Œ åŸºç±»åˆ†é…çš„å†…å­˜å³å¯ï¼Œæ‰€ä»¥è™šç»§æ‰¿å¯ä»¥æå¤§çš„é™ä½å†…å­˜å¼€é”€ï¼\nè™šç»§æ‰¿åå†…å­˜ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä»½åŸºç±»çš„å†…å­˜(åŒ…å«å¤šå±‚å¼•ç”¨)ï¼Œå…·ä½“çš„å†…å­˜é€»è¾‘å›¾å¯ä»¥é€šè¿‡ dump classæŸ¥çœ‹\nå¤šç»§æ‰¿å½“è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢æ—¶ä¼šé€šè¿‡ç§»åŠ¨æŒ‡é’ˆå®ç°ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢ä¾‹å­ï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€äº›caseï¼Œæ¯”å¦‚TestEä¸­ TestEä¼šå’ŒTestCçš„åœ°å€ä¸€æ ·ï¼ŒåŸå› å¾ˆç®€å•å°±æ˜¯ä¸¤è€…åœ¨virtual tableä¸­å‡½æ•°ç”³æ˜éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æ²¡å¿…è¦å†åˆ†é…ä¸€ä»½å†…å­˜äº†ï¼ˆè¿™ä¸ªå±äºGCCçš„ä¼˜åŒ–å§ï¼‰ï¼\n\nint main()&#123;  TestE *ee = new TestE(); // vptr(TestE/TestC) + vptr(TestB) + 24 + vptr(TestA) + 24 + vptr(TestD)  TestC *cc = ee;  TestD *dd = ee;  TestB *bb = ee;  TestA *aa = ee;  std::cout &lt;&lt; std::hex &lt;&lt; ee &lt;&lt; &quot;\\n&quot;; // 0x600002ef80f0 (offset=0)  std::cout &lt;&lt; std::hex &lt;&lt; cc &lt;&lt; &quot;\\n&quot;; // 0x600002ef80f0 (offset=0)  std::cout &lt;&lt; std::hex &lt;&lt; bb &lt;&lt; &quot;\\n&quot;; // 0x600002ef80f8 (offset=8)  std::cout &lt;&lt; std::hex &lt;&lt; aa &lt;&lt; &quot;\\n&quot;; // 0x600002ef8118 (offset=40)  std::cout &lt;&lt; std::hex &lt;&lt; dd &lt;&lt; &quot;\\n&quot;; // 0x600002ef8138 (offset=72)&#125;\n\n\nè™šç»§æ‰¿è¡¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ è¿™é‡Œä»¥ TestC ä¸ºä¾‹å­\n\n# TestB    Vtable for TestBTestB::_ZTV5TestB: 12 entries0     328     (int (*)(...))016    (int (*)(...))(&amp; _ZTI5TestB)24    (int (*)(...))TestB::foo132    (int (*)(...))TestB::foo240    (int (*)(...))TestB::foo348    1844674407370955158456    1844674407370955158464    (int (*)(...))-3272    (int (*)(...))(&amp; _ZTI5TestB)80    (int (*)(...))TestB::_ZTv0_n24_N5TestB4foo1Ev88    (int (*)(...))TestB::_ZTv0_n32_N5TestB4foo2EvVTT for TestBTestB::_ZTT5TestB: 2 entries0     ((&amp; TestB::_ZTV5TestB) + 24)8     ((&amp; TestB::_ZTV5TestB) + 80)Class TestB   size=64 align=8   base size=32 base align=8TestB (0x0x7f779a7cc618) 0    vptridx=0 vptr=((&amp; TestB::_ZTV5TestB) + 24)  TestA (0x0x7f779a7b5660) 32 virtual      vptridx=8 vbaseoffset=-24 vptr=((&amp; TestB::_ZTV5TestB) + 80)##  TestCVtable for TestCTestC::_ZTV5TestC: 20 entries0     408     816    (int (*)(...))024    (int (*)(...))(&amp; _ZTI5TestC)32    (int (*)(...))TestC::foo440    048    056    064    3272    (int (*)(...))-880    (int (*)(...))(&amp; _ZTI5TestC)88    (int (*)(...))TestB::foo196    (int (*)(...))TestB::foo2104   (int (*)(...))TestB::foo3112   18446744073709551584120   18446744073709551584128   (int (*)(...))-40136   (int (*)(...))(&amp; _ZTI5TestC)144   (int (*)(...))TestB::_ZTv0_n24_N5TestB4foo1Ev152   (int (*)(...))TestB::_ZTv0_n32_N5TestB4foo2EvConstruction vtable for TestB in TestCTestC::_ZTC5TestC8_5TestB: 12 entries0     328     (int (*)(...))016    (int (*)(...))(&amp; _ZTI5TestB)24    (int (*)(...))TestB::foo132    (int (*)(...))TestB::foo240    (int (*)(...))TestB::foo348    1844674407370955158456    1844674407370955158464    (int (*)(...))-3272    (int (*)(...))(&amp; _ZTI5TestB)80    (int (*)(...))TestB::_ZTv0_n24_N5TestB4foo1Ev88    (int (*)(...))TestB::_ZTv0_n32_N5TestB4foo2EvVTT for TestCTestC::_ZTT5TestC: 5 entries0     ((&amp; TestC::_ZTV5TestC) + 32)8     ((&amp; TestC::_ZTV5TestC) + 88)16    ((&amp; TestC::_ZTV5TestC) + 144)24    ((&amp; TestC::_ZTC5TestC8_5TestB) + 24)32    ((&amp; TestC::_ZTC5TestC8_5TestB) + 80)Class TestC   size=72 align=8 // vptr(TestC) + vptr(TestB) + b.arr + vptr(TestA) + a.arr   base size=8 base align=8TestC (0x0x7f779a7cc750) 0 nearly-empty  ## offset=0 (TestC vptr) -&gt; 32    vptridx=0 vptr=((&amp; TestC::_ZTV5TestC) + 32)  TestB (0x0x7f779a7cc7b8) 8 virtual ## offset=8 (TestB vptr) -&gt; 88      subvttidx=24 vptridx=8 vbaseoffset=-24 vptr=((&amp; TestC::_ZTV5TestC) + 88)    TestA (0x0x7f779a7b57e0) 40 virtual ## offset=40 (TestA vptr)  -&gt; 144        vptridx=16 vbaseoffset=-32 vptr=((&amp; TestC::_ZTV5TestC) + 144)# TestEClass TestE   size=80 align=8 # 80 = vptr(TestE/TestC) + vptr(TestB) + 24 + vptr(TestA) + 24 + vptr(TestD)   base size=8 base align=8TestE (0x0x7f9b2d91d1c0) 0 nearly-empty    vptridx=0 vptr=((&amp; TestE::_ZTV5TestE) + 56)  TestC (0x0x7f9b2d91c9c0) 0 nearly-empty virtual      primary-for TestE (0x0x7f9b2d91d1c0)      subvttidx=40 vptridx=8 vbaseoffset=-48    TestB (0x0x7f9b2d91ca28) 8 virtual        subvttidx=64 vptridx=16 vbaseoffset=-24 vptr=((&amp; TestE::_ZTV5TestE) + 120)      TestA (0x0x7f9b2d905960) 40 virtual          vptridx=24 vbaseoffset=-32 vptr=((&amp; TestE::_ZTV5TestE) + 176)  TestD (0x0x7f9b2d91ca90) 72 nearly-empty virtual      subvttidx=80 vptridx=32 vbaseoffset=-56 vptr=((&amp; TestE::_ZTV5TestE) + 232)    TestB (0x0x7f9b2d91ca28) alternative-path\n\nææ„å‡½æ•°ä¸Šé¢èŠåˆ°äº†ç»§æ‰¿ï¼Œä½†æ˜¯æ²¡æœ‰èŠåˆ°å†…å­˜å›æ”¶ï¼Œæˆ‘ä»¬çŸ¥é“ä¸è®ºæ˜¯è™šç»§æ‰¿ã€æ™®é€šç»§æ‰¿ä»–çš„å†…å­˜åˆ†é…æœºåˆ¶å¤§å®¶ä¸Šé¢åº”è¯¥æ˜¯æœ‰æ‰€äº†è§£äº†ï¼Œä½†æ˜¯å¯¹äºå†…å­˜å›æ”¶æ²¡è°ˆåˆ°ï¼ŒC++ä½œä¸ºä¸€ä¸ªéGCè¯­è¨€éœ€è¦æ‰‹åŠ¨å›æ”¶ã€‚ææ„å‡½æ•°ä½¿ç”¨è™šå‡½æ•°å®Œç¾çš„è§£å†³äº†å†…å­˜å›æ”¶ï¼Œé‚£ä¹ˆå…·ä½“æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ\næ³¨æ„ï¼šæŠ½è±¡ç±»ä¸€å®šè¦ä¸ºæŠŠææ„å‡½æ•°å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Œå¦åˆ™ç³»ç»Ÿä¸ä¼šå›æ”¶ï¼\n#include &lt;iostream&gt;struct TestA &#123;    virtual ~TestA() &#123;        std::cout &lt;&lt; &quot;~TestA()\\n&quot;;    &#125;&#125;;struct TestB : virtual TestA &#123;    ~TestB() override &#123;        std::cout &lt;&lt; &quot;~TestB()\\n&quot;;    &#125;&#125;;struct TestC : virtual TestA &#123;    ~TestC() override &#123;        std::cout &lt;&lt; &quot;~TestC()\\n&quot;;    &#125;&#125;;struct TestD : virtual TestB, virtual TestC &#123;    ~TestD() override &#123;        std::cout &lt;&lt; &quot;~TestD()\\n&quot;;    &#125;&#125;;int main() &#123;    TestA *a = new TestD();    delete a;&#125;// ~TestD()// ~TestC()// ~TestB()// ~TestA()\n\nè¿˜æœ‰ä¸€ä¸ªcaseå¤§å®¶æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ï¼Œå°±æ˜¯å¤šç»§æ‰¿ç±»å‹è½¬æ¢ä¼šæ¶‰åŠåˆ°æŒ‡é’ˆç§»åŠ¨ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰è™šç»§æ‰¿å¾ˆå¯èƒ½ä¼šå‡ºç°  pointer being freed was not allocated:   https://zhuanlan.zhihu.com/p/26392392 ã€‚ æˆ‘ç›¸ä¿¡é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ å¯¹äºè¿™ä¸ªé—®é¢˜åº”è¯¥å¤§å®¶ä¹Ÿèƒ½çŸ¥é“ä¸ºå•¥ä¼šæŠ¥é”™ï¼\næˆ–è€…è¿˜æœ‰ä¸€ç§å°±æ˜¯æŠŠæ„é€ (åŒ…å«ææ„)å‡½æ•°è®¾ç½®ä¸ºprotectedé˜²æ­¢å‘ä¸Šè½¬å‹åè°ƒç”¨ææ„å‡½æ•°ï¼Œè¿™ä¹ˆçš„è¯ç”±æ´¾ç”Ÿç±»å»ææ„å°±ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä»£ç ä¾‹å­:  https://godbolt.org/z/d15KdT3PM ã€‚\næ€»ç»“\nåªè¦åŸºç±»å®šä¹‰äº†è™šå‡½æ•°ï¼Œå°±ä¼šæ·»åŠ åˆ°åŸºç±»çš„è™šå‡½æ•°è¡¨ä¸­ï¼Œå­ç±»é‡å†™åæ˜¯å¦æ ‡è®°ä¸ºè™šå‡½æ•°(virtualä¿®é¥°)éƒ½ä¼šæ·»åŠ åˆ°å­ç±»çš„è™šå‡½æ•°è¡¨ä¸­ï¼Œå­ç±»çš„å­ç±»ä¹Ÿæ˜¯\nä¼˜å…ˆä½¿ç”¨è™šç»§æ‰¿ï¼Œå¯ä»¥é™ä½å†…å­˜å¼€é”€\nå­ç±»ç»§æ‰¿çš„æ—¶å€™æœ€å¥½ç”¨ override ä¿®é¥°ä¸€ä¸‹å‡½æ•°é‡å†™ï¼Œæ–¹ä¾¿ä»£ç é˜…è¯»\nå¦‚æœä½ è¿™ä¸ªç±»ä¸æ¶‰åŠåˆ°ç»§æ‰¿ï¼ˆä¸æ˜¯æŠ½è±¡ç±»ï¼‰ï¼Œé‚£ä¹ˆä½ æ²¡å¿…è¦è®¾ç½®ä¸€ä¸ªè™šå‡½æ•°ï¼Œå› ä¸ºä¼šé¢å¤–åˆ†é…å†…å­˜\næŠ½è±¡ç±»ä¸€å®šè¦æŠŠææ„å‡½æ•°è®¾ç½®ä¸ºè™šå‡½æ•°ï¼Œå¦åˆ™ä¼šå­˜åœ¨å†…å­˜æ³„æ¼æˆ–è€…å†…å­˜å›æ”¶å‡ºç°ç©ºå¼•ç”¨é—®é¢˜\nå¦‚æœé‡åˆ°ç‰¹åˆ«ä¸ç†è§£çš„ï¼Œçœ‹ä¸€ä¸‹ dump class çœ‹çœ‹\nè™šè¡¨çš„è®¾è®¡æˆ–å¤šæˆ–å°‘æœ‰äº›å†—ä½™ï¼Œå› ä¸ºåœ¨æ´¾ç”Ÿç±»ä¸­è®°å½•ä¸‹æ¥å…¨éƒ¨çš„è™šå‡½æ•°çš„å‡½æ•°åœ°å€(æ˜¯å¦é‡å†™éƒ½ä¼šè®°å½•)ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç¼–è¯‘æœŸå°±å†³å®šäº†ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹æ±‡ç¼–ä»£ç å‘ç°æ•°æ®æ®µä¸­å®šä¹‰æœ‰virtual table.\nå¤šé˜…è¯»æºç ã€ä¼˜ç§€çš„å¼€æºé¡¹ç›®å¯ä»¥æŒæ¡ä¸å°‘æŠ€å·§\n\nå…¶ä»–å°ç‚¹\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ traits çš„ std::is_convertible æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œç±»å‹è½¬æ¢ï¼Œ å®è·µå¯ä»¥å‚è€ƒ std::enable_shared_from_this \nä¾‹å­ï¼šhttps://godbolt.org/z/sTzz4o9he\n\n\n\n// -std=c++17  is_convertible_v æ˜¯c17æä¾›çš„,c11å¯èƒ½å†™æ³•éº»çƒ¦ç‚¹#include &lt;iostream&gt;#include &lt;type_traits&gt;struct TestB &#123;&#125;;struct TestC : private TestB &#123;&#125;;struct TestD : TestB &#123;&#125;;template &lt;typename T&gt;typename std::enable_if&lt;std::is_convertible_v&lt;T, TestB *&gt;&gt;::type DoPrint(T t) &#123;    std::cout &lt;&lt; &quot;impl TestB*&quot; &lt;&lt; std::endl;&#125;template &lt;typename T&gt;typename std::enable_if&lt;std::is_convertible_v&lt;T, TestB&gt;&gt;::type DoPrint(T t) &#123;    std::cout &lt;&lt; &quot;impl TestB&quot; &lt;&lt; std::endl;&#125;void DoPrint(...) &#123;    std::cout &lt;&lt; &quot;not impl TestB&quot; &lt;&lt; std::endl;&#125;int main() &#123;    DoPrint(new TestD()); // impl TestB*    DoPrint(TestD&#123;&#125;); // impl TestB    DoPrint(TestC&#123;&#125;); // not impl TestB&#125;\n\n\nç»§æ‰¿æ˜¯å¯ä»¥é™å®šä½œç”¨åŸŸçš„ï¼Œç»§æ‰¿æ˜¯æ— æ³•ä½¿ç”¨åŸºç±»privateçš„æˆå‘˜çš„ï¼Œé™¤éåŸºç±»ç»™ä½ å¼€å¯friendï¼Œstructçš„è¯é»˜è®¤æ˜¯publicç»§æ‰¿ï¼Œclassé»˜è®¤æ˜¯privateç»§æ‰¿.  protectç»§æ‰¿ä¼šä½¿ç”¨ç»§æ‰¿çš„publicå±æ€§çš„æˆå‘˜å˜æˆprotectï¼Œprivateä¼šä½¿ç”¨ç»§æ‰¿çš„æˆå‘˜å˜æˆ(public&amp;protect -&gt; private)ã€‚ åŸºç±»ç”³æ˜ä¸ºfinalè¡¨ç¤ºç¦æ­¢ç»§æ‰¿ï¼Œoverrideå¯ä»¥æ˜¾ç¤ºç”³æ˜é‡å†™ï¼\n\nç»§æ‰¿æ„é€ å‡½æ•°ï¼Œå½“æˆ‘ä»¬æƒ³ç›´æ¥æœç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°éœ€è¦æ‰‹åŠ¨å†ç”³æ˜ä¸€æ¬¡!! \n\n\n// -std=c++11#include &lt;iostream&gt;struct TestB &#123;    TestB(int f1, int f2) : f1_(f1), f2_(f2) &#123;    &#125;    virtual int sum() &#123;        return f1_ + f2_;    &#125;private:    int f1_;    int f2_;&#125;;struct TestC : TestB &#123;    using TestB::TestB; // ç»§æ‰¿æ„é€ å‡½æ•°&#125;;struct TestD : TestB &#123;    // éœ€è¦æ‰‹åŠ¨ç”³æ˜ï¼Œä½¿ç”¨æ„é€ å‡½æ•°å§”æ‰˜    TestD(int f1, int f2) : TestB(f1, f2) &#123;    &#125;&#125;;int main() &#123;    TestC c = TestC(1, 2);    std::cout &lt;&lt; c.sum() &lt;&lt; std::endl;    TestD d = TestD(1, 2);    std::cout &lt;&lt; c.sum() &lt;&lt; std::endl;&#125;\n\nå‚è€ƒæ–‡ç« \nC++å¯¹è±¡æ¨¡å‹ï¼š https://www.miaoerduo.com/2023/01/19/cpp-object-model/\n\nCPP-Virtual-Tableï¼šhttps://leimao.github.io/blog/CPP-Virtual-Table-Table/\n\nC++ä¸­çš„deleting destructorï¼šhttps://zhuanlan.zhihu.com/p/26392392\n\n\n","categories":["C++"],"tags":["C++","é¢å‘å¯¹è±¡"]},{"title":"tcpdump","url":"/2021/03/29/a22db6b9984d48fcdf4adcc9ff16c659/","content":"â€‹        ä½¿ç”¨tcpdump + wireshark å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬è§£å†³çº¿ä¸ŠæŠ“åŒ…é—®é¢˜ï¼è¿™é‡ŒåŒæ—¶ä¹Ÿæ¨èä¸€ä¸‹æˆ‘å†™çš„ä¸€ä¸ªå·¥å…·ï¼Œtcpdump decoder, å› ä¸ºçº¿ä¸Šæˆ‘ä»¬å¹¶æ²¡æœ‰wiresharkçš„å¯è§†åŒ–å·¥å…·ï¼Œå¾€å¾€éœ€è¦tcpdump -w tcpdump.pcap ç„¶åæœ¬åœ°é€šè¿‡wiresharkè°ƒè¯•ï¼Œæ˜¯çš„å¤ªè¿‡äºéº»çƒ¦å’Œå†—ä½™ï¼Œå› æ­¤æˆ‘ä¸ªäººå¼€äº†ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥åœ¨çº¿è§£æ HTTP/Thriftæµé‡ï¼\n\n\ntcpdump å‘½ä»¤ä»‹ç»\nä¸€èˆ¬æ¥è¯´ tcpdump å‘½ä»¤æœ‰ä¸‰éƒ¨åˆ†ç»„æˆï¼Œ tcpdump -i [interface] &#39;[pacp expression]&#39; [options]\n\n\ninterface: æ ‡è¯†ç½‘å¡ï¼ŒæŒ‡çš„ä½ çš„ç½‘å¡åç§°ï¼Œå¯ä»¥é€šè¿‡ ip addr  or  ifconfig æŸ¥çœ‹\npacp expression: pcapè¡¨è¾¾å¼ï¼Œå¯ä»¥ç†è§£ä¸ºè¿‡æ»¤è¡¨è¾¾å¼\noptions: ä¸€äº›é¢å¤–çš„å‚æ•°ï¼Œ\n -n æ ‡è¯†ä¸è§£æhost \n -X  hexdumpæ‰“å°payload\n-v  è§£æpayloadï¼ˆä¸€èˆ¬å°±åªæ”¯æŒä¸€äº›çº¯æ–‡æœ¬åè®®ï¼‰\n-t  éšè—æ—¶é—´æ“\n-w ä¿å­˜åˆ°æ–‡ä»¶\n-r è¯»å–æ–‡ä»¶\n\n\nç›¸å…³æ–‡æ¡£\npcap filter: https://www.tcpdump.org/manpages/pcap-filter.7.html\ntcpdump: https://www.tcpdump.org/manpages/tcpdump.1.html\n\n\n\n\nè·å–ç½‘å¡.  ä¸€èˆ¬ä½ éœ€è¦ç¡®å®šä½ è¦æŠ“å–çš„ipï¼Œç„¶åå†å»ç¡®è®¤ç½‘å¡, ä¾‹å¦‚æˆ‘è¦æŠ“å–10.248.166.215 åˆ™éœ€è¦ä½¿ç”¨ eth0çš„ç½‘å¡ï¼\n\nfanhaodong.516:~/ $ ip addr                                                                                                                                            [14:23:51]1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host       valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000    link/ether fa:16:3e:34:9d:82 brd ff:ff:ff:ff:ff:ff    inet 10.248.166.215/22 brd 10.248.167.255 scope global eth0       valid_lft forever preferred_lft forever    inet6 fdbd:dc03:ff:1:1:248:166:215/128 scope global       valid_lft forever preferred_lft forever    inet6 fe80::f816:3eff:fe34:9d82/64 scope link       valid_lft forever preferred_lft forever\n\n\næŠ“åŒ…\n\nâœ  tcpdump -i lo0  &#x27;port 8080 and host ::1&#x27; -l -n -vtcpdump: listening on lo0, link-type NULL (BSD loopback), capture size 262144 bytes14:11:38.539268 IP6 (flowlabel 0x20900, hlim 64, next-header TCP (6) payload length: 212) ::1.8080 &gt; ::1.59678: Flags [P.], cksum 0x00dc (incorrect -&gt; 0x72c5), seq 633202846:633203026, ack 3120721099, win 6164, options [nop,nop,TS val 1356080951 ecr 3287837093], length 180: HTTP, length: 180\tHTTP/1.1 200 OK\tContent-Encoding: gzip\tDate: Wed, 31 Aug 2022 06:11:38 GMT\tTransfer-Encoding: chunked\t3d\n\n\né«˜çº§è¿‡æ»¤\n\n# åŒºåˆ† src å’Œ dst tcpdump -i lo0  &#x27;src port 8080 and dst host ::1&#x27; -X# æŠ“å–syncåŒ…ï¼Œä¹Ÿå°±æ˜¯æ¡æ‰‹åŒ…âœ  tcpdump -i lo0 &#x27;tcp[13]=0x02&#x27; -l -ntcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on lo0, link-type NULL (BSD loopback), capture size 262144 bytes14:20:24.679509 IP 127.0.0.1.63788 &gt; 127.0.0.1.9229: Flags [S], seq 220694465, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 3788980622 ecr 0,sackOK,eol], length 014:20:24.680149 IP 127.0.0.1.63790 &gt; 127.0.0.1.9229: Flags [S], seq 3821191416, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 278963318 ecr 0,sackOK,eol], length 014:20:25.682374 IP 127.0.0.1.63792 &gt; 127.0.0.1.9229: Flags [S], seq 1726308526, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 818205733 ecr 0,sackOK,eol], length 014:20:25.683262 IP 127.0.0.1.63794 &gt; 127.0.0.1.9229: Flags [S], seq 3871219645, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 1976538711 ecr 0,sackOK,eol], length 014:20:26.685361 IP 127.0.0.1.63797 &gt; 127.0.0.1.9229: Flags [S], seq 2836663358, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 2399073465 ecr 0,sackOK,eol], length 014:20:26.686232 IP 127.0.0.1.63799 &gt; 127.0.0.1.9229: Flags [S], seq 1158021919, win 65535, options [mss 16344,nop,wscale 6,nop,nop,TS val 837560897 ecr 0,sackOK,eol], length 0\n\n\nç‰¹æ®Šcaseï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™è¯·æ±‚çš„æ˜¯ åŸŸåï¼Œé‚£ä¹ˆæ€ä¹ˆè§£å†³å‘¢ï¼Ÿå¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼è·å–\n\n#æ–¹å¼1. è·å–aè®°å½•âœ  test git:(fix/bug/1_0_4) âœ— dig www.baidu.com## ....www.baidu.com.\t\t134\tIN\tCNAME\twww.a.shifen.com.www.a.shifen.com.\t134\tIN\tA\t220.181.38.149www.a.shifen.com.\t134\tIN\tA\t220.181.38.150#æ–¹å¼2. curl è·å–ip âœ  curl www.baidu.com -v*   Trying 220.181.38.150:80...* Connected to www.baidu.com (220.181.38.150) port 80 (#0)#æ–¹å¼3. ç›´æ¥è¿‡æ»¤hosttcpdump -i en0 &#x27;host www.baidu.com&#x27; -l -n -v\n\næŠ“å–HTTPæœåŠ¡æµé‡\næˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªHTTP Server, è¿™ä¸ªæ¥å£æœ‰ç‚¹å¤æ‚ï¼Œæ˜¯Chunkedç¼–ç +å‹ç¼©çš„ï¼\n\npackage mainimport (\t&quot;fmt&quot;\t&quot;log&quot;\t&quot;github.com/anthony-dong/go-sdk/commons&quot;\t&quot;github.com/anthony-dong/go-sdk/commons/codec/http_codec&quot;\t&quot;github.com/gin-gonic/gin&quot;)func main() &#123;\trouter := gin.Default()\trouter.GET(&quot;/api/v1/:compress&quot;, func(context *gin.Context) &#123;\t\tresp := map[string]interface&#123;&#125;&#123;\t\t\t&quot;data&quot;: commons.NewString(&#x27;A&#x27;, 1024*8),\t\t&#125;\t\tdata := commons.ToJsonString(resp)\t\tcontext.Writer.Header().Set(&quot;Transfer-Encoding&quot;, &quot;chunked&quot;)\t\tcompress := context.Param(&quot;compress&quot;)\t\tif !http_codec.CheckAcceptEncoding(context.Request.Header, compress) &#123;\t\t\tcompress = &quot;&quot;\t\t&#125;\t\tif err := http_codec.EncodeHttpBody(context.Writer, context.Writer.Header(), []byte(data), compress); err != nil &#123;\t\t\tcontext.JSON(500, map[string]interface&#123;&#125;&#123;\t\t\t\t&quot;error&quot;: err.Error(),\t\t\t&#125;)\t\t\treturn\t\t&#125;\t&#125;)\tfmt.Println(&quot;Listen: http://localhost:8080\\nTest: http://localhost:8080/api/v1/gzip&quot;)\tif err := router.Run(&quot;:8080&quot;); err != nil &#123;\t\tlog.Fatal(err)\t&#125;&#125;\n\n\nå¯åŠ¨å¹¶ä¸”æŠ“å–æµé‡\n\nâœ  test git:(fix/bug/1_0_4) âœ— tcpdump -i lo0 &#x27;port 8080&#x27; -l -v -ntcpdump: listening on lo0, link-type NULL (BSD loopback), capture size 262144 bytes14:31:22.066978 IP6 (flowlabel 0x80f00, hlim 64, next-header TCP (6) payload length: 814) ::1.50327 &gt; ::1.8080: Flags [P.], cksum 0x0336 (incorrect -&gt; 0x2a59), seq 3927208909:3927209691, ack 3528028485, win 6369, options [nop,nop,TS val 4277916016 ecr 1002452734], length 782: HTTP, length: 782\tGET /api/v1/gzip HTTP/1.1\tHost: localhost:8080\tConnection: keep-alive\tCache-Control: max-age=0\tsec-ch-ua: &quot;Chromium&quot;;v=&quot;104&quot;, &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;104&quot;\tsec-ch-ua-mobile: ?0\tsec-ch-ua-platform: &quot;macOS&quot;\tUpgrade-Insecure-Requests: 1\tUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36\tAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\tSec-Fetch-Site: none\tSec-Fetch-Mode: navigate\tSec-Fetch-User: ?1\tSec-Fetch-Dest: document\tAccept-Encoding: gzip, deflate, br\tAccept-Language: zh-CN,zh;q=0.9\tCookie: Hm_lvt_899b2a5c34078209c5f30853eaaa7846=1650731778,1652082863,165294802914:31:22.067020 IP6 (flowlabel 0x10e00, hlim 64, next-header TCP (6) payload length: 32) ::1.8080 &gt; ::1.50327: Flags [.], cksum 0x0028 (incorrect -&gt; 0x68da), ack 782, win 6347, options [nop,nop,TS val 1002463298 ecr 4277916016], length 014:31:22.067407 IP6 (flowlabel 0x10e00, hlim 64, next-header TCP (6) payload length: 189) ::1.8080 &gt; ::1.50327: Flags [P.], cksum 0x00c5 (incorrect -&gt; 0xdce5), seq 1:158, ack 782, win 6347, options [nop,nop,TS val 1002463298 ecr 4277916016], length 157: HTTP, length: 157\tHTTP/1.1 200 OK\tContent-Encoding: gzip\tDate: Wed, 31 Aug 2022 06:31:22 GMT\tTransfer-Encoding: chunked\t2614:31:22.067429 IP6 (flowlabel 0x80f00, hlim 64, next-header TCP (6) payload length: 32) ::1.50327 &gt; ::1.8080: Flags [.], cksum 0x0028 (incorrect -&gt; 0x682a), ack 158, win 6366, options [nop,nop,TS val 4277916016 ecr 1002463298], length 0\n\næˆ‘ä»¬å¯ä»¥å‘ç°å¹¶ä¸èƒ½æ‹¿åˆ°chunkedç¼–ç çš„å†…å®¹ï¼Œè¿™é‡Œåªå±•ç¤ºäº†ç¬¬ä¸€è¡Œ 26ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿ é€šè¿‡ gtool tcpdump\nâœ  test git:(fix/bug/1_0_4) âœ— tcpdump -i lo0 &#x27;port 8080&#x27; -l -X -n | gtool tcpdumptcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on lo0, link-type NULL (BSD loopback), capture size 262144 bytes14:32:08.549007 IP6 ::1.8080 &gt; ::1.50327: Flags [.], ack 3927210473, win 6335, length 014:32:08.549037 IP6 ::1.50327 &gt; ::1.8080: Flags [.], ack 1, win 6364, options [nop,nop,TS val 4277962497 ecr 1002494741], length 014:32:08.570433 IP6 ::1.50327 &gt; ::1.8080: Flags [P.], seq 1:783, ack 1, win 6364, options [nop,nop,TS val 4277962519 ecr 1002494741], length 782: HTTP: GET /api/v1/gzip HTTP/1.1GET /api/v1/gzip HTTP/1.1Host: localhost:8080Connection: keep-aliveCache-Control: max-age=0sec-ch-ua: &quot;Chromium&quot;;v=&quot;104&quot;, &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;104&quot;sec-ch-ua-mobile: ?0sec-ch-ua-platform: &quot;macOS&quot;Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Sec-Fetch-Site: noneSec-Fetch-Mode: navigateSec-Fetch-User: ?1Sec-Fetch-Dest: documentAccept-Encoding: gzip, deflate, brAccept-Language: zh-CN,zh;q=0.9Cookie: Hm_lvt_899b2a5c34078209c5f30853eaaa7846=1650731778,1652082863,165294802914:32:08.570456 IP6 ::1.8080 &gt; ::1.50327: Flags [.], ack 783, win 6323, options [nop,nop,TS val 1002509801 ecr 4277962519], length 014:32:08.571189 IP6 ::1.8080 &gt; ::1.50327: Flags [P.], seq 1:158, ack 783, win 6323, options [nop,nop,TS val 1002509801 ecr 4277962519], length 157: HTTP: HTTP/1.1 200 OKHTTP/1.1 200 OKTransfer-Encoding: chunkedContent-Encoding: gzipDate: Wed, 31 Aug 2022 06:32:08 GMT&#123;&quot;data&quot;:&quot;AAAAAAAAAAAAAAAAAAAA&quot;&#125;14:32:08.571208 IP6 ::1.50327 &gt; ::1.8080: Flags [.], ack 158, win 6362, options [nop,nop,TS val 4277962519 ecr 1002509801], length 0\n\né…åˆwiresharkä½¿ç”¨\nä»‹ç»\n\nwireshark æ˜¯ä¸€ä¸ªå®Œå…¨å¼€æºçš„é¡¹ç›®ï¼Œå‡ºèº«ä¹Ÿæ¯”è¾ƒæ—©ï¼Œä¹åå¹´ä»£çš„äº§ç‰©ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯åˆ©ç”¨pcapå»è§£ææ•°æ®åŒ…ï¼Œå¹¶æ”¯æŒå¼ºå¤§çš„è¿‡æ»¤è¯­æ³•ï¼Œæºç : https://gitlab.com/wireshark/wireshark, æ–‡æ¡£: https://www.wireshark.org/docs/man-pages/wireshark-filter.html\n\nå…¶å®wireshark æä¾›äº†å¾ˆå¤šcliï¼Œå¸®åŠ©dumpæ•°æ®ï¼Œå…·ä½“å¯ä»¥çœ‹: https://www.wireshark.org/docs/man-pages/\n\nåªéœ€è¦tcpdump -w [filename] å°±OKäº†ï¼Œæ˜¯çš„è¿˜å¯ä»¥ tcpdump -r [filename] ä¹Ÿå¯ä»¥è¯»çš„ï¼\n\n\nâœ tcpdump -i lo0 &#x27;port 8080&#x27; -w ~/data/tcpdump.pcaptcpdump: listening on lo0, link-type NULL (BSD loopback), capture size 262144 bytes\n\n\nè¯»å–æ–‡ä»¶(ä¸€èˆ¬æŠ“åŒ…æ–‡ä»¶çš„æ–‡ä»¶åç¼€æ˜¯ .pcap) , æˆ–è€…ç›´æ¥ç›‘å¬ç½‘å¡ \n\n5. ä½¿ç”¨ flow å¯ä»¥æ›´å¥½çš„æŸ¥çœ‹è¿æ¥ä¸Šçš„è¯·æ±‚ï¼\n\nä½¿ç”¨ gtool tcpdump\nä»‹ç»: https://github.com/Anthony-Dong/go-sdk/blob/master/gtool/tcpdump\n\n\næœ¬é¡¹ç›®åªæ˜¯ä¸ºäº†äº†è§£ pcap+æµé‡è§£æï¼Œè™½ç„¶wiresharkæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„GUIå·¥å…·ï¼Œä½†æ˜¯çº¿ä¸Šå¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå…¶æ¬¡å°±æ˜¯ä½¿ç”¨ tcpdumpå¤§éƒ¨åˆ†å¯ä»¥æ»¡è¶³èƒ½åŠ›ï¼æ‰€ä»¥æˆ‘å·¥å…·å¹¶æ²¡æœ‰é€ è½®å­ï¼Œæ›´å¤šçš„æ˜¯åœ¨çº¿è§£æä¸šåŠ¡æµé‡ï¼Œå…³æ³¨äºè§£æåº”ç”¨å±‚æµé‡ï¼\n\n\næ”¯æŒè§£æTCPçš„åŒ…\næ”¯æŒè§£æHTTPåŒ…(HTTP/1.1 &amp; HTTP/1.0)ï¼Œæ”¯æŒè‡ªåŠ¨æ ¹æ®content-encodingç±»å‹è¿›è¡Œè§£æï¼\næ”¯æŒè§£æThriftåŒ…ï¼Œæ”¯æŒå¤šç§åè®®ï¼ŒåŒ…å«Kitexçš„TTHeader å’Œ Thrift å®˜æ–¹åè®®ï¼ˆFramedã€THeaderã€Unframedï¼‰ï¼\næ”¯æŒè§£æå¤§åŒ…ï¼ˆç²˜åŒ…é—®é¢˜ï¼‰\næ”¯æŒtcpdumpåœ¨çº¿/ç¦»çº¿æµé‡è§£æ\n\nâœ  gtool tcpdump -hName: decode tcpdump file, help doc: https://github.com/Anthony-Dong/go-sdk/tree/master/gtool/tcpdumpUsage: gtool tcpdump [-r file] [-v] [-X] [--max dump size] [flags]Examples:\t1. step1: tcpdump &#x27;port 8080&#x27; -w ~/data/tcpdump.pcap\t   step2: gtool tcpdump -r ~/data/tcpdump.pcap\t2. tcpdump &#x27;port 8080&#x27; -X -l -n | gtool tcpdumpOptions:  -X, --dump          Enable Display payload details with hexdump.  -r, --file string   The packets file, eg: tcpdump_xxx_file.pcap.  -h, --help          help for tcpdump      --max int       The hexdump max size  -v, --verbose       Enable Display decoded details.Global Options:      --config-file string   set the config file (default &quot;/Users/bytedance/.gtool.yaml&quot;)      --log-level string     set the log level in &quot;fatal|error|warn|info|debug&quot; (default &quot;debug&quot;)To get more help with gtool, check out our guides at https://github.com/Anthony-Dong/go-sdk\n\n\nä½¿ç”¨ (æ³¨æ„ç®¡é“ç¬¦è¯»å–ï¼Œéœ€è¦-Xè¾“å‡ºï¼Œå› ä¸ºå…¶ä»–ä¼šä¸¢å¤±åŸæ•°æ®)\n\nfanhaodong.516:go-sdk/ $ sudo tcpdump -i eth0 &#x27;port 8888&#x27; -l -n -X | bin/gtool tcpdump                     [14:08:10]tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes14:08:51.426622 IP 10.225.xx.196.28284 &gt; 10.248.xx.215.8888: Flags [S], seq 174152772, win 28200, options [mss 1410,sackOK,TS val 445695352 ecr 0,nop,wscale 10], length 014:08:51.426726 IP 10.248.xx.215.8888 &gt; 10.225.xx.196.28284: Flags [S.], seq 2533803252, ack 174152773, win 28960, options [mss 1460,sackOK,TS val 2106570914 ecr 445695352,nop,wscale 10], length 014:08:51.430699 IP 10.225.xx.196.28284 &gt; 10.248.xxx.215.8888: Flags [.], ack 1, win 28, options [nop,nop,TS val 445695357 ecr 2106570914], length 014:08:51.430790 IP 10.225.xx.196.28284 &gt; 10.248.xxx.215.8888: Flags [P.], seq 1:987, ack 1, win 28, options [nop,nop,TS val 445695357 ecr 2106570914], length 986&#123;  &quot;method&quot;: &quot;SimpleTestRPC&quot;,  &quot;seq_id&quot;: 324,  &quot;protocol&quot;: &quot;UnframedBinary&quot;,  &quot;message_type&quot;: &quot;call&quot;,  &quot;payload&quot;: &#123;    &quot;1_STRUCT&quot;: &#123;      &quot;255_STRUCT&quot;: &#123;        &quot;1_STRING&quot;: &quot;111&quot;,        &quot;2_STRING&quot;: &quot;xxxx.xxx.xx&quot;,        &quot;3_STRING&quot;: &quot;10.xxx.xxx.xxx&quot;,        &quot;4_STRING&quot;: &quot;&quot;,        &quot;6_MAP&quot;: &#123;          &quot;cluster&quot;: &quot;test&quot;,          &quot;env&quot;: &quot;prod&quot;,          &quot;idc&quot;: &quot;xxx&quot;,          &quot;tracestate&quot;: &quot;_sr=1&quot;,          &quot;user_extra&quot;: &quot;&quot;        &#125;      &#125;,      &quot;1_STRING&quot;: &quot;hello world&quot;    &#125;  &#125;,  &quot;meta_info&quot;: &#123;&#125;&#125;14:08:51.430803 IP 10.248.xxx.215.8888 &gt; 10.225.xxx.196.28284: Flags [.], ack 987, win 32, options [nop,nop,TS val 2106570918 ecr 445695357], length 014:08:51.432384 IP 10.248.xxx.215.8888 &gt; 10.225.xxx.196.28284: Flags [P.], seq 1:890, ack 987, win 32, options [nop,nop,TS val 2106570919 ecr 445695357], length 889&#123;  &quot;method&quot;: &quot;SimpleTestRPC&quot;,  &quot;seq_id&quot;: 324,  &quot;protocol&quot;: &quot;UnframedBinary&quot;,  &quot;message_type&quot;: &quot;reply&quot;,  &quot;payload&quot;: &#123;    &quot;0_STRUCT&quot;: &#123;      &quot;1_STRING&quot;: &quot;hello world&quot;,      &quot;2_STRING&quot;: &quot;hello, world!&quot;,      &quot;255_STRUCT&quot;: &#123;        &quot;2_I32&quot;: 0,        &quot;1_STRING&quot;: &quot;&quot;,        &quot;3_MAP&quot;: &#123;          &quot;_CUSTOM_CLUSTER&quot;: &quot;default&quot;,          &quot;_CUSTOM_ENV&quot;: &quot;prod&quot;,          &quot;_CUSTOM_IDC&quot;: &quot;xxx&quot;,          &quot;_CUSTOM_IP&quot;: &quot;10.xxx.xx.xx&quot;,          &quot;_CUSTOM_IP_V4&quot;: &quot;xxx.xxx.xxx.xxx&quot;,          &quot;_CUSTOM_IP_V6&quot;: &quot;xxxx&quot;,          &#125;      &#125;    &#125;  &#125;,  &quot;meta_info&quot;: &#123;&#125;&#125;14:08:51.436438 IP 10.225.xx.196.28284 &gt; 10.248.xxx.215.8888: Flags [.], ack 890, win 31, options [nop,nop,TS val 445695362 ecr 2106570919], length 014:08:51.637336 IP 10.225.xx.196.28284 &gt; 10.248.xx.215.8888: Flags [F.], seq 987, ack 890, win 31, options [nop,nop,TS val 445695563 ecr 2106570919], length 014:08:51.637552 IP 10.248.xx.215.8888 &gt; 10.225.xx.196.28284: Flags [F.], seq 890, ack 988, win 32, options [nop,nop,TS val 2106571125 ecr 445695563], length 014:08:51.641670 IP 10.225.xx.196.28284 &gt; 10.248.xxx.215.8888: Flags [.], ack 891, win 31, options [nop,nop,TS val 445695568 ecr 2106571125], length 0\n\n\n\n\n\n","categories":["Linux"],"tags":["Linuxå‘½ä»¤"]},{"title":"Mac ä¸ªäººå¼€å‘ç¯å¢ƒæ­å»º","url":"/2021/08/24/a5ccc7a0e58afc7d2f946516f3e32dd0/","content":"â€‹     ä¸ªäººçš„Macç¯å¢ƒï¼Œä¸»è¦æ˜¯è§£å†³ä¸€äº›æ›´æ¢ç”µè„‘æ—¶éœ€è¦é‡æ–°æä¸€äº›ä¸œè¥¿ï¼Œä»¥åŠåˆ†äº«ä¸€ä¸‹ä¸ªäººmacçš„é…ç½®ï¼Œä»¥åŠä¸€äº›å‘½ä»¤çš„æ¨èï¼\n\n\nå®‰è£…å¸¸ç”¨å‘½ä»¤brewå’Œ on-my-zsh# å®‰è£… brew ï¼ˆä»…macï¼‰sh -c &quot;$(curl -fsSL https://anthony-wangpan.oss-accelerate.aliyuncs.com/software/2021/6-17/brew.sh)&quot;# å®‰è£…zsh, å¯ä»¥å…ˆæ£€æŸ¥ä¸‹æœ‰æ²¡æœ‰  zsh --version ï¼Œmacé»˜è®¤æ˜¯è‡ªå¸¦çš„zsh --version# https://github.com/ohmyzsh/ohmyzshsodu apt-get install zsh# å®‰è£…on-myzshsh -c &quot;$(curl -fsSL https://anthony-wangpan.oss-accelerate.aliyuncs.com/software/2021/6-17/zsh.sh)&quot;# è®¾ç½®é»˜è®¤chsh -s $(which zsh)\n\nè§£å†³brew  Updating æ…¢çš„é—®é¢˜æˆ‘ä»¬æ˜¯å›½å†…ç”¨æˆ·ï¼Œåœ¨æ²¡æœ‰å¥½çš„VPNçš„æƒ…å†µä¸‹ï¼Œè®¿é—®å¤–ç½‘é‚£çœŸçš„å«åšä¸€ä¸ªç³Ÿå¿ƒï¼å¹¸å¥½æœ‰é˜¿é‡Œå·´å·´è¿™ç§å…¬å¸åšé•œåƒï¼\nå‚è€ƒè‡ª: https://blog.csdn.net/weixin_43318367/article/details/111411462\n# 1. æ›¿æ¢ brew.git ä»“åº“åœ°å€cd &quot;$(brew --repo)&quot;git remote set-url origin https://mirrors.aliyun.com/homebrew/brew.git# 2. æ›¿æ¢ homebrew-core.git ä»“åº“åœ°å€cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot;git remote set-url origin https://mirrors.aliyun.com/homebrew/homebrew-core.git# 3. æ›¿æ¢ homebrew-bottles è®¿é—®åœ°å€echo &#x27;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.aliyun.com/homebrew/homebrew-bottles&#x27; &gt;&gt; ~/.zshrcsource ~/.zshrc\n\non-my-zsh æ’ä»¶\n zsh-autosuggestions å‘½ä»¤è®°å½•/æ¨è\n\n\n# 1. ä¸‹è½½æ’ä»¶git clone --depth 1 https://github.com/zsh-users/zsh-autosuggestions.git $ZSH_CUSTOM/plugins/zsh-autosuggestions# 2. é…ç½®æ’ä»¶ vim ~/.zshrcplugins=(\tgit\tzsh-autosuggestions)\n\n\nzsh-syntax-highlighting  é«˜äº®\n\ngit clone --depth 1 https://github.com/zsh-users/zsh-syntax-highlighting.git $ZSH_CUSTOM/plugins/zsh-syntax-highlighting\n\n\n\nhttps://github.com/zsh-users/zsh-autosuggestions/issues/238    è§£æ ctrl c+v å¢¨è¿¹çš„é—®é¢˜ï¼Œæ”¾åˆ° ~/.zshrc é‡Œé¢å°±è¡Œ\n\n# This speeds up pasting w/ autosuggest# https://github.com/zsh-users/zsh-autosuggestions/issues/238pasteinit() &#123;  OLD_SELF_INSERT=$&#123;$&#123;(s.:.)widgets[self-insert]&#125;[2,3]&#125;  zle -N self-insert url-quote-magic # I wonder if you&#x27;d need `.url-quote-magic`?&#125;pastefinish() &#123;  zle -N self-insert $OLD_SELF_INSERT&#125;zstyle :bracketed-paste-magic paste-init pasteinitzstyle :bracketed-paste-magic paste-finish pastefinish\n\n\nå…³äº agnoster ä¹±ç é—®é¢˜: è‡ªè¡Œç™¾åº¦è§£å†³ï¼Œè§£å†³æ–¹æ¡ˆéƒ½ä¸å¤ªå¥½ï¼Œå»ºè®®åˆ«ç”¨ï¼Œé»˜è®¤æŒºå¥½ï¼\n\nå®‰è£…GNUå‘½ä»¤è¡Œ (ä»…Mac)ä¸»è¦æ˜¯è§£å†³ï¼Œæˆ‘ä»¬Linuxç”¨æˆ·çš„ç—›ç‚¹ï¼Œå‘ç°å¾ˆå¤šå‘½ä»¤macosä½¿ç”¨æ–¹å¼ä¸ä¸€æ ·ï¼\n# å¤‡ä»½ä¸‹cp ~/.zshrc ~/.zshrc_copy# install grep sed awk gtarbrew install grepbrew install gnu-sedbrew install gawkbrew install gnu-tar# install coreutils, eg: ls,cd,nc, ...  brew install coreutils# install find utils, eg: find, xargs ..brew install findutils# install mysql-clientbrew install mysql-client\n\nç¯å¢ƒå˜é‡é…ç½®ï¼š\n# aliasalias awk=gawk# export gnu binexport PATH=&quot;/usr/local/opt/gnu-sed/libexec/gnubin:$PATH&quot;export PATH=&quot;/usr/local/opt/gnu-tar/libexec/gnubin:$PATH&quot;export PATH=&quot;/usr/local/opt/grep/libexec/gnubin:$PATH&quot;export PATH=&quot;/usr/local/opt/coreutils/libexec/gnubin:$PATH&quot;export PATH=&quot;/usr/local/opt/findutils/libexec/gnubin:$PATH&quot;# export softwareexport PATH=&quot;/usr/local/opt/mysql-client/bin:$PATH&quot;\n\nç³»ç»Ÿå·¥å…·å®‰è£…\nbrew install htop\n\nå®‰è£…è¯­è¨€ç¯å¢ƒ\nå®‰è£…GOè¯­è¨€ï¼Œæ–‡æ¡£ï¼š gvm\n\n## å®‰è£…gvmbash &lt; &lt;(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)## æ³¨æ„: é…ç½®ä¸€ä¸‹è¿™ä¸ª, gvmä¼šé‡å†™GOPATH.source $&#123;HOME&#125;/.gvm/scripts/gvmexport GOPATH=$HOME/go## ä¸‹è½½å’Œä½¿ç”¨gvm install go1.17## é»˜è®¤ä½¿ç”¨ go1.17gvm use go1.17 --default\n\n\nå®‰è£…openjdk\n\nbrew install openjdk@8\n\n\nå®‰è£…å…¶ä»–è¯­è¨€\n\n# é…ç½®python ä½¿ç”¨ python3alias python=python3\n\n\nå®‰è£…vscode\n\n\nä¸€å®šè¦é…ç½®è¿™ä¸ªï¼Œå¯ä»¥åšåˆ° anywhere code xxxx ï¼ï¼ï¼\n\n\né«˜äº®é…ç½®ls é«˜äº®alias ä¸‹ alias ls=&#39;ls -F --show-control-chars --color=auto&#39;\nä¸ªäººé«˜é¢‘è„šæœ¬1. åŒæ­¥æ–‡ä»¶è„šæœ¬\nè¿™ä¸ªè„šæœ¬ä¸»è¦æ˜¯æœ¬åœ°åŒæ­¥åˆ°è¿œç¨‹ï¼Œè¿œç¨‹å¼€å‘çš„è¯ç›´æ¥ç”¨ remote-ssh æˆ–è€… cloud-ide å³å¯ï¼\n\n\nè®°å¾—åœ¨ $&#123;SYNC_HOME&#125;/.fileignore åˆ›å»ºæ–‡ä»¶ï¼Œä¸»è¦æ˜¯ç”³æ˜ä¸€äº›ä¸éœ€è¦åŒæ­¥çš„æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶\n\n*.swp*.pyc*.pyo.git.DS_Store.idea.vscode-upload.jsonoutput*.class*.log*mvnw*target*.iml.m2binnode_modulescmake-build-debugcmake-build-debug-event-trace\n\n\nåœ¨$&#123;SYNC_HOME&#125;/sync.sh åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶ä¸”copyä¸‹é¢æ–‡ä»¶\n\n#!/bin/bash########################### é…ç½®å¼€å§‹# è¿œç¨‹æœåŠ¡å™¨çš„ç”¨æˆ·åç§°readonly DEV_USER=&quot;fanhaodong.516&quot;# è¿œç¨‹æœåŠ¡å™¨çš„åœ°å€readonly DEV_IP=&quot;xx.xx.xx.xx&quot;# è¿œç¨‹åŒæ­¥ç›®å½•ï¼Œæ¨èç”¨æˆ·çš„æ ¹ç›®å½•ï¼Œä¾‹å¦‚å¯ä»¥æ‰§è¡Œ echo &quot;$HOME&quot; æŸ¥çœ‹ç”¨æˆ·æ ¹ç›®å½•readonly REMOTE_PATH=&quot;/home/fanhaodong.516&quot;# æœ¬åœ°è„šæœ¬ç›®å½•readonly SYNC_HOME=&quot;/Users/bytedance/go/bin/sync-devbox&quot;# æœ¬åœ°åŒæ­¥ç™½åå•readonly WHITE_LIST=(&quot;/Users/bytedance/go/src&quot; &quot;/Users/bytedance/data&quot; &quot;/Users/bytedance/note&quot;)########################### é…ç½®ç»“æŸ## è·å–å½“å‰è·¯å¾„if [[ -z &quot;$&#123;1&#125;&quot; ]]; then    PWD=$(pwd)else    PWD=$&#123;1&#125;fiPWD=$(realpath &quot;$&#123;PWD&#125;&quot;)PASS=&quot;false&quot;NOT_PASS_DIR=&quot;&quot;for elem in &quot;$&#123;WHITE_LIST[@]&#125;&quot;; do    if echo &quot;$&#123;PWD&#125;&quot; | grep -e &quot;^$&#123;elem&#125;.*&quot;; then PASS=&quot;true&quot;; fi    NOT_PASS_DIR=$&#123;NOT_PASS_DIR&#125;&quot;$elem, &quot;doneif [[ &quot;$&#123;PASS&#125;&quot; == &quot;false&quot; ]]; then echo &quot;$&#123;PWD&#125; æ— æ³•åŒæ­¥,åŸå› æ˜¯ç›®å½•ä¸åœ¨$&#123;NOT_PASS_DIR&#125;ç›®å½•ä¸‹!&quot;; exit 1; fiif [[ &quot;$&#123;PWD: -1&#125;&quot; == &quot;/&quot; ]]; then    echo &quot;$&#123;PWD&#125; æ— æ³•åŒæ­¥,åŸå› æ˜¯ç›®å½•æœ€ååŒ…å« &#x27;/&#x27; &quot;    exit 1;fi# æ›¿æ¢ å½“å‰è·¯å¾„çš„ $&#123;HOME&#125; ä¸º $&#123;REMOTE_PATH&#125;REMOTE_PWD=$&#123;PWD/$&#123;HOME&#125;/$&#123;REMOTE_PATH&#125;&#125;ssh $&#123;DEV_USER&#125;@$&#123;DEV_IP&#125; mkdir -p $(dirname $&#123;REMOTE_PWD&#125;)echo &quot;remote exec: mkdir -p $(dirname $&#123;REMOTE_PWD&#125;)&quot;# ç”¨æ³•å‚è€ƒ: https://www.ruanyifeng.com/blog/2020/08/rsync.html# -a é€’å½’æ›¿æ¢ä¸”æ–‡ä»¶å…ƒä¿¡æ¯ä¹Ÿæ›¿æ¢# -v å±•ç¤ºä¿¡æ¯# --delete åˆ é™¤åªå­˜åœ¨äºç›®æ ‡ç›®å½•ã€ä¸å­˜åœ¨äºæºç›®å½•çš„æ–‡ä»¶rsync -avz \\    --delete \\    --progress \\    --log-file=$&#123;SYNC_HOME&#125;/sync-devbox.log \\    --log-file-format=&#x27;%t %f %b&#x27; \\    --exclude-from=$&#123;SYNC_HOME&#125;/.fileignore \\    &quot;$&#123;PWD&#125;/&quot; &quot;$&#123;DEV_USER&#125;@$&#123;DEV_IP&#125;:$&#123;REMOTE_PWD&#125;/&quot;echo &quot;local exec: rsync $&#123;PWD&#125;/ -&gt; $&#123;REMOTE_PWD&#125;/  success!&quot;\n\n\nåœ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œé…ç½®æœ¬åœ°æœåŠ¡çš„å…¬é’¥ï¼Œè¿›è¡Œå…å¯†ç™»é™†ï¼\næ‰§è¡Œ sync.sh   æˆ–è€…  sync.sh [dir]\n\nmacç³»ç»Ÿé…ç½®\nè¿™ä¸ªä¸èƒ½è¿‡å¿«ï¼Œä¸ç„¶åŒå‡»æ— æ³•é€‰ä¸­ä¸œè¥¿ï¼\nvim é…ç½®æœ¬äººå‚è€ƒçš„é…ç½®æ˜¯: https://github.com/amix/vimrc  ç›´æ¥æ ¹æ®æ–‡æ¡£æ“ä½œå³å¯ ï¼Œä¸ªäººforkäº†ä¸€ä¸ªç‰ˆæœ¬: https://github.com/Anthony-Dong/vimrc/tree/dev \n\nåŸºæœ¬æ“ä½œ\n\n\ncontrol + f å‘ä¸‹ç¿»ä¸€é¡µ forward\ncontrol + b å‘ä¸Šç¿»ä¸€é¡µ back forward\ncontrol + d å‘ä¸‹ç¿»åŠé¡µ down\ncontrol + u å‘ä¸‹ç¿»åŠé¡µ up\nctrl + e:  å‘ä¸‹æ»šåŠ¨ä¸€è¡Œ\nctrl + y:  å‘ä¸Šæ»šåŠ¨ä¸€è¡Œ\nline number + gg: æ‰è½¬åˆ°æŒ‡å®šè¡Œï¼Œä»1å¼€å§‹\n/{xxx}: æŸ¥æ‰¾æ–‡ä»¶å†…å®¹ï¼Œ shift+n æŸ¥æ‰¾ä¸‹ä¸€ä¸ª\n\n\næ“ä½œï¼ŒåŸºæœ¬å°±æ˜¯è§†å›¾æ¨¡å¼ã€åŸºæœ¬æ¨¡å¼ã€ç¼–è¾‘æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ï¼Œå¤§æ¦‚4ä¸ªæ¨¡å¼ï¼Œå…¶ä¸­è§†å›¾æ¨¡å¼éœ€è¦æŒ‰vè¿›å…¥\n\nå…¶ä»–åŸºæœ¬æ“ä½œ dåˆ é™¤ï¼ˆDeleteï¼‰ï¼Œcå‰ªåˆ‡ï¼ˆCutï¼‰ï¼Œyå¤åˆ¶ï¼ˆYankï¼‰ï¼Œpç²˜è´´ï¼ˆPasteï¼‰ï¼Œä½†æ˜¯ä¸€èˆ¬ä¹Ÿå…¼å®¹ (command+c/command+v)\n\nvimçš„å¿«æ·é”®\n\n\nmap (é€’å½’map, nmapè¡¨ç¤ºéé€’å½’)# leaderæ˜¯ä¸€ä¸ªå…¨å±€çš„å¿«æ·é”®ï¼Œä¾‹å¦‚ \\\\# &lt;leader&gt;nn å«ä¹‰å°±æ˜¯ \\\\nné‚£ä¹ˆå®ƒç­‰ä»·äº :NERDTreeToggle&lt;cr&gt;map &lt;leader&gt;nn :NERDTreeToggle&lt;cr&gt;\n\n\nNERDTree æ–‡ä»¶æ ‘æ’ä»¶\n\n\nä¸ªäººå–œæ¬¢ ctrl + t  æ‰“å¼€ NERDTreeToggle \nctrl + w + w: å…¶å®å°±æ˜¯æ¥å›åˆ‡æ¢ ç›®å½•æ ‘/ç¼–è¾‘åŒº çš„å…‰æ ‡\no: æ‰“å¼€ç›®å½• ï¼ˆæˆ–è€… enter ä¹Ÿå¯ä»¥ï¼‰\nx: å…³é—­ç›®å½•\nr: åˆ·æ–°ç›®å½•\n\n\n\n\nCtrl-P æœç´¢æ–‡ä»¶æ’ä»¶\n\n\nä¸ªäººå–œæ¬¢ ctrl+p æ‰“å¼€ CtrlP\nctrl+c å–æ¶ˆæœç´¢\n\n\n\n\nGit-Fugitive  Gitæ’ä»¶\n\n\nGvdiffsplit å¯ä»¥å¿«é€Ÿçœ‹åˆ°diff\n\n\n\npostman ä½ç‰ˆæœ¬ä¸‹è½½\npostmanæ–°ç‰ˆæœ¬å¤ªæ…¢äº†ï¼Œè€Œä¸”uiå¤ªå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢æ—§çš„ç‰ˆæœ¬ï¼Œæˆ‘ä¸ªäººä½¿ç”¨è½¯ä»¶çš„åŸåˆ™æ˜¯èƒ½ä¸å‡çº§åˆ™ä¸å‡çº§ï¼\n\nRelease Notes: https://www.postman.com/downloads/release-notes/\nä¾‹å¦‚æˆ‘è¦ä¸‹è½½  v7.36.7 ç‰ˆæœ¬çš„postman ï¼Œå¹³å°æ˜¯macosï¼Œå¯ä»¥æ‰“å¼€ https://dl.pstmn.io/download/version/7.36.7/osx è¿›è¡Œä¸‹è½½\n\næ³¨æ„ï¼š{version} éœ€è¦æŠŠ v7.36.7 ä¸­çš„ vå»é™¤æ‰\n\n\n\n\nå¹³å°\nä¸‹è½½åœ°å€\n\n\n\nWindows64ä½\nhttps://dl.pstmn.io/download/version/{version}/win64\n\n\nWindows32ä½\nhttps://dl.pstmn.io/download/version/{version}/win32\n\n\nMac\nhttps://dl.pstmn.io/download/version/{version}/osx\n\n\nLinux\nhttps://dl.pstmn.io/download/version/{version}/linux\n\n\n ä¸è¿‡æœ€æ–°ç‰ˆæœ¬ï¼Œmac-osç”±äºæœ‰armèŠ¯ç‰‡æ‰€ä»¥:\n\narm :  https://dl.pstmn.io/download/latest/osx_arm64\nintel :  https://dl.pstmn.io/download/latest/osx_64\n\n","categories":["Linux"],"tags":["mac"]},{"title":"Makefileå­¦ä¹ ","url":"/2021/03/20/a9ec632af8ce6689c201007d3b97b0df/","content":"â€‹    Makefile åœ¨å¼€æºé¡¹ç›®ä¸­è¿˜æ˜¯ç›¸å½“çš„å¸¸è§çš„ï¼Œç†Ÿæ‚‰ä»–çš„åŸºæœ¬è¯­æ³•ï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå…¶æ¬¡æ˜¯Makefileç›¸å¯¹äºshellè„šæœ¬çš„ä¼˜ç‚¹å°±æ˜¯ä»–çš„å…³è”æ€§ï¼Œå’Œå‰ç½®æ¡ä»¶ç­‰éƒ½å¾ˆå¥½çš„è§£å†³çš„æ„å»ºé“¾æ¡çš„é—®é¢˜ã€‚æœ‰äº›å­¦c/cppçš„åŒå­¦å¯èƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæˆ‘ä»¬è¿™ä¸ªæ ¸å¿ƒä¸å…³æ³¨äºè¿™ä¸ªï¼Œä¸»è¦æ˜¯ä½¿ç”¨åœ¨æ—¥å¸¸ä¸­\n\n\nmake ä¸€äº›cliå‚æ•°\n-n å‚æ•°ï¼š\n\nã€€ã€€ ä½¿ç”¨ -n å‚æ•°ï¼Œè®© make å‘½ä»¤è¾“å‡ºå°†è¦æ‰§è¡Œçš„æ“ä½œæ­¥éª¤ï¼Œè€Œä¸æ˜¯çœŸæ­£æ‰§è¡Œè¿™äº›æ“ä½œï¼›\nâœ  makefile git:(master) âœ— touch Makefile2      âœ  makefile git:(master) âœ— make -n        rm -f Makefile1 Makefile2 Makefile3âœ  makefile git:(master) âœ— ls Makefile  Makefile1 Makefile2\n\n\n-f å‚æ•°ï¼š\n\nã€€ã€€ä½¿ç”¨ -f å‚æ•°ï¼Œåé¢å¯ä»¥æ¥ä¸€ä¸ªæ–‡ä»¶åï¼Œç”¨äºæŒ‡å®šä¸€ä¸ªæ–‡ä»¶ä½œä¸º makefile æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨ -f é€‰é¡¹ï¼Œåˆ™ make å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾åä¸º makefile çš„æ–‡ä»¶ï¼Œå¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æŸ¥æ‰¾åä¸º Makefile çš„æ–‡ä»¶ã€‚ \n\n-C å‚æ•°\nâ€‹    ä¸€èˆ¬å½“æˆ‘ä»¬è°ƒç”¨å…¶ä»–ç›®å½•çš„makefileï¼Œå¯ä»¥ç›´æ¥ make -C &lt;dir&gt;  æ‰§è¡Œå®Œé€€å›å½“å‰makeå‘½ä»¤ï¼Œç±»ä¼¼äºshell\n\ninclude  å¯ä»¥å¼•ç”¨ç”¨å…¶ä»–çš„makefileï¼Œç±»ä¼¼äºå…¶ä»–ç¼–ç¨‹è¯­è¨€çš„importï¼Œå’Œç¯å¢ƒå˜é‡ MAKEFILES ç­‰æ•ˆ\n\n\nMakefileæ–‡ä»¶\ninclude a.make b.makeall: echoa echob\t@echo hello\n\na.make æ–‡ä»¶\nechoa:\t@echo hello a\t\n\nb.make æ–‡ä»¶\nechob:\t@echo hello b\n\næ‰§è¡Œ\n1ï¼‰ å¯ä»¥å‘ç°includeå´æ˜¯æ˜¯æŠŠå®ƒå®Œå®Œå…¨å…¨çš„copyåˆ°äº†å¤´éƒ¨\nâœ  makefile git:(master) âœ— makehello a\n\n2ï¼‰ç»§ç»­ï¼Œå®Œå…¨ç¬¦åˆ\nâœ  makefile git:(master) âœ— make allhello ahello bhello\n\nmakefileä¸€äº›ç¯å¢ƒå˜é‡MAKE\nâ€‹    å…¶å®å°±æ˜¯ä½ çš„makeç¯å¢ƒå˜é‡çš„ï¼Œwhich make å³å¯\n\n.PHONY: allall:\t@echo &quot;makeè·¯å¾„: $(MAKE)&quot;\n\nè¾“å‡º\nâœ  makefile git:(master) âœ— makemakeè·¯å¾„: /Library/Developer/CommandLineTools/usr/bin/make\n\nRM\nâ€‹    è¿™ä¸ªä¸»è¦æ˜¯å½“ä½œ rm -f å‚æ•°\n\n.PHONY: allclean:\t$(RM) Makefile1 Makefile2 Makefile3\n\nè¾“å‡ºï¼š\nâœ  makefile git:(master) âœ— makerm -f Makefile1 Makefile2 Makefile3\n\nMAKEFILE_LIST\nâ€‹    MAKEFILE_LISTçš„å˜é‡, å®ƒæ˜¯ä¸ªåˆ—è¡¨å˜é‡, åœ¨æ¯æ¬¡makeè¯»å…¥ä¸€ä¸ªmakeæ–‡ä»¶æ—¶, éƒ½æŠŠå®ƒæ·»åŠ åˆ°æœ€åä¸€é¡¹ï¼Œgnu make æœ‰æ•ˆã€‚\n\n\nMakefile æ–‡ä»¶\n\nall:\t@echo &quot;å½“å‰makefile: $(MAKEFILE_LIST)&quot;\t@$(MAKE) -f Makefile2\n\n\nMakefile æ–‡ä»¶2\n\nall:\t@echo &quot;å½“å‰makefile: $(MAKEFILE_LIST)&quot;\n\nè¾“å‡º\nâœ  makefile git:(master) âœ— makeå½“å‰makefile:  Makefileå½“å‰makefile:  Makefile2\n\næ‰€ä»¥ä¾é è¿™ä¸ªå¯ä»¥è·å–å½“å‰è·¯å¾„ï¼Œä½†æ˜¯ç›®å‰æ²¡æœ‰æ¨¡æ‹Ÿå‡º MAKEFILE_LIST å¤šä¸ªåˆ—è¡¨\n.PHONY:first:\t@echo $(MAKEFILE_LIST)second:\t@echo $(lastword $(MAKEFILE_LIST))third:\t@echo $(realpath $(lastword $(MAKEFILE_LIST)))latest: first second third\t@echo $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))\n\næ‰§è¡Œ\nâœ  go-source git:(master) âœ— make latest MakefileMakefile/Users/fanhaodong/go/code/go-source/Makefile/Users/fanhaodong/go/code/go-source\n\nmakefile æ–‡ä»¶ä¹¦å†™è§„åˆ™ã€€    makefile æ–‡ä»¶ç”±ä¸€ç»„ä¾èµ–å…³ç³»å’Œè§„åˆ™æ„æˆã€‚æ¯ä¸ªä¾èµ–å…³ç³»éƒ½ç”±ä¸€ä¸ªç›®æ ‡ï¼ˆå³å°†è¦åˆ›å»ºçš„æ–‡ä»¶ï¼‰å’Œä¸€ä¸ªè¯¥ç›®æ ‡æ‰€ä¾èµ–çš„æºæ–‡ä»¶ç»„æˆï¼›è§„åˆ™æè¿°äº†å¦‚ä½•é€šè¿‡è¿™äº›ä¾èµ–æ–‡ä»¶åˆ›å»ºç›®æ ‡ã€‚ç®€å•çš„æ¥è¯´ï¼Œmakefile æ–‡ä»¶çš„å†™æ³•å¦‚ä¸‹ï¼š\ntarget: prerequisites    command1    command2    ...\n\nã€€ã€€å…¶ä¸­ï¼Œtarget æ˜¯å³å°†è¦åˆ›å»ºçš„ç›®æ ‡ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œtarget åé¢ç´§è·Ÿä¸€ä¸ªå†’å·ï¼Œprerequisite æ˜¯ç”Ÿæˆè¯¥ç›®æ ‡æ‰€éœ€è¦çš„æºæ–‡ä»¶ï¼ˆä¾èµ–ï¼‰ï¼Œä¸€ä¸ªç›®æ ‡æ‰€ä¾èµ–çš„æ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªï¼Œä¾èµ–æ–‡ä»¶ä¸ç›®æ ‡ä¹‹é—´ä»¥åŠå„ä¾èµ–æ–‡ä»¶ä¹‹é—´ç”¨ç©ºæ ¼æˆ–åˆ¶è¡¨ç¬¦ Tab éš”å¼€ï¼Œè¿™äº›å…ƒç´ ç»„æˆäº†ä¸€ä¸ªä¾èµ–å…³ç³»ã€‚éšåçš„å‘½ä»¤ command å°±æ˜¯è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯ make éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„çš„ shell å‘½ä»¤ã€‚å¦å¤–ï¼Œmakefile æ–‡ä»¶ä¸­ï¼Œæ³¨é‡Šä»¥ # å·å¼€å¤´ï¼Œä¸€ç›´å»¶ç»­åˆ°è¯¥è¡Œçš„ç»“æŸã€‚\næ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼Œtargetå°±æ˜¯hello, prerequisiteæ˜¯ hello.cçš„æ–‡ä»¶\nhello:  hello.c\t$(CC) -o hello.s -S hello.c\t$(CC) -o hello.o -c hello.s\t$(CC) -o hello hello.o\n\n\næ„å»ºcé¡¹ç›®all: test test: test.o anotherTest.o     gcc -Wall test.o anotherTest.o -o testtest.o: test.c     gcc -c -Wall test.c anotherTest.o: anotherTest.c     gcc -c -Wall anotherTest.c clean:     rm -rf *.o test\n\nGNUçš„makeå·¥ä½œæ—¶çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\n\nè¯»å…¥æ‰€æœ‰çš„Makefileã€‚\nè¯»å…¥è¢«includeçš„å…¶å®ƒMakefileã€‚\nåˆå§‹åŒ–æ–‡ä»¶ä¸­çš„å˜é‡ã€‚\næ¨å¯¼éšæ™¦è§„åˆ™ï¼Œå¹¶åˆ†ææ‰€æœ‰è§„åˆ™ã€‚\nä¸ºæ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶åˆ›å»ºä¾èµ–å…³ç³»é“¾ã€‚\næ ¹æ®ä¾èµ–å…³ç³»ï¼Œå†³å®šå“ªäº›ç›®æ ‡è¦é‡æ–°ç”Ÿæˆã€‚\næ‰§è¡Œç”Ÿæˆå‘½ä»¤ã€‚\n\n1-5æ­¥ä¸ºç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œ6-7ä¸ºç¬¬äºŒä¸ªé˜¶æ®µã€‚ç¬¬ä¸€ä¸ªé˜¶æ®µä¸­ï¼Œå¦‚æœå®šä¹‰çš„å˜é‡è¢«ä½¿ç”¨äº†ï¼Œé‚£ä¹ˆï¼Œmakeä¼šæŠŠå…¶å±•å¼€åœ¨ä½¿ç”¨çš„ä½ç½®ã€‚ä½†makeå¹¶ä¸ä¼šå®Œå…¨é©¬ä¸Šå±•å¼€ï¼Œmakeä½¿ç”¨çš„æ˜¯æ‹–å»¶æˆ˜æœ¯ï¼Œå¦‚æœå˜é‡å‡ºç°åœ¨ä¾èµ–å…³ç³»çš„è§„åˆ™ä¸­ï¼Œé‚£ä¹ˆä»…å½“è¿™æ¡ä¾èµ–è¢«å†³å®šè¦ä½¿ç”¨äº†ï¼Œå˜é‡æ‰ä¼šåœ¨å…¶å†…éƒ¨å±•å¼€ã€‚\nå½“ç„¶ï¼Œè¿™ä¸ªå·¥ä½œæ–¹å¼ä½ ä¸ä¸€å®šè¦æ¸…æ¥šï¼Œä½†æ˜¯çŸ¥é“è¿™ä¸ªæ–¹å¼ä½ ä¹Ÿä¼šå¯¹makeæ›´ä¸ºç†Ÿæ‚‰ã€‚æœ‰äº†è¿™ä¸ªåŸºç¡€ï¼Œåç»­éƒ¨åˆ†ä¹Ÿå°±å®¹æ˜“çœ‹æ‡‚äº†ã€‚\nç”³æ˜å˜é‡\n= ç±»ä¼¼å®ä¸€æ ·ï¼Œä»–ä¼šå¯¹å˜é‡è¿›è¡Œå¼•ç”¨ï¼Œåœ¨æ‰§è¡Œæ—¶æ‰©å±•ï¼Œå…è®¸é€’å½’æ‰©å±•\n:= å¦‚æœå˜é‡ç”³æ˜ç¬¦åˆå…ˆæ¥ååˆ°ï¼Œå’Œ =å«ä¹‰ä¸€æ ·ï¼Œä½†æ˜¯å¦‚æœ ç”³æ˜aå¼•ç”¨äº†bä½†æ˜¯bè¿˜æ²¡æœ‰ç”³æ˜ï¼Œæ­¤æ—¶è®¤ä¸ºbä¸ºç©º\n\na = $(b) + 1b = 2c := $(d) + 1d = 2all:\t@echo $(a)\t@echo $(c)\n\nè¾“å‡º\nâœ  makefile git:(master) âœ— make2 + 1+ 1\nå¥‡æ€ªçš„ç°è±¡ï¼š å¯ä»¥å‘ç°æˆ‘ä»¬ç”³æ˜aå˜é‡åï¼Œä½†æ˜¯è¾“å‡ºçš„æ—¶å€™å´æ˜¯ 100 ï¼Œå¯ä»¥å‘ç°cliä¼ é€’çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸å¯ä»¥è¢«è¦†ç›–\nâœ  makefile git:(master) âœ— make a=100        100+ 1\n\n\n\n?= å¦‚æœaå˜é‡å‰é¢å·²ç»ç”³æ˜è¿‡äº†ï¼Œé‚£ä¹ˆåé¢ a ?= xxx åˆ™å› ä¸ºå‰é¢å·²ç»ç”³æ˜äº†aï¼Œæ‰€ä»¥ä¸è¿›è¡Œèµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯ a?=xxxxæ— æ•ˆï¼Œå¦‚æœå‰é¢æ²¡æœ‰ç”³æ˜åˆ™æœ‰æ•ˆ\n\nA = helloA ?= hello worldall:\t@echo $(A)\n\nè¾“å‡ºï¼šhello\n\n+= è¿™ä¸ªç±»ä¼¼äº a+=1 ï¼Œ æ„æ€å°±æ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Š += ï¼Œå¾ˆæ–¹ä¾¿ï¼Œä¸‹é¢æä¾›demo\n\nbuild_args := -raceifeq ($(vendor),true)\tbuild_args += -mod=vendorendifall:\t@echo $(build_args)\n\nè¾“å‡ºï¼š\nâœ  makefile git:(master) âœ— make vendor=true-race -mod=vendor\n\nå‘½ä»¤è¡Œå‚æ•°echo:\t@echo $(arg)\n\næ‰§è¡Œï¼š\nâœ  makefile git:(master) âœ— make arg=ruoyuruoyu\n\næ‰§è¡Œå‡½æ•°1ã€call + define å®å®šä¹‰ç±»ä¼¼äºCè¯­è¨€çš„å®å®šä¹‰\n# ç¼–è¯‘ç”Ÿæˆåˆ°binç›®å½•ä¸‹define build    sh ./build.sh $(1) ./bin/$(strip $(2))endef# è„šæ‰‹æ¶è„šæœ¬go-build: pre\t$(call build, cmd/go-build/main.go, go-build)\n\n2ã€è‡ªå¸¦å‡½æ•°\nâ€‹    æ ¼å¼ $(&lt;å‘½ä»¤&gt; &lt;å‚æ•°&gt;)\n\nall:\t@echo $(lastword 1 2 3)\n\nè¾“å‡º\nâœ  makefile git:(master) âœ— make3\n\n3ã€è°ƒç”¨shellå‡½æ•°all:\t@echo $(shell dirname /data/test)\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make/data\n\nMakefileæ–‡ä»¶çš„è¯­æ³•&lt;target&gt; : &lt;prerequisites&gt; [tab]  &lt;commands&gt;\n\n\ntarget: ç›®æ ‡ï¼Œæ”¯æŒæ¨¡å¼åŒ¹é…\nprerequisitesï¼šå‰ç½®æ¡ä»¶ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œæ”¯æŒæ¨¡å¼åŒ¹é…\ncommands: å‰é¢å¿…é¡»æœ‰ tab ï¼Œæ˜¯shellå‘½ä»¤/makefileå‡½æ•°å‘½ä»¤\n\n1ã€æ³¨é‡Šâ€‹        æ³¨é‡Šä¸€èˆ¬ä½¿ç”¨ # å¼€å¤´è¡¨ç¤ºï¼Œä½†æ˜¯å¦‚æœæ³¨é‡Šåœ¨ç›®æ ‡çš„å‘½ä»¤åŒ…å«\n# ä¸€èˆ¬allå®šä¹‰äº†å…¨éƒ¨all:\t#hello\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make#hello\n\n2ã€å…³é—­å›å£°è¿™ä¸ªå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œshellå‘½ä»¤çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šæ‰“å°æ—¥å¿—ï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº†å¾ˆå¥½çš„è§£å†³æ–¹å¼ï¼Œä½¿ç”¨ @ ç¬¦å·\nall:\techo &quot;hello world&quot;\n\næ‰§è¡Œåä¼šå‘ç°ï¼Œæ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šæ‰“å°å›å£°\nâœ  makefile git:(master) âœ— makeecho &quot;hello world&quot;hello world\n\næ‰€ä»¥å¯ä»¥å°†makefileæ–‡ä»¶æ”¹æˆä»¥ä¸‹\nall:\t@echo &quot;hello world&quot;\n\nè¾“å‡º\nâœ  makefile git:(master) âœ— makehello world\n\n3ã€é€šé…ç¬¦â€‹    å’Œbashä¸€æ ·ï¼Œä¸»è¦æœ‰ * ç­‰é€šé…ç¬¦ï¼Œä¸»è¦æ˜¯åœ¨ shellè„šæœ¬ä¸­ä½¿ç”¨\nnew:\tfor x in &#123;1,2,3,4&#125;;do touch $$x.test ;doneclean:\t$(RM) *.test\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make new for x in &#123;1,2,3,4&#125;;do touch $x.test ;doneâœ  makefile git:(master) âœ— ls | grep test1.test2.test3.test4.testâœ  makefile git:(master) âœ— make clean rm -f *.testâœ  makefile git:(master) âœ— ls | grep test\n\n4ã€æ¨¡å¼åŒ¹é…ä¸»è¦æ˜¯å¯¹æ–‡ä»¶åçš„æ”¯æŒï¼ä¸»è¦æ˜¯åœ¨ ç›®æ ‡å’Œä¾èµ–ä¸­ä½¿ç”¨, ä½¿ç”¨åŒ¹é…ç¬¦%ï¼Œå¯ä»¥å°†å¤§é‡åŒç±»å‹çš„æ–‡ä»¶ï¼Œåªç”¨ä¸€æ¡è§„åˆ™å°±å®Œæˆæ„å»ºã€‚\n%.o: %.c\n\nç­‰åŒäº\nf1.o: f1.cf2.o: f2.c\n\nä¸æ‡‚çš„å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œå¯¹æ¯”ä¸€ä¸‹ æ¨¡å¼åŒ¹é…å’Œé€šé…ç¬¦çš„åŒºåˆ« :   https://blog.csdn.net/BobYuan888/article/details/88640923\nç†è§£æ¨¡å¼åŒ¹é…å¿…é¡»äº†è§£ä¸‹é¢è¿™å››ä¸ª\n$@ï¼šç›®æ ‡çš„åå­—\n$^ï¼šæ„é€ æ‰€éœ€æ–‡ä»¶åˆ—è¡¨æ‰€æœ‰æ‰€æœ‰æ–‡ä»¶çš„åå­—\n$&lt;ï¼šæ„é€ æ‰€éœ€æ–‡ä»¶åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„åå­—\n$?ï¼šæ„é€ æ‰€éœ€æ–‡ä»¶åˆ—è¡¨ä¸­æ›´æ–°è¿‡çš„æ–‡ä»¶\nå¤§è‡´åŸç†ï¼š\n\næˆ‘è¦æ‰¾f1.oçš„æ„é€ è§„åˆ™ï¼Œçœ‹çœ‹Makefileä¸­é‚£ä¸ªè§„åˆ™ç¬¦åˆã€‚\nç„¶åæ‰¾åˆ°äº†%.o:%.c\næ¥å¥—ä¸€ä¸‹æ¥å¥—ä¸€ä¸‹\n %.o å’Œæˆ‘è¦æ‰¾çš„ f1.o åŒ¹é…\nå¥—ä¸Šäº†ï¼Œå¾—åˆ°%=f1ã€‚\næ‰€ä»¥åœ¨åé¢çš„%.cå°±è¡¨ç¤ºf1.cäº†ã€‚\nOKè¿›è¡Œæ„é€ \n\n1ã€ä¾‹å­ä¸€ï¼ˆç¼–è¯‘cæ–‡ä»¶ï¼‰\n%.o: %.c %.h\t@echo &quot;ç›®æ ‡çš„åå­—: $@, ä¾èµ–çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶: $&lt; , ä¾èµ–çš„å…¨éƒ¨æ–‡ä»¶: $^, æ‰€æ›´æ–°çš„æ–‡ä»¶: $?&quot;\t$(CC) -o $@ -c $&lt;all: utils.o\t@echo &quot;ç¼–è¯‘ã€‚ã€‚ã€‚&quot;\tclean:\t$(RM) *.i *.s *.o main\n\næ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°å®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„ä¾‹å­\nç›®æ ‡çš„åå­—: utils.o, ä¾èµ–çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶: utils.c , ä¾èµ–çš„å…¨éƒ¨æ–‡ä»¶: utils.c utils.h, æ‰€æ›´æ–°çš„æ–‡ä»¶: utils.c utils.hcc -o utils.o -c utils.cç¼–è¯‘ã€‚ã€‚ã€‚\n\nforå¾ªç¯1ã€makefile: foreachå¾ªç¯è¯­æ³•ï¼š $(foreach &lt;var&gt;, $(g_var), &lt;command1&gt;;&lt;command2&gt;) ï¼Œ è¿™é‡Œéœ€è¦å˜é‡å¼•ç”¨éœ€è¦ä½¿ç”¨ $()\nlist := $(shell ls)all:\t@$(foreach item,$(list),\\\t\techo $(item);\\\t\techo $(realpath $(item));\\\t\techo &quot;====================&quot;;\\\t)\n\nè¾“å‡ºï¼š\nâœ  makefile git:(master) âœ— makeMakefile/Users/fanhaodong/note/note/demo/makefile/Makefile====================Makefile1/Users/fanhaodong/note/note/demo/makefile/Makefile1====================Makefile2/Users/fanhaodong/note/note/demo/makefile/Makefile2====================\n\n3ã€shellï¼šfor å¾ªç¯list := $(shell ls)all:\t@for x in $(list); do\\\t\techo $$x;\\\tdone\n\nè®°ä½ä¸€ç‚¹å°±å¥½ï¼Œ $ ç¬¦å·è½¬ç§»éœ€è¦ä½¿ç”¨ $$\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make mfor MakefileMakefile1Makefile2a.makeb.make\n\nif å‡½æ•°1ã€makefile: if å‡½æ•°å‘½ä»¤æ ¼å¼ï¼š $(if &lt;condition&gt;, &lt;yes do1&gt;;&lt;yes do2&gt;, &lt;no do1&gt;;&lt;no do2&gt;)\nall:\t@$(if $(shell command -v $(arg)),echo command $(arg) is exist,echo command $(arg) is not exist)\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make arg=gocommand go is existâœ  makefile git:(master) âœ— make arg=go1command go1 is not exist\n\n2ã€shell: if å‡½æ•°all:\t@if [ `command -v $(arg)` ];then\\\t\techo &quot;command [$(arg)] is exist&quot;;\\\telse \\\t\techo &quot;command [$(arg)] is not exist&quot;;\\\tfi\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make arg=gocommand [go] is existâœ  makefile git:(master) âœ— make arg=go1command [go1] is not exist\n\næ‰§è¡Œå¤šä¸ªå‘½ä»¤echo:\t@echo hello worldecho2:\t@echo hello world 2\t\n\næ‰§è¡Œï¼š\nâœ  makefile git:(master) âœ— make echo echo2hello worldhello world 2\n\nå®å®šä¹‰define echo\techo &quot;hello, $(1)!&quot;endefARG := ifdef arg\tARG := $(arg)else\tARG := NULLendif\tall: print\t@$(call echo,&quot;world&quot;)\t@echo $(ARG)print:\t@echo &quot;arg: $(arg)&quot;\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— make arg=worldarg: worldhello, world!world\n\nç³»ç»Ÿç¯å¢ƒå˜é‡ç”³æ˜æ¨èï¼š export &lt;å˜é‡åç§°&gt;  ï¼Œ è·å–ä½¿ç”¨ $&#123;&lt;å˜é‡åç§°&gt;&#125;\nGOPROXY := https://goproxy.cn,directexport GOPROXYall:\t@echo $&#123;GOPROXY&#125;\n\nç¼–è¯‘Cé¡¹ç›®cé¡¹ç›®å¾€å¾€å¾ˆå¤æ‚ï¼Œè®¾è®¡åˆ° é¢„ç¼–è¯‘ï¼Œç¼–è¯‘ï¼Œæ±‡ç¼–ï¼Œé“¾æ¥ çš„è¿‡ç¨‹\n\n1ã€æ–‡ä»¶ (å¤´æ–‡ä»¶ã€mainæ–‡ä»¶)1ã€utils.h\n#ifndef _ADD_H_#define _ADD_H_int add (int a,int b);#endif\n\n2ã€utils.c\nint add(int x ,int y)&#123;    return x+y;&#125;\n\n3ã€main.c\næ³¨æ„ï¼šå¤´æ–‡ä»¶çš„å¯»æ‰¾æ–¹å¼\n\nå…ˆæœç´¢å½“å‰ç›®å½•\nç„¶åæœç´¢-IæŒ‡å®šçš„ç›®å½•,ä¾‹å¦‚ -I ./head\nå†æœç´¢gccçš„ç¯å¢ƒå˜é‡CPLUS_INCLUDE_PATHï¼ˆCç¨‹åºä½¿ç”¨çš„æ˜¯C_INCLUDE_PATHï¼‰\næœ€åæœç´¢gccçš„å†…å®šç›®å½•\n\n#include &lt;stdio.h&gt;#include &quot;utils.h&quot;int main(int argc, char const *argv[])&#123;    printf(&quot;1+2 = %d\\n&quot;,add(1,2));    return 0;&#125;\n\nå‡å¦‚ .h æ–‡ä»¶æ”¾åœ¨ head ç›®å½•\nâœ  cpp git:(master) âœ— ls head utils.h# å¯ä»¥å‘ç°ç¼–è¯‘å¼‚å¸¸ï¼Œå¼‚å¸¸æ—¶ .hæ–‡ä»¶æœªæ‰¾åˆ°âœ  cpp git:(master) âœ— gcc -c main.c -o main.omain.c:2:10: fatal error: &#x27;utils.h&#x27; file not found#include &quot;utils.h&quot;         ^~~~~~~~~1 error generated.# ä¿®æ”¹ -I å‚æ•°å¯ä»¥å‘ç°é€šè¿‡âœ  cpp git:(master) âœ— gcc -I ./head  -c main.c -o main.oâœ  cpp git:(master) âœ— ls | grep main.omain.o\n\n2ã€é¢„ç¼–è¯‘ -E-Eï¼šé¢„ç¼–è¯‘ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯å°†å¤´æ–‡ä»¶ï¼Œå®å®šä¹‰å±•å¼€åˆ°æ–‡ä»¶ï¼Œæ˜¯æ–‡æœ¬å½¢å¼\nâœ  cpp git:(master) âœ— gcc -E main.c -o main.iâœ  cpp git:(master) âœ— tail -f 10 main.i tail: 10: No such file or directory==&gt; main.i &lt;==### å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æŠŠ utils.h çš„å¤´æ–‡ä»¶ä¿¡æ¯ copy è¿‡æ¥äº†int add (int a,int b);# 3 &quot;main.c&quot; 2int main(int argc, char const *argv[])&#123;    printf(&quot;1+2 = %d\\n&quot;,add(1,2));    return 0;&#125;\n\n3ã€ç¼–è¯‘ -S\nç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç ï¼Œæ˜¯æ–‡æœ¬å½¢å¼\n\nâœ  cpp git:(master) âœ— gcc -S main.i -o main.s\n\n\n4ã€æ±‡ç¼– -c\nâ€‹    å°±æ˜¯ç¼–è¯‘æˆäºŒè¿›åˆ¶çš„æ±‡ç¼–æ–‡ä»¶ï¼Œæ˜¯å¯é‡å®šä½ç›®æ ‡ç¨‹åºï¼Œå±äºäºŒè¿›åˆ¶æ–‡ä»¶\n\nâœ  cpp git:(master) âœ— gcc -c main.s -o main.oâœ  cpp git:(master) âœ— hexdump -C main.o00000000  cf fa ed fe 07 00 00 01  03 00 00 00 01 00 00 00  |................|00000010  04 00 00 00 08 02 00 00  00 20 00 00 00 00 00 00  |......... ......|00000020  19 00 00 00 88 01 00 00  00 00 00 00 00 00 00 00  |................|00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|00000040  b0 00 00 00 00 00 00 00  28 02 00 00 00 00 00 00  |........(.......|00000050  b0 00 00 00 00 00 00 00  07 00 00 00 07 00 00 00  |................|00000060  04 00 00 00 00 00 00 00  5f 5f 74 65 78 74 00 00  |........__text..|00000070  00 00 00 00 00 00 00 00  5f 5f 54 45 58 54 00 00  |........__TEXT..|00000080  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|00000090  42 00 00 00 00 00 00 00  28 02 00 00 04 00 00 00  |B.......(.......|000000a0  d8 02 00 00 03 00 00 00  00 04 00 80 00 00 00 00  |................|âœ  cpp git:(master) âœ— objdump -d main.omain.o: file format Mach-O 64-bit x86-64Disassembly of section __TEXT,__text:0000000000000000 _main:       0: 55                            pushq   %rbp       1: 48 89 e5                      movq    %rsp, %rbp       4: 48 83 ec 20                   subq    $32, %rsp       8: c7 45 fc 00 00 00 00          movl    $0, -4(%rbp)       f: 89 7d f8                      movl    %edi, -8(%rbp)      12: 48 89 75 f0                   movq    %rsi, -16(%rbp)      16: bf 01 00 00 00                movl    $1, %edi      1b: be 02 00 00 00                movl    $2, %esi      20: e8 00 00 00 00                callq   0 &lt;_main+0x25&gt;      25: 48 8d 3d 16 00 00 00          leaq    22(%rip), %rdi      2c: 89 c6                         movl    %eax, %esi      2e: b0 00                         movb    $0, %al      30: e8 00 00 00 00                callq   0 &lt;_main+0x35&gt;      35: 31 c9                         xorl    %ecx, %ecx      37: 89 45 ec                      movl    %eax, -20(%rbp)      3a: 89 c8                         movl    %ecx, %eax      3c: 48 83 c4 20                   addq    $32, %rsp      40: 5d                            popq    %rbp      41: c3                            retq\n\n5ã€é“¾æ¥å¯¹äºc/cppè¯­è¨€æ¥è¯´ï¼Œæœ€éš¾çš„å°±æ˜¯é“¾æ¥äº†ï¼è¿™é‡Œä¹Ÿè®¾è®¡åˆ°éšæ™¦è§„åˆ™äº†ï¼Œé¦–å…ˆ .o æ˜¯ç¬¦åˆ main.o, utils.oçš„ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ ä¸¤æ¬¡ ccï¼Œæœ€ç»ˆé“¾æ¥æˆåŠŸ\n# ä¼ªç›®æ ‡,è¿™é‡Œå®šä¹‰çš„ç›®æ ‡ä¸ä¼šå»æ–‡ä»¶ç³»ç»Ÿé‡Œå¯»æ‰¾.PHONY: all clean# CC å±äºmakefileçš„å…¨å±€å˜é‡ï¼Œå·²ç»å®šä¹‰å¥½äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨gccéœ€è¦æŒ‡å®šCC := gcc# $@ ç›®å‰çš„ç›®æ ‡é¡¹ç›®åç§° ä¹Ÿå°±æ˜¯ %.o# $&lt; ç›®å‰çš„ä¾èµ–é¡¹ç›®%.o: %.c\t$(CC) -c $&lt; -o $@all: install run clean# å½“ä¾èµ–ç¬¦åˆæ¨¡å¼åŒ¹é…æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸Šé¢çš„ %.o: %.cinstall: utils.o main.o\tgcc -o main utils.o main.orun:\t./mainclean:\t$(RM) *.i *.s *.o main\n\næ‰§è¡Œ\nâœ  cpp git:(master) âœ— makegcc -c utils.c -o utils.ogcc -c main.c -o main.ogcc -o main utils.o main.o./main1+2 = 3rm -f *.i *.s *.o main\n\nå¸®åŠ©å¦‚æœä½ æƒ³å†™helpï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢é‚£ä¸ªè¡¨è¾¾å¼\n.PHONY: helpecho: ## æ‰“å°echo\t@echo &quot;hello&quot;all: ## æ‰“å°echo1help: ## å¸®åŠ©\t@awk &#x27;BEGIN &#123;FS = &quot;:.*?## &quot;&#125; /^[a-zA-Z_-]+:.*?## / &#123;sub(&quot;\\\\\\\\n&quot;,sprintf(&quot;\\n%22c&quot;,&quot; &quot;), $$2);printf &quot; \\033[36m%-20s\\033[0m  %s\\n&quot;, $$1, $$2&#125;&#x27; $(MAKEFILE_LIST)\n\nå…¶å®å¾ˆç®€å•ï¼Œäº†è§£ awk è¯­æ³•çš„è¯ï¼ŒçŸ¥é“  awk &#39;æ¡ä»¶ åŠ¨ä½œ&#39; æ–‡ä»¶å æ‰€è°“æ¡ä»¶å°±æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ†éš”ç¬¦æ˜¯:.*?## ï¼Œç„¶ååŒ¹é…çš„æ¡ä»¶æ˜¯ä»¥  å­—æ¯å¼€å¤´çš„\n[root@19096dee708b data]# cat demo.txt11 2211122 33\n\nåŒ¹é…ä¸€ä¸‹Â·\n[root@19096dee708b data]# awk  &#x27;&#123;printf &quot;$1=%s $2=%s\\n&quot;,$1,$2&#125;&#x27; demo.txt$1=11 $2=22$1=111 $2=$1=22 $2=33\n\næˆ‘ä»¬è¦æ‹¿åˆ°æˆ‘ä»¬çš„ç»“æœï¼æ‰€ä»¥éœ€è¦åŒ¹é…æœ‰ç©ºæ ¼çš„ï¼ŒåŒ¹é…ç©ºæ ¼å°±æ˜¯ \\s\n[root@19096dee708b data]# awk  &#x27;/\\s/ &#123;printf &quot;$1=%s $2=%s\\n&quot;,$1,$2&#125;&#x27; demo.txt$1=11 $2=22$1=22 $2=33\n\n\n\n","categories":["Linux"],"tags":["Makefile"]},{"title":"shellæŠ€å·§ä»‹ç»","url":"/2021/03/01/bfb83a0f198dea6e73567268963f4e9b/","content":"â€‹        Shell è„šæœ¬åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘å’Œå­¦ä¹ éƒ½æœ‰ä¸¾è¶³è½»é‡çš„åœ°ä½ï¼Œæ¯”å¦‚çœ‹ä¸€äº›å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚é¡¹ç›®ä¸­çš„å„å¼å„æ ·çš„è„šæœ¬ï¼Œå¯¹äºä¿ƒè¿›ç”Ÿäº§åŠ›å·¥å…·æœ‰å¾ˆå¤§å¸®åŠ©ï¼è€Œä¸”shellæœ€å¤§çš„å¥½å¤„å°±æ˜¯ä¾èµ–æ¯”è¾ƒå°ï¼Œç›´æ¥å¯ä»¥è¿è¡Œï¼ æ—¥å¸¸ä¸­æ¨èç”¨bashï¼Œä¸æ¨èç”¨shï¼\n\n\n1ã€å‘½ä»¤å°æŠ€å·§1ã€-x å‘½ä»¤è¿›è¡Œè·Ÿè¸ªè°ƒè¯•æ‰§è¡Œ#!/bin/shnum1=10num2=20if (($num1 &lt;= $num2)); then    echo num1 lesser equal num2else    echo num1 greater num2fi\n\næ‰§è¡Œï¼š\nâœ  note git:(master) âœ— sh -x /Users/fanhaodong/Desktop/project/test.sh+ num1=10+ num2=20+ (( 10 &lt;= 20 ))+ echo num1 lesser equal num2num1 lesser equal num2\n\n2ã€-c å‘½ä»¤ ï¼ˆæ‰§è¡Œå‘½ä»¤å‚æ•°ï¼‰âœ  note git:(master) âœ— sh -c &lt;&lt; EOF &quot;dquote&gt; echo hello worlddquote&gt; echo hello world2dquote&gt; &quot;heredoc&gt; EOFhello worldhello world2\n\n\nè¿™ç§ç»å¸¸ä¼šåœ¨ç½‘ä¸Šä¸‹è½½ä¸€ä¸ªè„šæœ¬ç„¶åç›´æ¥æ‰§è¡Œï¼Œå¯ä»¥ sh -c &quot;curl xxxx.sh&quot;\n\n3ã€ä½¿ç”¨setå˜é‡ä¸€èˆ¬å°±æ˜¯ set -ex ï¼Œæˆ–è€…æ‰§è¡Œçš„æ—¶å€™ bash -ex\n#!/bin/sh# -v  Print shell input lines as they are read.# -x  Print commands and their arguments as they are executed.# -e  Exit immediately if a command exits with a non-zero status.set -execho &quot;hello world&quot;exit 1\n\næ‰§è¡Œ\nâœ  makefile git:(master) âœ— sh ./main.sh+ echo &#x27;hello world&#x27;hello world+ exit 1âœ  makefile git:(master) âœ— echo $?     1\n\nå¸®åŠ©å¯ä»¥çœ‹ï¼š sh -c &quot;help set&quot;\n2ã€è¯­æ³•å°æŠ€å·§1ã€å¼•ç”¨å˜é‡ä¸€èˆ¬æ¨èæ­£ç¡®ç”¨æ³•æ˜¯ï¼Œå˜é‡ä½¿ç”¨ &quot;&quot; åŒå¼•å·å¼•ç”¨ï¼Œå…¶æ¬¡å°±æ˜¯å˜é‡ä½¿ç”¨ $&#123;&#125;è¿›è¡Œå¼•ç”¨ï¼very goodï¼\n# ä½¿ç”¨ $&#123;&#125; å¼•ç”¨å˜é‡ï¼Œæ‹’ç»æ­§ä¹‰âœ  ~ data=&quot;hello&quot; ;echo $dataaâœ  ~ data=&quot;hello&quot; ;echo $&#123;data&#125;ahelloa# å­—ç¬¦ä¸²ç”¨ &quot;&quot; å¼•ç”¨âœ  ~ data=&quot;hello &quot; ;echo &quot;$&#123;data&#125;a&quot;hello aâœ  ~ data=hello  ;echo &quot;$&#123;data&#125;a&quot;helloa# å•å¼•å·ä¸ä¼šè¿›è¡Œå˜é‡èµ‹å€¼ (æ³¨æ„)âœ  ~ data=hello  ;echo &#x27;$&#123;data&#125;a&#x27;$&#123;data&#125;a\n\n2ã€ $( cmd ) å’Œ `cmd`  æ‰§è¡Œå‘½ä»¤âœ  ~ echo $(uname)Darwinâœ  ~ echo `uname`Darwin\n\n3ã€ cat [&gt;&gt;|&gt;] [file] &lt;&lt; EOF  .... EOF å†™å…¥æ–‡ä»¶\nå¦‚æœé‡å®šå‘çš„æ“ä½œç¬¦æ˜¯&lt;&lt;-ï¼Œé‚£ä¹ˆåˆ†ç•Œç¬¦ï¼ˆEOFï¼‰æ‰€åœ¨è¡Œçš„å¼€å¤´éƒ¨åˆ†çš„åˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰éƒ½å°†è¢«å»é™¤ã€‚è¿™å¯ä»¥è§£å†³ç”±äºè„šæœ¬ä¸­çš„è‡ªç„¶ç¼©è¿›äº§ç”Ÿçš„åˆ¶è¡¨ç¬¦ã€‚\n\nâœ  test cat &gt; glide.yaml &lt;&lt; EOFheredoc&gt; name: tomheredoc&gt; age: 10heredoc&gt; hobby:heredoc&gt; - footballheredoc&gt; EOFâœ  test cat glide.yamlname: tomage: 10hobby:- football\n\n4ã€ç®¡é“ç¬¦ å’Œ xargs1. ç®¡é“ç¬¦ç®¡é“ç¬¦ä½œç”¨å°±æ˜¯æŠŠä¸Šä¸€ä¸ªå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤ä¸ªæ ‡å‡†è¾“å…¥\nâœ  echo &quot;hello wrold&quot; | python -c &#x27;import sys; print(sys.stdin.read())&#x27;hello wrold\n\n2. xargs1 .xargsçš„ä½œç”¨å°±æ˜¯æŠŠä¸Šä¸ªå‘½ä»¤çš„æ ‡å‡†è¾“å‡º  ä½œä¸º ä¸‹ä¸€ä¸ªå‘½ä»¤çš„å‚æ•° \nâœ  echo &quot;hello wrold&quot; | xargs python -c &#x27;import sys; print(sys.argv)&#x27;[&#x27;-c&#x27;, &#x27;hello&#x27;, &#x27;wrold&#x27;]\n\n\nå¦‚æœæƒ³æ›¿æ¢åˆ†éš”ç¬¦å·éœ€è¦è¾“å…¥å‚æ•° -d, åŒæ—¶ä½ æƒ³æ‰“å°æ‰€æ‰§è¡Œçš„å‘½ä»¤ -t\n\nâœ  ~ echo &quot;hello:wrold&quot; | xargs -t -d &#x27;:&#x27; python -c &#x27;import sys; print(sys.argv)&#x27;python -c &#x27;import sys; print(sys.argv)&#x27; hello &#x27;wrold&#x27;$&#x27;\\n&#x27;[&#x27;-c&#x27;, &#x27;hello&#x27;, &#x27;wrold\\n&#x27;]# ä¸Šé¢å¸¦\\nçš„åŸå› æ˜¯echoé»˜è®¤æ¢è¡Œï¼Œéœ€è¦âœ  ~ echo -e &quot;hello:wrold\\c&quot; | xargs -d &#x27;:&#x27; python -c &#x27;import sys; print(sys.argv)&#x27;[&#x27;-c&#x27;, &#x27;hello&#x27;, &#x27;wrold&#x27;]\n\n\nxargs æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æµ‹è¯•**, -Pç­‰äº0è¡¨ç¤ºä¸é™åˆ¶è¿›ç¨‹æ•°**ï¼Œé»˜è®¤æ˜¯1ï¼Œ -nç­‰äº1è¡¨ç¤ºå‚æ•°æŒ‰æ¯ä¸€ä¸ªè¿›è¡Œæ‹†åˆ†\n\n\nâ€‹    è¿™ä¸ªå‘½ä»¤ç›¸å½“æ£’ï¼Œå°±æ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼\n\nâœ  echo &quot;hello world&quot; | xargs -P0 -n1  sh -c &#x27;echo &quot;start $$&quot;; sleep 5s; echo &quot;end $$&quot;&#x27;start 21377start 21378end 21377end 21378\n\n\n-Iï¼Œå¯ä»¥æ›¿æ¢å‘½ä»¤è¡Œå‚æ•°\n\nâœ  ~ echo &quot;hello wrold&quot; | xargs echohello wroldâœ  ~ echo &quot;hello wrold&quot; | xargs -I &#123;&#125;  echo &#123;&#125;hello wrold\n\n5ã€ç‰¹æ®Šå˜é‡\n$0: å½“å‰è„šæœ¬çš„æ–‡ä»¶å\n$[n] : ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„å‚æ•°ã€‚n æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºç¬¬å‡ ä¸ªå‚æ•°ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯$1ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯$2ã€‚\n$#: ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚\n$*: ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„æ‰€æœ‰å‚æ•°\n$@: **ä¼ é€’ç»™è„šæœ¬æˆ–å‡½æ•°çš„æ‰€æœ‰å‚æ•°(æ¨èä½¿ç”¨è¿™ä¸ª)**ï¼Œå½“ä½¿ç”¨ &quot;&quot; åŒå¼•å·å¼•ç”¨æ˜¯ $*ä¼šå˜æˆå­—ç¬¦ä¸²è€Œä¸æ˜¯æ•°ç»„\n$?: ä¸Šä¸ªå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ï¼Œæˆ–å‡½æ•°çš„è¿”å›å€¼ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¤§éƒ¨åˆ†å‘½ä»¤æ‰§è¡ŒæˆåŠŸä¼šè¿”å› 0ï¼Œå¤±è´¥è¿”å› 1ã€‚\n$$: å½“å‰Shellè¿›ç¨‹IDã€‚å¯¹äº Shell è„šæœ¬ï¼Œå°±æ˜¯è¿™äº›è„šæœ¬æ‰€åœ¨çš„è¿›ç¨‹IDã€‚\n$! å­è¿›ç¨‹ID\n\n6ã€[[]] å’Œ [] æ ‡å‡† ä»¥åŠåŸºæœ¬è¯­æ³•è§„èŒƒ#!/bin/bashname=&quot;&quot;# å•æ‹¬å·æ¨èç”¨æŒ‡ä»¤ï¼Œè¿ç®—ç¬¦æ”¯æŒçš„æ¯”è¾ƒåƒåœ¾if [-z $name ]; then    echo &quot;is zero&quot;fi# åŒæ‹¬å·æ”¯æŒè¿ç®—ç¬¦if [[ &quot;$name&quot; == &quot;&quot; ]]; then    echo &quot;is zero&quot;fi\n\nå°½å¯èƒ½çš„ç”¨åŒæ‹¬å·ï¼Œå¯¹äºå­—ç¬¦ä¸²æ¯”è¾ƒè¿™ç§åœºæ™¯ï¼\nå¯¹äºå‘½ä»¤ç¬¦å· -z -eq -gt ç­‰ç”¨å•æ‹¬å·ï¼Œä¸€åŠ³æ°¸é€¸çš„è¯ç”¨åŒæ‹¬å·å°±è¡Œäº†\n7ã€/bin/sh ä¸ /bin/bash çš„åŒºåˆ«/bin/sh ä¸ /bin/bash çš„åŒºåˆ«\n3ã€è·å–å‘½ä»¤ç»“æœ $(cmd)æœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§æ˜¯ $()è¿™ä¸ªå¹¶ä¸æ˜¯æ‰€æœ‰çš„shelléƒ½æ”¯æŒï¼Œä½†æ˜¯æ¯”è¾ƒç›´è§‚ï¼Œ å¦å¤–ä¸€ç§æ˜¯   &quot;``&quot;   ï¼ˆå®ƒå¯æ˜¯é€‚ç”¨æ›´å¤šçš„å¹³å°ï¼‰\n#!/bin/shecho `ls -a /Users/fanhaodong/note`echo $(ls -a /Users/fanhaodong/note)\n\nè¾“å‡ºï¼š\n. .. .DS_Store 1714.jpg docker-rocketmq-cluster gridea-home hexo-home note pdf vuepress-starter. .. .DS_Store 1714.jpg docker-rocketmq-cluster gridea-home hexo-home note pdf vuepress-starter\n\n4ã€è¾“å…¥è¾“å‡ºé‡å®šå‘ 2&gt;&amp;1ä½¿ç”¨ç¨‹åºä¸­ç»å¸¸æœ‰ï¼Œæ ‡å‡†è¾“å‡ºï¼Œä½†æ˜¯è¿˜æœ‰é”™è¯¯è¾“å‡ºï¼Œå› æ­¤éœ€è¦åˆå¹¶åˆ°ä¸€ä¸ªæµä¸­\nå…¶å®Goçš„ç¨‹åºä¸­æ­£æ‰§è¡Œè„šæœ¬çš„æ—¶å€™å¯ä»¥æŒ‡å®šï¼Œæ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡º\ncommand := exec.Command(shell, &quot;-c&quot;, cmd)command.Stdout = os.Stdoutcommand.Stderr = os.Stderr\n\nä½¿ç”¨çš„æ—¶å€™ï¼š\n\né»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºé‡å®šå‘ï¼Œä¸ 1&gt; ç›¸åŒ\n2&gt;&amp;1  æ„æ€æ˜¯æŠŠ æ ‡å‡†é”™è¯¯è¾“å‡º é‡å®šå‘åˆ° æ ‡å‡†è¾“å‡º.\n&amp;&gt;file  æ„æ€æ˜¯æŠŠæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡º éƒ½é‡å®šå‘åˆ°æ–‡ä»¶fileä¸­\n\nä¾‹å¦‚ï¼š\ncommand &gt;out.file  2&gt;&amp;1 &amp;\ncommand &gt;out.fileæ˜¯å°†commandçš„æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°out.fileæ–‡ä»¶ï¼Œå³è¾“å‡ºå†…å®¹ä¸æ‰“å°åˆ°å±å¹•ä¸Šï¼Œè€Œæ˜¯è¾“å‡ºåˆ°out.fileæ–‡ä»¶ä¸­ã€‚2&gt;&amp;1 æ˜¯å°†æ ‡å‡†å‡ºé”™é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œè¿™é‡Œçš„æ ‡å‡†è¾“å‡ºå·²ç»é‡å®šå‘åˆ°äº†out.fileæ–‡ä»¶ï¼Œå³å°†æ ‡å‡†å‡ºé”™ä¹Ÿè¾“å‡ºåˆ°out.fileæ–‡ä»¶ä¸­ã€‚æœ€åä¸€ä¸ª&amp; ï¼Œæ˜¯è®©è¯¥å‘½ä»¤åœ¨åå°æ‰§è¡Œã€‚\nå‚è€ƒhttps://www.cnblogs.com/caolisong/archive/2007/04/25/726896.html\n5ã€Ifè¯­å¥\nâ€‹    if å…¶å®å°±æ˜¯test å‘½ä»¤\n\n1ã€æ ¼å¼\næ¢è¡Œå†™\n\nif [ condition ]; then     # bodyelif [ condition ]; then     # bodyelse     # bodyfi\n\n2ï¼‰éæ¢è¡Œå†™\nif [ -f &quot;/Users/fanhaodong/note/note/Makefile1&quot; ]; then  echo 111 ; echo 222 ;elif [ -f &quot;/Users/fanhaodong/note/note/README.md&quot; ]; then  echo 333 ; echo 4444 ; else  echo 555 ; echo 666 ; fi\n\n2ã€ç»“æœè·å–/åˆ¤æ–­ç»“æœè¾“å‡º0 ï¼Œè¡¨ç¤ºä¸ºçœŸï¼Œå¯ä»¥é€šè¿‡$? æ¥è·å–ç»“æœ\n3ã€ä¾‹å¦‚è°ƒè¯•æ¡ä»¶âœ  note git:(master) âœ— test &quot;abc&quot;!=&quot;def&quot;âœ  note git:(master) âœ— echo $?0\n\n4ã€æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨\nå¦‚æœä½ è¦åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œåªéœ€è¦ -e å³å¯ï¼Œè¾“å‡º0 è¡¨ç¤ºæ–‡ä»¶å­˜åœ¨ ï¼ˆä¸åœ¨åˆ¤æ–­ç±»å‹çš„æ—¶å€™æ¨èä½¿ç”¨è¿™ä¸ªï¼‰\nå¦‚æœä½ è¦åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œåªéœ€è¦ -d å³å¯\nå¦‚æœä½ è¦åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦ä¸ºå¸¸è§„æ–‡ä»¶ ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œåªéœ€è¦-f å³å¯\n-L filename å¦‚æœ filenameä¸ºç¬¦å·é“¾æ¥ï¼Œåˆ™ä¸ºçœŸ\n\n[root@019066c0cd63 ~]# ls -allrwxrwxrwx 1 root root    5 Mar  1 09:49 c.txt -&gt; a.txt[root@019066c0cd63 ~]# [ -L &quot;./c.txt&quot; ][root@019066c0cd63 ~]# echo $?0\n\n\n-r filename å¦‚æœ filenameå¯è¯»ï¼Œåˆ™ä¸ºçœŸ \n-w filename å¦‚æœ filenameå¯å†™ï¼Œåˆ™ä¸ºçœŸ \n-x filename å¦‚æœ filenameå¯æ‰§è¡Œï¼Œåˆ™ä¸ºçœŸ\n-s filename å¦‚æœæ–‡ä»¶é•¿åº¦ä¸ä¸º0ï¼Œåˆ™ä¸ºçœŸ\n-h filename å¦‚æœæ–‡ä»¶æ˜¯è½¯é“¾æ¥ï¼Œåˆ™ä¸ºçœŸ\n\nâœ  note git:(master) âœ— [ -f &quot;/Users/fanhaodong/note/note/Makefile&quot; ]âœ  note git:(master) âœ— echo $?0âœ  note git:(master) âœ— [ -f &quot;/Users/fanhaodong/note/note/Makefile1&quot; ]âœ  note git:(master) âœ— echo $?1\n\n5ã€å­—ç¬¦ä¸²æ“ä½œ\nâ€‹    å­—ç¬¦ä¸²æ¨èåŠ  &quot;&quot; è¿›è¡Œå®šä¹‰\n\n\nåˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º -z (zero)ä¹ˆ\n\n#!/bin/shstr=&quot;&quot;if [ -z &quot;$&#123;str&#125;&quot; ]; then    echo str is emptyfi# str is empty\n\n2ï¼‰åˆ¤æ–­ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒ\n#!/bin/shstr1=&quot;str&quot;str2=&quot;str2&quot;if [ &quot;$str1&quot; = &quot;$str2&quot; ]; then    echo str1 is equal str2else    echo str1 is not equal str2fi# str1 is not equal str2\n\n4ã€æµ‹è¯•ä¸€ä¸ªå‘½ä»¤æ˜¯å¦å­˜åœ¨ command -v $#\n#!/bin/shcmd=goif [ `command -v $cmd` ]; then   echo $cmd command is exists else    echo $cmd command not exists fi# go command is exists\n\n5ã€è·å–å­—ç¬¦ä¸²é•¿åº¦ $&#123;#var&#125;\n#!/bin/shstr=&quot;hello   &quot;  str1=helloecho str çš„é•¿åº¦æ˜¯ $&#123;#str&#125;echo str1 çš„é•¿åº¦æ˜¯ $&#123;#str1&#125;#str çš„é•¿åº¦æ˜¯ 8#str1 çš„é•¿åº¦æ˜¯ 5\n\n6ã€æ•°å­—æ¯”è¾ƒ\n-eq ç­‰äº\n-ne ä¸ç­‰äº\n-gt å¤§äº\n-ge å¤§äºç­‰äº\n-lt å°äº\n-le å°äºç­‰äº\n\n#!/bin/shnum1=10num2=20if (($num1 &lt;= $num2)); then    echo num1 lesser equal num2fiif [ $num1 -le $num2 ]; then    echo num1 lesser equal num2fi# num1 lesser equal num2# num1 lesser equal num2\n\n7ã€shellè„šæœ¬ä¸­ifåˆ¤æ–­â€™-aâ€™ - â€˜-zâ€™å«ä¹‰https://blog.csdn.net/tootsy_you/article/details/95597376\n\n\n\n6ã€æ•°ç»„å’Œå¾ªç¯#!/bin/bash#### æ•°ç»„# 1. å®šä¹‰æ•°ç»„arr=(&quot;00&quot; &quot;11&quot; &quot;22&quot; &quot;33&quot; &quot;44&quot;)# 2. éå†æ•°ç»„for elem in &quot;$&#123;arr[@]&#125;&quot;; do    echo &quot;elem: $&#123;elem&#125;&quot;done# æ•°ç»„åœ¨shellä¸­å®šä¹‰å’Œmapå·®ä¸å¤šï¼Œmapä¹Ÿå¯ä»¥ä½¿ç”¨æ•°ç»„è¿›è¡Œè¡¨è¾¾ï¼Œkey=index, value=elemfor index in &quot;$&#123;!arr[@]&#125;&quot;; do    echo &quot;elem: $&#123;arr[index]&#125;&quot;done# æ ‡å‡†forå¾ªç¯for ((index = 0; index &lt; $&#123;#arr[@]&#125;; index++)); do    echo &quot;elem: $&#123;arr[index]&#125;&quot;done# 3. æ·»åŠ å…ƒç´ arr+=(&quot;55&quot; &quot;66&quot;)echo &quot;len(arr) = $&#123;#arr[@]&#125;&quot;# 4. å…ƒç´ åˆ‡ç‰‡echo &quot;arr[2:4] = $&#123;arr[*]:2:2&#125;&quot;# 5. åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨# $1=want# $2...=arr# æ³¨æ„shellå‡½æ•°å‚æ•°æ²¡æœ‰æ•°ç»„çš„æ¦‚å¿µï¼Œåªèƒ½è¯´ä½ æŠŠå®ƒå±•å¼€æˆå¤šä¸ªå‚æ•°# æ³¨æ„ $@ ä¸ºå‚æ•°ï¼Œ $# ä¸ºå‚æ•°é•¿åº¦function contains() &#123;    # $0 ä¸ºæ‰§è¡Œæ–‡ä»¶    # $1 ... ä¸ºå‚æ•°    want=&quot;$1&quot;    for elem in &quot;$&#123;@:2&#125;&quot;; do        if [ &quot;$elem&quot; == &quot;$want&quot; ]; then return 0; fi    done    return 1&#125;if contains &quot;111&quot; &quot;$&#123;arr[@]&#125;&quot;; then    echo &quot;contains 111&quot;else    echo &quot;not contains 111&quot;fiif contains &quot;11&quot; &quot;$&#123;arr[@]&#125;&quot;; then    echo &quot;contains 11&quot;else    echo &quot;not contains 11&quot;fi\n\n7ã€switch#!/bin/bashname=&quot;$1&quot;case &quot;$name&quot; in    &quot;11 222&quot;| &quot;222 333&quot;)        echo &quot;num is: 11 222| 222 3333&quot;    ;;    44)        echo &quot;name is: 44&quot;    ;;    *)        echo &quot;num is(*): $name&quot;    ;;esac\n\nè¾“å‡º:\nâœ  script git:(master) âœ— bash -e string.sh &quot;11 222&quot; num is: 11 222| 222 3333âœ  script git:(master) âœ— bash -e string.sh &quot;11 222 3333&quot;num is(*): 11 222 3333âœ  script git:(master) âœ— bash -e string.sh &quot;44&quot;         name is: 44\n\n\n\n","categories":["Linux"],"tags":["shell"]},{"title":"Elasticsearch åŸºç¡€ã€æ¦‚å¿µã€åŸç†å­¦ä¹ ","url":"/2021/03/17/cacf73d580b314c8a4c95660b46a7178/","content":"â€‹    esä½œä¸º dbã€æœç´¢ã€alapä»¥åŠæˆç†Ÿçš„ç¤¾åŒºï¼Œå·²ç»è¶Šæ¥è¶Šæˆä¸ºåç«¯æ¯”è¾ƒæˆç†Ÿçš„æŠ€æœ¯æ ˆäº†ï¼Œä¸šåŠ¡ä¸­ç”±äºéœ€è¦å¤§é‡èšåˆæ“ä½œï¼Œæ¥å¼¥è¡¥ä¼ ç»Ÿå…³ç³»å‹æ•°æ®(My-SQL)çš„æ€§èƒ½ä¸è¶³ï¼Œè¡Œæ•°æ®åº“çš„åŠ£åŠ¿ï¼Œå¾€å¾€ä¼šä»¥esä½œä¸ºè¾…åŠ©çš„å­˜å‚¨å·¥å…·ï¼Œå› æ­¤æ·±å…¥å­¦ä¹ esåŸºæœ¬æ¦‚å¿µï¼ŒåŸç†å¯¹äºæ—¥å¸¸å¼€å‘æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼å¯¹äºSQL-Bodyæ¥è¯´ï¼Œesæ”¯æŒSQLè¯­æ³•ï¼Œè¿˜æ˜¯ç›¸å½“ç»™åŠ›çš„ï¼\nâ€‹    ç”±äºæˆ‘ä»¬å…¬å¸esé›†ç¾¤åŸºæœ¬ä½¿ç”¨çš„æ˜¯ 6.8.8ç‰ˆæœ¬ï¼Œæ‰€ä»¥å…¨éƒ¨å­¦ä¹ èµ„æ–™åŸºäºè¿™ä¸ªç‰ˆæœ¬å­¦ä¹ ï¼\n\n\n1ã€å®˜æ–¹æ–‡æ¡£6.8ç‰ˆæœ¬çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ¨èå¤§å®¶å­¦ä¹ çš„æ—¶å€™è¯¦ç»†é˜…è¯»ä¸€ä¸‹ï¼ï¼ ï¼Œ ä¸­æ–‡ç‰ˆå¯èƒ½åªæœ‰2.xç‰ˆæœ¬çš„ï¼\n2ã€dockerå®‰è£…ESç¯å¢ƒ\nâ€‹    è¿™é‡Œä¸å»åšé›†ç¾¤èŠ‚ç‚¹ï¼Œæœ¬æ–‡åªæ˜¯åšç»ƒä¹ ï¼Œæ‰€ä»¥ä¸å»æ­å»ºé‚£ä¹ˆå¤šèŠ‚ç‚¹ï¼(dockeræ˜¯ä¸ªå¥½å·¥å…·ï¼Œå¯¹äºæœ¬åœ°å­¦ä¹ è½¯ä»¶)\n\n# åˆ›å»ºbridgeç½‘ç»œdocker network create elasticsearch# åˆ›å»ºes(signle-node)docker run -d  --rm --name elasticsearch -p 9200:9200 -p 9300:9300 --network elasticsearch -e &quot;discovery.type=single-node&quot; elasticsearch:6.8.8# åˆ›å»ºkibana(web-console)docker run -d --rm --name kibana -p 5601:5601 --network elasticsearch  kibana:6.8.8\n\n3ã€ç›¸å…³æ¦‚å¿µ1ã€ç´¢å¼•\nâ€‹    elastic-search çš„åŸºæœ¬æ¦‚å¿µï¼š ç´¢å¼•(index) -&gt; type(ç±»å‹) -&gt; document(æ–‡æ¡£) -&gt; field (å­—æ®µ) å’Œå…³ç³»å‹æ•°æ®åº“çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n\nRelational    DB    -&gt;    Databases    -&gt;    Tables    -&gt;    Rows    -&gt;    Columns\nElasticsearch    -&gt;    Indices            -&gt;    Types        -&gt;    Documents    -&gt;    Fields\n\nä½†æ˜¯å…¶å®å¼€å‘ä¸Šå®é™…ä¸Šä¸å…è®¸ä¸€ä¸ªç´¢å¼•åˆ›å»ºå¤šä¸ªç±»å‹çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåæœŸesåºŸå¼ƒäº†typeï¼Œæœ€ç»ˆåˆ°8.Xç‰ˆæœ¬åºŸå¼ƒæ‰äº†ï¼åŸå› å…¶å®æ ¹æ®esåº•å±‚æœ‰å…³ï¼Œå½±å“æ£€ç´¢æ•ˆç‡ï¼Œè¿™ä¸ªå’Œeså­˜å‚¨äºLucene çš„å…³ç³»äº†\n\nåœ¨6.xç‰ˆæœ¬åªæ”¯æŒä¸€ä¸ªç´¢å¼•ä¸€ä¸ªtypeï¼Œåœ¨7.xç‰ˆæœ¬ç§»é™¤äº† type ï¼Œ8.xå½»åº•åºŸå¼ƒï¼Œä¸»è¦åŸå› è¿˜æ˜¯å› ä¸ºluceneçš„åº•å±‚è®¾ç½®é—®é¢˜ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/6.8/removal-of-types.html\n\nå¦‚ä½•åˆ›å»ºä¸€ä¸ªç´¢å¼•å‘¢â€‹        é¦–å…ˆå…ˆè¦passæ‰é‚£ç§ç›´æ¥æ’å…¥æ•°æ®è¿›è¡Œåˆ›å»ºç´¢å¼•çš„ï¼Œå¯¹äºçº¿ä¸Šä¸šåŠ¡æ¥è¯´ä¸å…è®¸å¼€å‘è€…å»ä»¥è¿™ç§æ–¹å¼å»åˆ›å»ºç´¢å¼•çš„ï¼Œeså¯ä»¥åšæ§åˆ¶ï¼å…¶æ¬¡å°±æ˜¯åˆ›å»ºç´¢å¼•6.xç‰ˆæœ¬ååªèƒ½åˆ›å»ºä¸€ä¸ªtypeï¼Œæ¨ètypeè®¾ç½®ä¸º _docï¼Œå…¶æ¬¡å°±æ˜¯æŒ‡å®šå±æ€§äº†\nâ€‹        è¿™ä¸ªä¾‹å­æ˜¯åˆ›å»ºä¸€ä¸ªmy_indexç´¢å¼•ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª_doc ç±»å‹ï¼Œå­—æ®µæ˜¯ full_nameï¼Œç±»å‹ä¸º text\nPUT my_index&#123;  &quot;mappings&quot;: &#123;    &quot;_doc&quot;: &#123;      &quot;properties&quot;: &#123;# å±æ€§        &quot;full_name&quot;: &#123; # å­—æ®µåç§°          &quot;type&quot;:  &quot;text&quot; # å­—æ®µå±æ€§æ§åˆ¶ï¼Œå…·ä½“æ ¹æ®å®˜æ–¹é…ç½®èµ°        &#125;      &#125;    &#125;  &#125;&#125;\n\nå…³äºæ›´å¤šç´¢å¼•çš„é…ç½®å¯ä»¥å‚è€ƒï¼šmappingå­—æ®µç±»å‹  å’Œ mapping çš„å­—æ®µå‚æ•°\næ ¸å¿ƒå…³æ³¨çš„å‡ ä¸ªç‚¹å§ï¼Œ1ã€å­—æ®µçš„ç±»å‹ typeï¼Œ2ã€å­—æ®µæ˜¯å¦å¯ä»¥è¢«ç´¢å¼•ï¼ˆé»˜è®¤trueï¼‰ç”±indexæ§åˆ¶ï¼Œ3ã€å­—æ®µçš„åˆ†è¯å™¨ analyzerï¼Œ4ã€fields å±æ€§(textç±»å‹ç‰¹æœ‰çš„)\nç´¢å¼•çš„ç±»å‹ä½¿ç”¨å°±ä¸ä»‹ç»äº†ï¼Œè¿™ä¸ªæ ¹æ®ç»éªŒæœ‰å…³ï¼Œä¸»è¦æœ‰åŸºæœ¬ç±»å‹ï¼Œæ•°ç»„ï¼Œå¯¹è±¡ï¼Œgeoï¼Œ\nä»¥æ—¥å¿—æ”¶é›†æ¥è¯´\n&#123;  &quot;filebeat-xxxxxxx-2021.03.11&quot;: &#123;    &quot;mappings&quot;: &#123;      &quot;doc&quot;: &#123;        &quot;properties&quot;: &#123;          &quot;@timestamp&quot;: &#123;            &quot;type&quot;: &quot;date&quot;          &#125;,          &quot;agent&quot;: &#123;            &quot;type&quot;: &quot;object&quot;          &#125;,          &quot;ecs&quot;: &#123;            &quot;type&quot;: &quot;object&quot;          &#125;,          &quot;fields&quot;: &#123;            &quot;properties&quot;: &#123;              &quot;log_type&quot;: &#123;                &quot;type&quot;: &quot;text&quot;,                &quot;fields&quot;: &#123;                  &quot;keyword&quot;: &#123;                    &quot;type&quot;: &quot;keyword&quot;,                    &quot;ignore_above&quot;: 256                  &#125;                &#125;              &#125;            &#125;          &#125;,          &quot;host&quot;: &#123;            &quot;properties&quot;: &#123;              &quot;name&quot;: &#123;                &quot;type&quot;: &quot;text&quot;,                &quot;fields&quot;: &#123;                  &quot;keyword&quot;: &#123;                    &quot;type&quot;: &quot;keyword&quot;,                    &quot;ignore_above&quot;: 256                  &#125;                &#125;              &#125;            &#125;          &#125;,          &quot;input&quot;: &#123;            &quot;type&quot;: &quot;object&quot;          &#125;,          &quot;log&quot;: &#123;            &quot;properties&quot;: &#123;              &quot;file&quot;: &#123;                &quot;type&quot;: &quot;object&quot;              &#125;            &#125;          &#125;,          &quot;message&quot;: &#123;            &quot;type&quot;: &quot;text&quot;,            &quot;fields&quot;: &#123;              &quot;keyword&quot;: &#123;                &quot;type&quot;: &quot;keyword&quot;,                &quot;ignore_above&quot;: 256              &#125;            &#125;          &#125;        &#125;      &#125;    &#125;  &#125;&#125;\n\næ•°æ®ï¼š\n\n2ã€å­—æ®µä¸šåŠ¡ä¸­é€šå¸¸å…³æ³¨çš„æ˜¯å­—æ®µè®¾ç½®ï¼Œå› ä¸ºå­—æ®µå…³ç³»åˆ°ä½ çš„æ•°æ®ç»“æ„è®¾è®¡ï¼ŒæŒæ¡å¥½esçš„æ•°æ®ç»“æ„å¾ˆé‡è¦ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä¼šå¤§æ¦‚å±•ç¤ºå¦‚ä½•è®¾ç½®ä¸€ä¸ªç»“æ„ä½“\nå¤æ‚å¯¹è±¡å¦‚ä½•å­˜å‚¨/æ£€ç´¢1ã€å­˜å‚¨ä¸»è¦æ˜¯é‡‡ç”¨jsonçš„æ‰å¹³åŒ–\nPUT my_index/_doc/1&#123;   &quot;region&quot;: &quot;US&quot;,  &quot;manager&quot;: &#123;     &quot;age&quot;:     30,    &quot;name&quot;: &#123;       &quot;first&quot;: &quot;John&quot;,      &quot;last&quot;:  &quot;Smith&quot;    &#125;  &#125;&#125;\n\n=&gt; å­˜å‚¨åˆ°esä¸­ç”±äºLuceneæ²¡æœ‰å¯¹è±¡æ£€ç´¢è¿™ç§æ¦‚å¿µï¼Œæ‰€ä»¥ä¼šè¿›è¡Œæ‰å¹³åŒ–å­˜å‚¨\n&#123;  &quot;region&quot;:             &quot;US&quot;,  &quot;manager.age&quot;:        30,  &quot;manager.name.first&quot;: &quot;John&quot;,  &quot;manager.name.last&quot;:  &quot;Smith&quot;&#125;\n\n2ã€æ£€ç´¢çš„è¯å’Œæ™®é€šå­—æ®µåŸºæœ¬å°±æ²¡æœ‰å·®å¼‚äº†ï¼Œåªè¦å‡†å¯»æ‰å¹³åŒ–å­—æ®µè¿›è¡Œæ£€ç´¢\nå‚è€ƒï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/6.8/object.html\nå¯¹è±¡æ•°ç»„å¦‚ä½•å­˜å‚¨/æ£€ç´¢esé‡Œé¢å«åš nested ï¼Œä¸­æ–‡åç§°å«åšåµŒå¥—\nç±»ä¼¼äºä¸‹é¢çš„æ•°ç»„ï¼Œå¯¹äºesæ¥è¯´ï¼Œåˆ°åº•æ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿï¼Ÿï¼Ÿ\nPUT my_index/_doc/1&#123;  &quot;group&quot; : &quot;fans&quot;,  &quot;user&quot; : [     &#123;      &quot;first&quot; : &quot;John&quot;,      &quot;last&quot; :  &quot;Smith&quot;    &#125;,    &#123;      &quot;first&quot; : &quot;Alice&quot;,      &quot;last&quot; :  &quot;White&quot;    &#125;  ]&#125;\n\nesä¼šå°†å…¶å­˜å‚¨ä¸º\n&#123;  &quot;group&quot; :        &quot;fans&quot;,  &quot;user.first&quot; : [ &quot;alice&quot;, &quot;john&quot; ],  &quot;user.last&quot; :  [ &quot;smith&quot;, &quot;white&quot; ]&#125;\n\nå› ä¸ºè¿™é‡Œå°±ä¼šæœ‰ä¸ªé—®é¢˜äº†ï¼Œé‚£ä¹ˆæˆ‘æŸ¥è¯¢å’‹æŸ¥å“‡ï¼Œå¦‚ä½•ç¡®å®šå”¯ä¸€ï¼Œæ¯”å¦‚æŸ¥è¯¢Alice-Smithï¼Œä½†æ˜¯å…¶å®æŸ¥è¯¢å‡ºå†…å®¹\nGET my_index/_search&#123;  &quot;query&quot;: &#123;    &quot;bool&quot;: &#123;      &quot;must&quot;: [        &#123; &quot;match&quot;: &#123; &quot;user.first&quot;: &quot;Alice&quot; &#125;&#125;,        &#123; &quot;match&quot;: &#123; &quot;user.last&quot;:  &quot;Smith&quot; &#125;&#125;      ]    &#125;  &#125;&#125;\n\nfields å­—æ®µçš„ä½œç”¨\nâ€‹    æ˜¯æˆ‘åŸºäºå®˜æ–¹æ–‡æ¡£å¯¹äºè¿™ä¸ªæ¦‚å¿µçš„ç†è§£ï¼Œæ–‡æ¡£: https://www.elastic.co/guide/en/elasticsearch/reference/6.8/multi-fields.html\n\nåŠŸèƒ½ä¸€ï¼šèšåˆ1ã€åŠ å…¥è¦åškeywordäº†ï¼Œæ¯”å¦‚è¯´ä½ çš„æ—¥å¿—å¯èƒ½åˆ†ç±»å‹è®°å½•ï¼Œæ¯”å¦‚è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ±‚æ— æƒé™ï¼Œè¯·æ±‚å‚æ•°é”™è¯¯ï¼Œå¯¹äºè¿™ç§ç®€å•çš„å‚æ•°è¿›è¡Œèšåˆç»Ÿè®¡ï¼Œä½†æ˜¯ç”±äºæ—¥å¿—éœ€è¦åšå…¨æ–‡æ£€ç´¢ï¼Œæ‰€ä»¥ä¸èƒ½è®¾ç½®ä¸º keywordï¼Œè¿™é‡Œå°±ä½¿ç”¨ fields ï¼\nDELETE /my_indexPUT /my_index&#123;  &quot;settings&quot;: &#123;    &quot;number_of_replicas&quot;: 1,    &quot;number_of_shards&quot;: 5  &#125;,   &quot;mappings&quot;:&#123;    &quot;_doc&quot;:&#123;      &quot;properties&quot;:&#123;        &quot;message&quot;:&#123;          &quot;type&quot;:&quot;text&quot;,          &quot;fields&quot;:&#123;            &quot;keyword&quot;: &#123;              &quot;type&quot;: &quot;keyword&quot;,              &quot;ignore_above&quot;: 10            &#125;          &#125;        &#125;      &#125;    &#125;  &#125;&#125;POST /my_index/_doc&#123;  &quot;message&quot;:&quot;è¯·æ±‚è¶…æ—¶&quot;&#125;POST /my_index/_doc&#123;  &quot;message&quot;:&quot;ä¸šåŠ¡æ—¥å¿—ï¼šname: xiaoli, id: 111&quot;&#125;POST /my_index/_doc&#123;  &quot;message&quot;:&quot;è¯·æ±‚æ— æƒé™&quot;&#125;POST /my_index/_doc&#123;  &quot;message&quot;:&quot;è¯·æ±‚å‚æ•°é”™è¯¯&quot;&#125;\n\n2ã€è¿›è¡Œæ£€ç´¢ï¼š\n2.1ã€ä½¿ç”¨kibanaä¼šè‡ªåŠ¨å‘Šè¯‰ä½ keyworkï¼Œè¿›è¡Œèšåˆç»Ÿè®¡\n\n2.2ã€æˆ‘è¿˜å¯ä»¥é€šè¿‡æ—¥å¿—è¿›è¡Œå…¨æ–‡æ£€ç´¢\n\n3ã€ä½†æ˜¯å¯¹äºesæ¥è¯´ï¼Œå¦‚æœä½ æ²¡æœ‰æŒ‡å®šmappingå»åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œ\nPOST /test_index/_doc&#123;  &quot;message&quot;:&quot;hello&quot;&#125;GET /test_index/_mapping&#123;  &quot;test_index&quot; : &#123;    &quot;mappings&quot; : &#123;      &quot;_doc&quot; : &#123;        &quot;properties&quot; : &#123;          &quot;message&quot; : &#123;            &quot;type&quot; : &quot;text&quot;,            &quot;fields&quot; : &#123;              &quot;keyword&quot; : &#123;                &quot;type&quot; : &quot;keyword&quot;,                &quot;ignore_above&quot; : 256              &#125;            &#125;          &#125;        &#125;      &#125;    &#125;  &#125;&#125;\n\nå¯ä»¥çœ‹åˆ°å¯¹äº textç±»å‹ï¼Œé»˜è®¤ä¼šæ”¯æŒ 256ä¸ªå­—ç¬¦çš„keywordï¼Œèšåˆæ£€ç´¢\nåŠŸèƒ½äºŒï¼šåˆ†è¯\nâ€‹    ä¸šåŠ¡ä¸Šä¸€ä¸ªå­—æ®µå¯èƒ½ä½¿ç”¨å¤šç§åˆ†è¯ï¼Œè¿™é‡Œå°±æ”¯æŒåˆ†è¯å±æ€§\n\nPUT my_index&#123;  &quot;mappings&quot;: &#123;    &quot;_doc&quot;: &#123;      &quot;properties&quot;: &#123;        &quot;text&quot;: &#123;           &quot;type&quot;: &quot;text&quot;,          &quot;fields&quot;: &#123;            &quot;english&quot;: &#123;               &quot;type&quot;:     &quot;text&quot;,              &quot;analyzer&quot;: &quot;english&quot;            &#125;          &#125;        &#125;      &#125;    &#125;  &#125;&#125;\n\n3ã€ç›¸å…³æ“ä½œ1ã€æ’å…¥\n\nâ€‹    megacorp è¡¨ç¤ºindexï¼Œemployee è¡¨ç¤ºç±»å‹ï¼Œ3è¡¨ç¤ºid-document\n\nPUT \t/megacorp/employee/3&#123;    &quot;first_name&quot;: &quot;Douglas&quot;,    &quot;last_name&quot;: &quot;Fir&quot;,    &quot;age&quot;: 35,    &quot;about&quot;: &quot;I like to build cabinets&quot;,    &quot;interests&quot;: [        &quot;forestry&quot;    ]&#125;\n\n2ã€æŸ¥è¯¢\nGET \t/megacorp/employee/_search&#123;  &quot;query&quot;: &#123;    &quot;match&quot;: &#123;      &quot;first_name&quot;: &quot;Anthony&quot;    &#125;  &#125;&#125;\n\n3ã€è¿‡æ»¤æŸ¥è¯¢\n\nè¿‡æ»¤æŸ¥è¯¢å·²è¢«å¼ƒç”¨ï¼Œå¹¶åœ¨ES 5.0ä¸­åˆ é™¤ã€‚ç°åœ¨åº”è¯¥ä½¿ç”¨bool / must / filteræŸ¥è¯¢ã€‚\n\n4ã€æ›´æ–°\nPOST /megacorp/employee/3/_update&#123;  &quot;doc&quot;:&#123;    &quot;age&quot;:22,    &quot;deatil&quot;:&quot;my name is ....&quot;  &#125;&#125;\n\nåŠ å…¥æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œä½†æ˜¯è¿™ä¸ªç´¢å¼•çš„mappingä¸å˜\nå¥åº·çŠ¶æ€ï¼šElasticsearch é›†ç¾¤å’Œç´¢å¼•å¥åº·çŠ¶æ€åŠå¸¸è§é”™è¯¯è¯´æ˜\n","categories":["å­˜å‚¨"],"tags":["Elasticsearch"]},{"title":"Protocol Buffersåè®®è®²è§£","url":"/2022/01/16/cc45d69abc6417303d451f43acf099d9/","content":"â€‹     Protobuf ä¸»è¦æ˜¯ä»¥æ•°æ®ç¼–ç å°ä¸ºè‘—åï¼Œä¸»è¦æ˜¯ç”¨äºæ•°æ®äº¤äº’å’Œæ•°æ®å­˜å‚¨ç­‰ï¼Œé™ä½å¸¦å®½ã€ç£ç›˜ã€ç§»åŠ¨ç«¯ç½‘ç»œç¯å¢ƒè¾ƒå·®å‡å°‘æŠ¥æ–‡å¤§å°ç­‰åœºæ™¯ï¼Œå…³äºåºåˆ—åŒ–é€Ÿåº¦ä¸»è¦æ˜¯å–å†³äºä½ ç”¨çš„sdkï¼Œæ‰€ä»¥æœ¬æ–‡ä¸ä¼šå…³å¿ƒåºåˆ—åŒ–é€Ÿåº¦ï¼æœ¬æ–‡å°†ä»¥proto3è¯­æ³•è¿›è¡Œä»‹ç»ï¼å¹¶ä¸”ä¹Ÿä»‹ç»äº†å¦‚ä½•ä½¿ç”¨pbè§„èŒƒçš„å®šä¹‰æ¥å£ï¼Œä»¥åŠå¯¹æ¯”äº†pb2/pb3å·®åˆ«ï¼å¦‚æœä½ è¿˜å¯¹Thriftæ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹æˆ‘è¿™è¾¹æ–‡ç« : Thriftåè®®è®²è§£ï¼\n\n\n1. åè®®è®²è§£\npb3 ä¸ pb2å·®åˆ«ï¼š\n\n\npb3 å¯¹äºåŸºæœ¬ç±»å‹å·²ç»çº¦å®šäº†é»˜è®¤å€¼ï¼Œä¼šæŠŠ 0/ &quot;&quot;/false/æšä¸¾ä¸º0çš„å€¼ åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸è¿›è¡Œç¼–ç ï¼Œä¹Ÿå°±æ˜¯æ— æ³•åŒºåˆ†è¿™ä¸ªå€¼æ˜¯å¦è®¾ç½®äº†ï¼\npb3 åæœŸæ”¯æŒäº† optionalï¼Œä½†æ˜¯éœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™æŒ‡å®š--experimental_allow_proto3_optional !\npb3 ä¸æ”¯æŒ required å…³é”®å­—ï¼Œä¸æ¨èä¸šåŠ¡å®šä¹‰requiredï¼ \npb3 ä¸æ”¯æŒé»˜è®¤å€¼è®¾ç½®ï¼Œpb3ä¸­é»˜è®¤å€¼éƒ½æ˜¯çº¦å®šå¥½çš„ï¼Œä»¥åŠä¸æ”¯æŒgroup messageï¼\npb3 çš„æšä¸¾ç±»å‹çš„ç¬¬ä¸€ä¸ªå­—æ®µå¿…é¡»ä¸º 0ï¼\npb3 å’Œ pb2 æ˜¯å¯ä»¥æ··åˆä½¿ç”¨çš„ï¼pb3å’Œpb2åŸºæœ¬ä¸Šå‹ç¼©ç‡å’Œæ€§èƒ½ä¸Šæ— å·®åˆ«ï¼\n\n\nlabels\npb2\npb3\nå¤‡æ³¨\n\n\n\nrequired\næ”¯æŒ\nä¸æ”¯æŒ\n\n\n\noptional\næ”¯æŒ\næ”¯æŒ\n\n\n\nsingular (ç±»ä¼¼äºthrift default)\nä¸æ”¯æŒ\næ”¯æŒ\n\n\n\nrepeated\næ”¯æŒ\næ”¯æŒ\n\n\n\noneof\næ”¯æŒ\næ”¯æŒ\n\n\n\nmap\næ”¯æŒ\næ”¯æŒ\n\n\n\nextend\næ”¯æŒ\nä¸æ”¯æŒ\n\n\n\n\n\né€‰æ‹©ä¸Šæ¥è¯´å°±æ˜¯çœ‹ä½ æ˜¯å¦éœ€è¦ nullå’Œé»˜è®¤å€¼ï¼å¦‚æœéœ€è¦é‚£å°±pb2ï¼Œä¸è¡Œå°±pb3ï¼\n\npb3åŸºæœ¬ä¸Šè¯­æ³•å¦‚ä¸‹ï¼Œå…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£: https://developers.google.com/protocol-buffers/docs/proto3 ï¼Œ ä¾‹å¦‚ä¸‹é¢çš„test.proto æ–‡ä»¶\n\nsyntax = &quot;proto3&quot;;message TestData &#123;  enum EnumType &#123;    UnknownType = 0; // å¿…é¡»ä»¥0å¼€å§‹ï¼    Test1Type = 1;    Test2Type = 2;  &#125;  message TestObj &#123;    int64 t_int64 = 1;  &#125;  string t_string = 1;  int64 t_int64 = 2;  bool t_bool = 3;  fixed64 t_fix64 = 4;  repeated int64 t_list_i64 = 5;  map&lt;int64, string&gt; t_map = 6;  EnumType t_enum = 7;  TestObj t_obj = 8 ;  repeated TestObj t_list_obj = 9 ;  map&lt;string, TestData&gt; t_map_obj = 10;  repeated string  t_list_string = 11;&#125;\n\n\nå¦‚ä½•ç¼–è¯‘äº†ï¼Ÿ å¦‚æœæ˜¯Goçš„è¯å¯ä»¥ä¸‹é¢è¿™ç§æ–¹å¼ç¼–è¯‘ï¼è®°ä½æå‰ä¸‹è½½å¥½ protoc-gen-go å’Œ protoc-gen-go-grpc , æºç åœ°å€: protobuf-go\n\n# install  protoc &amp; protoc-gen-go &amp; protoc-gen-go-grpcwget https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protoc-3.17.3-osx-x86_64.zipgo get -v google.golang.org/protobuf/cmd/protoc-gen-gogo get -v google.golang.org/grpc/cmd/protoc-gen-go-grpc# ç¼–è¯‘ä¸Šé¢çš„&#x27;test.proto&#x27;æ–‡ä»¶protoc \\--experimental_allow_proto3_optional \\--proto_path=. \\--plugin=protoc-gen-go=$&#123;HOME&#125;/go/bin/protoc-gen-go \\--go_opt=Mtest.proto=github.com/anthony-dong/go-tool/internal/example/protobuf/test \\--go_out=$&#123;HOME&#125;/go/src \\--plugin=protoc-gen-go-grpc=$&#123;HOME&#125;/go/bin/protoc-gen-go-grpc \\--go-grpc_opt=Mtest.proto=github.com/anthony-dong/go-tool/internal/example/protobuf/test \\--go-grpc_out=$&#123;HOME&#125;/go/src \\test.proto\n\n\npb åºåˆ—åŒ–æ ¸å¿ƒç”¨åˆ°çš„æ€æƒ³å°±æ˜¯varint + zigzap,  å…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡ç« : https://developers.google.com/protocol-buffers/docs/encoding\næœ¬æ–‡çš„ç›®æ ‡æ˜¯å¯ä»¥åšåˆ°ç®€å•çš„åºåˆ—åŒ– message å’Œ ååºåˆ—åŒ–messageï¼\nç›®å‰Goä¸»è¦æœ‰ä¸¤ä¸ªPBåº“ï¼Œä¸€ä¸ªæ˜¯V1ç‰ˆæœ¬çš„: https://github.com/golang/protobufï¼Œä¸€ä¸ªæ˜¯V2ç‰ˆæœ¬çš„: https://github.com/protocolbuffers/protobuf-go , éƒ½å±äºå®˜æ–¹å®ç°ï¼\n\n2. ç¼–ç +è§£ç å…³äºæ¶ˆæ¯å„ä¸ªç±»å‹çš„ç¼–ç é€»è¾‘: https://github.com/protocolbuffers/protobuf-go/tree/master/internal/impl\næ ¸å¿ƒæ€æƒ³ï¼š \n\nvarintï¼Œæ ¹æ®æ•°å­—çš„å¤§å°è¿›è¡ŒåŠ¨æ€ç¼–ç ï¼Œå¯ä»¥å‡å°‘å­—èŠ‚æ•°çš„å ç”¨ï¼Œé‡‡ç”¨ msb(the Most Significant Bit) æœ€é«˜æœ‰æ•ˆä½ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºå¤§ç«¯-&gt;å°ç«¯è½¬æ¢ï¼Œå…·ä½“å¯ä»¥çœ‹åé¢è®²è¿°ï¼\nzigzag ç”±äºè´Ÿæ•°çš„æœ€é«˜é«˜ä½æ°¸è¿œæ˜¯1ï¼Œå¯¼è‡´-1å ç”¨8å­—èŠ‚ï¼Œæ¯”è¾ƒæµªè´¹ï¼Œæ‰€ä»¥zigzagåšäº†ä¸€ä¸ªæ˜ å°„ï¼Œè´Ÿæ•°å¯ä»¥æ˜ å°„æˆæ­£æ•°ï¼Œæ­£æ•°è¿˜æ˜¯æ­£æ•°ï¼Œå…·ä½“å¯ä»¥çœ‹åé¢è®²è¿°ï¼\n\n1. ç®€å•ä¾‹å­ï¼ˆå­¦ä¹ ç›®æ ‡ï¼‰ä¸‹é¢æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ˜¯é€šè¿‡PBè‡ªå¸¦çš„åº“ç¼–ç ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ç¼–ç ï¼Œæˆ‘ä»¬è¿™ç¯‡æ–‡ç« ç›®æ ‡æ˜¯å¯ä»¥è‡ªå·±å®ç°ç¼–ç ï¼\n// ä½¿ç”¨pb åºåˆ—åŒ–func Test_Marshal_Data(t *testing.T) &#123;\tvar request = test.TestData&#123;\t\tTString: &quot;hello&quot;, // 1:string\t\tTInt64:  520,     //8:int64\t\tTObj: &amp;test.TestData_TestObj&#123; //8:message\t\t\tTInt64: 520, // 1:int64\t\t&#125;,\t&#125;\tmarshal, err := proto.Marshal(&amp;request)\tif err != nil &#123;\t\tt.Fatal(err)\t&#125;\tt.Log(hex.Dump(marshal))\t// 00000000  0a 05 68 65 6c 6c 6f 10  88 04 42 03 08 88 04     |..hello...B....|&#125;// è‡ªå·±ç¼–ç å®Œæˆï¼func TestMarshal_Data_Custom_Test(t *testing.T) &#123;\t// æ³¨é‡Šè¯­æ³•\t// field_id:field_type:wire_type\t// size(field_value)\t// field_type=field_value\tbuffer := bytes.NewBuffer(make([]byte, 0, 1024))\tbinary.Write(buffer, binary.BigEndian, uint8(0x0a))     // 1:string:WireBytes, 0000 1010  = 0x0a\tbinary.Write(buffer, binary.BigEndian, uint8(0x05))     // size(string) = 5\tbinary.Write(buffer, binary.BigEndian, []byte(&quot;hello&quot;)) // string=&#x27;hello&#x27;, 68 65 6c 6c 6f\tbinary.Write(buffer, binary.BigEndian, uint8(0x10))     // 2:int64:WireVarint, 0001 0000 = 0x10\tbinary.Write(buffer, binary.BigEndian, uint16(0x8804))  // int64=520, 0000 0010 0000 1000 =&gt; 1000 1000 0000 0100 = 0x8804\tbinary.Write(buffer, binary.BigEndian, uint8(0x42))    // 8:message:WireBytes, 0100 0010 = 0x42\tbinary.Write(buffer, binary.BigEndian, uint8(0x03))    // size(message) = 3\tbinary.Write(buffer, binary.BigEndian, uint8(0x08))    // 1:int64:WireVarint, 0000 1000=0x08\tbinary.Write(buffer, binary.BigEndian, uint16(0x8804)) // int64=520, 0000 0010 0000 1000 =&gt; 1000 1000 0000 0100 = 0x8804\tt.Log(hex.Dump(buffer.Bytes()))\t// 00000000  0a 05 68 65 6c 6c 6f 10  88 04 42 03 08 88 04     |..hello...B....|&#125;\n\n2. Message ç¼–ç ä»‹ç»1. ä»‹ç»æ¶ˆæ¯æ˜¯ç”± field_id å’Œ field_valueç»„æˆï¼Œä½†æ˜¯pbæ”¯æŒçš„ç±»å‹æ¯”è¾ƒå¤šï¼Œè€ƒè™‘åˆ°ç¼–ç çš„æ—¶å€™å¾ˆå¤šç±»å‹å…¶å®æœ‰ç›¸ä¼¼çš„é€»è¾‘ï¼Œå› æ­¤pbå¯¹äºç±»å‹è¿›è¡Œäº†äºŒæ¬¡å½’ç±»ï¼Œå«åšwire typeï¼Œä¹Ÿå°±æ˜¯ field_idå’Œwire_type ç»„åˆæˆä¸€ä¸ªå­—æ®µç”¨varint è¿›è¡Œç¼–ç ï¼\nfield id, wire_type used varint encode+--------+...+--------+--------+--------+...+--------+| field id            |dddddttt| field value         |+--------+...+--------+--------+--------+...+--------+\n\n\nfield id + dddddttt ä¸€å…±æ˜¯ 1-4ä¸ªå­—èŠ‚ï¼Œç”¨çš„æ˜¯ varint ç¼–ç ï¼å…·ä½“Goçš„ä»£ç å®ç°å¦‚ä¸‹\n\n// EncodeTagAndWireType encodes the given field tag and wire type to the// buffer. This combines the two values and then writes them as a varint.func (b *Buffer) EncodeTagAndWireType(fieldId int32, wireType int8) error &#123;\tv := uint64((int64(fieldId) &lt;&lt; 3) | int64(wireType))\treturn b.EncodeVarint(v)&#125;// DecodeTagAndWireType decodes a field tag and wire type from input.// This reads a varint and then extracts the two fields from the varint// value read.func (cb *Buffer) DecodeTagAndWireType() (tag int32, wireType int8, err error) &#123;\tvar v uint64\tv, err = cb.DecodeVarint()\tif err != nil &#123;\t\treturn\t&#125;\t// low 7 bits is wire type\twireType = int8(v &amp; 7)\t// rest is int32 tag number\tv = v &gt;&gt; 3\tif v &gt; math.MaxInt32 &#123;\t\terr = fmt.Errorf(&quot;tag number out of range: %d&quot;, v)\t\treturn\t&#125;\ttag = int32(v)\treturn&#125;\n\n\nttt ä¸º3bitè¡¨ç¤ºwire_typeï¼Œä¹Ÿå°±æ˜¯æœ€å¤šè¡¨ç¤º1&lt;&lt;3 -17ç§ç±»å‹ï¼ŒåŒ…å«000 ï¼Œä¹Ÿå°±æ˜¯8ç§ç±»å‹ï¼Œå…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š wire types ä»‹ç»ï¼\n\n\nconst (\tWireVarint     = 0\tWireFixed32    = 5\tWireFixed64    = 1\tWireBytes      = 2\tWireStartGroup = 3\tWireEndGroup   = 4)// æ˜ å°„å…³ç³»ï¼Œå°±æ˜¯ å­—æ®µçœŸå®ç±»å‹ -&gt; åºåˆ—åŒ–ç±»å‹func MustWireType(t descriptor.FieldDescriptorProto_Type) int8 &#123;\twireType, err := GetWireType(t)\tif err != nil &#123;\t\tpanic(err)\t&#125;\treturn wireType&#125;func GetWireType(t descriptor.FieldDescriptorProto_Type) (int8, error) &#123;\tswitch t &#123;\tcase descriptor.FieldDescriptorProto_TYPE_ENUM,\t\tdescriptor.FieldDescriptorProto_TYPE_BOOL,\t\tdescriptor.FieldDescriptorProto_TYPE_INT32,\t\tdescriptor.FieldDescriptorProto_TYPE_SINT32,\t\tdescriptor.FieldDescriptorProto_TYPE_UINT32,\t\tdescriptor.FieldDescriptorProto_TYPE_INT64,\t\tdescriptor.FieldDescriptorProto_TYPE_SINT64,\t\tdescriptor.FieldDescriptorProto_TYPE_UINT64:\t\treturn proto.WireVarint, nil\tcase descriptor.FieldDescriptorProto_TYPE_FIXED32,\t\tdescriptor.FieldDescriptorProto_TYPE_SFIXED32,\t\tdescriptor.FieldDescriptorProto_TYPE_FLOAT:\t\treturn proto.WireFixed32, nil\tcase descriptor.FieldDescriptorProto_TYPE_FIXED64,\t\tdescriptor.FieldDescriptorProto_TYPE_SFIXED64,\t\tdescriptor.FieldDescriptorProto_TYPE_DOUBLE:\t\treturn proto.WireFixed64, nil\tcase descriptor.FieldDescriptorProto_TYPE_BYTES,\t\tdescriptor.FieldDescriptorProto_TYPE_STRING,\t\tdescriptor.FieldDescriptorProto_TYPE_MESSAGE:\t\treturn proto.WireBytes, nil\tcase descriptor.FieldDescriptorProto_TYPE_GROUP:\t\treturn proto.WireStartGroup, nil\tdefault:\t\treturn 0, fmt.Errorf(&quot;not support pb type: %d&quot;, t)\t&#125;&#125;\n\n\nfield value å°±æ˜¯å­—æ®µå†…å®¹äº†ï¼Œä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»æ¯ä¸€ç§å¯¹åº”çš„ï¼\n\nWireVarint å†™çš„æ—¶å€™é‡‡ç”¨varint ç¼–ç ï¼Œå¯å˜1-10å­—èŠ‚WireFixed32 å†™çš„æ—¶å€™ä¼šè¿›è¡Œå°ç«¯è½¬æ¢ï¼Œå›ºå®š4å­—èŠ‚WireFixed64 å†™çš„æ—¶å€™ä¼šè¿›è¡Œå°ç«¯è½¬æ¢ï¼Œå›ºå®š8å­—èŠ‚WireBytes å†™çš„æ—¶å€™æ­£å¸¸å†™å‡ºå­—èŠ‚æµå³å¯ï¼WireStartGroup / WireEndGroup ä¸è¿›è¡Œä»‹ç»äº†ï¼\n\n2. æ€»ç»“\nè¿™é‡Œè°ˆä¸ªå°æŠ€å·§ï¼Œå…¶å®çœ‹åè®®ç¼–ç è¿™ç§æºç çš„æ—¶å€™ï¼Œå¾ˆå¤šä½è¿ç®—ï¼Œå…¶å®ä¸€èˆ¬æ¥è¯´ |è¡¨ç¤ºset bitæ“ä½œï¼Œ &amp;è¡¨ç¤ºget bitæ“ä½œï¼\nè¿™é‡Œå†è¡¥å……ä¸‹ä¸ºå•¥æœ€å¤§å­—æ®µæ˜¯2^29-1ï¼Œæ˜¯å› ä¸ºnuberæœ€å¤§æ˜¯ui32ç¼–ç ï¼Œç„¶åæœ‰3bitç”¨ä½œmsbï¼Œå°±å‰©ä½™29ä½äº†ï¼Œæ‰€ä»¥å°±æ˜¯ 2^29-1äº†ï¼\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆpbä¸­1-15å­—æ®µå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œæ˜¯å› ä¸º var intåªæœ‰7å­—æ®µå­˜å‚¨æ•°æ®ï¼Œä½†æ˜¯3bitå­˜å‚¨wire_type ï¼Œæ‰€ä»¥å‰©ä½™çš„4bitå­˜å‚¨å­—æ®µIDï¼Œä¹Ÿå°±æ˜¯ 1&lt;&lt;4 -1 = 15   ä¸ªå­—æ®µäº†ï¼\n\n3. varint ç¼–ç ä»‹ç»wikiä»‹ç» https://en.wikipedia.org/wiki/Variable-length_quantity ï¼Œæ•´ä½“æ¦‚è¿°ä¸€ä¸‹å°±æ˜¯å¯¹äºæ— ç¬¦å·æ•´æ•°æ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯æµªè´¹å­—èŠ‚ï¼Œæ¯”å¦‚uint64 å ç”¨ 8å­—èŠ‚ï¼Œå€¼ä¸º1æ˜¯å ç”¨8å­—èŠ‚ï¼Œå€¼ä¸º1&lt;&lt;64 - 1ä¹Ÿæ˜¯ä¸€æ ·ï¼Œé‚£ä¹ˆvarintå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼Œå¯ä»¥ç”¨1-10ä¸ªå­—èŠ‚è¿›è¡Œè¡¨ç¤ºï¼æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä½¿ç”¨ä½ä½çš„7bitè¡¨ç¤ºæ•°æ®ï¼Œé«˜ä½1bitè¡¨ç¤ºmsbï¼ˆThe Most Significant Bitï¼Œ æœ€é«˜æœ‰æ•ˆä½ï¼‰ï¼Œæœ€å°1ä¸ªå­—èŠ‚ï¼Œæœ€å¤§10ä¸ªå­—èŠ‚è¡¨ç¤º int64 ï¼\npbä¸­ç±»å‹ä¸ºå¦‚ä¸‹ç±»å‹éƒ½ä¼šé‡‡ç”¨varint ç¼–ç  , æšä¸¾ç­‰åŒäºint32!\nvarint       := int32 | int64 | uint32 | uint64 | bool | enum, encoded as varints\n\n1. ä¾‹å­1æ¯”å¦‚: data=15 -&gt; 0000 1111,  \nç¼–ç é€»è¾‘ï¼š\nvarint è¡¨ç¤ºä¸º 0000 1111ï¼Œæ˜¯å› ä¸ºä»–èƒ½å¤Ÿç”¨7å­—èŠ‚è¡¨ç¤ºï¼æ‰€ä»¥ä¸éœ€è¦è®¾ç½® msb!\nè§£æé€»è¾‘ï¼š\næˆ‘ä»¬æ‹¿åˆ° 0000 1111 å–å‡ºmsb å‘ç°1 ï¼Œè¿™é‡Œæ‹¿åˆ°msbæœ‰å¤šç§æ–¹å¼ï¼Œå¯ä»¥æ¯”è¾ƒå¤§å°ï¼Œä¹Ÿèƒ½é€šè¿‡ä½è¿ç®—è¿›è¡Œå–ï¼Œæ¯”å¦‚ 0000 1111 &amp; 1&lt;&lt;7 == 0 å°±å¯ä»¥è¯´æ˜æ²¡æœ‰è®¾ç½®msbï¼Œç„¶åå–å‡ºä½7ä½å³æ˜¯çœŸå®æ•°æ®ï¼Œè¿™é‡Œç”±äº8ä½ä¹Ÿæ˜¯0å…¶å®å¯ä»¥å¿½ç•¥è¿™ä¸ªæ“ä½œï¼\n2. ä¾‹å­2æ¯”å¦‚ data=520 -&gt; 0000 0010 0000 1000     (å¤§ç«¯è¡¨ç¤ºæ³•ï¼Œä½ä½åœ¨é«˜åœ°å€)\nç¼–ç é€»è¾‘ï¼š\né¦–å…ˆç¡®å®š520æ˜¯7ä¸ªbitæ”¾ä¸ä¸‹ï¼Œæ‰€ä»¥å…ˆå–å‡º å‰7ä¸ªå­—èŠ‚( data &amp; (1&lt;&lt;7) - 1)  =  000 1000ï¼Œç„¶åè®¾ç½®msb 1000 1000, è¿™ä¸ªæ˜¯ç¬¬ä¸€è½®ï¼›\nç¬¬äºŒè½®å‰©ä½™å­—èŠ‚ 0000 0010 0= 4 , å‘ç°4å¯ä»¥ç”¨7ä¸ªå­—èŠ‚æ”¾ä¸‹ï¼Œæ‰€ä»¥æ˜¯ 0000 0100\næ‰€ä»¥æœ€ç»ˆç»“æœæ˜¯ 1000 1000 0000 0100  ï¼Œä¹Ÿå°±æ˜¯ [136,4]ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºæ˜¯å¤§ç«¯ -&gt; å°ç«¯çš„ä¸€ä¸ªè¿‡ç¨‹ï¼\nè§£æé€»è¾‘ï¼š\né¦–å…ˆvarint å…¶å®è¾“å‡ºçš„æ˜¯ä¸€ä¸ªå°ç«¯è¡¨ç¤ºæ³•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä»ä½ä½å¼€å§‹ï¼\né¦–å…ˆæ˜¯å–å‡ºç¬¬ä¸€ä¸ªå­—èŠ‚1000 1000 ï¼Œå‘ç°msbï¼Œç„¶åå¾—åˆ°ç»“æœæ˜¯ 000 1000 = 8 \nç„¶åæ˜¯å–å‡ºç¬¬äºŒä¸ªå­—èŠ‚0000 0100ï¼Œå‘ç°ä¸æ˜¯msbï¼Œç„¶åå¾—åˆ°ç»“æœ 000 0100ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒæ”¾åˆ° 000 1000åé¢å»ï¼æ€ä¹ˆåšäº†ï¼Œå…¶å®è·Ÿç®€å• 000 0100 &lt;&lt; 7 | 000 1000 å³å¯å¾—åˆ°ç»“æœæ˜¯ 000 0100 000 1000 = 0000 0010 0000 1000 ã€‚ è¿™ä¸ªé€»è¾‘å¯ä»¥ç†è§£ä¸ºæ˜¯å°ç«¯-&gt;å¤§ç«¯çš„ä¸€ä¸ªè¿‡ç¨‹\n3. ä»£ç å®ç°func (p *pbCodec) EncodeVarInt(data int64) error &#123;\t// 1. å–å‡ºä½7ä½ï¼ˆå¦‚æœ7ä¸ªå­—èŠ‚ä¸å¯ä»¥æ”¾ä¸‹ï¼ï¼‰\t// 2. ç„¶åè®¾ç½®é«˜8ä½æ ‡è¯†ç¬¦å·\t// 3. ç„¶åå³ç§»\tfor data &gt; (1&lt;&lt;7 - 1) &#123;\t\tp.buffer = append(p.buffer, byte(data&amp;(1&lt;&lt;7-1)|(1&lt;&lt;7)))\t\tdata &gt;&gt;= 7\t&#125;\tp.buffer = append(p.buffer, byte(data))\treturn nil&#125;func (p *pbCodec) DecodeVarInt() (int64, error) &#123;\tvar (\t\tx int64\t\tn = 0\t)\tdefer func() &#123;\t\tp.buffer = p.buffer[n:]\t&#125;()\tfor shift := uint(0); shift &lt; 64; shift += 7 &#123; // åç§»é‡ä»0å¼€å§‹ï¼Œæ¯æ¬¡+7\t\tif n &gt;= len(p.buffer) &#123;\t\t\treturn 0, fmt.Errorf(&quot;not enough buffer&quot;)\t\t&#125;\t\t// 1. å–å‡ºç¬¬ä¸€ä¸ªè‡ªå·±\t\t// 2. ç„¶åå–å‡ºä½7ä½\t\t// 3. ç„¶åç”±äºæ•°æ®æ˜¯å°ç«¯ï¼Œæ‰€ä»¥å–å‡ºçš„æ•°æ®éœ€è¦ç§»åŠ¨åç§»é‡\t\t// 4. ç„¶åè®¾ç½®è¿›å»åŸæ¥çš„æ•°æ®ä¸­ï¼\t\tb := int64(p.buffer[n])\t\tn++\t\tx |= (b &amp; 0x7F) &lt;&lt; shift\t\tif (b &amp; 0x80) == 0 &#123;\t\t\treturn x, nil\t\t&#125;\t&#125;\treturn 0, fmt.Errorf(&quot;proto integer overflow&quot;)&#125;\n\n4. é varint ç¼–ç ç±»å‹1. fixed 64/32 ç±»å‹ (å°ç«¯)å…¶å®å°±æ˜¯ç”¨å°ç«¯è¿›è¡Œä¼ è¾“ï¼ä¾‹å¦‚fixed64 = 520 å°ç«¯ç¼–ç åå¦‚ä¸‹ï¼Œä¸ºæ­¤ä¸ºäº†å’Œvarintè¿›è¡ŒåŒºåˆ†ï¼Œæ‰€ä»¥å®šäº†ä¸¤ä¸ªwire type=WireFixed32|WireFixed64\n# fix64 520 å ç”¨ 8 å­—èŠ‚00 00 00 00 00 00 02 08# ç¼–ç å08 02 00 00 00 00 00 00\n\nä¾‹å¦‚Goä»£ç çš„å…·ä½“å®ç°ï¼Œ è¿™é‡Œä»¥ 64ä½ä¸ºä¾‹å­\nimport &quot;encoding/binary&quot;// å†™çš„æ—¶å€™å¯ä»¥é€šè¿‡å¦‚ä¸‹binary.Write(bf, binary.LittleEndian, uint64(520))// è¯»çš„æ—¶å€™å¯ä»¥é€šè¿‡å¦‚ä¸‹å®ç°var data uint64binary.Read(bf, binary.LittleEndian, &amp;data)\n\n2. double / float ç±»å‹åŒä¸Šé¢çš„fixed 64/32  ï¼Œdoubleéœ€è¦è½¬æ¢ä¸º fixed64 , floatéœ€è¦è½¬æ¢ä¸ºfixed32ï¼Œ å…·ä½“ float -&gt; uint Goçš„è½¬æ¢ä»£ç å®ç°ï¼š\nimport &quot;math&quot;math.Float32bits(v)math.Float64bits(v)\n\n3. string / bytes / message / packed ç±»å‹string å’Œ bytes éƒ½æ˜¯å˜é•¿ï¼Œæ‰€ä»¥éœ€è¦å…ˆå†™é•¿åº¦(var int)ç¼–ç ï¼Œå†å†™payloadï¼Œå¦‚æœæ˜¯stringçš„è¯éœ€è¦utf-8ç¼–ç ï¼\nmessage ç±»å‹ä¹Ÿæ˜¯é‡‡ç”¨çš„å¦‚ä¸‹ç¼–ç ï¼Œæ‰€ä»¥åœ¨PBé‡Œæ— æ³•é€šè¿‡äºŒè¿›åˆ¶æŠ¥æ–‡ç›´æ¥è§£æï¼\ndelimited := size (message | string | bytes | packed), size encoded as varintmessage   := valid protobuf sub-messagestring    := valid UTF-8 string (often simply ASCII); max 2GB of bytesbytes     := any sequence of 8-bit bytes; max 2GB\n\ndelimited := size (message | string | bytes | packed), size encoded as varint# size bytes+--------+...+--------+--------+...+--------+| byte length         | bytes               |+--------+...+--------+--------+...+--------+\n\n5. zigzag ç¼–ç  ( sint32 / sint64)å‰é¢è®²çš„varintå¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå› ä¸ºæ•°æ®å¾€å­˜åœ¨è´Ÿæ•°ï¼Œè€Œè´Ÿæ•°äºŒè¿›åˆ¶æœ€é«˜ä½éƒ½æ˜¯1ï¼Œæ‰€ä»¥å¯¼è‡´varintç¼–ç åæ•°æ®éƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥éœ€è¦zigzagç¼–ç ï¼Œå®ƒå¯ä»¥å¸®è´Ÿæ•°è½¬æ¢æˆæ­£æ•°ï¼Œæ­£æ•°è½¬æ¢æˆæ­£æ•°ï¼è€Œä¸”åŸºäºä½è¿ç®—æ•ˆç‡å¾ˆé«˜ï¼Œæ‰€ä»¥pbæå‡ºäº†sint32ã€sint64ç¼–ç ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ ¸å¿ƒå…¶å®å°±æ˜¯ä½¿ç”¨äº† zigzag ç¼–ç ï¼\nä¾‹å¦‚: int64 ç±»å‹ï¼Œå€¼ä¸º -1ï¼Œ varint ç¼–ç æ˜¯ï¼šff ff ff ff ff ff ff ff ff 01 æ»¡æ»¡çš„å ç”¨äº†10ä¸ªå­—èŠ‚ï¼ ä½†æ˜¯å‡å¦‚æ˜¯ sint64 ç±»å‹ï¼Œå€¼ä¸º -1ï¼Œ zigzag ç¼–ç åå€¼ä¸º01ï¼Œç„¶åvarintç¼–ç åæ˜¯ 01, æ­¤æ—¶å°±èŠ‚çœäº†9ä¸ªå­—èŠ‚ï¼\nzigzag ç¼–ç å…¶å®å¾ˆç®€å•å°±æ˜¯ç±»ä¼¼äºåšäº†å±‚æ˜ å°„ï¼ç”¨æ— ç¬¦å·çš„ä¸€åŠè¡¨ç¤ºæ­£æ•°ä¸€åŠè¡¨ç¤ºè´Ÿæ•°ï¼\n\nå…·ä½“ç®—æ³•ç”¨Goå†™å¤§æ”¹å¦‚ä¸‹ï¼š\n// EncodeZigZag64 does zig-zag encoding to convert the given// signed 64-bit integer into a form that can be expressed// efficiently as a varint, even for negative values.func EncodeZigZag64(v int64) uint64 &#123;\treturn (uint64(v) &lt;&lt; 1) ^ uint64(v&gt;&gt;63)&#125;// EncodeZigZag32 does zig-zag encoding to convert the given// signed 32-bit integer into a form that can be expressed// efficiently as a varint, even for negative values.func EncodeZigZag32(v int32) uint64 &#123;\treturn uint64((uint32(v) &lt;&lt; 1) ^ uint32((v &gt;&gt; 31)))&#125;// DecodeZigZag32 decodes a signed 32-bit integer from the given// zig-zag encoded value.func DecodeZigZag32(v uint64) int32 &#123;\treturn int32((uint32(v) &gt;&gt; 1) ^ uint32((int32(v&amp;1)&lt;&lt;31)&gt;&gt;31))&#125;// DecodeZigZag64 decodes a signed 64-bit integer from the given// zig-zag encoded value.func DecodeZigZag64(v uint64) int64 &#123;\treturn int64((v &gt;&gt; 1) ^ uint64((int64(v&amp;1)&lt;&lt;63)&gt;&gt;63))&#125;\n\n\nå¼‚æˆ–ï¼šç›¸åŒä¸º0ï¼Œç›¸å¼‚ä¸º1\n\nä¾‹å¦‚ä¸‹é¢ä¾‹å­ï¼Œå°†-1 å’Œ 1 è¿›è¡Œzigzag ç¼–ç å:\n# -11111 1111 1111 1111 1111 1111 1111 1111# d1=uint32(n) &lt;&lt; 11111 1111 1111 1111 1111 1111 1111 1110# d2=uint32(n &gt;&gt; 31) (è´Ÿæ•°å·¦ç§»æ·»åŠ 1)1111 1111 1111 1111 1111 1111 1111 1111# d1 ^ d20000 0000 0000 0000 0000 0000 0000 0001# 10000 0000 0000 0000 0000 0000 0000 0001#n&lt;&lt;10000 0000 0000 0000 0000 0000 0000 0010#n&gt;&gt;310000 0000 0000 0000 0000 0000 0000 0000# è¾“å‡º0000 0000 0000 0000 0000 0000 0000 0010\n\n6. repeated ï¼ˆlistï¼‰ä¸Šæ–‡éƒ½æ²¡æœ‰è®²è§£åˆ° é›†åˆç±»å‹ï¼Œprotbuf æä¾›äº† repeatedå…³é”®å­—æ¥æä¾›listç±»å‹ï¼å…³äº repeated å…·ä½“ç¼–ç å®ç°æœ‰ä¸¤ç§ï¼š\n\npacked ï¼ˆ pb3é»˜è®¤ä¼šæ ¹æ®å­—æ®µç±»å‹é€‰æ‹©packed,  pb2 v2.1.0 å¼•å…¥çš„,å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£: packedä»‹ç» ï¼‰\n\nunpacked \n\n\nç›®å‰pbä¸­æ”¯æŒ wire_type=WireVarint|WireFixed32|WireFixed64è¿›è¡Œ packedç¼–ç ï¼\nå…¶å®å¯ä»¥æ€è€ƒä¸€ä¸‹ä¸ºå•¥ï¼é¦–å…ˆå‡å¦‚æ˜¯WireBytes ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘æ•°æ®é‡å¾ˆå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªbytesæ•°æ®æœ€å¤§å¯ä»¥å†™2Gï¼Œé‚£ä¹ˆæˆ‘å†™å‡ºçš„æ—¶å€™å‡å¦‚ç”¨packedç¼–ç ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘å†™3æ¡æ•°æ®ï¼Œéœ€è¦å†…å­˜ä¸­ç§¯å‹6Gæ•°æ®ï¼Œç„¶åç®—å‡ºæ€»å¤§å°ï¼Œå†å†™å‡ºå»ï¼Œå ç”¨å†…å­˜å¾ˆå¤§ï¼Œè€Œä¸”è§£ç çš„æ—¶å€™ä¹Ÿæ˜¯ï¼PBè€ƒè™‘çš„å¯çœŸç»†è‡´ï¼\n1. packed ç¼–ç å¯ä»¥æ ¹æ®å®˜ç½‘æä¾›çš„demoä¸ºä¾‹å­ï¼š\nmessage Test4 &#123;  repeated int32 d = 4 [packed=true];&#125;\n\nå‡å¦‚d= [3, 270,86942] ï¼Œç¼–ç då­—æ®µçš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼Œå…ˆå†™ field_number å’Œ wire_type  ç„¶åå†å»å†™æ•´ä¸ªpayload å¤§å°ï¼Œæœ€åå†å†™æ¯ä¸€ä¸ªå…ƒç´ ï¼\n22        // key (field number = 4, wire type = 2 WireBytes)06        // payload size (6 bytes)03        // first element (varint 3)8E 02     // second element (varint 270)9E A7 05  // third element (varint 86942)\n\n2. unpacked ç¼–ç message Test5 &#123;  repeated int32 d = 4 [packed = false];&#125;\n\nè¿˜æ˜¯ä»¥å­—æ®µd= [3, 270,86942] è¿›è¡Œç¼–ç ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¼šæŠŠæ¯ä¸ªå…ƒç´ ä½œä¸ºå•ç‹¬çš„æ•´ä½“è¿›è¡Œå†™å‡ºï¼Œæ¯”å¦‚å…ƒç´ ä¸€ä¼šå†™field_type and wire_typeï¼Œç„¶åå†å†™ field_valueï¼Œä¾æ¬¡ï¼ï¼\n00000000  20 03 20 8e 02 20 9e a7  05                       | . .. ...|20  // key (field number 4, wire type=proto.WireVarint)03 // (varint 3)20 //  key (field number 4, wire type=proto.WireVarint)8e 02 // (varint 270)20 //  key (field number 4, wire type=proto.WireVarint)9e a7  05 // (varint 86942)\n\n7. mapå…¶å®åœ¨PBä¸­mapå®é™…ä¸Šå°±æ˜¯ repeated kv messageï¼Œå¯ä»¥é€šè¿‡FieldDescriptorå¯ä»¥çœ‹åˆ°ï¼\n&#123;    &quot;name&quot;: &quot;TestData&quot;,    &quot;field&quot;: [        &#123;            &quot;name&quot;: &quot;t_map&quot;,            &quot;number&quot;: 6,            &quot;label&quot;: 3,            &quot;type&quot;: 11,            &quot;type_name&quot;: &quot;.TestData.TMapEntry&quot;,            &quot;json_name&quot;: &quot;tMap&quot;        &#125;,    ],    &quot;nested_type&quot;: [        &#123;            &quot;name&quot;: &quot;TMapEntry&quot;,            &quot;field&quot;: [                &#123;                    &quot;name&quot;: &quot;key&quot;,                    &quot;number&quot;: 1,                    &quot;label&quot;: 1,                    &quot;type&quot;: 3,                    &quot;json_name&quot;: &quot;key&quot;                &#125;,                &#123;                    &quot;name&quot;: &quot;value&quot;,                    &quot;number&quot;: 2,                    &quot;label&quot;: 1,                    &quot;type&quot;: 9,                    &quot;json_name&quot;: &quot;value&quot;                &#125;            ],            &quot;options&quot;: &#123;                &quot;map_entry&quot;: true            &#125;        &#125;    ],    &quot;enum_type&quot;: []&#125;\n\næ‰€ä»¥ç¼–ç çš„æ—¶å€™ä¹Ÿå¾ˆç®€å•ï¼Œä¾‹å¦‚\nmessage TestMapData1 &#123;// è¿™é‡Œæ— æ³•å®šä¹‰ TMapEntryï¼Œä¼šæŠ¥é”™ï¼  map&lt;int64, string&gt; t_map = 6;&#125;==&gt; å®é™…ä¸Šæ˜¯ç”Ÿæˆäº†è¿™ä¸ªä»£ç ï¼message TestMapData2 &#123;  message TMapEntry &#123;    int64 key = 1;    string value = 2;  &#125;  repeated TMapEntry t_map = 6;&#125;\n\næ‰€ä»¥ç¼–ç è¿‡ç¨‹æ˜¯ä¸€ä¸ªrepeated k v messageçš„åºåˆ—åŒ–æ–¹å¼ï¼ä¾‹å¦‚ä¸‹é¢\nt_map= &#123;1:&quot;1&quot;,2:&quot;2&quot;&#125;=&gt;32 05 08 01 12 01 31 32  05 08 02 12 01 32=&gt; 32 // field_number=6 and wire_type=proto.WireBytes05 // entry data length=508 // entry data key field_number=1 and wire_type=proto.WireVarint01 // entry data key_value=varint(1)12 // entry data value field_number=2 and wire_type=proto.WireBytes01 // entry data value len= varint(1)31 // entry data value=&quot;1&quot;32  // field_number=6 and wire_type=proto.WireBytes05  // entry data length=508 02 12 01 32 // åŒä¸Šï¼\n\n8. field orderpbç¼–ç ä¸åœ¨æ„å­—æ®µçš„ç¼–ç é¡ºåºï¼Œä¹Ÿå°±æ˜¯encodeçš„å­—æ®µé¡ºåºä¸ä¸€æ ·ä¼šå¯¼è‡´è¾“å‡ºçš„æ•°æ®ä¸ä¸€æ ·ï¼ä½†æ˜¯è§£æå‡ºæ¥çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼\nè¿˜æœ‰å°±æ˜¯mapçš„keyé¡ºåºä¹Ÿä¼šå½±å“ï¼\næ‰€ä»¥ä¸€èˆ¬apiéƒ½ä¼šæŒ‡å®šæ˜¯å¦æ”¯æŒ deterministicï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œç»“æœä¸€èˆ¬éƒ½ä¼šä¿è¯ä¸€æ ·ï¼Œå¦åˆ™å¯èƒ½ä¸ä¸€æ ·ï¼\nä½†æ˜¯ä½ æ‡‚å¾—ï¼Œå®é™…ä¸Šæ•ˆæœå§ï¼Œå°±æ˜¯å¼€å¯ä¹‹åä¸€å®šæ¯”ä¸å¼€å¯æ…¢ï¼Œå› ä¸ºéœ€è¦è¿›è¡Œorderï¼\n3. pb åè®®æ•´ä½“æ¦‚æ‹¬ä¸‹é¢è¿™ä¸ªæ˜¯ä¸€ä¸ªç±»ä¼¼äºbnfèŒƒå¼çš„ä¸œè¥¿ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ: PB Encode ç®—æ³•\nmessage   := (tag value)*     You can think of this as â€œkey valueâ€tag       := (field &lt;&lt; 3) BIT_OR wire_type, encoded as varintvalue     := (varint|zigzag) for wire_type==0 |             fixed32bit      for wire_type==5 |             fixed64bit      for wire_type==1 |             delimited       for wire_type==2 |             group_start     for wire_type==3 | This is like â€œopen parenthesisâ€             group_end       for wire_type==4   This is like â€œclose parenthesisâ€varint       := int32 | int64 | uint32 | uint64 | bool | enum, encoded as                varintszigzag       := sint32 | sint64, encoded as zig-zag varintsfixed32bit   := sfixed32 | fixed32 | float, encoded as 4-byte little-endian;                memcpy of the equivalent C types (u?int32_t, float)fixed64bit   := sfixed64 | fixed64 | double, encoded as 8-byte little-endian;                memcpy of the equivalent C types (u?int64_t, double)delimited := size (message | string | bytes | packed), size encoded as varintmessage   := valid protobuf sub-messagestring    := valid UTF-8 string (often simply ASCII); max 2GB of bytesbytes     := any sequence of 8-bit bytes; max 2GBpacked    := varint* | fixed32bit* | fixed64bit*,             consecutive values of the type described in the protocol definitionvarint encoding: sets MSB of 8-bit byte to indicate â€œno more bytesâ€zigzag encoding: sint32 and sint64 types use zigzag encoding.\n\n4. protoc å‘½ä»¤è®²è§£è¿™é‡Œè®²è§£ä¸€ä¸‹protoc çš„æ¶æ„å›¾ï¼Œç”Ÿæˆæ¶æ„å›¾\n\nç¬¬ä¸€ä¸ªèŠ‚ç‚¹protocå…¶å®æ˜¯ c++å†™çš„ï¼Œ https://github.com/protocolbuffers/protobuf\nç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯ protoc è¾“å‡ºçš„äºŒè¿›åˆ¶æŠ¥æ–‡(PBç¼–ç ) CodeGeneratorRequest    ï¼Œå…·ä½“å¯ä»¥çœ‹ CodeGeneratorRequest IDLå®šä¹‰ï¼Œå…¶ä¸­ SourceCode æ¯”è¾ƒéš¾ç†è§£ï¼Œå¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« : SourceCodeInfoä»‹ç» ï¼\nç¬¬ä¸‰ä¸ªèŠ‚ç‚¹æ˜¯ plugin ç”Ÿæˆé€»è¾‘ï¼Œå¯ä»¥é€šè¿‡æ ‡å‡†è¾“å…¥è·å–CodeGeneratorRequest,é€šè¿‡æ ‡å‡†è¾“å‡ºå†™å…¥CodeGeneratorResponse\nç¬¬å››ä¸ªèŠ‚ç‚¹è¾“å‡º CodeGeneratorResponseï¼Œå…·ä½“å¯ä»¥çœ‹ CodeGeneratorResponse IDLå®šä¹‰\nç›®å‰è™½ç„¶æœ‰å¾ˆå¤šé¡¹ç›®åœ¨è§£æ protoc çš„ astæ—¶ï¼Œéƒ½æ˜¯è‡ªå·±å®ç°çš„è¯æ³•è§£æå’Œè¯­æ³•è§£æï¼Œæ‰€ä»¥å‡å¦‚å¯ä»¥æŠŠprotocå°è£…ä¸ªlibåº“å°±å¥½äº†ï¼Œä¸Šå±‚å¯ä»¥ç”¨cgo ã€ java/python native å»æ‰ç”¨ä¼šå¥½å¾ˆå¤šï¼Œè¿™é‡Œæˆ‘è‡ªå·±ç”¨cgoå°è£…çš„libprotobuf,  å…·ä½“å¯ä»¥çœ‹æˆ‘è‡ªå·±å†™çš„é¡¹ç›®: https://github.com/Anthony-Dong/protobufï¼\n1. è‡ªå®šä¹‰plugin\nè‡ªå·±ç”¨Goè¯­è¨€å†™ä¸€ä¸ª print CodeGeneratorRequest çš„ç”Ÿæˆå™¨\n\npackage main//build: go build -o $(go env GOPATH)/bin/protoc-gen-print -v .import (\t&quot;io/ioutil&quot;\t&quot;os&quot;\t&quot;strings&quot;\t&quot;google.golang.org/protobuf/encoding/protojson&quot;\t&quot;google.golang.org/protobuf/proto&quot;\t&quot;google.golang.org/protobuf/types/pluginpb&quot;)func main() &#123;\treq := pluginpb.CodeGeneratorRequest&#123;&#125;\tresp := pluginpb.CodeGeneratorResponse&#123;&#125;\tstdIn, err := ioutil.ReadAll(os.Stdin)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tif err := proto.Unmarshal(stdIn, &amp;req); err != nil &#123;\t\tpanic(err)\t&#125;\toptions := toKVOption(&amp;req)\tswitch options[&quot;type&quot;] &#123;\tcase &quot;pb&quot;:\t\tmarshal, err := proto.Marshal(&amp;req)\t\tif err != nil &#123;\t\t\tpanic(err)\t\t&#125;\t\tresp.File = []*pluginpb.CodeGeneratorResponse_File&#123;\t\t\t&#123;\t\t\t\tName:    proto.String(&quot;desc.binary&quot;),\t\t\t\tContent: proto.String(string(marshal)),\t\t\t&#125;,\t\t&#125;\tdefault:\t\tresp.File = []*pluginpb.CodeGeneratorResponse_File&#123;\t\t\t&#123;\t\t\t\tName:    proto.String(&quot;desc.json&quot;),\t\t\t\tContent: proto.String(MessageToJson(&amp;req, true)),\t\t\t&#125;,\t\t&#125;\t&#125;\trespBinary, err := proto.Marshal(&amp;resp)\tif err != nil &#123;\t\tpanic(err)\t&#125;\tif _, err := os.Stdout.Write(respBinary); err != nil &#123;\t\tpanic(err)\t&#125;&#125;func toKVOption(req *pluginpb.CodeGeneratorRequest) map[string]string &#123;\tkvs := strings.Split(req.GetParameter(), &quot;,&quot;)\tresult := make(map[string]string, len(kvs))\tfor _, kv := range kvs &#123;\t\tkvv := strings.Split(kv, &quot;=&quot;)\t\tif len(kvv) == 2 &#123;\t\t\tresult[kvv[0]] = kvv[1]\t\t&#125; else &#123;\t\t\tresult[kvv[0]] = &quot;&quot;\t\t&#125;\t&#125;\treturn result&#125;func MessageToJson(v proto.Message, pretty ...bool) string &#123;\tops := protojson.MarshalOptions&#123;Multiline: len(pretty) &gt; 0 &amp;&amp; pretty[0]&#125;\treturn ops.Format(v)&#125;\n\n\nå…¶ä¸­pluginä¸€èˆ¬éµå®ˆå‘½åè§„åˆ™: protoc-gen-&#123;plugin name&#125; , ä½¿ç”¨ --plugin æŒ‡å®šè‡ªå·±æ’ä»¶çš„è·¯å¾„ï¼Œä½¿ç”¨ --&#123;pulgin&#125;_out æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œä½¿ç”¨ --&#123;pulgin&#125;_opt æŒ‡å®šparameterï¼Œ å¤šä¸ªè¯·å‚æ•°ç”¨, åˆ†å‰² \n\nprotoc --proto_path desc --proto_path . \\--plugin=protoc-gen-print=$&#123;HOME&#125;/go/bin/protoc-gen-print \\--print_out=$&#123;HOME&#125;/data/print \\--print_opt=type=json,k1=v1 \\--print_opt=k2=v2 `find . -name &#x27;*.proto&#x27;`\n\n2. è§£æoptions (Extensions)\nä¸šåŠ¡ä¸­ç»å¸¸æ‹“å±• protobuf.FieldOptions å®šä¹‰ä¸€äº›æ³¨è§£(å…ƒä¿¡æ¯)ï¼Œåœ¨ä»£ç ç”Ÿæˆä¸­/è¿è¡Œæ—¶çš„æ—¶å€™ç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚å¦‚ä¸‹æˆ‘å®šä¹‰çš„ api.proto æ–‡ä»¶\n\nsyntax = &quot;proto2&quot;;package api;option go_package = &quot;github.com/anthony-dong/protobuf/internal/pb_gen/api&quot;;import &quot;google/protobuf/descriptor.proto&quot;;extend google.protobuf.FileOptions&#123;  optional string android_package = 1001;&#125;extend google.protobuf.FieldOptions &#123;  optional HttpSourceType source = 50101; // æ¥è‡ªäºhttp è¯·æ±‚çš„å“ªä¸ªéƒ¨ä½  optional string key = 50102; // http è¯·æ±‚çš„header è¿˜æ˜¯å“ª  optional bool unbox = 50103; // æ˜¯å¦å¹³é“ºå¼€ç»“æ„ä½“ï¼Œé™¤bodyå¤–ï¼Œé»˜è®¤å¤„ç†ç¬¬ä¸€å±‚&#125;enum HttpSourceType &#123;  Query = 1;  Body = 2;  Header = 3;&#125;extend google.protobuf.MethodOptions &#123;  optional HttpMethodType method = 50201; // http method  optional string path = 50202; // http path&#125;enum HttpMethodType&#123;  GET = 1;  POST = 2;  PUT = 3;&#125;\n\n\né‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‹¿åˆ°è¿™äº›ä¿¡æ¯äº†ï¼Ÿ\n\n\nä½¿ç”¨protocç”Ÿæˆå¯¹åº”çš„api.proto æ–‡ä»¶äº§ç‰©ï¼Œå¯¹åº”è¯­è¨€çš„\n\nè¯»å– options çš„å®ç°ï¼Œå…·ä½“å¯ä»¥çœ‹ GetProtobufOptions çš„å®ç°\n\n\npackage mainimport (\t&quot;errors&quot;\t&quot;fmt&quot;\t&quot;reflect&quot;\t&quot;google.golang.org/protobuf/types/pluginpb&quot;\t&quot;github.com/anthony-dong/protobuf/internal/printer/api&quot; // è¿™ä¸ªæ˜¯api.protoçš„ç¼–è¯‘äº§ç‰©\t&quot;google.golang.org/protobuf/proto&quot;\t&quot;google.golang.org/protobuf/runtime/protoimpl&quot;)func readProtobufOptions(req *pluginpb.CodeGeneratorRequest) &#123;\tfor _, file := range req.GetProtoFile() &#123;\t\tfor _, message := range file.GetMessageType() &#123;\t\t\tif message.GetName() != &quot;ImMessageRequest&quot; &#123;\t\t\t\tcontinue\t\t\t&#125;\t\t\t/**\t\t\timport &quot;api.proto&quot;;\t\t\tmessage ImMessageRequest &#123;\t\t\t  optional int64 Cursor = 1 [default = 2, (api.source) = Query, (api.key) = &#x27;æµ‹è¯•æ³¨è§£è§£æ&#x27;];\t\t\t  optional im.commons.ImCommons ImCommons = 255 [(api.unbox) = true];\t\t\t&#125;\t\t\t*/\t\t\tfor _, field := range message.GetField() &#123;\t\t\t\toutput, err := GetProtobufOptions(field.GetOptions())\t\t\t\tif err != nil &#123;\t\t\t\t\tpanic(err)\t\t\t\t&#125;\t\t\t\tfmt.Printf(&quot;%s: %#v\\n&quot;, field.GetName(), output)\t\t\t&#125;\t\t&#125;\t&#125;&#125;func GetProtobufOptions(options proto.Message) (map[string]interface&#123;&#125;, error) &#123;\toptionKV := make(map[string]interface&#123;&#125;, 0)\tvar source api.HttpSourceType\tif isOk, err := marshalExtension(options, api.E_Source, &amp;source); err != nil &#123;\t\treturn nil, err\t&#125; else if isOk &#123;\t\toptionKV[&quot;api.source&quot;] = source\t&#125;\tvar key string\tif isOk, err := marshalExtension(options, api.E_Key, &amp;key); err != nil &#123;\t\treturn nil, err\t&#125; else if isOk &#123;\t\toptionKV[&quot;api.key&quot;] = key\t&#125;\tvar unbox bool\tif isOk, err := marshalExtension(options, api.E_Unbox, &amp;unbox); err != nil &#123;\t\treturn nil, err\t&#125; else if isOk &#123;\t\toptionKV[&quot;api.unbox&quot;] = unbox\t&#125;\treturn optionKV, nil&#125;// å‚è€ƒ: https://github.com/lyft/protoc-gen-star/blob/master/extension.go å®ç°func marshalExtension(opts proto.Message, e *protoimpl.ExtensionInfo, out interface&#123;&#125;) (bool, error) &#123;\tif opts == nil || reflect.ValueOf(opts).IsNil() &#123;\t\treturn false, nil\t&#125;\tif e == nil &#123;\t\treturn false, errors.New(&quot;nil *protoimpl.ExtensionInfo parameter provided&quot;)\t&#125;\tif out == nil &#123;\t\treturn false, errors.New(&quot;nil extension output parameter provided&quot;)\t&#125;\to := reflect.ValueOf(out)\tif o.Kind() != reflect.Ptr &#123;\t\treturn false, errors.New(&quot;out parameter must be a pointer type&quot;)\t&#125;\tif !proto.HasExtension(opts, e) &#123;\t\treturn false, nil\t&#125;\tval := proto.GetExtension(opts, e)\tif val == nil &#123;\t\treturn false, errors.New(&quot;extracted extension value is nil&quot;)\t&#125;\tv := reflect.ValueOf(val)\tfor v.Kind() == reflect.Ptr || v.Kind() == reflect.Interface &#123;\t\tv = v.Elem()\t&#125;\tfor o.Kind() == reflect.Ptr || o.Kind() == reflect.Interface &#123;\t\tif o.Kind() == reflect.Ptr &amp;&amp; o.IsNil() &#123;\t\t\to.Set(reflect.New(o.Type().Elem()))\t\t&#125;\t\to = o.Elem()\t&#125;\tif v.Type().AssignableTo(o.Type()) &#123;\t\to.Set(v)\t\treturn true, nil\t&#125;\treturn true, fmt.Errorf(&quot;cannot assign extension type %q to output type %q&quot;,\t\tv.Type().String(),\t\to.Type().String())&#125;\n\n\nè¾“å‡º\n\nCursor: map[string]interface &#123;&#125;&#123;&quot;api.key&quot;:&quot;cursor&quot;, &quot;api.source&quot;:1&#125;ImCommons: map[string]interface &#123;&#125;&#123;&quot;api.unbox&quot;:true&#125;\n\n\nå…·ä½“ä¸ºå•¥éè¦è§£æ api.protoæ–‡ä»¶æ‰èƒ½è·å–ExtensionInfo å‘¢ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯descä¸­å¹¶ä¸ä¼šæœ‰è¯¦ç»†çš„ç±»å‹ä¿¡æ¯ï¼Œåªæœ‰ id:value ä¿¡æ¯ï¼Œå¯ä»¥çœ‹æˆ‘è§£æåçš„ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ cat /Users/bytedance/data/print/desc.binary | gtool codec pb è¿›è¡Œè§£æï¼Œ gtool å¯ä»¥ä»è¿™é‡Œä¸‹è½½: https://github.com/anthony-dong/go-sdk \n\n[    &#123;        &quot;1&quot;: &quot;Cursor&quot;,        &quot;3&quot;: 1,        &quot;4&quot;: 1,        &quot;5&quot;: 3,        &quot;7&quot;: &quot;2&quot;,        &quot;8&quot;: &#123;            &quot;50101&quot;: 1,            &quot;50102&quot;: &quot;cursor&quot;        &#125;,        &quot;10&quot;: &quot;Cursor&quot;    &#125;,    &#123;        &quot;1&quot;: &#123;            &quot;9&quot;: 1.0640046222664341e+248        &#125;,        &quot;3&quot;: 255,        &quot;4&quot;: 1,        &quot;5&quot;: 11,        &quot;6&quot;: &quot;.im.commons.ImCommons&quot;,        &quot;8&quot;: &#123;            &quot;50103&quot;: 1        &#125;,        &quot;10&quot;: &#123;            &quot;9&quot;: 1.0640046222664341e+248        &#125;    &#125;]\n\n5. pb å…¶ä»–ç»†èŠ‚è®²è§£\npackageï¼ˆåŒ…ï¼‰ï¼Œä¸€ä¸ªåŒ…ä¸‹ä¸èƒ½å­˜åœ¨ç›¸åŒå®šä¹‰çš„messageå’Œæšä¸¾ä»¥åŠæšä¸¾å­—æ®µï¼\nincludeï¼ˆimportï¼‰ï¼ŒåŸºäºinclude_path ä½œä¸ºæ ¹ç›®å½•çš„relative pata\noptionï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€äº›æ³¨è§£ï¼Œå¯ä»¥å¯¹äºå­—æ®µã€æ¶ˆæ¯ã€æšä¸¾ã€methodè¿›è¡Œæ ‡è®°ï¼\n\n\nè¿™é‡Œä¸æ¨èåœ¨idlé‡Œå®šä¹‰ option go_package=xxx  java php py ä¹‹ç±»çš„ï¼Œå› ä¸ºpbåœ¨ç¼–è¯‘æœŸå¯ä»¥æŒ‡å®šï¼å¦‚æœä½ ä»¬æœ‰è‡ªå·±çš„pb gen pluginå¯ä»¥æ‹“å±• descriptor!\n\nsyntax = &quot;proto2&quot;;package api;option go_package = &quot;github.com/anthony-dong/go-tool/internal/example/protobuf/idl_example/pb_gen/api&quot;;import &quot;google/protobuf/descriptor.proto&quot;;extend google.protobuf.FieldOptions &#123;  optional HttpSourceType source = 50101; // æ¥è‡ªäºhttp è¯·æ±‚çš„å“ªä¸ªéƒ¨ä½  optional string key = 50102; // http è¯·æ±‚çš„header è¿˜æ˜¯å“ª  optional bool unbox = 50103; // æ˜¯å¦å¹³é“ºå¼€ç»“æ„ä½“ï¼Œé™¤bodyå¤–ï¼Œé»˜è®¤å¤„ç†ç¬¬ä¸€å±‚&#125;enum HttpSourceType &#123;  Query = 1;  Body = 2;  Header = 3;&#125;extend google.protobuf.MethodOptions &#123;  optional HttpMethodType method = 50201; // http method  optional string path = 50202; // http path&#125;enum HttpMethodType&#123;  GET = 1;  POST = 2;  PUT = 3;&#125;// extend google.protobuf.EnumValueOptions &#123;// &#125;// extend google.protobuf.EnumOptions &#123;// &#125;// extend google.protobuf.MessageOptions &#123;// &#125;// extend google.protobuf.ServiceOptions &#123;// &#125;\n\nå…·ä½“å¯ä»¥çœ‹æˆ‘çš„å†™çš„ä¾‹å­ï¼šprotobuf\n6. proto any ç±»å‹ä¾‹å¦‚pbæ–‡ä»¶\nimport &quot;google/protobuf/any.proto&quot;;message TestAnyType &#123;  optional google.protobuf.Any any = 1;&#125;message Type1 &#123;  string  value = 1;&#125;message Type2 &#123;  int64  value = 1;&#125;message Type3 &#123;  float value = 1;&#125;\n\næ­¤æ—¶Valueå¯èƒ½æ˜¯å¾ˆå¤šç±»å‹ï¼Œæ¯”å¦‚ Type1 æˆ–è€…Type2æˆ–è€…Type3ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦ä¸€ä¸ªanyç±»å‹\né¦–å…ˆæˆ‘ä»¬å†™ä»£ç åˆ›å»ºä¸€ä¸ª TestAnyType ç»è¿‡pbç¼–ç \nfunc encodeData(t *testing.T) []byte &#123;\t// import &quot;google.golang.org/protobuf/types/known/anypb&quot;\tdata := test.TestAnyType&#123;\t\tAny: &amp;anypb.Any&#123;&#125;,\t&#125;\tif err := data.Any.MarshalFrom(&amp;test.Type1&#123;\t\tValue: &quot;11111&quot;,\t&#125;); err != nil &#123;\t\tt.Fatal(err)\t&#125;\t// import &quot;google.golang.org/protobuf/proto&quot;\tif result, err := proto.Marshal(&amp;data); err != nil &#123;\t\tt.Fatal(err)\t\treturn nil\t&#125; else &#123;\t\treturn result\t&#125;&#125;\n\nå¦‚ä½•ä½¿ç”¨äº†ï¼Ÿ\nfunc TestAnyType(t *testing.T) &#123;\tdata := encodeData(t)\tresult := test.TestAnyType&#123;&#125;\tif err := proto.Unmarshal(data, &amp;result); err != nil &#123;\t\tt.Fatal(err)\t&#125;\tt.Log(result.String())\tany := result.Any\t// é€šè¿‡ any.MessageIs åˆ¤æ–­ç±»å‹ï¼è®°ä½å¯ä»¥ä½¿ç”¨ â€ä¼ªç©ºå¯¹è±¡â€œ å³å¯ï¼\tif any.MessageIs((*test.Type1)(nil)) &#123;\t\ttype1 := test.Type1&#123;&#125;\t\tif err := any.UnmarshalTo(&amp;type1); err != nil &#123;\t\t\tt.Fatal(err)\t\t&#125;\t\t// handler type1 func\t\tt.Logf(&quot;type1: %s\\n&quot;, type1.String())\t&#125;\tif any.MessageIs((*test.Type2)(nil)) &#123;\t\ttype2 := test.Type2&#123;&#125;\t\tif err := any.UnmarshalTo(&amp;type2); err != nil &#123;\t\t\tt.Fatal(err)\t\t&#125;\t\t// handler type2 func\t\tt.Logf(&quot;type2: %s\\n&quot;, type2.String())\t&#125;\tif any.MessageIs((*test.Type3)(nil)) &#123;\t\ttype2 := test.Type3&#123;&#125;\t\tif err := any.UnmarshalTo(&amp;type2); err != nil &#123;\t\t\tt.Fatal(err)\t\t&#125;\t\t// handler type3 func\t\tt.Logf(&quot;type3: %s\\n&quot;, type2.String())\t&#125;&#125;\n\n7. å‚è€ƒæ–‡ç« \nprotobuf ç¼–ç ä»‹ç»\nprotobufç¼–ç ä¹‹varint/zigzag\nå¾®è½¯ APIè®¾è®¡è§„èŒƒ\nGoogle APIè®¾è®¡è§„èŒƒ\nrestful apiè®¾è®¡æŒ‡å—\n\n","categories":["RPC"],"tags":["GRPC","API","Protobuf"]},{"title":"grepã€awkã€sedã€æ­£åˆ™è¡¨è¾¾å¼ å¼€å‘å¿…å¤‡åˆ†äº«","url":"/2022/03/12/c9cb8912930fdc26498e1bf5b085fabf/","content":"grepã€awkå‘½ä»¤ä¸»è¦æ˜¯ç”¨äºæˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æ—¥å¿—æ£€ç´¢ï¼Œé—®é¢˜å°±æ˜¯æœ‰åŒå­¦å¯èƒ½ä¼šå’¨è¯¢ä¸æ˜¯æœ‰elkã€ä¼ä¸šå†…éƒ¨æ—¥å¿—æ”¶é›†è¿‡æ»¤ç³»ç»Ÿï¼Œé‚£ä¹ˆæˆ‘ä¸ºå•¥è¦å­¦è¿™äº›ä¸œè¥¿ï¼æ—¥å¿—æ”¶é›†åœ¨ç³»ç»Ÿä¸ç¨³å®šçš„æƒ…å†µä¸‹æ˜¯å¾ˆå®¹æ˜“ä¸¢å¤±æ—¥å¿—çš„æˆ–è€…ä½ åšä¸€äº›é«˜ç²¾åº¦çš„è¿‡æ»¤æ—¥å¿—ä¹Ÿä¸ç¬¦åˆï¼Œæ¯”å¦‚æˆ‘è¦æŸ¥çœ‹ä¸€ä¸‹latency&gt;10sçš„æ¥å£ï¼Œä½ æ—¥å¿—å’‹æœï¼ï¼æ‰€ä»¥è¿˜æ˜¯æœ‰å­¦ä¹ å¿…è¦æ€§çš„ï¼\næ­£åˆ™è¡¨è¾¾å¼å¦‚æœä½ ä¸šåŠ¡ä¸­å¤„ç†æ–‡æœ¬çš„éœ€æ±‚æ¯”è¾ƒå¤šçš„è¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨ä¸å®¹å°è§‘ï¼Œè€Œä¸”æ­£åˆ™è¡¨è¾¾å¼åºå¤§çš„çŸ¥è¯†ä½“ç³»ä¹Ÿéœ€è¦ç»å¸¸ç»ƒä¹ æ‰å¯ä»¥ï¼\n\n\n1ã€grep1. åŸºç¡€æ¦‚å¿µgrepå…¨åå«Global regular expression print, wiki: https://zh.wikipedia.org/zh-tw/Grepï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå…¨å±€çš„æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ç„¶åæ‰“å°ï¼\n2. æ—¥å¸¸ä½¿ç”¨grep æ˜¯æˆ‘ä»¬æ—¥å¸¸æœ€å¸¸è§å’Œä½¿ç”¨çš„å‘½ä»¤äº†ï¼Œä¸»è¦æ˜¯åšæ­£åˆ™åŒ¹é…åšæ—¥å¿—è¿‡æ»¤ï¼\nè¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹å¸¸ç”¨çš„å‘½ä»¤å’ŒæŠ€å·§å§\ngrep [-abcdDEFGHhIiJLlMmnOopqRSsUVvwXxZz] [-A num] [-B num] [-C[num]]     [-e pattern] [-f file] [--binary-files=value] [--color[=when]]     [--colour[=when]] [--context[=num]] [--label] [--line-buffered]     [--null] [pattern] [file ...]\n\nç®€å•åŒ¹é…å°±æ˜¯ cat biz.log | grep &#39;Error&#39; è¿‡æ»¤æ‰€æœ‰åŒ…å«Errorçš„è¡Œ\n\n-i å¯ä»¥å¿½ç•¥å¤§å°å†™ï¼Œæ¯”å¦‚ä¸Šé¢çš„grep -i error å®ƒå¯ä»¥åŒ¹é… errorå’ŒError ç­‰ï¼\n-v å–åï¼Œæ¯”å¦‚è¯´grep -v &#39;error&#39;ï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥å–infoã€debugã€warnçš„æ—¥å¿—äº†\n--colour=auto|always|neverï¼Œä¸€èˆ¬è®¾ç½®ä¸º --colour=always å°±å¯ä»¥é«˜äº®å±•ç¤ºäº†ï¼\n-E æ˜¯é«˜çº§æ­£åˆ™ï¼Œæ¯”å¦‚ä¸€äº›é«˜çº§çš„æ­£åˆ™ . æˆ–åˆ™\\w ï¼Œ\\d ç­‰ï¼Œå°±éœ€è¦äº†\n-Fä¸ºfgrep å…¶å®å°±æ˜¯--fixed-strings æœ¬è´¨ä¸Šå°±æ˜¯å¯¹äºæ­£åˆ™è¡¨è¾¾å¼ä¸è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”å¦‚\n\n\n3. æ€»ç»“æ‰€ä»¥ä¸€èˆ¬ä½ æ˜¯ç²¾ç¡®å­—ç¬¦åŒ¹é…çš„è¯ï¼Œæ¨èç”¨ grep -F æˆ–è€…fgrep , å¦‚æœä½ ç”¨çš„æ˜¯æ­£åˆ™åŒ¹é…çš„è¯æ¨èç”¨egrepå’Œgrep -E , å…·ä½“å·®å¼‚å¯ä»¥ä¸‹æˆ‘ä¸‹é¢æ­£åˆ™è¡¨è¾¾å¼é‚£ä¸ªç« èŠ‚ï¼\n4. å‚è€ƒæ–‡ç« \nGNU grep ä»‹ç»\n\n2ã€awk\nawk æ˜¯ä¸‰ä¸ªå¤§ä½¬å†™çš„ä¸€é—¨è¯­è¨€ï¼Œè¯´æ˜¯ä¸€é—¨è¯­è¨€å…¶å®ä¸è¶³ä¸ºè¿‡ï¼å› ä¸ºç¡®å®è´¼å‰å®³ï¼\n\n1. åŸºç¡€æ¦‚å¿µä»‹ç»awk æ•´ä½“æ ¼å¼å°±æ˜¯æœ‰ä¸€ç»„çš„ pattern-actionç»„æˆï¼Œä¸è¿‡ä¹Ÿæœ‰å¯èƒ½åªæœ‰actionï¼Œä½†æ˜¯å¿…é¡»è¦çŸ¥é“è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼ï¼\nå¤‡æ³¨: ä¸‹åˆ—ä¾‹å­å¯èƒ½ç”¨åˆ° out.logæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹: \nDan     3.75    0Kathy   4.00    10Mark    5.00    20Mary    5.50    22Susie   4.25    18\n\n\nç®€å•è¿‡æ»¤æ¨¡å¼ ï¼ˆpattern-actionï¼‰\n\nawk &#x27;$3&gt;0 &#123;print&#125;&#x27;  # pattern å°±æ˜¯ $3&gt;0 ï¼Œ &#123;print&#125; è¡¨ç¤ºè¡Œä¸ºï¼Œ å¦‚æœä¸æŒ‡å®š pattern é‚£ä¹ˆè¡¨ç¤ºæ— è¿‡æ»¤æ¡ä»¶ï¼Œ# æ¢æˆå…¶ä»–è¯­è¨€å°±æ˜¯for x:=0; x&lt;len; x++&#123;\t\tif (pattern) &#123;\t\t\t\taction()\t\t&#125;&#125;\n\n\n(action1) (action2) æ¨¡å¼\n\nawk &#x27;&#123;print&#125; &#123;print&#125;&#x27; # è½¬æ¢åfor x:=0; x&lt; len; x++&#123;\t\taction1()\t\taction2()&#125;\n\n\nå†…ç½®patternæ¨¡å¼, pattern=BEGIN / END\n\n# pattern=ENDï¼Œè¡¨ç¤ºç»“æŸawk &#x27;END &#123;print&#125;&#x27; # æ¢æˆå…¶ä»–è¯­è¨€å°±æ˜¯for x:=0; x&lt;len; x++&#123;&#125;action()# pattern=BEGINï¼Œè¡¨ç¤ºå¼€å§‹awk &#x27;BEGIN &#123;print&#125;&#x27; # æ¢æˆå…¶ä»–è¯­è¨€å°±æ˜¯action()for x:=0; x&lt;len; x++&#123;&#125;\n\n\nè¾“å‡ºå‡½æ•°\n\nawk &#x27;&#123;print 1, $1; print 2, $1&#125;&#x27;awk &#x27;&#123;print 1, $1&#125; &#123;print 2,$1&#125;&#x27; awk &#x27;&#123;printf &quot;1 %s\\n&quot;, $1; printf &quot;2 %s\\n&quot;, $1&#125;&#x27;...# ä¸Šè¯‰ä¾‹å­è¾“å‡ºå…¶å®æ˜¯ä¸€æ ·çš„ï¼\n\n\nif / else  \n\n\nå‰é¢è™½ç„¶è¯´äº† patternå¯ä»¥æ”¯æŒæ¡ä»¶è¿‡æ»¤ï¼Œä½†æ˜¯å¤ªè¿‡äºç®€å•ï¼ä¸æ”¯æŒelseè¯­å¥\n\nâœ  yulili cat out.log | awk &#x27;&#123;if ($3&gt;0) printf &quot;%s-%d gt 0\\n&quot;, $1, $3; else printf &quot;%s-%d eq 0\\n&quot;, $1,$3&#125;&#x27;Beth-0 eq 0Dan-0 eq 0Kathy-10 gt 0Mark-20 gt 0Mary-22 gt 0Susie-18 gt 0\n\n\nfor å¾ªç¯ ï¼Œä¸€èˆ¬ä¼šåœ¨ENDè¯­å¥ä¸­æ‰§è¡Œï¼\n\nâœ  yulili cat out.log | awk &#x27;END &#123; for (x=1; x&lt;NR; x++) printf &quot;row %d\\n&quot;, x&#125;&#x27;row 1row 2row 3row 4row 5\n\n\næ•°ç»„/mapï¼Œ å¯ä»¥é€šè¿‡ var[index]=valueæˆ–è€…var[key]=value  è¿›è¡Œå®šä¹‰ï¼åŒæ—¶å¯ä»¥é€šè¿‡ inè¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨\n\n# ç®€å•çš„ä¾¿åˆ©å¾ªç¯âœ  yulili cat out.log | awk &#x27;&#123;line[NR]=$0&#125; END &#123; for (x=1; x&lt;NR; x++) printf &quot;row: %s\\n&quot;, line[x]&#125;&#x27;row: Beth    4.00    0row: Dan     3.75    0row: Kathy   4.00    10row: Mark    5.00    20row: Mary    5.50    22# åˆ¤æ–­æ˜¯å¦å­˜åœ¨âœ  yulili cat out.log | awk &#x27;&#123;line[NR]=$0&#125;  END &#123;if (1 in line) print &quot;1 in line&quot;&#125; END &#123;if (0 in line) print &quot;0 in line&quot;&#125;&#x27;1 in line\n\n\næ­£åˆ™åŒ¹é…\n\n# ä¾‹å¦‚è¾“å‡ºMå¼€å¤´çš„ç”¨æˆ·ä¿¡æ¯âœ  yulili cat out.log| awk &#x27;$1 ~ &quot;^M&quot; &#123;print&#125;&#x27;Mark    5.00    20Mary    5.50    22# ä¾‹å¦‚è¾“å‡ºéMå¼€å¤´çš„ç”¨æˆ·ä¿¡æ¯âœ  yulili cat out.log| awk &#x27;$1 !~ &quot;^M&quot; &#123;print&#125;&#x27;Beth    4.00    0Dan     3.75    0Kathy   4.00    10Susie   4.25    18\n\n\nå†…ç½®å˜é‡\n\n\n\n\nå†…ç½®å˜é‡\nå«ä¹‰\n\n\n\nNRï¼ˆnumeric rowï¼‰\nè¡¨ç¤ºæ€»è¡Œæ•°ï¼Œå·²ç»é˜…è¯»çš„è¡Œæ•°ï¼Œ BEGIN=0ï¼ŒEND=total\n\n\nNFï¼ˆnumber fieldï¼‰\nè¡¨ç¤ºæ²¡è¡Œçš„åˆ—æ•°ï¼ŒBEGIN=0ï¼Œ END=pre_row_column\n\n\nFS (field separator)\nè¾“å…¥çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤åº”è¯¥æ˜¯ &quot; &quot;\n\n\nOFS(out field separator)\nè¾“å‡ºçš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤æ˜¯&quot; &quot;\n\n\n$0â€¦n\nå˜é‡ï¼Œ$0è¡¨ç¤ºæ•´ä¸ªåˆ—ï¼Œ$1è¡¨ç¤ºç¬¬ä¸€åˆ—ï¼Œæ³¨æ„å˜é‡æ˜¯å¯ä»¥è¢«ä¿®æ”¹ï¼\n\n\n\n\n\n\n\nä¾‹å¦‚æˆ‘ä¿®æ”¹FSå’ŒOFSï¼Œ FSä¸ºç©ºæ ¼ï¼Œè¾“å‡ºçš„OFSæ˜¯,\n\nâœ  yulili cat out.log | awk &#x27;BEGIN &#123; FS=&quot; &quot;; OFS=&quot;,&quot;&#125; &#123;print $1 ,$2 ,$3&#125;&#x27;Beth,4.00,0Dan,3.75,0Kathy,4.00,10Mark,5.00,20Mary,5.50,22Susie,4.25,18\n\n\nå†…ç½®å‡½æ•°\n\n\n\n\nå†…ç½®å‡½æ•°\nå«ä¹‰\n\n\n\nprint\næ¢è¡Œè¾“å‡º, eg:  awk &#39;&#123;print $1, $2, $3; print $1, $2&#125;&#39;\n\n\nprintf\nformatè¾“å‡º, eg:  awk &#39;&#123;printf &quot;ç¬¬ä¸€åˆ—: %d&quot;, $1&#125;&#39;\n\n\nlength(s)\nsä¸ºå­—ç¬¦ä¸²ï¼Œè¾“å‡ºå­—ç¬¦ä¸²é•¿åº¦\n\n\nsubstr(s,p)\nsä¸ºå­—ç¬¦ä¸²ï¼Œpä¸ºindexï¼Œè¾“å‡ºä»indexåæˆªå–çš„å­—ç¬¦ä¸²\n\n\ngsub(r,s,t)\nå°†å­—ç¬¦ä¸²tä¸­çš„ r æ›¿æ¢ä¸ºsï¼Œ è¾“å‡ºå­—ç¬¦ä¸²\n\n\nstrtonum(s)\nsä¸ºå­—ç¬¦ä¸²ï¼Œè¾“å‡ºä¸ºnumeric\n\n\nrand()\nè¾“å‡ºä¸€ä¸ªéšæœºæ•°\n\n\nint(x)\nè¾“å‡ºxçš„æ•´æ•°éƒ¨åˆ†\n\n\n\nä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨gsubå‡½æ•°æ›¿æ¢ï¼Œè¿™é‡Œå¯èƒ½æ³¨æ„å¯ä»¥æ­£åˆ™æ›¿æ¢\n\nâœ  yulili cat out.log| awk &#x27;&#123;gsub(&quot;\\\\.&quot;,&quot;0&quot;,$2)&#125;&#123;print $2&#125;&#x27;400030754000500050504025\n\n2. ç®€å•ä¾‹å­ä»‹ç»\næŸ¥è¯¢å·¥æ—¶å¤§äº0çš„è®°å½•\n\nâœ  yulili cat out.log | awk &#x27;$3&gt;0 &#123;print&#125;&#x27;Kathy   4.00    10Mark    5.00    20Mary    5.50    22Susie   4.25    18\n\n\næŸ¥è¯¢å·¥æ—¶å¤§äº0çš„äººå‘˜æ•°é‡ ï¼Œ ä¸šåŠ¡ä¸­æ¯”è¾ƒé€‚åˆè¿‡æ»¤ latency &gt; xxxmsçš„æ•°é‡ï¼\n\nâœ  yulili cat out.log | awk &#x27;$3&gt;0 &#123;emp=emp+1&#125; END &#123;printf &quot;total emp: %d\\n&quot;, emp&#125;&#x27;total emp: 4\n\n\næŸ¥è¯¢å¹³å‡å·¥èµ„ (å·¥æ—¶*å·¥æ—¶è´¹ç”¨/ äººå‘˜) ï¼Œ å…¶å®å§ä¸šåŠ¡ä¸­æ¯”è¾ƒé€‚åˆæ±‚avg-latency\n\nâœ  yulili cat out.log | awk &#x27;&#123; salary = salary + $2*$3 &#125; END &#123; printf &quot;avg salary: %d\\n&quot;, salary / NR &#125;&#x27;avg salary: 56\n\n3. ä½¿ç”¨æŠ€å·§æŠ€å·§\næ¯”å¦‚ç»å¸¸å‡ºç°æˆ‘ä»¬è¦æ£€æŸ¥ latency &gt; xxx çš„access_log ï¼Œæ€ä¹ˆè§£å†³äº†ï¼Œç”±äºæˆ‘ä»¬æ—¥å¿—ä¸­ latencyæ˜¯è¿™ä¹ˆè®°å½•çš„cost=251045ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è¿‡æ»¤çš„æ—¶å€™éœ€è¦å­—ç¬¦ä¸²æ“ä½œï¼Œè¿™æ—¶å€™éœ€è¦substr(str, index) å‡½æ•°å–å‡ºæ¥lantencyï¼Œç„¶åå–å‡ºæ¥å®é™…ä¸Šæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé‚£ä¹ˆæ­¤æ—¶éœ€è¦é€šè¿‡+0æ¥è½¬æ¢ä¸ºintï¼ï¼ æˆ–è€…é€šè¿‡å‡½æ•° strtonumè¿›è¡Œè½¬æ¢ï¼Œ ä¸‹é¢ä¾‹å­æ˜¯å–å‡ºå¤§äº200msçš„æ—¥å¿—çš„logid\n\n# cat access.log | awk &#x27;strtonum(substr($11,6)) &gt; 200000 &#123;print $6 ,$11, substr($11,6)&#125;&#x27;# cat access.log | awk &#x27;substr($11,6)+0 &gt; 200000 &#123;print $6 ,$11, substr($11,6)&#125;&#x27;20220312000212010212043169032F1158 cost=358144 35814420220312000442010150139043227E02C8 cost=251045 25104520220312002645010150132075097C7676 cost=532952 5329522022031200293601021009615805605CF5 cost=256238 25623820220312002943010211182012276F60AD cost=298612 2986122022031200295801021009615805606647 cost=213975 21397520220312003410010150135045168607FA cost=366926 366926202203120037310101501390291691A893 cost=4882332 4882332202203120039100101501322000F82B0D0 cost=276756 276756\n\n\næ–‡æœ¬å¤„ç†ï¼Œä¾‹å¦‚ä»¥ä¸‹æ–‡æœ¬\n\na,b,cd1,c1,a1d2\n\néœ€æ±‚æ˜¯éœ€è¦æŒ‰, åˆ†å‰²ï¼Œä¸”è¦æ‹¼æ¥å­—ç¬¦ä¸²ï¼å¦‚ a,b,c éœ€è¦è¾“å‡º t1.a=t2.a and t1.b=t2.b and t1.c=t2.c ï¼Œ å¯ä»¥ä¸‹é¢è¿™ä¹ˆå†™ï¼\ncat text.txt| awk &#x27;BEGIN &#123; FS=&quot;,&quot; &#125;$0 ~ /\\S/ &#123;        sql=&quot;&quot;        for (x=1;x&lt;=NF;x++) &#123;                if ( x != NF )&#123;                        sql= sprintf (&quot;%s a.%s=b.%s and&quot;,sql, $x, $x)                &#125;else&#123;                        sql= sprintf (&quot;%s a.%s=b.%s&quot;, sql, $x, $x)                &#125;        &#125;        sqls[NR]=sql&#125;END &#123;        for (x=1;x&lt;=NR;x++)&#123;                if ( x in sqls) &#123;                        printf &quot;sql: %s\\n&quot;, sqls[x] #  todo æ‹¼æ¥sql                &#125;        &#125;&#125;&#x27;\n\n4. å‚è€ƒæ–‡ç« \nawk ç®€å•ä»‹ç»\næ¨è: awkä¸­æ–‡æ–‡æ¡£\n\n3ã€sed1. åŸºç¡€å­¦ä¹ sedå…¨åå«stream editorï¼Œæµç¼–è¾‘å™¨ï¼Œç”¨ç¨‹åºçš„æ–¹å¼æ¥ç¼–è¾‘æ–‡æœ¬ã€‚sedåŸºæœ¬ä¸Šå°±æ˜¯ç©æ­£åˆ™æ¨¡å¼åŒ¹é…ï¼Œæ‰€ä»¥ï¼Œç©sedçš„äººï¼Œæ­£åˆ™è¡¨è¾¾å¼ä¸€èˆ¬éƒ½æ¯”è¾ƒå¼ºã€‚å…¶æ¬¡å°±æ˜¯gunçš„sedå‡½æ•°å’Œmacçš„sedæ˜¯æœ‰äº›ä¸åŒçš„ï¼Œmacä¸Šç©sedæ¨èç”¨gsedï¼\nè¿™é‡Œæˆ‘å°±ä»‹ç»ä¸€äº›ç®€å•çš„ç”¨æ³•ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸è¿›è¡Œçš„æ‰¹é‡æ›¿æ¢æ¯”å¦‚æŠŠä»£ç ä¸­æŸä¸ªå˜é‡åæ›¿æ¢ä¸ºå¦ä¸€ä¸ªå˜é‡åï¼Œæˆ–è€…é…ç½®æ–‡ä»¶ä¹‹ç±»çš„ï¼Œæˆ–è€…è¿›è¡Œç®€å•çš„æ–‡æœ¬æ“ä½œï¼\n\næ›¿æ¢ï¼Œç”¨æ³•å°±æ˜¯ sed  &#39;s/a/b/g&#39; file , æ„æ€å°±æ˜¯æŠŠaæ›¿æ¢ä¸ºbï¼Œå…¨å±€æ›¿æ¢\n\n\ns: substitute\n\nâœ  docs cat test.logaaaaaabbbbbbaaaaaacccccc# æŠŠaæ›¿æ¢æˆbï¼Œæ¯è¡Œç¬¬ä¸€ä¸ªâœ  docs cat test.log| sed &#x27;s/a/b/&#x27;baaaaabbbbbbbaaaaacccccc# æœ€ååŠ ä¸€ä¸ªgè¡¨ç¤ºglobalçš„æ„æ€ï¼Œè¡¨ç¤ºæ¯è¡Œå…¨å±€æ›¿æ¢ï¼âœ  docs cat test.log| sed &#x27;s/a/b/g&#x27;bbbbbbbbbbbbbbbbbbcccccc# è¡¨ç¤ºä»ç¬¬ä¸‰ä¸ªå­—ç¬¦å¼€å§‹æ›¿æ¢âœ  docs cat test.log| sed &#x27;s/a/b/3g&#x27;aabbbbbbbbbbaabbbbcccccc# s å¯ä»¥é€šè¿‡[start,end]æ¥ä¿®é¥°è¡Œæ•°ï¼Œæ¯”å¦‚ 1-3è¡Œå¯ä»¥ 1,3sï¼Œ æ¯”å¦‚1è¡Œå¯ä»¥1sï¼Œæœ«å°¾è¡Œå¯ä»¥ $s, æ¯”å¦‚2-æœ€åä¸€è¡Œå¯ä»¥ç”¨2,$è¡¨ç¤ºâœ  docs cat test.log| sed &#x27;1,3s/a/b/g&#x27;bbbbbbbbbbbbbbbbbbcccccc# åªæ›¿æ¢ç¬¬ä¸€è¡Œâœ  docs cat test.log| sed &#x27;1s/a/b/g&#x27;bbbbbbbbbbbbaaaaaacccccc# åªæ›¿æ¢æœ€åä¸€è¡Œâœ  docs cat test.log| sed &#x27;$s/c/a/g&#x27;aaaaaabbbbbbaaaaaaaaaaaa\n\næ³¨æ„ï¼šå¦‚æœä½ è¦ä½¿ç”¨å•å¼•å·ï¼Œé‚£ä¹ˆä½ æ²¡åŠæ³•é€šè¿‡\\è¿™æ ·æ¥è½¬ä¹‰ï¼Œå°±æœ‰åŒå¼•å·å°±å¯ä»¥äº†ï¼Œåœ¨åŒå¼•å·å†…å¯ä»¥ç”¨\\â€æ¥è½¬ä¹‰ã€‚\n\næ­£åˆ™æ›¿æ¢ï¼Œä½†æ˜¯ä¸€èˆ¬æ¨èä½¿ç”¨æ­£åˆ™ç›´æ¥æºå¸¦ -Eå‚æ•°ï¼Œæ³¨æ„ä¼šæœ‰ä¸€äº›è½¬ä¹‰å­—ç¬¦ï¼Œéœ€è¦é€šè¿‡\\æ¥å¤„ç†\n\nâœ  docs cat test.log| sed  -E &#x27;2,$s/\\w/a/g&#x27;aaaaaaaaaaaaaaaaaaaaaaaa\n\n\næ·»åŠ /æ’å…¥/åˆ é™¤/æ›¿æ¢æ–‡æœ¬ï¼Œ sed &#39;a1 æ–‡æœ¬&#39;ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€è¡Œåé¢æ·»åŠ æ–‡æœ¬ï¼Œsed &#39;i1 æ–‡æœ¬&#39;å«ä¹‰å°±æ˜¯åœ¨ç¬¬ä¸€è¡Œæ’å…¥æ–‡æœ¬\n\n\na: append\ni: insert\nd: delete\n\n# åœ¨ç¬¬ä¸€è¡Œåé¢æ·»åŠ zzzzzzâœ  docs cat test.log | sed &#x27;1a zzzzzz&#x27;aaaaaazzzzzzbbbbbbaaaaaacccccc# åœ¨æœ€åä¸€è¡Œæ·»åŠ `zzzzzz`âœ  docs cat test.log | sed &#x27;$a zzzzzz&#x27;aaaaaabbbbbbaaaaaacccccczzzzzz# ç¬¬ä¸€è¡Œæ’å…¥ `zzzzzz`âœ  docs cat test.log | sed &#x27;1i zzzzzz&#x27;zzzzzzaaaaaabbbbbbaaaaaacccccc# åˆ é™¤ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œï¼âœ  docs cat test.log | sed &#x27;1d;$d&#x27;bbbbbbaaaaaa\n\n\næˆªå–æ–‡æœ¬ \n\n# é€‰æ‹©ç¬¬2-3è¡Œæ–‡æœ¬ï¼Œæ³¨æ„è¿™é‡Œå¿…é¡»åŠ -nå‚æ•°ï¼Œå¦åˆ™ä¼šé‡å¤æ‰“å°âœ  docs cat test.log| sed  -n &#x27;2,3p&#x27;bbbbbbaaaaaa# æ‰“å°âœ  docs cat test.log| sed  -n &#x27;/b/p&#x27;bbbbbb# æ‰“å°bæˆ–è€…cçš„æ–‡æœ¬âœ  docs cat test.log| sed  -n &#x27;/\\(\\(b\\|c\\)\\)/p&#x27;bbbbbbcccccc\n\n2. æ€»ç»“\nå‘½ä»¤é€šç”¨æ ¼å¼ [addr]/[regexp]/[flags] æˆ–è€… [addr]/[regexp]/[replace content]/[false] \nå¤šä¸ªå‘½ä»¤å¯ä»¥é€šè¿‡ ;è¿›è¡Œåˆ†å‰²\n 2addrè¡¨ç¤ºå¯ä»¥é€šè¿‡ 1,2è¿›è¡Œé€‰æ‹©è¡Œæ“ä½œ\n1addråªæ”¯æŒ1æˆ–è€…$æˆ–è€… â€¦.\nsed -i æ˜¯ç›´æ¥æ›¿æ¢åŸæ–‡æœ¬ï¼æ‰€ä»¥ä¸æ¨èè¿™ä¹ˆä½¿ç”¨ï¼Œå¯ä»¥ç”¨é‡å®šå‘ç¬¦å·è¿›è¡Œæ“ä½œï¼\nsed -E è¡¨ç¤ºä½¿ç”¨æ‹“å±•æ­£åˆ™ï¼å¦‚æœä½ ä½¿ç”¨æ­£åˆ™åˆ™æ¨èä½¿ç”¨è¿™ä¸ªï¼\nmac ä¸Šæ¨èä½¿ç”¨gsedå‘½ä»¤ï¼\n\n\n\n\nå‘½ä»¤\nå¤‡æ³¨\n\n\n\n[2addr]s/regular expression/replacement/flags\næŠŠregular expressionæ›¿æ¢æˆreplacement\n\n\nw file\nå†™å…¥åˆ°fileä¸­\n\n\nr file\nè¯»å–æ–‡ä»¶\n\n\n[2addr]x\næ¸…ç©ºæŸè¡Œ 1xè¡¨ç¤ºæ¸…ç©ºç¬¬ä¸€è¡Œï¼Œ Swap the contents of the pattern and hold spaces.\n\n\n[1addr]a text\napped text\n\n\n[1addr]i  text\ninsert text\n\n\n[2addr] d\ndelete æŒ‡å®šè¡Œ\n\n\n/regexp/d\nåˆ é™¤åŒ¹é…è¡Œ\n\n\n-n &#39;[2addr]p&#39;\nprint æ‰“å°æŒ‡å®šè¡Œ\n\n\n-n /regexp/p\næ‰“å°åŒ¹é…è¡Œ\n\n\n3. å‚è€ƒæ–‡ç« \nGNU sed æ–‡æ¡£\nsed ç®€æ˜æ•™ç¨‹\n\n4ã€Dashå¦‚æœä½ ç”¨çš„æ˜¯macä½œä¸ºä½ çš„å¼€å‘ç¯å¢ƒï¼Œæˆ‘æ¨èä½ ä½¿ç”¨dashè¿›è¡Œå‘½ä»¤æˆ–è€…ä»£ç åº“æ£€ç´¢ï¼æ¯”è¾ƒå¥½ç”¨ï¼Œå› ä¸ºå¹³æ—¶æ¯”å¦‚æˆ‘ä»¬ç»å¸¸é‡åˆ°å†™ä»£ç å¿˜è®°apiçš„ï¼Œå¯ä»¥é€šè¿‡dashè¿›è¡Œæœç´¢ï¼\nä¸è¿‡Linuxçš„GNUå‘½ä»¤éƒ½ä¼šæºå¸¦å¸®åŠ©çš„ï¼çœ‹ä¸ªäººå–œå¥½å§ï¼\n\n5ã€ æ­£åˆ™è¡¨è¾¾å¼å…¶å®ä¸éš¾å‘ç°ï¼Œåªè¦æ–‡æœ¬å¤„ç†å°±ç¦»ä¸å¼€ æ­£åˆ™è¡¨è¾¾å¼  (Regular Expression) ï¼Œå¯èƒ½æœ‰äº›åŒå­¦ä¼šè¯´ é€šé…ç¬¦ï¼ˆwildcardï¼‰ï¼Œç¡®å®é€šé…ç¬¦å¯ä»¥è§£å†³ä¸€éƒ¨åˆ†é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›æ—¶å€™è¿˜æ˜¯æ­£åˆ™æ›´åŠ å¼ºå¤§å’Œçµæ´»ï¼Œå…¶å®é€šé…ç¬¦æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„å‰èº«ï¼Œå‡ºç”Ÿæ›´æ—©!\n1. é€šé…ç¬¦\n* åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ ï¼ˆæœ‰ç‚¹åƒæ•°æ®åº“çš„é€šé…ç¬¦*ï¼‰\n\n? åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼ˆæœ‰ç‚¹åƒæ•°æ®åº“çš„é€šé…ç¬¦_ï¼‰\n\n[char_list]  åŒ¹é…char_listä¸­ä»»æ„å•ä¸ªå­—ç¬¦\n\n[^char_list] or [!char_list] æ’é™¤ char_listä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦\n\n\nâœ  test_file ls *.filea.file  ab.file  c.file  cd.fileâœ  test_file ls -a./  ../  a.file  ab.file  c.file  cd.fileâœ  test_file ls *.filea.file  ab.file  c.file  cd.fileâœ  test_file ls [a].filea.fileâœ  test_file ls [a]?.fileab.fileâœ  test_file ls [a]*.filea.file  ab.fileâœ  test_file ls [ac]*.filea.file  ab.file  c.file  cd.fileâœ  test_file ls [^a].filec.fileâœ  test_file ls [^a]*.filec.file  cd.file\n\n\n&#123;xxx1,xxx2,xxx3&#125;  åªèƒ½æ˜¯ xxx1 or xxx2 or xxx3 , æ¨¡å¼, è¿™ä¸ªæ¯”è¾ƒå¸¸è§ä¸»è¦ç”¨ä½œåˆ›å»ºæ–‡ä»¶lsæ–‡ä»¶\n\nâœ  test_file ls &#123;a,ab&#125;.filea.file  ab.fileâœ  test_file ls &#123;a,c&#125;*.filea.file  ab.file  c.file  cd.fileâœ  test_file touch d&#123;a,b,c,d&#125;.fileâœ  test_file ls d&#123;a,b,c,d&#125;.fileda.file  db.file  dc.file  dd.file\n\n\n &#123;start..end&#125; è¡¨ç¤ºåŒ¹é… start-&gt;end ä¸­çš„å­—ç¬¦ï¼Œ æ¯”è¾ƒé€‚åˆforå¾ªç¯ï¼ï¼å…¶ä¸­æ”¯æŒæ•°å­—å’Œå­—æ¯\n\nâœ  test_file for x in &#123;1..10&#125;; do echo &quot;num: $&#123;x&#125;&quot;; donenum: 1num: 2num: 3num: 4num: 5num: 6num: 7num: 8num: 9num: 10\n\næœ€åä»‹ç»ä¸‹ é€šé…ç¬¦æ‰§è¡ŒåŸç†ï¼Œé€šé…ç¬¦é¡¾åæ€ä¹‰å°±æ˜¯æ‰§è¡Œçš„å®ç°å…ˆè¿›è¡Œè§£é‡Šï¼Œä¹Ÿå°±æ˜¯æ¯”å¦‚ ls *.file å…ˆè§£ææˆls a.file å†æ‰§è¡Œ ls a.fileï¼Œ å‡å¦‚æ²¡æœ‰åŒ¹é…ä¼šå¯¼è‡´æŠ¥é”™æˆ–è€…ç¨‹åºä¸ç¬¦åˆé¢„æœŸ\n2. æ­£åˆ™è¡¨è¾¾å¼ä¸€ (åŸºç¡€)åŸºç¡€æ„Ÿè§‰ä¸ç”¨è¯´ï¼Œå¯ä»¥çœ‹ä¸‹ https://github.com/Anthony-Dong/learn-regex-zh  , æƒ³å¿…çœ‹è¿™ç¯‡æ–‡ç« çš„äººæ­£åˆ™åŸºæœ¬éƒ½è¿˜æ˜¯å¯ä»¥çš„ï¼ è¿™é‡Œæ¨èä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„å¯è§†åŒ–ç½‘ç«™ https://regexper.com/\n\nå…ƒå­—ç¬¦ï¼Œè¿™ç±»å­—ç¬¦ä¼šæœ‰ç‰¹æ®Šå«ä¹‰ï¼Œæ‰€ä»¥å¦‚æœä½ æ­£åˆ™ä¸­æƒ³è¦ä¸è¡¨ç¤ºç‰¹æ®Šå«ä¹‰å°±éœ€è¦è½¬ä¹‰äº†ï¼ ä»¥ä¸‹åˆ—è¡¨ POSIX Extended å’Œ Perl å…¨éƒ¨æ”¯æŒ ï¼POSIX éƒ¨åˆ†ä¸æ”¯æŒï¼\n\n\n\n\nå…ƒå­—ç¬¦\næè¿°\n\n\n\n.\nåŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦ã€‚\n\n\n[ ]\nå­—ç¬¦ç±»ï¼ŒåŒ¹é…æ–¹æ‹¬å·ä¸­åŒ…å«çš„ä»»æ„å­—ç¬¦ã€‚\n\n\n[^ ]\nå¦å®šå­—ç¬¦ç±»ã€‚åŒ¹é…æ–¹æ‹¬å·ä¸­ä¸åŒ…å«çš„ä»»æ„å­—ç¬¦\n\n\n*\nåŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡\n\n\n+\nåŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼ä¸€æ¬¡æˆ–å¤šæ¬¡\n\n\n?\nåŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡ï¼Œæˆ–æŒ‡æ˜ä¸€ä¸ªéè´ªå©ªé™å®šç¬¦ã€‚\n\n\n{n,m}\nèŠ±æ‹¬å·ï¼ŒåŒ¹é…å‰é¢å­—ç¬¦è‡³å°‘ n æ¬¡ï¼Œä½†æ˜¯ä¸è¶…è¿‡ m æ¬¡ã€‚\n\n\n(xyz)\nå­—ç¬¦ç»„ï¼ŒæŒ‰ç…§ç¡®åˆ‡çš„é¡ºåºåŒ¹é…å­—ç¬¦ xyzã€‚\n\n\n|\nåˆ†æ”¯ç»“æ„ï¼ŒåŒ¹é…ç¬¦å·ä¹‹å‰çš„å­—ç¬¦æˆ–åé¢çš„å­—ç¬¦ã€‚\n\n\n\\\nè½¬ä¹‰ç¬¦ï¼Œå®ƒå¯ä»¥è¿˜åŸå…ƒå­—ç¬¦åŸæ¥çš„å«ä¹‰ï¼Œå…è®¸ä½ åŒ¹é…ä¿ç•™å­—ç¬¦ `[ ] ( ) { } . * + ? ^ $ \\\n\n\n^\nåŒ¹é…è¡Œçš„å¼€å§‹\n\n\n$\nåŒ¹é…è¡Œçš„ç»“æŸ\n\n\n\nç®€å†™å­—ç¬¦é›†ï¼Œè¿™ä¸ªæ¯”è¾ƒå¸¸ç”¨ï¼Œå› ä¸ºç¡®å®è¿™ç±»ç®€å†™å­—ç¬¦é›†å¾ˆæ–¹ä¾¿ï¼Œçœä»£ç ï¼ ä»¥ä¸‹åªè¦ Perl å…¨éƒ¨æ”¯æŒï¼ŒPOSIX æ”¯æŒä¸å‹å¥½ï¼\n\n\n\n\nç®€å†™\næè¿°\n\n\n\n.\nåŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦\n\n\n\\w\nåŒ¹é…æ‰€æœ‰å­—æ¯å’Œæ•°å­—çš„å­—ç¬¦ï¼š[a-zA-Z0-9_]\n\n\n\\W\nåŒ¹é…éå­—æ¯å’Œæ•°å­—çš„å­—ç¬¦ï¼š[^\\w]\n\n\n\\d\nåŒ¹é…æ•°å­—ï¼š[0-9]\n\n\n\\D\nåŒ¹é…éæ•°å­—ï¼š[^\\d]\n\n\n\\s\nåŒ¹é…ç©ºæ ¼ç¬¦ï¼š[\\t\\n\\f\\r\\p&#123;Z&#125;]\n\n\n\\S\nåŒ¹é…éç©ºæ ¼ç¬¦ï¼š[^\\s]\n\n\n3. æ­£åˆ™è¡¨è¾¾å¼äºŒ (åˆ†ç»„)è¯´å®è¯ï¼Œä¸šåŠ¡ä¸­æˆ‘é‡åˆ°åˆ†ç»„çš„æƒ…å†µä¹Ÿä¸å°‘ï¼Œä½†æ˜¯å¤§å¤šæ•°äººä¹ŸåŸºæœ¬ä¸ä¼šç”¨ï¼Œä¹Ÿå°±æ˜¯å†™ä¸ªåŸºç¡€æ­£åˆ™ç½¢äº†ï¼åˆ†ç»„ä½œç”¨å°±æ˜¯å°†æ­£åˆ™åˆ†ä¸ºå¤šä¸ªç»„ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å–æ¯ä¸ªç»„å†…éƒ¨çš„ä¸œè¥¿ï¼ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘è¦åŒ¹é…ä¸€ä¸ªæ–‡æœ¬ 2020å¹´ 01æœˆ 02æ—¥ ï¼Œæˆ‘è¦ç¬¬ä¸€åŒ¹é…ï¼Œç¬¬äºŒå–å‡ºæ¥å¹´æœˆæ—¥ï¼\nimport (\t&quot;regexp&quot;\t&quot;testing&quot;\t&quot;github.com/anthony-dong/go-sdk/commons&quot;\t&quot;github.com/stretchr/testify/assert&quot;)func TestMatch(t *testing.T) &#123;\tre := regexp.MustCompile(`^\\d+å¹´\\s*\\d&#123;1,2&#125;æœˆ\\s*\\d&#123;1,2&#125;æ—¥$`)\tassert.Equal(t, re.MatchString(&quot;2020å¹´ 01æœˆ 02æ—¥&quot;), true)\tassert.Equal(t, re.MatchString(&quot;2020å¹´01æœˆ02æ—¥&quot;), true)\tassert.Equal(t, re.MatchString(&quot;2020å¹´\t01æœˆ\t02æ—¥&quot;), true)\tassert.Equal(t, re.MatchString(&quot;01æœˆ02æ—¥&quot;), false)&#125;func TestGroup(t *testing.T) &#123;\tre := regexp.MustCompile(`^(\\d+)å¹´\\s*(\\d&#123;1,2&#125;)æœˆ\\s*(\\d&#123;1,2&#125;)æ—¥$`)\tresult := re.FindStringSubmatch(&quot;2020å¹´ 01æœˆ 02æ—¥&quot;)\tt.Logf(&quot;%#v\\n&quot;, result)\tassert.Equal(t, len(result), 4)\tt.Logf(&quot;å¹´: %s, æœˆ %s, æ—¥: %s\\n&quot;, result[1], result[2], result[3])&#125;// output://    regexp_test.go:22: []string&#123;&quot;2020å¹´ 01æœˆ 02æ—¥&quot;, &quot;2020&quot;, &quot;01&quot;, &quot;02&quot;&#125;//    regexp_test.go:24: å¹´: 2020, æœˆ 01, æ—¥: 02func TestNameGroup(t *testing.T) &#123;\tre := regexp.MustCompile(`^(?P&lt;year&gt;\\d+)å¹´\\s*(?P&lt;month&gt;\\d&#123;1,2&#125;)æœˆ\\s*(?P&lt;day&gt;\\d&#123;1,2&#125;)æ—¥$`)\tresult := re.FindStringSubmatch(&quot;2020å¹´ 01æœˆ 02æ—¥&quot;)\tnames := re.SubexpNames()\tfor _, elem := range names &#123;\t\tt.Logf(&quot;sub exp name: %s\\n&quot;, elem)\t&#125;\tmapData := make(map[string]string)\tfor index, elem := range names &#123;\t\tif index == 0 &#123;\t\t\tcontinue\t\t&#125;\t\tmapData[elem] = result[index]\t&#125;\tt.Logf(&quot;%s\\n&quot;, commons.ToJsonString(mapData))&#125;// output://    regexp_test.go:35: sub exp name: //    regexp_test.go:35: sub exp name: year//    regexp_test.go:35: sub exp name: month//    regexp_test.go:35: sub exp name: day//    regexp_test.go:44: &#123;&quot;day&quot;:&quot;02&quot;,&quot;month&quot;:&quot;01&quot;,&quot;year&quot;:&quot;2020&quot;&#125;\n\nä¸è¿‡Goè¯­è¨€ä¹Ÿæä¾›äº†ä¸€äº›é«˜é˜¶ç”¨æ³•ï¼Œè¿™é‡Œæ ¹æ®éœ€æ±‚è¿›è¡Œä½¿ç”¨ï¼\n# re è¡¨ç¤ºæ­£åˆ™è¡¨è¾¾å¼(re)  æœ€ç®€å•çš„åˆ†ç»„ä½¿ç”¨æ³•ï¼Œé€šè¿‡indexè·å–(?P&lt;name&gt;re)  å¯ä»¥å¯¹åˆ†ç»„è¿›è¡Œå‘½å(?:re)  \tä¸ä¼šå¯¹å½“å‰åˆ†ç»„è¿›è¡Œæ•è·(?flags)\tè®¾ç½®å½“å‰æ‰€åœ¨åˆ†ç»„çš„æ ‡å¿—ï¼Œä¸æ•è·ä¹Ÿä¸åŒ¹é…\n\n4. æ­£åˆ™è¡¨è¾¾å¼æ ‡å‡†åˆ†ç±»æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯ç»å†äº†ä¸æ–­çš„å‘å±•ï¼Œç›®å‰æ—¥è¶‹å®Œå–„ï¼Œç›®å‰ä¸»æµè®¡ç®—æœºé«˜çº§è¯­è¨€éƒ½æ˜¯ä½¿ç”¨çš„perlæ ‡å‡†ï¼Œæœªæ¥perlä¹Ÿä¼šæˆä¸ºæ­£åˆ™è¡¨è¾¾å¼çš„æ ‡å‡†ï¼ˆä¸è¿‡ç›®å‰å°±æ˜¯ï¼‰ï¼ä½†æ˜¯è¯´æ˜¯æ ‡å‡†ä½†æ˜¯æ¯•ç«Ÿè¿˜æ˜¯æœ‰äº›å·¥å…·ä»ç„¶ä½¿ç”¨POSIXï¼ æ‰€ä»¥æˆ‘ä»¬è®²ä¸€ä¸‹åŒºåˆ«ï¼\n\nPOSIX  or BRE( Basic Regular Expression)\nPOSIX Extended  or  ERE (Extended Regular Express)\nPerl or   PCRE (Perl Compatible Regular Expression)\n\n\nç›®å‰å¸¸è§çš„grep å°±æ˜¯ç”¨çš„  POSIX æ ‡å‡†ï¼Œè€Œ grep -E æˆ–è€… egrep å°±æ˜¯ç”¨çš„ POSIX Extended æ ‡å‡†äº†ï¼åƒlinuxå‘½ä»¤ç›®å‰åŸºæœ¬ä¸Šéƒ½æ˜¯èµ°çš„POSIX æ ‡å‡†ï¼Œæœ‰äº›å¯èƒ½ä¼šæ‹“å±•POSIX Extended ï¼\n\n\n\nä¸»è¦åŒºåˆ«å°±æ˜¯è½¬ä¹‰å­—ç¬¦çš„åŒºåˆ«äº†ï¼Œ åƒPOSIX çš„è½¬ä¹‰å­—ç¬¦æœ‰ .ã€\\ã€[ã€^ã€$ã€* ï¼Œ ä½†æ˜¯ POSIX Extended  å¤šäº†7ä¸ªéœ€è¦è½¬ä¹‰çš„å­—ç¬¦ (ã€)ã€&#123;ã€&#125;ã€+ã€?ã€|    å…¶å®è¯´ç™½äº†å°±æ˜¯ä¸æ”¯æŒ å­—ç¬¦ç»„å’ŒèŠ±æ‹¬å·è¿˜æœ‰ +å’Œ? !\n\n\n\n\n\nPerl å’Œ POSIXä¸»è¦åŒºåˆ«ä¹Ÿå¾ˆç®€å•,  å°±æ˜¯ä¸æ”¯æŒç®€å†™å­—ç¬¦é›†ï¼ä½†æ˜¯Goè¯­è¨€å¥½åƒæ˜¯POSIXå®Œå…¨ä¸å…è®¸ç®€å†™å­—ç¬¦é›†ï¼æ‰€ä»¥å‡å¦‚æˆ‘ä»¬ä½¿ç”¨POSIXè¿˜æ˜¯ä¸ç”¨ç®€å†™å­—ç¬¦é›†å§ï¼\n\nfunc TestPOSIX(t *testing.T) &#123;\t// è¿™é‡Œä¸å…è®¸ä½¿ç”¨ perl çš„ `\\d` ä¹‹ç±»çš„....\tassert.Equal(t, regexp.MustCompilePOSIX(`^[0-9]+`).MatchString(&quot;123abc&quot;), true)\t// panic\tassert.Equal(t, assert.Panics(t, func() &#123;\t\tregexp.MustCompilePOSIX(`^[\\d]+`).MatchString(&quot;123abc&quot;)\t&#125;), true)&#125;func TestPerl(t *testing.T) &#123;\tassert.Equal(t, regexp.MustCompile(`^[\\d]+`).MatchString(&quot;123abc&quot;), true)&#125;\n\n5. æ€»ç»“â€‹    æ€»ç»“ä¸€äº›ï¼Œå‡å¦‚æˆ‘ä»¬ç°åœ¨è¦å†™ä¸€ä¸ªæ­£åˆ™ï¼Œé‚£ä¹ˆéœ€è¦ç¡®å®šæ˜¯å¦ä½¿ç”¨Perlï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆæˆ‘ä»¬éœ€è¦ç¡®è®¤æ˜¯å¦æ”¯æŒ POSIX Extended ï¼ç„¶åå°±æ˜¯æˆ‘ä»¬åˆ«ç”¨ç®€å†™å­—ç¬¦é›†å°±è¡Œäº†ï¼\nè¿˜æœ‰æ–­è¨€æˆ‘æ²¡æœ‰è®²åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œå°±å·æ‡’äº†ï¼åç»­è¡¥å……ï¼æ—¥å¸¸ä¸­ç¡®å®æ²¡ç”¨åˆ°æ–­è¨€ï¼\n6. å‚è€ƒæ–‡ç« \næ­£åˆ™è¡¨è¾¾å¼å­¦ä¹ \n\nBREå’ŒEREåŒºåˆ«\n\nGoè¯­è¨€æ ‡å‡†åº“ regexp å­¦ä¹ \n\n\n7. bashbash å’Œshçš„åŒºåˆ«åœ¨äºï¼Œshéµå®ˆPOSIXæ ‡å‡†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä½¿ç”¨bashï¼Œå…¶æ¬¡å¤§éƒ¨åˆ†å‘½ä»¤çš„è¯æ¨èä½¿ç”¨ posix (macä¸Šå¾ˆå¤šå‘½ä»¤å¹¶ä¸éµå®ˆposix)\n","categories":["Linux"],"tags":["Linux","grep","awk","sed","æ­£åˆ™è¡¨è¾¾å¼"]},{"title":"Golangçš„è°ƒåº¦æ¨¡å‹","url":"/2021/05/27/ed44e381cbc098d95c5091eb11450b7e/","content":"Goæœ‰å››å¤§æ ¸å¿ƒæ¨¡å—ï¼ŒåŸºæœ¬å…¨éƒ¨ä½“ç°åœ¨runtimeï¼Œæœ‰è°ƒåº¦ç³»ç»Ÿã€GCã€goroutineã€channelï¼Œé‚£ä¹ˆæ·±å…¥ç†è§£å…¶ä¸­çš„ç²¾é«“å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£Goè¿™ä¸€é—¨è¯­è¨€ï¼\n\n\n1ã€Goè°ƒåº¦æ¨¡å‹å‘å±•å†å²\nå•çº¿ç¨‹è°ƒåº¦å™¨ (0.x ç‰ˆæœ¬)\nåªåŒ…å« 40 å¤šè¡Œä»£ç ï¼›\nç¨‹åºä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ªæ´»è·ƒçº¿ç¨‹ï¼Œç”± G-M æ¨¡å‹ç»„æˆï¼›\n\n\nå¤šçº¿ç¨‹è°ƒåº¦å™¨ Â·ï¼ˆ1.0ç‰ˆæœ¬ï¼‰\nå…è®¸è¿è¡Œå¤šçº¿ç¨‹çš„ç¨‹åºï¼›\nå…¨å±€é”å¯¼è‡´ç«äº‰ä¸¥é‡ï¼›\n\n\nä»»åŠ¡çªƒå–è°ƒåº¦å™¨ Â· ï¼ˆ1.1ç‰ˆæœ¬ï¼‰\nå¼•å…¥äº†å¤„ç†å™¨ Pï¼Œæ„æˆäº†ç›®å‰çš„ G-M-P æ¨¡å‹ï¼›\nåœ¨å¤„ç†å™¨ P çš„åŸºç¡€ä¸Šå®ç°äº†åŸºäºå·¥ä½œçªƒå–çš„è°ƒåº¦å™¨ï¼›\nåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒGoroutine ä¸ä¼šè®©å‡ºçº¿ç¨‹ï¼Œè¿›è€Œé€ æˆé¥¥é¥¿é—®é¢˜ï¼›(å•ä¸ªp+ç©ºè½¬)\næ—¶é—´è¿‡é•¿çš„åƒåœ¾å›æ”¶ï¼ˆStop-the-worldï¼ŒSTWï¼‰ä¼šå¯¼è‡´ç¨‹åºé•¿æ—¶é—´æ— æ³•å·¥ä½œï¼›\n\n\næŠ¢å å¼è°ƒåº¦å™¨ Â· ï¼ˆ1.2ç‰ˆæœ¬~ è‡³ä»Šï¼‰\nåŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦å™¨ - 1.2 ~ 1.13\né€šè¿‡ç¼–è¯‘å™¨åœ¨å‡½æ•°è°ƒç”¨æ—¶æ’å…¥æŠ¢å æ£€æŸ¥æŒ‡ä»¤ï¼Œåœ¨å‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥å½“å‰ Goroutine æ˜¯å¦å‘èµ·äº†æŠ¢å è¯·æ±‚ï¼Œå®ç°åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ï¼›\nGoroutine å¯èƒ½ä¼šå› ä¸ºåƒåœ¾å›æ”¶å’Œå¾ªç¯é•¿æ—¶é—´å ç”¨èµ„æºå¯¼è‡´ç¨‹åºæš‚åœï¼›\n\n\nåŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦å™¨ - 1.14 ~ è‡³ä»Š\nå®ç°åŸºäºä¿¡å·çš„çœŸæŠ¢å å¼è°ƒåº¦ï¼›\nåƒåœ¾å›æ”¶åœ¨æ‰«ææ ˆæ—¶ä¼šè§¦å‘æŠ¢å è°ƒåº¦ï¼›\næŠ¢å çš„æ—¶é—´ç‚¹ä¸å¤Ÿå¤šï¼Œè¿˜ä¸èƒ½è¦†ç›–å…¨éƒ¨çš„è¾¹ç¼˜æƒ…å†µï¼›\n\n\n\n\néå‡åŒ€å­˜å‚¨è®¿é—®è°ƒåº¦å™¨ Â· ææ¡ˆ\nå¯¹è¿è¡Œæ—¶çš„å„ç§èµ„æºè¿›è¡Œåˆ†åŒºï¼›\nå®ç°éå¸¸å¤æ‚ï¼Œåˆ°ä»Šå¤©è¿˜æ²¡æœ‰æä¸Šæ—¥ç¨‹ï¼›\n\n\n\nä¸Šé¢è¯´åˆ°çš„1.3ç‰ˆæœ¬ä»¥å‰å†å²ï¼Œå…¶å®éƒ½æ˜¯goçš„éå‘è¡Œç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬å…³æ³¨ä¸çš„æ˜¯goçš„å‘è¡Œç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯goçš„gpmæ¨¡å‹ï¼\n\nG: Goroutineï¼Œå³æˆ‘ä»¬åœ¨ Go ç¨‹åºä¸­ä½¿ç”¨ go å…³é”®å­—åˆ›å»ºçš„æ‰§è¡Œä½“ï¼›\nM: Machineï¼Œæˆ– worker threadï¼Œå³ä¼ ç»Ÿæ„ä¹‰ä¸Šè¿›ç¨‹çš„çº¿ç¨‹ï¼›\nP: Processorï¼Œå³ä¸€ç§äººä¸ºæŠ½è±¡çš„ã€ç”¨äºæ‰§è¡Œ Go ä»£ç è¢«è¦æ±‚å±€éƒ¨èµ„æºã€‚åªæœ‰å½“ M ä¸ä¸€ä¸ª P å…³è”åæ‰èƒ½æ‰§è¡Œ Go ä»£ç ã€‚é™¤é M å‘ç”Ÿé˜»å¡æˆ–åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶é—´è¿‡é•¿æ—¶ï¼Œæ²¡æœ‰ä¸ä¹‹å…³è”çš„ Pã€‚\n\nå‚è€ƒ: è°ƒåº¦ç³»ç»Ÿè®¾è®¡ç²¾è¦\n2ã€GMæ¨¡å‹\nâ€‹    Pçš„ä½œç”¨ä¸å…‰å…‰æ˜¯é˜Ÿåˆ—è¿™ç§æŠ½è±¡ï¼Œå¦‚æœç†è§£ä¸ºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆå®ƒçš„åœ°ä½åªæ˜¯Mçš„ä¸€ä¸ªå­é›†ï¼ŒGMæ¨¡å‹ï¼Œæˆ‘ä»¬æ ¸å¿ƒå…³æ³¨çš„æ˜¯Gå’ŒMï¼Œè¿™ä¹Ÿæ˜¯ä¸€èˆ¬çº¿ç¨‹æ± çš„æ¨¡å‹ï¼ç›®æ ‡å°±æ˜¯é«˜æ•ˆçš„è°ƒåº¦Gåœ¨Mä¸Šï¼\n\nä¸‹é¢æ˜¯æˆ‘ç”¨Goè¯­è¨€ç®€å•å†™çš„ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹è®¾è®¡æ€è·¯ï¼Œä»¥åŠå­˜åœ¨çš„é—®é¢˜ï¼\npackage mainimport (\t&quot;fmt&quot;\t&quot;go.uber.org/atomic&quot;\t&quot;os&quot;\t&quot;os/signal&quot;\t&quot;time&quot;)func main() &#123;\tsig := make(chan os.Signal, 0) // ç›‘å¬ç¨‹åºçš„ä¿¡å·\tsignal.Notify(sig, os.Interrupt, os.Kill)\tdown := make(chan struct&#123;&#125;, 0) // ç¨‹åºdownæœºä¿¡å·\tthreadNum := 2                        // è¿è¡Œçš„çº¿ç¨‹\ttaskQueue := make(chan func(), 1&lt;&lt;20) // ä»»åŠ¡é˜Ÿåˆ—å¤§å°é™åˆ¶\taddTask := func(foo func()) &#123;\t\tselect &#123;\t\tcase &lt;-down:\t\tcase taskQueue &lt;- foo:\t\t&#125;\t&#125;\tschedule := func() &#123;\t\tfor x := 0; x &lt; threadNum; x++ &#123;\t\t\tgo func() &#123;\t\t\t\tfor &#123;\t\t\t\t\tselect &#123;\t\t\t\t\tcase &lt;-down:\t\t\t\t\t\treturn\t\t\t\t\tcase foo := &lt;-taskQueue:\t\t\t\t\t\tfoo()\t\t\t\t\t&#125;\t\t\t\t&#125;\t\t\t&#125;()\t\t&#125;\t&#125;\tschedule() // å¯åŠ¨è°ƒåº¦å™¨\tcount := &amp;atomic.Int64&#123;&#125;\tfor x := 0; x &lt; 1; x++ &#123;\t\taddTask(func() &#123; // æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œå¾ªç¯çš„å¡å…¥ä»»åŠ¡\t\t\tfor &#123;\t\t\t\taddTask(func() &#123;\t\t\t\t\tcount.Add(1)\t\t\t\t&#125;)\t\t\t&#125;\t\t&#125;)\t&#125;\t// ç­‰å¾…ç¨‹åºç»“æŸ\tselect &#123;\tcase &lt;-sig:\t\tclose(down)\t\tfmt.Println(&quot;ç¨‹åºé€€å‡º, exec ctrl+c&quot;)\tcase &lt;-time.After(time.Second):\t\tclose(down)\t\tfmt.Printf(&quot;è°ƒç”¨é‡: %v\\n&quot;, count.Load())\t\treturn\t&#125;&#125;\n\n1ã€ç°è±¡1ã€æµ‹è¯•æ¡ä»¶ï¼Œè°ƒåº¦å™¨åªå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œç„¶åä¸€ä¸ªçº¿ç¨‹ä¸»è¦æ˜¯è´Ÿè´£å¾ªç¯çš„æ·»åŠ ä»»åŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹å¾ªç¯çš„å»æ‰§è¡Œä»»åŠ¡\nâœ  go-tool git:(master) âœ— bin/app                         è°ƒç”¨é‡: 5078714âœ  go-tool git:(master) âœ— bin/appè°ƒç”¨é‡: 5043506\n\n2ã€æµ‹è¯•æ¡ä»¶ï¼Œè°ƒåº¦å™¨å¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹ï¼Œç„¶åä¸¤ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œä¸€ä¸ªæ·»åŠ ä»»åŠ¡\nâœ  go-tool git:(master) âœ— bin/app                         è°ƒç”¨é‡: 4333959âœ  go-tool git:(master) âœ— bin/appè°ƒç”¨é‡: 4359804\n\n3ã€ç»§ç»­æµ‹è¯•ï¼Œå¯åŠ¨åä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ·»åŠ ä»»åŠ¡ï¼Œä¹ä¸ªæ‰§è¡Œä»»åŠ¡\nâœ  go-tool git:(master) âœ— bin/app                         è°ƒç”¨é‡: 1663691âœ  go-tool git:(master) âœ— bin/appè°ƒç”¨é‡: 1692096\n\n4ã€æˆ‘ä»¬æ·»åŠ ä¸€äº›é˜»å¡çš„ä»»åŠ¡\naddTask(func() &#123;  count.Inc()  time.Sleep(time.Second * 2)&#125;)\n\næ‰§è¡Œå¯ä»¥çœ‹åˆ°å®Œå…¨ä¸å¯ç”¨\nâœ  go-tool git:(master) âœ— bin/app                            è°ƒç”¨é‡: 9\n\n2ã€é—®é¢˜â€‹     1ã€ å¯ä»¥çœ‹åˆ°éšç€Mçš„ä¸æ–­çš„å¢åŠ ï¼Œå¯ä»¥å‘ç°æ‰§è¡Œä»»åŠ¡çš„æ•°é‡ä¹Ÿä¸æ–­çš„å‡å°‘ï¼ŒåŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åŠ ä¸€ä¸ªpprofå¯ä»¥çœ‹çœ‹ï¼Œå…¶å®å¤§é‡çš„åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ï¼    \nâ€‹      2ã€å¦‚æœæˆ‘çš„Mè¿è¡Œäº†ç±»ä¼¼äºSleepæ“ä½œçš„æ–¹æ³•å¦‚ä½•è§£å†³äº†ï¼Œæˆ‘çš„è°ƒåº¦å™¨è¿˜èƒ½æ”¯æ’‘è¿™ä¸ªé‡çº§çš„è°ƒåº¦å—ï¼Ÿ\nå…³äºpprofå¦‚ä½•ä½¿ç”¨ï¼šåœ¨ä»£ç å¤´éƒ¨åŠ ä¸€ä¸ªè¿™ä¸ªä»£ç ï¼š\nfile, err := os.OpenFile(&quot;/Users/fanhaodong/go/code/go-tool/main/prof.pporf&quot;, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, 0644)if err != nil &#123;  panic(err)&#125;if err := pprof.StartCPUProfile(file); err != nil &#123;  panic(err)&#125;defer pprof.StopCPUProfile()\n\næˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ go tool pprof main/prof.pporf\nShowing top 10 nodes out of 36      flat  flat%   sum%        cum   cum%     2.45s 63.80% 63.80%      2.45s 63.80%  runtime.usleep     0.40s 10.42% 74.22%      0.40s 10.42%  runtime.pthread_cond_wait     0.28s  7.29% 81.51%      0.28s  7.29%  runtime.(*waitq).dequeueSudoG     0.25s  6.51% 88.02%      0.25s  6.51%  runtime.pthread_cond_signal     0.17s  4.43% 92.45%      0.94s 24.48%  main.main.func2.1     0.10s  2.60% 95.05%      0.10s  2.60%  runtime.procyield     0.07s  1.82% 96.88%      0.07s  1.82%  runtime.(*waitq).dequeue     0.03s  0.78% 97.66%      0.03s  0.78%  runtime.madvise     0.02s  0.52% 98.18%      0.99s 25.78%  main.main.func3     0.02s  0.52% 98.70%      1.72s 44.79%  runtime.selectgo\n\nå¯ä»¥çœ‹åˆ°çœŸæ­£æ‰§è¡Œä»£ç çš„æ—¶é—´åªæœ‰ 0.17s  + 0.02s å…¶ä»–æ—¶é—´éƒ½è¢«é˜»å¡æ‰äº†ï¼\n3ã€GPMæ¨¡å‹1ã€GMæ¨¡å‹é—®é¢˜1ã€GMæ¨¡å‹ä¸­çš„æ‰€æœ‰Géƒ½æ˜¯æ”¾å…¥åˆ°ä¸€ä¸ªqueueï¼Œé‚£ä¹ˆå¯¼è‡´æ‰€æœ‰çš„Må–æ‰§è¡Œä»»åŠ¡æ—¶éƒ½ä¼šå»ç«äº‰é”ï¼Œæˆ‘ä»¬æ’å…¥Gä¹Ÿä¼šå»ç«äº‰é”ï¼Œæ‰€ä»¥è§£å†³è¿™ç§é—®é¢˜ä¸€èˆ¬å°±æ˜¯å‡å°‘å¯¹å•ä¸€èµ„æºçš„ç«äº‰ï¼Œé‚£å°±æ˜¯æ¡¶åŒ–ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªé˜Ÿåˆ—\n2ã€GMæ¨¡å‹ä¸­æ²¡æœ‰ä»»åŠ¡çŠ¶æ€ï¼Œåªæœ‰runnableï¼Œå‡å¦‚ä»»åŠ¡é‡åˆ°é˜»å¡ï¼Œå®Œå…¨å¯ä»¥æŠŠä»»åŠ¡æŒ‚èµ·å†å”¤é†’\n\nè¿è¡Œé˜Ÿåˆ—å»å­˜æ”¾æ‰€æœ‰çš„å¯ä»¥è¿è¡Œçš„ä»»åŠ¡ï¼Œrunnable\næ‰€æœ‰çº¿ç¨‹æ‰§è¡Œè¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œrunning \nè¿è¡Œä¸­çš„ä»»åŠ¡è¢«é˜»å¡çš„ä»»åŠ¡ï¼Œéœ€è¦æ”¾å¼ƒè¿è¡Œæƒåˆ©ï¼ŒæŒ‚èµ·åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œblocking\n\n2ã€GPMå¦‚ä½•ä¼˜åŒ–GMçš„ï¼ˆæ ¸å¿ƒï¼‰1ã€å¼•å…¥Pâ€‹      è¿™é‡Œå…¶å®ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚è¦åˆ†é…å¾ˆå¤šä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæ­¤æ—¶éšç€çº¿ç¨‹çš„å¢åŠ ï¼Œä¹Ÿä¼šé€ æˆé˜Ÿåˆ—çš„å¢åŠ ï¼Œå…¶å®ä¹Ÿä¼šé€ æˆè°ƒåº¦å™¨çš„å‹åŠ›ï¼Œå› ä¸ºå®ƒéœ€è¦éå†å…¨éƒ¨çº¿ç¨‹çš„é˜Ÿåˆ—å»åˆ†é…ä»»åŠ¡ä»¥åŠåç»­ä¼šè®²åˆ°çš„çªƒå–ä»»åŠ¡ï¼\nâ€‹      å› ä¸ºæˆ‘ä»¬çŸ¥é“CPUçš„æœ€å¤§å¹¶è¡Œåº¦å…¶å®å–å†³äºCPUçš„æ ¸æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡å¿…è¦ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½å»åˆ†é…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå› ä¸ºå°±ç®—æ˜¯ç»™ä»–ä»¬åˆ†é…äº†ï¼Œä»–ä»¬è‡ªå·±å»é‚£æ‰§è¡Œè°ƒåº¦ï¼Œå…¶å®ä¹Ÿä¼šå‡ºç°å¤§é‡é˜»å¡ï¼ŒåŸå› å°±æ˜¯CPUè°ƒåº¦ä¸è¿‡æ¥è¿™äº›çº¿ç¨‹ï¼\nâ€‹       Goé‡Œé¢æ˜¯åªåˆ†é…äº†CPUä¸ªæ•°çš„é˜Ÿåˆ—ï¼Œè¿™é‡Œå°±æ˜¯Pè¿™ä¸ªæ¦‚å¿µï¼Œä½ å¯ä»¥ç†è§£ä¸ºPå…¶å®æ˜¯çœŸæ­£çš„èµ„æºåˆ†é…å™¨ï¼ŒMå¾ˆè½»åªæ˜¯æ‰§è¡Œç¨‹åºï¼Œæ‰€æœ‰çš„èµ„æºå†…å­˜éƒ½ç»´æŠ¤åœ¨Pä¸Šï¼Måªæœ‰ç»‘å®šPæ‰èƒ½æ‰§è¡Œä»»åŠ¡ï¼ˆå¼ºåˆ¶çš„ï¼‰ï¼\n\nè¿™æ ·åšçš„å¥½å¤„ï¼š\n\nå¦‚æœçº¿ç¨‹å¾ˆè½»ï¼Œé‚£ä¹ˆé”€æ¯å’Œåˆ›å»ºä¼šå˜å¾—å¾ˆç®€å•ï¼Œä¹Ÿå°±æ˜¯åé¢ä¼šè®²åˆ°çš„å†…æ ¸é˜»å¡è°ƒç”¨åˆ›å»ºçº¿ç¨‹\nå¦‚æœå…¨éƒ¨èµ„æºåˆ†é…åœ¨å›ºå®šæ•°é‡çš„Pä¸Šï¼Œé‚£ä¹ˆå¯ä»¥å……åˆ†åˆ©ç”¨CPUå¹¶è¡Œåº¦\n\n2ã€GPMè°ƒåº¦å™¨1ã€é¦–å…ˆè°ƒåº¦ç¨‹åºå…¶å®å°±æ˜¯è°ƒåº¦ä¸åŒçŠ¶æ€çš„ä»»åŠ¡ï¼Œgoé‡Œé¢ä¸ºGoæ ‡è®°äº†ä¸åŒçš„çŠ¶æ€ï¼Œå…¶å®å¤§æ¦‚å°±æ˜¯åˆ†ä¸ºï¼šrunnableï¼Œrunningï¼Œblockç­‰ï¼Œæ‰€ä»¥å¦‚ä½•å……åˆ†è°ƒåº¦ä¸åŒçŠ¶æ€çš„Gæˆäº†é—®é¢˜ï¼Œé‚£ä¹ˆå…³äºé˜»å¡çš„Gå¦‚ä½•è§£å†³ï¼Œå…¶å®å¯ä»¥å¾ˆå¥½çš„è§£å†³Gè°ƒåº¦çš„é—®é¢˜ï¼\n\nåœ¨channelä¸Šå‘é€å’Œæ¥æ”¶\nç½‘ç»œI/Oæ“ä½œ\né˜»å¡çš„ç³»ç»Ÿè°ƒç”¨\nä½¿ç”¨å®šæ—¶å™¨æˆ–è€…Sleep\nä½¿ç”¨äº’æ–¥é” sync.Mutex\n\nä¸Šé¢è¿™äº›æƒ…å†µå…¶å®å°±åˆ†ä¸ºï¼š\n\nç”¨æˆ·æ€é˜»å¡\nå†…æ ¸æ€é˜»å¡ä½†æ˜¯ä¸ä¼šæŒ‚èµ·å½“å‰çº¿ç¨‹\nå†…æ ¸æ€é˜»å¡ä¼šæŒ‚èµ·å½“å‰çº¿ç¨‹\n\n2ã€ç”¨æˆ·æ€é˜»å¡ï¼Œä¸€èˆ¬Goé‡Œé¢ä¾é gopark å‡½æ•°å»å®ç°ï¼Œå¤§ä½“çš„ä»£ç é€»è¾‘åŸºæœ¬ä¸Šå’Œgoçš„è°ƒåº¦ç»‘å®šæ­»äº†\næºç åœ¨ï¼šhttps://golang.org/src/runtime/proc.go\nfunc gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) &#123;\tif reason != waitReasonSleep &#123;\t\tcheckTimeouts() // timeouts may expire while two goroutines keep the scheduler busy\t&#125;\tmp := acquirem()\tgp := mp.curg\tstatus := readgstatus(gp)\tif status != _Grunning &amp;&amp; status != _Gscanrunning &#123;\t\tthrow(&quot;gopark: bad g status&quot;)\t&#125;\tmp.waitlock = lock\tmp.waitunlockf = unlockf\tgp.waitreason = reason\tmp.waittraceev = traceEv\tmp.waittraceskip = traceskip\treleasem(mp)\t// can&#x27;t do anything that might move the G between Ms here.\tmcall(park_m)&#125;// park continuation on g0.func park_m(gp *g) &#123;\t_g_ := getg()\tif trace.enabled &#123;\t\ttraceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip)\t&#125;\tcasgstatus(gp, _Grunning, _Gwaiting)\tdropg()\tif fn := _g_.m.waitunlockf; fn != nil &#123;\t\tok := fn(gp, _g_.m.waitlock)\t\t_g_.m.waitunlockf = nil\t\t_g_.m.waitlock = nil\t\tif !ok &#123;\t\t\tif trace.enabled &#123;\t\t\t\ttraceGoUnpark(gp, 2)\t\t\t&#125;\t\t\tcasgstatus(gp, _Gwaiting, _Grunnable)\t\t\texecute(gp, true) // Schedule it back, never returns.\t\t&#125;\t&#125;\tschedule() // è°ƒåº¦ç¨‹åº&#125;\n\n\nä»–ä¼šæ ‡è®°å½“å‰çš„gçš„çŠ¶æ€ä» running -&gt; waiting çŠ¶æ€\nç„¶åå¼€å§‹æ‰§è¡Œè°ƒåº¦:  schedule()  æ–¹æ³•\né¦–å…ˆå°±æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–ç‰¹æ®Šæƒ…å†µï¼šæ¯”å¦‚GCæˆ–è€…trace\nå…¶æ¬¡å°±æ˜¯å¯èƒ½å…ˆå»è·å–å…¨å±€é˜Ÿåˆ—çš„(ä»£ç é‡Œå†™çš„å¶å°”ï¼Œæ ¹æ®éšæœºæ€§å»æ‰§è¡Œçš„)\nè·å–å½“å‰gç»‘å®šçš„pé˜Ÿåˆ—é‡Œè·å–g\nä»å…¶ä»–åœ°æ–¹è·å–å¯ä»¥è¿è¡Œçš„g (ä¼˜å…ˆçº§æ˜¯ï¼šä»æœ¬åœ°é˜Ÿåˆ—-&gt;å…¨å±€é˜Ÿåˆ—-&gt;ç½‘ç»œè½®å·¡å™¨-&gt;çªƒå–å…¶ä»–Pçš„Gï¼Œå…·ä½“å¯ä»¥çœ‹ findrunnable æ–¹æ³•)\næœ€åæ‰§è¡Œé‚£ä¸ªå”¤é†’çš„G\n\n\næœ€åå°±æ˜¯unparkï¼Œå°±æ˜¯å°†å½“å‰goroutineç½®äºç­‰å¾…çŠ¶æ€å¹¶è§£é”é”ã€‚ å¯ä»¥é€šè¿‡è°ƒç”¨goreadyæ–¹æ³•ä½¿goroutineå†æ¬¡è¿è¡Œã€‚\n\n3ã€å…¶å®å¯¹äºnetpool è¿™ç§nioæ¨¡å‹ï¼Œå…¶å®å†…æ ¸è°ƒç”¨æ˜¯éé˜»å¡çš„ï¼Œæ‰€ä»¥goå¼€è¾Ÿäº†ä¸€ä¸ªç½‘ç»œè½®è®­å™¨é˜Ÿåˆ—ï¼Œæ¥å­˜æ”¾è¿™äº›è¢«é˜»å¡çš„gï¼Œç­‰å¾…å†…æ ¸è¢«å”¤é†’ï¼é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šè¢«å”¤é†’äº†ï¼Œå…¶å®å°±æ˜¯éœ€è¦ç­‰å¾…è°ƒåº¦å™¨å»è°ƒåº¦äº†ï¼\nn, err := syscall.Read(fd.Sysfd, p)if err != nil &#123;  n = 0  if err == syscall.EAGAIN &amp;&amp; fd.pd.pollable() &#123;    if err = fd.pd.waitRead(fd.isFile); err == nil &#123; // è¿™é‡Œä¼šç­‰å¾…è¯»ï¼Œå…¶å®å°±æ˜¯æŒ‚èµ·äº†å½“å‰gï¼Œä¹Ÿå°±æ˜¯ä¸»åŠ¨è®©å‡ºäº†m      continue    &#125;  &#125;  // ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&#125;\n\n4ã€å¦‚æœæ˜¯å†…æ ¸æ€é˜»å¡äº†ï¼ˆå†…æ ¸æ€é˜»å¡ä¸€èˆ¬éƒ½ä¼šå°†çº¿ç¨‹æŒ‚èµ·ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…è¢«å”¤é†’ï¼‰ï¼Œæˆ‘ä»¬æ­¤æ—¶Påªèƒ½æ”¾å¼ƒæ­¤çº¿ç¨‹çš„æƒåˆ©ï¼Œç„¶åå†æ‰¾ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»è¿è¡ŒPï¼\nå…³äºç€æ–°çº¿ç¨‹ï¼šæ‰¾æœ‰æ²¡æœ‰idleçš„çº¿ç¨‹ï¼Œæ²¡æœ‰å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼\nå…³äºå½“å†…æ ¸è¢«å”¤é†’åçš„æ“ä½œï¼šå› ä¸ºGPMæ¨¡å‹æ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸ªPç»‘å®šï¼Œæ‰€ä»¥Gä¼šå»å°è¯•æ‰¾ä¸€ä¸ªå¯ç”¨çš„Pï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„Pï¼ŒGä¼šæ ‡è®°ä¸ºrunnableæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼\n\nâ€‹    å…³äºå†…æ ¸å”¤é†’åGå¦‚ä½•æ‰§è¡Œçš„ä»£ç æˆ‘æ²¡æœ‰æ‰¾åˆ°ï¼Œä¸å¥½æ„æ€ï¼Œé€»è¾‘æ²¡æœ‰çœ‹å¤ªæ¸…æ™°ï¼å…¶å®ç–‘é—®ç‚¹ï¼šå¦‚ä½•æ‰¾åˆ°å¯ç”¨çš„Pï¼Œæ‰€ä»¥å›ºå®šæ•°é‡çš„Pçš„å¥½å¤„å°±æ˜¯æŸ¥è¯¢æ—¶é—´æ¯”è¾ƒå¯æ§ï¼ä¸ºä½•ä¸æ‰¾åˆ°ä¸Šä¸€æ¬¡ç»‘å®šçš„På‘¢ï¼Ÿä¸ºä½•åˆ‡æ¢ä¸Šä¸‹æ–‡äº†ï¼\n\n5ã€å…¶å®äº†è§£ä¸Šé¢å¤§è‡´å…¶å®å°±äº†è§£äº†Goçš„åŸºæœ¬è°ƒåº¦æ¨¡å‹\n\nGè¿è¡Œçš„ä¼˜å…ˆçº§æ˜¯å•¥\nPå’ŒMå•¥æ—¶å€™ä¼šæ¥è§¦ç»‘å®š\nPå•¥æ—¶å€™ä¼šçªƒå–G\n\nç­”æ¡ˆæ–‡ç« é‡Œæ…¢æ…¢å“å‘³ï¼\n3ã€å¦‚ä½•é˜²æ­¢Gé•¿æ—¶é—´å ç”¨På¦‚æœæŸä¸ª G æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå…¶ä»–çš„ G å¦‚ä½•æ‰èƒ½è¢«æ­£å¸¸çš„è°ƒåº¦ï¼Ÿ è¿™ä¾¿æ¶‰åŠåˆ°æœ‰å…³è°ƒåº¦çš„ä¸¤ä¸ªç†å¿µï¼šåä½œå¼è°ƒåº¦ä¸æŠ¢å å¼è°ƒåº¦ã€‚åä½œå¼å’ŒæŠ¢å å¼è¿™ä¸¤ä¸ªç†å¿µè§£é‡Šèµ·æ¥å¾ˆç®€å•ï¼š åä½œå¼è°ƒåº¦ä¾é è¢«è°ƒåº¦æ–¹ä¸»åŠ¨å¼ƒæƒï¼›æŠ¢å å¼è°ƒåº¦åˆ™ä¾é è°ƒåº¦å™¨å¼ºåˆ¶å°†è¢«è°ƒåº¦æ–¹è¢«åŠ¨ä¸­æ–­ã€‚\n1ã€ç©ºè½¬ä»£ç ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘æœ¬åœ°çš„ç‰ˆæœ¬æ˜¯go1.13.5\npackage mainimport (\t&quot;fmt&quot;\t&quot;runtime&quot;)func main() &#123;\tgo func() &#123;\t\tfor &#123;\t\t\t&#123;\t\t\t&#125;\t\t&#125;\t&#125;()\truntime.Gosched() // è¡¨ç¤ºä¸»çº¿ç¨‹è®©å‡ºå½“å‰çº¿ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºå…ˆè®©goæ‰§è¡Œ\tfmt.Println(&quot;close&quot;)&#125;\n\n2ã€å­˜åœ¨çš„é—®é¢˜æ‰§è¡Œ: GOMAXPROCS=1 é…ç½®å…¨å±€åªèƒ½æœ‰ä¸€ä¸ªP\nâœ  go-tool git:(master) âœ— GODEBUG=schedtrace=1 GOMAXPROCS=1 bin/appSCHED 0ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=0 [2]SCHED 1ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 2ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 4ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 7ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 13ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]\n\nå¯ä»¥çœ‹åˆ°mainå‡½æ•°æ— æ³•æ‰§è¡Œ!ä¹Ÿå°±æ˜¯é‚£ä¸ªgo ç©ºè½¬æŠ¢å äº†æ•´ä¸ªç¨‹åº\nå¤‡æ³¨ï¼š\n\nGODEBUG=schedtrace=1  è¡¨ç¤º1msæ‰“å°ä¸€æ¬¡\n\nSCHEDï¼šè°ƒè¯•ä¿¡æ¯è¾“å‡ºæ ‡å¿—å­—ç¬¦ä¸²ï¼Œä»£è¡¨æœ¬è¡Œæ˜¯goroutine schedulerçš„è¾“å‡ºï¼›1msï¼šå³ä»ç¨‹åºå¯åŠ¨åˆ°è¾“å‡ºè¿™è¡Œæ—¥å¿—çš„æ—¶é—´ï¼›gomaxprocs: Pçš„æ•°é‡ï¼›idleprocs: å¤„äºidleçŠ¶æ€çš„Pçš„æ•°é‡ï¼›é€šè¿‡gomaxprocså’Œidleprocsçš„å·®å€¼ï¼Œæˆ‘ä»¬å°±å¯çŸ¥é“æ‰§è¡Œgoä»£ç çš„Pçš„æ•°é‡ï¼›threads: os threadsçš„æ•°é‡ï¼ŒåŒ…å«schedulerä½¿ç”¨çš„mæ•°é‡ï¼ŒåŠ ä¸Šruntimeè‡ªç”¨çš„ç±»ä¼¼sysmonè¿™æ ·çš„threadçš„æ•°é‡ï¼›spinningthreads: å¤„äºè‡ªæ—‹çŠ¶æ€çš„os threadæ•°é‡ï¼›idlethread: å¤„äºidleçŠ¶æ€çš„os threadçš„æ•°é‡ï¼›runqueue=1ï¼š go schedulerå…¨å±€é˜Ÿåˆ—ä¸­Gçš„æ•°é‡ï¼›[3 4 0 10]: åˆ†åˆ«ä¸º4ä¸ªPçš„local queueä¸­çš„Gçš„æ•°é‡ã€‚\n\n3ã€å‡çº§1.14+ç‰ˆæœ¬è§£å†³ä½†æ˜¯å‡å¦‚æˆ‘æ¢ä¸ºç”¨ 1.14+ç‰ˆæœ¬æ‰§è¡Œï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥ä½¿ç”¨æˆ‘çš„dockeré•œåƒï¼Œç›´æ¥å¯ä»¥æ‹‰å–ï¼š fanhaodong/golang:1.15.11 å’Œ  fanhaodong/golang:1.13.5\n[root@647af84b3319 code]# GODEBUG=schedtrace=1 GOMAXPROCS=1 bin/appSCHED 0ms: gomaxprocs=1 idleprocs=0 threads=2 spinningthreads=0 idlethreads=0 runqueue=0 [0]SCHED 1ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=0 [0]SCHED 2ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=0 [0]SCHED 3ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 4ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 5ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 6ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 7ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 8ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 10ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]SCHED 13ms: gomaxprocs=1 idleprocs=0 threads=3 spinningthreads=0 idlethreads=1 runqueue=1 [1]close\n\n4ã€å…³äºGä¸Šå†…å­˜åˆ†é…çš„é—®é¢˜é¦–å…ˆæˆ‘ä»¬çŸ¥é“G/M/Pï¼ŒGå¯èƒ½å’ŒMä¹Ÿå¯èƒ½å’ŒPè§£é™¤ç»‘å®šï¼Œé‚£ä¹ˆå…³äºæ•°æ®å˜é‡æ”¾åœ¨å“ªå“‡ï¼å…¶å®è¿™ä¸ªå°±æ˜¯é€ƒé€¸åˆ†æï¼\n1ã€ä»€ä¹ˆæƒ…å†µä¸‹ä¼šé€ƒé€¸package maintype Demo struct &#123;\tMain string&#125;func main() &#123;\tgo func() &#123;\t\tdemo := Demo&#123;&#125;\t\tgo func() &#123;\t\t\ttest(demo)\t\t&#125;()\t&#125;()&#125;func test(demo Demo) &#123;&#125;\n\nè¾“å‡ºå¯ä»¥çœ‹åˆ°å…¶å®æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œé‚£æ˜¯å› ä¸º demoè¢«æ‹·è´å®ƒè‡ªå·±çš„æ ˆç©ºé—´å†…\n[root@647af84b3319 code]#  go build -gcflags &quot;-N -l -m&quot; -o bin/app deno/main2.go# command-line-argumentsdeno/main2.go:13:11: demo does not escapedeno/main2.go:6:5: func literal escapes to heapdeno/main2.go:8:6: func literal escapes to heap\n\nå¤‡æ³¨ï¼š\n -gcflags &quot;-N -l -m&quot; å…¶ä¸­ -N ç¦ç”¨ä¼˜åŒ– -lç¦æ­¢å†…è”ä¼˜åŒ–ï¼Œ-mæ‰“å°é€ƒé€¸ä¿¡æ¯\né‚£ä¹ˆç»§ç»­æ”¹æˆè¿™ä¸ª\npackage maintype Demo struct &#123;\tMain string&#125;func main() &#123;\tgo func() &#123;\t\tdemo := Demo&#123;&#125;\t\tgo func() &#123;\t\t\ttest(&amp;demo)\t\t&#125;()\t&#125;()&#125;func test(demo *Demo) &#123;&#125;\n\nå¯ä»¥çœ‹åˆ°å‘ç° demoå¯¹è±¡å…¶å®è¢«é€ƒé€¸åˆ°äº†å †ä¸Šï¼è¿™å°±æ˜¯ä¸ä¼šå‡ºç°ç±»ä¼¼äºGå¦‚æœè¢«åˆ«çš„Mæ‰§è¡Œï¼Œå…¶å®ä¸ä¼šå‡ºç°å†…å­˜åˆ†é…ä½ç½®çš„é—®é¢˜ï¼\n[root@647af84b3319 code]#  go build -gcflags &quot;-N -l -m&quot; -o bin/app deno/main2.go# command-line-argumentsdeno/main2.go:13:11: demo does not escapedeno/main2.go:7:3: moved to heap: demodeno/main2.go:6:5: func literal escapes to heapdeno/main2.go:8:6: func literal escapes to heap\n\n2ã€forå¾ªç¯ä¸­ç”³æ˜gå†…å­˜å¼•ç”¨é—®é¢˜æ‰€ä»¥å¯ä»¥çœ‹åˆ°demoå…¶å®æ˜¯copyåˆ°äº†å †ä¸Šï¼è¿™å°±æ˜¯gé€ƒé€¸çš„é—®é¢˜ï¼Œå’Œforå¾ªç¯ä¸€æ ·çš„\nfunc main() &#123;\tfor x := 0; x &lt; 10; x++ &#123;\t\tgo func() &#123;\t\t\tfmt.Println(x)\t\t&#125;()\t&#125;&#125;\n\næ‰§è¡Œå¯ä»¥å‘ç°ï¼Œå…¶å®xå·²ç»é€ƒé€¸åˆ°äº†å †ä¸Šï¼Œæ‰€ä»¥ä½ æ‰€æœ‰çš„géƒ½å¼•ç”¨çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚ä½•è§£å†³äº†\nâœ  go-tool git:(master) âœ— go build -gcflags &quot;-l -m&quot; -o bin/app deno/main2.go# command-line-argumentsdeno/main2.go:10:6: moved to heap: xdeno/main2.go:11:6: func literal escapes to heapdeno/main2.go:12:15: main.func1 ... argument does not escapedeno/main2.go:12:15: x escapes to heapdeno/main2.go:16:11: test demo does not escape\n\nå¦‚ä½•è§£å†³äº†ï¼Œå…¶å®å¾ˆç®€å•\n\nç›´æ¥copyä¸€ä»½æ•°æ®\n\nfor x := 0; x &lt; 10; x++ &#123;  x := x // clone  go func() &#123;    fmt.Println(x)  &#125;()&#125;\n\n\né€šè¿‡å‚æ•°ä¼ é€’(æ¨è)\n\nfor x := 0; x &lt; 10; x++ &#123;go func(x int) &#123;  fmt.Println(x)&#125;(x)&#125;\n\nå‚è€ƒæ–‡ç« ä¹Ÿè°ˆgoroutineè°ƒåº¦å™¨\nå›¾è§£Goè¿è¡Œæ—¶è°ƒåº¦å™¨\nGoè¯­è¨€å›é¡¾ï¼šä»Go 1.0åˆ°Go 1.13\nGoè¯­è¨€åŸæœ¬\nè°ƒåº¦ç³»ç»Ÿè®¾è®¡ç²¾è¦\nScalable Go Scheduler Design Doc\n","categories":["Golang"],"tags":["Golang","è°ƒåº¦å™¨"]},{"title":"git æ—¥å¸¸ç”¨æ³•","url":"/2020/03/08/e29180bc3d76b959abec41c7fc18c142/","content":"â€‹    æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨gitä½œä¸ºç‰ˆæœ¬æ§åˆ¶ï¼Œå¸¸ç”¨çš„è¯å°±æ˜¯gitå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ sourcetree å·¥å…·ï¼Œå¯¹äºå¸¸ç”¨å‘½ä»¤æ¥è¯´ï¼Œå…¶å®gitå‘½ä»¤åŸºæœ¬å¤Ÿç”¨äº†ï¼Œä½†æ˜¯å½“ä½ å¤§é‡é˜…è¯»ä»£ç çš„æ—¶å€™ï¼Œä¾æ‰˜äºideï¼Œé€Ÿåº¦å¤ªæ…¢äº†ï¼\n\n\n1ã€å¸¸ç”¨å‘½ä»¤git pull &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;è¿œç¨‹åˆ†æ”¯å&gt;:&lt;æœ¬åœ°åˆ†æ”¯å&gt;\ngit push &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;æœ¬åœ°åˆ†æ”¯å&gt;:&lt;è¿œç¨‹åˆ†æ”¯å&gt; ,  å’Œgit pull éƒ½æ˜¯ src:dest\n git fetch &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;åˆ†æ”¯å&gt;  å…¶å®å°±æ˜¯æ‹‰å»è¿œç¨‹åˆ†æ”¯åˆ°æœ¬åœ°ç‰ˆæœ¬åº“ï¼Œç„¶åå†ä½¿ç”¨ git merge\ngit merge &lt;branch&gt;  åˆå¹¶åˆ†æ”¯ï¼Œå°†&lt;branch&gt; åˆå¹¶åˆ°å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ï¼Œ æ¯”å¦‚git merge master ï¼Œå°†æœ¬åœ°masterä¸è‡ªå·±çš„åˆ†æ”¯åˆå¹¶ï¼Œæ¯”å¦‚git merge origin/branch ï¼Œå°±æ˜¯å°†è¿œç¨‹çš„origin/branchä¸æœ¬åœ°çš„åˆ†æ”¯åˆå¹¶ , æ¯”å¦‚ä¸è‡ªåŠ¨commitï¼Œå¯ä»¥git merge --no-commit &lt;branch&gt; ã€‚ å…¶å®git merge å¯ä»¥ä¸€æ¬¡åˆå¹¶å¤šä¸ªåˆ†æ”¯ï¼Œæ¯”å¦‚ git merge &lt;branch&gt; origin/&lt;branch&gt; å…¶å®å°±æ˜¯ç®¡ä½ è¿œç¨‹å’Œæœ¬åœ°äº†å…¨éƒ¨åˆåˆ°æˆ‘çš„åˆ†æ”¯ä¸Šã€‚\ngit diff &lt;branch1&gt; &lt;branch2&gt;  åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´æ¯”è¾ƒ\ngit diff --cached    æ¯”è¾ƒ git add . ä¸ å·¥ä½œåŒºä¹‹é—´çš„æ¯”è¾ƒï¼Œ ä¹Ÿå°±æ˜¯æœ¬åœ°æš‚å­˜åŒºä¸å·¥ä½œåŒºä¹‹é—´çš„æ¯”è¾ƒ\n\ngit diff\t            å·¥ä½œåŒº vs æš‚å­˜åŒºgit diff head\t        å·¥ä½œåŒº vs ç‰ˆæœ¬åº“git diff â€“cached        æš‚å­˜åŒº vs ç‰ˆæœ¬åº“\n\ngit reset --mixed  å°†æš‚å­˜åŒºçš„åˆ†æ”¯ç›´æ¥å›åˆ°åˆ°å·¥ä½œåŒºï¼Œ ä¹Ÿå°±æ˜¯æ¯”å¦‚git add .  ä½ æƒ³å›é€€åˆ°æœ¬åœ°ï¼Œç›´æ¥ `git resrt â€“mixed\ngit reset --mixed HEAD~1 å›é€€ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ¯”å¦‚ä½ æœ¬åœ°commit/è¿œç¨‹å·²ç»pushäº†ï¼Œé‚£ä¹ˆä½ æœ¬åœ°å’Œè¿œç¨‹æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœä½ æƒ³å›é€€ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ­¤æ—¶éœ€è¦resetæ“ä½œï¼Œä¸»è¦æ˜¯è§£å†³å›é€€çš„æ“ä½œï¼Œä¸Šé¢å°±æ˜¯commitä¸€æ¬¡åéœ€è¦å›é€€ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥æ˜¯HEADï½1, æ¯”å¦‚commitäº†ä¸¤æ¬¡å°±æ˜¯HEAD~2 ï¼Œ æ­¤æ—¶æœ‰4ç§é€‰é¡¹ï¼Œä¸€èˆ¬åˆ†ä¸º--hard å’Œ --mixed  ï¼Œ--soft  , --hard ç¡¬resetï¼Œå›é€€å›æ¥ä½ çš„è¿™æ¬¡ä¿®æ”¹å…¨éƒ¨æ²¡æœ‰äº†ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å›åˆ°äº†ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œ--mixed å›é€€åˆ°ä½ æ²¡æœ‰git add . æ“ä½œçš„æ—¶å€™ï¼Œ--soft æ˜¯å›é€€åˆ°ä½ git add . æ“ä½œå®Œåçš„æ—¶å€™ã€‚ çœ‹éœ€æ±‚å§ã€‚ä¸€èˆ¬åªç”¨--hard å’Œ --mixed .\ngit commit --amend  ä¸»è¦æ˜¯å¤„ç† ä½  git commit -m &#39;&#39; æƒ³è¦ä¿®æ”¹ commitçš„desc/commentäº†ã€‚\ngit rm -r --cached .  æ¯”å¦‚ä¿®æ”¹äº† gitignore ,ä½†æ˜¯å…¶å®ä½ çš„ç‰ˆæœ¬åº“/æš‚å­˜åŒºæ˜¯æ²¡æœ‰ ignoreçš„ï¼Œæ‰€ä»¥éœ€è¦ç›´æ¥åˆ é™¤ æš‚å­˜åŒºçš„ç¼“å­˜ã€‚\ngit rm file ä¹Ÿå°±æ˜¯åˆ é™¤æœ¬åœ°å¼€å‘çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œç¡¬åˆ é™¤ï¼Œç›´æ¥åˆ æ²¡äº†ï¼Œå›é€€ä¹Ÿéœ€è¦ç¡¬å›é€€ã€‚\ngit checkout .  æ¸…ç©ºæœ¬åœ°æ‰€æœ‰ä¿®æ”¹çš„ä»£ç \ngit checkout -b &lt;branch&gt; å°†æœ¬åœ°çš„è¿™ä¸ªåˆ†æ”¯ï¼Œcheckout å‡ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œåå­—ä¸º&lt;branch&gt;git checkout -b &lt;branch&gt;  origin/&lt;branch&gt; ï¼Œå°†è¿œç¨‹çš„&lt;branch&gt; åˆ†æ”¯ä¸Š checkoutä¸€ä¸ªæ–°çš„æœ¬åœ°åˆ†æ”¯åå­—ä¸º`\næœ‰äº›åœºæ™¯å¯èƒ½éœ€è¦æ‰“tagï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯ git pull ,æ‹‰å»è¿œç¨‹çš„æ‰€æœ‰ä»£ç (è®°å¾—åˆ‡æ¢åˆ°masterä¸Š)ï¼Œç„¶å git tag æŸ¥çœ‹tag å†å²ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„tag ï¼Œæ¯”å¦‚git tag v1.1.0ï¼Œç„¶åç›´æ¥æ¨é€åˆ°è¿œç¨‹git push origin v1.1.0 å°±å¥½äº†ï¼ˆä¸€èˆ¬æ˜¯åˆ«äººç»™ä½ åˆmasteräº†ï¼Œä¸Šçº¿å¯èƒ½éœ€è¦æ‰“æ–°çš„tagï¼‰\næ–‡ä»¶æƒé™å‘ç”Ÿå˜æ›´éœ€è¦é…ç½®ï¼šgit diff old mode 100644 new mode 100755 çš„é—®é¢˜ ï¼šéœ€è¦è®¾ç½® git config â€“add core.filemode false\n git log -p README.md æŸ¥çœ‹æ–‡ä»¶çš„å˜æ›´è¯¦ç»†å†å²ï¼Œ git log &lt;file&gt; æŸ¥çœ‹æ–‡ä»¶çš„å˜æ›´å†å²ï¼Œå¦å¤–æœ‰å¯èƒ½æŸ¥çœ‹æŸä¸€è¡Œçš„å˜æ›´ï¼Œè¿™ä¸ªæ˜¯æŒ‡ä½ æ²¡æœ‰ideçš„æƒ…å†µä¸‹ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®š\nâœ  ebike-**** git:(master) âœ— cat -n  cmd/main.go 1  package main 2   3  import ( ## ........18  )19  20  func main() &#123;# ......24          // å¯åŠ¨RocketMQ25          rq.RocketmqInit()## ......53          r.Run(fmt.Sprintf(&quot;:%s&quot;, host))54  &#125;55  ## .............83  &#125;\n\nç„¶å\nâœ  ebike-op-helios git:(master) âœ— git log -L 25:cmd/main.go\n\n\ngit shortlog -sn æŸ¥çœ‹æäº¤è€…\ngit submodel add remote_addr local_dir å­æ¨¡å—\n# å°†è¿œç¨‹é¡¹ç›®https://github.com/maonx/vimwiki-assets.gitå…‹éš†åˆ°æœ¬åœ°assetsæ–‡ä»¶å¤¹ã€‚git submodule add https://github.com/maonx/vimwiki-assets.git assets\t\n\n2ã€å­æ¨¡å—\nâ€‹    æœ‰ç§æƒ…å†µæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ï¼šæŸä¸ªå·¥ä½œä¸­çš„é¡¹ç›®éœ€è¦åŒ…å«å¹¶ä½¿ç”¨å¦ä¸€ä¸ªé¡¹ç›®ã€‚ ä¹Ÿè®¸æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ–è€…ä½ ç‹¬ç«‹å¼€å‘çš„ï¼Œç”¨äºå¤šä¸ªçˆ¶é¡¹ç›®çš„åº“ã€‚ ç°åœ¨é—®é¢˜æ¥äº†ï¼šä½ æƒ³è¦æŠŠå®ƒä»¬å½“åšä¸¤ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼ŒåŒæ—¶åˆæƒ³åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å¦ä¸€ä¸ªã€‚\n\næ–‡æ¡£ï¼šGit-å·¥å…·-å­æ¨¡å—\n1ã€åœ¨çˆ¶é¡¹ç›®æ–°å»ºå­æ¨¡å—\ngit submodule add https://github.com/chaconinc/DbConnector  ./submodule/DbConnector\n\n2ã€æäº¤å­æ¨¡å—\n\nå¦‚æœåœ¨çˆ¶é¡¹ç›®(çˆ¶é¡¹ç›®æ— ä»»ä½•å˜æ›´)ä¸­æäº¤å­æ¨¡å—ï¼Œä¼šå‡ºç°ï¼š\n\nâœ  test-dir git:(master) gitpush masterOn branch masterYour branch is up to date with &#x27;origin/master&#x27;.Changes not staged for commit:\tmodified:   submodule-01 (modified content)no changes added to commitEverything up-to-date\n\n\nçˆ¶é¡¹ç›®æ›´æ›´æäº¤ ï¼ˆå¯ä»¥æäº¤å˜æ›´ï¼Œä½†æ˜¯å­é¡¹ç›®å¹¶æ²¡æœ‰æäº¤ï¼‰\n\nâœ  test-dir git:(master) âœ— gitpush master[master f00fa83] fanhaodong æäº¤ä¸2021-03-08 15:54:09 1 file changed, 1 insertion(+)## ......To gitee.com:Anthony-Dong/parent-report.git   53487e2..f00fa83  master -&gt; master\n\n\næäº¤å­é¡¹ç›®(éœ€è¦åˆ‡æ¢åˆ°å­é¡¹ç›®ç›®å½•ï¼Œç„¶ååˆ‡æ¢åˆ°çˆ¶é¡¹ç›®æäº¤)\n\nâœ  submodule-01 git:(master) âœ— gitpush master[master 969f9ea] fanhaodong æäº¤ä¸2021-03-08 15:52:08## ....To gitee.com:Anthony-Dong/submodule-01.git   6ac8e7d..969f9ea  master -&gt; master   âœ  test-dir git:(master) âœ— gitpush master[master 53487e2] fanhaodong æäº¤ä¸2021-03-08 15:52:12 1 file changed, 1 insertion(+), 1 deletion(-)## ....To gitee.com:Anthony-Dong/parent-report.git   14e259d..53487e2  master -&gt; maste   \n\né—®é¢˜å°±æ˜¯ï¼Œæäº¤æµç¨‹è¿‡äºå¤æ‚ï¼ï¼\nå‚è€ƒ\nProGit, æœ€å¥½çš„GitæŒ‡å—\nAdvanced Git\nGit and GitHub Secrets\nGITå­æ¨¡å—\n\n","categories":["Linux"],"tags":["git"]},{"title":"singleflightå’ŒbackoffåŒ…ä»‹ç»å’Œç»„åˆä½¿ç”¨","url":"/2022/02/28/efabb79e15af38ef629520bf36df0adf/","content":"â€‹    ä¸šåŠ¡ä¸­æˆ‘ä»¬ç»å¸¸é‡åˆ°ä¸€äº›é‡å¤ä½¿ç”¨çš„è½®å­ä»£ç ï¼Œæœ¬ç¯‡ä»‹ç»äº† singleflight å’Œ backoff ä»¥åŠæœ¬åœ°ç¼“å­˜ï¼æ¥æé«˜æˆ‘ä»¬å¹³æ—¶ä¸šåŠ¡å¼€å‘çš„æ•ˆç‡å’Œä»£ç çš„ç²¾ç®€åº¦ï¼\n\n\nsingleflightä»‹ç»\næºç ä½ç½®: https://github.com/golang/groupcache/tree/master/singleflight æˆ–è€… golang.org/x/sync/singleflight\n\nä¸»è¦æ˜¯google å¼€æºçš„group cache å°è£…çš„sdkï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³ cache å›æºçš„æ—¶å€™ï¼Œå®¹æ˜“å‡ºç°å¹¶å‘åŠ è½½ä¸€ä¸ªæˆ–è€…å¤šä¸ªkeyï¼Œå¯¼è‡´ç¼“å­˜å‡»ç©¿\n\nå…¶ä¸­ golang.org/x/sync/singleflight å®ƒæä¾›äº†æ›´å¤šæ–¹æ³•ï¼Œæ¯”å¦‚å¼‚æ­¥åŠ è½½ç­‰ï¼ä½†æ˜¯ä»£ç é‡å¢åŠ äº†å¾ˆå¤šï¼Œæ¯”å¦‚å¾ˆå¤šå¼‚æ­¥çš„bugä¹‹ç±»çš„ï¼\n\n\nç®€å•ä½¿ç”¨\nç®€å•æ¨¡æ‹Ÿ100ä¸ªå¹¶å‘è¯·æ±‚å»åŠ è½½k1\n\npackage mainimport (\t&quot;fmt&quot;\t&quot;sync&quot;\t&quot;github.com/golang/groupcache/singleflight&quot;)var (\tcache sync.Map\tsf    = singleflight.Group&#123;&#125;)func main() &#123;\tkey := &quot;k1&quot; // å‡å¦‚ç°åœ¨æœ‰100ä¸ªå¹¶å‘è¯·æ±‚è®¿é—® k1\twg := sync.WaitGroup&#123;&#125;\twg.Add(100)\tfor x := 0; x &lt; 100; x++ &#123;\t\tgo func() &#123;\t\t\tdefer wg.Done()\t\t\tloadKey(key)\t\t&#125;()\t&#125;\twg.Wait()\tfmt.Printf(&quot;result key: %s\\n&quot;, loadKey(key))&#125;func loadKey(key string) (v string) &#123;\tif data, ok := cache.Load(key); ok &#123;\t\treturn data.(string)\t&#125;\tdata, err := sf.Do(key, func() (interface&#123;&#125;, error) &#123;\t\tdata := &quot;data&quot; + &quot;|&quot; + key\t\tfmt.Printf(&quot;load and set success, data: %s\\n&quot;, data)\t\tcache.Store(key, data)\t\treturn data, nil\t&#125;)\tif err != nil &#123;\t\t// todo handler\t\tpanic(err)\t&#125;\treturn data.(string)&#125;// output//load and set success, data: data|k1//load and set success, data: data|k1//result key: data|k1\n\nå¯ä»¥çœ‹åˆ°è¾“å‡ºä¸­ï¼Œå…¶ä¸­æœ‰2æ¬¡å» loadKeyFromRemote å»åŠ è½½ï¼Œå¹¶æ²¡æœ‰åšåˆ°å®Œå…¨é˜²æ­¢å¾—åˆ°çš„ä½œç”¨\n\nå¦‚ä½•è§£å†³ä¸Šè¯‰é—®é¢˜äº†ï¼Œé—®é¢˜å‡ºåœ¨å“ªäº†ï¼Ÿæˆ‘ä»¬è¿›è¡Œç®€å•çš„æºç åˆ†æ\n\næºç åˆ†æ\næ•°æ®ç»“æ„\n\n// call is an in-flight or completed Do calltype call struct &#123;\twg  sync.WaitGroup\tval interface&#123;&#125;\terr error&#125;// Group represents a class of work and forms a namespace in which// units of work can be executed with duplicate suppression.type Group struct &#123;\tmu sync.Mutex       // protects m\tm  map[string]*call // lazily initialized // æ‡’åŠ è½½&#125;\n\n\nä¸»é€»è¾‘\n\nfunc (g *Group) Do(key string, fn func() (interface&#123;&#125;, error)) (interface&#123;&#125;, error) &#123;\tg.mu.Lock() // lock\tif g.m == nil &#123; // æ‡’åŠ è½½\t\tg.m = make(map[string]*call)\t&#125;  // å¦‚æœkeyå­˜åœ¨ï¼Œåˆ™wait\tif c, ok := g.m[key]; ok &#123;\t\tg.mu.Unlock()\t\tc.wg.Wait()\t\treturn c.val, c.err\t&#125;  // new caller + wg add  + set\tc := new(call)\tc.wg.Add(1)\tg.m[key] = c\tg.mu.Unlock()\t  // è°ƒç”¨æ–¹æ³•\tc.val, c.err = fn()  // notify\tc.wg.Done()\t  // åˆ é™¤key,é˜²æ­¢å†…å­˜æ³„æ¼\tg.mu.Lock()\tdelete(g.m, key)\tg.mu.Unlock()\treturn c.val, c.err&#125;\n\n\n(1) é¦–å…ˆä¼šå»åˆå§‹åŒ–ä¸€ä¸ª callerï¼Œç„¶åwaitgroup ++ ï¼Œç„¶åset  [é”]\n(2) ç„¶åè°ƒç”¨æ–¹æ³•ï¼Œå†done [æ— é”]\n(3) æœ€ååˆ é™¤ key [é”]\n(4) å…¶ä»–åŒä¸€ä¸ªkeyå¹¶å‘è¯·æ±‚ï¼Œä¼šå‘ç°keyå­˜åœ¨ï¼Œåˆ™ç›´æ¥waitäº†!\n\nå‡å¦‚ç°åœ¨å¹¶å‘è¯·æ±‚ï¼Œé‚£ä¹ˆæ­¤æ—¶å‡å¦‚éƒ½åŠ è½½åŒä¸€ä¸ªkeyï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªkeyå…ˆç»è¿‡ï¼Œä½†æ˜¯è®¡ç®—æœºæ‰§è¡Œçš„å¾ˆå¿«ï¼Œåœ¨ç¬¬(2)å’Œ(3)æ­¥æ‰§è¡Œçš„å¾ˆå¿«ï¼Œå¯¼è‡´keyå·²ç»åˆ é™¤ï¼Œä½†æ˜¯è¿˜æœ‰è¯·æ±‚æœªå¼€å§‹ Do æ–¹æ³•æˆ–è€…åˆ°äº† g.m[key] è¿™ä¸€æ­¥ï¼Œéƒ½æ˜¯ä¼šå†æ¬¡é‡æ–°èµ°ä¸€é\n\né—®é¢˜? èƒ½ä¸èƒ½ä½¿ç”¨è¯»å†™é”ä¼˜åŒ–åŠ é”äº†ï¼Ÿ\n\nå‡å¦‚è¯»å–keyåŠ çš„è¯»é”ï¼Œé‚£ä¹ˆæ­¤æ—¶æœ€é•¿æµç¨‹å˜ä¸º: è¯»é” + å†™é” + å†™é”ï¼Œ æœ€çŸ­æµç¨‹å˜ä¸º: è¯»é”ï¼Œ å½“ç‰¹åˆ«é«˜çš„å¹¶å‘æ‰ä¼šæœ‰è¾ƒä¸ºå¤§çš„æå‡ï¼\nä¼˜åŒ–åç”¨æ³•package mainimport (\t&quot;fmt&quot;\t&quot;sync&quot;\t&quot;github.com/golang/groupcache/singleflight&quot;)var (\tcache sync.Map\tsf    = singleflight.Group&#123;&#125;)func main() &#123;\tkey := &quot;k1&quot; // å‡å¦‚ç°åœ¨æœ‰100ä¸ªå¹¶å‘è¯·æ±‚è®¿é—® k1\twg := sync.WaitGroup&#123;&#125;\twg.Add(100)\tfor x := 0; x &lt; 100; x++ &#123;\t\tgo func() &#123;\t\t\tdefer wg.Done()\t\t\tloadKey(key)\t\t&#125;()\t&#125;\twg.Wait()\tfmt.Printf(&quot;result key: %s\\n&quot;, loadKey(key))&#125;func loadKey(key string) (v string) &#123;\tif data, ok := cache.Load(key); ok &#123;\t\treturn data.(string)\t&#125;\tdata, err := sf.Do(key, func() (interface&#123;&#125;, error) &#123;\t\tif data, ok := cache.Load(key); ok &#123; // åŒé‡æ£€æµ‹\t\t\treturn data.(string), nil\t\t&#125;\t\tdata := &quot;data&quot; + &quot;|&quot; + key\t\tfmt.Printf(&quot;load and set success, data: %s\\n&quot;, data)\t\tcache.Store(key, data)\t\treturn data, nil\t&#125;)\tif err != nil &#123;\t\t// todo handler\t\tpanic(err)\t&#125;\treturn data.(string)&#125;// output//load and set success, data: data|k1//result key: data|k1\n\nbackoffä»‹ç»\næºç åœ°å€: github.com/cenkalti/backoff\n\nä¸»è¦æ˜¯è§£å†³è¡¥å¿çš„æ“ä½œï¼Œå½“ä¸šåŠ¡/æ–¹æ³•é‡åˆ°å¼‚å¸¸çš„æƒ…å†µï¼Œé€šå¸¸ä¼šæœ‰è¡¥å¿çš„æ“ä½œï¼Œä¸€èˆ¬å°±æ˜¯ä¸šåŠ¡ç»§ç»­é‡è¯•\n\næˆ‘ç»å¸¸ä½¿ç”¨è¿™ä¸ªåŒ…åšé‡è¯•ï¼Œæ„Ÿè§‰æ¯”è¾ƒå¥½ç”¨ï¼ä¸ç”¨è‡ªå·±å†™forå¾ªç¯äº†\n\n\nç®€å•ä½¿ç”¨\næ¨¡æ‹Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œå»åŠ è½½ä¸€ä¸ªdataæ•°æ®ï¼Œå½“é‡åˆ°å¶æ•°çš„æ—¶å€™å°±çˆ†å¼‚å¸¸ï¼\n\npackage mainimport (\t&quot;fmt&quot;\t&quot;math/rand&quot;\t&quot;time&quot;\t&quot;github.com/cenkalti/backoff&quot;)func main() &#123;\tvar (\t\tdata interface&#123;&#125;\t)\tif err := backoff.Retry(func() error &#123;\t\tif rand.Int()%2 == 0 &#123; // æ¨¡æ‹Ÿå¼‚å¸¸\t\t\terr := fmt.Errorf(&quot;find data mod 2 is zero&quot;)\t\t\tfmt.Printf(&quot;find err, err: %s\\n&quot;, err)\t\t\treturn err\t\t&#125;\t\tdata = &quot;load success&quot;\t\treturn nil\t&#125;, backoff.WithMaxRetries(backoff.NewConstantBackOff(time.Millisecond*1), 3)); err != nil &#123;\t\tpanic(err)\t&#125;\tfmt.Printf(&quot;data: %s\\n&quot;, data)&#125;//output//find err, err: find data mod 2 is zero//data: load success\n\nç»“æœå¯ä»¥çœ‹åˆ°å¾ˆå¥½çš„è§£å†³äº†é‡è¯•çš„é—®é¢˜ï¼ä»£ç å¾ˆä¼˜é›…ï¼\n\nå…³äºä¸ºå•¥ä¸šåŠ¡ä¸­é‡è¯•éƒ½å–œæ¬¢ç­‰å¾…ä¸€ä¸‹ï¼Œå…¶å®æ¯”è¾ƒä½›å­¦ï¼\n\nsdkä»‹ç»\nback off\n\ntype BackOff interface &#123;\t// NextBackOff returns the duration to wait before retrying the operation,\t// or backoff. Stop to indicate that no more retries should be made.\t// æ˜¯å¦ä¸‹ä¸€æ¬¡ï¼Œä»¥åŠä¸‹ä¸€æ¬¡éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼\tNextBackOff() time.Duration\t// Reset to initial state.\tReset()&#125;\n\n\nå°è£…äº†å››ä¸ªåŸºæœ¬çš„Backoff\n\n// ä¸éœ€è¦ç­‰å¾…ï¼Œç»§ç»­é‡è¯•type ZeroBackOff struct&#123;&#125;func (b *ZeroBackOff) Reset() &#123;&#125;func (b *ZeroBackOff) NextBackOff() time.Duration &#123; return 0 &#125;// ä¸å…è®¸é‡è¯•type StopBackOff struct&#123;&#125;func (b *StopBackOff) Reset() &#123;&#125;func (b *StopBackOff) NextBackOff() time.Duration &#123; return Stop &#125;// æ¯æ¬¡é‡è¯•ç­‰å¾…ç›¸åŒçš„æ—¶é—´type ConstantBackOff struct &#123;\tInterval time.Duration&#125;func (b *ConstantBackOff) Reset()                     &#123;&#125;func (b *ConstantBackOff) NextBackOff() time.Duration &#123; return b.Interval &#125;func NewConstantBackOff(d time.Duration) *ConstantBackOff &#123;\treturn &amp;ConstantBackOff&#123;Interval: d&#125;&#125;// é‡è¯•back offï¼Œä¸»è¦æ˜¯è®¡æ•°é‡è¯•çš„æ¬¡æ•°ï¼Œä»¥åŠåŸºäºå§”æ‰˜ä»£ç†æ¨¡å‹ï¼Œå®ç°æ¯”è¾ƒå¥½çš„æ‹“å±•// max=0 ä¼šæ— é™é‡è¯•ä¸‹å»func WithMaxRetries(b BackOff, max uint64) BackOff &#123;\treturn &amp;backOffTries&#123;delegate: b, maxTries: max&#125;&#125;type backOffTries struct &#123;\tdelegate BackOff\tmaxTries uint64\tnumTries uint64&#125;func (b *backOffTries) NextBackOff() time.Duration &#123;\tif b.maxTries &gt; 0 &#123;\t\tif b.maxTries &lt;= b.numTries &#123;\t\t\treturn Stop\t\t&#125;\t\tb.numTries++\t&#125;\treturn b.delegate.NextBackOff()&#125;func (b *backOffTries) Reset() &#123;\tb.numTries = 0\tb.delegate.Reset()&#125;\n\n\nè‡ªé€‚åº”backoff\n\n\næ•´ä¸ªæ—¶é—´ &lt; 15minï¼Œé‡è¯•æ—¶é—´ä»500mså¼€å§‹å¢é•¿ï¼Œæ¯æ¬¡å¢é•¿1.5å€ï¼Œç›´åˆ°60sæ¯æ¬¡ï¼\n\n// NewExponentialBackOff creates an instance of ExponentialBackOff using default values.func NewExponentialBackOff() *ExponentialBackOff &#123;\tb := &amp;ExponentialBackOff&#123;\t\tInitialInterval:     DefaultInitialInterval,\t\tRandomizationFactor: DefaultRandomizationFactor,\t\tMultiplier:          DefaultMultiplier,\t\tMaxInterval:         DefaultMaxInterval,\t\tMaxElapsedTime:      DefaultMaxElapsedTime,\t\tClock:               SystemClock,\t&#125;\tb.Reset()\treturn b&#125;\n\nç»„åˆä½¿ç”¨ï¼Œæ„å»ºä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼è¿™ä¸ªåº”è¯¥æ˜¯æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ç”¨åˆ°çš„ï¼Œæœ¬åœ°ç¼“å­˜å¯ä»¥æœ‰æ•ˆè§£å†³é«˜é¢‘æ•°æ®ä½†æ˜¯æ•°æ®æ•´ä½“å ç”¨å¹¶ä¸æ˜¯ç‰¹åˆ«çš„å¤§ï¼Œä½†æ˜¯æ¯æ¬¡åŠ è½½éƒ½éœ€è¦é¢å¤–çš„å¼€é”€ï¼Œæ‰€ä»¥åŸºäºæœ¬åœ°ç¼“å­˜å»æ„å»ºä¸€ä¸ªå¯ç”¨æ€§æ¯”è¾ƒé«˜çš„ç¼“å­˜æ¡†æ¶ï¼\n\næ ¸å¿ƒä»£ç \n\npackage mainimport (\t&quot;context&quot;\t&quot;fmt&quot;\t&quot;time&quot;\t&quot;github.com/cenkalti/backoff&quot;\t&quot;golang.org/x/sync/singleflight&quot;)var (\tlocalCacheCallbackIsNil = fmt.Errorf(&quot;cache callback func is nil&quot;))type CacheOption interface &#123;&#125;type Cache interface &#123;\tGet(key string) (value interface&#123;&#125;, isExist bool)\tSet(key string, value interface&#123;&#125;, opts ...CacheOption)&#125;type WrapperCache interface &#123;\tGetData(ctx context.Context, key string, callback func(ctx context.Context) (interface&#123;&#125;, error)) (v interface&#123;&#125;, err error)&#125;type wrapperCache struct &#123;\tname           string\tcache          Cache\tsingleflight   singleflight.Group\tretrySleepTime time.Duration\tretryNum       uint64&#125;func NewWrapperCache(name string, cache Cache) WrapperCache &#123;\treturn &amp;wrapperCache&#123;\t\tname:           name,\t\tcache:          cache,\t\tretryNum:       3,\t\tretrySleepTime: time.Millisecond * 10,\t&#125;&#125;// emitHitCachedMetric è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡func (c *wrapperCache) emitHitCachedMetric(hit bool) &#123;&#125;func (c *wrapperCache) GetData(ctx context.Context, key string, callback func(ctx context.Context) (interface&#123;&#125;, error)) (v interface&#123;&#125;, err error) &#123;\tif result, isExist := c.cache.Get(key); isExist &#123;\t\tc.emitHitCachedMetric(true)\t\treturn result, nil\t&#125;\tif callback == nil &#123;\t\treturn nil, localCacheCallbackIsNil\t&#125;\tc.emitHitCachedMetric(false)\tresult, err, _ := c.singleflight.Do(key, func() (interface&#123;&#125;, error) &#123;\t\t// åŒé‡æ£€æµ‹ï¼Œé˜²æ­¢singleflight é”çš„keyå¤±æ•ˆ\t\tif result, isExist := c.cache.Get(key); isExist &#123;\t\t\treturn result, nil\t\t&#125;\t\tvar callBackData interface&#123;&#125;\t\tif err := backoff.Retry(func() error &#123;\t\t\tif data, err := callback(ctx); err != nil &#123;\t\t\t\treturn err\t\t\t&#125; else &#123;\t\t\t\tcallBackData = data\t\t\t\treturn nil\t\t\t&#125;\t\t&#125;, backoff.WithMaxRetries(backoff.NewConstantBackOff(c.retrySleepTime), c.retryNum)); err != nil &#123;\t\t\t// todo add log\t\t\treturn nil, err\t\t&#125;\t\tc.cache.Set(key, callBackData)\t\treturn callBackData, nil\t&#125;)\tif err != nil &#123;\t\treturn nil, err\t&#125;\treturn result, nil&#125;\n\n\ncache å®ç°\n\nè¿™é‡Œä»‹ç»ä¸€ä¸‹sync.Mapä¸ºä¸€ä¸ªæ— è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜å’Œ go-cacheæœ‰ttlçš„ç¼“å­˜æ¡†æ¶ï¼æˆ–è€…ä½ è‡ªå·±å»å®ç°ä¸€ä¸ªä¹Ÿå¯ä»¥ï¼\nimport (  &quot;sync&quot;\t&quot;github.com/patrickmn/go-cache&quot;)type localCache struct &#123;\tsync.Map&#125;func (l *localCache) Get(key string) (value interface&#123;&#125;, isExist bool) &#123;\treturn l.Load(key)&#125;func (l *localCache) Set(key string, value interface&#123;&#125;, opts ...CacheOption) &#123;\tl.Store(key, value)&#125;type goCache struct &#123;\t*cache.Cache&#125;func (l goCache) Set(key string, value interface&#123;&#125;, opts ...CacheOption) &#123;\tl.SetDefault(key, value)&#125;\n\n\næµ‹è¯•ç”¨ä¾‹\n\nimport (\t&quot;context&quot;\t&quot;strconv&quot;\t&quot;sync&quot;\t&quot;sync/atomic&quot;\t&quot;testing&quot;\t&quot;time&quot;\t&quot;github.com/patrickmn/go-cache&quot;\t&quot;github.com/stretchr/testify/assert&quot;)func TestNewCached(t *testing.T) &#123;\tcached := NewWrapperCache(&quot;test&quot;, goCache&#123;\t\tCache: cache.New(time.Second*10, time.Second*30),\t&#125;)\t//cached := NewWrapperCache(&quot;test&quot;, &amp;localCache&#123;&#125;)\tctx := context.Background()\twg := sync.WaitGroup&#123;&#125;\tvar (\t\tloadTime uint64 = 0\t\tcurrG           = 20\t)\twg.Add(currG)\tfor x := 0; x &lt; currG; x++ &#123;\t\tgo func(x int) &#123;\t\t\tdefer wg.Done()\t\t\tfor y := 0; y &lt; 200000; y++ &#123;\t\t\t\tkey := y % 10\t\t\t\tresult, err := cached.GetData(ctx, strconv.Itoa(key), func(ctx context.Context) (interface&#123;&#125;, error) &#123;\t\t\t\t\tatomic.AddUint64(&amp;loadTime, 1)\t\t\t\t\tt.Logf(&quot;load key: %s, num: %d, g_id: %d\\n&quot;, strconv.Itoa(key), y, x)\t\t\t\t\treturn int(key), nil\t\t\t\t&#125;)\t\t\t\tif err != nil &#123;\t\t\t\t\tt.Fatal(err)\t\t\t\t&#125;\t\t\t\tif result.(int) != key &#123;\t\t\t\t\tt.Fatal(&quot;data is not eq err&quot;)\t\t\t\t&#125;\t\t\t&#125;\t\t&#125;(x)\t&#125;\twg.Wait()\tfor x := 0; x &lt; 10; x++ &#123;\t\tresult, _ := cached.GetData(ctx, strconv.Itoa(x), nil)\t\tt.Log(result)\t\tassert.Equal(t, result.(int), int(x))\t&#125;\tassert.Equal(t, int(loadTime), int(10))&#125;\n\n","categories":["Golang"],"tags":["singleflight","backoff"]},{"title":"Goçš„runtime.SetFinalizerå‡½æ•°ä»‹ç»","url":"/2022/02/28/f2436dad6e7955374f33b91fcf1ddca0/","content":"â€‹      ä¸šåŠ¡ä¸­æˆ‘ä»¬ç»å¸¸é‡åˆ°éœ€è¦è¿›è¡Œæ‰‹åŠ¨å›æ”¶çš„æ“ä½œï¼Œè™½ç„¶Goæä¾›äº†deferæ“ä½œå¯ä»¥ç”¨æ¥æ‰‹åŠ¨å›æ”¶ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™ç¡®å®ä¼šå‡ºç°ä¸€äº›caseç”¨æˆ·å¿˜è®°æ‰‹åŠ¨å›æ”¶ï¼Œå¹¶ä¸”å¤§é‡å†…å­˜æ³„æ¼æˆ–è€…goroutineæ³„å£çš„é—®é¢˜ï¼Œè€Œä¸”åªèƒ½é€šè¿‡çº¿ä¸Šå·¥å…·è¿›è¡Œäº‹åå®šä½ï¼æœ¬æ–‡ä»‹ç»ä¸€ä¸‹ runtime.SetFinalizer æ¥è§£å†³å¯¹è±¡å›æ”¶é‡Šæ”¾èµ„æºçš„é—®é¢˜ï¼æœ¬æ–‡åªæ˜¯æ ¹æ®ç®€å•çš„ä¾‹å­è¿›è¡Œé˜è¿°ï¼Œä¾‹å­é€‰æ‹©ä¸ä¸€å®šçš„å¥½ï¼\n\n\nä»‹ç»\nruntime.SetFinalizer æ˜¯Goæä¾›å¯¹è±¡è¢«GCå›æ”¶æ—¶çš„ä¸€ä¸ªæ³¨å†Œå‡½æ•°ï¼Œå¯ä»¥åœ¨å¯¹è±¡è¢«å›æ”¶çš„æ—¶å€™å›æ‰å‡½æ•°\næ­¤æ–¹æ³•ç±»ä¼¼äºJAVAçš„finalize æ–¹æ³•å’ŒC++çš„ææ„å‡½æ•°ï¼\nå½“å­˜åœ¨å¤šå±‚å¼•ç”¨æ—¶ï¼Œç±»ä¼¼äºA-&gt;B-&gt;C è¿™ç§å…³ç³»çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•è§£å†³å‘¢ï¼Ÿ\nGoå‡½æ•°å†…éƒ¨åŸç†ä»‹ç»\n\nfunc SetFinalizer(obj interface&#123;&#125;, finalizer interface&#123;&#125;) &#123;    ....  // å¯¹è±¡çš„ä½5ä½æ˜¯å¯¹è±¡ç±»å‹ï¼Œè¿™é‡Œæ£€æµ‹ä¸€ä¸‹æ˜¯å¦æ˜¯æŒ‡é’ˆç±»å‹\tif etyp.kind&amp;kindMask != kindPtr &#123;\t\tthrow(&quot;runtime.SetFinalizer: first argument is &quot; + etyp.string() + &quot;, not pointer&quot;)\t&#125;  // ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯å‡½æ•°\tif ftyp.kind&amp;kindMask != kindFunc &#123;\t\tthrow(&quot;runtime.SetFinalizer: second argument is &quot; + ftyp.string() + &quot;, not a function&quot;)\t&#125;   //\t// make sure we have a finalizer goroutine\tcreatefing()      // finally add finalizer\tsystemstack(func() &#123;\t\tif !addfinalizer(e.data, (*funcval)(f.data), nret, fint, ot) &#123;\t\t\tthrow(&quot;runtime.SetFinalizer: finalizer already set&quot;)\t\t&#125;\t&#125;)&#125;// æœ€åå¯åŠ¨è°ƒåº¦æ± å­ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªGå»å›æ”¶æ•´ä¸ªåº”ç”¨ç¨‹åºçš„finalizeå‡½æ•°!func createfing() &#123;\t// start the finalizer goroutine exactly once\tif fingCreate == 0 &amp;&amp; atomic.Cas(&amp;fingCreate, 0, 1) &#123;\t\tgo runfinq()\t&#125;&#125;// 1. addfinalizer å°±æ˜¯ç»™å¯¹è±¡çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åŠ äº†ä¸ªç‰¹æ®Šæ ‡è®°ï¼æ­¤æ ‡è®°æ­¤å¯¹è±¡æ˜¯finalizerå¯¹è±¡ï¼Œå†…éƒ¨å®ç°å°±æ˜¯æ‹¿åˆ°å¯¹è±¡çš„spanï¼Œç„¶åspané‡Œé¢æœ‰ä¸ªé“¾è¡¨ç»´æŠ¤å¯¹è±¡çš„ç‰¹æ®Šæ ‡è®°ï¼// 2. runfinq å‡½æ•°ï¼Œå°±æ˜¯éå†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åå›æ”¶é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œä¸€ä¸ªæ­»å¾ªç¯ç½¢äº†ï¼å¦‚æœæ²¡æœ‰ç­‰å¾…å›æ”¶çš„å¯¹è±¡ï¼Œå°±parkä½// 3. æ¯æ¬¡å½“GC sweep é˜¶æ®µï¼Œä¼šå…ˆæ ‡è®°ï¼Œç„¶åç¬¬äºŒæ¬¡GCæ‰è¦è¢«å›æ”¶ï¼ˆæ¸…ç†ï¼‰ï¼å…·ä½“é€»è¾‘å¯ä»¥çœ‹mspan#sweep\n\nç®€å•ä½¿ç”¨package mainimport (\t&quot;fmt&quot;\t&quot;runtime&quot;\t&quot;time&quot;)type object intfunc (o object) Ptr() *object &#123;\treturn &amp;o&#125;var (\tcacheData = make(map[string]*object, 1024))func deleteData(key string) &#123;\tdelete(cacheData, key)&#125;func setData(key string, v object) &#123;\tdata := v.Ptr()\truntime.SetFinalizer(data, func(data *object) &#123;\t\tfmt.Printf(&quot;runtime invoke Finalizer data: %d, time: %s\\n&quot;, *data, time.Now().Format(&quot;15:04:05.000&quot;))\t\ttime.Sleep(time.Second)\t&#125;)\tcacheData[key] = data&#125;func main() &#123;\tsetData(&quot;key1&quot;, 1)\tsetData(&quot;key2&quot;, 2)\tsetData(&quot;key3&quot;, 3)\tdeleteData(&quot;key1&quot;)\tdeleteData(&quot;key2&quot;)\tdeleteData(&quot;key3&quot;)\tfor x := 0; x &lt; 5; x++ &#123;\t\tfmt.Println(&quot;invoke runtime.GC()&quot;)\t\truntime.GC()\t\ttime.Sleep(time.Second)\t&#125;&#125;// output://invoke runtime.GC()//runtime invoke Finalizer data: 1, time: 23:44:49.013//invoke runtime.GC()//runtime invoke Finalizer data: 3, time: 23:44:50.019//invoke runtime.GC()//runtime invoke Finalizer data: 2, time: 23:44:51.020//invoke runtime.GC()//invoke runtime.GC()\n\n\nå¹¶æ²¡æœ‰çœ‹å‡ºç¬¬äºŒæ¬¡æ‰ä¼šGCæ‰ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿåœ¨deleleè¿‡ç¨‹ä¸­è§¦å‘è¿‡ä¸€æ¬¡GC\nå¯ä»¥çœ‹åˆ°GCåè°ƒç”¨Finalizer å‡½æ•°æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼\n\næ—¥å¸¸ä½¿ç”¨æ³¨æ„ç‚¹\nGCæ³¨å†Œçš„Finalizerå‡½æ•°æ‰§è¡Œæ—¶é—´ä¸é€‚åˆè¿‡é•¿ï¼\nFinalizer å‡½æ•°è¿”å›ç»“æœæ˜¯ç³»ç»Ÿä¼šå¿½ç•¥ï¼Œæ‰€ä»¥ä½ è¿”å›errorä¹Ÿæ— æ‰€è°“ï¼Œä½†æ˜¯åˆ‡è®°ä¸å¯ä»¥panicï¼Œç¨‹åºæ˜¯æ— æ³•recoverçš„ï¼\nå¦‚æœå¯¹è±¡åœ¨Finalizerå‡½æ•°å†æ¬¡è¢«å¼•ç”¨ï¼Œæ˜¯ä¸ä¼šè¢«å†æ¬¡å›æ”¶è°ƒç”¨Finalizerå‡½æ•°çš„ï¼\nå½“å­˜åœ¨ A-&gt;B-&gt;C çš„å¼•ç”¨æ—¶ï¼Œå›æ”¶é¡ºåºæ˜¯å¼•ç”¨é¡ºåºï¼Œå½“å›æ”¶Aåï¼Œç„¶åå†å›æ”¶Bï¼Œç„¶åå†å›æ”¶Cï¼Œåº”è¯¥æ²¡å•¥é—®é¢˜å§\nå¦‚æœä½ å¯¹è±¡è¢«goroutine å¼•ç”¨è€Œåˆ†é…åˆ°å †ä¸Šï¼Œgoroutine åˆæ²¡åŠæ³•å…³é—­ï¼Œå¯¼è‡´ä½ éœ€è¦åŒ…è£…ä¸€å±‚å¯¹è±¡è¿›è¡Œå›æ”¶ï¼ä¾‹å¦‚ä¸‹åˆ—ä¾‹å­ï¼Œå¯¼è‡´ä¸šåŠ¡å‡½æ•°ç»“æŸåå¿˜è®°äº†Closeï¼Œå¯¼è‡´Gæ³„æ¼ï¼Œè™½ç„¶æ³¨å†Œäº†Finalizerå‡½æ•°ï¼Œä½†æ˜¯æ²¡æœ‰è¢«å›æ”¶ï¼æˆ‘å°±çŠ¯è¿‡è¿™æ ·çš„é”™è¯¯ï¼Œä¸è¿‡åœ¨å†™æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™å°±å‘ç°äº†ï¼ï¼\n\ntype cacheData struct &#123;\tname     string\tdataLock sync.RWMutex\tdata     map[string]interface&#123;&#125;\treporter func(data *cacheData)\tcloseOnce sync.Once\tdone      chan struct&#123;&#125;&#125;func NewCacheData(name string) *cacheData &#123;\tdata := &amp;cacheData&#123;\t\tname: name,\t\tdata: map[string]interface&#123;&#125;&#123;&#125;,\t\treporter: func(data *cacheData) &#123;\t\t\tlog.Println(&quot;reporter&quot;)\t\t&#125;,\t\tdone: make(chan struct&#123;&#125;, 0),\t&#125;\tdata.init()\truntime.SetFinalizer(data, (*cacheData).Close)\treturn data&#125;// init æ³¨å†Œreporterå‡½æ•°ï¼Œæ¯”å¦‚ä¸ŠæŠ¥ä¸€äº›ç¼“å­˜çš„ä¿¡æ¯func (c *cacheData) init() &#123;\tgo func() &#123;\t\tc.reporter(c)\t\tt := time.NewTicker(time.Second)\t\tfor &#123;\t\t\tselect &#123;\t\t\tcase &lt;-c.done:\t\t\t\tt.Stop()\t\t\t\treturn\t\t\tcase &lt;-t.C:\t\t\t\tc.reporter(c)\t\t\t&#125;\t\t&#125;\t&#125;()&#125;// Close å‡½æ•°ä¸»è¦æ˜¯é˜²æ­¢goroutineæ³„æ¼func (c *cacheData) Close() &#123;\tc.closeOnce.Do(func() &#123;\t\tclose(c.done)\t&#125;)&#125;func BizFunc() &#123;\tcache := NewCacheData(&quot;test&quot;)\tcache.Set(&quot;k1&quot;, &quot;v1&quot;)\t// biz ....\t// ä½†æ˜¯å¿˜è®°å…³é—­cacheäº†ï¼Œæˆ–è€…ç­‰ç­‰çš„æ²¡æœ‰closeï¼Œå¯¼è‡´Gæ³„æ¼&#125;func main() &#123;\tBizFunc()\tfor x := 0; x &lt; 10; x++ &#123;\t\truntime.GC()\t\tlog.Println(&quot;runtime.GC&quot;)\t\ttime.Sleep(time.Second)\t&#125;&#125;\n\nå¦‚ä½•è§£å†³äº†ï¼Ÿï¼Ÿ å¯ä»¥çœ‹ NewSafeCacheData\npackage mainimport (\t&quot;log&quot;\t&quot;runtime&quot;\t&quot;sync&quot;\t&quot;time&quot;)func init() &#123;\tlog.SetFlags(log.Ltime)&#125;func (c *cacheData) Set(key string, v interface&#123;&#125;) &#123;\tc.dataLock.Lock()\tdefer c.dataLock.Unlock()\tc.data[key] = v&#125;type CacheData struct &#123;\t*cacheData&#125;type cacheData struct &#123;\tname     string\tdataLock sync.RWMutex\tdata     map[string]interface&#123;&#125;\treporter func(data *cacheData)\tcloseOnce sync.Once\tdone      chan struct&#123;&#125;&#125;func NewCacheData(name string) *cacheData &#123;\tdata := &amp;cacheData&#123;\t\tname: name,\t\tdata: map[string]interface&#123;&#125;&#123;&#125;,\t\treporter: func(data *cacheData) &#123;\t\t\tlog.Println(&quot;reporter&quot;)\t\t&#125;,\t\tdone: make(chan struct&#123;&#125;, 0),\t&#125;\treturn data&#125;// NewSafeCacheData å®‰å…¨çš„å‡½æ•°func NewSafeCacheData(name string) *CacheData &#123;\tdata := NewCacheData(name)\tdata.init()\tresult := &amp;CacheData&#123;\t\tcacheData: data,\t&#125;\truntime.SetFinalizer(result, (*CacheData).Close)\treturn result&#125;// init æ³¨å†Œreporterå‡½æ•°ï¼Œæ¯”å¦‚ä¸ŠæŠ¥ä¸€äº›ç¼“å­˜çš„ä¿¡æ¯func (c *cacheData) init() &#123;\tgo func() &#123;\t\tc.reporter(c)\t\tt := time.NewTicker(time.Second)\t\tfor &#123;\t\t\tselect &#123;\t\t\tcase &lt;-c.done:\t\t\t\tt.Stop()\t\t\t\treturn\t\t\tcase &lt;-t.C:\t\t\t\tc.reporter(c)\t\t\t&#125;\t\t&#125;\t&#125;()&#125;// Close å‡½æ•°ä¸»è¦æ˜¯é˜²æ­¢goroutineæ³„æ¼func (c *cacheData) Close() &#123;\tc.closeOnce.Do(func() &#123;\t\tclose(c.done)\t&#125;)&#125;func BizFunc() &#123;\tcache := NewSafeCacheData(&quot;test&quot;)\tcache.Set(&quot;k1&quot;, &quot;v1&quot;)\t// biz ....\t// ä½†æ˜¯å¿˜è®°å…³é—­cacheäº†ï¼Œæˆ–è€…ç­‰ç­‰çš„æ²¡æœ‰closeï¼Œå¯¼è‡´Gæ³„æ¼&#125;func main() &#123;\tBizFunc()\tfor x := 0; x &lt; 10; x++ &#123;\t\truntime.GC()\t\tlog.Println(&quot;runtime.GC&quot;)\t\ttime.Sleep(time.Second)\t&#125;&#125;\n\n","categories":["Golang"],"tags":["Golang"]},{"title":"æ¥å£mockå¹³å°","url":"/2021/03/02/f86786a14802b2f17d560d87387e8690/","content":"â€‹        æ¥å£Mockå¹³å°ä¸»è¦å®è·µåœ¨é¡¹ç›®çš„å¼€å‘å›¢é˜Ÿå¤ªå¤šï¼Œä¸šåŠ¡éœ€è¦å¯¹æ¥å„ä¸ªä¸‹å±‚æœåŠ¡ï¼Œè€Œä¸‹å±‚æœåŠ¡æä¾›çš„APIæ—¶é—´çº¿çš„åå·®ï¼Œå¾€å¾€éœ€è¦Mockæ¥å£æä¾›ç»™éœ€æ±‚æ–¹(å‰ç«¯)ï¼Œè¿›è¡Œè”è°ƒï¼Œæé«˜äº¤ä»˜è´¨é‡ã€‚æœ€åå†ç”±æˆ‘ä»¬å»å¯¹æ¥ä¸‹å±‚æœåŠ¡æ¥ä¿è¯äº¤ä»˜è´¨é‡ï¼ŒåŒæ—¶ä¸‹å±‚æœåŠ¡ä¹Ÿéœ€è¦æä¾›mockæ¥æ ¼å¼åŒ–å“åº”å‚æ•°ï¼Œä½†æ˜¯å¾€å¾€çœç•¥è¿™éƒ¨åˆ†å·¥ä½œå¯¼è‡´æ¥å£æ–‡æ¡£å¯ç”¨æ€§å¤ªä½ã€‚\n\n\n1ã€Yapi\nç”±å»å“ªå„¿ç½‘å¤§å‰ç«¯æŠ€æœ¯ä¸­å¿ƒ å¼€æºçš„é¡¹ç›®\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://hellosean1025.github.io/yapi/documents/index.html\ngithubï¼šhttps://github.com/ymfe/yapi\n\n1ã€ç•Œé¢ä»‹ç»ï¼š\nâ€‹     è¯·æ±‚ Mock æ•°æ®æ—¶ï¼Œè§„åˆ™åŒ¹é…ä¼˜å…ˆçº§ï¼šMock æœŸæœ› &gt; è‡ªå®šä¹‰ Mock è„šæœ¬ &gt; é¡¹ç›®å…¨å±€ mock è„šæœ¬ &gt; æ™®é€š Mockã€‚å¦‚æœå‰é¢åŒ¹é…åˆ° Mock æ•°æ®ï¼Œåé¢ Mock åˆ™ä¸è¿”å›ã€‚\n\n1ã€é¢„è§ˆç•Œé¢\nâ€‹    å¤§æ¦‚ä»‹ç»ï¼Œæ— å…¶ä»–ç”¨å¤„ï¼Œå”¯ä¸€ç”¨å¤„å°±æ˜¯æ¥å£Mock\n\n\n2ã€ç¼–è¾‘ç•Œé¢åŠŸèƒ½ (ä¼˜å…ˆçº§ level-3)1ã€ç‰¹ç‚¹è¿™ä¸ªæ˜¯æ•°æ®Mockï¼Œæ”¯æŒåŸºæœ¬çš„è¯­æ³•ï¼Œè¿™ä¸ªè¯­æ³•æ¥è‡ªäº Mockæ•°æ®å ä½ç¬¦å®šä¹‰è§„èŒƒ DPD , ä»–æ”¯æŒè°ƒç”¨ Mock.Random çš„ä»»ä½•æ–¹æ³•ï¼Œæ¯”å¦‚è°ƒç”¨ Random.datetime(&#39;yy-MM-dd a HH:mm:ss&#39;), ä½ åªéœ€è¦å†™ @data(&#39;yy-MM-dd a HH:mm:ss&#39;) å³å¯\n2ã€é€‚ç”¨åœºæ™¯\næ¯”è¾ƒé€‚ç”¨äºè¯·æ±‚å‚æ•°çš„Mock\nå“åº”å­—æ®µä¸å¤æ‚ï¼Œæ²¡æœ‰å¤æ‚çš„æ•°ç»„ç»“æ„ï¼Œä¸éœ€è¦å®šåˆ¶åŒ–å¤„ç†\n\n\n3ã€è¿è¡Œé¡µé¢1ã€ç‰¹ç‚¹\næ”¯æŒå¤šç§ç¯å¢ƒçš„æ”¯æŒ\n\n\n\næ”¯æŒæµ‹è¯•mockæ¥å£\næ”¯æŒè°ƒè¯•å¤§éƒ¨åˆ†ç¯å¢ƒ\n\n\n2ã€é€‚ç”¨åœºæ™¯\næ¥å£è°ƒè¯•ï¼ˆä½†æ˜¯æ— å†å²è®°å½•ï¼Œè¿™ä¸ªæ¯”è¾ƒå‘ï¼‰\nå’Œé…ç½®è¿›è¡Œæ¯”è¾ƒ\n\n4ã€é«˜çº§Mock-æœŸæœ› (ä¼˜å…ˆçº§æœ€é«˜-level 1)1ã€ç‰¹ç‚¹å¯ä»¥å¯¹äºæ•°æ®çš„å“åº”è¿›è¡ŒæœŸæœ›å€¼è®¾å®šï¼Œå®Œå…¨æ”¯æŒ Mock.js çš„è¯­æ³•ï¼Œè¯­æ³•æ–‡æ¡£: http://mockjs.com/examples.html\n2ã€é€‚ç”¨åœºæ™¯\nå¯¹äºæ•°æ®mockéœ€è¦å®šåˆ¶åŒ–å¤„ç†çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦å°†listè¿›è¡ŒæŒ‡å®šmock\nä½†æ˜¯å®ƒä¸é€‚åˆå¯¹äºæ•°æ®è¿›è¡Œè„šæœ¬å¤„ç†ï¼Œæ¯”å¦‚è¦å¯¹äºè¯·æ±‚å‚æ•°è¿›è¡Œæ ¡éªŒç­‰ç­‰\nå¯ä»¥å¯¹äºå“åº”æ—¶é•¿è¿›è¡Œmock\nå¯ä»¥å¯¹äº\n\nä¾‹å­ï¼š\n&#123;  &quot;code&quot;: 0,  &quot;message&quot;: &quot;success&quot;,  &quot;data&quot;: &#123;    &quot;list|40-50&quot;: [      &#123;        &quot;worker_name&quot;: &quot;@cname&quot;,        &quot;id&quot;: &quot;@integer(0)&quot;,        &quot;create_time&quot;: &quot;@date(&#x27;yyyy-MM-dd HH-mm-ss&#x27;)&quot;,        &quot;status&quot;: &quot;@integer(1,4)&quot;,        &quot;discover_place&quot;: &quot;@city&quot;      &#125;    ],    &quot;nums_list&quot;: [      &#123;        &quot;status&quot;: 1,        &quot;num&quot;: &quot;@integer(1,1000)&quot;      &#125;,      &#123;        &quot;status&quot;: 2,        &quot;num&quot;: &quot;@integer(1,1000)&quot;      &#125;,      &#123;        &quot;status&quot;: 3,        &quot;num&quot;: &quot;@integer(1,1000)&quot;      &#125;,      &#123;        &quot;status&quot;: 3,        &quot;num&quot;: &quot;@integer(1,1000)&quot;      &#125;    ],    &quot;page_index&quot;: 1,    &quot;page_size&quot;: 10,    &quot;total_count&quot;: 50,    &quot;is_more&quot;: 1  &#125;&#125;\n\n\n5ã€é«˜çº§Mock - è„šæœ¬ ï¼ˆä¼˜å…ˆçº§ level-2ï¼‰1ã€ç‰¹ç‚¹è„šæœ¬å¸¦æ¥çš„å¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥å„ç§å®šåˆ¶åŒ–å¤„ç†ï¼Œæ¯”å¦‚è¯´è¯·æ±‚å‚æ•°ï¼Œæ¯”å¦‚è¯´è¯·æ±‚å¤´ç­‰ç­‰ï¼Œæ¯”å¦‚è¯´å„ç§é€»è¾‘åˆ¤æ–­\nè¯·æ±‚\n\nheader è¯·æ±‚çš„ HTTP å¤´\nparams è¯·æ±‚å‚æ•°ï¼ŒåŒ…æ‹¬ Bodyã€Query ä¸­æ‰€æœ‰å‚æ•°\ncookie è¯·æ±‚å¸¦çš„ Cookies\n\nå“åº”\n\nmockJson æ¥å£å®šä¹‰çš„å“åº”æ•°æ® Mock æ¨¡æ¿\nresHeader å“åº”çš„ HTTP å¤´\nhttpCode å“åº”çš„ HTTP çŠ¶æ€ç \ndelay Mock å“åº”å»¶æ—¶ï¼Œå•ä½ä¸º ms\nRandom Mock.Random æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰å ä½ç¬¦,è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹ Wiki\n\n2ã€ä½¿ç”¨åœºæ™¯\nå“åº”ç»“æœéœ€è¦å¯¹äºè¯·æ±‚å‚æ•°æœ‰ä¾èµ–çš„\n\ndemo\nlet data=[]for (let x =0 ; x&lt;100;x++)&#123;    data[x]=&#123;        name:Random.string(),    &#125;&#125;mockJson=&#123;    list: data&#125;\n\n\n2ã€è¯­æ³•ä»‹ç»è‹±æ–‡ï¼ˆä¸­æ–‡å‰ç¼€ä¸ºcï¼Œä¾‹å¦‚cfirstï¼‰åå­—ï¼šRandom.first()\nè‹±æ–‡æ€§ï¼šRandom.last()\nå…¨åå­—ï¼šRandom.name()\néšæœºçš„æ—¶é—´æ“(ms)ï¼šRandom.datetime(â€˜Tâ€™)\néšæœºæ—¥æœŸï¼šRandom.datetime(â€˜yyyy-MM-dd  HH:mm:ssâ€™)\néšæœºæ—¶é—´ï¼šRandom.now(â€˜yyyy-MM-dd HH:mm:ssâ€™)\néšæœºæ–‡æœ¬ï¼šRandom.csentence(length)\néšæœºçš„http-urlï¼š Random.url(â€˜httpâ€™, â€˜nuysoft.comâ€™)\néšæœºçš„ipï¼š Random.ip()\néšæœºçš„emailï¼š Random.email(â€˜nuysoft.comâ€™) ï¼ŒRandom.email()\néšæœºçš„åœ°å€ï¼š éšæœºåŸå¸‚ï¼šRandom.city(true) éšæœºå¿åŸï¼šRandom.county(true) éšæœºçœä»½ï¼šRandom.province()\nUUIDï¼š Random.guid()\néšæœºèº«ä»½è¯ï¼šRandom.id()\néšæœºæ•°ï¼šRandom.range(1, 10, 2)\néšæœºè‹±æ–‡ä¸²ä¸²ï¼šRandom.string( 5 )\néšæœºboolï¼šRandom.bool()\n","categories":["API"],"tags":["yapi","mock"]},{"title":"C++ å…¥é—¨åˆ°æ”¾å¼ƒ","url":"/2023/04/06/fd8e40efcdb71f2be44fb720dc582d67/","content":"C++ç›®å‰åœ¨ä¸€äº›é¢†åŸŸå¤„äºå„æ–­åœ°ä½ï¼Œæ¯”å¦‚æ•°æ®åº“å†…æ ¸ã€é«˜æ€§èƒ½ç½‘ç»œä»£ç†ã€åŸºç¡€è½¯ä»¶è®¾æ–½ ç­‰åŸºæœ¬éƒ½æ˜¯C/C++çš„å„æ–­é¢†åŸŸï¼Œè™½ç„¶å…¶ä»–è¯­è¨€ä¹Ÿæœ‰åœ¨åšï¼Œä½†æ˜¯ç”Ÿæ€ã€æ€§èƒ½ç­‰éƒ½æ— æ³•ä¼åŠï¼Œå…¶æ¬¡C/C++æœ‰ç€ä¸°å¯Œçš„ç”Ÿæ€ï¼Œå¾ˆå¤šé«˜çº§è¯­è¨€ä¹Ÿæä¾›äº†æ¥å£å¯ä»¥å¯¹æ¥C/C++ (JNI/CGOç­‰) ï¼Œè¿™æ ·ä½ å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†ä¸€äº›åº•å±‚C/C++åº“é“¾æ¥åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œé¿å…é€ è½®å­ï¼æœ¬äººå­¦ä¹ C++ç›®çš„æ˜¯ä¸ºäº†çœ‹æ‡‚åˆ«äººçš„ä»£ç ï¼Œå› ä¸ºå¾ˆå¤šä¼˜ç§€çš„é¡¹ç›®éƒ½æ˜¯C++å†™çš„ï¼Œè€Œéæˆ‘ä»äº‹C++ç›¸å…³é¢†åŸŸå¼€å‘ï¼\nä¸ªäººè§‰å¾— C++æ¯”è¾ƒéš¾çš„æ˜¯ å†…å­˜ç®¡ç†  + é¢å‘å¯¹è±¡ + æ¨¡ç‰ˆå…ƒç¼–ç¨‹(Template Metaprogramming) äº†ï¼Œå…¶ä»–å°±æ˜¯åºå¤§ä¸”å¤æ‚çš„è¯­æ³• éœ€è¦å‹¤åŠ ç»ƒä¹ å’Œä½¿ç”¨ï¼ŒC++çµé­‚å°±æ˜¯å†…å­˜ç®¡ç†+æ¨¡ç‰ˆå…ƒç¼–ç¨‹ï¼Œæœ¬æ–‡ä¸»è¦å°±æ˜¯ç‚¹åˆ°ä¸ºæ­¢ï¼å­¦ä¹ è¿‡ç¨‹ä¸­ä½ ä¼šæ„Ÿæ…¨åˆ°C++ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤æ‚ï¼Œç©¶å…¶åŸå› å°±æ˜¯ä¸ºäº†æ€§èƒ½ï¼ˆç¼–è¯‘å™¨è¯´æ”¾äº†æˆ‘å§ï¼‰ï¼Œæ¨¡ç‰ˆå…ƒç¼–ç¨‹ä¸è¡Œå°±æ”¾å¼ƒå§ï¼\næœ¬ç¯‡æ–‡ç« ä¼šé•¿æœŸæ›´æ–°å’Œè¡¥å……ï¼Œè€Œä¸”ç¯‡å¹…è¿‡é•¿ï¼Œæˆ‘å¹³æ—¶å–œæ¬¢æŠŠå­¦ä¹ è¯­è¨€è¯­æ³•ç›¸å…³çš„æ–‡æ¡£å½’ç±»åˆ°ä¸€èµ·ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨ä½“ç§¯è¾ƒå¤§çš„é—®é¢˜ï¼Œæ–¹ä¾¿å¹³æ—¶å½“ä½œå·¥å…·ä¹¦ä½¿ç”¨ï¼\n\n\nå­¦ä¹ ç¯å¢ƒä¸ªäººè§‰å¾—å¦‚æœä½ æ˜¯ä¸€ä¸ªæ–°æ‰‹ï¼Œä¸€å®šè¦é€‰ä¸€ä¸ªåˆ©äºå­¦ä¹ çš„ç¯å¢ƒï¼Œä¸ªäººæ¯”è¾ƒæ¨èæ–°æ‰‹ç”¨ clionï¼å…¶æ¬¡æœ¬æ–‡å…¨éƒ¨éƒ½æ˜¯åŸºäº C++17 èµ°çš„ï¼Œç›®å‰C++ ç‰ˆæœ¬æœ‰ 98ã€11ã€14ã€17ã€20 ï¼ç¼–è¯‘å·¥å…·ç”¨çš„gcc + cmakeï¼Œcamkeå­¦ä¹ æˆæœ¬å¹¶ä¸æ˜¯å¤ªé«˜(bazelå¤æ‚åº¦æœ‰ç‚¹é«˜)ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„æ–‡ç« : cmakeå…¥é—¨ï¼\n\n11 åŸºæœ¬ä¸Šæä¾›äº†å¤§é‡çš„APIå’Œè¯­æ³•ï¼ˆ æ¨¡ç‰ˆ + stl + æ™ºèƒ½æŒ‡é’ˆ ï¼‰\n14ã€17 ä¼˜åŒ–äº†è¯­æ³•å’Œæ–°å¢éƒ¨åˆ†APIï¼Œæ‰€ä»¥å¦‚æœä¸ç”¨c++20æœ€å¥½çš„é€‰æ‹©å°±æ˜¯c++17äº†ï¼\n20 æ”¯æŒäº† coroutine(æ— æ ˆåç¨‹)ã€concept(é¸­å­ç±»å‹)ã€æ¨¡å—(ç›®å‰è¿˜æ²¡å¤§é‡ä½¿ç”¨ï¼Œä¸»è¦æ˜¯è§£å†³ç¼–è¯‘é—®é¢˜)\næ•´ä½“æ¥çœ‹ï¼Œc++20å·²ç»æ˜¯ä¸€ä¸ªå¯ä»¥åª²ç¾rustçš„è¯­è¨€äº†ï¼\n\nå¦‚æœä½ æ˜¯c++å¼€å‘åŒå­¦æœ€å¥½é€‰æ‹©è‡ªå·±å…¬å¸çš„ç¼–è¯‘å·¥å…·å’Œå¼€å‘è§„èŒƒï¼C++è§„èŒƒï¼ŒæŒ‰ç…§å…¬å¸çš„æ¥å³å¯ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥å‚è€ƒGoogleçš„ï¼šhttps://github.com/google/styleguide\nå­¦ä¹ æ–‡æ¡£çš„è¯ï¼Œè¯­æ³•å­¦ä¹ ä»…å»ºè®®å­¦ä¹ å®˜æ–¹æ–‡æ¡£ï¼šhttps://en.cppreference.com/w/cpp/languageï¼Œ åŸå› å°±æ˜¯å†…å®¹æœ€å…¨é¢ã€åˆ†ç±»æœ€å…·ä½“ï¼Œå¦‚æœä½ ä¸œçœ‹è¥¿çœ‹å¯èƒ½æ¦‚å¿µå¾ˆæ¨¡ç³Šï¼æŠ€å·§å­¦ä¹ çš„è¯æˆ‘å»ºè®®å¤šçœ‹çœ‹å¼€æºé¡¹ç›®ï¼Œå…¶æ¬¡å°±æ˜¯çœ‹ä¸€ä¸‹ç»éªŒçš„ä¹¦  Effective c++ å’Œ C++ Template ç¬¬äºŒç‰ˆï¼Œå®è·µæ‰æ˜¯ç¡¬é“ç†ã€‚\nC++çš„è¯­æ³•åº”è¯¥æ˜¯æ²¡æœ‰ä»»ä½•ä¸€ä¸ªè¯­è¨€èƒ½è¶…è¶Šçš„ï¼Œå¤æ‚æ¶å¿ƒï¼Œæ‰€ä»¥æ­»å•ƒä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå•ƒå®Œå°±å¥½äº†ï¼Œæœ€éš¾ç†è§£çš„å°±æ˜¯æ¨¡ç‰ˆå…ƒç¼–ç¨‹ï¼\nä»hello world å¼€å§‹#include &lt;iostream&gt;int main() &#123;    std::cout &lt;&lt; &quot;Hello&quot;              &lt;&lt; &quot; &quot;              &lt;&lt; &quot;World!&quot; &lt;&lt; std::endl;&#125;\n\nä¸æ¸…æ¥šå¤§å®¶å¯¹äºä¸Šé¢ä»£ç æ¯”è¾ƒå¥½å¥‡çš„æ˜¯å“ªé‡Œäº†ï¼Ÿæ¯”å¦‚è¯´æˆ‘å¥½å¥‡çš„æ˜¯ä¸ºå•¥&lt;&lt; å°±å¯ä»¥è¾“å‡ºäº†ï¼Œ ä¸ºå•¥è¿˜å¯ä»¥ &lt;&lt; å®ç° append è¾“å‡ºï¼Ÿ å¯¹ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘çš„ç–‘é—®ï¼\næ€è€ƒä¸€ä¸‹æ˜¯ä¸æ˜¯ç­‰ä»·äºä¸‹é¢è¿™ä¸ªä»£ç äº†ï¼Ÿæ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“ç†è§£äº†å°±ï¼å¯ä»¥æŠŠ operator&lt;&lt; ç†è§£ä¸ºä¸€ä¸ªæ–¹æ³•åï¼ å…·ä½“ç»†èŠ‚ä¸‹æ–‡ä¼šè®²è§£ï¼\n#include &lt;iostream&gt;int main() &#123;    std::operator&lt;&lt;(std::cout,&quot;Hello&quot;).operator&lt;&lt;(&quot; &quot;).operator&lt;&lt;(&quot;World!&quot;).operator&lt;&lt;(std::endl);&#125;\n\nå†…ç½®ç±»å‹æ³¨æ„C++å¾ˆå¤šæ—¶å€™éƒ½æ˜¯è·¨ç«¯å¼€å‘ï¼Œæ‰€ä»¥å…·ä½“åŸºç¡€ç±»å‹å¾—çœ‹ä½ çš„ç³»ç»Ÿç¯å¢ƒï¼Œå¸¸è§çš„åŸºç¡€ç±»å‹ä½ å¯ä»¥ç›´æ¥åœ¨ https://en.cppreference.com/w/cpp/language/types è¿™é‡ŒæŸ¥çœ‹ ï¼\nchar* å’Œ char[] å’Œ std::string\næœ¬å—å†…å®¹å¯ä»¥å…ˆäº†è§£ä¸€éï¼Œçœ‹å®Œæœ¬ç¯‡å†…å®¹å†å›å¤´çœ‹ä¸€ä¸‹ä¼šç†è§£ä¸€äº›ï¼\n\nå­—ç¬¦ä¸²åœ¨ç¼–ç¨‹ä¸­å¤„äºä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ“ä½œï¼Œé‚£ä¹ˆC++ä¸­æä¾›çš„ std::string å’Œ char* åŒºåˆ«åœ¨å‘¢äº†ï¼Ÿ\nç®€å•æ¥è¯´const char* xxx= &quot;å­—é¢é‡&quot; çš„æ€§èƒ½åº”è¯¥æ˜¯æœ€é«˜çš„ï¼Œå› ä¸ºå­—é¢é‡åˆ†é…åœ¨å¸¸é‡åŒºåŸŸï¼Œæ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯æ³¨æ„å¥¥ä¸å¯ä¿®æ”¹çš„ï¼\nchar[]= &quot;å­—é¢é‡&quot; | new char[]&#123;&#125;  åˆ†é…åœ¨æ ˆä¸Šæˆ–è€…å †ä¸Šéå¸¸ä¸å®‰å…¨ï¼Œè¿™ç§éœ€æ±‚ç›´æ¥ç”¨ std::vector æˆ–è€… std::array æ›´å¥½ï¼\nstd::string  åœ¨C++11æœ‰äº†ç§»åŠ¨è¯­æ„åï¼Œæ€§èƒ½å·²ç»åœ¨éƒ¨åˆ†åœºæ™¯ä¼˜åŒ–äº†å¾ˆå¤šï¼Œè¿›è¡Œå­—ç¬¦ä¸²æ“ä½œæ¯”è¾ƒå¤šçš„è¯ä»‹æ„ç”¨è¿™ä¸ªï¼Œåˆ«ä¹±ç”¨std::string* ã€‚ä½¿ç”¨ std::string ä¸€èˆ¬ä¸ä¼šæ¶‰åŠåˆ°å†…å­˜å®‰å…¨é—®é¢˜ï¼Œæ— éå°±æ˜¯å¤šå‡ æ¬¡æ‹·è´ï¼ å¦‚æœç”¨æŒ‡é’ˆæœ€å¥½ä¹Ÿåˆ«ç”¨è£¸æŒ‡é’ˆï¼Œåˆ«çnewï¼Œå¯ä»¥ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œæˆ–è€…å‚æ•°[å¼•ç”¨]ä¼ é€’ï¼\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¯ä»¥å‚è€ƒå­¦ä¹ ï¼\n #include &lt;cstring&gt;#include &lt;iostream&gt;using namespace std;const char* getStackStr() &#123;    char arr[] = &quot;hello world&quot;;    // ä¸èƒ½è¿™ä¹ˆè¿”å›ï¼Œå±äºä¸å®‰å…¨çš„è¡Œä¸ºï¼Œå› ä¸ºarråˆ†é…åœ¨æ ˆä¸Šï¼Œä½ è¿”å›äº†ä¸€ä¸ªæ ˆä¸Šçš„åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°è°ƒç”¨è¿™ä¸ªæ ˆå°±æ¶ˆäº¡äº†ï¼Œæ‰€ä»¥ä¸å®‰å…¨!    return arr;&#125;const char* getConstStr() &#123;    // ä¸ä¼šæœ‰å†…å­˜å®‰å…¨é—®é¢˜ï¼Œå°±æ˜¯æ°¸è¿œæŒ‡å‘å¸¸é‡æ± çš„ä¸€å—å†…å­˜    // å¯¹äºè¿™ç§ä»£ç ï¼Œæˆ‘ä»¬éå¸¸æ¨èç”¨ const char*    const char* arr = &quot;hello world&quot;;    return arr;&#125;const char* getHeapStr() &#123;    // stack åˆ†é…åœ¨æ ˆä¸Š, å°†æ•°æ®æ‹·è´åˆ°è¿”å›å‡½æ•° arrä¸Š!    char stack[] = &quot;hello world&quot;;    char* arr = new char[strlen(stack) + 1]&#123;&#125;;    strcpy(arr, stack);    *arr = &#x27;H&#x27;;    arr[1] = &#x27;E&#x27;;    // arr åˆ†é…åœ¨å †ä¸Šï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªè£¸æŒ‡é’ˆï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸é‡Šæ”¾æœ‰å†…å­˜å®‰å…¨é—®é¢˜    return arr;&#125;// è¿™é‡Œstd::stringç›´æ¥åˆ†é…åœ¨å †ä¸Š, å®ƒçš„å›æ”¶å–å†³äº std::unique_ptr çš„æ¶ˆäº¡, å…·ä½“æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹æ™ºèƒ½æŒ‡é’ˆ// æ³¨æ„: åƒä¸‡åˆ«ç”¨å‡½æ•°è¿”å›ä¸€ä¸ªè£¸æŒ‡é’ˆï¼Œé‚£ä¹ˆå®ƒæ˜¯éå¸¸ä¸å®‰å…¨çš„ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾!std::unique_ptr&lt;std::string&gt; getUniquePtrStr() &#123;    auto str = std::unique_ptr&lt;std::string&gt;(new std::string(&quot;hello world.&quot;));    str-&gt;append(&quot; i am from heap and used unique_ptr.&quot;);    return str;&#125;// æ³¨æ„: è¿™é‡Œè¿”å›çš„strå®é™…ä¸Šè¿›è¡Œäº†ä¸€æ¬¡æ‹·è´ï¼Œå®ç°åœ¨std::stringçš„æ‹·è´æ„é€ å‡½æ•°ä¸Š!std::string getStdStr() &#123;    std::string str = &quot;hello world.&quot;;    str += &quot; i am from stack and used copy constructor.&quot;;    return str;&#125;int main() &#123;    // aæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å¸¸é‡åŒºï¼Œ &quot;hello world&quot; åˆ†é…åœ¨å¸¸é‡åŒºï¼Œå¯¹äºè¿™ç§ç”³æ˜C++11æ¨èç”¨ const æ ‡è®°å‡ºæ¥ï¼Œå› ä¸ºå¸¸é‡åŒºæˆ‘ä»¬ç¨‹åºè¿è¡Œæ—¶æ˜¯æ— æ³•ä¿®æ”¹çš„    char* a = &quot;hello world&quot;;    // bæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å¸¸é‡åŒºï¼Œ&quot;c++&quot; åˆ†é…åœ¨å¸¸é‡åŒº    // å¸¸é‡åŒºç¼–è¯‘å™¨ä¼šä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ a å’Œ b ä¿©äººå§ä»–ä»¬çš„å†…å®¹éƒ½ä¸€æ¨¡ä¸€æ ·ï¼Œé‚£ä¹ˆæ‰€ä»¥å¸¸é‡åªæœ‰ä¸€ä»½    const char* b = &quot;hello world&quot;;    const char* c = &quot;hello world c&quot;;    printf(&quot;%p\\n&quot;, a);    printf(&quot;%p\\n&quot;, b);    printf(&quot;%p\\n&quot;, c);    // arr åˆ†é…åœ¨æ ˆä¸Šï¼Œå½“å‡½æ•°è°ƒç”¨ç»“æŸå°±é”€æ¯äº†ï¼    char arr[] = &quot;1111&quot;;    // ä¹±ç !!!    cout &lt;&lt; getStackStr() &lt;&lt; endl;    // æ­£å¸¸    cout &lt;&lt; getConstStr() &lt;&lt; endl;    // å¸¸é‡æ˜¯ä¸ä¼šé‡å¤åˆ†é…å†…å­˜çš„ï¼Œæ‰€ä»¥ä¸‹é¢3ä¸ªè¾“å‡ºç»“æœæ˜¯ä¸€æ ·çš„!    auto arr1 = getConstStr();    auto arr2 = getConstStr();    printf(&quot;%p\\n&quot;, arr1);    printf(&quot;%p\\n&quot;, arr2);    printf(&quot;%p\\n&quot;, b);    auto arr3 = getHeapStr();    // æ­£å¸¸æ‰“å°    cout &lt;&lt; arr3 &lt;&lt; endl;    // éœ€è¦æ‰‹åŠ¨é‡Šæ”¾    delete[] arr3;    // std::string æ˜¯ä¸€ä¸ªç±»ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå†…å­˜å¼€é”€éå¸¸çš„é«˜ï¼Œè€Œä¸”å¯¹äºå¤§çš„æ•°æ®ä¼šåˆ†é…åœ¨å †ä¸Šæ€§èƒ½ä»¥åŠæ•ˆç‡ä¼šå·®ä¸€äº›!    // è¿™é‡Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯ strçš„copy constructorå‡½æ•°ï¼Œå±äºéšå¼ç±»å‹è½¬æ¢!    std::string str = arr1;    cout &lt;&lt; str &lt;&lt; endl;    printf(&quot;%p\\n&quot;, str.data());    // ä¸šåŠ¡ä¸­å¦‚ä½•ä½¿ç”¨ std::stringäº†ï¼Œæœ€å¥½ä½¿ç”¨std:unique_ptrï¼Œå¯ä»¥å‡å°‘å†…å­˜çš„æ‹·è´!    // c++ ä¸­ä¸€èˆ¬ä¸æ¨èreturnä¸€ä¸ªå¤æ‚çš„æ•°æ®ç»“æ„(å› ä¸ºæ¶‰åŠåˆ°æ‹·è´,    // æˆ–è€…ä½ å°±ç”¨æŒ‡é’ˆï¼Œæˆ–è€…C++11å¼•å…¥äº†ç§»åŠ¨è¯­æ„ï¼Œé™ä½æ‹·è´)ï¼Œè€Œæ˜¯æ¨èé€šè¿‡å‚æ•°æŠŠè¿”å›å˜é‡ä¼ é€’è¿‡å»ï¼Œè¿›è€Œå‡å°‘æ‹·è´!    cout &lt;&lt; *getUniquePtrStr() &lt;&lt; endl;    cout &lt;&lt; getStdStr() &lt;&lt; endl;&#125;\n\næ³¨æ„ç‚¹å…³äº x++ å’Œ ++xé¦–å…ˆå­¦è¿‡Java/Cçš„åŒå­¦éƒ½çŸ¥é“ï¼Œx++ è¿”å›çš„æ˜¯x+1ä¹‹å‰çš„å€¼ï¼Œ ++xè¿”å›çš„æ˜¯x+1åçš„å€¼ï¼ ä»–ä¿©éƒ½å¯ä»¥ä½¿xåŠ 1ï¼Œä½†æ˜¯ä»–ä¿©çš„è¿”å›å€¼ä¸åŒç½¢äº†ï¼\n#include &lt;iostream&gt;using namespace std;// å®ç° x++int xadd(int&amp; x) &#123;    int tmp = x;    x = x + 1;    return tmp;&#125;// å®ç° ++xconst int&amp; addx(int&amp; x) &#123;    x = x + 1;    return x;&#125;int main() &#123;    int x = 10;    //    int tmp = x++;    int tmp = xadd(x);    cout &lt;&lt; &quot;x: &quot; &lt;&lt; x &lt;&lt; &quot;, tmp: &quot; &lt;&lt; tmp &lt;&lt; endl;    // reset    x = 10;    //    tmp = ++x;    tmp = addx(x);    cout &lt;&lt; &quot;x: &quot; &lt;&lt; x &lt;&lt; &quot;, tmp: &quot; &lt;&lt; tmp &lt;&lt; endl;    tmp = tmp + 1;    cout &lt;&lt; &quot;x: &quot; &lt;&lt; x &lt;&lt; &quot;, tmp: &quot; &lt;&lt; tmp &lt;&lt; endl;    // è¾“å‡º:    // x: 11, tmp: 10    // x: 11, tmp: 11    // x: 11, tmp: 12&#125;\n\nå¼•ç”¨ (å·¦å€¼/å³å€¼/ä¸‡èƒ½å¼•ç”¨)å¼•ç”¨æœ¬è´¨ä¸Šå°±æ˜¯æŒ‡é’ˆï¼Œä½†æ˜¯å®ƒè§£å†³äº†ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä»–æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ°å¼•ç”¨çš„æ•ˆæœ ï¼ˆå•è¯´å¼•ç”¨ä¸€èˆ¬æ˜¯æŒ‡çš„å·¦å€¼å¼•ç”¨ï¼‰\n\nvoid inc(int&amp; a, int inc) &#123;    a = a + inc;&#125;using namespace std;int main(int argc, char const* argv[]) &#123;    int a = 1;    inc(a, 10);    cout &lt;&lt; a &lt;&lt; endl;    return 0;&#125;// è¾“å‡ºï¼š// 11\n\n\nå…¶å®ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼ˆincå‡½æ•°ï¼‰å±äºå·¦å€¼å¼•ç”¨ï¼Œä¸ºä»€ä¹ˆå«å·¦å€¼å¼•ç”¨ï¼Œæ˜¯å› ä¸ºå®ƒåªèƒ½å¼•ç”¨ å·¦å€¼ï¼ˆlvalueï¼‰ ï¼Œ ä½ å¯ä»¥ç†è§£ä¸ºå·¦å€¼ æ˜¯ä¸€ä¸ªè¢«å®šä¹‰ç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆå®ƒä¸€å®šå¯ä»¥è¢«å–å€ï¼ˆå› ä¸ºå·¦å¼•ç”¨å¾ˆå¤šç¼–è¯‘å™¨å°±æ˜¯ç”¨çš„æŒ‡é’ˆå»å®ç°çš„ï¼‰ï¼Œ å³å€¼åˆ™ç›¸åï¼Œä¾‹å¦‚å­—é¢é‡ï¼›  å³å€¼åŒ…å«çº¯å³å€¼ï¼ˆprvalueï¼‰å’Œå°†äº¡å€¼ï¼ˆxvalueï¼‰(å°†äº¡å€¼æˆ‘ä¸ªäººç†è§£æ˜¯å¦‚æœæ²¡æœ‰ä½¿ç”¨é‚£ä¹ˆä¸‹ä¸€æ­¥å°±è¢«å›æ”¶äº†ï¼Œç”Ÿå‘½åˆ°è¾¾ç»ˆç‚¹çš„é‚£ç§ï¼)\n\nint x = 10;// x: æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå…¶å†…å­˜åˆ†é…åœ¨æ ˆç©ºé—´ä¸Šï¼Œä¸ºå·¦å€¼ï¼Œæˆ‘å¯ä»¥å–xçš„æŒ‡é’ˆï¼Œé‚£ä¹ˆxæŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯æ ˆä¸Šçš„æŸä¸ªç©ºé—´// 10: æ˜¯ä¸€ä¸ªå­—é¢é‡ï¼Œä¸ºå³å€¼ï¼Œå¦‚æœæ²¡æœ‰xé‚£ä¹ˆå®ƒå°±å’Œè°ä¹Ÿæ²¡å…³ç³»ï¼Œè®¤ä¸ºæ˜¯åƒåœ¾(æ³¨æ„å³å€¼å¼•ç”¨å°±æ˜¯è¦ç”¨åƒåœ¾ï¼Œè®©åƒåœ¾ç”Ÿå‘½å»¶ç»­)\n\n\nä¸‹é¢æ˜¯ä¸€ä¸ªå·¦å€¼(lvalue)/å³å€¼(rvalue)/ä¸‡èƒ½å¼•ç”¨(Universal Reference)åœ¨å®é™…å¼€å‘ä¸­çš„ä¾‹å­\n\n#include &lt;unordered_map&gt;#include &lt;string&gt;#include &lt;iostream&gt;#include &lt;shared_mutex&gt;// æ³¨æ„: -std=c++17template &lt;typename K, typename V&gt;struct SafeMap &#123;public:    // T ä¸ºä¸‡èƒ½å¼•ç”¨(æ³¨æ„: ä¸‡èƒ½å¼•ç”¨ä¼šæ¶‰åŠåˆ°ç±»å‹æ¨æ–­, åŒºåˆ«äºå³å€¼å¼•ç”¨)    // ä¸‡èƒ½å¼•ç”¨ä¸€å®šè¦å’Œstd::forward(ä¸‡èƒ½è½¬å‘)ç»“åˆä½¿ç”¨, ä¸ç„¶æ²¡å•¥æ„ä¹‰    template &lt;class T&gt;    auto Get(T &amp;&amp;key) &#123;        std::shared_lock lock(mutex);        return map[std::forward&lt;T&gt;(key)];    &#125;    // K ä¸ºå³å€¼å¼•ç”¨    bool Exist(K &amp;&amp;key) &#123;        std::shared_lock lock(mutex);        if (const auto &amp;kv = map.find(key); kv == map.end()) &#123;            return false;        &#125;        return true;    &#125;    void Put(K key, const V &amp;value) &#123;        std::unique_lock lock(mutex);        map[key] = value;    &#125;    auto Size() &#123;        std::shared_lock lock(mutex);        return map.size();    &#125;private:    std::unordered_map&lt;K, V&gt; map;    std::shared_mutex mutex;&#125;;template &lt;typename T&gt;using StringSafeMap = SafeMap&lt;std::string, T&gt;;int main() &#123;    std::string key = &quot;1&quot;;    StringSafeMap&lt;int&gt; map;    map.Put(&quot;1&quot;, 1);    std::cout &lt;&lt; map.Get(&quot;1&quot;) &lt;&lt; std::endl; // å³å€¼å¼•ç”¨    std::cout &lt;&lt; map.Get(key) &lt;&lt; std::endl; // å·¦å€¼å¼•ç”¨    // map.Exist(key); // ç¼–è¯‘ä¸è¿‡å»ï¼Œå› ä¸ºæ²¡æœ‰å®šä¹‰å·¦å€¼å¼•ç”¨å‡½æ•°    if (map.Exist(&quot;1&quot;)) &#123;        std::cout &lt;&lt; &quot;exist&quot; &lt;&lt; std::endl;    &#125; else &#123;        std::cout &lt;&lt; &quot;not exist&quot; &lt;&lt; std::endl;    &#125;&#125;\n\næœ‰å…´è¶£çš„å¯ä»¥çœ‹æ–‡ç« :\n\nhttps://paul.pub/cpp-value-category/\nhttps://oi-wiki.org/lang/reference/\nhttps://blog.51cto.com/u_6343747/5464960\n\næ€»ç»“: \n\nå³å€¼å¼•ç”¨å¯ä»¥é™ä½å†…å­˜æ‹·è´ï¼Œä½†æ˜¯éœ€è¦å®ç°ç§»åŠ¨è¯­ä¹‰ï¼\nå¼•ç”¨æœ¬è´¨ä¸Šå°±æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥ä½¿ç”¨å¼•ç”¨ä¸€å®šè¦æ³¨æ„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¨èç”Ÿå‘½å‘¨æœŸæ˜ç¡®å¼•ç”¨ä¼ é€’ï¼Œä¸æ˜ç¡®å€¼ä¼ é€’(å€¼ä¼ é€’å¯ä»¥é€šè¿‡ç§»åŠ¨è¿›è¡Œä¼˜åŒ–æœ¬è´¨ä¸Šå¼€é”€å¹¶ä¸å¤§)ï¼\nå¸¸é‡å·¦å€¼å¼•ç”¨ï¼Œå¯ä¼ é€’å³å€¼ï¼\nä¸‡èƒ½å¼•ç”¨å¯ä»¥å‡å°‘ä»£ç é‡ï¼Œå°¤å…¶æ˜¯å‚æ•°å¤šçš„æƒ…å†µä¸‹ï¼Œä¸‡èƒ½å¼•ç”¨éœ€è¦é…åˆ std::forword ä¸‡èƒ½è½¬å‘ä½¿ç”¨ï¼\n\nç±»çš„åˆå§‹åŒ–å‡½æ•°ç±»çš„åŸºæœ¬çš„æˆå‘˜å‡½æ•°\nè¿™ä¸ªæ˜¯C++ æœ€éš¾çš„åœ°æ–¹ï¼Œæ–°æ‰‹åšåˆ°çŸ¥é“å³å¯ï¼Œä¸å»ºè®®æ·±æŒ–ï¼Œæ— åº•æ´ä¸€ä¸ªï¼Œæ˜¾ç„¶ç¦æ­¢æ‹·è´å’Œç§»åŠ¨æ‰æ˜¯æœ€ä½³é€‰æ‹©ï¼\n\nC++ çš„ç±»ï¼Œæœ€åŸºæœ¬ä¹Ÿä¼šæœ‰å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå°±ç®—ä½ å®šä¹‰äº†ä¸€ä¸ªç©ºçš„ç±»ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¼šæœ‰ï¼ˆå‰æä½ ä½¿ç”¨äº†è¿™äº›æ“ä½œï¼‰ï¼Œå’ŒJavaçš„æœ‰ç‚¹åƒï¼\n\ndefault constructor: é»˜è®¤æ„é€ å‡½æ•°\ncopy constructor: æ‹·è´æ„é€ å‡½æ•° ï¼ˆæ³¨æ„: ç¼–è¯‘å™¨é»˜è®¤ç”Ÿæˆçš„æ‹·è´æ„é€ å‡½æ•°æ˜¯æµ…æ‹·è´ï¼ï¼‰\ncopy assignment constructor:  æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°\ndeconstructor:  ææ„å‡½æ•° ï¼\nC++11å¼•å…¥äº† move constructor ï¼ˆç§»åŠ¨æ„é€ å‡½æ•° ï¼‰  ã€ move assigment constructorï¼ˆç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°ï¼‰ï¼Œä½ ä¸å®šä¹‰æ˜¯ä¸ä¼šç”Ÿæˆçš„ã€‚\n\nä¸‹é¢ä¾‹å­æˆ‘æ˜¯æ ¹æ®æ­¤æ•™ç¨‹å†™çš„ï¼Œå¤§æ¦‚å¯ä»¥è§£é‡Š6ä¸ªå‡½æ•° https://coliru.stacked-crooked.com/a/ae31c28f852e3220\n// g++ -std=c++17 -O0 -Wall main.cpp -o main &amp;&amp; ./main#include &lt;iostream&gt;struct Memory &#123;public:    // æ„é€ å‡½æ•°    explicit Memory(size_t size) : size_(size), data_(new char[size]) &#123;        std::cout &lt;&lt; &quot;Memory constructors&quot; &lt;&lt; std::endl;    &#125;    // ææ„å‡½æ•°    ~Memory() &#123;        clearMemory();        std::cout &lt;&lt; &quot;Memory deconstructors&quot; &lt;&lt; std::endl;    &#125;    // æ‹·è´æ„é€ å‡½æ•°(å°±æ˜¯åˆ›å»ºä¸€ä¸ªbï¼ŒæŠŠaæ‹·è´åˆ°b)    Memory(Memory &amp;from) : size_(from.size_), data_(new char[from.size_]) &#123;        // å‚æ•°: start,end,dst        std::copy(from.data_, from.data_ + from.size_, data_);        std::cout &lt;&lt; &quot;Memory Copy constructors&quot; &lt;&lt; std::endl;    &#125;    // æ‹·è´èµ‹å€¼å‡½æ•°(å°±æ˜¯åšæ‹·è´ï¼ŒæŠŠaæ‹·è´åˆ°b)    Memory &amp;operator=(const Memory &amp;from) &#123;        // å¾ˆå¯èƒ½è‡ªèº«ç§»åŠ¨, è¿™é‡Œä¸€èˆ¬éƒ½éœ€è¦è¿™ä¹ˆå¤„ç†        if (this == &amp;from) &#123;            std::cout &lt;&lt; &quot;Memory Copy assignment constructors (=)&quot; &lt;&lt; std::endl;            return *this;        &#125;        std::cout &lt;&lt; &quot;Memory Copy assignment constructors (!=)&quot; &lt;&lt; std::endl;        // 1. æ¸…ç†è‡ªå·±        clearMemory();        // 2. æ‹·è´        this-&gt;size_ = from.size_;        this-&gt;data_ = new char[from.size_];        std::copy(from.data_, from.data_ + from.size_, data_);        return *this;    &#125;    // ç§»åŠ¨æ„é€ å‡½æ•°    Memory(Memory &amp;&amp;from) noexcept : size_(0), data_(nullptr) &#123;        std::cout &lt;&lt; &quot;Memory Move constructors&quot; &lt;&lt; std::endl;        // https://blog.csdn.net/p942005405/article/details/84644069        // 1. std::move å¼ºåˆ¶å˜æˆäº†å³å€¼        // 2. è°ƒç”¨ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°        *this = std::move(from);    &#125;    // ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°, è¿™äº›å‡½æ•°éœ€è¦ noexcept    Memory &amp;operator=(Memory &amp;&amp;from) noexcept &#123;        if (this == &amp;from) &#123;            std::cout &lt;&lt; &quot;Memory Move Assignment constructors(=)&quot; &lt;&lt; std::endl;            return *this;        &#125;        std::cout &lt;&lt; &quot;Memory Move Assignment constructors(!=)&quot; &lt;&lt; std::endl;        // å…ˆæ¸…ç†è‡ªå·±çš„å†…å­˜        delete[] data_;        // ç§»åŠ¨        data_ = from.data_;        size_ = from.size_;        // æ ‡è®°ç©ºï¼Œé˜²æ­¢ææ„å‡½æ•°å¤±è´¥        from.data_ = nullptr;        from.size_ = 0;        return *this;    &#125;    // è¿™é‡Œæ²¡è®°å½•å†™åç§»é‡ï¼Œæ‰€ä»¥è¿™é‡Œå°±åªæ”¯æŒsetå‡½æ•°äº†.    void Set(const char *data, size_t size) &#123;        if (size &gt; size_) &#123;            size = size_;        &#125;        std::copy(data, data + size, data_);    &#125;    friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;out, Memory &amp;from) &#123;        if (from.data_ == nullptr) &#123;            return out &lt;&lt; &quot;null&quot;;        &#125;        return out &lt;&lt; from.data_;    &#125;private:    void clearMemory() &#123;        if (this-&gt;data_ == nullptr) &#123;            return;        &#125;        delete[] this-&gt;data_; // æ­£å¸¸æ¥è¯´å¦‚æœä¸å­˜åœ¨ç§»åŠ¨å¯ä»¥è¿™ä¹ˆå†™        this-&gt;data_ = nullptr;    &#125;private:    size_t size_&#123;&#125;;    char *data_&#123;&#125;;&#125;;Memory getMemory(bool x) &#123;    if (x) &#123;        Memory mm(16);        mm.Set(&quot;true&quot;, 4);        return mm;    &#125;    Memory mm(16);    mm.Set(&quot;false&quot;, 5);    return mm;&#125;int main() &#123;    Memory memory1(20); // constructor    memory1.Set(&quot;hello world&quot;, 11);    std::cout &lt;&lt; &quot;memory1: &quot; &lt;&lt; memory1 &lt;&lt; std::endl;    Memory memory2 = memory1; // copy constructor (è¿™ä¸ªå±äºç¼–è¯‘å™¨ä¼˜åŒ–äº†, ä¸ç„¶ä½ è¿™ä¸ªä»£ç ä¹Ÿæ‰§è¡Œä¸é€šå“‡ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°, æ‰€ä»¥å·¦å€¼æ˜¯æ— æ³•åˆå§‹åŒ–çš„)    std::cout &lt;&lt; &quot;memory2: &quot; &lt;&lt; memory2 &lt;&lt; std::endl;    Memory memory3(0); // constructor    memory3 = memory2; // copy assignment constructor    std::cout &lt;&lt; &quot;memory3: &quot; &lt;&lt; memory3 &lt;&lt; std::endl;    Memory memory4 = getMemory(true); // move constructor(å¦‚æœæœªå®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œåˆ™ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ç§»åŠ¨æ„é€ å‡½æ•°æ˜¯ä¸ä¼šé»˜è®¤ç”Ÿæˆçš„)    std::cout &lt;&lt; &quot;memory4: &quot; &lt;&lt; memory4 &lt;&lt; std::endl;    memory3 = getMemory(false); // move constructor + move assignment constructor    std::cout &lt;&lt; &quot;memory3: &quot; &lt;&lt; memory3 &lt;&lt; std::endl;    Memory memory5 = std::move(memory3);    std::cout &lt;&lt; &quot;memory3: &quot; &lt;&lt; memory3 &lt;&lt; std::endl;    std::cout &lt;&lt; &quot;memory5: &quot; &lt;&lt; memory5 &lt;&lt; std::endl;    return 0;&#125;\n\næ€»ç»“ï¼šæ‹·è´å¯ä»¥é¿å…å †å†…å­˜éšæ„å¼•ç”¨é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘å®šä¹‰äº†Aå¯¹è±¡ï¼Œæ­¤æ—¶æˆ‘åœ¨Aå¯¹è±¡ä¸Šåˆ†é…äº†10Mç©ºé—´ï¼Œæ­¤æ—¶Bå¯¹è±¡æ‹·è´è‡ªæˆ‘ï¼Œé‚£ä¹ˆæ­¤æ—¶Bå¼•ç”¨äº†Açš„10Må†…å­˜ï¼Œæ­¤æ—¶A/Bå›æ”¶çš„æ—¶å€™åˆ°åº•è¦æ¸…ç†Aè¿˜æ˜¯Bçš„10Må†…å­˜äº†ï¼Ÿ ç¬¬äºŒä¸ªå°±æ˜¯ç§»åŠ¨è§£å†³çš„é—®é¢˜ï¼Œå¯¹äºä¸€äº›å³å€¼å¯èƒ½ä¼šå­˜åœ¨å†—ä½™æ‹·è´çš„é—®é¢˜ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ç§»åŠ¨ä¼˜åŒ–å†…å­˜æ‹·è´ã€‚ æœ¬è´¨ä¸Šè¿™äº›æ„é€ å‡½æ•°éƒ½æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜å†…å­˜åˆ†é…ï¼ï¼\nåˆå§‹åŒ–åˆ—è¡¨è¿™é‡Œæˆ‘ä»¬è¦çŸ¥é“ä¸€ç‚¹å°±æ˜¯ C++ ç±»çš„åˆå§‹åŒ–å†…ç½®ç±»å‹(builtin type)æ˜¯ä¸ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸º0çš„ï¼Œä½†æ˜¯ç±»ç±»å‹(éæŒ‡é’ˆç±»å‹)çš„è¯å´ä¼šè‡ªåŠ¨è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œå…·ä½“ä¸ºå•¥äº†ï¼Œå…¼å®¹Cï¼Œä¸ç„¶ä¼šå¾ˆæ…¢ï¼Œå› ä¸ºå‡å¦‚ä½ è¦åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œä¾‹å¦‚å®šä¹‰äº†10ä¸ªå†…ç½®ç±»å‹çš„å­—æ®µï¼Œæˆ‘éœ€è¦10æ¬¡èµ‹å€¼è°ƒç”¨æ‰èƒ½æŠŠ10ä¸ªå­—æ®µåˆå§‹åŒ–æˆ0ï¼Œè€Œä¸åˆå§‹åŒ–åªéœ€è¦å¼€è¾Ÿå›ºå®šçš„å†…å­˜ç©ºé—´å³å¯ï¼Œå¯ä»¥å¤§å¤§æé«˜ä»£ç è¿è¡Œæ•ˆç‡ï¼\n\nå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯æ¨èä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨çš„ï¼\n\n#include &lt;iostream&gt;// struct Info&#123;//     int id;//     long salary;// &#125;;using namespace std;class Demo &#123;  public:    int id;    Demo() &#123;        cout &lt;&lt; &quot;init demo&quot; &lt;&lt; endl;    &#125;&#125;;class Info &#123;  public:    int id;    long salary;    Demo wrapper;&#125;;int main() &#123;    // æœªä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨    Info info;    cout &lt;&lt; info.id &lt;&lt; endl;    cout &lt;&lt; info.wrapper.id &lt;&lt; endl;    int x;    cout &lt;&lt; x &lt;&lt; endl;    Info* infop;    cout &lt;&lt; infop &lt;&lt; endl;    // ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨    cout &lt;&lt; &quot;======= C++11 åˆå§‹åŒ–åˆ—è¡¨ &quot; &lt;&lt; endl;    Info info1&#123;&#125;;    cout &lt;&lt; info1.id &lt;&lt; endl;    cout &lt;&lt; info1.wrapper.id &lt;&lt; endl;    int x1&#123;&#125;;    cout &lt;&lt; x1 &lt;&lt; endl;    Info* infop1&#123;&#125;;    cout &lt;&lt; infop1 &lt;&lt; endl;&#125;// è¾“å‡º// init demo// 185313075// 88051808// 32759// 0x10b11c010// ======= C++11 åˆå§‹åŒ–åˆ—è¡¨// init demo// 0// 0// 0// 0x0\n\nç±»çš„åˆå§‹åŒ–åˆ—è¡¨ï¼š\n\n https://www.cnblogs.com/graphics/archive/2010/07/04/1770900.html\nhttps://en.cppreference.com/w/cpp/language/value_initialization\n\nç±»çš„åˆå§‹åŒ–å†™æ³•C++11 å°±ä¸‹é¢è¿™ä¸‰ç§å†™æ³•\n\n( expression-list ) å°æ‹¬å·æ‹¬èµ·æ¥çš„è¡¨è¾¾å¼åˆ—è¡¨\n= expression    è¡¨è¾¾å¼\n&#123; initializer-list &#125;   å¤§æ‹¬å·æ‹¬èµ·æ¥çš„è¡¨è¾¾å¼åˆ—è¡¨ï¼ŒC++11æ¯”è¾ƒæ¨èè¿™ç§å†™æ³•\n\nç„¶åè¿™ä¸‰ç§å†™æ³•å¤§é¢˜åˆ†ä¸ºäº†å‡ å¤§ç±»ï¼Œè¿™å‡ å¤§ç±»ä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†å§ï¼Œæˆ‘ä¸ªäººè§‰å¾—å°±æ˜¯è¯­æ³•ä¸Šçš„å½’ç±»ï¼Œä¸»è¦æ˜¯cppå†å²åŒ…è¢±å¤ªé‡äº†ï¼Œå…¶æ¬¡è¿½æ±‚é«˜æ€§èƒ½ï¼Œè¿›è€Œåˆ†ç±»äº†å¾ˆå¤šåˆå§‹åŒ–å†™æ³•ï¼Œå…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š https://en.cppreference.com/w/cpp/language/initialization ï¼\nç±»çš„å¤šæ€\nå‰æœŸå…ˆæŒæ¡åŸºæœ¬è¯­æ³•å§ï¼Œå®é™…ç”¨åˆ°çš„æ—¶å€™å†æ·±å…¥å­¦ä¹ ï¼Œç±»çš„ç»§æ‰¿åœ¨C++ä¸­ç‰¹åˆ«å¤æ‚ï¼Œå› ä¸ºä¼šæ¶‰åŠåˆ°æ¨¡ç‰ˆã€ç±»å‹è½¬æ¢ã€è™šå‡½æ•°ã€ææ„å‡½æ•°ï¼Œæ³¨æ„äº‹é¡¹éå¸¸å¤šï¼\n\nç»§æ‰¿c++çš„ç»§æ‰¿éå¸¸å¤æ‚ï¼Œåº•å±‚è®¾è®¡ä»¥åŠå„ç§ç»†èŠ‚ï¼Œæ‰€ä»¥æˆ‘å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« ï¼š C++ç»§æ‰¿çš„åº•å±‚è®¾è®¡\n\nåŸºç±» base class ï¼ŒåŸºç±»éœ€è¦æŠŠææ„å‡½æ•°è®¾ç½®ä¸ºè™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±» derived classï¼ŒåŸºç±» å’Œ æ´¾ç”Ÿç±»æ˜¯ç›¸å¯¹å…³ç³»\nä¸‰ç§ç»§æ‰¿æ–¹å¼: \n\n\npublic: åŸºç±»çš„ public å’Œ protected æˆå‘˜çš„è®¿é—®å±æ€§åœ¨æ´¾ç”Ÿç±»ä¸­ä¿æŒä¸å˜(ä¼ é€’æ€§)ï¼Œä½†åŸºç±»çš„ private æˆå‘˜ä¸å¯ç›´æ¥è®¿é—®\nprotect: åŸºç±»çš„ public å’Œ protected æˆå‘˜éƒ½ä»¥ protected èº«ä»½å‡ºç°åœ¨æ´¾ç”Ÿç±»ä¸­(ä¼ é€’æ€§)ï¼Œä½†åŸºç±»çš„ private æˆå‘˜ä¸å¯ç›´æ¥è®¿é—®\nprivate: åŸºç±»çš„ public å’Œ protected æˆå‘˜éƒ½ä»¥ private èº«ä»½å‡ºç°åœ¨æ´¾ç”Ÿç±»ä¸­(ä¼ é€’æ€§)ï¼Œä½†åŸºç±»çš„ private æˆå‘˜ä¸å¯ç›´æ¥è®¿é—®\næ€»ç»“: \npublic ä¸€åŠ³æ°¸é€¸ï¼Œprotectã€private çš„è¯ä¼šä¿®æ”¹åŸºç±»çš„è®¿é—®å±æ€§ã€‚ä¸šåŠ¡ä¸­ä¸€èˆ¬ç”¨publicï¼Œä¸æƒ³å¯¹å¤–æš´éœ²åŸºç±»é™¤å¤–\nstruct é»˜è®¤ç»§æ‰¿æ˜¯public , class é»˜è®¤ç»§æ‰¿æ˜¯private\nå¤šå†™å†™ä»£ç å°è¯•ä¸‹ï¼Œå°±è¡Œäº†\n\n\n\n\nä½¿ç”¨è™šç»§æ‰¿å¯ä»¥é™ä½å†…å­˜å¼€é”€ï¼Œè§£å†³å¤šç»§æ‰¿çš„äºŒä¹‰æ€§é—®é¢˜\nå…·ä½“ä¾‹å­å¯ä»¥çœ‹ï¼š\n\n\n https://godbolt.org/z/TEEsYra7f  \nhttps://godbolt.org/z/rxeza5EEa\n\noverride ã€final\noverrideï¼ˆé‡å†™ï¼‰ å’Œ  overloadï¼ˆé‡è½½ï¼‰ åŒºåˆ«åœ¨äº override æ˜¯ç»§æ‰¿å¼•å…¥çš„æ¦‚å¿µï¼\n\nè¿™ä¿©ä¿®é¥°è¯ä¸»è¦æ˜¯è§£å†³ç»§æ‰¿ä¸­é‡å†™çš„é—®é¢˜ï¼\n\nç±»è¢«ä¿®é¥°ä¸º final \n\nclass A final &#123;   public:    void func() &#123; cout &lt;&lt; &quot;æˆ‘ä¸æƒ³è¢«ç»§æ‰¿&quot; &lt;&lt; endl; &#125;;&#125;;class B : A &#123; // è¿™é‡Œä¼šè¢«ç¼–è¯‘æŠ¥é”™ï¼Œè¯´Aæ— æ³•è¢«ç»§æ‰¿ï¼    &#125;;\n\n\næ–¹æ³•è¢«ä¿®é¥°ä¸º final\n\nclass A &#123;   public:    virtual void func() final &#123; cout &lt;&lt; &quot;æˆ‘ä¸æƒ³è¢«ç»§æ‰¿&quot; &lt;&lt; endl; &#125;; // ç”³æ˜æˆ‘è¿™ä¸ªå‡½æ•°æ— æ³•è¢«ç»§æ‰¿ï¼Œæ³¨æ„: finalåªèƒ½ä¿®é¥°virtualå‡½æ•°&#125;;class B : A &#123;  public:    void func(); // è¿™é‡Œç¼–è¯‘æŠ¥é”™ï¼Œæ— æ³•é‡å†™çˆ¶ç±»æ–¹æ³•&#125;;\n\n\næ–¹æ³•ä¿®é¥°ä¸º override \n\nclass A &#123;&#125;;class B : A &#123;    void func() override; // è¿™é‡Œç¼–è¯‘æŠ¥é”™ï¼Œé‡å†™éœ€è¦çˆ¶ç±»æœ‰å®šä¹‰ï¼&#125;;\n\nprotectedpublic å’Œ privateå…¶å®æ²¡å¤šå¿…è¦ä»‹ç»ï¼Œ ä½†æ˜¯æ¶‰åŠåˆ°ç»§æ‰¿ï¼Œä»…å…è®¸æˆ‘çš„å­ç±»è®¿é—®é‚£ä¹ˆå°±éœ€è¦protectedå…³é”®è¯äº†ï¼ŒåŒºåˆ«äºJavaçš„protected.\nfriendfriend ï¼ˆå‹å…ƒï¼‰è¡¨ç¤ºå¤–éƒ¨æ–¹æ³•å¯ä»¥è®¿é—®æˆ‘çš„private/protectedå˜é‡ï¼Œ æ­£å¸¸æ¥è¯´æˆ‘å®šä¹‰ä¸€ä¸ªä¸€äº›ç§æœ‰çš„æˆå‘˜å˜é‡ï¼Œå¤–éƒ¨å‡½æ•°è°ƒç”¨çš„è¯ï¼Œæ˜¯è®¿é—®ä¸äº†çš„ï¼Œä½†æ˜¯å‹å…ƒå‡½æ•°å¯ä»¥ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªcaseï¼š\n#include &lt;iostream&gt;class Data &#123;    friend std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, const Data&amp; c);   private:    int id&#123;&#125;;    std::string name;&#125;;std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, const Data&amp; c) &#123;    os &lt;&lt; &quot;(Id=&quot; &lt;&lt; c.id &lt;&lt; &quot;,Name=&quot; &lt;&lt; c.name &lt;&lt; &quot;)&quot;;    return os;&#125;int main() &#123;    std::cout &lt;&lt; Data&#123;&#125; &lt;&lt; std::endl;  // è¿™é‡Œä¼šæ¶‰åŠåˆ°è¿ç®—ç¬¦é‡è½½çš„ä¸€äº›ç»†èŠ‚ï¼Œå…·ä½“å¯ä»¥çœ‹æœ¬ç¯‡æ–‡ç« !&#125;\n\næŒ‡é’ˆçš„ä¸€äº›ç»†èŠ‚æ³¨æ„ï¼šåˆ«çnewæŒ‡é’ˆ,  newäº†åœ°æ–¹è¦ä¹ˆç”¨æ™ºèƒ½æŒ‡é’ˆè‡ªåŠ¨å›æ”¶ï¼Œè¦ä¹ˆç”¨deleteæ‰‹åŠ¨å›æ”¶ï¼ æ‰‹åŠ¨newçš„ä¸€å®šä¼šåˆ†é…åœ¨å †ä¸Šï¼Œæ‰€ä»¥æ€§èƒ½æœ¬èº«å°±ä¸é«˜ï¼Œæ¨èç”¨æ™ºèƒ½æŒ‡é’ˆ + raiiï¼\nä»€ä¹ˆå«æŒ‡é’ˆï¼Œä½ å¯ä»¥ç†è§£ä¸ºå°±æ˜¯ä¸€ä¸ªlongç±»å‹çš„å€¼ï¼Œä½†æ˜¯å‘¢è¿™ä¸ªlongç±»å‹çš„å€¼æ˜¯ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œä½ å¯ä»¥é€šè¿‡æ“ä½œè¿™ä¸ªå†…å­˜åœ°å€è¿›è¡Œ è·å–å€¼ï¼ˆå› ä¸ºæŒ‡é’ˆæ˜¯æœ‰ç±»å‹çš„ï¼‰ï¼Œä¿®æ”¹å†…å­˜ç­‰æ“ä½œï¼\nåœ¨C/C++ è¯­è¨€ä¸­ï¼Œè¡¨ç¤ºæŒ‡é’ˆå¾ˆç®€å•ï¼Œä¾‹å¦‚ int*  ptr  è¡¨ç¤ºptræ˜¯ä¸€ä¸ªintç±»å‹çš„æŒ‡é’ˆ æˆ–è€…  ä¸€ä¸ªintç±»å‹çš„æ•°ç»„ï¼c++ åˆ¤æ–­æŒ‡é’ˆä¸ºç©ºç”¨ nullptr !\nint main() &#123;    // æ ˆæ˜¯ é«˜åœ°å€-&gt;ä½åœ°å€ èµ°äº†    // x,yéƒ½æ˜¯åˆ†é…åœ¨æ ˆä¸Š    int x = 1;    int y = 2;    // æŒ‡é’ˆå°±æ˜¯ä¸€ä¸ªlongç±»å‹çš„å€¼    long yp = (long)(&amp;y);    // ç”±äºä»–åœ¨æ ˆä¸Šåˆ†é…ï¼Œæ‰€ä»¥ä¸éœ€è¦è½¬æ¢ä¸€æ¬¡äº†ï¼Œç›´æ¥+-å°±å¯ä»¥æŒªåŠ¨å†…å­˜äº†ï¼Œæœ€ååœ¨ç»™ä»–è½¬æ¢æˆçœŸæ˜¯çš„æŒ‡é’ˆç±»å‹    int *xp = (int *)((yp) + 4);    *xp = 100;    std::cout &lt;&lt; x &lt;&lt; std::endl;&#125;// è¾“å‡º 100\n\nä¾‹å­1: æ•°ç»„ä¸æŒ‡é’ˆC++/C ä¸­æ•°ç»„å’ŒæŒ‡é’ˆæœ€å¥‡å¦™ï¼ŒåŸå› æ˜¯ æ•°ç»„ å’Œ æŒ‡é’ˆ åŸºæœ¬æ¦‚å¿µç­‰ä»·ï¼Œå› ä¸ºä¸¤è€…éƒ½æ˜¯æŒ‡å‘å†…å­˜çš„é¦–åœ°å€ï¼ŒåŒºåˆ«åœ¨äºæ•°ç»„åå®šä¹‰äº†æ•°ç»„çš„é•¿åº¦ï¼Œä½†æ˜¯æŒ‡é’ˆæ²¡æœ‰æ•°ç»„é•¿åº¦çš„æ¦‚å¿µï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é€šè¿‡ä¸€ä¸ªæŒ‡é’ˆè·å–æ•°ç»„é•¿åº¦ï¼\nç±»ä¼¼äºä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œ arr æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œp1ã€p2æ˜¯ä¸€ä¸ªæ•°ç»„æŒ‡é’ˆ\nint main(int argc, char const* argv[]) &#123;    int arr[] = &#123;1, 2, 3, 4, 5&#125;;    int* p1 = arr;    int* p2 = &amp;arr[0];    cout &lt;&lt; &quot;sizeof(arr)=&quot; &lt;&lt; sizeof(arr) &lt;&lt; &quot;, sizeof(arr[1])=&quot; &lt;&lt; sizeof(arr[1]) &lt;&lt; &quot;, sizeof(p1)=&quot; &lt;&lt; sizeof(p1) &lt;&lt; &quot;, sizeof(p2)=&quot; &lt;&lt; sizeof(p2) &lt;&lt; endl;    cout &lt;&lt; &quot;arr len=&quot; &lt;&lt; sizeof(arr) / sizeof(arr[0]) &lt;&lt; endl;    cout &lt;&lt; &quot;arr=&quot; &lt;&lt; arr &lt;&lt; &quot;, p1=&quot; &lt;&lt; p1 &lt;&lt; &quot;, p2=&quot; &lt;&lt; p2 &lt;&lt; endl;    for (int i = 0; i &lt; 5; i++) &#123;        cout &lt;&lt; &quot;i=&quot; &lt;&lt; i &lt;&lt; &quot;, (arr+i)=&quot; &lt;&lt; arr + i &lt;&lt; &quot;, (p1+i)=&quot; &lt;&lt; p1 + i &lt;&lt; &quot;, arr[i]=&quot; &lt;&lt; arr[i] &lt;&lt; &quot;, *(p1+i)=&quot; &lt;&lt; *(p1 + i) &lt;&lt; endl;    &#125;    return 0;&#125;\n\nè¾“å‡º\nsizeof(arr)=20, sizeof(arr[1])=4, sizeof(p1)=8, sizeof(p2)=8arr len=5arr=0x7ff7bd9999f0, p1=0x7ff7bd9999f0, p2=0x7ff7bd9999f0i=0, (arr+i)=0x7ff7bd9999f0, (p1+i)=0x7ff7bd9999f0, arr[i]=1, *(p1+i)=1i=1, (arr+i)=0x7ff7bd9999f4, (p1+i)=0x7ff7bd9999f4, arr[i]=2, *(p1+i)=2i=2, (arr+i)=0x7ff7bd9999f8, (p1+i)=0x7ff7bd9999f8, arr[i]=3, *(p1+i)=3i=3, (arr+i)=0x7ff7bd9999fc, (p1+i)=0x7ff7bd9999fc, arr[i]=4, *(p1+i)=4i=4, (arr+i)=0x7ff7bd999a00, (p1+i)=0x7ff7bd999a00, arr[i]=5, *(p1+i)=5\n\nç»“è®º:\n\næ•°ç»„ã€æ•°ç»„æŒ‡é’ˆå…¶å®éƒ½æ˜¯ æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¯¹åº”çš„å†…å­˜åœ°å€ï¼ˆæŒ‡é’ˆï¼‰\næ•°ç»„+1 å’Œ æŒ‡é’ˆ+1 ï¼Œå…¶å®ä¸æ˜¯ç®€å•çš„int+1çš„æ“ä½œï¼Œè€Œæ˜¯åç§»äº†ç±»å‹çš„é•¿åº¦ï¼ŒåŸå› æ˜¯ æŒ‡é’ˆæ˜¯æœ‰ç±»å‹çš„ï¼Œä¸”æŒ‡é’ˆé»˜è®¤é‡è½½äº† + è¿ç®—ç¬¦ï¼\næ•°ç»„æ˜¯å¯ä»¥è·å–æ•°ç»„çš„é•¿åº¦çš„ï¼Œä½†æ˜¯æ•°ç»„æŒ‡é’ˆä¸å¯ä»¥ï¼\n\næ³¨æ„ï¼š\n\næ•°ç»„delete å’Œ delete[] éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸º delete[]ä¸new[] æˆå¯¹å‡ºç°ï¼Œä»¥åŠ deleteå’Œnewæˆå¯¹å‡ºç°\n\nä¾‹å­2: æ•°ç»„é•¿åº¦é€šå¸¸ï¼Œæˆ‘ä»¬ä¸å¯èƒ½åœ¨mainå‡½æ•°é‡Œå†™ä»£ç ï¼Œæ˜¯ä¸æ˜¯ï¼Œæˆ‘ä»¬æ›´å¤šéƒ½æ˜¯å‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Ÿ å‡½æ•°è°ƒç”¨å¦‚ä½•å®‰å…¨çš„æ“ä½œå‘¢ï¼Ÿ\nint* get_array() &#123;    int* arr = new int[12];    for (int i = 0; i &lt; 12; i++) &#123;        *(arr + i) = i + 1;    &#125;    return arr;&#125;int main(int argc, char const* argv[]) &#123;    int* arr = get_array();    for (int i = 0; i &lt; 12; i++) &#123; // è¿™é‡Œæ— æ³•è·å–æ•°ç»„æŒ‡é’ˆ arr çš„é•¿åº¦        cout &lt;&lt; *(arr + i) &lt;&lt; endl;    &#125;    return 0;&#125;\n\né—®é¢˜ï¼š å¦‚ä½•è·å–arrçš„é•¿åº¦çš„å‘¢ï¼Ÿ æ˜¾ç„¶æ˜¯ä¸å¯ä»¥è·å–çš„ï¼\nä¾‹å­3: å¸¸é‡æŒ‡é’ˆ\nå¸¸é‡æŒ‡é’ˆ(Constant Pointer)ï¼Œè¡¨ç¤ºçš„æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼ˆå†…å®¹ï¼‰ä¸å¯ä»¥ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´ *p ä¸å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯ p å¯ä»¥ä¿®æ”¹\n\nint const* p; // const ä¿®é¥°çš„æ˜¯ *pï¼Œ *pä¸å¯ä»¥å˜ï¼ˆæŒ‡å‘çš„å†…å®¹ï¼‰ï¼Œä½†æ˜¯på¯ä»¥å˜const int* p; // å†™æ³•ä¸Šæ²¡å•¥åŒºåˆ«, éƒ½ä¿®é¥°çš„æ˜¯ *p, æˆ‘æ¯”è¾ƒæ¨èè¿™ç§å†™æ³•\n\nä¾‹å­\nint main(int argc, char const* argv[]) &#123;    using namespace std;    int x = 10;    int* p2 = new int;    const int* p = &amp;x;    // *p = 10; // ä¸å…è®¸æ”¹å˜ æŒ‡é’ˆæŒ‡å‘çš„å€¼    p = p2; // å…è®¸    cout &lt;&lt; &quot;p: &quot; &lt;&lt; *p &lt;&lt; endl;    return 0;&#125;// è¾“å‡º:// p: 0\n\n\næŒ‡é’ˆå¸¸é‡(pointer to a constantï¼šæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆ)ï¼Œè¡¨ç¤º p ä¸å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯ *p å¯ä»¥ä¿®æ”¹\n\nint* const p\n\nä¾‹å­\nint main(int argc, char const* argv[]) &#123;    using namespace std;    int x = 10;    int* p2 = new int;    int* const p = &amp;x;    *p = 20; // å…è®¸æ”¹å˜ æŒ‡é’ˆæŒ‡å‘çš„å€¼    // p = p2; // ä¸å…è®¸    cout &lt;&lt; &quot;p: &quot; &lt;&lt; *p &lt;&lt; endl;    return 0;&#125;// è¾“å‡º// p: 20\n\n\næŒ‡å‘å¸¸é‡çš„å¸¸é‡æŒ‡é’ˆ\n\nconst int* const p; // å®ƒå…¼å®¹äº†ä¸¤è€…çš„å…¨éƒ¨ä¼˜ç‚¹ï¼\n\n\næ€»ç»“\n\nå¤§éƒ¨åˆ†caseéƒ½æ˜¯ä½¿ç”¨å¸¸é‡æŒ‡é’ˆï¼Œå› ä¸ºæŒ‡é’ˆä¼ é€’æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„ç›®çš„æ˜¯ä¸è®©æŒ‡é’ˆå»æ“ä½œå†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨ å¸¸é‡æŒ‡é’ˆï¼Œå¯¹ä¸æŒ‡é’ˆæœ¬èº«æ¥è¯´å°±æ˜¯ä¸€ä¸ª64ä½çš„intå®ƒå˜ä¸ä¸å˜ä½ ä¸ç”¨ç®¡ï¼ \nè¡¥å……ä¸€äº›å°ç‚¹\næŒ‡é’ˆåˆ°åº•å†™åœ¨ ç±»å‹ä¸Šå¥½ int* pï¼Œè¿˜æ˜¯å˜é‡ä¸Šå¥½ int *p,  æ²¡æœ‰æ­£ç¡®ç­”æ¡ˆï¼Œæˆ‘æ˜¯å†™Goçš„æ‰€ä»¥ä¹ æƒ¯å†™åˆ°ç±»å‹ä¸Šï¼å…·ä½“å¯ä»¥çœ‹ https://www.zhihu.com/question/52305847?rf=21136956\næŒ‡å‘æˆå‘˜çš„æŒ‡é’ˆè¿ç®—ç¬¦: (æ¯”è¾ƒéš¾ç†è§£ï¼Œä¸ªäººæ„Ÿè§‰å®é™…ä¸Šå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªæŒ‡é’ˆ alies )\n .* å’Œ -&gt;*\n::*\n\n\n\næ™ºèƒ½æŒ‡é’ˆåœ¨C++11ä¸­å­˜åœ¨å››ç§æ™ºèƒ½æŒ‡é’ˆï¼šstd::auto_ptrï¼Œstd::unique_ptrï¼Œstd::shared_ptrï¼Œ std::weak_ptrï¼Œ\nauto_ptr : c++98 ä¸­æä¾›äº†ï¼Œç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨äº†\nunique_ptr: è¿™ä¸ªå¯¹è±¡æ²¡æœ‰å®ç°æ‹·è´æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨çš„æ—¶å€™åªèƒ½ç”¨ std::move è¿›è¡Œç§»åŠ¨èµ‹å€¼ ï¼Œç»å¸¸ä½¿ç”¨ï¼\nshared_ptr: å…¶å®ç±»ä¼¼äºGCè¯­è¨€çš„å¯¹è±¡ï¼Œä»–é€šè¿‡å¼•ç”¨è®¡æ•°ã€å¾ªç¯å¼•ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ã€‘ï¼Œå®ç°è‡ªåŠ¨å›æ”¶ï¼Œç»å¸¸ä½¿ç”¨å§ï¼\nweak_ptr: æœ¬è´¨ä¸Šå°±æ˜¯è§£å†³ shared_ptr å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå®ƒæŒæœ‰ shared_ptrï¼Œä½†æ˜¯ä¸ä¼šä½¿å¾—shared_ptrå¼•ç”¨è®¡æ•°å¢åŠ ï¼Œå¾ˆå°‘ä½¿ç”¨å§ï¼\nc++14æ–°å¢äº†make_unique   çš„apiï¼Œè¿™é‡Œçš„åŸç†ä¼šæ¶‰åŠåˆ° std::move  å’Œ std::forward å‡½æ•°ç›¸å…³çŸ¥è¯†ï¼Œ æœ‰å…´è¶£å¯ä»¥äº†è§£ä¸‹ å®Œç¾è½¬å‘å’Œä¸‡èƒ½å¼•ç”¨ï¼Œä»¥åŠç§»åŠ¨è¯­æ„ï¼\nstd::unique_ptrclass Test &#123;   public:    explicit Test(int x_) : x(x_) &#123;&#125;    ~Test() &#123;        std::cout &lt;&lt; &quot;release: &quot; &lt;&lt; x &lt;&lt; std::endl;    &#125;   public:    int x;&#125;;Test* newTestFunc(int x) &#123;    return new Test(x);&#125;int main() &#123;    std::unique_ptr&lt;Test&gt; test1 = std::unique_ptr&lt;Test&gt;(new Test(1));    // unique_ptråªæœ‰ç§»åŠ¨è¯­æ„ï¼Œæ²¡æœ‰æ‹·è´è¯­ä¹‰    auto test2 = std::move(test1);    std::cout &lt;&lt; &quot;test1 is null ptr: &quot; &lt;&lt; (test1 == nullptr) &lt;&lt; std::endl;    std::cout &lt;&lt; &quot;test2.x: &quot; &lt;&lt; test2-&gt;x &lt;&lt; std::endl;    // reset ä¼šå…ˆé‡Šæ”¾åŸæ¥æŒ‡é’ˆï¼Œç„¶åå†èµ‹å€¼    test2.reset(new Test(2));    // é‡Šæ”¾å¼•ç”¨, ä¾‹å¦‚ç†è®ºä¸Š test2 ä¼šåœ¨mainå‡½æ•°ç»“æŸåä¼šé‡Šæ”¾ï¼Œä½†æ˜¯æˆ‘å…¶å®æƒ³è¦è¿™ä¸ªå†…å®¹ï¼Œæˆ‘è‡ªå·±ç®¡ç†ï¼Œå°±å¯ä»¥ç”¨ release å‡½æ•°é‡Šæ”¾æŒ‡é’ˆ    Test* test2_ = test2.release();    std::cout &lt;&lt; &quot;test2_-&gt;x: &quot; &lt;&lt; test2_-&gt;x &lt;&lt; std::endl;    delete test2_;    // ä¸æ¨èè¿™ä¹ˆå†™ï¼Œè¿™æ ·è£¸æŒ‡é’ˆå¾ˆå±é™©ï¼Œä¹Ÿå®¹æ˜“å¿˜è®°é‡Šæ”¾.//    Test* test3 = newTestFunc(3);      // æ¨èä½¿ç”¨æ™ºèƒ½åŒ…è£…ä¸€å±‚    auto test = std::unique_ptr&lt;Test&gt;(newTestFunc(3));&#125;\n\nstd::shared_ptrshared_ptr å®é™…ä¸ŠåŸºæœ¬å·²ç»å¯¹æ ‡ä¸»æµçš„åƒåœ¾å›æ”¶è¯­è¨€äº†ï¼Œå®ƒä½¿ç”¨å¼•ç”¨è®¡æ•°çš„æ–¹å¼å®ç°äº†åƒåœ¾å›æ”¶ï¼\nshared_ptr ä¼šå­˜å‚¨ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨+æŒ‡é’ˆï¼Œæ¯æ¬¡æ‹·è´éƒ½ä¼šä½¿å¾—è®¡æ•°å™¨+1ç„¶åå†æ‹·è´æ•°æ®ï¼Œå½“è°ƒç”¨ææ„å‡½æ•°(æˆ–è€… resetå‡½æ•°)çš„æ—¶å€™ä¼šä½¿å¾—è®¡æ•°å™¨-1ï¼›å½“ä¸º0çš„æ—¶å€™ä¼šç›´æ¥ä¼šå»é‡Šæ”¾æŒ‡é’ˆï¼æ‰€ä»¥åŸç†å¹¶ä¸å¤æ‚å§ï¼\nstruct AStruct;struct BStruct;struct AStruct &#123;    std::shared_ptr&lt;BStruct&gt; bPtr;    ~AStruct() &#123; std::cout &lt;&lt; &quot;AStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;struct BStruct &#123;    int Num;    ~BStruct() &#123; std::cout &lt;&lt; &quot;BStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;void setAB(const std::shared_ptr&lt;AStruct&gt; &amp;ap) &#123;    std::shared_ptr&lt;BStruct&gt; bp(new BStruct&#123;&#125;);    std::cout &lt;&lt; &quot;bp-&gt;count[0]: &quot; &lt;&lt; bp.use_count() &lt;&lt; std::endl; // 1    bp-&gt;Num = 111;    ap-&gt;bPtr = bp;    std::cout &lt;&lt; &quot;bp-&gt;count[1]: &quot; &lt;&lt; bp.use_count() &lt;&lt; std::endl;         // 2    std::cout &lt;&lt; &quot;bp-&gt;count[1.1]: &quot; &lt;&lt; ap-&gt;bPtr.use_count() &lt;&lt; std::endl; // 2    // defer: bpé‡Šæ”¾ count=1, æœªè§¦å‘å›æ”¶;&#125;void Test() &#123;    std::shared_ptr&lt;AStruct&gt; ap(new AStruct&#123;&#125;);    setAB(ap);    std::cout &lt;&lt; ap-&gt;bPtr-&gt;Num &lt;&lt; std::endl;    std::cout &lt;&lt; &quot;bp-&gt;count[2]: &quot; &lt;&lt; ap-&gt;bPtr.use_count() &lt;&lt; std::endl; // 1    // defer ap é‡Šæ”¾ -&gt; bpé‡Šæ”¾å bp.count=0 é‡Šæ”¾bp!&#125;int main() &#123;    Test();&#125;\n\nä½†æ˜¯è¿™ä¸ªä¹Ÿæ³¨å®šæœ‰ä¸€ä¸ªé™·é˜±ï¼Œå°±æ˜¯å¾ªç¯å¼•ç”¨æ— æ³•è§£å†³ï¼\nstruct AStruct;struct BStruct;struct AStruct &#123;    std::shared_ptr&lt;BStruct&gt; bPtr;    ~AStruct() &#123; std::cout &lt;&lt; &quot;AStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;struct BStruct &#123;    std::shared_ptr&lt;AStruct&gt; aPtr;    ~BStruct() &#123; std::cout &lt;&lt; &quot;BStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;void TestLoopReference() &#123;    std::shared_ptr&lt;AStruct&gt; ap(new AStruct&#123;&#125;);    std::shared_ptr&lt;BStruct&gt; bp(new BStruct&#123;&#125;);    ap-&gt;bPtr = bp;    bp-&gt;aPtr = ap;  // æ— æ³•é‡Šæ”¾ ap å’Œ bp&#125;int main() &#123;    TestLoopReference();&#125;\n\nstd::weak_ptrweak_ptr æœ¬è´¨ä¸Šå¹¶ä¸èƒ½ç®—çš„ä¸Šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œåªèƒ½è¯´æ˜¯ä¸ºäº†è§£å†³ shared_ptr å¾ªç¯å¼•ç”¨çš„é—®é¢˜ [ä¸èƒ½æ ¹æœ¬è§£å†³]ï¼Œweak_ptrç›¸å½“äºæ‹·è´äº†ä¸€ä»½ shared_ptrï¼Œ ä½†æ˜¯å¼•ç”¨æ¬¡æ•°å¹¶ä¸ä¼šå¢åŠ ï¼Œä¸ºæ­¤å‡å¦‚ shared_ptr å·²ç»è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆweak_pträ¹Ÿä¼šæŒ‡å‘ç©ºæŒ‡é’ˆï¼\nstruct AStruct;struct BStruct;struct AStruct &#123;    std::weak_ptr&lt;BStruct&gt; bPtr;    ~AStruct() &#123; std::cout &lt;&lt; &quot;AStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;struct BStruct &#123;    std::weak_ptr&lt;AStruct&gt; aPtr;    int Num;    ~BStruct() &#123; std::cout &lt;&lt; &quot;BStruct is deleted!&quot; &lt;&lt; std::endl; &#125;&#125;;void TestLoopReference() &#123;    std::shared_ptr&lt;AStruct&gt; ap(new AStruct&#123;&#125;);    std::shared_ptr&lt;BStruct&gt; bp(new BStruct&#123;&#125;);    bp-&gt;Num = 1;    // weak ptr æœ¬èº«å°±æ˜¯å¼±å¼•ç”¨ï¼Œæ­¤æ—¶åªæ˜¯åªè¦ap/bpç”Ÿå‘½å‘¨æœŸ(ä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°æ²¡æ‰§è¡Œç»“æŸ)æ²¡ç»“æŸå°±ä¸€ç›´å¯ä»¥ä½¿ç”¨!    ap-&gt;bPtr = bp;    bp-&gt;aPtr = ap;    std::cout &lt;&lt; &quot;BStruct.Num: &quot; &lt;&lt; ap-&gt;bPtr.lock()-&gt;Num &lt;&lt; std::endl;&#125;int main() &#123;    TestLoopReference();&#125;\n\næ™ºèƒ½æŒ‡é’ˆå’Œæ•°ç»„\né’ˆå¯¹äºæ•°ç»„æŒ‡é’ˆ, éœ€è¦è‡ªå·±å®šä¹‰deleteå‡½æ•°  https://coliru.stacked-crooked.com/a/83d4d163afb6cdd8\né’ˆå¯¹äºæ•°ç»„ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†  https://coliru.stacked-crooked.com/a/b3e9c0103382fe3b\n\n#include &lt;memory&gt;int main() &#123;    // æ•°ç»„    std::shared_ptr&lt;Int[]&gt; data&#123;&#125;;    data.reset(new Int[10]);    // æ•°ç»„æŒ‡é’ˆ    std::shared_ptr&lt;Int&gt; data2&#123;&#125;;    data.reset(new Int[10], [](auto p) &#123;        delete[] p; // é¦–åœ°å€çš„å‰8å­—èŠ‚(64ä½)åœ°å€å°±æ˜¯æ•°ç»„é•¿åº¦ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤æˆåŠŸ    &#125;);      // å‘ç°ä¸ªå¾ˆç¥å¥‡çš„åœ°æ–¹ï¼Œåˆ é™¤æ•°ç»„æ˜¯ä»å°¾åˆ°é¦–éƒ¨åˆ é™¤...&#125;\n\nå†…å­˜å›æ”¶çš„ä¸€äº›æ€è€ƒ\nè™½ç„¶C++ä¸­æä¾›äº† raii å’Œ æ™ºèƒ½æŒ‡é’ˆï¼Œä½†æ˜¯å†…å­˜çš„é¢‘ç¹åˆ†é…å’Œé¢‘ç¹é”€æ¯ï¼Œä¼šç»™cpué€ æˆä¸€äº›å¼€é”€(æ€§èƒ½æ…¢ã€å»¶æ—¶é«˜ç­‰)ï¼Œé‚£ä¹ˆä¸šåŠ¡ä¸­ç»å¸¸é‡åˆ°é‚£ç§å·¨å‹ç»“æ„è¿›è¡Œåºåˆ—åŒ–ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆä¸šå†…ä¹Ÿæœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨ arena ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ\n\n\nhttps://protobuf.dev/reference/cpp/arenas/\nhttps://github.com/protocolbuffers/protobuf/issues/4327\n\nå…³é”®è¯constC++çš„ const è¡¨è¾¾çš„æ„æ€æ˜¯åªè¯»çš„æ„æ€ï¼Œå°±æ˜¯ä¸å¯å˜çš„æ„æ€ï¼\n\nè¿™é‡Œä¸»è¦æ˜¯ä»‹ç»ä¸€ä¸ªåŒé‡æŒ‡é’ˆï¼Œå…¶ä»–ç–‘é—®å¯ä»¥çœ‹è¿™ä¸ªé“¾æ¥: https://www.zhihu.com/question/433076446ï¼\n\n#include &lt;iostream&gt;void foo1() &#123;    using namespace std;    int* x = new int(10);    int* const* p = &amp;x; // è¡¨ç¤º*pæ˜¯å¸¸é‡    cout &lt;&lt; **p &lt;&lt; endl;    **p = 100; // **på…è®¸ä¿®æ”¹    cout &lt;&lt; **p &lt;&lt; endl;    // *p = x2; // *pä¸å…è®¸ä¿®æ”¹!&#125;void foo2() &#123;    using namespace std;    const int* x = new int(10);    const int** p = &amp;x; // è¡¨ç¤º**pæ˜¯å¸¸é‡, å› ä¸ºå®ƒä¹Ÿä¸éœ€è¦è¦ç”¨å¸¸é‡*xåˆå§‹åŒ–, ä¸ç„¶ç¼–è¯‘æŠ¥é”™!    cout &lt;&lt; **p &lt;&lt; endl;    *p = new int(11); // *på¯ä»¥ä¿®æ”¹    cout &lt;&lt; **p &lt;&lt; endl;    // **p = 10; // **pä¸å¯ä»¥ä¿®æ”¹&#125;int main() &#123;    foo1();    foo2();&#125;\n\n\nconst å¯ä»¥ä¿®é¥°æ–¹æ³•çš„è¿”å›å€¼\n\nconst char* getString() &#123; return &quot;hello&quot;; &#125;int main() &#123;    auto str = getString();    *(str + 1) = &#x27;a&#x27;;  // è¿™é‡Œç¼–è¯‘æŠ¥é”™ï¼Œåªè¯» str    return 0;&#125;\n\n\nconst ä¿®é¥°æ–¹æ³•çš„å‚æ•°\n\nvoid printStr(const char* str) &#123; cout &lt;&lt; str &lt;&lt; endl; &#125; // è¿™é‡Œæ— æ³•ä¿®æ”¹strint main() &#123;    printStr(&quot;1111&quot;);    return 0;&#125;\n\n\nconst ä¿®é¥°æ–¹æ³•ï¼Œ è¡¨ç¤ºæ­¤æ–¹æ³•æ˜¯ä¸€ä¸ªåªè¯»çš„å‡½æ•°\n\nclass F &#123;   private:    int a;   public:    void foo() const &#123; this-&gt;a = 1; &#125; // ç¼–è¯‘æŠ¥é”™ï¼Œæ— æ³•ä¿®æ”¹ this-&gt;a !&#125;;\n\nconstexprconstexpr å¸¸é‡è¡¨è¾¾å¼ï¼Œå°±æ˜¯å®ƒå¯ä»¥åœ¨ç¼–è¯‘åç›´æ¥æ›¿æ¢ä¸ºè®¡ç®—æ‰€å¾—çš„å€¼ï¼å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œç›´æ¥è®¡ç®—å‡º fib(6) çš„å€¼ç›´æ¥èµ‹å€¼ç»™äº†esi (å‚æ•°ä¸€) ï¼\n\nconstexpr ç›®å‰å·²ç»æ˜¯éå¸¸æˆç†Ÿçš„èƒ½åŠ›äº†ï¼Œä½†æ˜¯å®ƒä¼šç»™ç¼–è¯‘å™¨å¸¦æ¥æ¯”è¾ƒå¤§çš„å‹åŠ›ï¼\nC++11ï¼šä»…æ”¯æŒç®€å•çš„å¸¸é‡è¡¨è¾¾å¼\nC++14ï¼šæ”¯æŒé€»è¾‘è¯­å¥\nC++17ï¼šæ”¯æŒLambda\nå‚è€ƒæ–‡ç« \n\nhttps://zhxilin.github.io/post/tech_stack/1_programming_language/modern_cpp/cpp17/constexpr/\nhttps://en.cppreference.com/w/cpp/language/constexpr\n\nè¯´å®è¯ï¼Œä¸€å †èŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ä½ å¾ˆéš¾ç†è§£å®ƒçš„å®é™…ç”¨é€”ï¼Œåƒä¸Šé¢è¿™ç§å¸¸é‡è¡¨è¾¾å¼è®¡ç®—ï¼Œäººå®¶ç¼–è¯‘å™¨å¯èƒ½ç›´æ¥ç»™ä½ ä¼˜åŒ–äº†ï¼Œå®Œå…¨ä¸éœ€è¦ä½ ç”³æ˜ consteptr\nä¸»è¦å®ç”¨çš„ç”¨é€”å°±æ˜¯ï¼š\n\nè®©ç¼–è¯‘å™¨æå‰ä¼˜åŒ–ä»£ç ï¼ˆæå‰çš„æ„æ€è¡¨ç¤ºå¯èƒ½æœªæ¥ç¼–è¯‘å™¨å°±ä¼˜åŒ–äº†ï¼‰ï¼Œç±»ä¼¼äºä¸Šé¢é‚£ä¸ªçº¯ç²¹çš„è®¡ç®—å‡½æ•°\n\nç¼–è¯‘æ—¶æœŸè¿›è¡Œ static_assertï¼Œè¿›è¡Œä¸€äº›ç±»å‹ã€å¸¸é‡æ£€æµ‹ \n\nç¼–è¯‘å™¨è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå‡å°‘ä»£ç é‡ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªä¾‹å­å¯ä»¥ç”¨ cpp17çš„ fold expression\n\n\ntemplate&lt;typename T, typename ... Args&gt;constexpr void print(T t, Args ... args) &#123;    std::cout &lt;&lt; t &lt;&lt; &quot; &quot;;    if constexpr (sizeof...(args) &gt; 0) &#123;        print(args ...);    &#125;    if constexpr (sizeof...(args) == 0) &#123;        std::cout &lt;&lt; &quot;\\n&quot;;    &#125;&#125;int main()&#123;  print(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;);&#125;\n\n\næ¨¡ç‰ˆå…ƒç¼–ç¨‹: å¤ªè¿‡äºå¼ºå¤§ï¼Œæ­¤å¤„ä¸å»ºè®®å­¦ä¹ \n\nstaticstatic ä¸»è¦æ˜¯å†…å­˜åˆ†é…çš„é—®é¢˜ï¼Œåœ¨ç¨‹åºåˆå§‹åŒ–é˜¶æ®µä¼šæœ‰ä¸€ä¸ªé™æ€å†…å­˜åŒºåŸŸä¸“é—¨å­˜å‚¨é™æ€å˜é‡çš„ï¼Œå…¶æ¬¡é™æ€å±€éƒ¨å˜é‡å¯ä»¥ä¿è¯å¤šçº¿ç¨‹å®‰å…¨ï¼ˆc++11åï¼‰ï¼\n\næ³¨æ„: c++ä¸­staticå®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ä¼šè¢«åˆå§‹åŒ–å¤šæ¬¡ï¼Œä¸è¦åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å…¨å±€staticå˜é‡ï¼Œåˆ«è¯¯ä»¥ä¸ºæ˜¯staticä½œç”¨åŸŸå¤±æ•ˆäº†ï¼\n\n\nå…¨å±€ é™æ€å˜é‡ã€é™æ€æ–¹æ³•\n\n\né™æ€æˆå‘˜å˜é‡å¯ä»¥åˆå§‹åŒ–ï¼Œä½†åªèƒ½åœ¨ç±»ä½“å¤–è¿›è¡Œåˆå§‹åŒ–\n\n// main.h#include &lt;fmt/core.h&gt;namespace example &#123;static int NumberX = 100;static int NumberY = 200;static int NumberZ = NumberY + 300;static void print() &#123;    fmt::print(&quot;x: &#123;&#125;, y: &#123;&#125;, z: &#123;&#125;\\n&quot;, NumberX, NumberY, NumberZ);&#125;class Class &#123;public:    static void print();    static const int x;    static int y;    static int z;&#125;;&#125; // namespace example// main.cpp#include &lt;fmt/core.h&gt;const int example::Class::x = 1;int example::Class::y = z + 2;int example::Class::z = 2;void example::Class::print() &#123;    fmt::print(&quot;x: &#123;&#125;, y: &#123;&#125;, z: &#123;&#125;&quot;, x, y, z);&#125;int main() &#123;    example::print();    example::Class::print();&#125;// output:// x: 100, y: 200, z: 500// x: 1, y: 4, z: 2\n\n\nå…¨å±€é™æ€æ–¹æ³•å’Œé™æ€å˜é‡\n\n#include &lt;iostream&gt;int inc() &#123;    static int sum = 0;    return ++sum;&#125;int main(int argc, char const* argv[]) &#123;    std::cout &lt;&lt; inc() &lt;&lt; std::endl;    std::cout &lt;&lt; inc() &lt;&lt; std::endl;    return 0;&#125;// è¾“å‡º:// 1// 2\n\n\næ¨¡ç‰ˆçš„é™æ€å˜é‡\n\nclass A &#123;public:    static int num;&#125;;int A::num = 100;class B : public A &#123;&#125;;class C : public A &#123;&#125;;template &lt;class T&gt;class AA &#123;public:    static int num;&#125;;template &lt;class T&gt;int AA&lt;T&gt;::num = 1;class BB : public AA&lt;BB&gt; &#123;&#125;;class CC : public AA&lt;CC&gt; &#123;&#125;;int main() &#123;    printf(&quot;%p\\n&quot;, &amp;B::num);    printf(&quot;%p\\n&quot;, &amp;C::num);    printf(&quot;%p\\n&quot;, &amp;BB::num);    printf(&quot;%p\\n&quot;, &amp;CC::num);&#125;// output:// 0x10f2c5030// 0x10f2c5030// 0x10f2c5034// 0x10f2c5038\n\n\nå†™ä¸€ä¸ªå•ä¾‹å¯¹è±¡\n\n#include &lt;absl/base/call_once.h&gt;#include &lt;fmt/core.h&gt;template &lt;class T&gt;class ThreadSafeSingleton &#123;public:    static T &amp;get() &#123;        absl::call_once(ThreadSafeSingleton&lt;T&gt;::create_once_, &amp;ThreadSafeSingleton&lt;T&gt;::Create);        return *ThreadSafeSingleton&lt;T&gt;::instance_;    &#125;protected:    static void Create() &#123; instance_ = new T(); &#125;    static absl::once_flag create_once_;    static T *instance_;&#125;;template &lt;class T&gt;absl::once_flag ThreadSafeSingleton&lt;T&gt;::create_once_;template &lt;class T&gt;T *ThreadSafeSingleton&lt;T&gt;::instance_ = nullptr;// C++ 11 å¯ä»¥è¿™ä¹ˆå†™ï¼Œå› ä¸ºstaticçº¿ç¨‹å®‰å…¨template &lt;class T&gt;class ConstSingleton &#123;public:    static T &amp;get() &#123;        static T *t = new T();        return *t;    &#125;&#125;;struct ExampleStruct &#123;    std::string name;&#125;;using ExampleStructSingleton = ThreadSafeSingleton&lt;ExampleStruct&gt;;using ExampleStructConstSingleton = ConstSingleton&lt;ExampleStruct&gt;;int main() &#123;    ExampleStructSingleton::get().name = &quot;hello world&quot;;    fmt::print(&quot;name = &#123;&#125;\\n&quot;, ExampleStructSingleton::get().name);    ExampleStructConstSingleton::get().name = &quot;hello world&quot;;    fmt::print(&quot;name = &#123;&#125;\\n&quot;, ExampleStructConstSingleton::get().name);&#125;\n\nextern\n extern C  ä¸»è¦æ˜¯è§£å†³C++ -&gt; C é“¾æ¥æ–¹å¼ä¸å¾—åŒï¼Œä»¥åŠCä¸C++å‡½æ•°äº’ç›¸è°ƒç”¨çš„é—®é¢˜\nå…¶ä»–å¾…è¡¥å……ï¼\n\nauto å’Œ decltype\n çœ‹è¿™é‡Œä¹‹å‰å»ºè®®å…ˆå­¦ä¹ æ¨¡ç‰ˆ\n\nauto å®é™…ä¸Šæ˜¯å¤§éƒ¨åˆ†é«˜çº§è¯­è¨€ç°åœ¨éƒ½æœ‰çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯ç±»å‹æ¨æ–­ï¼Œc++11å¼•å…¥auto åŸå› ä¹Ÿæ˜¯å› ä¸ºæ¨¡ç‰ˆ, å…¶æ¬¡æ›´åŠ æ–¹ä¾¿ï¼\ndecltype æœ¬è´¨ä¸Šä¹Ÿæ˜¯ç±»å‹æ¨æ–­ï¼Œä½†æ˜¯å®ƒä¸ auto æ˜¯ä¿©åœºæ™¯ï¼Œè§£å†³ä¸åŒçš„åœºæ™¯çš„é—®é¢˜ï¼Œéå¸¸å¥½ç”¨ï¼Œdecltypeå¹¶ä¸ä¼šçœŸæ­£çš„è°ƒç”¨å‡½æ•°ï¼Œåªæ˜¯è·å–å‡½æ•°çš„ç±»å‹ï¼Œéå¸¸å¥½ç”¨ï¼Œå°¤å…¶æ˜¯é¢å¯¹å¤æ‚æ¨¡ç‰ˆçš„æ—¶å€™ï¼\ntemplate &lt;typename T, typename U&gt;auto add(T t, U u) -&gt; decltype(t + u) &#123; // è¿”å›ç±»å‹çš„åç½®å†™æ³•!    using Sum = decltype(t + u);    Sum s = t + u;    s = s + 1;    return s;&#125;int main() &#123;    auto num = add(float(1.1), int(1));    cout &lt;&lt; num &lt;&lt; endl;    return 0;&#125;\n\nä¸Šé¢ä»£ç ï¼Œå¦‚æœæ²¡æœ‰ decltype å¾ˆéš¾å»å®ç°ï¼Œå¦‚æœä»…ç”¨æ¨¡ç‰ˆæ ¹æœ¬æ— æ³•æ¨æ–­å‡ºåˆ°åº•è¿”å›ç±»å‹æ˜¯å•¥ï¼Œå¯èƒ½æ˜¯int ä¹Ÿå¯èƒ½æ˜¯ float ï¼\næ³¨æ„: \n\ndecltype æœ€éš¾çš„åœ°æ–¹è¿˜æ˜¯åœ¨äºå®ƒä¿ç•™äº† å·¦å€¼/å³å€¼ä¿¡æ¯ï¼Œè¿™ä¸ªå°±ç»™ç¼–ç¨‹å¸¦æ¥äº†ä¸€å®šçš„éš¾åº¦ï¼\nc++14 æœ‰æ›´ç²¾ç®€çš„è¯­æ³•ï¼Œå…·ä½“å¯ä»¥çœ‹c++14è¯­æ³•\n\nusing å’Œ typedef\nçœ‹è¿™é‡Œä¹‹å‰å…ˆå­¦ä¹ æ¨¡ç‰ˆ\n\nè™½ç„¶å¤§éƒ¨åˆ†caseä¸¤è€…å·®è·ä¸å¤§ï¼Œusing è¿™é‡Œä¸»è¦è§£å†³äº†ä¸€äº›case è¯­æ³•è¿‡äºå¤æ‚çš„é—®é¢˜ï¼\nä¾‹å¦‚ typedef æ— æ³•è§£å†³æ¨¡ç‰ˆçš„é—®é¢˜ï¼Œåªèƒ½ä¾èµ–äºç±»æ¨¡ç‰ˆå»å®ç°ï¼\nusing æ›´åŠ æ–¹ä¾¿ï¼\n#include &lt;iostream&gt;#include &lt;list&gt;template &lt;typename T, template &lt;typename&gt; class MyAlloc = std::allocator&gt;using MyAllocList = std::list&lt;T, MyAlloc&lt;T&gt;&gt;;int main() &#123;    auto my_list = MyAllocList&lt;int&gt;&#123;1, 2, 3, 4&#125;;    for (auto item : my_list) &#123;        cout &lt;&lt; item &lt;&lt; endl;    &#125;    return 0;&#125;\n\nå¦‚æœç”¨typedef æˆ‘ä»¬åªèƒ½å®šä¹‰ä¸€ä¸ª ç±»\n#include &lt;iostream&gt;#include &lt;list&gt;template &lt;typename T, template &lt;typename&gt; class MyAlloc = std::allocator&gt;struct MyAllocList2 &#123;   public:    typedef std::list&lt;T, MyAlloc&lt;T&gt;&gt; type;&#125;;int main() &#123;    auto my_list_2 = MyAllocList2&lt;int&gt;::type&#123;1, 2, 3, 4&#125;;    return 0;&#125;\n\nswitch &amp; breakå…¶å®æˆ‘è¿™é‡Œå°±æƒ³è¯´ä¸€ç‚¹ï¼Œå°±æ˜¯switchå½“åŒ¹é…åˆ°caseåï¼Œå¦‚æœcaseæ²¡æœ‰æ‰§è¡Œbreakï¼Œä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„caseï¼Œå·²ç»ä¸ç®¡caseæ˜¯å¦åŒ¹é…äº†ï¼ï¼\n#include &lt;iostream&gt;int main() &#123;    int x = 2;    switch (x) &#123;        case 1: &#123;            std::cout &lt;&lt; &quot;1&quot; &lt;&lt; std::endl;        &#125;        case 2: &#123;            std::cout &lt;&lt; &quot;2&quot; &lt;&lt; std::endl;        &#125;        case 3: &#123;            std::cout &lt;&lt; &quot;3&quot; &lt;&lt; std::endl;        &#125;    &#125;&#125;// output// 2// 3\n\nbreakç”¨æ³•\n#include &lt;iostream&gt;int main() &#123;    int x = 2;    switch (x) &#123;        case 1: &#123;            std::cout &lt;&lt; &quot;1&quot; &lt;&lt; std::endl;        &#125;        case 2: &#123;            std::cout &lt;&lt; &quot;2&quot; &lt;&lt; std::endl;        &#125;            break;        case 3: &#123;            std::cout &lt;&lt; &quot;3&quot; &lt;&lt; std::endl;        &#125;    &#125;&#125;// è¾“å‡ºï¼š// 2\n\ntypenameC++ ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ä¸ª typename å…³é”®è¯ï¼Œä¸å…‰å…‰æ˜¯ç”³æ˜ä¸€ä¸ª æ¨¡ç‰ˆå‚æ•°åˆ—è¡¨ è¿™ä¹ˆç®€å•ï¼Œå…¶æ¬¡æ›´é‡è¦çš„æ˜¯ç”³æ˜æ¨¡ç‰ˆä¾èµ–(dependency)ï¼Œéœ€è¦é…åˆ template å…³é”®è¯ä½¿ç”¨ï¼åœ¨æ¨¡ç‰ˆå…ƒç¼–ç¨‹ä¸­å¤§é‡ä½¿ç”¨ï¼\næ¯”è¾ƒæ„Ÿå…´è¶£çš„ä¸¤ä¸ªè¯é¢˜ï¼š\n\nhttps://stackoverflow.com/questions/610245/where-and-why-do-i-have-to-put-the-template-and-typename-keywords/613132#613132\n\nhttps://pages.cs.wisc.edu/~driscoll/typename.html\n\n\ntypenameå’Œclassæœ‰ç€ç›¸åŒçš„èƒ½åŠ›åœ¨æ¨¡ç‰ˆè¿™é‡Œï¼Œä½†æ˜¯typenameæ›´å¤šçš„æ˜¯ä¸ºäº†æ”¯æŒæ¨¡ç‰ˆï¼\n#include &lt;spdlog/spdlog.h&gt;struct Test &#123;    std::string name;&#125;;template &lt;&gt;struct fmt::formatter&lt;Test&gt; : fmt::formatter&lt;std::string&gt; &#123;    static auto format(const Test &amp;my, fmt::format_context &amp;ctx) -&gt; decltype(ctx.out()) &#123;        return format_to(ctx.out(), &quot;[test name=&#123;&#125;]&quot;, my.name);    &#125;&#125;;template &lt;typename T&gt;constexpr auto has_const_formatter(T t) -&gt; decltype(typename fmt::formatter&lt;T&gt;().format(std::declval&lt;const T &amp;&gt;(), std::declval&lt;fmt::format_context &amp;&gt;()), true) &#123;    return true;&#125;int main()&#123;  std::cout &lt;&lt; has_const_formatter&lt;&gt;(Test&#123;&#125;) &lt;&lt; std::endl;&#125;\n\næ“ä½œç¬¦é‡è½½(è¿ç®—ç¬¦é‡è½½)æœ¬è´¨ä¸Šæ“ä½œç¬¦é‡è½½å°±æ˜¯å¯ä»¥ç†è§£ä¸ºæ–¹æ³•çš„é‡è½½ï¼Œå’Œæ™®é€šæ–¹æ³•æ²¡å•¥å·®åˆ«ï¼ä½†æ˜¯C++æ”¯æŒå°†ä¸€äº› ä¸€å…ƒ/äºŒå…ƒ/ä¸‰å…ƒçš„è¿ç®—ç¬¦è¿›è¡Œé‡è½½ï¼\nå®é™…ä¸Šè¿ç®—ç¬¦é‡è½½æ˜¯æ”¯æŒ ç±»å†…é‡è½½ã€ç±»å¤–é‡è½½çš„ï¼Œä¸¤è€…æ˜¯ç­‰ä»·çš„ï¼ä½†æ˜¯æœ‰äº›è¿ç®—ç¬¦å¿…é¡»è¦ç±»å†…é‡è½½ï¼Œä¾‹å¦‚ = ã€[]ã€()ã€-&gt; ç­‰è¿ç®—ç¬¦å¿…é¡»ç±»å†…é‡è½½ï¼\nè¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥ ostream  çš„ &lt;&lt;ä»…ä»…é‡è½½äº†éƒ¨åˆ†ç±»å‹ï¼Œå°±å¯ä»¥å®ç°è¾“å‡ºä»»æ„ç±»å‹äº†ï¼ˆåªè¦ä½ å®ç°äº†é‡è½½ï¼‰ï¼Œæœ‰åˆ«äºä¸€äº›å…¶ä»–è¯­è¨€çš„å®ç°äº†ï¼Œä¾‹å¦‚Javaä¾èµ–äºObject#ToStringç»§æ‰¿ï¼ŒGoä¾èµ–äºæ¥å£å®ç°ç­‰ï¼è¿ç®—ç¬¦é‡è½½çš„å¥½å¤„åœ¨äºç¼–è¯‘å™¨å°±å¯ä»¥åšåˆ°æ£€æµ‹ï¼\n#include &lt;iostream&gt;using namespace std;class Complex &#123;  private:    int re, im;  public:    Complex(int re, int im) : re(re), im(im) &#123;    &#125;    // è¯­æ³•å°±æ˜¯ type operator&lt;operator-symbol&gt;(parameter-list)    Complex operator+(const Complex&amp; other) &#123;        return Complex(this-&gt;re + other.re, this-&gt;im + other.im);    &#125;    void print() &#123;        cout &lt;&lt; &quot;re: &quot; &lt;&lt; re &lt;&lt; &quot;, im: &quot; &lt;&lt; im &lt;&lt; endl;    &#125;&#125;;int main(int argc, char const* argv[]) &#123;    Complex a = Complex(1, 1);    Complex b = Complex(2, 2);    Complex c = a + b;    c.print();    return 0;&#125;// è¾“å‡º:// re: 3, im: 3\n\nlambdaé¦–å…ˆlambda å…¶å®åœ¨å‡½æ•°å¼ç¼–ç¨‹å¾ˆå¸¸è§ï¼Œä½†å®é™…ä¸Šæˆ‘ä¸ªäººè¿˜æ˜¯ä¸ç†è§£ï¼Œå¦‚æœä¸ºäº†æ›´çŸ­çš„ä»£ç ï¼Œæˆ‘è§‰å¾—æ¯«æ— æ„ä¹‰ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ç½¢äº†ï¼Œæœ¬è´¨ä¸ŠC++çš„Lambdaå°±æ˜¯è¯­æ³•ç³–ï¼Œç¼–è¯‘åä¼šå‘ç°å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŒ¿åçš„ä»¿å‡½æ•°ï¼\né‚£ä¹ˆä»€ä¹ˆæ‰æ˜¯lambdaï¼Ÿæˆ‘è§‰å¾—å‡½æ•°å¼ç¼–ç¨‹ï¼Œä¸€ä¸ªå¾ˆå¼ºçš„æ¦‚å¿µå°±æ˜¯(anywhere define function)ä»»æ„åœ°æ–¹éƒ½å¯ä»¥å®šä¹‰å‡½æ•°ï¼Œä¾‹å¦‚æˆ‘ç°åœ¨ç»å¸¸å†™Goï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘éœ€è¦ç”¨åˆ°æŸä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å‘¢è¿™ä¸ªä½œç”¨èŒƒå›´æˆ‘ä¸æƒ³æ”¾åˆ°å¤–é¢ï¼Œå› ä¸ºå¤–é¢ä¹Ÿç”¨ä¸åˆ°ã€‚å› æ­¤åˆ†ä¸ºäº†ç«‹å³æ‰§è¡Œå‡½æ•°å’Œå˜é‡å‡½æ•°\ntype Demo struct &#123;\tName *string&#125;func foo() &#123;\tnewDemo := func(v string) *Demo &#123; // newDemoå˜é‡ æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹\t\treturn &amp;Demo&#123;\t\t\tName: func(v string) *string &#123;\t\t\t\tif v == &quot;&quot; &#123;\t\t\t\t\treturn nil\t\t\t\t&#125;\t\t\t\treturn &amp;v\t\t\t&#125;(v), // ç«‹å³æ‰§è¡Œå‡½æ•°\t\t&#125;\t&#125;\tdemo1 := newDemo(&quot;1&quot;)\tdemo2 := newDemo(&quot;&quot;)\tfmt.Println(demo1.Name)\tfmt.Println(demo2.Name)&#125;\n\né‚£ä¹ˆæ¢åšC++ï¼Œæˆ‘æ€ä¹ˆå†™å‘¢ï¼Ÿ æ˜¯çš„å¦‚æ­¤å¼ºå¤§çš„C++å®Œå…¨æ”¯æŒï¼Œ å“ˆå“ˆå“ˆå“ˆï¼æ³¨æ„æ˜¯C++11 ï¼\nstruct Demo &#123;  public:    const char* name;    Demo(const char* name) : name(name) &#123;    &#125;&#125;;void foo() &#123;    auto newDemo = [](const char* name) &#123;        return new Demo([&amp;] &#123;            if (*name == &#x27;\\0&#x27;) &#123;                const char * null;                return null;            &#125;            return name;        &#125;());    &#125;;    Demo* d1 = newDemo(&quot;111&quot;);    Demo* d2 = newDemo(&quot;&quot;);    std::cout &lt;&lt; d1-&gt;name &lt;&lt; std::endl;    std::cout &lt;&lt; d2-&gt;name &lt;&lt; std::endl;&#125;\n\nåŸºäºä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¤§æ¦‚çŸ¥é“äº†å¦‚ä½•å®šä¹‰ä¸€ä¸ª  å˜é‡çš„ç±»å‹æ˜¯å‡½æ•° ï¼Œ å…¶æ¬¡å¦‚ä½•å®šä¹‰ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼\n\nå‡½æ•°ç±»å‹\n\n/**[=]ï¼šé€šè¿‡å€¼æ•æ‰æ‰€æœ‰å˜é‡[&amp;]ï¼šé€šè¿‡å¼•ç”¨æ•æ‰æ‰€æœ‰å˜é‡[&amp;x]åªé€šè¿‡å¼•ç”¨æ•æ‰xï¼Œä¸æ•æ‰å…¶ä»–å˜é‡ã€‚[x]åªé€šè¿‡å€¼æ•æ‰xï¼Œä¸æ•æ‰å…¶ä»–å˜é‡ã€‚[=, &amp;xï¼Œ &amp;y]é»˜è®¤é€šè¿‡å€¼æ•æ‰ï¼Œå˜é‡xå’Œyä¾‹å¤–ï¼Œè¿™ä¸¤ä¸ªå˜é‡é€šè¿‡å¼•ç”¨æ•æ‰ã€‚[&amp;, x]é»˜è®¤é€šè¿‡å¼•ç”¨æ•æ‰ï¼Œå˜é‡xä¾‹å¤–ï¼Œè¿™ä¸ªå˜é‡é€šè¿‡å¼•ç”¨æ•æ‰ã€‚[&amp;x, &amp;y]éæ³•ï¼Œå› ä¸ºæ ‡å¿—ç¬¦ä¸å…è®¸é‡å¤ã€‚*/int add1(int x, int y) &#123;    auto lam = [&amp;]() &#123; // [&amp;] è¡¨ç¤ºå¼•ç”¨ä¼ é€’        x = x + 1;        y = y + 1;        return x + y;    &#125;;    return lam();&#125;int add2(int x, int y) &#123;    auto lam = [=]() &#123; // [=] è¡¨ç¤ºå€¼ä¼ é€’ï¼Œä¸å¯ä»¥åšå†™æ“ä½œï¼Œç±»ä¼¼äºconstå±æ€§        // x = x+1; // ä¸å¯ä»¥æ“ä½œ        // y = y+1; // ä¸å¯ä»¥æ“ä½œ        return x + y;    &#125;;    return lam();&#125;int add3(int x, int y) &#123;    // &amp;xè¡¨ç¤ºä¼ é€’xçš„å¼•ç”¨    // y è¡¨ç¤ºå‡½æ•°å‚æ•°    // ç±»å‹æ˜¯: std::function&lt;int(int)&gt;    std::function&lt;int(int)&gt; lam = [&amp;x](int y) &#123;        x = x + 1;        return x + y;    &#125;;    return lam(y);&#125;\n\n\nç«‹å³æ‰§è¡Œå‡½æ•°\n\nint main(int argc, char const* argv[]) &#123;    // lam: å‡½æ•°ç±»å‹    std::function&lt;int(int, int)&gt; lam = [](int a, int b) &#123; return a + b; &#125;;    std::cout &lt;&lt; lam(1, 9) &lt;&lt; &quot; &quot; &lt;&lt; lam(2, 6) &lt;&lt; std::endl;    // ç«‹å³æ‰§è¡Œå‡½æ•°    [] &#123; std::cout &lt;&lt; &quot;ç«‹å³æ‰§è¡Œå‡½æ•°&quot; &lt;&lt; std::endl; &#125;();    return 0;&#125;// è¾“å‡º:// 10 8// ç«‹å³æ‰§è¡Œå‡½æ•°\n\n\nå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’\n\nstd::function&lt;void()&gt; print(std::string str) throw(const char*) &#123;    if (str == &quot;&quot;) &#123;        throw &quot;str is empty&quot;;    &#125;    return [=] &#123; std::cout &lt;&lt; &quot;print: &quot; &lt;&lt; str &lt;&lt; std::endl; &#125;;&#125;int main(int argc, char const* argv[]) &#123;    try &#123;        print(&quot;&quot;)();    &#125; catch (const char* v) &#123;        std::cout &lt;&lt; &quot;å‡½æ•°æ‰§è¡Œå¤±è´¥, å¼‚å¸¸ä¿¡æ¯: &quot; &lt;&lt; v &lt;&lt; std::endl;    &#125;    print(&quot;abc&quot;)();    return 0;&#125;// è¾“å‡º: // å‡½æ•°æ‰§è¡Œå¤±è´¥, å¼‚å¸¸ä¿¡æ¯: str is empty// print: abc\n\næ³¨æ„ç‚¹ï¼š\n\nåŒºåˆ«äºä»¿å‡½æ•°ï¼Œä»¿å‡½æ•°æ˜¯é‡è½½äº†()è¿ç®—ç¬¦ï¼Œä»¿å‡½æ•°æœ¬è´¨ä¸Šæ˜¯ç±»ï¼Œä½†æ˜¯C++11å¼•å…¥äº† std::function ä¹Ÿå°±æ˜¯ lamdba ç®€åŒ–äº†ä»¿å‡½æ•°ï¼Œæ‰€ä»¥C++11 ä¸å†æ¨èä»¿å‡½æ•°äº†ï¼\nåŒºåˆ«äºå‡½æ•°æŒ‡é’ˆ\n\n#include &lt;algorithm&gt;#include &lt;iostream&gt;#include &lt;vector&gt;class NumberPrint &#123;   public:    explicit NumberPrint(int max) : max(max)&#123;&#125;;    void operator()(int num) const &#123; // ä»¿å‡½æ•°        if (num &lt; max) &#123;            std::cout &lt;&lt; &quot;num: &quot; &lt;&lt; num &lt;&lt; std::endl;        &#125;    &#125;;   private:    int max;&#125;;void printVector(std::vector&lt;int&gt;&amp;&amp; vector, void (*foo)(int)) &#123; std::for_each(vector.begin(), vector.end(), foo); &#125;void printNum(int num) &#123; std::cout &lt;&lt; &quot;num: &quot; &lt;&lt; num &lt;&lt; std::endl; &#125;int main() &#123;    printVector(std::vector&lt;int&gt;&#123;1, 2, 3, 4&#125;, printNum);    auto arr = std::vector&lt;int&gt;&#123;1, 2, 3, 4&#125;;    std::for_each(arr.begin(), arr.end(), NumberPrint(3));&#125;\n\n\nå‡½æ•°æŒ‡é’ˆçš„è‡´å‘½ç¼ºé™·ï¼Œ å°±æ˜¯å‡½æ•°æŒ‡é’ˆä¸æ”¯æŒæ•è·å‚æ•°ï¼Œæ‰€ä»¥æœ€å¥½åˆ«ç”¨å‡½æ•°æŒ‡é’ˆï¼Œé™¤éå¯¹æ¥Cï¼ \n\n\næšä¸¾C++çš„æšä¸¾ç»§æ‰¿äº†Cï¼Œä¹Ÿå°±æ˜¯æ”¯æŒ enum å’Œ enum classï¼Œä¸¤è€…çš„åŒºåˆ«ä¸»è¦æ˜¯åœ¨äºä½œç”¨èŒƒå›´çš„ä¸åŒï¼Œ ä¾‹å¦‚ä¸‹é¢  Child å’Œ Student éƒ½å®šä¹‰äº† Girl å’Œ Bodyï¼Œå¦‚æœä¸æ˜¯ enum class çš„è¯åˆ™ä¼šæŠ¥é”™ï¼\n#include &lt;iostream&gt;#include &lt;map&gt;// å…è®¸æŒ‡å®šç±»å‹enum class Child : char &#123;    Girl, // ä¸æŒ‡å®šä¸”ä½ç½®æ˜¯ç¬¬ä¸€ä¸ªå°±æ˜¯0    Boy = 1,&#125;;const static std::map&lt;Child, std::string&gt; child_map = &#123;&#123;                                                           Child::Girl,                                                           &quot;Girl&quot;,                                                       &#125;,                                                       &#123;                                                           Child::Boy,                                                           &quot;Boy&quot;,                                                       &#125;&#125;;std::ostream&amp; operator&lt;&lt;(std::ostream&amp; out, const Child&amp; child) &#123; // é‡è½½æ–¹æ³• &lt;&lt; æ–¹æ³•    auto kv = child_map.find(child);    if (kv == child_map.end()) &#123;        out &lt;&lt; &quot;Unknown[&quot; &lt;&lt; int(child) &lt;&lt; &quot;]&quot;;        return out;    &#125;    out &lt;&lt; kv-&gt;second;    return out;&#125;enum class Student &#123;    Girl,    Boy&#125;;using namespace std;int main() &#123;    Child x = Child::Boy;    cout &lt;&lt; x &lt;&lt; endl;    cout &lt;&lt; int(x) &lt;&lt; endl;    cout &lt;&lt; Child(100) &lt;&lt; endl;&#125;\n\næ¨¡ç‰ˆ\ntemplate: æ¨¡ç‰ˆ\ntemplate specialization: æ¨¡ç‰ˆç‰¹åŒ–\nå­¦ä¹ æ–‡æ¡£æ¨èï¼š\nhttps://en.cppreference.com/w/cpp/language/templates\nC++ Template ï¼ˆç¬¬äºŒç‰ˆï¼‰  \n\n\n\nC++çš„æ¨¡ç‰ˆæ˜¯ç°ä»£C++çš„çµé­‚ï¼Œæ”¯æŒåŒ…å«ç±»å‹é™å®šã€æŠ½è±¡ï¼Œå…¶çµæ´»æ€§éå¸¸ä¹‹é«˜ï¼ä¸ºä»€ä¹ˆæ˜¯æ¨¡ç‰ˆå‘¢ï¼Œæ¨¡ç‰ˆæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œå› ä¸ºä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½ï¼Œä¸å…è®¸å­˜åœ¨è¿è¡Œæ—¶çš„æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥C++é‡‡ç”¨äº†æ¨¡ç‰ˆçš„æŠ€æœ¯æ¥å®ç°æ³›å‹(generic)ã€‚\næ¨¡ç‰ˆåœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ C++ç±»å‹é€€åŒ– çš„é—®é¢˜, è¿™é‡Œå¯èƒ½ä¼šä½¿ç”¨åˆ° std::decay  https://www.cnblogs.com/heartchord/p/5039894.html ã€‚ \nç±»æ¨¡ç‰ˆç±»æ¨¡ç‰ˆæ”¯æŒå…¨ç‰¹åŒ–å’Œåç‰¹åŒ–\n\nå‚è€ƒæ–‡ç« :\n\nhttps://en.cppreference.com/w/cpp/language/template_parameters\n\nhttps://harttle.land/2015/10/03/cpp-template.html\n\n\n\n#include &lt;iostream&gt;using namespace std;// doc: https://en.cppreference.com/w/cpp/language/template_parameters// Non-type template parameter// è¿™é‡Œçš„Non-type å¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…·ä½“ç±»å‹ï¼Œè€Œé &#x27;typename T&#x27; or &#x27;class T&#x27;// å…¶ä¸­ç±»å‹å¯ä»¥æ˜¯ï¼Œå…·ä½“å‚è€ƒä¸Šé¢æ–‡ç« å°±è¡Œäº†template &lt;int size&gt;struct IntArray &#123;    int arr[size];&#125;;// Type template parameter// è¿™é‡Œå¯ä»¥æ˜¯ &#x27;typename T&#x27; or &#x27;class T&#x27;template &lt;typename K, typename V&gt;struct KV &#123;    K key;    V value;&#125;;// æ¨¡ç‰ˆå®ä¾‹åŒ–: åç‰¹åŒ–// åç‰¹åŒ–: ä»…ç‰¹åŒ– type template parametertemplate &lt;typename K&gt;struct KV&lt;K, int&gt; &#123;    K key;    int value;    static const int type_id = 1;&#125;;// æ¨¡ç‰ˆå®ä¾‹åŒ–: å…¨ç‰¹åŒ–// å…¨ç‰¹åŒ–: ç‰¹åŒ–å…¨éƒ¨çš„ type template parametertemplate &lt;&gt;struct KV&lt;int, int&gt; &#123;    int key;    int value;    static const int type_id = 2;&#125;;// å‡½æ•°æ¨¡ç‰ˆï¼Œæ­¤å¤„æ‰“å° type_id// æ³¨æ„æ¨¡ç‰ˆåœ¨ç¼–è¯‘å™¨ä¼šæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰ç”¨åˆ°å°±ä¸ä¼šæ£€æŸ¥è¯­æ³•é”™è¯¯template &lt;typename T&gt;void do_print_type_id(T t) &#123;    cout &lt;&lt; &quot;type_id: &quot; &lt;&lt; T::type_id &lt;&lt; endl;&#125;template &lt;typename T, size_t S&gt;struct TArray &#123;    T array[S];&#125;;// Template template parameter// å®é™…ä¸Šä¸ªäººæ„Ÿè§‰å§æ¯”è¾ƒé€‚åˆäº, é™å®š template parametertemplate &lt;typename Key, typename Value, size_t Size = 16, template &lt;typename E, size_t S&gt; class ArrayValue = TArray&gt;struct ArrayKV &#123;    Key key;    ArrayValue&lt;Value, Size&gt; value;&#125;;int main() &#123;    KV&lt;int, int&gt; kv1&#123;&#125;;    KV&lt;const char *, int&gt; kv2&#123;&#125;;    KV&lt;const char *, const char *&gt; kv3&#123;&#125;;    do_print_type_id(kv1); // type_id: 2    do_print_type_id(kv2); // type_id: 1    do_print_type_id(kv3); // error: ç¼–è¯‘å¤±è´¥    ArrayKV&lt;const char *, int&gt; kv4&#123;&#125;;    kv4.value.array[0] = 1;    kv4.value.array[1] = 2;&#125;\n\nå‡½æ•°æ¨¡ç‰ˆæ³¨æ„: å‡½æ•°ä¸æ”¯æŒåç‰¹åŒ–ï¼Œä»…æ”¯æŒå…¨ç‰¹åŒ–ï¼Œå³ä¸å…è®¸ç‰¹åŒ–æ¨¡ç‰ˆå‡½æ•°æœ‰æ¨¡ç‰ˆå‚æ•°ï¼ŒåŸå› æ˜¯å‡½æ•°æ”¯æŒé‡è½½\n#include &lt;iostream&gt;using namespace std;// å‡½æ•°æ¨¡ç‰ˆtemplate &lt;typename K, typename V&gt;void do_print(K key, V value) &#123;    cout &lt;&lt; &quot;func1&quot; &lt;&lt; endl;&#125;// å…¨ç‰¹åŒ– æ¨¡ç‰ˆ// æ³¨æ„å‡½æ•°æ¨¡ç‰ˆä¸éœ€è¦æ‰‹åŠ¨ç”³æ˜ &#x27;&lt;æ¨¡ç‰ˆå®å‚&gt;&#x27; (å¦‚æœå‡ºç°æ¨æ–­å†²çªçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ç”³æ˜)template &lt;&gt;void do_print(const char *key, int value) &#123;    cout &lt;&lt; &quot;func2&quot; &lt;&lt; endl;&#125;// é‡è½½// ç†è®ºä¸Šçš„åç‰¹åŒ–, ä½†æ˜¯å‡½æ•°æ”¯æŒé‡è½½, å› æ­¤å‡½æ•°ä¸æ”¯æŒåç‰¹åŒ–template &lt;typename K&gt;void do_print(K key, int value) &#123;    cout &lt;&lt; &quot;func3&quot; &lt;&lt; endl;&#125;int main() &#123;  \t// å¦‚æœå‡ºç°æ­§ä¹‰ï¼Œä¾‹å¦‚2/3/4ä»£ç ï¼Œå…¶å®å°±æ˜¯æ­§ä¹‰äº†ï¼Œå¯ä»¥é€šè¿‡ç”³æ˜æ¨¡ç‰ˆå®å‚è§£å†³    do_print(&quot;1&quot;, &quot;1&quot;);                  // func1    do_print&lt;const char *, int&gt;(&quot;1&quot;, 1); // func2    do_print&lt;const char *&gt;(&quot;1&quot;, 1);      // func3    do_print(&quot;1&quot;, 1);                    // func3&#125;\n\n\næ³¨æ„\n\n\næ¨¡ç‰ˆç”±äºå…¶ç‰¹æ®Šæ€§å®ç°éƒ¨åˆ†åªèƒ½åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰ï¼Œä¸»è¦åŸå› æ˜¯å› ä¸ºå‡½æ•°æ¨¡ç‰ˆçš„å®ä¾‹åŒ–è¿‡ç¨‹å®é™…ä¸Šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾ˆå¤šæƒ…å†µä¸‹ä»…ä¾èµ–å¤´æ–‡ä»¶å’Œé“¾æ¥(ç¼–è¯‘åçš„äº§ç‰©)ï¼Œæ‰€ä»¥å®ç°éƒ¨åˆ†å¿…é¡»å®šä¹‰åœ¨å¤´æ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰å¯ä»¥ä½¿ç”¨å¤´æ–‡ä»¶çš„æ¨¡ç‰ˆï¼\næˆ–è€…é€šè¿‡æ¨¡ç‰ˆå…¨ç‰¹åŒ–çš„æ–¹æ¡ˆ\nå…¶æ¬¡å°±æ˜¯å‚è€ƒ fmt åŒ…çš„æ–¹æ¡ˆ\n\n\nclass ä¸ template åŒºåˆ«  \n\n\næœ‰ç‚¹é¢è¯•ç»æ„Ÿè§‰ï¼Œè¯´å®è¯æˆ‘ä¸ªäººè§‰å¾—åªæ˜¯è¯­æ³•æ”¯æŒåº¦ä¸Šçš„å·®å¼‚:   https://liam.page/2018/03/16/keywords-typename-and-class-in-Cxx/\n\ntype traitsæ¨¡ç‰ˆçš„ç±»å‹æ¨æ–­æ˜¯éå¸¸å¼ºå¤§ï¼Œé‚£ä¹ˆåŸºæœ¬ä¸Šé«˜çº§ç©æ³•éƒ½å·®ä¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä»¥ä¸‹å‡ ä¸ªä¾‹å­\n\nç§»é™¤æŒ‡é’ˆ, å¤´æ–‡ä»¶ type_traits çš„å†…å®¹\n\nå®ç°æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯æ¨¡ç‰ˆåœ¨åŒ¹é…çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠæŒ‡é’ˆå¼•ç”¨çš„ç±»å‹æ‹¿åˆ°å°±è¡Œäº†\ntemplate &lt;class _Tp&gt; struct _LIBCPP_TEMPLATE_VIS remove_pointer                      &#123;typedef _LIBCPP_NODEBUG_TYPE _Tp type;&#125;;template &lt;class _Tp&gt; struct _LIBCPP_TEMPLATE_VIS remove_pointer&lt;_Tp*&gt;                &#123;typedef _LIBCPP_NODEBUG_TYPE _Tp type;&#125;;template &lt;class _Tp&gt; struct _LIBCPP_TEMPLATE_VIS remove_pointer&lt;_Tp* const&gt;          &#123;typedef _LIBCPP_NODEBUG_TYPE _Tp type;&#125;;template &lt;class _Tp&gt; struct _LIBCPP_TEMPLATE_VIS remove_pointer&lt;_Tp* volatile&gt;       &#123;typedef _LIBCPP_NODEBUG_TYPE _Tp type;&#125;;template &lt;class _Tp&gt; struct _LIBCPP_TEMPLATE_VIS remove_pointer&lt;_Tp* const volatile&gt; &#123;typedef _LIBCPP_NODEBUG_TYPE _Tp type;&#125;;\n\n\né™å®šç±»å‹ï¼Œè¿™ä¸ªç”¨å¤„æœ€å¤šï¼Œä»–æ˜¯é€šè¿‡å‚æ•°2æ¥é™å®šå‚æ•°1çš„ç±»å‹ï¼Œä¾‹å¦‚ä¸‹é¢ä»…å…è®¸æŒ‡é’ˆç±»å‹\n\n#include &lt;type_traits&gt;#include &lt;fmt/core.h&gt;template &lt;typename T&gt;struct IsPoint &#123;&#125;;// åªæœ‰æŒ‡é’ˆç±»å‹: æ‰æœ‰valueå­—æ®µï¼Œä¸”valueä¸ºtruetemplate &lt;typename T&gt;struct IsPoint&lt;T *&gt; &#123;    static const bool value = true;&#125;;template &lt;bool Enable, typename T = void&gt;struct EnableIf &#123;&#125;;// ä»…æœ‰Enable=trueçš„æ—¶å€™ï¼Œæ‰ä¼šæœ‰typeç”³æ˜template &lt;typename T&gt;struct EnableIf&lt;true, T&gt; &#123;    typedef T type;&#125;;template &lt;typename T&gt;// std::is_pointer&lt;T&gt;::value ç›¸å½“äºå¦‚æœä½ æ˜¯æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªvalue=true// std::enable_if&lt;bool,T=void&gt; å½“trueçš„æ—¶å€™ä¼šå®šä¹‰ä¸€ä¸ªtypeç±»å‹ï¼Œä¸”è¿™ä¸ªtypeé»˜è®¤æ˜¯voidç±»å‹void do_print_point(T t, typename std::enable_if&lt;std::is_pointer&lt;T&gt;::value&gt;::type * = nullptr) &#123;    fmt::print(&quot;&#123;&#125;\\n&quot;, *t);&#125;int main() &#123;    int x1 = 10086;    do_print_point(&amp;x1);    do_print_point(x1); // ç¼–è¯‘å¤±è´¥&#125;\n\n\næ¨¡ç‰ˆå®é™…ä¸Šå¹¶ä¸ä¼šæ£€æŸ¥è¯­æ³•ï¼Œå› æ­¤å¯ä»¥é™å®šå‡½æ•°æ‰§è¡Œï¼Œå…·ä½“ç¼–è¯‘åå‡½æ•°å¯ä»¥çœ‹: é“¾æ¥\n\ntemplate &lt;class InputIterator, class Function&gt;Function ForEach(InputIterator _first, InputIterator _last, Function _f) &#123;    for (; _first != _last; ++_first) &#123; _f(*_first); &#125;    return _f;&#125;int main() &#123;    int arr[10]&#123;&#125;;    ForEach(arr, &amp;arr[9], [](int &amp;x) &#123; x = 10; &#125;);    ForEach(arr, &amp;arr[9], [](const int &amp;x) &#123; std::cout &lt;&lt; x &lt;&lt; std::endl; &#125;);&#125;\n\n\nstd::declval \n\nå¯å˜å‚æ•°æ¨¡ç‰ˆhttps://zhuanlan.zhihu.com/p/338785886\nå¯å˜å‚æ•°æ¨¡ç‰ˆæœ¬è´¨ä¸Šå°±æ˜¯ç¼–è¯‘å™¨å®ç°çš„ä¸€ä¸ªä»£ç å±•å¼€ç½¢äº†ï¼åœ¨C++11çš„æ—¶å€™æˆ‘ä»¬å¤§æ¦‚ç‡åªèƒ½è¿™ä¹ˆå†™ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç \n#include &lt;iostream&gt;void print() &#123;    std::cout &lt;&lt; &#x27;\\n&#x27;;&#125;template &lt;typename T, typename... Types&gt;void print(T firstArg, Types... args) &#123;    std::cout &lt;&lt; firstArg &lt;&lt; &#x27; &#x27;; // print first argument    print(args...);               // call print() for remaining arguments&#125;int main() &#123;    print(&quot;hello&quot;, 1, 1.11);&#125;// å±•å¼€å/* First instantiated from: insights.cpp:13 */#ifdef INSIGHTS_USE_TEMPLATEtemplate&lt;&gt;void print&lt;const char *, int, double&gt;(const char * firstArg, int __args1, double __args2)&#123;  std::operator&lt;&lt;(std::operator&lt;&lt;(std::cout, firstArg), &#x27; &#x27;);  print(__args1, __args2);&#125;#endif/* First instantiated from: insights.cpp:9 */#ifdef INSIGHTS_USE_TEMPLATEtemplate&lt;&gt;void print&lt;int, double&gt;(int firstArg, double __args1)&#123;  std::operator&lt;&lt;(std::cout.operator&lt;&lt;(firstArg), &#x27; &#x27;);  print(__args1);&#125;#endif/* First instantiated from: insights.cpp:9 */#ifdef INSIGHTS_USE_TEMPLATEtemplate&lt;&gt;void print&lt;double&gt;(double firstArg)&#123;  std::operator&lt;&lt;(std::cout.operator&lt;&lt;(firstArg), &#x27; &#x27;);  print();&#125;#endif\n\nåœ¨C++17ä»¥åï¼Œæ”¯æŒäº† Fold Expressionsï¼Œå†™æ³•ä¸Šæœ‰ç‚¹å¥‡æ€ª\nå¤§æ¦‚ç‡åˆ†ä¸ºå‡ éƒ¨åˆ†ç»„æˆ ...   ã€operator ã€pack(function)    ï¼Œç„¶åé¦–ä½ç”¨ () æ‹¬èµ·æ¥ï¼\n( pack op ... )\t(1)\t // (E1 op (... op (EN-1 op EN)))( ... op pack )\t(2)\t // (((E1 op E2) op ...) op EN)( pack op ... op init )\t(3)\t // (E1 op (... op (ENâˆ’1 op (EN op I))))( init op ... op pack )\t(4)\t// ((((I op E1) op E2) op ...) op EN)\n\nä¾‹å¦‚: \n#include &lt;iostream&gt;template &lt;typename T&gt;std::ostream &amp;output(T t) &#123;    return std::cout &lt;&lt; t &lt;&lt; &#x27; &#x27;;&#125;template &lt;typename... Args&gt;void print(Args... args) &#123;    (std::cout &lt;&lt; ... &lt;&lt; args) &lt;&lt; &quot;\\n&quot;;                     // ( init op ... op pack )    ((std::cout &lt;&lt; &quot;[info]: &quot;), ..., output(args)) &lt;&lt; &quot;\\n&quot;; // ( init op ... op pack )    (output(args), ..., (std::cout &lt;&lt; &quot; [end]\\n&quot;));         // ( pack op ... op init )     (..., (std::cout &lt;&lt; args &lt;&lt; &quot; &quot;)) &lt;&lt; &quot;\\n&quot;; // ( ... op pack ) left    (..., output(args)) &lt;&lt; &quot;\\n&quot;;               // ( ... op pack ) left    ((std::cout &lt;&lt; args &lt;&lt; &quot; &quot;), ...) &lt;&lt; &quot;\\n&quot;; // ( pack op ... ) right    (output(args), ...) &lt;&lt; &quot;\\n&quot;;               // ( pack op ... ) right&#125;\n\nSTLSTLï¼šï¼ˆStandard Template Libraryï¼‰å«åšC++æ ‡å‡†æ¨¡ç‰ˆåº“ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºC++æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¾ˆå¤šäººæœ›è€Œå´æ­¥ï¼Œå…¶å®æˆ‘æ„Ÿè§‰è¿˜å¥½ï¼\nä¸»è¦åŒ…å«ï¼š\n\nå®¹å™¨ç±»æ¨¡æ¿ï¼š åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œæ•°ç»„ã€é˜Ÿåˆ—ã€æ ˆã€mapã€å›¾ ç­‰ï¼Œå¦‚æœä½ å­¦ä¹ è¿‡å¾ˆå¤šé«˜çº§è¯­è¨€ï¼Œé‚£ä¹ˆå¯¹äºC++è¿™äº›å®¹å™¨ç»“æ„æˆ‘è§‰å¾—å…¶å®ä¸ç”¨å¤ªæŠ•å…¥ï¼Œåªè¦ç†Ÿæ‚‰å‡ ä¸ªAPIå°±å¯ä»¥äº†ï¼\n\n\n// å¤´æ–‡ä»¶#include &lt;vector&gt;#include &lt;array&gt;#include &lt;deque&gt;#include &lt;list&gt;#include &lt;forward_list&gt;#include &lt;map&gt;#include &lt;set&gt;#include &lt;stack&gt;\n\n\nç®—æ³•ï¼ˆå‡½æ•°ï¼‰æ¨¡æ¿ï¼šåŸºæœ¬çš„ç®—æ³•ï¼Œæ’åºå’Œç»Ÿè®¡ç­‰ ï¼Œ å…¶å®å°±æ˜¯ä¸€äº›å·¥å…·åŒ…\n\n// å¤´æ–‡ä»¶#include &lt;algorithm&gt;\n\n\nè¿­ä»£å™¨ç±»æ¨¡æ¿ï¼šæˆ‘è§‰å¾—åœ¨Javaä¸­å¾ˆå¸¸è§ï¼Œå› ä¸ºä½ è¦å®ç° for each å°±éœ€è¦å®ç° iterator æ¥å£ï¼Œå…¶å®è¿­ä»£å™¨ç±»æ¨¡ç‰ˆä¹Ÿå°±æ˜¯è¿™ä¸ªäº†ï¼\n\n// å¤´æ–‡ä»¶#include &lt;iterator&gt;\n\n\næ€»ç»“\n\n#include &lt;iostream&gt;#include &lt;algorithm&gt;  // ç®—æ³•#include &lt;iterator&gt;  // è¿­ä»£å™¨#include &lt;vector&gt;    // å®¹å™¨// æ‰¾åˆ°targetValä½ç½®ï¼Œå¹¶åœ¨targetValå‰é¢æ’å…¥insertVal// æœªæ‰¾åˆ°åˆ™åœ¨å°¾éƒ¨æ’å…¥template &lt;typename C, typename V&gt;void findAndInsert(C&amp; container, const V&amp; targetVal, const V&amp; insertVal) &#123;    // è¿­ä»£å™¨    using std::begin;    using std::end;    // ç®—æ³•    auto it = std::find(begin(container), end(container), targetVal);    container.insert(it, insertVal);&#125;int main() &#123;    // å®šä¹‰å®¹å™¨    auto arr = std::vector&lt;int&gt;&#123;1, 2, 3, 4&#125;;    findAndInsert(arr, 4, 2);    // ç®—æ³•    std::for_each(arr.begin(), arr.end(), [](decltype(*arr.begin()) elem) &#123; cout &lt;&lt; elem &lt;&lt; endl; &#125;);    return 0;&#125;\n\n\nç°åœ¨å¾ˆå¤šé«˜çº§è¯­è¨€éƒ½æ”¯æŒåˆ‡ç‰‡ï¼Œå¯ä»¥è¯´æ˜¯å¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ï¼Œä½†æ˜¯cppä¹Ÿæœ‰ï¼Œä¹Ÿå¾ˆç®€å•ï¼ŒåŒºåˆ«åœ¨äºæ˜¯c++å®ç°çš„æ˜¯æ‹·è´ï¼Œè€Œéå†…å­˜å¤ç”¨ï¼Œæ‰€ä»¥è¿™ç§éœ€æ±‚è¿˜æ˜¯ç”¨è¿­ä»£å™¨æ¯”è¾ƒå¥½ï¼\n\n#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;functional&gt;#include &lt;algorithm&gt;using IntVector = std::vector&lt;int&gt;;template &lt;typename T&gt;void print(std::vector&lt;T&gt; &amp;v) &#123;    int index = 0;    std::cout &lt;&lt; &quot;[&quot;;    for (const auto &amp;item : v) &#123;        if (index != 0) &#123; std::cout &lt;&lt; &quot;, &quot;; &#125;        std::cout &lt;&lt; item;        ++index;    &#125;    std::cout &lt;&lt; &quot;]&quot; &lt;&lt; std::endl;&#125;int main() &#123;    IntVector v1&#123;&#125;;    v1.reserve(10);    for (int x = 0; x &lt; 10; x++) &#123; v1.push_back(x); &#125;    print(v1);    // [:4]    auto v2 = IntVector(v1.begin(), v1.begin() + 4);    print(v2);    // [1:-1]    auto v3 = IntVector(v1.begin() + 1, v1.end() - 1);    print(v3);    // æ›´åŠ æ¨èï¼Œä¼ é€’è¿­ä»£å™¨    for (auto begin = v1.begin(); begin != v1.begin() + 4; begin++) &#123;        std::cout &lt;&lt; &quot;range: &quot; &lt;&lt; *begin &lt;&lt; std::endl;    &#125;    // c++14æ”¯æŒlambdaè¡¨è¾¾å¼å‚æ•°ç”¨auto    std::for_each(v1.begin() + 1, v1.begin() + 4, [](auto elem) &#123; std::cout &lt;&lt; &quot;for_each: &quot; &lt;&lt; elem &lt;&lt; std::endl; &#125;);&#125;\n\né¢„å¤„ç†å™¨ - å®å®æœ¬è´¨ä¸Šå°±æ˜¯åœ¨é¢„å¤„ç†é˜¶æ®µæŠŠå®æ›¿æ¢æˆå¯¹åº”çš„ä»£ç ï¼Œå±äºä»£ç æ¨¡ç‰ˆ[ C++/C æ€æƒ³çœŸçš„è¶…å‰ ]ï¼Œå¯ä»¥çœå»ä¸å°‘ä»£ç å·¥ä½œé‡ï¼Œå…¶æ¬¡å°±æ˜¯æ€§èƒ½æ›´å¥½ï¼Œä¸éœ€è¦å‡½æ•°è°ƒç”¨ï¼Œç›´æ¥é¢„å¤„ç†é˜¶æ®µå†…è”åˆ°ä»£ç ä¸­å»äº†ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œå°±ç”¨äº†å® https://github.com/Anthony-Dong/protobuf/blob/master/pb_include.h ï¼\nå®çš„ç©æ³•å¤ªé«˜çº§ï¼Œå¾ˆå¤šæºç æ»¡æ»¡çš„å®ï¼Œä¸ä»‹æ„æ–°æ‰‹å»æ·±å…¥äº†è§£ï¼åªè¦èƒ½çœ‹æ‡‚å°±è¡Œäº†ï¼Œç®€å•å®ç”¨ä¸€ä¸‹ä¹Ÿå®Œå…¨å¯ä»¥çš„å“ˆï¼\nç®€å•çš„ä¾‹å­#include &lt;iostream&gt;#define product(x) x* xusing namespace std;int main() &#123;    int x = product((1 + 1)) + 10; // å±•å¼€å:  (1 + 1)*(1 + 1) + 10    std::cout &lt;&lt; &quot;x: &quot; &lt;&lt; x &lt;&lt; std::endl;    int y = product(1 + 1) + 10; // å±•å¼€å: 1 + 1*1 + 1 + 10    std::cout &lt;&lt; &quot;y &quot; &lt;&lt; y &lt;&lt; std::endl;#ifdef ENABLE_DEBUG    cout &lt;&lt; &quot;print debug&quot; &lt;&lt; endl;#endif&#125;// è¾“å‡º:x: 14y: 13\n\nclass+å®+ç±»åçš„æ„ä¹‰\næ³¨æ„: è¿™é‡Œè¦æ˜¯æœ‰windowsç¯å¢ƒçš„è¯å¯ä»¥è‡ªå·±ä½“éªŒä¸‹ï¼\n\nä¸æ¸…æ¥šå¤§å®¶é˜…è¯»è¿‡c++æºç å—ï¼Œå‘ç°å¼€æºçš„ä»£ç ä¸­åŸºæœ¬éƒ½æœ‰ä¸€ä¸ª ,é‚£ä¹ˆé—®é¢˜æ˜¯ PROTOBUF_EXPORT å¹²å•¥äº†ï¼Ÿ\nclass PROTOBUF_EXPORT CodedInputStream &#123;  \t//...&#125;\n\nå®é™…ä¸Šä½ è‡ªå·±å†™ä»£ç æ²¡å•¥é—®é¢˜ï¼Œå®šä¸å®šä¹‰è¿™ä¸ªå®ï¼Œä½ è¦æŠŠä»£ç /ddlæä¾›ç»™åˆ«äººç”¨windowsçš„å¼€å‘è€…æ¥è¯´å°±æœ‰é—®é¢˜äº†ï¼Œåˆ«äººå¼•ç”¨ä½ çš„apiéœ€è¦ç”³æ˜ä¸€ä¸ª   __declspec(dllexport) å®å®šä¹‰ï¼Œè¡¨ç¤ºå¯¼å‡ºè¿™ä¸ªclassï¼Œå…·ä½“å¯ä»¥çœ‹ https://learn.microsoft.com/en-us/cpp/cpp/using-dllimport-and-dllexport-in-cpp-classes  æ‰€ä»¥è¯´å¯¹äºè·¨ç«¯å¼€å‘æ¥è¯´æ˜¯éå¸¸é‡è¦çš„è¿™ç‚¹ï¼\nå…¶æ¬¡è¿™ä¸ªä¸œè¥¿å¾ˆå¤šæ—¶å€™å¯ä»¥åœ¨ç¼–è¯‘å™¨å±‚é¢åšæ‰‹è„šï¼Œè¡¨ç¤ºç‰¹æ®Šæ ‡è¯†ï¼Œåæ­£ å¤§æ¦‚ä½ çŸ¥é“ windows ä¸‹éœ€æ±‚è¿™ä¸ªä¸œä¸œå°±è¡Œäº†ï¼\n#define DllExport   __declspec( dllexport )class DllExport C &#123;   int i;   virtual int func( void ) &#123; return 1; &#125;&#125;;\n\nRTTIå¾…è¡¥å……ï¼\nå¤šçº¿ç¨‹https://en.cppreference.com/w/cpp/thread\ncpp11 çš„ threadã€mutexã€lock_guardã€lock_uniqã€feature\ncpp14 æ”¯æŒäº† shared_lock\ncpp17 æ”¯æŒäº† async ã€shared_mutex\ncpp20 æ”¯æŒäº† jthread å’Œ coroutine\n#include &lt;mutex&gt;#include &lt;thread&gt;#include &lt;iostream&gt;int main() &#123;    using GuardLock = std::lock_guard&lt;std::mutex&gt;;    using UniqueLock = std::unique_lock&lt;std::mutex&gt;;    std::mutex mutex;    int count = 0;    &#123;        auto test = [&amp;count, &amp;mutex]() &#123;            for (int y = 0; y &lt; 100000; y++) &#123;                GuardLock lock(mutex);                ++count;            &#125;            std::cout &lt;&lt; std::this_thread::get_id() &lt;&lt; &quot;: &quot; &lt;&lt; count &lt;&lt; std::endl;        &#125;;        std::jthread tt(test);        std::jthread t2(test);        std::jthread t3(test);    &#125;    std::cout &lt;&lt; &quot;main&quot; &lt;&lt; count &lt;&lt; std::endl;&#125;\n\nå…¶ä»–new ä¸ mallocæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥å† Cè¯­è¨€é‡Œä½¿ç”¨ malloc  å’Œ frees åˆå§‹åŒ–å†…å­˜ï¼Œä½†æ˜¯C++ é‡Œæ›´åŠ æ¨èä½¿ç”¨ new å’Œ delete ï¼Œé‚£ä¹ˆåŒºåˆ«åœ¨å“ªé‡Œäº†ï¼\né¦–å…ˆæˆ‘ä»¬çŸ¥é“C++å¼•å…¥äº† æ„é€ å‡½æ•° å’Œ ææ„å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ cç³»åˆ—çš„apiæ“ä½œï¼Œä¼šä¸¢å¤±è¿™äº›ä¿¡æ¯ï¼Œè¿™å°±æ˜¯æœ€ä¸»è¦çš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯ç‰¹åˆ«éœ€è¦æ³¨æ„çš„ï¼\nä¾‹å­ä¸€: æœ€å¸¸è§çš„ä¹±ç”¨è¡Œä¸ºï¼ \nclass Test &#123;   public:    explicit Test(int x_) : x(x_) &#123;&#125;    ~Test() &#123;        std::cout &lt;&lt; &quot;release: &quot; &lt;&lt; x &lt;&lt; std::endl;    &#125;   public:    int x;&#125;;int main() &#123;    Test* test = new Test(1);    // é”™è¯¯è¡Œä¸º//    free(test);    // æ­£ç¡®ï¼Œä¼šè°ƒç”¨ææ„å‡½æ•°ï¼    delete test;&#125;\n\nä¾‹å­äºŒï¼š ä¸šåŠ¡ä¸­ä¸ºäº†åšä¸€äº›äº‹æƒ…ï¼Œä¾‹å¦‚æœ‰äº›ç‰¹æ®Šcaseéœ€è¦ç”¨ void* æŒ‡é’ˆè¿›è¡Œæ“ä½œï¼ˆä¾‹å¦‚å¯¼å‡ºCï¼‰ï¼Œè§£å†³å†…å­˜æ‹·è´çš„é—®é¢˜\nstruct CClass &#123;    void* point;&#125;;int main() &#123;    Test* test = new Test(1);    CClass c&#123;        .point = test,    &#125;;    // æ­£ç¡®è¡Œä¸ºï¼Œéœ€è¦å¼ºåˆ¶è½¬æ¢æˆ Test*ï¼›    delete (Test*)c.point;&#125;\n\nnew[] ä¸ delete[]æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå°±å¤§æ¦‚æ˜ç™½äº†ï¼Œnewä¸deleteçš„åŒºåˆ«\nclass Test &#123;   public:  \tTest() = default;    int x;&#125;;void builtin() &#123;    auto list = new int[10]&#123;&#125;;    for (int x = 0; x &lt; 10; x++) &#123;        list[x] = x;    &#125;    cout &lt;&lt; *((unsigned long*)list - 1) &lt;&lt; endl; // è¾“å‡ºä¸ç¡®å®š    delete[] list;&#125;void external() &#123;    auto list = new Test[10]&#123;&#125;;    for (int x = 0; x &lt; 10; x++) &#123;        list[x].x = x;    &#125;    cout &lt;&lt; *((unsigned long*)list - 1) &lt;&lt; endl; // è¾“å‡º10    delete[] list;&#125;\n\n\nå†…ç½®ç±»å‹çš„è¯ï¼Œå†…å­˜ä¸­ä¸ä¼šå­˜å‚¨é•¿åº¦å­—æ®µ\n\n\n\nå…¶ä»–ç±»å‹ï¼Œä¼šåœ¨é¦–åœ°å€-8 çš„ä½ç½®å­˜å‚¨é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯64ä½æ˜¯8å­—èŠ‚\n\n\n\næ‰€ä»¥å¯¹äº new[]  çš„æŒ‡é’ˆå¯¹è±¡ï¼Œä¸€å®šè¦ç”¨delete[] é‡Šæ”¾ï¼Œä¸ç„¶çš„è¯ä½ ä¼šå†…å­˜æ³„æ¼å¥¥ï¼\n\nC++ ä½åŸŸhttps://learn.microsoft.com/zh-cn/cpp/cpp/cpp-bit-fields?view=msvc-170  å¯ä»¥èŠ‚çº¦å†…å­˜å¼€é”€\n#include &lt;iostream&gt;using namespace std;struct http_parser &#123;    /** PRIVATE **/    unsigned int type : 2;                   /* enum http_parser_type */    unsigned int flags : 8;                  /* F_* values from &#x27;flags&#x27; enum; semi-public */    unsigned int state : 7;                  /* enum state from http_parser.c */    unsigned int header_state : 7;           /* enum header_state from http_parser.c */    unsigned int index : 5;                  /* index into current matcher */    unsigned int uses_transfer_encoding : 1; /* Transfer-Encoding header is present */    unsigned int allow_chunked_length : 1;   /* Allow headers with both                                              * `Content-Length` and                                              * `Transfer-Encoding: chunked` set */    unsigned int lenient_http_headers : 1;    uint32_t nread;          /* # bytes read in various scenarios */    uint64_t content_length; /* # bytes in body. `(uint64_t) -1` (all bits one)                              * if no Content-Length header.                              */    /** READ-ONLY **/    unsigned short http_major;    unsigned short http_minor;    unsigned int status_code : 16; /* responses only */    unsigned int method : 8;       /* requests only */    unsigned int http_errno : 7;    /* 1 = Upgrade header was present and the parser has exited because of that.     * 0 = No upgrade header present.     * Should be checked when http_parser_execute() returns in addition to     * error checking.     */    unsigned int upgrade : 1;    /** PUBLIC **/    void *data; /* A pointer to get hook to the &quot;connection&quot; or &quot;socket&quot; object */&#125;;int main() &#123;    cout &lt;&lt; sizeof(http_parser) &lt;&lt; endl;&#125;// output:// 32\n\nnamespaceæˆ‘ä»¬çŸ¥é“cè¯­è¨€æ˜¯æ²¡æœ‰namespaceçš„æ¦‚å¿µçš„ï¼Œä½œç”¨åŸŸæ˜¯å…¨å±€çš„ï¼Œæ‰€ä»¥å¯¼è‡´å¤´æ–‡ä»¶å¦‚æœå­˜åœ¨å…¬å…±å®šä¹‰æ˜¯å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜çš„ã€‚\nc++ æ”¯æŒäº†namespaceï¼Œè§£å†³å‘½åå†²çªçš„é—®é¢˜ï¼Œä½†æ˜¯åŒæ ·çš„å®ƒä¼šé€ æˆç¼–è¯‘çš„æ—¶å€™ ç¬¦å·è¿æ¥ä¼šå¸¦ä¸Šnamespaceï¼Œå¯¼è‡´cè¯­è¨€æ— æ³•å’Œc++é“¾æ¥ï¼Œæ­¤æ—¶å°±éœ€è¦ç”¨åˆ° extern &quot;C&quot; äº†ï¼\nnamespace Misc &#123;namespace Utils &#123;struct Consts &#123;&#125;;&#125; // namespace Utils&#125; // namespace Miscnamespace Misc &#123;namespace Network &#123;struct TcpConnect &#123;    using Consts = Utils::Consts; // ä»–ä»¬éƒ½å­˜åœ¨Misc namespaceä¸‹ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆå¼•ç”¨ï¼Œå› ä¸ºå¿…é¡»è¦å…¨é™å®šnamespace(è¿™ç§æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä¼šä½¿ç”¨)    using FullConsts = Misc::Utils::Consts; // ä¸æ¨è&#125;;&#125; // namespace Network&#125; // namespace Misc\n\nå¸¸ç”¨åº“\nabsl:  https://github.com/abseil/abseil-cpp\nprotobufï¼š https://github.com/protocolbuffers/protobuf\nfmt: https://github.com/fmtlib/fmt\nlibevent: https://libevent.org/\ngoogletest: https://github.com/google/googletest\n\nå…¶ä»–å­¦ä¹ èµ„æ–™\nhttps://godbolt.org/   ä¸€ä¸ªC++ è½¬ æ±‡ç¼–çš„å·¥å…·\nhttps://cppinsights.io/  å¯ä»¥çœ‹åˆ°ç¼–è¯‘å™¨ç¼–è¯‘åçš„ç»“æœ\nhttps://coliru.stacked-crooked.com/  å¯ä»¥è¿è¡Œc++ä»£ç \nhttps://gcc.gnu.org/onlinedocs\nC++å­¦ä¹ çš„ä¸€äº›ç½‘ç«™èµ„æ–™ï¼ˆç›´æ¥å»Githubæ‰¾ï¼‰\nhttps://en.cppreference.com/w/cpp/language  æ— è„‘æ¨èçš„ç™¾ç§‘å…¨ä¹¦\nhttps://oi-wiki.org/lang/csl/iterator/\nhttps://cntransgroup.github.io/EffectiveModernCppChinese/\nhttps://learn.microsoft.com/zh-cn/cpp/cpp/operator-overloading\n\n\n\n","categories":["C++"],"tags":["C++"]}]