<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>ThreadLocal | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/threadlocal/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>ThreadLocal</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-10-02</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/threadlocal/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/38zE8aaGQ3X/"
								class="tag">JUC</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">1811å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">8 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	<code>ThreadLocal</code>æ˜¯ä¸€ä¸ªçº¿ç¨‹å˜é‡å·¥å…·ç±»ã€‚ä¸»è¦ç”¨äºå°†ç§æœ‰çº¿ç¨‹å’Œè¯¥çº¿ç¨‹å­˜æ”¾çš„å‰¯æœ¬å¯¹è±¡åšä¸€ä¸ªæ˜ å°„ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´çš„å˜é‡äº’ä¸å¹²æ‰°ï¼Œä¾‹å¦‚Açº¿ç¨‹å’ŒBçº¿ç¨‹éƒ½æƒ³ä½¿ç”¨ä¸€ä¸ªå˜é‡,æ­¤æ—¶å°±å­˜åœ¨å¼ºèµ„æºçš„é—®é¢˜,è€Œè¿™ä¸ªå˜é‡ä»–å¯ä»¥æœ‰å¤šä»½,æ­¤æ—¶å°±å¯ä»¥ç”¨<code>ThreadLocal</code>ä½œä¸ºå˜é‡çš„ç®¡ç†è€… ,ä¸å­˜åœ¨å¤šçº¿ç¨‹éšæ‚£. åŒæ—¶ä»–éšå¼çš„å¯ä»¥ä½œä¸ºä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„ä¼ é€’ä¿¡æ¯çš„ä¸€ä¸ªå·¥å…· .</p>
<p>â€‹		<strong><code>ThreadLocal</code>ä»å¦ä¸€ä¸ªè§’åº¦æ¥è§£å†³çº¿ç¨‹çš„å¹¶å‘è®¿é—®</strong>ã€‚<strong><code>ThreadLocal</code>ä¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œéš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„è®¿é—®å†²çª</strong>ã€‚ä¾‹å¦‚åœ¨å¤šçº¿ç¨‹ä¸­éƒ½å»ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡,ä½†æ˜¯åˆå¸Œæœ›äº’ä¸å¹²æ¶‰,æ­¤æ—¶å°±éœ€è¦ç”¨åˆ°<code>ThreadLocal</code>.</p>
<p>æ¦‚æ‹¬èµ·æ¥è¯´ï¼Œå¯¹äºå¤šçº¿ç¨‹èµ„æºå…±äº«çš„é—®é¢˜ï¼ŒåŒæ­¥æœºåˆ¶é‡‡ç”¨äº†â€œä»¥æ—¶é—´æ¢ç©ºé—´â€çš„æ–¹å¼ï¼Œè€Œ<code>ThreadLocal</code>é‡‡ç”¨äº†â€œä»¥ç©ºé—´æ¢æ—¶é—´â€çš„æ–¹å¼ã€‚å‰è€…ä»…æä¾›ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®ï¼Œè€Œåè€…ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡ï¼Œå› æ­¤å¯ä»¥åŒæ—¶è®¿é—®è€Œäº’ä¸å½±å“ã€‚</p>
</blockquote>
<h2 id="1-å…¨å±€è§‚">1. å…¨å±€è§‚</h2>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-28/1d86e756-b877-4020-8f81-6b1f1bf9c59a.jpg?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç° æ¯ä¸€ä¸ª çº¿ç¨‹ éƒ½æœ‰ä¸€ä¸ª mapå¯¹è±¡ , mapå­˜æ”¾çš„æ˜¯æœ¬åœ°çº¿ç¨‹å¯¹è±¡å’Œå‰¯æœ¬å˜é‡ .ç„¶åè¿™ä¸ªmapå¯¹è±¡ç”±ä¸€ä¸ª threadlocalå¯¹è±¡ ç»´æŠ¤ ,ä»–è´Ÿè´£å»æ·»åŠ å’Œç»´æŠ¤</p>
<p>æ‰€ä»¥å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆäº†å‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
<p>ThreadLocal valuesä¸è¿™ä¸ªçº¿ç¨‹æœ‰å…³,è¿™ä¸ªmapè¢«è¿™ä¸ªthreadæ‰€ç»´æŠ¤</p>
<pre><code class="language-java">public class Thread implements Runnable {
    /* ThreadLocal values pertaining(å±äº) to this thread. This map is maintained(è¢«..ç»´æŠ¤)
     * by the ThreadLocal class. */
    ThreadLocal.ThreadLocalMap threadLocals = null;
}
</code></pre>
<h2 id="2-å¸¸ç”¨çš„æ–¹æ³•">2. å¸¸ç”¨çš„æ–¹æ³•</h2>
<p>1 . public T <strong>get</strong>()   è·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</p>
<p>2 . public void <strong>set</strong>(T value)    ä¿å­˜å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</p>
<p>3 .  public void <strong>remove</strong>()   ç§»é™¤å½“å‰å‰ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</p>
<p>4 . public static  ThreadLocal  <strong>withInitial</strong>(Supplier supplier) åˆå§‹åŒ–å˜é‡</p>
<h3 id="1-getæ–¹æ³•">1. getæ–¹æ³•</h3>
<blockquote>
<p>â€‹	Returns the value in the current thread's copy of this thread-local variable. If the variable has no value for the current thread, it is first initialized to the value returned by an invocation of the initialValue method.</p>
<p>â€‹	<strong>è¿”å›å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬ä¸­çš„å€¼ã€‚å¦‚æœå˜é‡æ²¡æœ‰å½“å‰çº¿ç¨‹çš„å€¼ï¼Œåˆ™é¦–å…ˆå°†å…¶åˆå§‹åŒ–ä¸ºè°ƒç”¨initialValueæ–¹æ³•è¿”å›çš„å€¼ã€‚</strong></p>
</blockquote>
<h3 id="2-setæ–¹æ³•">2. setæ–¹æ³•</h3>
<blockquote>
<p>â€‹	Sets the current thread's copy of this thread-local variable to the specified value. Most subclasses will have no need to override this method, relying solely on the initialValue method to set the values of thread-locals.</p>
<p>â€‹	<strong>å°†æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ã€‚å¤§å¤šæ•°å­ç±»ä¸éœ€è¦é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåªéœ€è¦ä¾èµ–initialValueæ–¹æ³•æ¥è®¾ç½®çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚</strong></p>
</blockquote>
<h3 id="3-removeæ–¹æ³•">3. removeæ–¹æ³•</h3>
<blockquote>
<p>â€‹	Removes the current thread's value for this thread-local variable. If this thread-local variable is subsequently read by the current thread, its value will be reinitialized by invoking its initialValue method, unless its value is set by the current thread in the interim. This may result in multiple invocations of the initialValue method in the current thread.</p>
<p><strong>1 . åˆ é™¤æ­¤çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ã€‚å¦‚æœè¿™ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡éšååˆè¢«è°ƒç”¨,é‚£ä¹ˆå®ƒçš„å€¼å°†é€šè¿‡è°ƒç”¨å…¶initialValueæ–¹æ³•é‡æ–°åˆå§‹åŒ–ï¼Œé™¤éå®ƒçš„å€¼æ˜¯ç”±å½“å‰çº¿ç¨‹åœ¨è¿‡æ¸¡æœŸé—´è®¾ç½®çš„ã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨å½“å‰çº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨initialValueæ–¹æ³•ã€‚</strong></p>
<p><strong>2 . è¿˜è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ ä¸remove ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼,æº¢å‡º,çœ‹ä½ çº¿ç¨‹æ¶ˆè€—å§,å›ºæœ‰çº¿ç¨‹éšæ„äº†,</strong></p>
</blockquote>
<h3 id="4-withinitial-æ–¹æ³•">4. withInitial æ–¹æ³•</h3>
<blockquote>
<p>â€‹	Creates a thread local variable. The initial value of the variable is determined by invoking the get method on the Supplier.</p>
<p><strong>åˆ›é€ ä¸€ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡ , é€šè¿‡è°ƒç”¨getæ–¹æ³•æ¥ç¡®å®šå˜é‡çš„åˆå§‹å€¼ã€‚</strong></p>
</blockquote>
<h2 id="3-ä½¿ç”¨åœºæ™¯">3. ä½¿ç”¨åœºæ™¯</h2>
<h3 id="1-çº¿ç¨‹æ± çš„ä½¿ç”¨">1. çº¿ç¨‹æ± çš„ä½¿ç”¨</h3>
<pre><code class="language-java">public class TestThreadLocal2 {

    private static ThreadLocal&lt;Connection&gt; threadLocal = new ThreadLocal&lt;&gt;();

    public static Connection getConnection(){
        Connection connection = threadLocal.get();
        if (null == connection) {
            connection = Datasource.get();
            threadLocal.set(connection);
        }
        return connection;
    }

    
    public static void remove(){
        threadLocal.remove();
    }



    public static void main(String[] args) throws InterruptedException {

        Executor executors = Executors.newFixedThreadPool(10);
        executors.execute(()-&gt;{
            System.out.println(getConnection());
        });
        executors.execute(()-&gt;{
            System.out.println(getConnection());
        });

        System.out.println(getConnection());
    }

    private static class Connection{
        String name;
        public Connection(String name) {
            this.name = name;
        }
    }

    private static class Datasource{
        static ArrayBlockingQueue&lt;Connection&gt; connections = new ArrayBlockingQueue&lt;Connection&gt;(5);

        static {
            connections.offer(new Connection(&quot;1&quot;));
            connections.offer(new Connection(&quot;2&quot;));
            connections.offer(new Connection(&quot;3&quot;));
            connections.offer(new Connection(&quot;4&quot;));
            connections.offer(new Connection(&quot;5&quot;));
        }

        static Connection get(){
            Connection connection =null;
            try {
                // ç§»é™¤å¹¶è¿”å›å¤´éƒ¨å…ƒç´  é˜»å¡æ“ä½œ
                connection = connections.take();
                // æŠŠç§»é™¤çš„å…ƒç´ å†æ·»åŠ å›å» æ¯”å¦‚ ä¸€å¼€å§‹æ˜¯ 1 2 3 4 5 ç°åœ¨ takeä¸€ä¸ªå˜æˆäº† 2 3 4 5 _ ç„¶åputå˜æˆäº† 2 3 4  5 1 .
                connections.put(connection);
            } catch (InterruptedException e) {
                System.out.println(&quot;çº¿ç¨‹é˜»å¡&quot;);
            }
            return connection;
        }
    }
}

</code></pre>
<h3 id="2-å†…éƒ¨å˜é‡çš„ä½¿ç”¨">2. å†…éƒ¨å˜é‡çš„ä½¿ç”¨</h3>
<pre><code class="language-java">public class MainTest {

    public static void main(String[] args) {
        ExecutorService pool = Executors.newFixedThreadPool(1000);

        // ä½¿ç”¨ ThreadLocal
        Bank bank = new Bank();
        IntStream.range(0, 3).forEach(e-&gt;{
            pool.execute(()-&gt;{
                bank.deposit(200,&quot;æ–°å‘˜å·¥ : &quot;+e);
            });
        });

        pool.shutdown();
    }
}

class Bank {
    // åˆå§‹åŒ–è´¦æˆ·ä½™é¢ä¸º 1000
    ThreadLocal&lt;Integer&gt; account = ThreadLocal.withInitial(() -&gt; 1000);

    public void deposit(int money,String name) {
        System.out.println(name + &quot;--å½“å‰è´¦æˆ·ä½™é¢ä¸ºï¼š&quot; + account.get());
        account.set(account.get() + money);
        System.out.println(name + &quot;--å­˜å…¥ &quot; + money + &quot; åè´¦æˆ·ä½™é¢ä¸ºï¼š&quot; + account.get());
        account.remove();
    }
}
</code></pre>
<p>è¾“å‡ºç»“æœ  :</p>
<pre><code class="language-java">æ–°å‘˜å·¥ : 0--å½“å‰è´¦æˆ·ä½™é¢ä¸ºï¼š1000
æ–°å‘˜å·¥ : 0--å­˜å…¥ 200 åè´¦æˆ·ä½™é¢ä¸ºï¼š1200
æ–°å‘˜å·¥ : 2--å½“å‰è´¦æˆ·ä½™é¢ä¸ºï¼š1000
æ–°å‘˜å·¥ : 2--å­˜å…¥ 200 åè´¦æˆ·ä½™é¢ä¸ºï¼š1200
æ–°å‘˜å·¥ : 1--å½“å‰è´¦æˆ·ä½™é¢ä¸ºï¼š1000
æ–°å‘˜å·¥ : 1--å­˜å…¥ 200 åè´¦æˆ·ä½™é¢ä¸ºï¼š1200
</code></pre>
<h3 id="3-æ—¥æœŸæ ¼å¼åŒ–å¹¶å‘é—®é¢˜">3.  æ—¥æœŸæ ¼å¼åŒ–å¹¶å‘é—®é¢˜</h3>
<pre><code class="language-java">public class DateUtil {

    private static ThreadLocal&lt;SimpleDateFormat&gt; sdf = ThreadLocal
            .withInitial(() -&gt; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;));

    // 
    public static String format(Date date) {
        String msg = null;
        try {
            // è°ƒç”¨getæ–¹æ³• -&gt; withInitialåˆå§‹åŒ– 
            msg = sdf.get().format(date);
        } finally {
            // ç”¨å®Œ remove 
            sdf.remove();
        }
        return msg;
    }


    public static String formatJava8(Date date){
        return LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));
    }

    public static void main(String[] args) throws Exception {
        System.err.println(format(new Date()));

        System.err.println(formatJava8(new Date()));
    }

}
</code></pre>
<h2 id="4-é—®é¢˜-threadlocalmap-entry">4 . é—®é¢˜: ThreadLocalMap - entry</h2>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-10-02/85530434-974c-42c8-908a-e4723265379c.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<pre><code class="language-java">static class Entry extends WeakReference&lt;ThreadLocal&gt; {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal k, Object v) {
        // åªæœ‰keyæ˜¯å¼±ç±»å‹å¼•ç”¨,valueå¹¶ä¸æ˜¯ , æ‰€ä»¥å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºçš„ç°è±¡,å¦‚æœä¸å»æ‰‹åŠ¨removeçš„è¯
        super(k);
        value = v;
    }
    
    .....
}
</code></pre>
<h2 id="5-ä½¿ç”¨æ³¨æ„çš„é—®é¢˜">5. ä½¿ç”¨æ³¨æ„çš„é—®é¢˜</h2>
<h4 id="threadlocalmapçš„é—®é¢˜">ThreadLocalMapçš„é—®é¢˜</h4>
<p>ç”±äºThreadLocalMapçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œè€ŒValueæ˜¯å¼ºå¼•ç”¨ã€‚è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼ŒThreadLocalåœ¨æ²¡æœ‰å¤–éƒ¨å¯¹è±¡å¼ºå¼•ç”¨æ—¶ï¼Œå‘ç”ŸGCæ—¶å¼±å¼•ç”¨Keyä¼šè¢«å›æ”¶ï¼Œè€ŒValueä¸ä¼šå›æ”¶ï¼Œå¦‚æœåˆ›å»ºThreadLocalçš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªEntryå¯¹è±¡ä¸­çš„valueå°±æœ‰å¯èƒ½ä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚</p>
<p><strong>å¦‚ä½•é¿å…æ³„æ¼</strong><br>
æ—¢ç„¶Keyæ˜¯å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦åšçš„äº‹ï¼Œå°±æ˜¯åœ¨è°ƒç”¨ThreadLocalçš„get()ã€set()æ–¹æ³•æ—¶å®Œæˆåå†è°ƒç”¨removeæ–¹æ³•ï¼Œå°†EntryèŠ‚ç‚¹å’ŒMapçš„å¼•ç”¨å…³ç³»ç§»é™¤ï¼Œè¿™æ ·æ•´ä¸ªEntryå¯¹è±¡åœ¨GC Rootsåˆ†æåå°±å˜æˆä¸å¯è¾¾äº†ï¼Œä¸‹æ¬¡GCçš„æ—¶å€™å°±å¯ä»¥è¢«å›æ”¶ã€‚</p>
<p>å¦‚æœä½¿ç”¨ThreadLocalçš„setæ–¹æ³•ä¹‹åï¼Œæ²¡æœ‰æ˜¾ç¤ºçš„è°ƒç”¨removeæ–¹æ³•ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œæ‰€ä»¥å…»æˆè‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ååˆ†é‡è¦ï¼Œä½¿ç”¨å®ŒThreadLocalä¹‹åï¼Œè®°å¾—è°ƒç”¨removeæ–¹æ³•ã€‚</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E5%85%A8%E5%B1%80%E8%A7%82">1. å…¨å±€è§‚</a></li>
<li><a href="#2-%E5%B8%B8%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95">2. å¸¸ç”¨çš„æ–¹æ³•</a>
<ul>
<li><a href="#1-get%E6%96%B9%E6%B3%95">1. getæ–¹æ³•</a></li>
<li><a href="#2-set%E6%96%B9%E6%B3%95">2. setæ–¹æ³•</a></li>
<li><a href="#3-remove%E6%96%B9%E6%B3%95">3. removeæ–¹æ³•</a></li>
<li><a href="#4-withinitial-%E6%96%B9%E6%B3%95">4. withInitial æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#3-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">3. ä½¿ç”¨åœºæ™¯</a>
<ul>
<li><a href="#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BD%BF%E7%94%A8">1. çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li>
<li><a href="#2-%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8">2. å†…éƒ¨å˜é‡çš„ä½¿ç”¨</a></li>
<li><a href="#3-%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98">3.  æ—¥æœŸæ ¼å¼åŒ–å¹¶å‘é—®é¢˜</a></li>
</ul>
</li>
<li><a href="#4-%E9%97%AE%E9%A2%98-threadlocalmap-entry">4 . é—®é¢˜: ThreadLocalMap - entry</a></li>
<li><a href="#5-%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98">5. ä½¿ç”¨æ³¨æ„çš„é—®é¢˜</a><br>
*
<ul>
<li><a href="#threadlocalmap%E7%9A%84%E9%97%AE%E9%A2%98">ThreadLocalMapçš„é—®é¢˜</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>