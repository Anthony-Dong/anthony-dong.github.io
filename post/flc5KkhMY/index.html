<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title> Java - I/Oä½“ç³»ä»åŸç†åˆ°åº”ç”¨ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/flc5KkhMY/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223360682" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a> Java - I/Oä½“ç³»ä»åŸç†åˆ°åº”ç”¨</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-01-30</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/flc5KkhMY/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/Vyew36Twpl/"
								class="tag">JavaåŸºç¡€</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">6378å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">25 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	æœ¬æ–‡ä»‹ç»<code>æ“ä½œç³»ç»ŸI/Oå·¥ä½œåŸç†</code>ï¼Œ<code>é›¶æ‹·è´çš„åŸç†</code>,<code>Java I/Oè®¾è®¡</code>ï¼Œ<code>åŸºæœ¬ä½¿ç”¨</code>ï¼Œ<code>å¼€æºé¡¹ç›®(Kafka,RocketMQ,Netty)ä¸­å®ç°é«˜æ€§èƒ½I/Oå¸¸è§æ–¹æ³•å’Œå®ç°</code>ï¼Œæ·±å…¥ç†è§£Javaçš„IOä½“ç³»</p>
</blockquote>
<h2 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</h2>
<p>åœ¨ä»‹ç»I/OåŸç†ä¹‹å‰ï¼Œå…ˆé‡æ¸©å‡ ä¸ªåŸºç¡€æ¦‚å¿µï¼š</p>
<ul>
<li><strong>(1) æ“ä½œç³»ç»Ÿä¸å†…æ ¸</strong></li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/d0b4ce09-7277-4f94-9736-003271ffd4fb.webp" alt="img" loading="lazy"></figure>
<p><strong>æ“ä½œç³»ç»Ÿ</strong>ï¼šç®¡ç†è®¡ç®—æœºç¡¬ä»¶ä¸è½¯ä»¶èµ„æºçš„ç³»ç»Ÿè½¯ä»¶<br>
<strong>å†…æ ¸</strong>ï¼šæ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒè½¯ä»¶ï¼Œè´Ÿè´£ç®¡ç†ç³»ç»Ÿçš„è¿›ç¨‹ã€å†…å­˜ã€è®¾å¤‡é©±åŠ¨ç¨‹åºã€æ–‡ä»¶å’Œç½‘ç»œç³»ç»Ÿç­‰ç­‰ï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›å¯¹è®¡ç®—æœºç¡¬ä»¶çš„å®‰å…¨è®¿é—®æœåŠ¡</p>
<ul>
<li><strong>2 å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</strong></li>
</ul>
<p>ä¸ºäº†é¿å…ç”¨æˆ·è¿›ç¨‹ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸å®‰å…¨ï¼Œæ“ä½œç³»ç»Ÿå°†å†…å­˜å¯»å€ç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<br>
<strong>å†…æ ¸ç©ºé—´ï¼ˆKernel-spaceï¼‰</strong>ï¼Œä¾›å†…æ ¸ç¨‹åºä½¿ç”¨<br>
<strong>ç”¨æˆ·ç©ºé—´ï¼ˆUser-spaceï¼‰</strong>ï¼Œä¾›ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨<br>
ä¸ºäº†å®‰å…¨ï¼Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿ç”¨æˆ·çš„ç¨‹åºå´©æºƒäº†ï¼Œå†…æ ¸ä¹Ÿä¸å—å½±å“</p>
<ul>
<li><strong>3 æ•°æ®æµ</strong></li>
</ul>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/e8859932-7711-4e13-be74-bbdb283f63c6.webp" alt="img" loading="lazy"></figure>
<p>è®¡ç®—æœºä¸­çš„æ•°æ®æ˜¯åŸºäºéšç€æ—¶é—´å˜æ¢é«˜ä½ç”µå‹ä¿¡å·ä¼ è¾“çš„ï¼Œè¿™äº›æ•°æ®ä¿¡å·è¿ç»­ä¸æ–­ï¼Œæœ‰ç€å›ºå®šçš„ä¼ è¾“æ–¹å‘ï¼Œç±»ä¼¼æ°´ç®¡ä¸­æ°´çš„æµåŠ¨ï¼Œå› æ­¤æŠ½è±¡æ•°æ®æµ(I/Oæµ)çš„æ¦‚å¿µï¼š<strong>æŒ‡ä¸€ç»„æœ‰é¡ºåºçš„ã€æœ‰èµ·ç‚¹å’Œç»ˆç‚¹çš„å­—èŠ‚é›†åˆ</strong>ï¼Œ</p>
<p>æŠ½è±¡å‡ºæ•°æ®æµçš„ä½œç”¨ï¼š<strong>å®ç°ç¨‹åºé€»è¾‘ä¸åº•å±‚ç¡¬ä»¶è§£è€¦</strong>ï¼Œé€šè¿‡å¼•å…¥æ•°æ®æµä½œä¸ºç¨‹åºä¸ç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„æŠ½è±¡å±‚ï¼Œé¢å‘é€šç”¨çš„æ•°æ®æµè¾“å…¥è¾“å‡ºæ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯å…·ä½“ç¡¬ä»¶ç‰¹æ€§ï¼Œç¨‹åºå’Œåº•å±‚ç¡¬ä»¶å¯ä»¥ç‹¬ç«‹çµæ´»æ›¿æ¢å’Œæ‰©å±•</p>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/a14c8889-89f0-4537-ba38-5c417684a735.webp" alt="img" loading="lazy"></figure>
<h2 id="io-å·¥ä½œåŸç†">I/O å·¥ä½œåŸç†</h2>
<h3 id="1-ç£ç›˜io">1. ç£ç›˜I/O</h3>
<p>å…¸å‹I/Oè¯»å†™ç£ç›˜å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/6834f5a6-015b-4cbc-8bd1-82113a41d4d6.webp" alt="img" loading="lazy"></figure>
<blockquote>
<p><strong>tips</strong>: DMAï¼šå…¨ç§°å«ç›´æ¥å†…å­˜å­˜å–ï¼ˆDirect Memory Accessï¼‰ï¼Œæ˜¯ä¸€ç§å…è®¸å¤–å›´è®¾å¤‡ï¼ˆç¡¬ä»¶å­ç³»ç»Ÿï¼‰ç›´æ¥è®¿é—®ç³»ç»Ÿä¸»å†…å­˜çš„æœºåˆ¶ã€‚åŸºäº DMA è®¿é—®æ–¹å¼ï¼Œç³»ç»Ÿä¸»å†…å­˜ä¸ç¡¬ä»¶è®¾å¤‡çš„æ•°æ®ä¼ è¾“å¯ä»¥çœå»CPU çš„å…¨ç¨‹è°ƒåº¦</p>
</blockquote>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>è¯»å†™æ“ä½œåŸºäºç³»ç»Ÿè°ƒç”¨å®ç°</li>
<li>è¯»å†™æ“ä½œç»è¿‡ç”¨æˆ·ç¼“å†²åŒºï¼Œå†…æ ¸ç¼“å†²åŒºï¼Œåº”ç”¨è¿›ç¨‹å¹¶ä¸èƒ½ç›´æ¥æ“ä½œç£ç›˜</li>
<li>åº”ç”¨è¿›ç¨‹è¯»æ“ä½œæ—¶éœ€é˜»å¡ç›´åˆ°è¯»å–åˆ°æ•°æ®</li>
</ul>
<h3 id="2-ç½‘ç»œio">2. ç½‘ç»œI/O</h3>
<p>è¿™é‡Œå…ˆä»¥æœ€ç»å…¸çš„é˜»å¡å¼I/Oæ¨¡å‹ä»‹ç»ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/4a53b71d-4f00-427b-ae51-c52fcfb7d810.webp" alt="img" loading="lazy"></figure>
<figure data-type="image" tabindex="6"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/15659eb4-51ef-4384-b590-86bd3f4cf0c4.webp" alt="img" loading="lazy"></figure>
<blockquote>
<p><strong>tips</strong>:recvfromï¼Œç»socketæ¥æ”¶æ•°æ®çš„å‡½æ•°</p>
</blockquote>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ç½‘ç»œI/Oè¯»å†™æ“ä½œç»è¿‡ç”¨æˆ·ç¼“å†²åŒºï¼ŒSokcetç¼“å†²åŒº</li>
<li>æœåŠ¡ç«¯çº¿ç¨‹åœ¨ä»è°ƒç”¨recvfromå¼€å§‹åˆ°å®ƒè¿”å›æœ‰æ•°æ®æŠ¥å‡†å¤‡å¥½è¿™æ®µæ—¶é—´æ˜¯é˜»å¡çš„ï¼Œrecvfromè¿”å›æˆåŠŸåï¼Œçº¿ç¨‹å¼€å§‹å¤„ç†æ•°æ®æŠ¥</li>
</ul>
<h2 id="java-ioè®¾è®¡">Java I/Oè®¾è®¡</h2>
<h3 id="1-ioåˆ†ç±»">1. I/Oåˆ†ç±»</h3>
<p>Javaä¸­å¯¹æ•°æ®æµè¿›è¡Œå…·ä½“åŒ–å’Œå®ç°ï¼Œå…³äºJavaæ•°æ®æµä¸€èˆ¬å…³æ³¨ä»¥ä¸‹å‡ ä¸ªç‚¹ï¼š</p>
<ul>
<li><strong>(1) æµçš„æ–¹å‘</strong><br>
ä»å¤–éƒ¨åˆ°ç¨‹åºï¼Œç§°ä¸º<strong>è¾“å…¥æµ</strong>ï¼›ä»ç¨‹åºåˆ°å¤–éƒ¨ï¼Œç§°ä¸º<strong>è¾“å‡ºæµ</strong></li>
<li><strong>(2) æµçš„æ•°æ®å•ä½</strong><br>
ç¨‹åºä»¥å­—èŠ‚ä½œä¸ºæœ€å°è¯»å†™æ•°æ®å•å…ƒï¼Œç§°ä¸º<strong>å­—èŠ‚æµ</strong>ï¼Œä»¥å­—ç¬¦ä½œä¸ºæœ€å°è¯»å†™æ•°æ®å•å…ƒï¼Œç§°ä¸º<strong>å­—ç¬¦æµ</strong></li>
<li><strong>(3) æµçš„åŠŸèƒ½è§’è‰²</strong></li>
</ul>
<figure data-type="image" tabindex="7"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/00e34c2d-e7e5-44b2-8b31-109d3ecd183c.webp" alt="img" loading="lazy"></figure>
<p>ä»/å‘ä¸€ä¸ªç‰¹å®šçš„IOè®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼Œç½‘ç»œï¼‰æˆ–è€…å­˜å‚¨å¯¹è±¡(å¦‚å†…å­˜æ•°ç»„)è¯»/å†™æ•°æ®çš„æµï¼Œç§°ä¸º<strong>èŠ‚ç‚¹æµ</strong>ï¼›<br>
å¯¹ä¸€ä¸ªå·²æœ‰æµè¿›è¡Œè¿æ¥å’Œå°è£…ï¼Œé€šè¿‡å°è£…åçš„æµæ¥å®ç°æ•°æ®çš„è¯»/å†™åŠŸèƒ½ï¼Œç§°ä¸º<strong>å¤„ç†æµ</strong>(æˆ–ç§°ä¸ºè¿‡æ»¤æµ)ï¼›</p>
<h3 id="2-ioæ“ä½œæ¥å£">2. I/Oæ“ä½œæ¥å£</h3>
<p>java.ioåŒ…ä¸‹æœ‰ä¸€å †I/Oæ“ä½œç±»ï¼Œåˆå­¦æ—¶çœ‹äº†å®¹æ˜“æä¸æ‡‚ï¼Œå…¶å®ä»”ç»†è§‚å¯Ÿå…¶ä¸­è¿˜æ˜¯æœ‰è§„å¾‹ï¼š<br>
è¿™äº›I/Oæ“ä½œç±»éƒ½æ˜¯åœ¨<strong>ç»§æ‰¿4ä¸ªåŸºæœ¬æŠ½è±¡æµçš„åŸºç¡€ä¸Šï¼Œè¦ä¹ˆæ˜¯èŠ‚ç‚¹æµï¼Œè¦ä¹ˆæ˜¯å¤„ç†æµ</strong></p>
<h4 id="21-å››ä¸ªåŸºæœ¬æŠ½è±¡æµ">2.1 å››ä¸ªåŸºæœ¬æŠ½è±¡æµ</h4>
<p>java.ioåŒ…ä¸­åŒ…å«äº†æµå¼I/Oæ‰€éœ€è¦çš„æ‰€æœ‰ç±»ï¼Œjava.ioåŒ…ä¸­æœ‰å››ä¸ªåŸºæœ¬æŠ½è±¡æµï¼Œåˆ†åˆ«å¤„ç†å­—èŠ‚æµå’Œå­—ç¬¦æµï¼š</p>
<ul>
<li>InputStream</li>
<li>OutputStream</li>
<li>Reader</li>
<li>Writer</li>
</ul>
<figure data-type="image" tabindex="8"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/229edfae-716a-4966-b47c-eebe90c26c12.webp" alt="img" loading="lazy"></figure>
<h4 id="22-èŠ‚ç‚¹æµ">2.2 èŠ‚ç‚¹æµ</h4>
<figure data-type="image" tabindex="9"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/380a7b24-92ca-4009-9ff1-610fa45792de.webp" alt="img" loading="lazy"></figure>
<p>èŠ‚ç‚¹æµI/Oç±»åç”±èŠ‚ç‚¹æµç±»å‹ + æŠ½è±¡æµç±»å‹ç»„æˆï¼Œå¸¸è§èŠ‚ç‚¹ç±»å‹æœ‰ï¼š</p>
<ul>
<li>Fileæ–‡ä»¶</li>
<li>Piped è¿›ç¨‹å†…çº¿ç¨‹é€šä¿¡ç®¡é“</li>
<li>ByteArray / CharArray (å­—èŠ‚æ•°ç»„ / å­—ç¬¦æ•°ç»„)</li>
<li>StringBuffer / String (å­—ç¬¦ä¸²ç¼“å†²åŒº / å­—ç¬¦ä¸²)</li>
</ul>
<p>èŠ‚ç‚¹æµçš„åˆ›å»ºé€šå¸¸æ˜¯åœ¨æ„é€ å‡½æ•°ä¼ å…¥æ•°æ®æºï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-cpp">FileReader reader = new FileReader(new File(&quot;file.txt&quot;));
FileWriter writer = new FileWriter(new File(&quot;file.txt&quot;));
</code></pre>
<h4 id="23-å¤„ç†æµ">2.3 å¤„ç†æµ</h4>
<figure data-type="image" tabindex="10"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/a187b032-9e71-4931-9c26-29d9d2233cf3.webp" alt="img" loading="lazy"></figure>
<p>å¤„ç†æµI/Oç±»åç”±å¯¹å·²æœ‰æµå°è£…çš„åŠŸèƒ½ + æŠ½è±¡æµç±»å‹ç»„æˆï¼Œå¸¸è§åŠŸèƒ½æœ‰ï¼š</p>
<ul>
<li><strong>ç¼“å†²</strong>ï¼šå¯¹èŠ‚ç‚¹æµè¯»å†™çš„æ•°æ®æä¾›äº†ç¼“å†²çš„åŠŸèƒ½ï¼Œæ•°æ®å¯ä»¥åŸºäºç¼“å†²æ‰¹é‡è¯»å†™ï¼Œæé«˜æ•ˆç‡ã€‚å¸¸è§æœ‰BufferedInputStreamã€BufferedOutputStream</li>
<li><strong>å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦æµ</strong>ï¼šç”±InputStreamReaderã€OutputStreamWriterå®ç°</li>
<li><strong>å­—èŠ‚æµä¸åŸºæœ¬ç±»å‹æ•°æ®ç›¸äº’è½¬æ¢</strong>ï¼šè¿™é‡ŒåŸºæœ¬æ•°æ®ç±»å‹æ•°æ®å¦‚intã€longã€shortï¼Œç”±DataInputStreamã€DataOutputStreamå®ç°</li>
<li><strong>å­—èŠ‚æµä¸å¯¹è±¡å®ä¾‹ç›¸äº’è½¬æ¢</strong>ï¼šç”¨äºå®ç°å¯¹è±¡åºåˆ—åŒ–ï¼Œç”±ObjectInputStreamã€ObjectOutputStreamå®ç°</li>
</ul>
<p>å¤„ç†æµçš„åº”ç”¨äº†é€‚é…å™¨/è£…é¥°æ¨¡å¼ï¼Œè½¬æ¢/æ‰©å±•å·²æœ‰æµï¼Œå¤„ç†æµçš„åˆ›å»ºé€šå¸¸æ˜¯åœ¨æ„é€ å‡½æ•°ä¼ å…¥å·²æœ‰çš„èŠ‚ç‚¹æµæˆ–å¤„ç†æµï¼š</p>
<pre><code class="language-csharp">FileOutputStream fileOutputStream = new FileOutputStream(&quot;file.txt&quot;);
// æ‰©å±•æä¾›ç¼“å†²å†™
BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(fileOutputStream);
 // æ‰©å±•æä¾›æä¾›åŸºæœ¬æ•°æ®ç±»å‹å†™
DataOutputStream out = new DataOutputStream(bufferedOutputStream);
</code></pre>
<h3 id="3-java-nio">3. Java NIO</h3>
<h4 id="31-æ ‡å‡†ioå­˜åœ¨é—®é¢˜">3.1 æ ‡å‡†I/Oå­˜åœ¨é—®é¢˜</h4>
<p>Java NIO(New I/O)æ˜¯ä¸€ä¸ªå¯ä»¥æ›¿ä»£æ ‡å‡†Java I/O APIçš„IO API(ä»Java 1.4å¼€å§‹)ï¼ŒJava NIOæä¾›äº†ä¸æ ‡å‡†I/Oä¸åŒçš„I/Oå·¥ä½œæ–¹å¼ï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³æ ‡å‡† I/Oå­˜åœ¨çš„ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><strong>(1) æ•°æ®å¤šæ¬¡æ‹·è´</strong></li>
</ul>
<p>æ ‡å‡†I/Oå¤„ç†ï¼Œå®Œæˆä¸€æ¬¡å®Œæ•´çš„æ•°æ®è¯»å†™ï¼Œè‡³å°‘éœ€è¦ä»åº•å±‚ç¡¬ä»¶è¯»åˆ°å†…æ ¸ç©ºé—´ï¼Œå†è¯»åˆ°ç”¨æˆ·æ–‡ä»¶ï¼Œåˆä»ç”¨æˆ·ç©ºé—´å†™å…¥å†…æ ¸ç©ºé—´ï¼Œå†å†™å…¥åº•å±‚ç¡¬ä»¶</p>
<p>æ­¤å¤–ï¼Œåº•å±‚é€šè¿‡writeã€readç­‰å‡½æ•°è¿›è¡ŒI/Oç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œéœ€è¦ä¼ å…¥æ•°æ®æ‰€åœ¨ç¼“å†²åŒº<strong>èµ·å§‹åœ°å€å’Œé•¿åº¦</strong><br>
ç”±äºJVM GCçš„å­˜åœ¨ï¼Œå¯¼è‡´å¯¹è±¡åœ¨å †ä¸­çš„ä½ç½®å¾€å¾€ä¼šå‘ç”Ÿç§»åŠ¨ï¼Œç§»åŠ¨åä¼ å…¥ç³»ç»Ÿå‡½æ•°çš„åœ°å€å‚æ•°å°±ä¸æ˜¯çœŸæ­£çš„ç¼“å†²åŒºåœ°å€äº†</p>
<p>å¯èƒ½å¯¼è‡´è¯»å†™å‡ºé”™ï¼Œä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä½¿ç”¨æ ‡å‡†I/Oè¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿˜ä¼šé¢å¤–å¯¼è‡´ä¸€æ¬¡æ•°æ®æ‹·è´ï¼šæŠŠæ•°æ®ä»JVMçš„å †å†…æ‹·è´åˆ°å †å¤–çš„è¿ç»­ç©ºé—´å†…å­˜(å †å¤–å†…å­˜)</p>
<p>æ‰€ä»¥æ€»å…±ç»å†6æ¬¡æ•°æ®æ‹·è´ï¼Œæ‰§è¡Œæ•ˆç‡è¾ƒä½</p>
<figure data-type="image" tabindex="11"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/cfd1dc3a-fb0d-4b06-b3d9-c8ad3ee812ce.webp" alt="img" loading="lazy"></figure>
<ul>
<li><strong>(2) æ“ä½œé˜»å¡</strong></li>
</ul>
<p>ä¼ ç»Ÿçš„ç½‘ç»œI/Oå¤„ç†ä¸­ï¼Œç”±äºè¯·æ±‚å»ºç«‹è¿æ¥(connect)ï¼Œè¯»å–ç½‘ç»œI/Oæ•°æ®(read)ï¼Œå‘é€æ•°æ®(send)ç­‰æ“ä½œæ˜¯çº¿ç¨‹é˜»å¡çš„</p>
<pre><code class="language-java">// ç­‰å¾…è¿æ¥
Socket socket = serverSocket.accept();

// è¿æ¥å·²å»ºç«‹ï¼Œè¯»å–è¯·æ±‚æ¶ˆæ¯
StringBuilder req = new StringBuilder();
byte[] recvByteBuf = new byte[1024];
int len;
while ((len = socket.getInputStream().read(recvByteBuf)) != -1) {
    req.append(new String(recvByteBuf, 0, len, StandardCharsets.UTF_8));
}

// å†™å…¥è¿”å›æ¶ˆæ¯
socket.getOutputStream().write((&quot;server response msg&quot;.getBytes()));
socket.shutdownOutput();
</code></pre>
<p>ä»¥ä¸Šé¢æœåŠ¡ç«¯ç¨‹åºä¸ºä¾‹ï¼Œå½“è¯·æ±‚è¿æ¥å·²å»ºç«‹ï¼Œè¯»å–è¯·æ±‚æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯è°ƒç”¨readæ–¹æ³•æ—¶ï¼Œå®¢æˆ·ç«¯æ•°æ®å¯èƒ½è¿˜æ²¡å°±ç»ª(ä¾‹å¦‚å®¢æˆ·ç«¯æ•°æ®è¿˜åœ¨å†™å…¥ä¸­æˆ–è€…ä¼ è¾“ä¸­)ï¼Œçº¿ç¨‹éœ€è¦åœ¨readæ–¹æ³•é˜»å¡ç­‰å¾…ç›´åˆ°æ•°æ®å°±ç»ª</p>
<p>ä¸ºäº†å®ç°æœåŠ¡ç«¯å¹¶å‘å“åº”ï¼Œæ¯ä¸ªè¿æ¥éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å•ç‹¬å¤„ç†ï¼Œå½“å¹¶å‘è¯·æ±‚é‡å¤§æ—¶ä¸ºäº†ç»´æŠ¤è¿æ¥ï¼Œå†…å­˜ã€çº¿ç¨‹åˆ‡æ¢å¼€é”€è¿‡å¤§</p>
<figure data-type="image" tabindex="12"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/bc81146e-0032-4f8b-8cfc-87ba734ecfdd.webp" alt="img" loading="lazy"></figure>
<h4 id="32-buffer">3.2 Buffer</h4>
<p><strong>Java NIOæ ¸å¿ƒä¸‰å¤§æ ¸å¿ƒç»„ä»¶æ˜¯Buffer(ç¼“å†²åŒº)ã€Channel(é€šé“)ã€Selector</strong></p>
<p>Bufferæä¾›äº†å¸¸ç”¨äºI/Oæ“ä½œçš„å­—èŠ‚ç¼“å†²åŒºï¼Œå¸¸è§çš„ç¼“å­˜åŒºæœ‰ByteBuffer, CharBuffer, DoubleBuffer, FloatBuffer, IntBuffer, LongBuffer, ShortBufferï¼Œåˆ†åˆ«å¯¹åº”åŸºæœ¬æ•°æ®ç±»å‹: byte, char, double, float, int, long, shortï¼Œä¸‹é¢ä»‹ç»ä¸»è¦ä»¥æœ€å¸¸ç”¨çš„ByteBufferä¸ºä¾‹ï¼ŒBufferåº•å±‚æ”¯æŒJavaå †å†…(HeapByteBuffer)æˆ–å †å¤–å†…å­˜(DirectByteBuffer)</p>
<p><strong>å †å¤–å†…å­˜</strong>æ˜¯æŒ‡ä¸å †å†…å­˜ç›¸å¯¹åº”çš„ï¼ŒæŠŠå†…å­˜å¯¹è±¡åˆ†é…åœ¨JVMå †ä»¥å¤–çš„å†…å­˜ï¼Œè¿™äº›å†…å­˜ç›´æ¥å—æ“ä½œç³»ç»Ÿç®¡ç†ï¼ˆè€Œä¸æ˜¯è™šæ‹Ÿæœº)ï¼Œç›¸æ¯”å †å†…å†…å­˜ï¼ŒI/Oæ“ä½œä¸­ä½¿ç”¨å †å¤–å†…å­˜çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ul>
<li>ä¸ç”¨è¢«JVM GCçº¿å›æ”¶ï¼Œå‡å°‘GCçº¿ç¨‹èµ„æºå æœ‰</li>
<li>åœ¨I/Oç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œç›´æ¥æ“ä½œå †å¤–å†…å­˜ï¼Œå¯ä»¥èŠ‚çœå †å¤–å†…å­˜å’Œå †å†…å†…å­˜çš„å¤åˆ¶æˆæœ¬</li>
</ul>
<p>ByteBufferåº•å±‚å †å¤–å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾åŸºäºmallocå’Œfreeå‡½æ•°ï¼Œå¯¹å¤–allocateDirectæ–¹æ³•å¯ä»¥ç”³è¯·åˆ†é…å †å¤–å†…å­˜ï¼Œå¹¶è¿”å›ç»§æ‰¿ByteBufferç±»çš„DirectByteBufferå¯¹è±¡ï¼š</p>
<pre><code class="language-cpp">public static ByteBuffer allocateDirect(int capacity) {
    return new DirectByteBuffer(capacity);
}
</code></pre>
<p>å †å¤–å†…å­˜çš„å›æ”¶åŸºäºDirectByteBufferçš„æˆå‘˜å˜é‡Cleanerç±»ï¼Œæä¾›cleanæ–¹æ³•å¯ä»¥ç”¨äºä¸»åŠ¨å›æ”¶ï¼ŒNettyä¸­å¤§éƒ¨åˆ†å †å¤–å†…å­˜é€šè¿‡è®°å½•å®šä½Cleanerçš„å­˜åœ¨ï¼Œä¸»åŠ¨è°ƒç”¨cleanæ–¹æ³•æ¥å›æ”¶ï¼›<br>
å¦å¤–ï¼Œå½“DirectByteBufferå¯¹è±¡è¢«GCæ—¶ï¼Œå…³è”çš„å †å¤–å†…å­˜ä¹Ÿä¼šè¢«å›æ”¶</p>
<blockquote>
<p><strong>tips</strong>: JVMå‚æ•°ä¸å»ºè®®è®¾ç½®-XX:+DisableExplicitGCï¼Œå› ä¸ºéƒ¨åˆ†ä¾èµ–Java NIOçš„æ¡†æ¶(ä¾‹å¦‚Netty)åœ¨å†…å­˜å¼‚å¸¸è€—å°½æ—¶ï¼Œä¼šä¸»åŠ¨è°ƒç”¨System.gc()ï¼Œè§¦å‘Full GCï¼Œå›æ”¶DirectByteBufferå¯¹è±¡ï¼Œä½œä¸ºå›æ”¶å †å¤–å†…å­˜çš„æœ€åä¿éšœæœºåˆ¶ï¼Œè®¾ç½®è¯¥å‚æ•°ä¹‹åä¼šå¯¼è‡´åœ¨è¯¥æƒ…å†µä¸‹å †å¤–å†…å­˜å¾—ä¸åˆ°æ¸…ç†</p>
</blockquote>
<p>å †å¤–å†…å­˜åŸºäºåŸºç¡€ByteBufferç±»çš„DirectByteBufferç±»æˆå‘˜å˜é‡ï¼šCleanerå¯¹è±¡ï¼Œè¿™ä¸ªCleanerå¯¹è±¡ä¼šåœ¨åˆé€‚çš„æ—¶å€™æ‰§è¡Œunsafe.freeMemory(address)ï¼Œä»è€Œå›æ”¶è¿™å—å †å¤–å†…å­˜</p>
<p>Bufferå¯ä»¥è§åˆ°ç†è§£ä¸ºä¸€ç»„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå­˜å‚¨åœ°å€è¿ç»­çš„çš„æ•°ç»„ï¼Œæ”¯æŒè¯»å†™æ“ä½œï¼Œå¯¹åº”è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ï¼Œé€šè¿‡å‡ ä¸ªå˜é‡æ¥ä¿å­˜è¿™ä¸ªæ•°æ®çš„å½“å‰ä½ç½®çŠ¶æ€ï¼šcapacityã€ positionã€ limitï¼š</p>
<ul>
<li>capacity ç¼“å†²åŒºæ•°ç»„çš„æ€»é•¿åº¦</li>
<li>position ä¸‹ä¸€ä¸ªè¦æ“ä½œçš„æ•°æ®å…ƒç´ çš„ä½ç½®</li>
<li>limit ç¼“å†²åŒºæ•°ç»„ä¸­ä¸å¯æ“ä½œçš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼šlimit &lt;= capacity</li>
</ul>
<figure data-type="image" tabindex="13"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/2f1dcb23-0d96-4296-9fcf-5ea24573e5c1.webp" alt="img" loading="lazy"></figure>
<h4 id="33-channel">3.3 Channel</h4>
<p>Channel(é€šé“)çš„æ¦‚å¿µå¯ä»¥ç±»æ¯”I/Oæµå¯¹è±¡ï¼ŒNIOä¸­I/Oæ“ä½œä¸»è¦åŸºäºChannelï¼š<br>
ä»Channelè¿›è¡Œæ•°æ®è¯»å– ï¼šåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œç„¶åè¯·æ±‚Channelè¯»å–æ•°æ®<br>
ä»Channelè¿›è¡Œæ•°æ®å†™å…¥ ï¼šåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¡«å……æ•°æ®ï¼Œè¯·æ±‚Channelå†™å…¥æ•°æ®</p>
<p>Channelå’Œæµéå¸¸ç›¸ä¼¼ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹åŒºåˆ«ï¼š</p>
<ul>
<li>Channelå¯ä»¥è¯»å’Œå†™ï¼Œè€Œæ ‡å‡†I/Oæµæ˜¯å•å‘çš„</li>
<li>Channelå¯ä»¥å¼‚æ­¥è¯»å†™ï¼Œæ ‡å‡†I/Oæµéœ€è¦çº¿ç¨‹é˜»å¡ç­‰å¾…ç›´åˆ°è¯»å†™æ“ä½œå®Œæˆ</li>
<li>Channelæ€»æ˜¯åŸºäºç¼“å†²åŒºBufferè¯»å†™</li>
</ul>
<p>Java NIOä¸­æœ€é‡è¦çš„å‡ ä¸ªChannelçš„å®ç°ï¼š</p>
<ul>
<li>FileChannelï¼š ç”¨äºæ–‡ä»¶çš„æ•°æ®è¯»å†™ï¼ŒåŸºäºFileChannelæä¾›çš„æ–¹æ³•èƒ½å‡å°‘è¯»å†™æ–‡ä»¶æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œåé¢ä¼šä»‹ç»</li>
<li>DatagramChannelï¼š ç”¨äºUDPçš„æ•°æ®è¯»å†™</li>
<li>SocketChannelï¼š ç”¨äºTCPçš„æ•°æ®è¯»å†™ï¼Œä»£è¡¨å®¢æˆ·ç«¯è¿æ¥</li>
<li>ServerSocketChannel: ç›‘å¬TCPè¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚ä¼šåˆ›å»ºä¼šä¸€ä¸ªSocketChannelï¼Œä¸€èˆ¬ç”¨äºæœåŠ¡ç«¯</li>
</ul>
<p>åŸºäºæ ‡å‡†I/Oä¸­ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ­¥å¯èƒ½è¦åƒä¸‹é¢è¿™æ ·è·å–è¾“å…¥æµï¼ŒæŒ‰å­—èŠ‚æŠŠç£ç›˜ä¸Šçš„æ•°æ®è¯»å–åˆ°ç¨‹åºä¸­ï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè€Œåœ¨NIOç¼–ç¨‹ä¸­ï¼Œéœ€è¦å…ˆè·å–Channelï¼Œå†è¿›è¡Œè¯»å†™</p>
<pre><code class="language-java">FileInputStream fileInputStream = new FileInputStream(&quot;test.txt&quot;);
FileChannel channel = fileInputStream.channel();
</code></pre>
<blockquote>
<p><strong>tips</strong>: FileChannelä»…èƒ½è¿è¡Œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œæ–‡ä»¶å¼‚æ­¥å¤„ç†çš„ I/O æ˜¯åœ¨JDK 1.7 æ‰è¢«åŠ å…¥çš„ java.nio.channels.AsynchronousFileChannel</p>
</blockquote>
<p>ä¸€ä¸‹ä»£ç æ˜¯ä¸€æ®µNIOçš„ä»£ç . ä¼ ç»Ÿçš„NIOæ¶‰åŠåˆ°å¤§é‡çš„ç©ºè½¬é—®é¢˜. å¦‚æœä¸è®¾ç½®ä¸ºnio, é‚£ä¹ˆå’Œbioåˆæœ‰å•¥åŒºåˆ«å‘¢. æ‰€ä»¥éœ€è¦å¼•å…¥åç»­çš„selectoræ¨¡å‹.</p>
<pre><code class="language-java">public static void main(String[] args) throws IOException {
    // 1. åˆå§‹åŒ–
    ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
    serverSocketChannel.bind(new InetSocketAddress(10086));
    // 2. NIOä¹ˆ. å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡. ä¹Ÿå°±æ˜¯acceptæ–¹æ³•ä¸ä¼šé˜»å¡. å¦‚æœä¸è®¾ç½®,é»˜è®¤æ˜¯ acceptæ–¹æ³•ä¼šä¸€ç›´é˜»å¡åˆ°æœ‰æ•°æ®è¿”å›.
    serverSocketChannel.configureBlocking(false);
    while (true) {
        // 3. å»ç›‘å¬è¿æ¥æ—¶é—´.
        SocketChannel socketChannel = serverSocketChannel.accept();
        if (socketChannel != null) {
            // 4.è®¾ç½®è¯»å†™éé˜»å¡.  å¦‚æœä¸è®¾ç½®. readæ–¹æ³•å°±æ˜¯é˜»å¡çš„.ä¼šä¸€ç›´ç­‰å¾…åˆ°è¯»å–åˆ°æ•°æ®.
            socketChannel.configureBlocking(false);

            // 5. é‚£åå»è¯»å–.æ˜¾ç„¶è¿™ä¸ªæ˜¯è¯»å–ä¸åˆ°çš„.å› ä¸ºéé˜»å¡ä¸‹,ä¸å¯èƒ½è¿™ä¹ˆå¿«æ“ä½œ,è¿æ¥å»ºç«‹å¥½,ä½ å°±å¯ä»¥å‘é€æ¶ˆæ¯äº†.
            ByteBuffer buffer = ByteBuffer.allocate(20);
            int n = socketChannel.read(buffer);
            System.out.printf(&quot;receive : %s\n&quot;, new String(buffer.array(), 0, n, StandardCharsets.UTF_8));

            // 6. å‘é€æ¶ˆæ¯
            buffer.clear();
            buffer.put(String.format(&quot;å½“å‰æ—¶é—´:%s.&quot;, new Date()).getBytes());
            buffer.flip();
            socketChannel.write(buffer);

            // 7. å…³é—­è¿æ¥
            socketChannel.close();
        }
    }
}
</code></pre>
<h4 id="34-selector">3.4 Selector</h4>
<p>Selector(é€‰æ‹©å™¨) ï¼Œå®ƒæ˜¯Java NIOæ ¸å¿ƒç»„ä»¶ä¸­çš„ä¸€ä¸ªï¼Œç”¨äºæ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªNIO Channelï¼ˆé€šé“ï¼‰çš„çŠ¶æ€æ˜¯å¦å¤„äºå¯è¯»ã€å¯å†™ã€‚å®ç°å•çº¿ç¨‹ç®¡ç†å¤šä¸ªChannelï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç®¡ç†å¤šä¸ªç½‘ç»œè¿æ¥</p>
<p>Selectoræ ¸å¿ƒåœ¨äºåŸºäºæ“ä½œç³»ç»Ÿæä¾›çš„I/Oå¤ç”¨åŠŸèƒ½ï¼Œå•ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶ç›‘è§†å¤šä¸ªè¿æ¥æè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªè¿æ¥å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œï¼Œå¸¸è§æœ‰selectã€pollã€epollç­‰ä¸åŒå®ç°</p>
<figure data-type="image" tabindex="14"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/adad4e2b-d453-4d57-98ee-370ec773569c.webp" alt="img" loading="lazy"></figure>
<figure data-type="image" tabindex="15"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/ca8290f3-1c83-444a-be48-6eebacfbc0ca.webp" alt="img" loading="lazy"></figure>
<p>Java NIO SelectoråŸºæœ¬å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>(1) åˆå§‹åŒ–Selectorå¯¹è±¡ï¼ŒæœåŠ¡ç«¯ServerSocketChannelå¯¹è±¡</li>
<li>(2) å‘Selectoræ³¨å†ŒServerSocketChannelçš„socket-acceptäº‹ä»¶</li>
<li>(3) çº¿ç¨‹é˜»å¡äºselector.select()ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯ï¼Œçº¿ç¨‹é€€å‡ºé˜»å¡</li>
<li>(4) åŸºäºselectorè·å–æ‰€æœ‰å°±ç»ªäº‹ä»¶ï¼Œæ­¤æ—¶å…ˆè·å–åˆ°socket-acceptäº‹ä»¶ï¼Œå‘Selectoræ³¨å†Œå®¢æˆ·ç«¯SocketChannelçš„æ•°æ®å°±ç»ªå¯è¯»äº‹ä»¶äº‹ä»¶</li>
<li>(5) çº¿ç¨‹å†æ¬¡é˜»å¡äºselector.select()ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ•°æ®å°±ç»ªï¼Œå¯è¯»</li>
<li>(6) åŸºäºByteBufferè¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼Œç„¶åå†™å…¥å“åº”æ•°æ®ï¼Œå…³é—­channel</li>
</ul>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ªNIOç¼–ç¨‹æ¨¡å‹çš„æ¨¡æ¿. ä¸€èˆ¬éƒ½æ˜¯ . ä¸Šè¯‰é‚£æ®µä»£ç è™½ç„¶æ˜¯NIOä½†æ˜¯, ä»–ä¾ç„¶æ˜¯é˜»å¡</p>
<pre><code class="language-java">// å¼€å¯ä¸€ä¸ªselector
Selector selector = Selector.open();

// å¼€å¯ä¸€ä¸ªServerSocketChannel
ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
serverSocketChannel.bind(new InetSocketAddress(10086));
// é…ç½®é€šé“ä¸ºéé˜»å¡æ¨¡å¼,ä¹Ÿå°±æ˜¯acceptæ–¹æ³•ä¸é˜»å¡äº†. 
serverSocketChannel.configureBlocking(false);

// æ³¨å†ŒæœåŠ¡ç«¯çš„socket-acceptäº‹ä»¶ , ä»£è¡¨çš„æ„æ€å°±æ˜¯ç›‘å¬ServerSocketChannelçš„acceptäº‹ä»¶
serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);

// æ­»å¾ªç¯,ä¸æ–­è½®è¯¢
while (true) {
    // è¿™ä¸ªåœ°æ–¹æ˜¯ä¸€ä¸ªç½‘ç»œæ¨¡å‹, æœ‰select,poll,epoll.é»˜è®¤å¹¶ä¸æ˜¯epoll,è€Œæ˜¯selector,éœ€è¦å¼•å…¥epollçœ‹æˆ‘ä¸‹é¢å›¾ç‰‡æœ‰. selectoræ¨¡å‹å…¶å®æ˜¯ä¸€ç§ reactoræ¨¡å‹. å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´, ä»–ä½œä¸ºä¸€ä¸ªå‘å¸ƒè€…. è€Œæˆ‘ä»¬ä½œä¸ºä¸€ä¸ªè®¢é˜…è€…. å»è®¢é˜…ç›¸å…³çš„äº‹ä»¶. å½“æˆ‘ä»¬è°ƒç”¨ selectæ–¹æ³•ä¼šè¿”å›ç»™æˆ‘ä»¬å…·ä½“ç›¸åº”çš„äº‹ä»¶.è¿™ç§æ¨¡å¼å…¶å®ä¹Ÿå¹¶ä¸æ˜¯ä¼ ç»Ÿçš„reactoræ¨¡å‹.å¯ä»¥é¿å…reactoræ¨¡å‹ä¸­çš„èƒŒå‹ç°è±¡(æœ‰ç‚¹åƒç”Ÿäº§è€…,æ¶ˆè´¹è€…æ¨¡å‹).
    // selector.select()ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰channelç›¸å…³æ“ä½œå°±ç»ª .åŒæ—¶å¯èƒ½å‡ºç°NIOçš„BUG.è‡ªè¡Œç™¾åº¦. è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤š.
    selector.select();
    
    // SelectionKeyå…³è”çš„channeléƒ½æœ‰å°±ç»ªäº‹ä»¶
    Iterator&lt;SelectionKey&gt; keyIterator = selector.selectedKeys().iterator();

    // éå†.
    while (keyIterator.hasNext()) {
        SelectionKey key = keyIterator.next();
        // æœåŠ¡ç«¯socket-accept, è¿™é‡Œå¦‚æœé€šè¿‡, é‚£ä¹ˆacceptä¸€å®šæ‹¿åˆ°äº†å¯¹è±¡.ä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆ.
        if (key.isAcceptable()) {
            // è·å–å®¢æˆ·ç«¯è¿æ¥çš„channel,ç”±äºæ­¤æ—¶å·²ç»ç›‘å¬åˆ°è¿æ¥äº‹ä»¶,æ‰€ä»¥ä¸ä¼šé˜»å¡
            SocketChannel clientSocketChannel = serverSocketChannel.accept();
            // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼,è¿™é‡Œçš„æ„æ€æ˜¯è¯»å†™æ“ä½œä¸é˜»å¡,æ— è®ºæœ‰æ²¡æœ‰æ•°æ®.æ¯”å¦‚å¯ä»¥é˜²æ­¢ä¸Šè¯‰ä¾‹å­ä»£ç ä¸­é—®é¢˜(2)
            clientSocketChannel.configureBlocking(false);
            // æ³¨å†Œç›‘å¬è¯¥å®¢æˆ·ç«¯channelå¯è¯»äº‹ä»¶ï¼Œå¹¶ä¸ºchannelå…³è”æ–°åˆ†é…çš„buffer,è¿™ä¸ªbufferå¯ä»¥é€šè¿‡`key.attachment()`è·å– attachmentæ˜¯é™„ä»¶çš„æ„æ€
            clientSocketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocateDirect(1024));
        }

        // channelå¯è¯»
        if (key.isReadable()) {
            SocketChannel socketChannel = (SocketChannel) key.channel();
            ByteBuffer buf = (ByteBuffer) key.attachment();

            int bytesRead;
            StringBuilder reqMsg = new StringBuilder();
            while ((bytesRead = socketChannel.read(buf)) &gt; 0) {
                // ä»bufå†™æ¨¡å¼åˆ‡æ¢ä¸ºè¯»æ¨¡å¼
                buf.flip();
                int bufRemain = buf.remaining();
                byte[] bytes = new byte[bufRemain];
                buf.get(bytes, 0, bytesRead);
                // è¿™é‡Œå½“æ•°æ®åŒ…å¤§äºbyteBufferé•¿åº¦ï¼Œæœ‰å¯èƒ½æœ‰ç²˜åŒ…/æ‹†åŒ…é—®é¢˜
                reqMsg.append(new String(bytes, StandardCharsets.UTF_8));
                buf.clear();
            }
            System.out.println(&quot;æœåŠ¡ç«¯æ”¶åˆ°æŠ¥æ–‡ï¼š&quot; + reqMsg.toString());
            if (bytesRead == -1) {
                byte[] bytes = &quot;[è¿™æ˜¯æœåŠ¡å›çš„æŠ¥æ–‡çš„æŠ¥æ–‡]&quot;.getBytes(StandardCharsets.UTF_8);

                int length;
                for (int offset = 0; offset &lt; bytes.length; offset += length) {
                    length = Math.min(buf.capacity(), bytes.length - offset);
                    buf.clear();
                    buf.put(bytes, offset, length);
                    buf.flip();
                    socketChannel.write(buf);
                }
                socketChannel.close();
            }
        }
        // Selectorä¸ä¼šè‡ªå·±ä»å·²selectedKeysä¸­ç§»é™¤SelectionKeyå®ä¾‹
        // å¿…é¡»åœ¨å¤„ç†å®Œé€šé“æ—¶è‡ªå·±ç§»é™¤,å…¶å®å°±æ˜¯é‡Šæ”¾å†…å­˜.
        keyIterator.remove();
    }
}
</code></pre>
<blockquote>
<p><strong>tips</strong>: Java NIOåŸºäºSelectorå®ç°é«˜æ€§èƒ½ç½‘ç»œI/Oè¿™å—ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œä½¿ç”¨ä¸å‹å¥½ï¼Œä¸€èˆ¬ä¸šç•Œä½¿ç”¨åŸºäºJava NIOè¿›è¡Œå°è£…ä¼˜åŒ–ï¼Œæ‰©å±•ä¸°å¯ŒåŠŸèƒ½çš„Nettyæ¡†æ¶æ¥ä¼˜é›…å®ç°</p>
</blockquote>
<p>å…³äºå¼•å…¥epoll å¤šè·¯å¤ç”¨æ¨¡å‹  , å°±æ˜¯ä¸€ä¸‹å‚æ•°äº†.</p>
<figure data-type="image" tabindex="16"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-20-22/594b080f-b042-4756-a362-b7120ff0436d.png" alt="" loading="lazy"></figure>
<p>å…³äºNIOçš„BUG , æˆ‘<a href="https://anthony-dong.gitee.io/post/y9LbqHqhJ/">è¿™ç¯‡æ–‡ç« </a>é‡Œå†™äº†, å¦‚ä½•è§£å†³æ­¤é—®é¢˜ :  <a href="https://anthony-dong.gitee.io/post/y9LbqHqhJ/">https://anthony-dong.gitee.io/post/y9LbqHqhJ/</a></p>
<p>æ·±å…¥ç†è§£ä¸Šè¯‰çš„ä¸¤æ®µä»£ç  ,å¯¹ä½ çš„NIOæ¨¡å‹çš„ç†è§£æœ‰å¾ˆå¤§çš„å¸®åŠ©.</p>
<h2 id="é«˜æ€§èƒ½ioä¼˜åŒ–">é«˜æ€§èƒ½I/Oä¼˜åŒ–</h2>
<p>ä¸‹é¢ç»“åˆä¸šç•Œçƒ­é—¨å¼€æºé¡¹ç›®ä»‹ç»é«˜æ€§èƒ½I/Oçš„ä¼˜åŒ–</p>
<h3 id="1-é›¶æ‹·è´">1. é›¶æ‹·è´</h3>
<p>é›¶æ‹·è´(zero copy)æŠ€æœ¯ï¼Œç”¨äºåœ¨æ•°æ®è¯»å†™ä¸­å‡å°‘ç”šè‡³å®Œå…¨é¿å…ä¸å¿…è¦çš„CPUæ‹·è´ï¼Œå‡å°‘å†…å­˜å¸¦å®½çš„å ç”¨ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œé›¶æ‹·è´æœ‰å‡ ç§ä¸åŒçš„å®ç°åŸç†ï¼Œä¸‹é¢ä»‹ç»å¸¸è§å¼€æºé¡¹ç›®ä¸­é›¶æ‹·è´å®ç°</p>
<h4 id="11-kafkaé›¶æ‹·è´">1.1 Kafkaé›¶æ‹·è´</h4>
<p>KafkaåŸºäºLinux 2.1å†…æ ¸æä¾›ï¼Œå¹¶åœ¨2.4 å†…æ ¸æ”¹è¿›çš„çš„sendfileå‡½æ•° + ç¡¬ä»¶æä¾›çš„DMA Gather Copyå®ç°é›¶æ‹·è´ï¼Œå°†æ–‡ä»¶é€šè¿‡socketä¼ é€</p>
<p>å‡½æ•°é€šè¿‡ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å®Œæˆäº†æ–‡ä»¶çš„ä¼ é€ï¼Œå‡å°‘äº†åŸæ¥read/writeæ–¹å¼çš„æ¨¡å¼åˆ‡æ¢ã€‚åŒæ—¶å‡å°‘äº†æ•°æ®çš„copy, sendfileçš„è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="17"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/9e1195b6-14af-4067-a576-777ccad5a1e2.webp" alt="img" loading="lazy"></figure>
<p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>(1) ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨</li>
<li>(2) å†…æ ¸åŸºäºDMA Copyå°†æ–‡ä»¶æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒº</li>
<li>(3) å†…æ ¸å°†å†…æ ¸ç¼“å†²åŒºä¸­çš„æ–‡ä»¶æè¿°ä¿¡æ¯(æ–‡ä»¶æè¿°ç¬¦ï¼Œæ•°æ®é•¿åº¦)æ‹·è´åˆ°Socketç¼“å†²åŒº</li>
<li>(4) å†…æ ¸åŸºäºSocketç¼“å†²åŒºä¸­çš„æ–‡ä»¶æè¿°ä¿¡æ¯å’ŒDMAç¡¬ä»¶æä¾›çš„Gather CopyåŠŸèƒ½å°†å†…æ ¸ç¼“å†²åŒºæ•°æ®å¤åˆ¶åˆ°ç½‘å¡</li>
<li>(5) ç”¨æˆ·è¿›ç¨‹sendfileç³»ç»Ÿè°ƒç”¨å®Œæˆå¹¶è¿”å›</li>
</ul>
<p>ç›¸æ¯”ä¼ ç»Ÿçš„I/Oæ–¹å¼ï¼Œsendfile + DMA Gather Copyæ–¹å¼å®ç°çš„é›¶æ‹·è´ï¼Œæ•°æ®æ‹·è´æ¬¡æ•°ä»4æ¬¡é™ä¸º2æ¬¡ï¼Œç³»ç»Ÿè°ƒç”¨ä»2æ¬¡é™ä¸º1æ¬¡ï¼Œç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ä»4æ¬¡å˜æˆ2æ¬¡DMA Copyï¼Œå¤§å¤§æé«˜å¤„ç†æ•ˆç‡</p>
<p>Kafkaåº•å±‚åŸºäºjava.nioåŒ…ä¸‹çš„FileChannelçš„transferToï¼š</p>
<pre><code class="language-csharp">public abstract long transferTo(long position, long count, WritableByteChannel target)
</code></pre>
<p>transferToå°†FileChannelå…³è”çš„æ–‡ä»¶å‘é€åˆ°æŒ‡å®šchannelï¼Œå½“Comsumeræ¶ˆè´¹æ•°æ®ï¼ŒKafka ServeråŸºäºFileChannelå°†æ–‡ä»¶ä¸­çš„æ¶ˆæ¯æ•°æ®å‘é€åˆ°SocketChannel</p>
<h4 id="12-rocketmqé›¶æ‹·è´">1.2 RocketMQé›¶æ‹·è´</h4>
<p>RocketMQåŸºäºmmap + writeçš„æ–¹å¼å®ç°é›¶æ‹·è´ï¼š<br>
mmap() å¯ä»¥å°†å†…æ ¸ä¸­ç¼“å†²åŒºçš„åœ°å€ä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºè¿›è¡Œæ˜ å°„ï¼Œå®ç°æ•°æ®å…±äº«ï¼Œçœå»äº†å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</p>
<pre><code class="language-c">tmp_buf = mmap(file, len); 
write(socket, tmp_buf, len);
</code></pre>
<figure data-type="image" tabindex="18"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/d24d6c6a-147f-43d9-8b29-f652a395eb4c.png" alt="img" loading="lazy"></figure>
<p>mmap + write å®ç°é›¶æ‹·è´çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>(1) ç”¨æˆ·è¿›ç¨‹å‘å†…æ ¸å‘èµ·ç³»ç»Ÿmmapè°ƒç”¨</li>
<li>(2) å°†ç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å­˜åŒºè¿›è¡Œå†…å­˜åœ°å€æ˜ å°„</li>
<li>(3) å†…æ ¸åŸºäºDMA Copyå°†æ–‡ä»¶æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒº</li>
<li>(4) ç”¨æˆ·è¿›ç¨‹mmapç³»ç»Ÿè°ƒç”¨å®Œæˆå¹¶è¿”å›</li>
<li>(5) ç”¨æˆ·è¿›ç¨‹å‘å†…æ ¸å‘èµ·writeç³»ç»Ÿè°ƒç”¨</li>
<li>(6) å†…æ ¸åŸºäºCPU Copyå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°Socketç¼“å†²åŒº</li>
<li>(7) å†…æ ¸åŸºäºDMA Copyå°†æ•°æ®ä»Socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡</li>
<li>(8) ç”¨æˆ·è¿›ç¨‹writeç³»ç»Ÿè°ƒç”¨å®Œæˆå¹¶è¿”å›</li>
</ul>
<p>RocketMQä¸­æ¶ˆæ¯åŸºäºmmapå®ç°å­˜å‚¨å’ŒåŠ è½½çš„é€»è¾‘å†™åœ¨org.apache.rocketmq.store.MappedFileä¸­ï¼Œå†…éƒ¨å®ç°åŸºäºnioæä¾›çš„java.nio.MappedByteBufferï¼ŒåŸºäºFileChannelçš„mapæ–¹æ³•å¾—åˆ°mmapçš„ç¼“å†²åŒºï¼š</p>
<pre><code class="language-java">// åˆå§‹åŒ–
this.fileChannel = new RandomAccessFile(this.file, &quot;rw&quot;).getChannel();
this.mappedByteBuffer = this.fileChannel.map(MapMode.READ_WRITE, 0, fileSize);
</code></pre>
<p>æŸ¥è¯¢CommitLogçš„æ¶ˆæ¯æ—¶ï¼ŒåŸºäºmappedByteBufferåç§»é‡posï¼Œæ•°æ®å¤§å°sizeæŸ¥è¯¢ï¼š</p>
<pre><code class="language-cpp">public SelectMappedBufferResult selectMappedBuffer(int pos, int size) {
    int readPosition = getReadPosition();
    // ...å„ç§å®‰å…¨æ ¡éªŒ
    
    // è¿”å›mappedByteBufferè§†å›¾
    ByteBuffer byteBuffer = this.mappedByteBuffer.slice();
    byteBuffer.position(pos);
    ByteBuffer byteBufferNew = byteBuffer.slice();
    byteBufferNew.limit(size);
    return new SelectMappedBufferResult(this.fileFromOffset + pos, byteBufferNew, size, this);
}
</code></pre>
<blockquote>
<p><strong>tips: transientStorePoolEnableæœºåˆ¶</strong><br>
Java NIO mmapçš„éƒ¨åˆ†å†…å­˜å¹¶ä¸æ˜¯å¸¸é©»å†…å­˜ï¼Œå¯ä»¥è¢«ç½®æ¢åˆ°äº¤æ¢å†…å­˜(è™šæ‹Ÿå†…å­˜)ï¼ŒRocketMQä¸ºäº†æé«˜æ¶ˆæ¯å‘é€çš„æ€§èƒ½ï¼Œå¼•å…¥äº†å†…å­˜é”å®šæœºåˆ¶ï¼Œå³å°†æœ€è¿‘éœ€è¦æ“ä½œçš„CommitLogæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œå¹¶æä¾›å†…å­˜é”å®šåŠŸèƒ½ï¼Œç¡®ä¿è¿™äº›æ–‡ä»¶å§‹ç»ˆå­˜åœ¨å†…å­˜ä¸­ï¼Œè¯¥æœºåˆ¶çš„æ§åˆ¶å‚æ•°å°±æ˜¯transientStorePoolEnable</p>
</blockquote>
<p>å› æ­¤ï¼ŒMappedFileæ•°æ®ä¿å­˜CommitLogåˆ·ç›˜æœ‰2ç§æ–¹å¼ï¼š</p>
<ul>
<li>1 å¼€å¯transientStorePoolEnableï¼šå†™å…¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer)  -&gt; ä»å†…å­˜å­—èŠ‚ç¼“å†²åŒº(writeBuffer)æäº¤(commit)åˆ°æ–‡ä»¶é€šé“(fileChannel)  -&gt; æ–‡ä»¶é€šé“(fileChannel) -&gt; flushåˆ°ç£ç›˜</li>
<li>2 æœªå¼€å¯transientStorePoolEnableï¼šå†™å…¥æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer) -&gt; æ˜ å°„æ–‡ä»¶å­—èŠ‚ç¼“å†²åŒº(mappedByteBuffer) -&gt; flushåˆ°ç£ç›˜</li>
</ul>
<p>RocketMQ åŸºäº mmap+write å®ç°é›¶æ‹·è´ï¼Œé€‚ç”¨äºä¸šåŠ¡çº§æ¶ˆæ¯è¿™ç§å°å—æ–‡ä»¶çš„æ•°æ®æŒä¹…åŒ–å’Œä¼ è¾“<br>
Kafka åŸºäº sendfile è¿™ç§é›¶æ‹·è´æ–¹å¼ï¼Œé€‚ç”¨äºç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯è¿™ç§é«˜ååé‡çš„å¤§å—æ–‡ä»¶çš„æ•°æ®æŒä¹…åŒ–å’Œä¼ è¾“</p>
<blockquote>
<p><strong>tips:</strong> Kafka çš„ç´¢å¼•æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ mmap+write æ–¹å¼ï¼Œæ•°æ®æ–‡ä»¶å‘é€ç½‘ç»œä½¿ç”¨çš„æ˜¯ sendfile æ–¹å¼</p>
</blockquote>
<h4 id="13-nettyé›¶æ‹·è´">1.3 Nettyé›¶æ‹·è´</h4>
<p>Netty çš„é›¶æ‹·è´åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>1 åŸºäºæ“ä½œç³»ç»Ÿå®ç°çš„é›¶æ‹·è´ï¼Œåº•å±‚åŸºäºFileChannelçš„transferToæ–¹æ³•</li>
<li>2 åŸºäºJava å±‚æ“ä½œä¼˜åŒ–ï¼Œå¯¹æ•°ç»„ç¼“å­˜å¯¹è±¡(ByteBuf )è¿›è¡Œå°è£…ä¼˜åŒ–ï¼Œé€šè¿‡å¯¹ByteBufæ•°æ®å»ºç«‹æ•°æ®è§†å›¾ï¼Œæ”¯æŒByteBuf å¯¹è±¡åˆå¹¶ï¼Œåˆ‡åˆ†ï¼Œå½“åº•å±‚ä»…ä¿ç•™ä¸€ä»½æ•°æ®å­˜å‚¨ï¼Œå‡å°‘ä¸å¿…è¦æ‹·è´</li>
</ul>
<h3 id="2-å¤šè·¯å¤ç”¨">2. å¤šè·¯å¤ç”¨</h3>
<p>Nettyä¸­å¯¹Java NIOåŠŸèƒ½å°è£…ä¼˜åŒ–ä¹‹åï¼Œå®ç°I/Oå¤šè·¯å¤ç”¨ä»£ç ä¼˜é›…äº†å¾ˆå¤šï¼š</p>
<pre><code class="language-java">// åˆ›å»ºmainReactor
NioEventLoopGroup boosGroup = new NioEventLoopGroup();
// åˆ›å»ºå·¥ä½œçº¿ç¨‹ç»„
NioEventLoopGroup workerGroup = new NioEventLoopGroup();

final ServerBootstrap serverBootstrap = new ServerBootstrap();
serverBootstrap 
     // ç»„è£…NioEventLoopGroup 
    .group(boosGroup, workerGroup)
     // è®¾ç½®channelç±»å‹ä¸ºNIOç±»å‹
    .channel(NioServerSocketChannel.class)
    // è®¾ç½®è¿æ¥é…ç½®å‚æ•°
    .option(ChannelOption.SO_BACKLOG, 1024)
    .childOption(ChannelOption.SO_KEEPALIVE, true)
    .childOption(ChannelOption.TCP_NODELAY, true)
    // é…ç½®å…¥ç«™ã€å‡ºç«™äº‹ä»¶handler
    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() {
        @Override
        protected void initChannel(NioSocketChannel ch) {
            // é…ç½®å…¥ç«™ã€å‡ºç«™äº‹ä»¶channel
            ch.pipeline().addLast(...);
            ch.pipeline().addLast(...);
        }
    });

// ç»‘å®šç«¯å£
int port = 8080;
serverBootstrap.bind(port).addListener(future -&gt; {
    if (future.isSuccess()) {
        System.out.println(new Date() + &quot;: ç«¯å£[&quot; + port + &quot;]ç»‘å®šæˆåŠŸ!&quot;);
    } else {
        System.err.println(&quot;ç«¯å£[&quot; + port + &quot;]ç»‘å®šå¤±è´¥!&quot;);
    }
});
</code></pre>
<h3 id="3-é¡µç¼“å­˜pagecache">3. é¡µç¼“å­˜(PageCache)</h3>
<p>é¡µç¼“å­˜ï¼ˆPageCache)æ˜¯æ“ä½œç³»ç»Ÿå¯¹æ–‡ä»¶çš„ç¼“å­˜ï¼Œç”¨æ¥å‡å°‘å¯¹ç£ç›˜çš„ I/O æ“ä½œï¼Œä»¥é¡µä¸ºå•ä½çš„ï¼Œå†…å®¹å°±æ˜¯ç£ç›˜ä¸Šçš„ç‰©ç†å—ï¼Œé¡µç¼“å­˜èƒ½å¸®åŠ©<strong>ç¨‹åºå¯¹æ–‡ä»¶è¿›è¡Œé¡ºåºè¯»å†™çš„é€Ÿåº¦å‡ ä¹æ¥è¿‘äºå†…å­˜çš„è¯»å†™é€Ÿåº¦</strong>ï¼Œä¸»è¦åŸå› å°±æ˜¯ç”±äºOSä½¿ç”¨PageCacheæœºåˆ¶å¯¹è¯»å†™è®¿é—®æ“ä½œè¿›è¡Œäº†æ€§èƒ½ä¼˜åŒ–ï¼š</p>
<p><strong>é¡µç¼“å­˜è¯»å–ç­–ç•¥</strong>ï¼šå½“è¿›ç¨‹å‘èµ·ä¸€ä¸ªè¯»æ“ä½œ ï¼ˆæ¯”å¦‚ï¼Œè¿›ç¨‹å‘èµ·ä¸€ä¸ª read() ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œå®ƒé¦–å…ˆä¼šæ£€æŸ¥éœ€è¦çš„æ•°æ®æ˜¯å¦åœ¨é¡µç¼“å­˜ä¸­ï¼š</p>
<ul>
<li>å¦‚æœåœ¨ï¼Œåˆ™æ”¾å¼ƒè®¿é—®ç£ç›˜ï¼Œè€Œç›´æ¥ä»é¡µç¼“å­˜ä¸­è¯»å–</li>
<li>å¦‚æœä¸åœ¨ï¼Œåˆ™å†…æ ¸è°ƒåº¦å— I/O æ“ä½œä»ç£ç›˜å»è¯»å–æ•°æ®ï¼Œå¹¶è¯»å…¥ç´§éšå…¶åçš„å°‘æ•°å‡ ä¸ªé¡µé¢ï¼ˆä¸å°‘äºä¸€ä¸ªé¡µé¢ï¼Œé€šå¸¸æ˜¯ä¸‰ä¸ªé¡µé¢ï¼‰ï¼Œç„¶åå°†æ•°æ®æ”¾å…¥é¡µç¼“å­˜ä¸­</li>
</ul>
<figure data-type="image" tabindex="19"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/8cfc5ede-d467-4a9c-bcf2-4be0a9a0f4cf.webp" alt="img" loading="lazy"></figure>
<p><strong>é¡µç¼“å­˜å†™ç­–ç•¥</strong>ï¼šå½“è¿›ç¨‹å‘èµ·writeç³»ç»Ÿè°ƒç”¨å†™æ•°æ®åˆ°æ–‡ä»¶ä¸­ï¼Œå…ˆå†™åˆ°é¡µç¼“å­˜ï¼Œç„¶åæ–¹æ³•è¿”å›ã€‚æ­¤æ—¶æ•°æ®è¿˜æ²¡æœ‰çœŸæ­£çš„ä¿å­˜åˆ°æ–‡ä»¶ä¸­å»ï¼ŒLinux ä»…ä»…å°†é¡µç¼“å­˜ä¸­çš„è¿™ä¸€é¡µæ•°æ®æ ‡è®°ä¸ºâ€œè„â€ï¼Œå¹¶ä¸”è¢«åŠ å…¥åˆ°è„é¡µé“¾è¡¨ä¸­</p>
<p>ç„¶åï¼Œç”±flusher å›å†™çº¿ç¨‹å‘¨æœŸæ€§å°†è„é¡µé“¾è¡¨ä¸­çš„é¡µå†™åˆ°ç£ç›˜ï¼Œè®©ç£ç›˜ä¸­çš„æ•°æ®å’Œå†…å­˜ä¸­ä¿æŒä¸€è‡´ï¼Œæœ€åæ¸…ç†â€œè„â€æ ‡è¯†ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè„é¡µä¼šè¢«å†™å›ç£ç›˜:</p>
<ul>
<li>ç©ºé—²å†…å­˜ä½äºä¸€ä¸ªç‰¹å®šé˜ˆå€¼</li>
<li>è„é¡µåœ¨å†…å­˜ä¸­é©»ç•™è¶…è¿‡ä¸€ä¸ªç‰¹å®šçš„é˜ˆå€¼æ—¶</li>
<li>å½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ sync() å’Œ fsync() ç³»ç»Ÿè°ƒç”¨æ—¶</li>
</ul>
<p>RocketMQä¸­ï¼ŒConsumeQueueé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨çš„æ•°æ®è¾ƒå°‘ï¼Œå¹¶ä¸”æ˜¯é¡ºåºè¯»å–ï¼Œåœ¨page cacheæœºåˆ¶çš„é¢„è¯»å–ä½œç”¨ä¸‹ï¼ŒConsume Queueæ–‡ä»¶çš„è¯»æ€§èƒ½å‡ ä¹æ¥è¿‘è¯»å†…å­˜ï¼Œå³ä½¿åœ¨æœ‰æ¶ˆæ¯å †ç§¯æƒ…å†µä¸‹ä¹Ÿä¸ä¼šå½±å“æ€§èƒ½ï¼Œæä¾›äº†2ç§æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥ï¼š</p>
<ul>
<li>åŒæ­¥åˆ·ç›˜ï¼šåœ¨æ¶ˆæ¯çœŸæ­£æŒä¹…åŒ–è‡³ç£ç›˜åRocketMQçš„Brokerç«¯æ‰ä¼šçœŸæ­£è¿”å›ç»™Producerç«¯ä¸€ä¸ªæˆåŠŸçš„ACKå“åº”</li>
<li>å¼‚æ­¥åˆ·ç›˜ï¼Œèƒ½å……åˆ†åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„PageCacheçš„ä¼˜åŠ¿ï¼Œåªè¦æ¶ˆæ¯å†™å…¥PageCacheå³å¯å°†æˆåŠŸçš„ACKè¿”å›ç»™Producerç«¯ã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨åå°å¼‚æ­¥çº¿ç¨‹æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œé™ä½äº†è¯»å†™å»¶è¿Ÿï¼Œæé«˜äº†MQçš„æ€§èƒ½å’Œååé‡</li>
</ul>
<p>Kafkaå®ç°æ¶ˆæ¯é«˜æ€§èƒ½è¯»å†™ä¹Ÿåˆ©ç”¨äº†é¡µç¼“å­˜ï¼Œè¿™é‡Œä¸å†å±•å¼€</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p>ã€Šæ·±å…¥ç†è§£Linuxå†…æ ¸ â€”â€” Daniel P.Bovetã€‹</p>
<p><a href="https://links.jianshu.com/go?to=http%3A%2F%2Fcalvin1978.blogcn.com%2Farticles%2Fdirectbytebuffer.html">Nettyä¹‹Javaå †å¤–å†…å­˜æ‰«ç›²è´´ â€”â€”æ±Ÿå—ç™½è¡£</a></p>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fc9tkrokcDQR375kiwCeV9w">Java NIOï¼Ÿçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†ï¼ â€”â€”æœ±å°å® </a></p>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.kunzhao.org%2Fblog%2F2018%2F03%2F12%2Frocketmq-message-store-flow">RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹ â€”â€”  Zhao Kun(èµµå¤)</a></p>
<p><a href="https://www.jianshu.com/p/6681bfa36c4f">ä¸€æ–‡ç†è§£Nettyæ¨¡å‹æ¶æ„ â€”â€”caison</a></p>
<h2 id="æ–‡ç« å¼•ç”¨">æ–‡ç« å¼•ç”¨</h2>
<p><a href="https://www.jianshu.com/p/27466ac569d2">å¼•ç”¨è‡ª-æ–‡ç« é“¾æ¥</a>  https://www.jianshu.com/p/27466ac569d2 æ˜¯ä¸ªå¤§ä½¬ , å€¼å¾—å…³æ³¨</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">åŸºç¡€æ¦‚å¿µ</a></li>
<li><a href="#io-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">I/O å·¥ä½œåŸç†</a>
<ul>
<li><a href="#1-%E7%A3%81%E7%9B%98io">1. ç£ç›˜I/O</a></li>
<li><a href="#2-%E7%BD%91%E7%BB%9Cio">2. ç½‘ç»œI/O</a></li>
</ul>
</li>
<li><a href="#java-io%E8%AE%BE%E8%AE%A1">Java I/Oè®¾è®¡</a>
<ul>
<li><a href="#1-io%E5%88%86%E7%B1%BB">1. I/Oåˆ†ç±»</a></li>
<li><a href="#2-io%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3">2. I/Oæ“ä½œæ¥å£</a>
<ul>
<li><a href="#21-%E5%9B%9B%E4%B8%AA%E5%9F%BA%E6%9C%AC%E6%8A%BD%E8%B1%A1%E6%B5%81">2.1 å››ä¸ªåŸºæœ¬æŠ½è±¡æµ</a></li>
<li><a href="#22-%E8%8A%82%E7%82%B9%E6%B5%81">2.2 èŠ‚ç‚¹æµ</a></li>
<li><a href="#23-%E5%A4%84%E7%90%86%E6%B5%81">2.3 å¤„ç†æµ</a></li>
</ul>
</li>
<li><a href="#3-java-nio">3. Java NIO</a>
<ul>
<li><a href="#31-%E6%A0%87%E5%87%86io%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98">3.1 æ ‡å‡†I/Oå­˜åœ¨é—®é¢˜</a></li>
<li><a href="#32-buffer">3.2 Buffer</a></li>
<li><a href="#33-channel">3.3 Channel</a></li>
<li><a href="#34-selector">3.4 Selector</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E9%AB%98%E6%80%A7%E8%83%BDio%E4%BC%98%E5%8C%96">é«˜æ€§èƒ½I/Oä¼˜åŒ–</a>
<ul>
<li><a href="#1-%E9%9B%B6%E6%8B%B7%E8%B4%9D">1. é›¶æ‹·è´</a>
<ul>
<li><a href="#11-kafka%E9%9B%B6%E6%8B%B7%E8%B4%9D">1.1 Kafkaé›¶æ‹·è´</a></li>
<li><a href="#12-rocketmq%E9%9B%B6%E6%8B%B7%E8%B4%9D">1.2 RocketMQé›¶æ‹·è´</a></li>
<li><a href="#13-netty%E9%9B%B6%E6%8B%B7%E8%B4%9D">1.3 Nettyé›¶æ‹·è´</a></li>
</ul>
</li>
<li><a href="#2-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">2. å¤šè·¯å¤ç”¨</a></li>
<li><a href="#3-%E9%A1%B5%E7%BC%93%E5%AD%98pagecache">3. é¡µç¼“å­˜(PageCache)</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83">å‚è€ƒ</a></li>
<li><a href="#%E6%96%87%E7%AB%A0%E5%BC%95%E7%94%A8">æ–‡ç« å¼•ç”¨</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>