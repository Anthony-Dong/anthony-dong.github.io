<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>NIO - Buffer &amp; Selector &amp; Channel | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/nio-xue-xi-chi-xu-geng-xin-zhong/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223299317" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>NIO - Buffer &amp; Selector &amp; Channel</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-09-23</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/nio-xue-xi-chi-xu-geng-xin-zhong/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/Vyew36Twpl/"
								class="tag">JavaåŸºç¡€</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2361å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">11 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<h2 id="1-è®¤è¯†nio">1. è®¤è¯†NIO</h2>
<h3 id="11-nioçš„åå­—æ˜¯ä»€ä¹ˆ">1.1  nioçš„åå­—æ˜¯ä»€ä¹ˆ?</h3>
<p>â€‹		æœ‰äº›äººç§°ä¸º <strong>NEW IO</strong> ,è¿˜æœ‰ä¸€äº›äººå«åš <strong>NOBLOCKING IO</strong> , å…¶å®å°±æˆ‘è®¤ä¸ºä»–æ˜¯ç«™åœ¨ä¸¤ä¸ªè§’åº¦å»çœ‹å¾…è¿™ä¸ªé—®é¢˜çš„,å› ä¸ºä»jdkçš„æºç å»çœ‹ nioä½äº java.nioåŒ…ä¸‹,ä¸ä¹‹å¯¹ç«‹çš„æ˜¯ java.io åŒ…,æ‰€ä»¥æ­¤æ—¶ä»å®˜æ–¹çš„è§’åº¦å°±æ˜¯ NEW IO , ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ javaä¸­ io åˆ†ä¸ºä¸‰ç§ :    BIO , NIO , AIO ,å…¶ä¸­æˆ‘ä¸å»åšè§£é‡Šäº† , å…´è¶£è€…ç™¾åº¦ , åå­—ä¸é‡è¦ ,é‡è¦çš„æ˜¯ç†è§£ .</p>
<h3 id="12-åˆæ­¥è®¤è¯†nioçš„ç¼–ç¨‹">1.2 åˆæ­¥è®¤è¯†NIOçš„ç¼–ç¨‹</h3>
<p>â€‹		æˆ‘è®¤ä¸ºå­¦ä¹  nio æ²¡å¿…è¦ç›´æ¥ è¿›è¡Œ nioç¼–ç¨‹ , ç†è§£æ‰æœ€ä¸ºé‡è¦ , ç›´æ¥æ¨¡ä»¿åˆ«äººçš„ä»£ç åªèƒ½è®©ä½ æ„Ÿè§‰ä½ ä¸çŸ¥é“ä½ åœ¨åšå•¥. æ‰€ä»¥æˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥èµ·æ­¥æ…¢æ…¢å­¦ä¹ å§.</p>
<pre><code>	å…¶ä¸­å®ƒåŒ…å«äº†ä¸‰ä¸ªæ¦‚å¿µ , ä¸€ä¸ªæ˜¯ selector ,ä¸€ä¸ªæ˜¯ channel ,è¿˜æœ‰å°±æ˜¯ buffer ,æˆ‘ä»¬æ‹¿ ä¸€å¼ å›¾å»è§£é‡Š .
</code></pre>
<p>â€‹		<img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-16/db9aa2dc-66d9-4e9c-ac88-29c7cad570c5.png?x-oss-process=style/template01" alt="" loading="lazy"></p>
<p>å…¶ä¸­è¿™ä¸‰ä¸ªå¯¹è±¡ æ˜¯ nio ç¼–ç¨‹ä¸­ <strong>æœ€ä¸ºæ ¸å¿ƒçš„ä¸‰ä¸ªè§’è‰²</strong> æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç‰¢è®° è¿™ä¸‰ä¸ªè§’è‰².</p>
<h3 id="13-è®¤è¯†-buffer">1.3 è®¤è¯† buffer</h3>
<p>â€‹	javaä¸­ ä¸€å…± 8ä¸ªåŸºæœ¬ç±»å‹,å¯¹åº”ç€7ç§bufferå¯¹è±¡(æ²¡æœ‰ BooleanBuffer) , å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ªbufferå¯¹è±¡ <code>ByteBuffer buffer = ByteBuffer.allocate(100);</code>, é‚£ä¹ˆæ€ä¹ˆè¿›è¡Œè¯»å†™æ“ä½œ. allocate åœ¨Cè¯­è¨€ç¼–ç¨‹ä¸­ä¹Ÿå«åˆ†é…ç©ºé—´</p>
<pre><code class="language-java">// åˆ›å»ºä¸€ä¸ª bufferå¯¹è±¡ ,è®¾ç½®å…¶å¤§å°ä¸º 50
IntBuffer buffer = IntBuffer.allocate(20);
// å¾€ bufferä¸­å†™å…¥æ•°æ®
for (int i = 0; i &lt; 10; i++) {
    buffer.put(new SecureRandom().nextInt(10));
}
// clearæ˜¯åšå•¥ ? 
// buffer.clear();	
// è¿›è¡Œç¿»è½¬ ,å¦‚æœä¸ä½¿ç”¨è¿™ä¸ª ä¼šå‘ç°ä»€ä¹ˆ ,---&gt; å…¶å®è¿™ä¸ªä½œç”¨å°±æ˜¯è®©
// buffer.flip();  
// è¯»  remainingæ˜¯å‰©ä½™çš„æ„æ€
while (buffer.remaining()&gt;0) {
    System.out.println(buffer.get());
}

// æ³¨æ„æŒ‡å®šç´¢å¼•ä½ç½®ä¸æ”¹å˜positionä½ç½®çš„

1. å½“ buffer.flip(); ä¸æ‰§è¡Œä¼šå‘ç”Ÿä»€ä¹ˆ ? 
  è¾“å‡º:  0	0	0	0	0	0	0	0	0	0	
   æˆ‘ä»¬å‘ç° ä»–å–åˆ°çš„æ­£å¥½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£éƒ¨åˆ†æ•°æ®,é‚£æ˜¯ä¸ºä»€ä¹ˆå‘¢ ,å› ä¸ºæˆ‘ä»¬çœ‹æºç å‘ç°ä»–åªæ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„,æŒ‰ç´¢å¼•å€¼è¿”å›.... é‚£ä¹ˆ ç´¢å¼•æ˜¯å“ªä¸ªå‘¢,å‘ç°æ˜¯ position++ (position&lt; limit) è¿™å°±æ˜ç™½äº†,flipå°±æ˜¯å°† optionçš„ä½ç½®æ”¾åˆ°0,limitç­‰äºåŸæ¥Postion
2.å½“ buffer.clear()æ‰§è¡Œ,flipä¸æ‰§è¡Œä¼šå‘ç”Ÿä»€ä¹ˆ ?     
   è¾“å‡º :  7	0	0	7	1	5	1	0	6	1	0	0	0	0	0	0	0	0	0	0	
  å¥¥åŸæ¥æ˜¯ç›´æ¥æŠŠæ•´ä¸ªæ•°ç»„è¾“å‡ºäº†,é‚£ä¹ˆä¸ºä»€ä¹ˆå‘¢,putä¸æ˜¯è®©position++ å—,é‚£ä¸ºå•¥èƒ½è¯»åˆ°å‰é¢æ•°æ®å‘¢? 
  åŸæ¥æ˜¯å°†ä¸‰ä¸ªæŒ‡é’ˆå¤ä½äº†,reset,
3. æ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº† filp å’Œ clearåšäº†ä»€ä¹ˆ 
4. put() æ–¹æ³• position++; (position&lt;limit)
</code></pre>
<p>â€‹		<strong>æˆ‘ä»¬å‘ç°buffer å°±æ˜¯ä¸€ä¸ªç¼“å†²åŒº,é‚£ä¹ˆå®ƒç©¶ç«ŸåŸç†æ˜¯ä»€ä¹ˆ? flip() åˆæ‰§è¡Œäº†ä»€ä¹ˆ?bufferçš„æ–¹æ³•æ—¶çº¿ç¨‹å®‰å…¨çš„å—</strong>?</p>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-16/1874ecb1-3315-4ba1-8fe0-a8772ff7af27.jpg?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>æˆ‘ä»¬å‘ç° Buffer ä¸­çš„ flip() æ–¹æ³•æ¶‰åŠåˆ° Buffer ä¸­çš„capacityã€positionã€limitä¸‰ä¸ªæ¦‚å¿µ. å…¶ä¸­æ¯å½“æ’å…¥æ•°æ®æ—¶ PostionæŒ‡é’ˆ ä¸€ç›´å‘å°¾ç§»åŠ¨, limitå’Œ capacity ä½äºå°¾éƒ¨è¿›è¡Œé™åˆ¶å¤§å°, è€Œå½“æ‰§è¡Œè¡Œ  flip() æ–¹æ³•æ—¶, è®©<code>limit = position;</code> ä½¿å¾— <code>position = 0;</code>, æ­¤æ—¶<code>buffer.remaining()&gt;0</code> æ‰§è¡Œçš„åˆæ˜¯ä»€ä¹ˆ,ä»–è¿”å›çš„æ˜¯ <code>limit - position;</code> æ‰€ä»¥å½“å¤§äº0æ—¶,è¿”å›çš„å°±æ˜¯æˆ‘ä»¬æ‰€æ’å…¥çš„æ•°æ® .</p>
<ul>
<li>capacityï¼šåœ¨è¯»/å†™æ¨¡å¼ä¸‹éƒ½æ˜¯å›ºå®šçš„(ä¸å¯å˜çš„)ï¼Œå°±æ˜¯æˆ‘ä»¬åˆ†é…çš„ç¼“å†²å¤§å°ï¼ˆå®¹é‡ï¼‰ã€‚</li>
<li>positionï¼šç±»ä¼¼äºè¯»/å†™æŒ‡é’ˆï¼Œè¡¨ç¤ºå°†è¦å»è¯»(å†™)çš„ä¸‹ä¸€ä¸ªä½ç½®çš„ç´¢å¼•ã€‚</li>
<li>limitï¼šåœ¨å†™æ¨¡å¼ä¸‹è¡¨ç¤ºæœ€å¤šèƒ½å†™å…¥å¤šå°‘æ•°æ®ï¼Œæ­¤æ—¶å’Œcapacityç›¸åŒã€‚åœ¨è¯»æ¨¡å¼ä¸‹è¡¨ç¤ºæœ€å¤šèƒ½è¯»å¤šå°‘æ•°æ®ï¼Œæ­¤æ—¶å’Œç¼“å­˜ä¸­çš„å®é™… æ•°æ®å¤§å°ç›¸åŒã€‚</li>
</ul>
<pre><code class="language-java">jdkä¸­è¯´ flip() It sets the limit to the current position and then sets the position to zero

// Invariants: mark &lt;= position &lt;= limit &lt;= capacity (å¾ˆæœ‰å†…æ¶µçš„)
private int mark = -1;
private int position = 0;
private int limit;
private int capacity;    

public final Buffer flip() {
    limit = position;
    position = 0;
    mark = -1;
    return this;
}

public final int remaining() {
    return limit - position;
}
// nextGetIndex() æ–¹æ³• å°±æ˜¯è®©positionç´¢å¼•+1
//offsetæ˜¯åç§»é‡ é»˜è®¤å€¼ä¸º0,
// nbæ˜¯ä¸€ä¸ªåˆå§‹åŒ–capacityå¤§å°çš„æ•°ç»„
protected int ix(int i) {
    return i + offset;
}

public int get() {
    return hb[ix(nextGetIndex())];
}

final int nextGetIndex() {                          // package-private
    if (position &gt;= limit)
        throw new BufferUnderflowException();
    return position++;
}
public final Buffer clear() {
    position = 0;
    limit = capacity;
    mark = -1;
    return this;
}
public IntBuffer put(int x) {
    hb[ix(nextPutIndex())] = x;
    return this;
}
final int nextPutIndex() {                          // package-private
    if (position &gt;= limit)
        throw new BufferOverflowException();
    return position++;
}	
</code></pre>
<p>â€‹	å½“æˆ‘ä»¬ç¿»é˜…APIæ—¶,å‘ç°buffer å¹¶ä¸æ˜¯ ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„, clearæ–¹æ³•å¹¶ä¸ä¼šä½¿å¾—æ•°ç»„æ¸…ç©º,åªæ˜¯è®©å‚æ•°å˜æˆåˆå§‹åŒ–çš„çŠ¶æ€.è¿˜æœ‰å°±æ˜¯ä¸ä¼šçœ‹æºç ,çœ‹æ³¨é‡Š jdkçš„æºç æ³¨é‡ŠçœŸçš„å¾ˆè¯¦ç»†</p>
<h3 id="14-nioè¯»å–æ–‡ä»¶çš„æ–¹å¼">1.4 nioè¯»å–æ–‡ä»¶çš„æ–¹å¼</h3>
<p>â€‹		è¿™é‡Œæˆ‘å†™ä¸€æ®µä»£ç  å¤§å®¶åº”è¯¥å¯ä»¥ç†è§£</p>
<pre><code class="language-java">// model &lt;tt&gt;&quot;r&quot;&lt;/tt&gt;, &lt;tt&gt;&quot;rw&quot;&lt;/tt&gt;, &lt;tt&gt;&quot;rws&quot;&lt;/tt&gt;
RandomAccessFile input = new RandomAccessFile(&quot;input.txt&quot;, &quot;r&quot;);
RandomAccessFile output = new RandomAccessFile(&quot;output.txt&quot;, &quot;rw&quot;);
// æ‰“å¼€ä¸€ä¸ªç®¡é“
FileChannel readChannel = input.getChannel();
FileChannel writeChannel = output.getChannel();

// allocateDirect(100)å¯¹å¤–å†…å­˜   allocate(100)
ByteBuffer buffer = ByteBuffer.allocateDirect(100);

while (true) {
    buffer.clear();
    int read = readChannel.read(buffer);
    System.out.println(read);
    if (read == -1) {
        break;
    }
    buffer.flip();
    writeChannel.write(buffer);
}
input.close();
output.close();

é—®é¢˜å°±æ˜¯åœ¨  sun.nio.ch.IOUtilç±»ä¸­çš„è¿™ä¸ªæ–­è¨€å’Œä¸‹é¢çš„é‚£ä¸ªåˆ¤æ–­è¯­å¥
private static int readIntoNativeBuffer(FileDescriptor var0, ByteBuffer var1, long var2, NativeDispatcher var4) throws IOException {
int var5 = var1.position();
int var6 = var1.limit();

assert var5 &lt;= var6;  // position &lt;= limit æ˜¾ç„¶æ— è¯­,å®Œç¾èº²é¿

int var7 = var5 &lt;= var6 ? var6 - var5 : 0;   è¿™é‡Œè¿”å›0
if (var7 == 0) {
    return 0;   æ‰€ä»¥readå¾—åˆ°çš„æ˜¯0
} else {................}
clearçš„ç›®çš„å°±æ˜¯å¤ä½, å¦‚æœä¸å¤ä½çš„è¯,é‚£ä¹ˆ position å’Œ limit åœ¨ä¸€èµ·,æ²¡æœ‰å®¹é‡,read=0,é‚£ä¸ºä»€ä¹ˆæ˜¯read=0å‘¢,æˆ‘ä»¬å‘ç°æœ€ç»ˆæºç ,å‘ç° 
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-16/76867428-fad2-4523-a31b-edfe38c086ff.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h3 id="15-buffer-å¯¹è±¡çš„-ä¸¤ç§å®ç°æ–¹å¼-direct-ä¸-heap">1.5 buffer å¯¹è±¡çš„ ä¸¤ç§å®ç°æ–¹å¼ Direct ä¸ Heap</h3>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-17/c963a764-01f2-4839-a13c-c100301f2573.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<pre><code>å½“æˆ‘ä»¬å»çœ‹å®ç°æ–¹å¼ å¤§è‡´åˆ†ä¸ºä¸¤ç§ ä¸€ç§æ˜¯ **heap** ,ä¸€ç§æ˜¯ **native** ,å…¶ä¸­ **DirectByteBufferR**æ˜¯åªè¯»buffer,å°±æ˜¯ä¸èƒ½è¿›è¡Œä¿®æ”¹æ“ä½œçš„buffer,æˆ‘ä»¬çš„é‡ç‚¹åœ¨ heapå’Œdirect ä¸Š .
</code></pre>
<ul>
<li>
<p>directç±» æˆ‘ä»¬ç¿»çœ‹æºç </p>
<pre><code class="language-java">ByteBuffer buffer = ByteBuffer.allocateDirect(100);

buffer æºç 
// Used only by direct buffers
// NOTE: hoisted here for speed in JNI GetDirectBufferAddress
long address;  // æŒ‡å‘çš„å°±æ˜¯ æœ¬åœ°å†…å­˜çš„åœ°å€

DirectByteBuffer() æˆ‘çš„å®ç°ä»£ç æˆ‘ä¹Ÿ è®²ä¸æ¸…æ¥š,è®¾è®¡åˆ°å¥½å¤š sunå…¬å¸çš„ä»£ç , sumå¼€å¤´çš„ä»£ç å®ƒä¸æ˜¯å¼€æºçš„,å¤§å®¶å¸¸ç”¨çš„jdk ,å…¶å®åˆ†ä¸ºä¸¤ç±» ä¸€ä¸ªæ˜¯ java,javax è¿™éƒ½æ˜¯å¼€æºçš„,sun å°±ä¸æ˜¯
è¿™ä¸ªç±»å®ç°å®åŸºäºjniçš„,
</code></pre>
</li>
<li>
<p><strong>MappedByteBuffer</strong>ä½¿ç”¨(A direct byte buffer whose content is a memory-mapped region of a file. ä»–ä¹Ÿæ˜¯ directæ–¹å¼çš„)</p>
<pre><code class="language-java"> RandomAccessFile file = new RandomAccessFile(&quot;modify.txt&quot;, &quot;rw&quot;);
 MappedByteBuffer buffer = file.getChannel().map(FileChannel.MapMode.READ_WRITE, 0, 10);
 buffer.put(0, (byte) 'a');
 buffer.put(4, (byte) 'a');

 file.close();
</code></pre>
</li>
<li>
<p>å¦‚ä¸‹æ˜¯æˆ‘åšçš„ä¸¤ä¸ªçš„å¯¹æ¯” ,æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹,ä¸»è¦åŒºåˆ«å°±æ˜¯ <strong>DirectByteBuffer å®ç°äº† é›¶æ‹·è´</strong></p>
</li>
</ul>
<figure data-type="image" tabindex="4"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-09-17/2236d4a5-0a31-495d-bda5-40131121f2b7.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h3 id="16-è®¤è¯†-selector">1.6 è®¤è¯† selector</h3>
<ul>
<li><strong>selector</strong></li>
</ul>
<blockquote>
<p>â€‹		A multiplexor(å¤šè·¯å¤ç”¨å™¨) of {@link SelectableChannel} objects. A selector may be created by invoking the {@link  open} method of this class, which will use the system's default {@link SelectorProvider } to create a new selector.</p>
<p>â€‹	æ˜¯ä¸€ä¸ªSelectableChannel çš„å¤šè·¯å¤ç”¨å™¨ ,å…¶å®å°±æ˜¯ ä¸€ä¸ªchannelçš„æ³¨å†Œå™¨, ç„¶åselector å»å¤ç”¨ä»–.</p>
<p>â€‹	å¦‚ä½•åˆ›å»º?</p>
<p>â€‹	Selector selector = Selector.open();</p>
<p>â€‹	å¦‚ä½•ä½¿ç”¨ ?</p>
<p>â€‹	serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</p>
</blockquote>
<ul>
<li><strong>Set<SelectionKey> selectionKeys = selector.keys();</strong></li>
</ul>
<blockquote>
<p>è¿™ä¸ªé›†åˆ æ˜¯ä»€ä¹ˆ ?</p>
<p>â€‹	å®ƒæ˜¯ æ³¨å†Œåœ¨ selectorä¸Šçš„ channel å¯¹è±¡, è®°ä½ ä½ æ³¨å†Œçš„æ—¶å€™ç”¨å•¥,ä½ è·å–çš„æ—¶å€™å°±å–æ³¨å†Œçš„ç±»å‹,å‘ä¸‹è½¬å‹ä¸€èˆ¬. ä¾‹å¦‚  ServerSocketChannel  serverChannel = (ServerSocketChannel)selectionKey.channel();</p>
</blockquote>
<ul>
<li><strong>SelectionKey</strong></li>
</ul>
<blockquote>
<p>â€‹	A token representing the registration of a {@link SelectableChannel} with a {@link Selector}.</p>
<p>â€‹	ä¸€ä¸ª SelectableChannel çš„ token (æ ‡è®°) ;</p>
<p>â€‹	æœ‰å››ä¸ªçŠ¶æ€ <code>OP_ACCEPT</code>   <code>OP_CONNECT</code>  <code>OP_WRITE</code>  <code>OP_READ</code></p>
</blockquote>
<h2 id="2-nioç¼–å†™æœåŠ¡å™¨">2. NIOç¼–å†™æœåŠ¡å™¨</h2>
<pre><code class="language-java">// åˆ›å»ºä¸€ä¸ª SelectableChannel çš„å¯¹è±¡
ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
// è¿™ä¸€æ­¥å¿…é¡»è®¾ç½®ä¸º éé˜»å¡çš„
serverSocketChannel.configureBlocking(false);

// ç»‘å®šä¸€ä¸ªsocketå¯¹è±¡ , è®©ä»–å»ç›‘å¬ 8899 ç«¯å£ , è·ŸBIOä¸€æ ·,ä¼ ç»Ÿsocketç¼–ç¨‹
ServerSocket socket = serverSocketChannel.socket();
socket.bind(new InetSocketAddress(8899));

// åˆ›å»ºä¸€ä¸ª Selectorå¯¹è±¡
Selector selector = Selector.open();
// æŠŠè¿æ¥äº‹ä»¶æ³¨å†Œåˆ° Selectorå¯¹è±¡ä¸Š
serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);
ByteBuffer buffer = ByteBuffer.allocate(1024);

// æ­»å¾ªç¯,ä¸æ–­è½®è¯¢
while (true) {

    // æ¯æ¬¡è¿›è¡Œè½®è¯¢
    selector.select(); //é˜»å¡

    // å½“ç›‘å¬åˆ°äº‹ä»¶æ—¶ æ‰§è¡Œä¸€ä¸‹ä»£ç 
    Set&lt;SelectionKey&gt; selectionKeys = selector.keys();

    selectionKeys.forEach(selectionKey -&gt; {
        // å¦‚æœæ˜¯å·²è¿æ¥çš„
        if (selectionKey.isAcceptable()) {

         // è·å–åˆ°è¿æ¥å¯¹è±¡
         ServerSocketChannel  serverChannel = (ServerSocketChannel)selectionKey.channel();

            SocketChannel socketChannel = null;
            try {
                // æ‰“å¼€ socketChannel (ç½‘ç»œç¼–ç¨‹å…¥å£)
                socketChannel = serverChannel.accept();//é˜»å¡

                if (null != socketChannel) {
                    socketChannel.configureBlocking(false);
                    socketChannel.register(selector, SelectionKey.OP_READ);
                }
            } catch (IOException e) {
//                        e.printStackTrace();
            }

        } else if (selectionKey.isReadable()) {
            SocketChannel channel = (SocketChannel) selectionKey.channel();
            Integer read=0;
            try {
                // è¯»å–åˆ°bufferä¸­
                 read = channel.read(buffer);
            } catch (IOException e) {
//                        e.printStackTrace();
            }

            if (read &gt;0) {
                buffer.flip();
                Charset charset = Charset.forName(&quot;utf-8&quot;);
                char[] array = charset.decode(buffer).array();

                String msg = new String(array);

                System.out.println(msg);

                buffer.clear();
            }
        }
    });
}
</code></pre>
<h2 id="3-ç¼–å†™æ—¥å¿—è¯»å†™">3. ç¼–å†™æ—¥å¿—è¯»å†™</h2>
<p>å†™ , æ¯100ms å†™ä¸€è¡Œ</p>
<pre><code class="language-java">public class TestWriter {


    public static void main(String[] args) throws IOException {

        BufferedWriter writer = new BufferedWriter(new FileWriter(&quot;C:\\Users\\12986\\Desktop\\file.txt&quot;));

        StringBuilder builder = new StringBuilder(20);
        AtomicInteger integer = new AtomicInteger(0);

        new Timer().schedule(new TimerTask() {
            @Override
            public void run() {
                try {
                    // è®¾ç½®ä»–çš„å†™æŒ‡é’ˆ
                    builder.setLength(0);
                    
                    // æ·»åŠ æ•°æ®
                    builder.append(&quot;å½“å‰è¡Œ : &quot; + integer.incrementAndGet() + &quot;\n&quot;);
                    
                    // å†™æ•°æ®
                    writer.write(builder.toString());
                    
                    // åˆ·æ´—è®°å¾— , ä¸ç„¶æ— æ³•ä¿å­˜
                    writer.flush();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }, 0, 100);

    }

}
</code></pre>
<p>è¯»å– , è¯»æ“ä½œ</p>
<pre><code class="language-java">public class TestRead {

    public static void main(String[] args) throws IOException, InterruptedException {

        RandomAccessFile file = new RandomAccessFile(new File(&quot;C:\\Users\\12986\\Desktop\\file.txt&quot;), &quot;r&quot;);

        FileChannel channel = file.getChannel();
        ByteBuffer allocate = ByteBuffer.allocate(100);

        // å¼€å§‹é•¿åº¦
        int start = 0;

        while (true) {
            // 1. æ¸…ç©º
            allocate.clear();
            // 2. è¯»
            int read = channel.read(allocate, start);

            // 3. å¦‚æœè¯»å–æ•°æ®ä¸º-1 è¿”å›
            if (read == -1) continue;

            // 4. start=start+è¯»å–é•¿åº¦
            start += read;

            // å˜æˆæ•°ç»„ -&gt; ç”±äºéœ€è¦è¯»å–ä¸éœ€è¦0æ‹·è´
            byte[] array = allocate.array();

            // 5.è¯»å–æ—¥å¿—
            String log = new String(array, 0, read, Charset.forName(&quot;utf8&quot;));

            // 6. log
            System.out.println(log);
        }
    }
}
</code></pre>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E8%AE%A4%E8%AF%86nio">1. è®¤è¯†NIO</a>
<ul>
<li><a href="#11-nio%E7%9A%84%E5%90%8D%E5%AD%97%E6%98%AF%E4%BB%80%E4%B9%88">1.1  nioçš„åå­—æ˜¯ä»€ä¹ˆ?</a></li>
<li><a href="#12-%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86nio%E7%9A%84%E7%BC%96%E7%A8%8B">1.2 åˆæ­¥è®¤è¯†NIOçš„ç¼–ç¨‹</a></li>
<li><a href="#13-%E8%AE%A4%E8%AF%86-buffer">1.3 è®¤è¯† buffer</a></li>
<li><a href="#14-nio%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E5%BC%8F">1.4 nioè¯»å–æ–‡ä»¶çš„æ–¹å¼</a></li>
<li><a href="#15-buffer-%E5%AF%B9%E8%B1%A1%E7%9A%84-%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-direct-%E4%B8%8E-heap">1.5 buffer å¯¹è±¡çš„ ä¸¤ç§å®ç°æ–¹å¼ Direct ä¸ Heap</a></li>
<li><a href="#16-%E8%AE%A4%E8%AF%86-selector">1.6 è®¤è¯† selector</a></li>
</ul>
</li>
<li><a href="#2-nio%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E5%99%A8">2. NIOç¼–å†™æœåŠ¡å™¨</a></li>
<li><a href="#3-%E7%BC%96%E5%86%99%E6%97%A5%E5%BF%97%E8%AF%BB%E5%86%99">3. ç¼–å†™æ—¥å¿—è¯»å†™</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>