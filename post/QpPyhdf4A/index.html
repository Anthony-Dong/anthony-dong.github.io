<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Curator å®ç°æ³¨å†Œä¸­å¿ƒ  ä»¥åŠ Leaderé€‰ä¸¾æœºåˆ¶ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/QpPyhdf4A/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Curator å®ç°æ³¨å†Œä¸­å¿ƒ  ä»¥åŠ Leaderé€‰ä¸¾æœºåˆ¶</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-03-26</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/QpPyhdf4A/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/I3pJJjYod0F/"
								class="tag">Zookeeper</a> |
							 <a
								href="https://anthony-dong.github.io/tag/ttg8Ug7wWN3/"
								class="tag">Curator</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2578å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">14 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<p>Demo å…¶å®éƒ½æ˜¯å®˜æ–¹æä¾›çš„. é“¾æ¥ :  <a href="http://curator.apache.org/curator-examples/index.html">http://curator.apache.org/curator-examples/index.html</a></p>
<h2 id="æ³¨å†Œä¸­å¿ƒ">æ³¨å†Œä¸­å¿ƒ</h2>
<p>ä¾èµ–</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
    &lt;artifactId&gt;curator-x-discovery&lt;/artifactId&gt;
    &lt;version&gt;4.0.1&lt;/version&gt;
&lt;/dependency&gt;
// è¿™ä¸ªæ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„zkæœåŠ¡ç«¯.ç›´æ¥new testzk å°±å¯ä»¥å¯åŠ¨äº†.
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
    &lt;artifactId&gt;curator-test&lt;/artifactId&gt;
    &lt;version&gt;4.0.1&lt;/version&gt;
    &lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="ç®€å•ä¾‹å­">ç®€å•ä¾‹å­</h3>
<p>ä¸‹é¢ä¾‹å­é‡Œ. ä½¿ç”¨äº† FastJsonåšåºåˆ—åŒ–. è¿˜æœ‰å°±æ˜¯ä½¿ç”¨Lombox .</p>
<pre><code class="language-java">public class TestDiscovery {

    public static void main(String[] args) throws Exception {
        String path = &quot;/discovery/example&quot;;
        // 1. åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯
        CuratorFramework client = Zk.startClient();

        // 2. è¿™ä¸ªæ˜¯ç”¨äºåºåˆ—åŒ–. æ¯ä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹çš„.
        InstanceSerializer&lt;Detail&gt; serializer = new InstanceSerializer&lt;Detail&gt;() {
            // åºåˆ—åŒ–è¿‡ç¨‹ , éƒ½æ˜¯ä½¿ç”¨çš„json
            @Override
            public byte[] serialize(ServiceInstance&lt;Detail&gt; instance) throws Exception {
                Detail detail = instance.getPayload();
                detail.id = instance.getId();
                return JSON.toJSONBytes(detail);
            }

            // ååºåˆ—åŒ–è¿‡ç¨‹
            @Override
            public ServiceInstance&lt;Detail&gt; deserialize(byte[] bytes) throws Exception {
                Detail detail = JSON.parseObject(bytes, Detail.class);
                return ServiceInstance.&lt;Detail&gt;builder().payload(detail).name(detail.name).address(detail.host).port(detail.port).build();
            }
        };

        // 3. å‡è®¾è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„ æœåŠ¡æ¶ˆè´¹æ–¹ , éœ€è¦å»æ¶ˆè´¹èŠ‚ç‚¹. (basePath , å…¶å®åœ¨zk3.5ä¸­æ˜¯åˆ›å»ºäº†ä¸€ä¸ª container)
        ServiceDiscovery&lt;Detail&gt; discovery = ServiceDiscoveryBuilder.builder(Detail.class).client(client).basePath(path).serializer(serializer).build();


        //4. åˆ›å»ºä¸‰ä¸ªæœåŠ¡æä¾›æ–¹ , åˆ›å»ºèŠ‚ç‚¹.
        newNode(path, client, serializer, &quot;192.168.58.131&quot;);
        newNode(path, client, serializer, &quot;192.168.58.132&quot;);
        newNode(path, client, serializer, &quot;192.168.58.133&quot;);


        //5. æˆ‘ä»¬çš„æœåŠ¡æ¶ˆè´¹æ–¹, éœ€è¦å»å‘ç°redisæœåŠ¡ èŠ‚ç‚¹. 
        Collection&lt;ServiceInstance&lt;Detail&gt;&gt; instances = discovery.queryForInstances(&quot;redis&quot;);
        instances.forEach(detailServiceInstance -&gt; System.out.println(&quot;find redis instance : &quot; + detailServiceInstance.getPayload()));

        // 6. æ–¹ä¾¿å»zkæŸ¥çœ‹ä¿¡æ¯.
        System.in.read();
    }

    // åˆ›å»ºredis èŠ‚ç‚¹
    private static void newNode(String path, CuratorFramework client, InstanceSerializer&lt;Detail&gt; serializer, String host) throws Exception {
        // 1. åˆ›å»ºä¸€ä¸ªDetail
        Detail detail = new Detail();
        detail.port = 6379;
        detail.host = host;
        detail.name = &quot;redis&quot;;
        // 2. å®ä¾‹åŒ–ä¸€ä¸ª æœåŠ¡èŠ‚ç‚¹
        ServiceInstance&lt;Detail&gt; instance = ServiceInstance.&lt;Detail&gt;builder().name(detail.name).payload(detail).address(detail.host).port(detail.port).build();

        // 3. æ³¨å†ŒèŠ‚ç‚¹ . æ­¤æ—¶éœ€è¦æ‰§è¡Œstart. å…¶å®å°±æ˜¯æ³¨å†Œäº†æ”¹èŠ‚ç‚¹.
        ServiceDiscovery&lt;Detail&gt; discovery = ServiceDiscoveryBuilder.builder(Detail.class).client(client).serializer(serializer).basePath(path).thisInstance(instance).build();
        discovery.start();
    }


    @Getter
    @Setter
    @ToString
    static class Detail {
        // id , é»˜è®¤æ˜¯UUID
        String id;

        // å±äºå“ªä¸ªæœåŠ¡
        String name;

        // host
        String host;

        // port
        int port;
    }
}
</code></pre>
<p>è¾“å‡º :</p>
<pre><code class="language-java">find redis instance : TestDiscovery.Detail(id=36c95464-6846-4b69-8c5b-07cf91ad0d62, name=redis, host=192.168.58.133, port=6379)
find redis instance : TestDiscovery.Detail(id=11bf74c8-8e4d-4b8d-821c-fecdf0492b6b, name=redis, host=192.168.58.132, port=6379)
find redis instance : TestDiscovery.Detail(id=ed01f5c4-2c92-484b-9194-b168958cf834, name=redis, host=192.168.58.131, port=6379)
</code></pre>
<p>æ‰€ä»¥ä½¿ç”¨èµ·æ¥è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„. æˆ‘ä»¬è¿™é‡Œå°è£…çš„<code>Detail</code> ä¸»è¦æ˜¯ä¿å­˜ä¸€äº›æˆ‘ä»¬æ¯ä¸ªèŠ‚ç‚¹çš„å…ƒä¿¡æ¯ .</p>
<p>æ­¤æ—¶å»zk æŸ¥çœ‹</p>
<pre><code class="language-java">[zk: localhost:2181(CONNECTED) 18] ls /discovery/example/redis
[11bf74c8-8e4d-4b8d-821c-fecdf0492b6b, 36c95464-6846-4b69-8c5b-07cf91ad0d62, ed01f5c4-2c92-484b-9194-b168958cf834]
</code></pre>
<p>ç¡®å® idé»˜è®¤æ˜¯ uuid ç”Ÿæˆçš„. ä¸è¿‡è¿™äº›æ˜¯å¯ä»¥æŒ‡å®šçš„.</p>
<p>æˆ‘ä»¬çœ‹çœ‹å…·ä½“é•¿å•¥æ ·å­æ¯ä¸ª.</p>
<pre><code class="language-java">[zk: localhost:2181(CONNECTED) 19] get /discovery/example/redis/11bf74c8-8e4d-4b8d-821c-fecdf0492b6b
{&quot;host&quot;:&quot;192.168.58.132&quot;,&quot;id&quot;:&quot;11bf74c8-8e4d-4b8d-821c-fecdf0492b6b&quot;,&quot;name&quot;:&quot;redis&quot;,&quot;port&quot;:6379}
</code></pre>
<p>å…·ä½“çŠ¶æ€å‘¢. å…¶å®æ˜¯ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹.</p>
<pre><code class="language-java">[zk: localhost:2181(CONNECTED) 20] stat /discovery/example/redis/11bf74c8-8e4d-4b8d-821c-fecdf0492b6b
cZxid = 0x2a5
ctime = Wed Mar 25 19:17:14 CST 2020
mZxid = 0x2a5
mtime = Wed Mar 25 19:17:14 CST 2020
pZxid = 0x2a5
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x1000000fdb80061
dataLength = 96
numChildren = 0
</code></pre>
<h3 id="å®ç°">å®ç°</h3>
<p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„åŸºæœ¬å®ç°.  å…¶å®æ˜¯ç”¨èµ·æ¥è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„.</p>
<p>ä¸»è¦æ˜¯æ³¨æ„ ä¸¤ä¸ªå¯¹è±¡. <code>ServiceDiscovery</code> è¿™ä¸ªå¯¹è±¡æ˜¯ä»£è¡¨ä¸€ä¸ªæœåŠ¡ç«¯ . (å¯ä»¥æ˜¯æ¶ˆè´¹è€…, å¯ä»¥æ˜¯æä¾›è€…) éœ€è¦startè¿›è¡Œæš´éœ² ,closeè¿›è¡Œåˆ é™¤, <code>ServiceInstance</code> ä»£è¡¨ä¸€ä¸ªå•ä¸ªæœåŠ¡å®ä¾‹.    ä¸€ä¸ªæœåŠ¡ç«¯å¯ä»¥æ³¨å†Œå¤šä¸ªæœåŠ¡å®ä¾‹</p>
<pre><code class="language-java">// 1. æ³¨å†ŒæœåŠ¡
discovery.registerService(Instance);
// 2. å‘ç°æœåŠ¡
discovery.queryForInstances(server-name);
// 3. å¯åŠ¨æœåŠ¡ , ä¼šå°†æ³¨å†Œåˆ°æœåŠ¡å™¨çš„èŠ‚ç‚¹å…¨éƒ¨æ³¨å†Œç»™zkæœåŠ¡ç«¯. 
discovery.start();
</code></pre>
<p>æˆ‘ä»¬çœ‹çœ‹ <code>registerServiceæ–¹æ³•</code> æ–¹æ³•</p>
<pre><code class="language-java">public void registerService(ServiceInstance&lt;T&gt; service) throws Exception
{
    Entry&lt;T&gt; newEntry = new Entry&lt;T&gt;(service);
    Entry&lt;T&gt; oldEntry = services.putIfAbsent(service.getId(), newEntry);
    Entry&lt;T&gt; useEntry = (oldEntry != null) ? oldEntry : newEntry;
    synchronized(useEntry)
    {
        if ( useEntry == newEntry ) // i.e. is new
        {
            useEntry.cache = makeNodeCache(service);
        }
        // è¿™é‡Œå°±å»æ‰§è¡Œå» zkæœåŠ¡å™¨ä¸­æ³¨å†Œæ”¹èŠ‚ç‚¹.
        internalRegisterService(service);
    }
}
</code></pre>
<p>å†è¿›å»å°±æ˜¯</p>
<pre><code class="language-java">@VisibleForTesting
protected void internalRegisterService(ServiceInstance&lt;T&gt; service) throws Exception
{
    byte[] bytes = serializer.serialize(service);
    String path = pathForInstance(service.getName(), service.getId());

    final int MAX_TRIES = 2;
    boolean isDone = false;
    for ( int i = 0; !isDone &amp;&amp; (i &lt; MAX_TRIES); ++i )
    {
        try
        {
        // åˆ¤æ–­èŠ‚ç‚¹åˆ›å»ºçš„ç±»å‹. 
            CreateMode mode;
            switch (service.getServiceType()) {
            case DYNAMIC:
                mode = CreateMode.EPHEMERAL;
                break;
            case DYNAMIC_SEQUENTIAL:
                mode = CreateMode.EPHEMERAL_SEQUENTIAL;
                break;
            default:
                mode = CreateMode.PERSISTENT;
                break;
            }
            client.create().creatingParentContainersIfNeeded().withMode(mode).forPath(path, bytes);
            isDone = true;
        }
        catch ( KeeperException.NodeExistsException e )
        {
            // å¦‚æœè¯¥èŠ‚ç‚¹å­˜åœ¨äº†, åˆ™åˆ é™¤è¯¥èŠ‚ç‚¹,  åˆ™ä¼šç»§ç»­å¾ªç¯(å› ä¸º isDown=false),ç„¶åé‡æ–°æ³¨å†Œæ”¹èŠ‚ç‚¹.
            client.delete().forPath(path);  // must delete then re-create so that watchers fire
        }
    }
}
</code></pre>
<h3 id="æ³¨æ„ç‚¹">æ³¨æ„ç‚¹</h3>
<p>æ‰€ä»¥æ€ä¹ˆè¯´å‘¢. start å’Œ registeråˆ«ä¸€èµ·ä½¿ç”¨å§.  æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å…ˆåˆ›å»º<code>ServiceDiscovery</code> æœåŠ¡å‘ç°ä¸­å¿ƒ.</p>
<pre><code class="language-java">ServiceDiscovery&lt;Detail&gt; discovery = ServiceDiscoveryBuilder.builder(Detail.class).client(client).basePath(path).serializer(serializer).build();
</code></pre>
<p>ç„¶åå†å»è°ƒç”¨ä»–çš„register instance. æœ€åå°±åˆ«ä½¿ç”¨start.  åŸºæœ¬å°±æ˜¯è¿™ä¸ª.   è¿˜æœ‰è¿™ä¸ªæ ¹èŠ‚ç‚¹æ˜¯ä¸€ä¸ª container . æ‰€ä»¥zkä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å›æ”¶è¿™ä¸ªèŠ‚ç‚¹ . å¦‚æœå­å¯¹è±¡ä¸ºç©ºçš„è¯.</p>
<p>æ‰€ä»¥API å°è£…çš„è¿˜æ˜¯å¾ˆæ£’çš„.</p>
<p>ä¸Šé¢æˆ‘çœ‹äº†çœ‹ demo , è‡ªå·±ç¼–å†™çš„.  å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯ :  <code>UriSpec</code> , å¯ä»¥ä½¿ç”¨å ä½ç¬¦. è¿›è¡Œè®¾ç½®å±æ€§.</p>
<pre><code class="language-java">UriSpec uriSpec = new UriSpec(&quot;{scheme}://foo.com:{port}&quot;);

thisInstance = ServiceInstance.&lt;InstanceDetails&gt;builder()
        .name(serviceName)
        .payload(new InstanceDetails(description))
        .port((int) (65535 * Math.random())) // in a real application, you'd use a common port
        .uriSpec(uriSpec)
        .build();
</code></pre>
<p>å¦‚æœåŠ å…¥äº† ssl é…ç½® , è‡ªåŠ¨æˆäº† https</p>
<pre><code class="language-java">if ( serviceInstance.getSslPort() != null )
{
    localVariables.put(FIELD_SCHEME, &quot;https&quot;);
}
</code></pre>
<h2 id="leaderé€‰ä¸¾">Leaderé€‰ä¸¾</h2>
<blockquote>
<p>â€‹	ä¸»è¦å®ç°åŸç†è¿˜æ˜¯åŸºäº åˆ†å¸ƒå¼é”å®ç°çš„. å› ä¸ºæ’å®ƒé”é»˜è®¤å°±æ˜¯ä¸€æŠŠ, å…¶å®å°±æ˜¯leader.  leaderä¼šæ‹¿ç€é‚£æŠŠé” , åŸºäºè¿™ç§æ€æƒ³å»åšçš„. å¯ä»¥çœ‹çœ‹ä»–çš„å…·ä½“åŸç†å’Œå®ç°. <code>org.apache.curator.framework.recipes.leader.LeaderSelector#doWork</code> åœ¨è¿™é‡Œå®ç°çš„.</p>
</blockquote>
<p>æˆ‘ä»¬æ‹¿å®˜æ–¹çš„ä¾‹å­æ¥è¯´ :</p>
<p>è¿™ä¸ªæ˜¯ä¸ªå®¢æˆ·ç«¯, æ ¸å¿ƒçš„apiåœ¨ <code>takeLeadership</code> , å½“ä½ è¢«é€‰ä¸ºleaderçš„æ—¶å€™, æ­¤æ—¶å½“è¯¥æ–¹æ³•æ²¡æœ‰è¿”å›ä¹‹å‰ä½ ä¸€ç›´æ˜¯leader.</p>
<pre><code class="language-java">/**
 * An example leader selector client. Note that {@link LeaderSelectorListenerAdapter} which
 * has the recommended handling for connection state issues
 */
public class ExampleClient extends LeaderSelectorListenerAdapter implements Closeable {
    private final String name;
    private final LeaderSelector leaderSelector;
    private final AtomicInteger leaderCount = new AtomicInteger();

    public ExampleClient(CuratorFramework client, String path, String name) {
        this.name = name;

        // create a leader selector using the given path for management
        // all participants in a given leader selection must use the same path
        // ExampleClient here is also a LeaderSelectorListener but this isn't required
        leaderSelector = new LeaderSelector(client, path, this);

        // for most cases you will want your instance to requeue when it relinquishes leadership
        // è¿™é‡Œå°±æ˜¯å½“ä½ æ”¾å¼ƒé¢†å¯¼çš„æ—¶å€™, å®Œå…¨æ”¾å¼ƒå°±ä¸è®¾ç½®äº†, å½“ä½ ä¸å®Œå…¨æ”¾å¼ƒ.è¿˜æƒ³å‚ä¸ç«é€‰.æ­¤æ—¶å°±éœ€è¦è®¾ç½®.
        leaderSelector.autoRequeue();
    }

    public void start() throws IOException {
        // the selection for this instance doesn't start until the leader selector is started
        // leader selection is done in the background so this call to leaderSelector.start() returns immediately
        leaderSelector.start();
    }

    @Override
    public void close() throws IOException {
        leaderSelector.close();
    }

    @Override
    public void takeLeadership(CuratorFramework client) throws Exception {
        // we are now the leader. This method should not return until we want to relinquish leadership

        final int waitSeconds = (int) (5 * Math.random()) + 1;

        System.out.println(name + &quot; is now the leader. Waiting &quot; + waitSeconds + &quot; seconds...&quot; );
        System.out.println(name + &quot; has been leader &quot; + leaderCount.getAndIncrement() + &quot; time(s) before.&quot;);
        try {
            Thread.sleep(TimeUnit.SECONDS.toMillis(waitSeconds));
        } catch (InterruptedException e) {
            System.err.println(name + &quot; was interrupted.&quot;);
            Thread.currentThread().interrupt();
        } finally {
            System.out.println(name + &quot; relinquishing leadership.\n&quot;);
        }
    }
}
</code></pre>
<p>ä¸»æ–¹æ³• : æ¨¡æ‹Ÿ leaderçš„é€‰ä¸¾.</p>
<pre><code class="language-java">public class LeaderSelectorExample {
    private static final int CLIENT_QTY = 10;

    private static final String PATH = &quot;/examples/leader&quot;;

    public static void main(String[] args) throws Exception {
        // all of the useful sample code is in ExampleClient.java

        System.out.println(&quot;Create &quot; + CLIENT_QTY + &quot; clients, have each negotiate for leadership and then wait a random number of seconds before letting another leader election occur.&quot;);
        System.out.println(&quot;Notice that leader election is fair: all clients will become leader and will do so the same number of times.&quot;);

        List&lt;CuratorFramework&gt; clients = Lists.newArrayList();
        List&lt;ExampleClient&gt; examples = Lists.newArrayList();
        TestingServer server = new TestingServer();
        try {
            for (int i = 0; i &lt; CLIENT_QTY; ++i) {
                CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3));
                clients.add(client);

                ExampleClient example = new ExampleClient(client, PATH, &quot;Client #&quot; + i);
                examples.add(example);

                client.start();
                example.start();
            }

            System.out.println(&quot;Press enter/return to quit\n&quot;);
            new BufferedReader(new InputStreamReader(System.in)).readLine();
        } finally {
            System.out.println(&quot;Shutting down...&quot;);

            for (ExampleClient exampleClient : examples) {
                CloseableUtils.closeQuietly(exampleClient);
            }
            for (CuratorFramework client : clients) {
                CloseableUtils.closeQuietly(client);
            }
            CloseableUtils.closeQuietly(server);
        }
    }
}
</code></pre>
<p>æˆ‘è¿˜å†™äº†ä¸€ä¸ªç±»ä¼¼çš„demo</p>
<pre><code class="language-java">public class ExampleLeader2 {

    public static void main(String[] args) throws InterruptedException {

        String path = &quot;/leader/example&quot;;
        int count = 10;
        ExecutorService pool = Executors.newFixedThreadPool(10);
        IntStream.range(0, count).forEach(new IntConsumer() {
            @Override
            public void accept(int value) {
                pool.execute(() -&gt; {
                    String id = &quot;c-&quot; + value;
                    CuratorFramework client = Zk.startClient();

                    // ç›‘è§†å™¨
                    Object monitor = new Object();

                    LeaderSelector selector = new LeaderSelector(client, path, new LeaderSelectorListener() {
                        // å½“ä½ æ˜¯é¢†å¯¼çš„æ—¶å€™, ä¼šè§¦å‘è¿™ä¸ªå›è°ƒäº‹ä»¶.
                        @Override
                        public void takeLeadership(CuratorFramework client) throws Exception {
                            System.out.println(id + &quot; :å…·æœ‰leaderæƒé™. : &quot; + Thread.currentThread().getName());

                            // æ¯”å¦‚æ­¤æ—¶å…·æœ‰äº†leaderæƒé™. æ­¤æ—¶å°±æ˜¯æ‰§è¡Œleaderæ‰€åšçš„å…·ä½“ä¸šåŠ¡.
                            // æ­¢åˆ°leaderè¢«downæ‰ä¹‹å. æ‰€ä»¥è®¾ç½®äº†ä¸€ä¸ªwait . ç­‰å¾…ç³»ç»Ÿdownæ‰.
                            synchronized (monitor) {
                                monitor.wait();
                            }
                        }

                        @Override
                        public void stateChanged(CuratorFramework client, ConnectionState newState) {
                            System.out.println(id + &quot; change : &quot; + newState);
                        }
                    });
                    selector.start();


                    // åç»­ä¸šåŠ¡å§.
                    // downæ‰å , å…·ä½“é€»è¾‘è¿™é‡Œå†™, 

                    synchronized (monitor) {
                        monitor.notifyAll();
                        System.out.println(id + &quot; downæœº.... , é‡Šæ”¾å½“å‰çº¿ç¨‹&quot;);
                    }
                    CloseableUtils.closeQuietly(selector);
                    CloseableUtils.closeQuietly(client);
                });
            }
        });

        pool.shutdown();
        pool.awaitTermination(1000, TimeUnit.DAYS);
    }
}
</code></pre>
<p>è¿™ç§å†™æ³• å¯¹äºéleaderçš„é€‰æ‰‹ä¸å‹å¥½. å› ä¸ºä»–å¹¶ä¸çŸ¥é“å®ƒæ˜¯ä¸æ˜¯leaderå’Œfollower.  è¿˜æœ‰ä¸€ç§å†™æ³•æ˜¯ç­‰åˆ°è‡ªå·±æ˜¯leaderçš„æ—¶å€™ç»§ç»­æ‰§è¡Œ</p>
<pre><code class="language-java">String id = &quot;c-&quot; + value;
CuratorFramework client = Zk.startClient();
LeaderLatch latch = new LeaderLatch(client, path, id);
try {
    latch.start();
} catch (Exception e) {
    //
}
// ä¸€ç›´ç­‰åˆ°è‡ªå·±ä½œä¸ºleader.
try {
    latch.await();
} catch (InterruptedException | EOFException e) {
    e.printStackTrace();
}
</code></pre>
<p>è¿™é‡Œæˆ‘å†™äº†ä¸€ä¸ª leaderç®€å•ç‰ˆ , å¯åŠ¨å¤šä¸ªè§‚å¯Ÿleaderçš„å˜åŒ–.</p>
<pre><code class="language-java">public class ExampleClient3 {

    public static void main(String[] args) {
        CuratorFramework client = Zk.startClient();

        String path = &quot;/leader/example&quot;;


        Object monitor = new Object();

        LeaderSelector selector = new LeaderSelector(client, path, new LeaderSelectorListener() {
            @Override
            public void takeLeadership(CuratorFramework client) throws Exception {
                new Timer(true).schedule(new TimerTask() {
                    @Override
                    public void run() {
                        System.out.println(&quot;leader worker&quot;);
                    }
                }, 1000, 1000);

                synchronized (monitor) {
                    monitor.wait();
                }
            }

            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                System.out.println(&quot;change : &quot; + newState);
            }
        });


        selector.setId(&quot;192.168.58.131:6379&quot;);

        selector.start();


        try {
            TimeUnit.DAYS.sleep(Integer.MAX_VALUE);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {
            @Override
            public void run() {
                synchronized (monitor) {
                    monitor.notifyAll();
                }
                CloseableUtils.closeQuietly(selector);
                CloseableUtils.closeQuietly(client);
            }
        }));
    }
}
</code></pre>
<p>æˆ‘ä»¬æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ . IDå…¶å®å°±æ˜¯ ä¿å­˜çš„æ•°æ®.</p>
<pre><code class="language-java">[zk: localhost:2181(CONNECTED) 66] ls /leader/example/_c_537ef73c-8923-46f5-8689-dc001cae446b-lock-0000000000
[]
[zk: localhost:2181(CONNECTED) 67] get /leader/example/_c_537ef73c-8923-46f5-8689-dc001cae446b-lock-0000000000
192.168.58.131:6379
</code></pre>
<p>åŸºæœ¬å°±æ˜¯è¿™äº›. Leaderé€‰ä¸¾æ˜¯é€‚ç”¨åœºæ™¯å¹¶ä¸å¤š, æ‰€ä»¥æˆ‘è¿™é‡Œä¹Ÿä¹ˆåŠæ³•å†™ä¸€ä¸ªdemo.</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83">æ³¨å†Œä¸­å¿ƒ</a>
<ul>
<li><a href="#%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90">ç®€å•ä¾‹å­</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0">å®ç°</a></li>
<li><a href="#%E6%B3%A8%E6%84%8F%E7%82%B9">æ³¨æ„ç‚¹</a></li>
</ul>
</li>
<li><a href="#leader%E9%80%89%E4%B8%BE">Leaderé€‰ä¸¾</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			// for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
			// 	n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
			// 	for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
			// 		n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
			// 	}
			// }
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>