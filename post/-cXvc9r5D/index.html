<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Curator - åˆ†å¸ƒå¼é”çš„å®ç°åŸç† &amp; å¦‚ä½•ä½¿ç”¨ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/-cXvc9r5D/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Curator - åˆ†å¸ƒå¼é”çš„å®ç°åŸç† &amp; å¦‚ä½•ä½¿ç”¨</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-03-26</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/-cXvc9r5D/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/I3pJJjYod0F/"
								class="tag">Zookeeper</a> |
							 <a
								href="https://anthony-dong.github.io/tag/ttg8Ug7wWN3/"
								class="tag">Curator</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2519å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">12 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<h2 id="curatoråˆ†å¸ƒå¼é”-åŸºæœ¬ä½¿ç”¨">Curatoråˆ†å¸ƒå¼é” - åŸºæœ¬ä½¿ç”¨</h2>
<p>æˆ‘çš„ä»£ç å…¨éƒ¨æ¥è‡ªäº <a href="https://github.com/apache/curator/tree/master/curator-examples/src/main/java/locking">https://github.com/apache/curator/tree/master/curator-examples/src/main/java/locking</a></p>
<p>è¿™ä¸ªæ˜¯å®˜æ–¹æä¾›çš„ä¾‹å­, æˆ‘è§‰å¾—æŒºå¥½çš„, äººå®¶ä»£ç å†™çš„ä¹Ÿä¸é”™.</p>
<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåŒæ­¥çš„èµ„æº. ä¹Ÿå°±æ˜¯è¿™ä¸ªè¿‡ç¨‹å®ƒå¿…é¡»æ˜¯çº¿ç¨‹åŒæ­¥çš„, ä¸ç„¶ä¸€å®šä¼šå‡ºç°å¼‚å¸¸.  æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªcasæ“ä½œ , å¦‚æœå¤±è´¥åˆ™å¼‚å¸¸.</p>
<pre><code class="language-java">public class FakeLimitedResource {
    private final AtomicBoolean inUse = new AtomicBoolean(false);

    public void use() throws InterruptedException {
        // in a real application this would be accessing/manipulating a shared resource
        if (!inUse.compareAndSet(false, true)) {
            throw new IllegalStateException(&quot;Needs to be used by one client at a time&quot;);
        }

        try {
            // æ¨¡æ‹ŸçœŸå®æ“ä½œæ—¶é•¿.
            Thread.sleep((long) (100 * Math.random()));
        } finally {
            // æœ€åæˆ‘ä»¬é‡ç½®çŠ¶æ€é‡.
            inUse.set(false);
        }
    }
}

</code></pre>
<p>æˆ‘ä»¬çš„é”.</p>
<pre><code class="language-java">public class ExampleClientThatLocks {
    private final InterProcessMutex lock;
    private final FakeLimitedResource resource;
    private final String clientName;

    // åˆ›å»ºè¿™ä¸ªæ’å®ƒé”.
    public ExampleClientThatLocks(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) {
        this.resource = resource;
        this.clientName = clientName;
        // è¿™å°±æ˜¯ curatoræä¾›çš„ æ’å®ƒé”. 
        lock = new InterProcessMutex(client, lockPath);
    }

    public void doWork(long time, TimeUnit unit) throws Exception {
        // è¿™é‡Œå°±æ˜¯å»è·å–é”, curatorçš„æ’å®ƒé”å¿…é¡»è®¾ç½®è¶…æ—¶æ—¶é—´. æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®.
        if (!lock.acquire(time, unit)) {
            // è¶…æ—¶æŠ›å‡ºå¼‚å¸¸.
            throw new IllegalStateException(clientName + &quot; could not acquire the lock&quot;);
        }
        try {
            // ä½¿ç”¨èµ„æº.
            System.out.println(clientName + &quot; has the lock&quot;);
            resource.use();
        } finally {
            // é‡Šæ”¾é”.
            System.out.println(clientName + &quot; releasing the lock&quot;);
            lock.release(); // always release the lock in a finally block
        }
    }
}
</code></pre>
<p>ä¸»ç¨‹åº</p>
<pre><code class="language-java">public class LockingExample {
    private static final int QTY = 5;
    private static final int REPETITIONS = QTY * 10;

    private static final String PATH = &quot;/examples/locks&quot;;

    public static void main(String[] args) throws Exception {
        // all of the useful sample code is in ExampleClientThatLocks.java

        // FakeLimitedResource simulates some external resource that can only be access by one process at a time
        // æˆ‘ä»¬è¦æ±‚åŒæ­¥çš„èµ„æº.
        final FakeLimitedResource resource = new FakeLimitedResource();

        // å¤šçº¿ç¨‹å¹¶å‘æ“ä½œ.
        ExecutorService service = Executors.newFixedThreadPool(QTY);
        // è¿™ä¸ªæ˜¯ä¸€ä¸ªzkçš„æµ‹è¯•æœåŠ¡å™¨. æˆ‘æ²¡æœ‰ä½¿ç”¨.
//        final TestingServer server = new TestingServer();
        try {
            for (int i = 0; i &lt; QTY; ++i) {
                final int index = i;
                Callable&lt;Void&gt; task = new Callable&lt;Void&gt;() {
                    @Override
                    public Void call() throws Exception {
                        // è¿‡ç¨‹å¾ˆç®€å• . å°±æ˜¯åˆ›å»ºå®¢æˆ·ç«¯.
                        CuratorFramework client = CuratorFrameworkFactory.newClient(&quot;192.168.58.131:2181&quot;, new ExponentialBackoffRetry(1000, 3));
                        try {
                            // å¯åŠ¨
                            client.start();

                            // æˆ‘ä»¬å»åˆ›å»ºé”.
                            ExampleClientThatLocks example = new ExampleClientThatLocks(client, PATH, resource, &quot;Client &quot; + index);
                            // ç„¶åå†æ‰§è¡Œä¸šåŠ¡é€»è¾‘. (åˆ†å¸ƒå¼é”)
                            for (int j = 0; j &lt; REPETITIONS; ++j) {
                                example.doWork(10, TimeUnit.MINUTES);
                            }
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        } catch (Exception e) {
                            e.printStackTrace();
                            // log or do something
                        } finally {
                            // æœ€åè®°å¾—é‡Šæ”¾å®¢æˆ·ç«¯
                            CloseableUtils.closeQuietly(client);
                        }
                        return null;
                    }
                };
                // æäº¤task.
                service.submit(task);
            }

            // ä¼˜é›…å…³é—­
            service.shutdown();
            service.awaitTermination(10, TimeUnit.MINUTES);
        } finally {
//            CloseableUtils.closeQuietly(server);
        }
    }
}
</code></pre>
<p>æ‰“å°ä¸€ä¸‹ä¿¡æ¯</p>
<pre><code class="language-java">Client 0 has the lock
Client 0 releasing the lock
Client 3 has the lock
Client 3 releasing the lock
Client 4 has the lock
Client 4 releasing the lock
Client 1 has the lock
Client 1 releasing the lock
Client 2 has the lock
Client 2 releasing the lock
</code></pre>
<h2 id="curatorå®ç°åˆ†å¸ƒå¼é”çš„åŸç†">Curatorå®ç°åˆ†å¸ƒå¼é”çš„åŸç†</h2>
<h3 id="lockacquiretime-unit"><code>lock.acquire(time, unit)</code></h3>
<p><code>lock.acquire(time, unit)</code> å¦‚ä¸‹ :</p>
<pre><code class="language-java">public boolean acquire(long time, TimeUnit unit) throws Exception
{
    return internalLock(time, unit);
}
</code></pre>
<p><code>internalLock(time, unit);</code> :</p>
<pre><code class="language-java">private boolean internalLock(long time, TimeUnit unit) throws Exception
{
    /*
       Note on concurrency: a given lockData instance
       can be only acted on by a single thread so locking isn't necessary
    */

    Thread currentThread = Thread.currentThread();

	// å¯é‡å…¥çš„å‰æå»ºç«‹åœ¨å•çº¿ç¨‹ä¸Š. ä»–ä¸»è¦æ˜¯ç»™å½“å‰çº¿ç¨‹çš„çŠ¶æ€é‡+1 , å…ˆä¼šåˆ¤æ–­å½“å‰çš„æ•°æ®æ˜¯ä¸æ˜¯ç©º.
    LockData lockData = threadData.get(currentThread);
    if ( lockData != null )
    {
        // re-entering
        lockData.lockCount.incrementAndGet();
        return true;
    }

	// ç©º, å°±å»æ‰§è¡Œlock.
    String lockPath = internals.attemptLock(time, unit, getLockNodeBytes());
    if ( lockPath != null )
    {
    // è¿™é‡Œå°±æ˜¯è®°å½•ä¸€ä¸‹çŠ¶æ€ , å®ç°å¯é‡å…¥. åŒæ—¶è®°å½•å½“å‰èŠ‚ç‚¹ä¿¡æ¯.
        LockData newLockData = new LockData(currentThread, lockPath);
        threadData.put(currentThread, newLockData);
        return true;
    }

    return false;
}
</code></pre>
<p><code>internals.attemptLock(time, unit, getLockNodeBytes());</code></p>
<pre><code class="language-java">String attemptLock(long time, TimeUnit unit, byte[] lockNodeBytes) throws Exception
{
// ä¸€äº›å®šä¹‰çš„å˜é‡  . åŸºæœ¬æ–‡å­—å°±å¯ä»¥çœ‹æ‡‚å•¥æ„æ€. 
    final long      startMillis = System.currentTimeMillis();
    final Long      millisToWait = (unit != null) ? unit.toMillis(time) : null;
    final byte[]    localLockNodeBytes = (revocable.get() != null) ? new byte[0] : lockNodeBytes;
    int             retryCount = 0;

    String          ourPath = null;
    boolean         hasTheLock = false;
    boolean         isDone = false;
    while ( !isDone )
    {
        isDone = true;

        try
        {
        // åœ¨è¿™é‡Œå…¶å®æ˜¯åˆ›å»ºä¸€ä¸ªå­ èŠ‚ç‚¹. zkåˆ›å»º EPHEMERAL_SEQUENTIALèŠ‚ç‚¹, æœ¬èº«å°±æ˜¯ä¸ç”¨è€ƒè™‘å¹¶å‘çš„.
            ourPath = driver.createsTheLock(client, path, localLockNodeBytes);
            // è¿™é‡Œæ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘.
            hasTheLock = internalLockLoop(startMillis, millisToWait, ourPath);
        }
        catch ( KeeperException.NoNodeException e )
        {
            // gets thrown by StandardLockInternalsDriver when it can't find the lock node
            // this can happen when the session expires, etc. So, if the retry allows, just try it all again
            if ( client.getZookeeperClient().getRetryPolicy().allowRetry(retryCount++, System.currentTimeMillis() - startMillis, RetryLoop.getDefaultRetrySleeper()) )
            {
                isDone = false;
            }
            else
            {
                throw e;
            }
        }
    }

// å¦‚æœæ‹¿åˆ°é”, å°±returnäº†.
    if ( hasTheLock )
    {
        return ourPath;
    }

    return null;
}
</code></pre>
<p><code>org.apache.curator.framework.recipes.locks.StandardLockInternalsDriver#createsTheLock</code></p>
<pre><code class="language-java">@Override
public String createsTheLock(CuratorFramework client, String path, byte[] lockNodeBytes) throws Exception
{
// è¿™ä¸ªè¿‡ç¨‹å¾ˆç®€å• , å°±æ˜¯ä¸€ä¸ªåˆ›å»ºä¸€ä¸ª EPHEMERAL_SEQUENTIALèŠ‚ç‚¹ . ç„¶ååˆ›å»ºå°±å¥½äº†. 
    String ourPath;
    if ( lockNodeBytes != null )
    {
        ourPath = client.create().creatingParentContainersIfNeeded().withProtection().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath(path, lockNodeBytes);
    }
    else
    {
        ourPath = client.create().creatingParentContainersIfNeeded().withProtection().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath(path);
    }
    return ourPath;
}
</code></pre>
<p>å…¶æ¬¡å°±æ˜¯ç¬¬äºŒæ­¥ <code>hasTheLock = internalLockLoop(startMillis, millisToWait, ourPath);</code>  (æ ¸å¿ƒæ­¥éª¤)</p>
<pre><code class="language-java">private boolean internalLockLoop(long startMillis, Long millisToWait, String ourPath) throws Exception
{
// çŠ¶æ€
    boolean     haveTheLock = false;
    boolean     doDelete = false;
    try
    {
        if (revocable.get() != null )
        {
            client.getData().usingWatcher(revocableWatcher).forPath(ourPath);
        }

// å¦‚æœå½“å‰çš„çŠ¶æ€æ˜¯å¯åŠ¨æˆåŠŸçš„è¯. åŒæ—¶ä¹Ÿæ²¡æœ‰æ‹¥æœ‰é”. è¿™æ˜¯ä¸€ä¸ªå¾ªç¯. 
        while ( (client.getState() == CuratorFrameworkState.STARTED) &amp;&amp; !haveTheLock )
        {
            List&lt;String&gt;        children = getSortedChildren();
            String              sequenceNodeName = ourPath.substring(basePath.length() + 1); // +1 to include the slash

// driverå…¶å®å°±æ˜¯ä¸€ä¸ªhandler . å…·ä½“çœ‹ä¸‹é¢è§£é‡Š. å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ‹¿åˆ°é”äº†, åŒæ—¶è¿”å›ä¸€ä¸ªå‰ç½®èŠ‚ç‚¹.
            PredicateResults    predicateResults = driver.getsTheLock(client, children, sequenceNodeName, maxLeases);
            if ( predicateResults.getsTheLock() )
            {
                haveTheLock = true;
            }
            else
            {
            // è¿™é‡Œå°±æ˜¯å‰ç½®èŠ‚ç‚¹.
                String  previousSequencePath = basePath + &quot;/&quot; + predicateResults.getPathToWatch();

                synchronized(this)
                {
                    try 
                    {
                        // use getData() instead of exists() to avoid leaving unneeded watchers which is a type of resource leak
                        // è·å–å‰ç½®èŠ‚ç‚¹.åŒæ—¶ç›‘å¬æ­¤èŠ‚ç‚¹. 
                        // å¥½å¤„æ˜¯, å¦‚æœå‰ç½®èŠ‚ç‚¹åˆ é™¤/æˆ–è€…ä¿®æ”¹æ•°æ®, æ­¤æ—¶å¯ä»¥é€šçŸ¥ notify,åœæ­¢wait. 
                        // ä¸ºå•¥è¦ç”¨ getData 
                        // ä½¿ç”¨getDataï¼ˆï¼‰è€Œä¸æ˜¯existï¼ˆï¼‰ä»¥é¿å…ç•™ä¸‹ä¸å¿…è¦çš„è§‚å¯Ÿè€…ï¼Œè¿™æ˜¯ä¸€ç§èµ„æºæ³„æ¼
                        // å…¶å®è¿™é‡Œæœ‰é—®é¢˜çš„, å¦‚æœæˆ‘ä»¬åœ¨ç›‘å¬æ­¤èŠ‚ç‚¹,å¦‚æœæ­¤èŠ‚ç‚¹è¢«åˆ é™¤äº†ä¼šæ€ä¹ˆåŠå‘¢ ?  å¹¶å‘ä¸‹ä¸€å®šä¼šå‡ºç°è¿™ç§æƒ…å†µ. æˆ‘ä»¬æ‹¿åˆ°å‰ç½®èŠ‚ç‚¹çš„ç¬é—´,å‰ç½®èŠ‚ç‚¹å·²ç»è¢«é‡Šæ”¾é”, è¢«åˆ é™¤äº†.æ‰€ä»¥åé¢è¿™ä¸ªcatchå•¥ä¹Ÿæ²¡åš,ç»§ç»­é‡è¯•.
                        // watcherçš„ç›®çš„å°±æ˜¯ä¸ºäº†è¢«notify. å¦‚æœå‰ç½®èŠ‚ç‚¹æ”¹åŠ¨äº†, æˆ‘ä¸€å®šä¼šæ”¶åˆ°ä¿¡æ¯, æ­¤æ—¶notifyå°±å¯ä»¥äº†.
                        client.getData().usingWatcher(watcher).forPath(previousSequencePath);
                        // æœ‰ä¸€ä¸ªè¶…æ—¶åˆ¤æ–­, è¶…æ—¶åˆ™åˆ é™¤å½“å‰èŠ‚ç‚¹.
                        if ( millisToWait != null )
                        {
                            millisToWait -= (System.currentTimeMillis() - startMillis);
                            startMillis = System.currentTimeMillis();
                            if ( millisToWait &lt;= 0 )
                            {
                                doDelete = true;    // timed out - delete our node
                                break;
                            }

// å¦åˆ™åˆ™ waitè¶…æ—¶æ—¶é—´.
                            wait(millisToWait);
                        }
                        else
                        {
                        // æ²¡æœ‰æŒ‡å®šè¶…æ—¶æ—¶é—´, å°±æ˜¯æ°¸ä¹…çš„ç­‰å¾….
                            wait();
                        }
                    }
                    catch ( KeeperException.NoNodeException e ) 
                    {
                        // it has been deleted (i.e. lock released). Try to acquire again
                    }
                }
            }
        }
    }
    catch ( Exception e )
    {
        ThreadUtils.checkInterrupted(e);
        doDelete = true;
        throw e;
    }
    finally
    {
    // æœ€å, å¦‚æœéœ€è¦åˆ é™¤(è¿™é‡Œæ˜¾ç„¶æ˜¯è¶…æ—¶çš„è¯ä¼šè§¦å‘è¿™ä¸ªæ“ä½œ.). åˆ™åˆ é™¤èŠ‚ç‚¹.
        if ( doDelete )
        {
            deleteOurPath(ourPath);
        }
    }
    return haveTheLock;
}
</code></pre>
<p><code>getSortedChildren</code> å…¶å®æ˜¯ä¸ºäº† å®ç°å…¬å¹³æ€§.  ä¹Ÿä¸èƒ½è¯´å…¬å¹³, ä½†å®é™…ä¸Šæ˜¯å¾ˆå…¬å¹³çš„, ä½†ä¸æ˜¯ç»å¯¹çš„å…¬å¹³, å› ä¸ºçœ‹zk-serverç«¯åˆ›å»ºèŠ‚ç‚¹å¦‚ä½•å®ç°çš„.</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹æˆ‘ä»¬çš„lockèŠ‚ç‚¹ . ä»¥ä¸ºç³»ç»Ÿåˆ›å»º<strong>é¡ºåºèŠ‚ç‚¹, è¿™ä¸ªæ˜¯zk åŸç”Ÿæä¾›çš„</strong>.</p>
<pre><code class="language-java">_c_258cf713-62d2-45bd-8967-963eac169d4a-lock-0000000188
_c_4d17dd48-1e07-4434-94a4-d3412eba1d47-lock-0000000187
_c_b3f9ab7c-e863-40bf-aa2c-c6aa16700e73-lock-0000000185
_c_b7d9b167-063a-401f-a7f7-9d9399c31296-lock-0000000184
_c_e6abf5a9-f593-429f-b6e7-7d2563680ff0-lock-0000000186
</code></pre>
<pre><code class="language-java">public static List&lt;String&gt; getSortedChildren(CuratorFramework client, String basePath, final String lockName, final LockInternalsSorter sorter) throws Exception
{
    try
    {
    // è·å–å­èŠ‚ç‚¹.
        List&lt;String&gt; children = client.getChildren().forPath(basePath);
        List&lt;String&gt; sortedList = Lists.newArrayList(children);
        Collections.sort
        (
            sortedList,
            new Comparator&lt;String&gt;()
            {
                @Override
                public int compare(String lhs, String rhs)
                {
                    return sorter.fixForSorting(lhs, lockName).compareTo(sorter.fixForSorting(rhs, lockName));
                }
            }
        );
        return sortedList;
    }
    catch ( KeeperException.NoNodeException ignore )
    {
        return Collections.emptyList();
    }
}
</code></pre>
<p><code>driver.getsTheLock(client, children, sequenceNodeName, maxLeases);</code>  <strong>æ ¸å¿ƒ , é‡è¦</strong></p>
<pre><code class="language-java">@Override
public PredicateResults getsTheLock(CuratorFramework client, List&lt;String&gt; children, String sequenceNodeName, int maxLeases) throws Exception
{
// 1.æ‹¿åˆ°ä¸€ä¸ªå­èŠ‚ç‚¹. æ¯”å¦‚[0,1,2,3,4] , å½“å‰èŠ‚ç‚¹æ˜¯1 , é‚£ä¹ˆè¿”å›çš„indexåˆ™æ˜¯1 , æ­¤æ—¶
    int             ourIndex = children.indexOf(sequenceNodeName);
    validateOurIndex(sequenceNodeName, ourIndex);

// 2.å»æ¯”è¾ƒ.æœ€å¤šå¯ä»¥è·å–å‡ ä¸ª, è¿™é‡Œé»˜è®¤æ˜¯maxLeases=1(å› ä¸ºæ’å®ƒé”ä¹ˆ) , æ‰€ä»¥  1&lt;1 false. åˆ™è¿”å›false.
    boolean         getsTheLock = ourIndex &lt; maxLeases;
// 3.è·å–å¤±è´¥, ç„¶åç›‘å¬å®ƒçš„å‰ä¸€ä¸ªèŠ‚ç‚¹.(åç»­è§£é‡Šä¸ºä»€ä¹ˆ.)
    String          pathToWatch = getsTheLock ? null : children.get(ourIndex - maxLeases);

    return new PredicateResults(pathToWatch, getsTheLock);
}
</code></pre>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æ‰€ä»¥ zkå®ç°å¯é‡å…¥çš„æœºåˆ¶å…¶å®æ˜¯ å’ŒAQS å·®ä¸å¤š,</p>
<p>åˆ©ç”¨zkçš„<code>EPHEMERAL_SEQUENTIAL</code> èŠ‚ç‚¹,  æä¾›äº†AQSé»˜è®¤çš„é˜Ÿåˆ—æœºåˆ¶. çº¿ç¨‹å®‰å…¨çš„.</p>
<p>å†å…¶æ¬¡, è·å–é”çš„æ“ä½œ,æ˜¯æ‰§è¡Œ æŸ¥æ‰¾å­èŠ‚ç‚¹ (æ’åºä¸€ä¸‹ , æ ¹æ®<code>EPHEMERAL_SEQUENTIAL</code>çš„é¡ºåºè¿›è¡Œæ’åˆ—)  , æ­¤æ—¶ä¼šæ ¹æ®å½“å‰èŠ‚ç‚¹çš„ä½ç½®,åšåˆ¤æ–­, æ˜¯å¦æ˜¯æ‹¥æœ‰çš„èŠ‚ç‚¹. å¦‚æœä¸æ˜¯åˆ™ç»§ç»­.  å¦‚æœæ˜¯åˆ™ä»£è¡¨å½“å‰èŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰é” ,  å¦åˆ™ç»§ç»­é‡å¤æ“ä½œ.</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªå¹¶å‘é—®é¢˜ :  ç¬¬ä¸€ç‚¹ , æ¯”å¦‚æˆ‘æ‹¿åˆ°çš„æˆ‘å½“å‰ä½ç½®, æ¯”å¦‚æ­¤æ—¶è·å–çš„å­èŠ‚ç‚¹é¡ºåºä¸º [0,1,2,3,4,5] , æˆ‘æ­¤æ—¶æ˜¯ç´¢å¼•1çš„ä½ç½®, æ­¤æ—¶æˆ‘ä¸å¯ä»¥æ‹¿åˆ°é”, ä½†æ˜¯å°±åœ¨æˆ‘æ¯”è¾ƒçš„è¿‡ç¨‹ä¸­, æ­¤æ—¶å‰ç½®èŠ‚ç‚¹å·²ç»é‡Šæ”¾é”äº†. ä¹Ÿå°±æ˜¯åˆ é™¤äº†.  é‚£ä¹ˆæ­¤æ—¶æˆ‘å°±æ˜¯ç¬¬ä¸€ä¸ª, ä½†æ˜¯æˆ‘å½“å‰çš„çŠ¶æ€è¶‹åŠ¿æœªæ‹¥æœ‰é”.   æ‰€ä»¥æˆ‘ä¼šå»ç›‘å¬æˆ‘çš„å‰ç½®èŠ‚ç‚¹ , ä¹Ÿå°±æ˜¯ç´¢å¼•ä¸º0çš„èŠ‚ç‚¹. æ­¤æ—¶ç›‘å¬å¤±è´¥. æˆ‘ä¼šç»§ç»­é‡å¤ä¸€å¼€å§‹çš„æ“ä½œ. è¿™æ—¶å€™åˆ¤æ–­, æˆ‘æ˜¯ç¬¬ä¸€ä¸ªä½ç½®. å“ˆå“ˆå“ˆ. æ‹¿åˆ°é”äº†.</p>
<p>æ‰€ä»¥åŸºæœ¬å°±æ˜¯ä¸ªè¿™ å¾ªç¯å¾€å¤çš„è¿‡ç¨‹.</p>
<h3 id="lockrelease"><code>lock.release();</code></h3>
<p>æˆ‘ä»¬çœ‹çœ‹ é‡Šæ”¾é”çš„è¿‡ç¨‹ :  <code>lock.release();</code></p>
<pre><code class="language-java">public void release() throws Exception
{
    /*
        Note on concurrency: a given lockData instance
        can be only acted on by a single thread so locking isn't necessary
     */

    Thread currentThread = Thread.currentThread();
    LockData lockData = threadData.get(currentThread);
    // å¦‚æœæ­¤æ—¶é‡Šæ”¾é”, æ­¤æ—¶æ‹¿åˆ°çº¿ç¨‹å´æœªæ‹¥æœ‰, åˆ™æŠ›å‡ºå¼‚å¸¸,æ‰€ä»¥è·å–é”å’Œé‡Šæ”¾é”å¿…é¡»åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…æ‰§è¡Œ.
    if ( lockData == null )
    {
        throw new IllegalMonitorStateException(&quot;You do not own the lock: &quot; + basePath);
    }

// è·å–å½“å‰çš„ çŠ¶æ€.  ç„¶åå‡ä¸€. å¦‚æœä¸ä¸º0 , è¿˜éœ€è¦é‡Šæ”¾. å…¶å®å°±æ˜¯ä¸€ä¸ªå¯é‡å…¥é”. ä½†æ˜¯æˆ‘è§‰å¾—è¿™é‡Œæ²¡å¿…è¦ç”¨cas, æœ¬æ¥å°±æ˜¯å•çº¿ç¨‹. å“ˆå“ˆå“ˆ. ä¸æ‡‚ä¸ºå•¥è¿™é‡Œè¿˜è¦ç”¨. 
    int newLockCount = lockData.lockCount.decrementAndGet();
    if ( newLockCount &gt; 0 )
    {
        return;
    }
    if ( newLockCount &lt; 0 )
    {
        throw new IllegalMonitorStateException(&quot;Lock count has gone negative for lock: &quot; + basePath);
    }
    try
    {
    // æœ€åå¦‚æœåˆ°0äº† , å®Œå…¨é‡Šæ”¾æ‰äº†, å†æ‰§è¡Œé‡Šæ”¾èŠ‚ç‚¹. è¿™é‡Œä¸»è¦åšçš„æ˜¯é‡Šæ”¾èµ„æº.ç„¶ååˆ é™¤å½“å‰èŠ‚ç‚¹
        internals.releaseLock(lockData.lockPath);
    }
    finally
    {
    // é‡Šæ”¾mapèµ„æº, é˜²æ­¢å†…å­˜æ³„æ¼.
        threadData.remove(currentThread);
    }
}
</code></pre>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#curator%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">Curatoråˆ†å¸ƒå¼é” - åŸºæœ¬ä½¿ç”¨</a></li>
<li><a href="#curator%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E7%90%86">Curatorå®ç°åˆ†å¸ƒå¼é”çš„åŸç†</a>
<ul>
<li><a href="#lockacquiretime-unit"><code>lock.acquire(time, unit)</code></a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#lockrelease"><code>lock.release();</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			// for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
			// 	n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
			// 	for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
			// 		n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
			// 	}
			// }
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>