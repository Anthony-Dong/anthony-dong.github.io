<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Netty  - å†…å­˜æ¨¡å‹åŸç† (ByteBufç®¡ç†) | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/PhckRTE4Q/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223360682" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Netty  - å†…å­˜æ¨¡å‹åŸç† (ByteBufç®¡ç†)</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-01-30</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/PhckRTE4Q/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/fn4lTiaKxHO/"
								class="tag">netty</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">3999å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">15 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	Nettyä½œä¸ºä¸€æ¬¾é«˜æ€§èƒ½ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œå®ç°äº†ä¸€å¥—é«˜æ€§èƒ½å†…å­˜ç®¡ç†æœºåˆ¶</p>
<p>â€‹	é€šè¿‡å­¦ä¹ å…¶ä¸­çš„å®ç°åŸç†ã€ç®—æ³•ã€å¹¶å‘è®¾è®¡ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å†™å‡ºæ›´ä¼˜é›…ã€æ›´é«˜æ€§èƒ½çš„ä»£ç ï¼›å½“ä½¿ç”¨Nettyæ—¶ç¢°åˆ°å†…å­˜æ–¹é¢çš„é—®é¢˜æ—¶ï¼Œä¹Ÿå¯ä»¥æ›´é«˜æ•ˆå®šä½æ’æŸ¥å‡ºæ¥</p>
<p>æœ¬æ–‡åŸºäºNetty4.1.43.Finalä»‹ç»å…¶ä¸­çš„å†…å­˜ç®¡ç†æœºåˆ¶</p>
</blockquote>
<h2 id="bytebuf-åˆ†ç±»">ByteBuf åˆ†ç±»</h2>
<p>Nettyä½¿ç”¨ByteBufå¯¹è±¡ä½œä¸ºæ•°æ®å®¹å™¨ï¼Œè¿›è¡ŒI/Oè¯»å†™æ“ä½œï¼ŒNettyçš„å†…å­˜ç®¡ç†ä¹Ÿæ˜¯å›´ç»•ç€ByteBufå¯¹è±¡é«˜æ•ˆåœ°åˆ†é…å’Œé‡Šæ”¾</p>
<p>å½“è®¨è®ºByteBufå¯¹è±¡ç®¡ç†ï¼Œä¸»è¦ä»ä»¥ä¸‹æ–¹é¢è¿›è¡Œåˆ†ç±»ï¼š</p>
<ul>
<li><strong>Pooled å’Œ Unpooled</strong></li>
</ul>
<p><strong>Unpooled</strong>ï¼Œéæ± åŒ–å†…å­˜æ¯æ¬¡åˆ†é…æ—¶ç›´æ¥è°ƒç”¨ç³»ç»Ÿ API å‘æ“ä½œç³»ç»Ÿç”³è¯·ByteBuféœ€è¦çš„åŒæ ·å¤§å°å†…å­˜ï¼Œç”¨å®Œåé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›è¡Œé‡Šæ”¾<br>
<strong>Pooled</strong>ï¼Œæ± åŒ–å†…å­˜åˆ†é…æ—¶åŸºäºé¢„åˆ†é…çš„ä¸€æ•´å—å¤§å†…å­˜ï¼Œå–å…¶ä¸­çš„éƒ¨åˆ†å°è£…æˆByteBufæä¾›ä½¿ç”¨ï¼Œç”¨å®Œåå›æ”¶åˆ°å†…å­˜æ± ä¸­</p>
<blockquote>
<p><strong>tips:</strong> Netty4é»˜è®¤ä½¿ç”¨Pooledçš„æ–¹å¼ï¼Œå¯é€šè¿‡å‚æ•°-Dio.netty.allocator.type=unpooledæˆ–pooledè¿›è¡Œè®¾ç½®</p>
</blockquote>
<ul>
<li><strong>Heap å’Œ Direct</strong><br>
<strong>Heap</strong>ï¼ŒæŒ‡ByteBufå…³è”çš„å†…å­˜JVMå †å†…åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜å—GC ç®¡ç†<br>
<strong>Direct</strong>ï¼ŒæŒ‡ByteBufå…³è”çš„å†…å­˜åœ¨JVMå †å¤–åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜ä¸å—GCç®¡ç†ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨å®ç°ç”³è¯·å’Œé‡Šæ”¾ï¼Œåº•å±‚åŸºäºJava NIOçš„DirectByteBufferå¯¹è±¡</li>
</ul>
<blockquote>
<p><strong>noteï¼š</strong> ä½¿ç”¨å †å¤–å†…å­˜çš„ä¼˜åŠ¿åœ¨äºï¼ŒJavaè¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œéœ€è¦ä¼ å…¥æ•°æ®æ‰€åœ¨ç¼“å†²åŒºèµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œç”±äºGCçš„å­˜åœ¨ï¼Œå¯¹è±¡åœ¨å †ä¸­çš„ä½ç½®å¾€å¾€ä¼šå‘ç”Ÿç§»åŠ¨ï¼Œå¯¼è‡´å¯¹è±¡åœ°å€å˜åŒ–ï¼Œç³»ç»Ÿè°ƒç”¨å‡ºé”™ã€‚ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œå½“åŸºäºå †å†…å­˜è¿›è¡ŒI/Oç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œéœ€è¦å°†å†…å­˜æ‹·è´åˆ°å †å¤–ï¼Œè€Œç›´æ¥åŸºäºå †å¤–å†…å­˜è¿›è¡ŒI/Oæ“ä½œçš„è¯ï¼Œå¯ä»¥èŠ‚çœè¯¥æ‹·è´æˆæœ¬</p>
</blockquote>
<h2 id="æ± åŒ–pooled-å¯¹è±¡ç®¡ç†">æ± åŒ–(Pooled) å¯¹è±¡ç®¡ç†</h2>
<p>éæ± åŒ–å¯¹è±¡(Unpooled)ï¼Œä½¿ç”¨å’Œé‡Šæ”¾å¯¹è±¡ä»…éœ€è¦è°ƒç”¨åº•å±‚æ¥å£å®ç°ï¼Œæ± åŒ–å¯¹è±¡å®ç°åˆ™å¤æ‚å¾—å¤šï¼Œå¯ä»¥å¸¦ç€ä»¥ä¸‹é—®é¢˜è¿›è¡Œç ”ç©¶ï¼š</p>
<ul>
<li>å†…å­˜æ± ç®¡ç†ç®—æ³•æ˜¯å¦‚ä½•å®ç°é«˜æ•ˆå†…å­˜åˆ†é…é‡Šæ”¾ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡</li>
<li>é«˜è´Ÿè½½ä¸‹å†…å­˜æ± ä¸æ–­ç”³è¯·/é‡Šæ”¾ï¼Œå¦‚ä½•å®ç°å¼¹æ€§ä¼¸ç¼©</li>
<li>å†…å­˜æ± ä½œä¸ºå…¨å±€æ•°æ®ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¦‚ä½•å‡å°‘é”ç«äº‰</li>
</ul>
<h2 id="ç®—æ³•è®¾è®¡">ç®—æ³•è®¾è®¡</h2>
<blockquote>
<p>â€‹	æ± åŒ–å¯¹è±¡ç®—æ³•è®¾è®¡æ€è·¯</p>
</blockquote>
<h3 id="11-æ•´ä½“åŸç†">1.1 æ•´ä½“åŸç†</h3>
<p>Nettyå…ˆå‘ç³»ç»Ÿç”³è¯·ä¸€æ•´å—è¿ç»­å†…å­˜ï¼Œç§°ä¸ºchunkï¼Œé»˜è®¤å¤§å°chunkSize = 16Mbï¼Œé€šè¿‡PoolChunkå¯¹è±¡åŒ…è£…ã€‚ä¸ºäº†æ›´ç»†ç²’åº¦çš„ç®¡ç†ï¼ŒNettyå°†chunkè¿›ä¸€æ­¥æ‹†åˆ†ä¸ºpageï¼Œé»˜è®¤æ¯ä¸ªchunkåŒ…å«2048ä¸ªpage(pageSize = 8Kb)</p>
<p>ä¸åŒå¤§å°æ± åŒ–å†…å­˜å¯¹è±¡çš„åˆ†é…ç­–ç•¥ä¸åŒï¼Œä¸‹é¢é¦–å…ˆä»‹ç»ç”³è¯·å†…å­˜å¤§å°åœ¨**(pageSize/2, chunkSize]**åŒºé—´èŒƒå›´å†…çš„æ± åŒ–å¯¹è±¡çš„åˆ†é…åŸç†ï¼Œå…¶ä»–å¤§å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…åŸç†åé¢å†ä»‹ç»ã€‚åœ¨åŒä¸€ä¸ªchunkä¸­ï¼ŒNettyå°†pageæŒ‰ç…§ä¸åŒç²’åº¦è¿›è¡Œå¤šå±‚åˆ†ç»„ç®¡ç†ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/39aac5a4-fdfd-4189-98bc-a98ee22cc726.webp" alt="img" loading="lazy"></figure>
<ul>
<li>ç¬¬1å±‚ï¼Œåˆ†ç»„å¤§å°size = 1*pageSizeï¼Œä¸€å…±æœ‰2048ä¸ªç»„</li>
<li>ç¬¬2å±‚ï¼Œåˆ†ç»„å¤§å°size = 2*pageSizeï¼Œä¸€å…±æœ‰1024ä¸ªç»„</li>
<li>ç¬¬3å±‚ï¼Œåˆ†ç»„å¤§å°size = 4*pageSizeï¼Œä¸€å…±æœ‰512ä¸ªç»„<br>
...</li>
</ul>
<p>å½“è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œå°†è¯·æ±‚åˆ†é…çš„å†…å­˜æ•°å‘ä¸Šå–å€¼åˆ°æœ€æ¥è¿‘çš„åˆ†ç»„å¤§å°ï¼Œåœ¨è¯¥åˆ†ç»„å¤§å°çš„ç›¸åº”å±‚çº§ä¸­ä»å·¦è‡³å³å¯»æ‰¾ç©ºé—²åˆ†ç»„<br>
ä¾‹å¦‚è¯·æ±‚åˆ†é…å†…å­˜å¯¹è±¡ä¸º1.5 *pageSizeï¼Œå‘ä¸Šå–å€¼åˆ°åˆ†ç»„å¤§å°2 * pageSizeï¼Œåœ¨è¯¥å±‚åˆ†ç»„ä¸­æ‰¾åˆ°å®Œå…¨ç©ºé—²çš„ä¸€ç»„å†…å­˜è¿›è¡Œåˆ†é…ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/b3470a43-13a3-4f73-8cae-78ebe90eba6b.webp" alt="img" loading="lazy"></figure>
<p>å½“åˆ†ç»„å¤§å°2 * pageSizeçš„å†…å­˜åˆ†é…å‡ºå»åï¼Œä¸ºäº†æ–¹ä¾¿ä¸‹æ¬¡å†…å­˜åˆ†é…ï¼Œåˆ†ç»„è¢«æ ‡è®°ä¸º<strong>å…¨éƒ¨å·²ä½¿ç”¨</strong>(å›¾ä¸­çº¢è‰²æ ‡è®°)ï¼Œå‘ä¸Šæ›´ç²—ç²’åº¦çš„å†…å­˜åˆ†ç»„è¢«æ ‡è®°ä¸º<strong>éƒ¨åˆ†å·²ä½¿ç”¨</strong>(å›¾ä¸­é»„è‰²æ ‡è®°)</p>
<h3 id="12-ç®—æ³•ç»“æ„">1.2 ç®—æ³•ç»“æ„</h3>
<p>NettyåŸºäºå¹³è¡¡æ ‘å®ç°ä¸Šé¢æåˆ°çš„ä¸åŒç²’åº¦çš„å¤šå±‚åˆ†ç»„ç®¡ç†</p>
<p>å½“éœ€è¦åˆ›å»ºä¸€ä¸ªç»™å®šå¤§å°çš„ByteBufï¼Œç®—æ³•éœ€è¦åœ¨PoolChunkä¸­å¤§å°ä¸ºchunkSizeçš„å†…å­˜ä¸­ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤Ÿå®¹çº³ç”³è¯·åˆ†é…å†…å­˜çš„ä½ç½®</p>
<p>ä¸ºäº†æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾chunkä¸­èƒ½å®¹çº³è¯·æ±‚å†…å­˜çš„ä½ç½®ï¼Œç®—æ³•æ„å»ºä¸€ä¸ªåŸºäºbyteæ•°ç»„(memoryMap)å­˜å‚¨çš„å®Œå…¨å¹³è¡¡æ ‘ï¼Œè¯¥å¹³è¡¡æ ‘çš„å¤šä¸ªå±‚çº§æ·±åº¦ï¼Œå°±æ˜¯å‰é¢ä»‹ç»çš„æŒ‰ç…§ä¸åŒç²’åº¦å¯¹chunkè¿›è¡Œå¤šå±‚åˆ†ç»„ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/1634a653-415a-48de-a2c0-3fa251b6496c.webp" alt="img" loading="lazy"></figure>
<p>æ ‘çš„æ·±åº¦depthä»0å¼€å§‹è®¡ç®—ï¼Œå„å±‚èŠ‚ç‚¹æ•°ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å†…å­˜å¤§å°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">depth = 0ï¼Œ 1 nodeï¼ŒnodeSize = chunkSize
depth = 1ï¼Œ 2 nodesï¼ŒnodeSize = chunkSize/2
...
depth = dï¼Œ 2^d nodesï¼Œ nodeSize = chunkSize/(2^d)
...
depth = maxOrderï¼Œ 2^maxOrder nodesï¼Œ nodeSize = chunkSize/2^{maxOrder} = pageSize
</code></pre>
<p>æ ‘çš„æœ€å¤§æ·±åº¦ä¸ºmaxOrder(æœ€å¤§é˜¶ï¼Œé»˜è®¤å€¼11)ï¼Œé€šè¿‡è¿™æ£µæ ‘ï¼Œç®—æ³•åœ¨chunkä¸­çš„æŸ¥æ‰¾å°±å¯ä»¥è½¬æ¢ä¸ºï¼š</p>
<p><strong>å½“ç”³è¯·åˆ†é…å¤§å°ä¸ºchunkSize/2^kçš„å†…å­˜ï¼Œåœ¨å¹³è¡¡æ ‘é«˜åº¦ä¸ºkçš„å±‚çº§ä¸­ï¼Œä»å·¦åˆ°å³æœç´¢ç¬¬ä¸€ä¸ªç©ºé—²èŠ‚ç‚¹</strong></p>
<p>æ•°ç»„çš„ä½¿ç”¨åŸŸä»index = 1å¼€å§‹ï¼Œå°†å¹³è¡¡æ ‘æŒ‰ç…§å±‚æ¬¡é¡ºåºä¾æ¬¡å­˜å‚¨åœ¨æ•°ç»„ä¸­ï¼Œdepth = nçš„ç¬¬1ä¸ªèŠ‚ç‚¹ä¿å­˜åœ¨memoryMap[2^n] ä¸­ï¼Œç¬¬2ä¸ªèŠ‚ç‚¹ä¿å­˜åœ¨memoryMap[2^n+1]ä¸­ï¼Œä»¥æ­¤ç±»æ¨(ä¸‹å›¾ä»£è¡¨å·²åˆ†é…chunkSize/2)</p>
<figure data-type="image" tabindex="4"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/8ee6c0ed-995c-48c5-8e4b-cc5946c825cd.webp" alt="img" loading="lazy"></figure>
<p>å¯ä»¥æ ¹æ®memoryMap[id]çš„å€¼å¾—å‡ºèŠ‚ç‚¹çš„ä½¿ç”¨æƒ…å†µï¼ŒmemoryMap[id]å€¼è¶Šå¤§ï¼Œå‰©ä½™çš„å¯ç”¨å†…å­˜è¶Šå°‘</p>
<ul>
<li>memoryMap[id] = depth_of_idï¼š<strong>idèŠ‚ç‚¹ç©ºé—²</strong>ï¼Œ åˆå§‹çŠ¶æ€ï¼Œdepth_of_idçš„å€¼ä»£è¡¨idèŠ‚ç‚¹åœ¨æ ‘ä¸­çš„æ·±åº¦</li>
<li>memoryMap[id] = maxOrder + 1ï¼š<strong>idèŠ‚ç‚¹å…¨éƒ¨å·²ä½¿ç”¨</strong>ï¼ŒèŠ‚ç‚¹å†…å­˜å·²å®Œå…¨åˆ†é…ï¼Œæ²¡æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ç©ºé—²</li>
<li>depth_of_id &lt; memoryMap[id] &lt; maxOrder + 1ï¼š<strong>idèŠ‚ç‚¹éƒ¨åˆ†å·²ä½¿ç”¨</strong>ï¼ŒmemoryMap[id] çš„å€¼ xï¼Œä»£è¡¨<strong>idçš„å­èŠ‚ç‚¹ä¸­ï¼Œç¬¬ä¸€ä¸ªç©ºé—²èŠ‚ç‚¹ä½äºæ·±åº¦xï¼Œåœ¨æ·±åº¦[depth_of_id, x)çš„èŒƒå›´å†…æ²¡æœ‰ä»»ä½•ç©ºé—²èŠ‚ç‚¹</strong></li>
</ul>
<h3 id="13-ç”³è¯·é‡Šæ”¾å†…å­˜">1.3 ç”³è¯·/é‡Šæ”¾å†…å­˜</h3>
<p>å½“ç”³è¯·åˆ†é…å†…å­˜ï¼Œä¼šé¦–å…ˆå°†è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°å½’ä¸€åŒ–(å‘ä¸Šå–å€¼)ï¼Œé€šè¿‡PoolArena#normalizeCapacity()æ–¹æ³•ï¼Œå–æœ€è¿‘çš„2çš„å¹‚çš„å€¼ï¼Œä¾‹å¦‚8000byteå½’ä¸€åŒ–ä¸º8192byte( chunkSize/2^11 )ï¼Œ8193byteå½’ä¸€åŒ–ä¸º16384byte(chunkSize/2^10)</p>
<p>å¤„ç†å†…å­˜ç”³è¯·çš„ç®—æ³•åœ¨PoolChunk#allocateRunæ–¹æ³•ä¸­ï¼Œå½“åˆ†é…å·²å½’ä¸€åŒ–å¤„ç†åå¤§å°ä¸ºchunkSize/2^dçš„å†…å­˜ï¼Œå³éœ€è¦åœ¨depth = dçš„å±‚çº§ä¸­æ‰¾åˆ°ç¬¬ä¸€å—ç©ºé—²å†…å­˜ï¼Œç®—æ³•<strong>ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†</strong> (æ ¹èŠ‚ç‚¹depth = 0ï¼Œ id = 1)ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ­¥éª¤1 <strong>åˆ¤æ–­æ˜¯å¦å½“å‰èŠ‚ç‚¹å€¼memoryMap[id] &gt; dï¼Œæˆ– depth_of_id &gt; d</strong><br>
å¦‚æœæ˜¯ï¼Œåˆ™æ— æ³•ä»è¯¥chunkåˆ†é…å†…å­˜ï¼ŒæŸ¥æ‰¾ç»“æŸ</li>
<li>æ­¥éª¤2 <strong>åˆ¤æ–­æ˜¯å¦èŠ‚ç‚¹å€¼memoryMap[id] == dï¼Œä¸”depth_of_id &lt;= d</strong><br>
å¦‚æœæ˜¯ï¼Œå½“å‰èŠ‚ç‚¹æ˜¯depth = dçš„ç©ºé—²å†…å­˜ï¼ŒæŸ¥æ‰¾ç»“æŸï¼Œæ›´æ–°å½“å‰èŠ‚ç‚¹å€¼ä¸ºmemoryMap[id] = max_order + 1ï¼Œä»£è¡¨èŠ‚ç‚¹å·²ä½¿ç”¨ï¼Œå¹¶éå†å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œæ›´æ–°èŠ‚ç‚¹å€¼ä¸ºå„è‡ªçš„å·¦å³å­èŠ‚ç‚¹å€¼çš„æœ€å°å€¼ï¼›å¦‚æœå¦ï¼Œæ‰§è¡Œæ­¥éª¤3</li>
<li>æ­¥éª¤3 <strong>åˆ¤æ–­æ˜¯å¦å½“å‰èŠ‚ç‚¹å€¼memoryMap[id] &lt;= dï¼Œä¸”depth_of_id &lt;= d</strong><br>
å¦‚æœæ˜¯ï¼Œåˆ™ç©ºé—²èŠ‚ç‚¹åœ¨å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­ï¼Œåˆ™å…ˆåˆ¤æ–­å·¦å­èŠ‚ç‚¹memoryMap[2 * id] &lt;=d(åˆ¤æ–­å·¦å­èŠ‚ç‚¹æ˜¯å¦å¯åˆ†é…)ï¼Œå¦‚æœæˆç«‹ï¼Œåˆ™å½“å‰èŠ‚ç‚¹æ›´æ–°ä¸ºå·¦å­èŠ‚ç‚¹ï¼Œå¦åˆ™æ›´æ–°ä¸ºå³å­èŠ‚ç‚¹ï¼Œç„¶åé‡å¤æ­¥éª¤1ï¼Œ2</li>
</ul>
<p>å‚è€ƒç¤ºä¾‹å¦‚ä¸‹å›¾ï¼Œç”³è¯·åˆ†é…äº†chunkSize/2çš„å†…å­˜</p>
<figure data-type="image" tabindex="5"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/24e22309-e041-4625-a81d-69f388b168bd.webp" alt="img" loading="lazy"></figure>
<blockquote>
<p><strong>note</strong>ï¼šå›¾ä¸­è™½ç„¶index = 2çš„å­èŠ‚ç‚¹memoryMap[id] = depth_of_idï¼Œä½†å®é™…ä¸ŠèŠ‚ç‚¹å†…å­˜å·²åˆ†é…ï¼Œå› ä¸ºç®—æ³•æ˜¯ä»ä¸Šå¾€ä¸‹å¼€å§‹éå†ï¼Œæ‰€ä»¥åœ¨å®é™…å¤„ç†ä¸­ï¼ŒèŠ‚ç‚¹åˆ†é…å†…å­˜åä»…æ›´æ–°ç¥–å…ˆèŠ‚ç‚¹çš„å€¼ï¼Œå¹¶æ²¡æœ‰æ›´æ–°å­èŠ‚ç‚¹çš„å€¼</p>
</blockquote>
<p>é‡Šæ”¾å†…å­˜æ—¶ï¼Œæ ¹æ®ç”³è¯·å†…å­˜è¿”å›çš„idï¼Œå°† memoryMap[id]æ›´æ–°ä¸ºdepth_of_idï¼ŒåŒæ—¶è®¾ç½®idèŠ‚ç‚¹çš„ç¥–å…ˆèŠ‚ç‚¹å€¼ä¸ºå„è‡ªå·¦å³èŠ‚ç‚¹çš„æœ€å°å€¼</p>
<h3 id="14-å·¨å‹å¯¹è±¡å†…å­˜ç®¡ç†">1.4 å·¨å‹å¯¹è±¡å†…å­˜ç®¡ç†</h3>
<p>å¯¹äºç”³è¯·åˆ†é…å¤§å°è¶…è¿‡chunkSizeçš„å·¨å‹å¯¹è±¡(huge)ï¼ŒNettyé‡‡ç”¨çš„æ˜¯éæ± åŒ–ç®¡ç†ç­–ç•¥ï¼Œåœ¨æ¯æ¬¡è¯·æ±‚åˆ†é…å†…å­˜æ—¶å•ç‹¬åˆ›å»ºç‰¹æ®Šçš„éæ± åŒ–PoolChunkå¯¹è±¡è¿›è¡Œç®¡ç†ï¼Œå†…éƒ¨memoryMapä¸ºnullï¼Œå½“å¯¹è±¡å†…å­˜é‡Šæ”¾æ—¶æ•´ä¸ªChunkå†…å­˜é‡Šæ”¾ï¼Œç›¸åº”å†…å­˜ç”³è¯·é€»è¾‘åœ¨PoolArena#allocateHuge()æ–¹æ³•ä¸­ï¼Œé‡Šæ”¾é€»è¾‘åœ¨PoolArena#destroyChunk()æ–¹æ³•ä¸­</p>
<h3 id="15-å°å¯¹è±¡å†…å­˜ç®¡ç†">1.5 å°å¯¹è±¡å†…å­˜ç®¡ç†</h3>
<p>å½“è¯·æ±‚å¯¹è±¡çš„å¤§å°reqCapacity &lt;= 496ï¼Œå½’ä¸€åŒ–è®¡ç®—åæ–¹å¼æ˜¯å‘ä¸Šå–æœ€è¿‘çš„16çš„å€æ•°ï¼Œä¾‹å¦‚15è§„æ•´ä¸º16ã€40è§„æ•´ä¸º48ã€490è§„æ•´ä¸º496ï¼Œè§„æ•´åçš„å¤§å°(normalizedCapacity)å°äºpageSizeçš„å°å¯¹è±¡å¯åˆ†ä¸º2ç±»ï¼š<br>
å¾®å‹å¯¹è±¡(tiny)ï¼šè§„æ•´åä¸º16çš„æ•´å€æ•°ï¼Œå¦‚16ã€32ã€48ã€...ã€496ï¼Œä¸€å…±31ç§è§„æ ¼<br>
å°å‹å¯¹è±¡(small)ï¼šè§„æ•´åä¸º2çš„å¹‚çš„ï¼Œæœ‰512ã€1024ã€2048ã€4096ï¼Œä¸€å…±4ç§è§„æ ¼</p>
<p>è¿™äº›å°å¯¹è±¡ç›´æ¥åˆ†é…ä¸€ä¸ªpageä¼šé€ æˆæµªè´¹ï¼Œåœ¨pageä¸­è¿›è¡Œå¹³è¡¡æ ‘çš„æ ‡è®°åˆé¢å¤–æ¶ˆè€—æ›´å¤šç©ºé—´ï¼Œå› æ­¤Nettyçš„å®ç°æ˜¯ï¼šå…ˆPoolChunkä¸­ç”³è¯·ç©ºé—²pageï¼ŒåŒä¸€ä¸ªpageåˆ†ä¸ºç›¸åŒå¤§å°è§„æ ¼çš„å°å†…å­˜è¿›è¡Œå­˜å‚¨</p>
<figure data-type="image" tabindex="6"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/2f8db19e-5e8d-46dd-9ad8-0408abf86c5c.webp" alt="img" loading="lazy"></figure>
<p>è¿™äº›pageç”¨PoolSubpageå¯¹è±¡è¿›è¡Œå°è£…ï¼ŒPoolSubpageå†…éƒ¨æœ‰è®°å½•å†…å­˜è§„æ ¼å¤§å°(elemSize)ã€å¯ç”¨å†…å­˜æ•°é‡(numAvail)å’Œå„ä¸ªå°å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œé€šè¿‡long[]ç±»å‹çš„bitmapç›¸åº”bitå€¼0æˆ–1ï¼Œæ¥è®°å½•å†…å­˜æ˜¯å¦å·²ä½¿ç”¨</p>
<blockquote>
<p><strong>note</strong>ï¼šåº”è¯¥æœ‰è¯»è€…æ³¨æ„åˆ°ï¼ŒNettyç”³è¯·æ± åŒ–å†…å­˜è¿›è¡Œå½’ä¸€åŒ–å¤„ç†åçš„å€¼æ›´å¤§äº†ï¼Œä¾‹å¦‚1025byteä¼šå½’ä¸€åŒ–ä¸º2048byteï¼Œ8193byteå½’ä¸€åŒ–ä¸º16384byteï¼Œè¿™æ ·æ˜¯ä¸æ˜¯é€ æˆäº†ä¸€äº›æµªè´¹ï¼Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§å–èˆï¼Œé€šè¿‡å½’ä¸€åŒ–å¤„ç†ï¼Œä½¿æ± åŒ–å†…å­˜åˆ†é…å¤§å°è§„æ ¼åŒ–ï¼Œå¤§å¤§æ–¹ä¾¿å†…å­˜ç”³è¯·å’Œå†…å­˜ã€å†…å­˜å¤ç”¨ï¼Œæé«˜æ•ˆç‡</p>
</blockquote>
<h2 id="å¼¹æ€§ä¼¸ç¼©">å¼¹æ€§ä¼¸ç¼©</h2>
<blockquote>
<p>â€‹		å‰é¢çš„ç®—æ³•åŸç†éƒ¨åˆ†ä»‹ç»äº†Nettyå¦‚ä½•å®ç°å†…å­˜å—çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œå•ä¸ªchunkæ¯”è¾ƒå®¹é‡æœ‰é™ï¼Œå¦‚ä½•ç®¡ç†å¤šä¸ªchunkï¼Œæ„å»ºæˆèƒ½å¤Ÿå¼¹æ€§ä¼¸ç¼©å†…å­˜æ± ï¼Ÿ</p>
</blockquote>
<h3 id="21-poolchunkç®¡ç†">2.1 PoolChunkç®¡ç†</h3>
<p>ä¸ºäº†è§£å†³å•ä¸ªPoolChunkå®¹é‡æœ‰é™çš„é—®é¢˜ï¼ŒNettyå°†å¤šä¸ªPoolChunkç»„æˆé“¾è¡¨ä¸€èµ·ç®¡ç†ï¼Œç„¶åç”¨PoolChunkListå¯¹è±¡æŒæœ‰é“¾è¡¨çš„head</p>
<p>å°†æ‰€æœ‰PoolChunkç»„æˆä¸€ä¸ªé“¾è¡¨çš„è¯ï¼Œè¿›è¡Œéå†æŸ¥æ‰¾ç®¡ç†æ•ˆç‡è¾ƒä½ï¼Œå› æ­¤Nettyè®¾è®¡äº†PoolArenaå¯¹è±¡(arenaä¸­æ–‡æ˜¯èˆå°ã€åœºæ‰€)ï¼Œå®ç°å¯¹å¤šä¸ªPoolChunkListã€PoolSubpageçš„ç®¡ç†ï¼Œçº¿ç¨‹å®‰å…¨æ§åˆ¶ã€å¯¹å¤–æä¾›å†…å­˜åˆ†é…ã€é‡Šæ”¾çš„æœåŠ¡</p>
<p>PoolArenaå†…éƒ¨æŒæœ‰6ä¸ªPoolChunkListï¼Œå„ä¸ªPoolChunkListæŒæœ‰çš„PoolChunkçš„ä½¿ç”¨ç‡åŒºé—´ä¸åŒï¼š</p>
<pre><code class="language-java">// å®¹çº³ä½¿ç”¨ç‡ (0,25%) çš„PoolChunk
private final PoolChunkList&lt;T&gt; qInit;
// [1%,50%) 
private final PoolChunkList&lt;T&gt; q000;
// [25%, 75%) 
private final PoolChunkList&lt;T&gt; q025;
// [50%, 100%) 
private final PoolChunkList&lt;T&gt; q050;
// [75%, 100%) 
private final PoolChunkList&lt;T&gt; q075;
// 100% 
private final PoolChunkList&lt;T&gt; q100;
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/5ad227f8-8a16-4866-ae40-075fc535d0de.webp" alt="img" loading="lazy"></figure>
<p>6ä¸ªPoolChunkListå¯¹è±¡ç»„æˆåŒå‘é“¾è¡¨ï¼Œå½“PoolChunkå†…å­˜åˆ†é…ã€é‡Šæ”¾ï¼Œå¯¼è‡´ä½¿ç”¨ç‡å˜åŒ–ï¼Œéœ€è¦åˆ¤æ–­PoolChunkæ˜¯å¦è¶…è¿‡æ‰€åœ¨PoolChunkListçš„é™å®šä½¿ç”¨ç‡èŒƒå›´ï¼Œå¦‚æœè¶…å‡ºäº†ï¼Œéœ€è¦æ²¿ç€6ä¸ªPoolChunkListçš„åŒå‘é“¾è¡¨æ‰¾åˆ°æ–°çš„åˆé€‚PoolChunkListï¼Œæˆä¸ºæ–°çš„headï¼›åŒæ ·çš„ï¼Œå½“æ–°å»ºPoolChunkå¹¶åˆ†é…å®Œå†…å­˜ï¼Œè¯¥PoolChunkä¹Ÿéœ€è¦æŒ‰ç…§ä¸Šé¢é€»è¾‘æ”¾å…¥åˆé€‚çš„PoolChunkListä¸­</p>
<p>åˆ†é…å½’ä¸€åŒ–å†…å­˜normCapacity(å¤§å°èŒƒå›´åœ¨[pageSize, chunkSize]) å…·ä½“å¤„ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŒ‰é¡ºåºä¾æ¬¡è®¿é—®q050ã€q025ã€q000ã€qInitã€q075ï¼Œéå†PoolChunkListå†…PoolChunké“¾è¡¨åˆ¤æ–­æ˜¯å¦æœ‰PoolChunkèƒ½åˆ†é…å†…å­˜</li>
<li>å¦‚æœä¸Šé¢5ä¸ªPoolChunkListæœ‰ä»»æ„ä¸€ä¸ªPoolChunkå†…å­˜åˆ†é…æˆåŠŸï¼ŒPoolChunkä½¿ç”¨ç‡å‘ç”Ÿå˜æ›´ï¼Œé‡æ–°æ£€æŸ¥å¹¶æ”¾å…¥åˆé€‚çš„PoolChunkListä¸­ï¼Œç»“æŸ</li>
<li>å¦åˆ™æ–°å»ºä¸€ä¸ªPoolChunkï¼Œåˆ†é…å†…å­˜ï¼Œæ”¾å…¥åˆé€‚çš„PoolChunkListä¸­(PoolChunkListæ‰©å®¹)</li>
</ul>
<blockquote>
<p>**noteï¼š**å¯ä»¥çœ‹åˆ°åˆ†é…å†…å­˜ä¾æ¬¡ä¼˜å…ˆåœ¨q050 -&gt; q025 -&gt; q000 -&gt; qInit -&gt; q075çš„PoolChunkListçš„å†…åˆ†é…ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä½¿åˆ†é…åå„ä¸ªåŒºé—´å†…å­˜ä½¿ç”¨ç‡æ›´å¤šå¤„äº[75,100)çš„åŒºé—´èŒƒå›´å†…ï¼Œæé«˜PoolChunkå†…å­˜ä½¿ç”¨ç‡çš„åŒæ—¶ä¹Ÿå…¼é¡¾æ•ˆç‡ï¼Œå‡å°‘åœ¨PoolChunkListä¸­PoolChunkçš„éå†</p>
</blockquote>
<p>å½“PoolChunkå†…å­˜é‡Šæ”¾ï¼ŒåŒæ ·PoolChunkä½¿ç”¨ç‡å‘ç”Ÿå˜æ›´ï¼Œé‡æ–°æ£€æŸ¥å¹¶æ”¾å…¥åˆé€‚çš„PoolChunkListä¸­ï¼Œå¦‚æœé‡Šæ”¾åPoolChunkå†…å­˜ä½¿ç”¨ç‡ä¸º0ï¼Œåˆ™ä»PoolChunkListä¸­ç§»é™¤ï¼Œé‡Šæ”¾æ‰è¿™éƒ¨åˆ†ç©ºé—´ï¼Œé¿å…åœ¨é«˜å³°çš„æ—¶å€™ç”³è¯·è¿‡å†…å­˜ä¸€ç›´ç¼“å­˜åœ¨æ± ä¸­(PoolChunkListç¼©å®¹)</p>
<figure data-type="image" tabindex="8"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/0c3599b0-ad5d-4029-a179-cb6ee0809f76.webp" alt="img" loading="lazy"></figure>
<p>PoolChunkListçš„é¢å®šä½¿ç”¨ç‡åŒºé—´å­˜åœ¨äº¤å‰ï¼Œè¿™æ ·è®¾è®¡æ˜¯å› ä¸ºå¦‚æœåŸºäºä¸€ä¸ªä¸´ç•Œå€¼çš„è¯ï¼Œå½“PoolChunkå†…å­˜ç”³è¯·é‡Šæ”¾åçš„å†…å­˜ä½¿ç”¨ç‡åœ¨ä¸´ç•Œå€¼ä¸Šä¸‹å¾˜å¾Šçš„è¯ï¼Œä¼šå¯¼è‡´åœ¨PoolChunkListé“¾è¡¨å‰åæ¥å›ç§»åŠ¨</p>
<h3 id="22-poolsubpageç®¡ç†">2.2 PoolSubpageç®¡ç†</h3>
<p>PoolArenaå†…éƒ¨æŒæœ‰2ä¸ªPoolSubpageæ•°ç»„ï¼Œåˆ†åˆ«å­˜å‚¨tinyå’Œsmallè§„æ ¼ç±»å‹çš„PoolSubpageï¼š</p>
<pre><code class="language-java">// æ•°ç»„é•¿åº¦32ï¼Œå®é™…ä½¿ç”¨åŸŸä»index = 1å¼€å§‹ï¼Œå¯¹åº”31ç§tinyè§„æ ¼PoolSubpage
private final PoolSubpage&lt;T&gt;[] tinySubpagePools;
// æ•°ç»„é•¿åº¦4ï¼Œå¯¹åº”4ç§smallè§„æ ¼PoolSubpage
private final PoolSubpage&lt;T&gt;[] smallSubpagePools;
</code></pre>
<p>ç›¸åŒè§„æ ¼å¤§å°(elemSize)çš„PoolSubpageç»„æˆé“¾è¡¨ï¼Œä¸åŒè§„æ ¼çš„PoolSubpageé“¾è¡¨çš„headåˆ™åˆ†åˆ«ä¿å­˜åœ¨tinySubpagePools æˆ–è€… smallSubpagePoolsæ•°ç»„ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<figure data-type="image" tabindex="9"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/8925499d-2aeb-4455-8312-4da9be6d7552.webp" alt="img" loading="lazy"></figure>
<p>å½“éœ€è¦åˆ†é…å°å†…å­˜å¯¹è±¡åˆ°PoolSubpageä¸­æ—¶ï¼Œæ ¹æ®å½’ä¸€åŒ–åçš„å¤§å°ï¼Œè®¡ç®—å‡ºéœ€è¦è®¿é—®çš„PoolSubpageé“¾è¡¨åœ¨tinySubpagePoolså’ŒsmallSubpagePoolsæ•°ç»„çš„ä¸‹æ ‡ï¼Œè®¿é—®é“¾è¡¨ä¸­çš„PoolSubpageçš„ç”³è¯·å†…å­˜åˆ†é…ï¼Œå¦‚æœè®¿é—®åˆ°çš„PoolSubpageé“¾è¡¨èŠ‚ç‚¹æ•°ä¸º0ï¼Œåˆ™åˆ›å»ºæ–°çš„PoolSubpageåˆ†é…å†…å­˜ç„¶ååŠ å…¥é“¾è¡¨</p>
<p>PoolSubpageé“¾è¡¨å­˜å‚¨çš„PoolSubpageéƒ½æ˜¯å·²åˆ†é…éƒ¨åˆ†å†…å­˜ï¼Œå½“å†…å­˜å…¨éƒ¨åˆ†é…å®Œæˆ–è€…å†…å­˜å…¨éƒ¨é‡Šæ”¾å®Œçš„PoolSubpageä¼šç§»å‡ºé“¾è¡¨ï¼Œå‡å°‘ä¸å¿…è¦çš„é“¾è¡¨èŠ‚ç‚¹ï¼›å½“PoolSubpageå†…å­˜å…¨éƒ¨åˆ†é…å®Œåå†é‡Šæ”¾éƒ¨åˆ†å†…å­˜ï¼Œä¼šé‡æ–°å°†åŠ å…¥é“¾è¡¨</p>
<p>PoolAreanå†…å­˜æ± å¼¹æ€§ä¼¸ç¼©å¯ç”¨ä¸‹å›¾æ€»ç»“ï¼š</p>
<figure data-type="image" tabindex="10"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/0f961efc-3239-4444-b2ec-20d7e10846c6.webp" alt="img" loading="lazy"></figure>
<h2 id="å¹¶å‘è®¾è®¡">å¹¶å‘è®¾è®¡</h2>
<p>å†…å­˜åˆ†é…é‡Šæ”¾ä¸å¯é¿å…åœ°ä¼šé‡åˆ°å¤šçº¿ç¨‹å¹¶å‘åœºæ™¯ï¼Œæ— è®ºæ˜¯PoolChunkçš„å¹³è¡¡æ ‘æ ‡è®°æˆ–è€…PoolSubpageçš„bitmapæ ‡è®°éƒ½æ˜¯å¤šçº¿ç¨‹ä¸å®‰å…¨ï¼Œå¦‚ä½•åœ¨çº¿ç¨‹å®‰å…¨çš„å‰æä¸‹å°½é‡æå‡å¹¶å‘æ€§èƒ½ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼ŒNettyä¼šæå‰åˆ›å»ºå¤šä¸ª<code>PoolArena</code>(é»˜è®¤ç”Ÿæˆæ•°é‡ =  2 * CPUæ ¸å¿ƒæ•°)ï¼Œå½“çº¿ç¨‹é¦–æ¬¡è¯·æ±‚æ± åŒ–å†…å­˜åˆ†é…ï¼Œä¼šæ‰¾è¢«æœ€å°‘çº¿ç¨‹æŒæœ‰çš„PoolArenaï¼Œå¹¶ä¿å­˜çº¿ç¨‹å±€éƒ¨å˜é‡<code>PoolThreadCache</code>ä¸­ï¼Œå®ç°çº¿ç¨‹ä¸<code>PoolArena</code>çš„å…³è”ç»‘å®š(<code>PoolThreadLocalCache#initialValue()</code>æ–¹æ³•)</p>
<blockquote>
<p>**noteï¼š**Javaè‡ªå¸¦çš„ThreadLocalå®ç°çº¿ç¨‹å±€éƒ¨å˜é‡çš„åŸç†æ˜¯ï¼šåŸºäºThreadçš„ThreadLocalMapç±»å‹æˆå‘˜å˜é‡ï¼Œè¯¥å˜é‡ä¸­mapçš„keyä¸ºThreadLocalï¼Œvalue-ä¸ºéœ€è¦è‡ªå®šä¹‰çš„çº¿ç¨‹å±€éƒ¨å˜é‡å€¼ã€‚è°ƒç”¨ThreadLocal#get()æ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡Thread.currentThread()è·å–å½“å‰çº¿ç¨‹è®¿é—®Threadçš„ThreadLocalMapä¸­çš„å€¼</p>
<p>Nettyè®¾è®¡äº†ThreadLocalçš„æ›´é«˜æ€§èƒ½æ›¿ä»£ç±»ï¼š<code>FastThreadLocal</code>ï¼Œéœ€è¦é…å¥—ç»§æ‰¿Threadçš„ç±»FastThreadLocalThreadä¸€èµ·ä½¿ç”¨ï¼ŒåŸºæœ¬åŸç†æ˜¯å°†åŸæ¥Theadçš„åŸºäºThreadLocalMapå­˜å‚¨å±€éƒ¨å˜é‡ï¼Œæ‰©å±•ä¸ºèƒ½æ›´å¿«é€Ÿè®¿é—®çš„æ•°ç»„è¿›è¡Œå­˜å‚¨(Object[] indexedVariables)ï¼Œæ¯ä¸ªFastThreadLocalå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€åŸå­è‡ªå¢çš„intç±»å‹çš„æ•°ç»„index</p>
</blockquote>
<p>æ­¤å¤–ï¼ŒNettyè¿˜è®¾è®¡äº†ç¼“å­˜æœºåˆ¶æå‡å¹¶å‘æ€§èƒ½ï¼šå½“è¯·æ±‚å¯¹è±¡å†…å­˜é‡Šæ”¾ï¼ŒPoolArenaå¹¶æ²¡æœ‰é©¬ä¸Šé‡Šæ”¾ï¼Œè€Œæ˜¯å…ˆå°è¯•å°†è¯¥å†…å­˜å…³è”çš„PoolChunkå’Œchunkä¸­çš„åç§»ä½ç½®(handlerå˜é‡)ç­‰ä¿¡æ¯å­˜å…¥PoolThreadLocalCacheä¸­çš„å›ºå®šå¤§å°ç¼“å­˜é˜Ÿåˆ—ä¸­(å¦‚æœç¼“å­˜é˜Ÿåˆ—æ»¡äº†åˆ™é©¬ä¸Šé‡Šæ”¾å†…å­˜)ï¼›<br>
å½“è¯·æ±‚å†…å­˜åˆ†é…ï¼ŒPoolArenaä¼šä¼˜å…ˆè®¿é—®PoolThreadLocalCacheçš„ç¼“å­˜é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç¼“å­˜å†…å­˜å¯ç”¨ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥åˆ†é…ï¼Œæé«˜åˆ†é…æ•ˆç‡</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>â€‹	Nettyæ± åŒ–å†…å­˜ç®¡ç†çš„è®¾è®¡å€Ÿé‰´äº†Facebookçš„jemallocï¼ŒåŒæ—¶ä¹Ÿä¸Linuxå†…å­˜åˆ†é…ç®—æ³•Buddyç®—æ³•å’ŒSlabç®—æ³•ä¹Ÿæœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œå¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿã€æ¡†æ¶çš„è®¾è®¡éƒ½å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿçš„è®¾è®¡ä¸­æ‰¾åˆ°åŸå‹ï¼Œå­¦ä¹ åº•å±‚åŸç†æ˜¯å¾ˆæœ‰ä»·å€¼çš„</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p>ã€Šscalable memory allocation using jemalloc â€”â€” Facebookã€‹<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fengineering.fb.com%2Fcore-data%2Fscalable-memory-allocation-using-jemalloc%2F">https://engineering.fb.com/core-data/scalable-memory-allocation-using-jemalloc/</a></p>
<p>ã€ŠNettyå…¥é—¨ä¸å®æˆ˜ï¼šä»¿å†™å¾®ä¿¡ IM å³æ—¶é€šè®¯ç³»ç»Ÿã€‹<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fjuejin.im%2Fbook%2F5b4bc28bf265da0f60130116%3Freferrer%3D598ff735f265da3e1c0f9643">https://juejin.im/book/5b4bc28bf265da0f60130116?referrer=598ff735f265da3e1c0f9643</a></p>
<h2 id="æ–‡ç« å¼•ç”¨">æ–‡ç« å¼•ç”¨</h2>
<p>æ–‡ç« é“¾æ¥ : https://www.jianshu.com/p/7d6fbd3f501e</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#bytebuf-%E5%88%86%E7%B1%BB">ByteBuf åˆ†ç±»</a></li>
<li><a href="#%E6%B1%A0%E5%8C%96pooled-%E5%AF%B9%E8%B1%A1%E7%AE%A1%E7%90%86">æ± åŒ–(Pooled) å¯¹è±¡ç®¡ç†</a></li>
<li><a href="#%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1">ç®—æ³•è®¾è®¡</a>
<ul>
<li><a href="#11-%E6%95%B4%E4%BD%93%E5%8E%9F%E7%90%86">1.1 æ•´ä½“åŸç†</a></li>
<li><a href="#12-%E7%AE%97%E6%B3%95%E7%BB%93%E6%9E%84">1.2 ç®—æ³•ç»“æ„</a></li>
<li><a href="#13-%E7%94%B3%E8%AF%B7%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98">1.3 ç”³è¯·/é‡Šæ”¾å†…å­˜</a></li>
<li><a href="#14-%E5%B7%A8%E5%9E%8B%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">1.4 å·¨å‹å¯¹è±¡å†…å­˜ç®¡ç†</a></li>
<li><a href="#15-%E5%B0%8F%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">1.5 å°å¯¹è±¡å†…å­˜ç®¡ç†</a></li>
</ul>
</li>
<li><a href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9">å¼¹æ€§ä¼¸ç¼©</a>
<ul>
<li><a href="#21-poolchunk%E7%AE%A1%E7%90%86">2.1 PoolChunkç®¡ç†</a></li>
<li><a href="#22-poolsubpage%E7%AE%A1%E7%90%86">2.2 PoolSubpageç®¡ç†</a></li>
</ul>
</li>
<li><a href="#%E5%B9%B6%E5%8F%91%E8%AE%BE%E8%AE%A1">å¹¶å‘è®¾è®¡</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E5%8F%82%E8%80%83">å‚è€ƒ</a></li>
<li><a href="#%E6%96%87%E7%AB%A0%E5%BC%95%E7%94%A8">æ–‡ç« å¼•ç”¨</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>