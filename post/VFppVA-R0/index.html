<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Netty - å †å¤–å†…å­˜æ³„æ¼æ’æŸ¥ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/VFppVA-R0/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223342286" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Netty - å †å¤–å†…å­˜æ³„æ¼æ’æŸ¥</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-01-30</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/VFppVA-R0/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/fn4lTiaKxHO/"
								class="tag">netty</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">4266å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">17 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	è¿™ç¯‡æ–‡ç« ï¼ŒåŸºäºNetty4.1.43.Finalï¼Œä¸“é—¨ä»‹ç»æ’æŸ¥Nettyå †å¤–å†…å­˜ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œè¯Šæ–­å·¥å…·ï¼Œä»¥åŠæ’æŸ¥æ€è·¯æä¾›å‚è€ƒ</p>
</blockquote>
<h2 id="ç°è±¡">ç°è±¡</h2>
<p>å †å¤–å†…å­˜æ³„æ¼çš„ç°è±¡ä¸»è¦æ˜¯ï¼Œè¿›ç¨‹å ç”¨çš„å†…å­˜è¾ƒé«˜(Linuxä¸‹å¯ä»¥ç”¨topå‘½ä»¤æŸ¥çœ‹)ï¼Œä½†Javaå †å†…å­˜å ç”¨å¹¶ä¸é«˜(jmapå‘½ä»¤æŸ¥çœ‹)ï¼Œå¸¸è§çš„ä½¿ç”¨å †å¤–å†…å­˜é™¤äº†Nettyï¼Œè¿˜æœ‰åŸºäºjava.nioä¸‹ç›¸å…³æ¥å£ç”³è¯·å †å¤–å†…å­˜ï¼ŒJNIè°ƒç”¨ç­‰ï¼Œä¸‹é¢ä¾§é‡ä»‹ç»Nettyå †å¤–å†…å­˜æ³„æ¼é—®é¢˜æ’æŸ¥</p>
<h2 id="å †å¤–å†…å­˜é‡Šæ”¾åº•å±‚å®ç°">å †å¤–å†…å­˜é‡Šæ”¾åº•å±‚å®ç°</h2>
<h3 id="1-javanioå †å¤–å†…å­˜é‡Šæ”¾">1. java.nioå †å¤–å†…å­˜é‡Šæ”¾</h3>
<p>Nettyå †å¤–å†…å­˜æ˜¯åŸºäºåŸç”Ÿjava.nioçš„DirectByteBufferå¯¹è±¡çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œæ‰€ä»¥æœ‰å¿…è¦å…ˆäº†è§£ä¸‹å®ƒçš„é‡Šæ”¾åŸç†</p>
<p>java.nioæä¾›çš„DirectByteBufferæä¾›äº†sun.misc.Cleanerç±»çš„clean()æ–¹æ³•ï¼Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨é‡Šæ”¾å †å¤–å†…å­˜ï¼Œè§¦å‘clean()æ–¹æ³•çš„æƒ…å†µæœ‰2ç§</p>
<ul>
<li><strong>(1) åº”ç”¨ç¨‹åºä¸»åŠ¨è°ƒç”¨</strong></li>
</ul>
<pre><code class="language-undefined">ByteBuffer buf = ByteBuffer.allocateDirect(1);
((DirectBuffer) byteBuffer).cleaner().clean();
</code></pre>
<ul>
<li><strong>(2) åŸºäºGCå›æ”¶</strong></li>
</ul>
<p>Cleanerç±»ç»§æ‰¿äº†java.lang.ref.Referenceï¼ŒGCçº¿ç¨‹ä¼šé€šè¿‡è®¾ç½®Referenceçš„å†…éƒ¨å˜é‡ï¼ˆpendingå˜é‡ä¸ºé“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹ï¼Œdiscoveredå˜é‡ä¸ºä¸‹ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼‰ï¼Œå°†å¯è¢«å›æ”¶çš„ä¸å¯è¾¾çš„Referenceå¯¹è±¡ä»¥é“¾è¡¨çš„æ–¹å¼ç»„ç»‡èµ·æ¥</p>
<p>Referenceçš„å†…éƒ¨å®ˆæŠ¤çº¿ç¨‹ä»é“¾è¡¨çš„å¤´éƒ¨(head)æ¶ˆè´¹æ•°æ®ï¼Œå¦‚æœæ¶ˆè´¹åˆ°çš„Referenceå¯¹è±¡åŒæ—¶ä¹Ÿæ˜¯Cleanerç±»å‹ï¼Œçº¿ç¨‹ä¼šè°ƒç”¨clean()æ–¹æ³•(Reference#tryHandlePending())</p>
<h3 id="2netty-nocleanerç­–ç•¥">2.Netty noCleanerç­–ç•¥</h3>
<p>ä»‹ç»noCleanerç­–ç•¥ä¹‹å‰ï¼Œéœ€è¦å…ˆç†è§£å¸¦æœ‰Cleanerå¯¹è±¡çš„DirectByteBufferåœ¨åˆå§‹åŒ–æ—¶åšäº†å“ªäº›äº‹æƒ…ï¼š</p>
<p>åªæœ‰åœ¨DirectByteBuffer(int cap)æ„é€ æ–¹æ³•ä¸­æ‰ä¼šåˆå§‹åŒ–Cleanerå¯¹è±¡ï¼Œæ–¹æ³•ä¸­æ£€æŸ¥å½“å‰å†…å­˜æ˜¯å¦è¶…è¿‡å…è®¸çš„æœ€å¤§å †å¤–å†…å­˜(å¯ç”±-XX:MaxDirectMemorySizeé…ç½®)</p>
<p>å¦‚æœè¶…å‡ºï¼Œåˆ™ä¼šå…ˆå°è¯•å°†ä¸å¯è¾¾çš„Referenceå¯¹è±¡åŠ å…¥Referenceé“¾è¡¨ä¸­ï¼Œä¾èµ–Referenceçš„å†…éƒ¨å®ˆæŠ¤çº¿ç¨‹è§¦å‘å¯ä»¥è¢«å›æ”¶DirectByteBufferå…³è”çš„Cleanerçš„run()æ–¹æ³•</p>
<p>å¦‚æœå†…å­˜è¿˜æ˜¯ä¸è¶³ï¼Œ åˆ™æ‰§è¡Œ System.gc()ï¼Œè§¦å‘full gcï¼Œæ¥å›æ”¶å †å†…å­˜ä¸­çš„DirectByteBufferå¯¹è±¡æ¥è§¦å‘å †å¤–å†…å­˜å›æ”¶ï¼Œå¦‚æœè¿˜æ˜¯è¶…è¿‡é™åˆ¶ï¼Œåˆ™æŠ›å‡ºjava.lang.OutOfMemoryError(ä»£ç ä½äºjava.nio.Bits#reserveMemory()æ–¹æ³•)</p>
<p>è€ŒNettyåœ¨4.1å¼•å…¥å¯ä»¥noCleanerç­–ç•¥ï¼šåˆ›å»ºä¸å¸¦Cleanerçš„DirectByteBufferå¯¹è±¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ç»•å¼€å¸¦Cleanerçš„DirectByteBufferæ‰§è¡Œæ„é€ æ–¹æ³•å’Œæ‰§è¡ŒCleanerçš„clean()æ–¹æ³•ä¸­ä¸€äº›é¢å¤–å¼€é”€ï¼Œå½“å †å¤–å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œä¸ä¼šè§¦å‘System.gc()ï¼Œæé«˜æ€§èƒ½</p>
<p>hasCleanerçš„DirectByteBufferå’ŒnoCleanerçš„DirectByteBufferä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ„é€ å™¨æ–¹å¼ä¸åŒï¼š<br>
noCleanerå¯¹è±¡ï¼šç”±åå°„è°ƒç”¨ private DirectByteBuffer(long addr, int cap)åˆ›å»º<br>
hasCleanerå¯¹è±¡ï¼šç”± new DirectByteBuffer(int cap)åˆ›å»º</li>
<li>é‡Šæ”¾å†…å­˜çš„æ–¹å¼ä¸åŒ<br>
noCleanerå¯¹è±¡ï¼šä½¿ç”¨ UnSafe.freeMemory(address);<br>
hasCleanerå¯¹è±¡ï¼šä½¿ç”¨ DirectByteBuffer çš„ Cleaner çš„ clean() æ–¹æ³•</li>
</ul>
<blockquote>
<p>**noteï¼š**Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œå¯ä»¥æä¾›å†…å­˜æ“ä½œã€å¯¹è±¡æ“ä½œã€çº¿ç¨‹è°ƒåº¦ç­‰æœ¬åœ°æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ï¼Œä½†ä¸æ­£ç¡®ä½¿ç”¨Unsafeç±»ä¼šä½¿å¾—ç¨‹åºå‡ºé”™çš„æ¦‚ç‡å˜å¤§ï¼Œç¨‹åºä¸å†â€œå®‰å…¨â€ï¼Œå› æ­¤å®˜æ–¹ä¸æ¨èä½¿ç”¨ï¼Œå¹¶å¯èƒ½åœ¨æœªæ¥çš„jdkç‰ˆæœ¬ç§»é™¤</p>
</blockquote>
<p>Nettyåœ¨å¯åŠ¨æ—¶éœ€è¦åˆ¤æ–­æ£€æŸ¥å½“å‰ç¯å¢ƒã€ç¯å¢ƒé…ç½®å‚æ•°æ˜¯å¦å…è®¸noCleanerç­–ç•¥(å…·ä½“é€»è¾‘ä½äºPlatformDependentçš„staticä»£ç å—)ï¼Œä¾‹å¦‚è¿è¡Œåœ¨Androidä¸‹æ—¶ï¼Œæ˜¯æ²¡æœ‰Unsafeç±»çš„ï¼Œä¸å…è®¸ä½¿ç”¨noCleanerç­–ç•¥ï¼Œå¦‚æœä¸å…è®¸ï¼Œåˆ™ä½¿ç”¨hasCleanerç­–ç•¥</p>
<blockquote>
<p>**noteï¼š**å¯ä»¥è°ƒç”¨PlatformDependent.useDirectBufferNoCleaner()æ–¹æ³•æŸ¥çœ‹å½“å‰Nettyç¨‹åºæ˜¯å¦ä½¿ç”¨noCleanerç­–ç•¥</p>
</blockquote>
<p>è¯»åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸æœ‰è¯»è€…ä¼šé—®ï¼Œå¦‚æœNettyåŸºäºhasCleanerç­–ç•¥ï¼Œé€šè¿‡GCè§¦å‘Cleaner.clean()ï¼Œè‡ªåŠ¨å›æ”¶å †å¤–å†…å­˜ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ä¸ç”¨è€ƒè™‘ByteBuf.release()æ–¹æ³•çš„è°ƒç”¨ï¼Œä¸ä¼šå†…å­˜æ³„æ¼ï¼Ÿ</p>
<p>å½“ç„¶ä¸æ˜¯ï¼Œä¸€æ–¹é¢åŸå› æ˜¯è‡ªåŠ¨è§¦å‘ä¸å®æ—¶ï¼šéœ€è¦ByteBufferå¯¹è±¡è¢«GCçº¿ç¨‹å›æ”¶æ‰ä¼šè§¦å‘ï¼Œå¦‚æœByteBufferå¯¹è±¡è¿›å…¥è€å¹´ä»£åæ‰å˜å¾—å¯å›æ”¶ï¼Œåˆ™éœ€è¦ç­‰åˆ°å‘é€é¢‘ç‡è¾ƒä½è€å¹´ä»£GCæ‰ä¼šè§¦å‘</p>
<p>å¦ä¸€æ–¹é¢ï¼ŒNettyéœ€è¦åŸºäºByteBuf.release()æ–¹æ³•æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œä¾‹å¦‚æ± åŒ–å†…å­˜é‡Šæ”¾å›å†…å­˜æ± ï¼Œå¦åˆ™è¯¥å¯¹è±¡ä¼šè¢«å†…å­˜æ± ä¸€ç›´æ ‡è®°ä¸ºå·²ä½¿ç”¨</p>
<h2 id="bytebufreleaseè§¦å‘æœºåˆ¶">ByteBuf.release()è§¦å‘æœºåˆ¶</h2>
<p>ä¸šç•Œæœ‰ä¸€ç§è¯¯è§£è®¤ä¸º Netty æ¡†æ¶åˆ†é…çš„ ByteBufï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä¸šåŠ¡ä¸éœ€è¦é‡Šæ”¾ï¼›ä¸šåŠ¡åˆ›å»ºçš„ ByteBuf åˆ™éœ€è¦è‡ªå·±é‡Šæ”¾ï¼ŒNetty æ¡†æ¶ä¸ä¼šé‡Šæ”¾</p>
<p>äº§ç”Ÿè¿™ç§è¯¯è§£æ˜¯æœ‰åŸå› çš„ï¼ŒNettyæ¡†æ¶æ˜¯ä¼šåœ¨ä¸€äº›åœºæ™¯è°ƒç”¨ByteBuf.release()æ–¹æ³•ï¼š</p>
<h3 id="1-å…¥ç«™æ¶ˆæ¯å¤„ç†">1. å…¥ç«™æ¶ˆæ¯å¤„ç†</h3>
<p>å½“å¤„ç†å…¥ç«™æ¶ˆæ¯æ—¶ï¼ŒNettyä¼šåˆ›å»ºByteBufè¯»å–channelä¸Šçš„æ¶ˆæ¯ï¼Œå¹¶è§¦å‘è°ƒç”¨pipelineä¸Šçš„ChannelHandlerå¤„ç†ï¼Œåº”ç”¨ç¨‹åºå®šä¹‰çš„ä½¿ç”¨ByteBufçš„ChannelHandleréœ€è¦è´Ÿè´£release()</p>
<pre><code class="language-java">public void channelRead(ChannelHandlerContext ctx, Object msg) {
    ByteBuf buf = (ByteBuf) msg;
    try {
        ...
    } finally {
        buf.release();
    }
}
</code></pre>
<p>å¦‚æœè¯¥ByteBufä¸ç”±å½“å‰ChannelHandlerå¤„ç†ï¼Œåˆ™ä¼ é€’ç»™pipelineä¸Šä¸‹ä¸€ä¸ªhandlerï¼š</p>
<pre><code class="language-java">public void channelRead(ChannelHandlerContext ctx, Object msg) {
    ByteBuf buf = (ByteBuf) msg;
    ...
    ctx.fireChannelRead(buf);
}
</code></pre>
<p>å¸¸ç”¨çš„æˆ‘ä»¬ä¼šé€šè¿‡ç»§æ‰¿<strong>ChannelInboundHandlerAdapter</strong>å®šä¹‰å…¥ç«™æ¶ˆæ¯å¤„ç†çš„handlerï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœæ‰€æœ‰ç¨‹åºçš„hanleréƒ½æ²¡æœ‰è°ƒç”¨release()æ–¹æ³•ï¼Œ<strong>è¯¥å…¥ç«™æ¶ˆæ¯Nettyæœ€åå¹¶ä¸ä¼šrelease()ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼</strong>ï¼›</p>
<p>å½“åœ¨pipelineçš„handlerå¤„ç†ä¸­æŠ›å‡ºå¼‚å¸¸ä¹‹åï¼Œæœ€åNettyæ¡†æ¶æ˜¯ä¼šæ•æ‰è¯¥å¼‚å¸¸è¿›è¡ŒByteBuf.release()çš„ï¼›<br>
å®Œæ•´æµç¨‹ä½äºAbstractNioByteChannel.NioByteUnsafe#read(),ä¸‹é¢æŠ½å–å…³é”®ç‰‡æ®µï¼š</p>
<pre><code class="language-java">try {
    do {
        byteBuf = allocHandle.allocate(allocator);
        allocHandle.lastBytesRead(doReadBytes(byteBuf));
        // å…¥ç«™æ¶ˆæ¯å·²è¯»å®Œ
        if (allocHandle.lastBytesRead() &lt;= 0) {
            // ...
            break;
        }
        // è§¦å‘piplineä¸Šhandlerè¿›è¡Œå¤„ç†
        pipeline.fireChannelRead(byteBuf);
        byteBuf = null;
    } while (allocHandle.continueReading());
    // ...
} catch (Throwable t) {
    // å¼‚å¸¸å¤„ç†ä¸­åŒ…æ‹¬è°ƒç”¨ byteBuf.release()
    handleReadException(pipeline, byteBuf, t, close, allocHandle);
} 
</code></pre>
<p>ä¸è¿‡ï¼Œå¸¸ç”¨çš„è¿˜æœ‰é€šè¿‡ç»§æ‰¿<strong>SimpleChannelInboundHandler</strong>å®šä¹‰å…¥ç«™æ¶ˆæ¯å¤„ç†ï¼Œåœ¨è¯¥ç±»ä¼šä¿è¯æ¶ˆæ¯æœ€ç»ˆè¢«releaseï¼š</p>
<pre><code class="language-java">@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
    boolean release = true;
    try {
        // è¯¥æ¶ˆæ¯ç”±å½“å‰handlerå¤„ç†
        if (acceptInboundMessage(msg)) {
            I imsg = (I) msg;
            channelRead0(ctx, imsg);
        } else {
            // ä¸ç”±å½“å‰handlerå¤„ç†ï¼Œä¼ é€’ç»™pipelineä¸Šä¸‹ä¸€ä¸ªhandler
            release = false;
            ctx.fireChannelRead(msg);
        }
    } finally {
        // è§¦å‘release
        if (autoRelease &amp;&amp; release) {
            ReferenceCountUtil.release(msg);
        }
    }
}
</code></pre>
<h3 id="2-å‡ºç«™æ¶ˆæ¯å¤„ç†">2. å‡ºç«™æ¶ˆæ¯å¤„ç†</h3>
<p>ä¸åŒäºå…¥ç«™æ¶ˆæ¯æ˜¯ç”±Nettyæ¡†æ¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå‡ºç«™æ¶ˆæ¯é€šå¸¸ç”±åº”ç”¨ç¨‹åºåˆ›å»ºï¼Œç„¶åè°ƒç”¨åŸºäºchannelçš„write()æ–¹æ³•æˆ–writeAndFlush()æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å†…éƒ¨ä¼šè´Ÿè´£è°ƒç”¨ä¼ å…¥çš„byteBufçš„release()æ–¹æ³•</p>
<blockquote>
<p><strong>noteï¼š</strong> write()æ–¹æ³•åœ¨netty-4.0.0.CR2å‰çš„ç‰ˆæœ¬å­˜åœ¨é—®é¢˜ï¼Œä¸ä¼šè°ƒç”¨ByteBuf.release()</p>
</blockquote>
<h3 id="3-releaseæ³¨æ„äº‹é¡¹">3. release()æ³¨æ„äº‹é¡¹</h3>
<ul>
<li><strong>(1) å¼•ç”¨è®¡æ•°</strong></li>
</ul>
<p>è¿˜æœ‰ä¸€ç§å¸¸è§çš„è¯¯è§£å°±æ˜¯ï¼Œåªè¦è°ƒç”¨äº†ByteBufçš„release()æ–¹æ³•ï¼Œæˆ–è€…ReferenceCountUtil.release()æ–¹æ³•ï¼Œå¯¹è±¡çš„å†…å­˜å°±ä¿è¯é‡Šæ”¾äº†ï¼Œå…¶å®ä¸æ˜¯</p>
<p>å› ä¸ºNettyçš„ByteBufå¼•ç”¨è®¡æ•°æ¥ç®¡ç†ByteBufå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒByteBufç»§æ‰¿äº†ReferenceCountedæ¥å£ï¼Œå¯¹å¤–æä¾›retain()å’Œrelease()æ–¹æ³•ï¼Œç”¨äºå¢åŠ æˆ–å‡å°‘å¼•ç”¨è®¡æ•°å€¼ï¼Œ<strong>å½“è°ƒç”¨release()æ–¹æ³•æ—¶ï¼Œå†…éƒ¨è®¡æ•°å€¼è¢«å‡ä¸º0æ‰ä¼šè§¦å‘å†…å­˜å›æ”¶åŠ¨ä½œ</strong></p>
<ul>
<li><strong>(2) derived ByteBuf</strong></li>
</ul>
<p>derivedï¼Œæ´¾ç”Ÿçš„æ„æ€ï¼Œåœ¨ByteBuf.duplicate(), ByteBuf.slice() å’Œ ByteBuf.order(ByteOrder) ç­‰æ–¹æ³•ä¼šåˆ›å»ºå‡ºderived  ByteBufï¼Œåˆ›å»ºå‡ºæ¥çš„ByteBufä¸åŸæœ‰ByteBufæ˜¯å…±äº«å¼•ç”¨è®¡æ•°çš„ï¼ŒåŸæœ‰ByteBufçš„release()æ–¹æ³•è°ƒç”¨ï¼Œä¹Ÿä¼šå¯¼è‡´è¿™äº›å¯¹è±¡å†…å­˜å›æ”¶</p>
<p>ç›¸åByteBuf.copy() å’Œ ByteBuf.readBytes(int)æ–¹æ³•åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡å¹¶ä¸æ˜¯derived ByteBufï¼Œè¿™äº›å¯¹è±¡ä¸åŸæœ‰ByteBufä¸æ˜¯å…±äº«å¼•ç”¨è®¡æ•°çš„ï¼Œ<strong>åŸæœ‰ByteBufçš„release()æ–¹æ³•è°ƒç”¨ä¸ä¼šå¯¼è‡´è¿™äº›å¯¹è±¡å†…å­˜å›æ”¶</strong></p>
<h2 id="å †å¤–å†…å­˜å¤§å°æ§åˆ¶å‚æ•°">å †å¤–å†…å­˜å¤§å°æ§åˆ¶å‚æ•°</h2>
<p>é…ç½®å †å¤–å†…å­˜å¤§å°çš„å‚æ•°æœ‰-XX:MaxDirectMemorySizeå’Œ-Dio.netty.maxDirectMemoryï¼Œè¿™2ä¸ªå‚æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<ul>
<li><strong>-XX:MaxDirectMemorySize</strong><br>
ç”¨äºé™åˆ¶Nettyä¸­<strong>hasCleanerç­–ç•¥çš„DirectByteBuffer</strong>å †å¤–å†…å­˜çš„å¤§å°ï¼Œé»˜è®¤å€¼æ˜¯JVMèƒ½ä»æ“ä½œç³»ç»Ÿç”³è¯·çš„æœ€å¤§å†…å­˜ï¼Œå¦‚æœå†…å­˜æœ¬èº«æ²¡é™åˆ¶ï¼Œåˆ™å€¼ä¸ºLong.MAX_VALUEä¸ªå­—èŠ‚(é»˜è®¤å€¼ç”±Runtime.getRuntime().maxMemory()è¿”å›)ï¼Œä»£ç ä½äºjava.nio.Bits#reserveMemory()æ–¹æ³•ä¸­</li>
</ul>
<blockquote>
<p><strong>noteï¼š</strong>-XX:MaxDirectMemorySizeæ— æ³•é™åˆ¶Nettyä¸­<strong>noCleanerç­–ç•¥çš„DirectByteBuffer</strong>å †å¤–å†…å­˜çš„å¤§å°</p>
</blockquote>
<ul>
<li><strong>-Dio.netty.maxDirectMemory</strong><br>
ç”¨äºé™åˆ¶<strong>noCleanerç­–ç•¥ä¸‹Nettyçš„DirectByteBuffer</strong>åˆ†é…çš„æœ€å¤§å †å¤–å†…å­˜çš„å¤§å°ï¼Œå¦‚æœè¯¥å€¼ä¸º0ï¼Œåˆ™ä½¿ç”¨hasCleanerç­–ç•¥ï¼Œä»£ç ä½äºPlatformDependent#incrementMemoryCounter()æ–¹æ³•ä¸­</li>
</ul>
<h2 id="å †å¤–å†…å­˜ç›‘æ§">å †å¤–å†…å­˜ç›‘æ§</h2>
<p>å¦‚ä½•è·å–å †å¤–å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Ÿ</p>
<h3 id="1-ä»£ç å·¥å…·">1. ä»£ç å·¥å…·</h3>
<ul>
<li><strong>(1) hasCleanerçš„DirectByteBufferç›‘æ§</strong><br>
å¯¹äºhasCleanerç­–ç•¥çš„DirectByteBufferï¼Œjava.nio.Bitsç±»æ˜¯æœ‰è®°å½•å †å¤–å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯è¯¥ç±»æ˜¯åŒ…çº§åˆ«çš„è®¿é—®æƒé™ï¼Œä¸èƒ½ç›´æ¥è·å–ï¼Œå¯ä»¥é€šè¿‡MXBeanæ¥è·å–</li>
</ul>
<blockquote>
<p>**noteï¼š**MXBeanï¼ŒJavaæä¾›çš„ä¸€ç³»åˆ—ç”¨äºç›‘æ§ç»Ÿè®¡çš„ç‰¹æ®ŠBeanï¼Œé€šè¿‡ä¸åŒç±»å‹çš„MXBeanå¯ä»¥è·å–JVMè¿›ç¨‹çš„å†…å­˜ï¼Œçº¿ç¨‹ã€ç±»åŠ è½½ä¿¡æ¯ç­‰ç›‘æ§æŒ‡æ ‡</p>
</blockquote>
<pre><code class="language-java">List&lt;BufferPoolMXBean&gt; bufferPoolMXBeans = ManagementFactoryHelper.getBufferPoolMXBeans();
BufferPoolMXBean directBufferMXBean = bufferPoolMXBeans.get(0);
// hasCleanerçš„DirectBufferçš„æ•°é‡
long count = directBufferMXBean.getCount();
// hasCleanerçš„DirectBufferçš„å †å¤–å†…å­˜å ç”¨å¤§å°ï¼Œå•ä½å­—èŠ‚
long memoryUsed = directBufferMXBean.getMemoryUsed();
</code></pre>
<blockquote>
<p><strong>noteï¼š</strong> MappedByteBufferï¼šæ˜¯åŸºäºFileChannelImpl.mapè¿›è¡Œè¿›è¡Œmmapå†…å­˜æ˜ å°„(é›¶æ‹·è´çš„ä¸€ç§å®ç°)å¾—åˆ°çš„å¦å¤–ä¸€ç§å †å¤–å†…å­˜çš„ByteBufferï¼Œå¯ä»¥é€šè¿‡ManagementFactoryHelper.getBufferPoolMXBeans().get(1)è·å–åˆ°è¯¥å †å¤–å†…å­˜çš„ç›‘æ§æŒ‡æ ‡</p>
</blockquote>
<ul>
<li><strong>(2) noCleanerçš„DirectByteBufferç›‘æ§</strong><br>
Nettyä¸­noCleanerçš„DirectByteBufferçš„ç›‘æ§æ¯”è¾ƒç®€å•ï¼Œç›´æ¥é€šè¿‡PlatformDependent.usedDirectMemory()è®¿é—®å³å¯</li>
</ul>
<h3 id="2-nettyè‡ªå¸¦å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·">2. Nettyè‡ªå¸¦å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·</h3>
<p>Nettyä¹Ÿè‡ªå¸¦äº†å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œå¯ç”¨äºæ£€æµ‹å‡º<strong>ByteBufå¯¹è±¡è¢«GCå›æ”¶ï¼Œä½†ByteBufç®¡ç†çš„å†…å­˜æ²¡æœ‰é‡Šæ”¾</strong>çš„æƒ…å†µï¼Œä½†ä¸é€‚ç”¨ByteBufå¯¹è±¡è¿˜æ²¡è¢«GCå›æ”¶å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œä¾‹å¦‚ä»»åŠ¡é˜Ÿåˆ—ç§¯å‹</p>
<p>ä¸ºäº†ä¾¿äºç”¨æˆ·å‘ç°å†…å­˜æ³„éœ²ï¼ŒNettyæä¾›4ä¸ªæ£€æµ‹çº§åˆ«ï¼š</p>
<ul>
<li>disabled å®Œå…¨å…³é—­å†…å­˜æ³„éœ²æ£€æµ‹</li>
<li>simple  ä»¥çº¦1%çš„æŠ½æ ·ç‡æ£€æµ‹æ˜¯å¦æ³„éœ²ï¼Œé»˜è®¤çº§åˆ«</li>
<li>advanced  æŠ½æ ·ç‡åŒsimpleï¼Œä½†æ˜¾ç¤ºè¯¦ç»†çš„æ³„éœ²æŠ¥å‘Š</li>
<li>paranoid æŠ½æ ·ç‡ä¸º100%ï¼Œæ˜¾ç¤ºæŠ¥å‘Šä¿¡æ¯åŒadvanced</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•æ˜¯åœ¨å‘½ä»¤è¡Œå‚æ•°è®¾ç½®ï¼š</p>
<pre><code class="language-undefined">-Dio.netty.leakDetectionLevel=[æ£€æµ‹çº§åˆ«]
</code></pre>
<p>ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼Œè®¾ç½®æ£€æµ‹çº§åˆ«ä¸ºparanoid ï¼š</p>
<pre><code class="language-java">// -Dio.netty.leakDetectionLevel=paranoid
public static void main(String[] args) {
    for (int i = 0; i &lt; 500000; ++i) {
        ByteBuf byteBuf = UnpooledByteBufAllocator.DEFAULT.buffer(1024);
        byteBuf = null; 
    }
    System.gc();
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºæ³„æ¼æŠ¥å‘Šï¼š</p>
<pre><code class="language-rust">åäºŒæœˆ 27, 2019 8:37:04 ä¸Šåˆ io.netty.util.ResourceLeakDetector reportTracedLeak
ä¸¥é‡: LEAK: ByteBuf.release() was not called before it's garbage-collected. See https://netty.io/wiki/reference-counted-objects.html for more information.
Recent access records: 
Created at:
    io.netty.buffer.UnpooledByteBufAllocator.newDirectBuffer(UnpooledByteBufAllocator.java:96)
    io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
    io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:178)
    io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:115)
    org.caison.netty.demo.memory.BufferLeaksDemo.main(BufferLeaksDemo.java:15)
</code></pre>
<p>å†…å­˜æ³„æ¼çš„åŸç†æ˜¯åˆ©ç”¨å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨(WeakReference)åˆ›å»ºæ—¶éœ€è¦æŒ‡å®šå¼•ç”¨é˜Ÿåˆ—(refQueue)ï¼Œé€šè¿‡å°†ByteBufå¯¹è±¡ç”¨å¼±å¼•ç”¨åŒ…è£…èµ·æ¥ï¼ˆä»£ç å…¥å£ä½äºAbstractByteBufAllocator#toLeakAwareBuffer()æ–¹æ³•ï¼‰</p>
<p>å½“å‘ç”ŸGCæ—¶ï¼Œå¦‚æœGCçº¿ç¨‹æ£€æµ‹åˆ°ByteBufå¯¹è±¡åªè¢«å¼±å¼•ç”¨å¯¹è±¡å…³è”ï¼Œä¼šå°†è¯¥WeakReferenceåŠ å…¥refQueueï¼›<br>
å½“ByteBufå†…å­˜è¢«æ­£å¸¸é‡Šæ”¾ï¼Œä¼šè°ƒç”¨WeakReferenceçš„clear()æ–¹æ³•è§£é™¤å¯¹ByteBufçš„å¼•ç”¨ï¼Œåç»­GCçº¿ç¨‹ä¸ä¼šå†å°†è¯¥WeakReferenceåŠ å…¥refQueueï¼›</p>
<p>Nettyåœ¨æ¯æ¬¡åˆ›å»ºByteBufæ—¶ï¼ŒåŸºäºæŠ½æ ·ç‡ï¼ŒæŠ½æ ·å‘½ä¸­æ—¶ä¼šè½®è¯¢(poll)refQueueä¸­çš„WeakReferenceå¯¹è±¡ï¼Œè½®è¯¢è¿”å›çš„énullçš„WeakReferenceå…³è”çš„ByteBufå³ä¸ºæ³„æ¼çš„å †å¤–å†…å­˜(ä»£ç å…¥å£ä½äºResourceLeakDetector#track()æ–¹æ³•)</p>
<h3 id="3-å›¾å½¢åŒ–å·¥å…·">3. å›¾å½¢åŒ–å·¥å…·</h3>
<p>åœ¨ä»£ç è·å–å †å¤–å†…å­˜çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡è‡ªå®šä¹‰æ¥å…¥ä¸€äº›ç›‘æ§å·¥å…·å®šæ—¶æ£€æµ‹è·å–ï¼Œç»˜åˆ¶å›¾å½¢å³å¯ï¼Œä¾‹å¦‚æ¯”è¾ƒæµè¡Œçš„Prometheusæˆ–è€…Zabbix</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡jdkè‡ªå¸¦çš„Visualvmè·å–ï¼Œéœ€è¦å®‰è£…Buffer Poolsæ’ä»¶ï¼Œåº•å±‚åŸç†æ˜¯è®¿é—®MXBeanä¸­çš„ç›‘æ§æŒ‡æ ‡ï¼Œåªèƒ½è·å–hasCleanerçš„DirectByteBufferçš„ä½¿ç”¨æƒ…å†µ</p>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/05e5b43a-396a-4d09-a872-180ace4d3d3b.webp" alt="img" loading="lazy"></figure>
<p>æ­¤å¤–ï¼Œå¯¹äºJNIè°ƒç”¨äº§ç”Ÿçš„å †å¤–å†…å­˜åˆ†é…ï¼Œå¯ä»¥ä½¿ç”¨google-perftoolsè¿›è¡Œç›‘æ§</p>
<h2 id="å †å¤–å†…å­˜æ³„æ¼è¯Šæ–­">å †å¤–å†…å­˜æ³„æ¼è¯Šæ–­</h2>
<p>å †å¤–å†…å­˜æ³„æ¼çš„å…·ä½“åŸå› æ¯”è¾ƒå¤šï¼Œå…ˆä»‹ç»ä»»åŠ¡é˜Ÿåˆ—å †ç§¯çš„ç›‘æ§ï¼Œå†ä»‹ç»é€šç”¨å †å¤–å†…å­˜æ³„æ¼è¯Šæ–­æ€è·¯</p>
<h3 id="1-ä»»åŠ¡é˜Ÿåˆ—å †ç§¯">1. ä»»åŠ¡é˜Ÿåˆ—å †ç§¯</h3>
<p>è¿™é‡Œçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯å€¼NioEventLoopä¸­çš„Queue<Runnable> taskQueueï¼Œæäº¤åˆ°è¯¥ä»»åŠ¡é˜Ÿåˆ—çš„åœºæ™¯æœ‰ï¼š</p>
<ul>
<li>(1) ç”¨æˆ·è‡ªå®šä¹‰æ™®é€šä»»åŠ¡</li>
</ul>
<pre><code class="language-java">ctx.channel().eventLoop().execute(runnable);
</code></pre>
<ul>
<li>(2) å¯¹channelè¿›è¡Œå†™å…¥</li>
</ul>
<pre><code class="language-java">channel.write(...)
channel.writeAndFlush(...)
</code></pre>
<ul>
<li>(3)  ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</li>
</ul>
<pre><code class="language-java">ctx.channel().eventLoop().schedule(runnable, 60, TimeUnit.SECONDS);
</code></pre>
<p>å½“é˜Ÿåˆ—ä¸­ç§¯å‹ä»»åŠ¡è¿‡å¤šï¼Œå¯¼è‡´æ¶ˆæ¯ä¸èƒ½å¯¹channelè¿›è¡Œå†™å…¥ç„¶åè¿›è¡Œé‡Šæ”¾ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p>
<p>è¯Šæ–­æ€è·¯æ˜¯å¯¹ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°ã€ç§¯å‹çš„ByteBufå¤§å°ã€ä»»åŠ¡ç±»ä¿¡æ¯è¿›è¡Œç›‘æ§ï¼Œå…·ä½“ç›‘æ§ç¨‹åºå¦‚ä¸‹(ä»£ç åœ°å€ <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fcaison%2Fcaison-blog-demo%2Ftree%2Fmaster%2Fnetty-demo">https://github.com/caison/caison-blog-demo/tree/master/netty-demo</a>)ï¼š</p>
<pre><code class="language-java">public void channelActive(ChannelHandlerContext ctx) throws NoSuchFieldException, IllegalAccessException {
    monitorPendingTaskCount(ctx);
    monitorQueueFirstTask(ctx);
    monitorOutboundBufSize(ctx);
}
/** ç›‘æ§ä»»åŠ¡é˜Ÿåˆ—å †ç§¯ä»»åŠ¡æ•°ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åŒ…æ‹¬ioè¯»å†™ä»»åŠ¡ï¼Œä¸šåŠ¡ç¨‹åºæäº¤ä»»åŠ¡ */
public void monitorPendingTaskCount(ChannelHandlerContext ctx) {
    int totalPendingSize = 0;
    for (EventExecutor eventExecutor : ctx.executor().parent()) {
        SingleThreadEventExecutor executor = (SingleThreadEventExecutor) eventExecutor;
        // æ³¨æ„ï¼ŒNetty4.1.29ä»¥ä¸‹ç‰ˆæœ¬æœ¬pendingTasks()æ–¹æ³•å­˜åœ¨bugï¼Œå¯¼è‡´çº¿ç¨‹é˜»å¡é—®é¢˜
        // å‚è€ƒ https://github.com/netty/netty/issues/8196
        totalPendingSize += executor.pendingTasks();
    }
    System.out.println(&quot;ä»»åŠ¡é˜Ÿåˆ—ä¸­æ€»ä»»åŠ¡æ•° = &quot; + totalPendingSize);
}
/** ç›‘æ§å„ä¸ªå †ç§¯çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªä»»åŠ¡çš„ç±»ä¿¡æ¯ */
public void monitorQueueFirstTask(ChannelHandlerContext ctx) throws NoSuchFieldException, IllegalAccessException {
    Field singleThreadField = SingleThreadEventExecutor.class.getDeclaredField(&quot;taskQueue&quot;);
    singleThreadField.setAccessible(true);
    for (EventExecutor eventExecutor : ctx.executor().parent()) {
        SingleThreadEventExecutor executor = (SingleThreadEventExecutor) eventExecutor;
        Runnable task = ((Queue&lt;Runnable&gt;) singleThreadField.get(executor)).peek();
        if (null != task) {
            System.out.println(&quot;ä»»åŠ¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªä»»åŠ¡ä¿¡æ¯ï¼š&quot; + task.getClass().getName());
        }
    }
}
/** ç›‘æ§å‡ºç«™æ¶ˆæ¯çš„é˜Ÿåˆ—ç§¯å‹çš„byteBufå¤§å° */
public void monitorOutboundBufSize(ChannelHandlerContext ctx) {
    long outBoundBufSize = ((NioSocketChannel) ctx.channel()).unsafe().outboundBuffer().totalPendingWriteBytes();
    System.out.println(&quot;å‡ºç«™æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§¯å‹çš„bufå¤§å°&quot; + outBoundBufSize);
}
</code></pre>
<blockquote>
<ul>
<li><strong>note:</strong> ä¸Šé¢ç¨‹åºè‡³å°‘éœ€è¦åŸºäºNetty4.1.29ç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨ï¼Œå¦åˆ™æœ‰æ€§èƒ½é—®é¢˜</li>
</ul>
</blockquote>
<p>å®é™…åŸºäºNettyè¿›è¡Œä¸šåŠ¡å¼€å‘ï¼Œè€—æ—¶çš„ä¸šåŠ¡é€»è¾‘ä»£ç åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</p>
<p>å…ˆè¯´ç»“è®ºï¼Œå»ºè®®<strong>è‡ªå®šä¹‰ä¸€ç»„æ–°çš„ä¸šåŠ¡çº¿ç¨‹æ± ï¼Œå°†è€—æ—¶ä¸šåŠ¡æäº¤ä¸šåŠ¡çº¿ç¨‹æ± </strong></p>
<p>Nettyçš„workerçº¿ç¨‹(NioEventLoop)ï¼Œé™¤äº†ä½œä¸ºNIOçº¿ç¨‹å¤„ç†è¿æ¥æ•°æ®è¯»å–ï¼Œæ‰§è¡Œpipelineä¸ŠchannelHandleré€»è¾‘ï¼Œå¦å¤–è¿˜æœ‰æ¶ˆè´¹taskQueueä¸­æäº¤çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬channelçš„writeæ“ä½œã€‚</p>
<p>å¦‚æœå°†è€—æ—¶ä»»åŠ¡æäº¤åˆ°taskQueueï¼Œä¹Ÿä¼šå½±å“NIOçº¿ç¨‹çš„å¤„ç†è¿˜æœ‰taskQueueä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤å»ºè®®åœ¨å•ç‹¬çš„ä¸šåŠ¡çº¿ç¨‹æ± è¿›è¡Œéš”ç¦»å¤„ç†</p>
<h3 id="2-é€šç”¨è¯Šæ–­æ€è·¯">2. é€šç”¨è¯Šæ–­æ€è·¯</h3>
<p>Nettyå †å¤–å†…å­˜æ³„æ¼çš„åŸå› å¤šç§å¤šæ ·ï¼Œä¾‹å¦‚ä»£ç æ¼äº†å†™è°ƒç”¨release()ï¼›é€šè¿‡retain()å¢åŠ äº†ByteBufçš„å¼•ç”¨è®¡æ•°å€¼è€Œåœ¨è°ƒç”¨release()æ—¶å¼•ç”¨è®¡æ•°å€¼æœªæ¸…ç©ºï¼›å› ä¸ºExceptionå¯¼è‡´æœªèƒ½release()ï¼›ByteBufå¼•ç”¨å¯¹è±¡æå‰è¢«GCï¼Œè€Œå…³è”çš„å †å¤–å†…å­˜æœªèƒ½å›æ”¶ç­‰ç­‰ï¼Œè¿™é‡Œæ— æ³•å…¨éƒ¨åˆ—ä¸¾ï¼Œæ‰€ä»¥å°è¯•æä¾›ä¸€å¥—é€šç”¨çš„è¯Šæ–­æ€è·¯æä¾›å‚è€ƒ</p>
<p>é¦–å…ˆï¼Œéœ€è¦èƒ½å¤ç°é—®é¢˜ï¼Œä¸ºäº†ä¸å½±å“çº¿ä¸ŠæœåŠ¡çš„è¿è¡Œï¼Œå°½é‡åœ¨æµ‹è¯•ç¯å¢ƒæˆ–è€…æœ¬åœ°ç¯å¢ƒè¿›è¡Œæ¨¡æ‹Ÿã€‚ä½†è¿™äº›ç¯å¢ƒé€šå¸¸æ²¡æœ‰çº¿ä¸Šé‚£ä¹ˆå¤§çš„å¹¶å‘é‡ï¼Œå¯ä»¥é€šè¿‡å‹æµ‹å·¥å…·æ¥æ¨¡æ‹Ÿè¯·æ±‚</p>
<p>å¯¹äºæœ‰äº›æ— æ³•æ¨¡æ‹Ÿçš„åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡Linuxæµé‡å¤åˆ¶å·¥å…·å°†çº¿ä¸ŠçœŸå®çš„æµé‡å¤åˆ¶åˆ°åˆ°æµ‹è¯•ç¯å¢ƒï¼ŒåŒæ—¶ä¸å½±å“çº¿ä¸Šçš„ä¸šåŠ¡ï¼Œç±»ä¼¼å·¥å…·æœ‰Gorã€tcpreplayã€tcpcopyç­‰</p>
<p>èƒ½å¤ç°ä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¦å®šä½é—®é¢˜æ‰€åœ¨ï¼Œå…ˆé€šè¿‡å‰é¢ä»‹ç»çš„ç›‘æ§æ‰‹æ®µã€æ—¥å¿—ä¿¡æ¯è¯•è¯•èƒ½ä¸èƒ½ç›´æ¥æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼›<br>
å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±éœ€è¦å®šä½å‡ºå †å¤–å†…å­˜æ³„æ¼çš„è§¦å‘æ¡ä»¶ï¼Œä½†æœ‰æ—¶åº”ç”¨ç¨‹åºæ¯”è¾ƒåºå¤§ï¼Œå¯¹å¤–æä¾›çš„æµé‡å…¥å£å¾ˆå¤šï¼Œæ— æ³•é€ä¸€æ’æŸ¥ã€‚</p>
<p>åœ¨éçº¿ä¸Šç¯å¢ƒçš„è¯ï¼Œå¯ä»¥å°†æµé‡å…¥å£æ³¨é‡Šæ‰ï¼Œæ¯æ¬¡æ³¨é‡Šæ‰ä¸€åŠï¼Œç„¶åå†è¿è¡Œæ£€æŸ¥é—®é¢˜æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œç»§ç»­å†æ³¨é‡Šæ‰å‰©ä¸‹çš„ä¸€åŠï¼Œé€šè¿‡è¿™ç§äºŒåˆ†æ³•çš„ç­–ç•¥é€šè¿‡å‡ æ¬¡å°è¯•å¯ä»¥å¾ˆå¿«å®šä½å‡ºé—®é¢˜è§¦å‘æ¡ä»¶</p>
<p>å®šä½å‡ºè§¦å‘æ¡ä»¶ä¹‹åï¼Œå†æ£€æŸ¥ç¨‹åºä¸­åœ¨è¯¥è§¦å‘æ¡ä»¶å¤„ç†é€»è¾‘ï¼Œå¦‚æœè¯¥å¤„ç†ç¨‹åºå¾ˆå¤æ‚ï¼Œæ— æ³•ç›´æ¥çœ‹å‡ºæ¥ï¼Œè¿˜å¯ä»¥ç»§ç»­æ³¨é‡Šæ‰éƒ¨åˆ†ä»£ç ï¼ŒäºŒåˆ†æ³•æ’æŸ¥ï¼Œç›´åˆ°æœ€åæ‰¾å‡ºå…·ä½“çš„é—®é¢˜ä»£ç å—</p>
<p>æ•´å¥—æ€è·¯çš„æ ¸å¿ƒåœ¨äºï¼Œ<strong>é—®é¢˜å¤ç°ã€ç›‘æ§ã€æ’é™¤æ³•</strong>ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ’æŸ¥å…¶ä»–é—®é¢˜ï¼Œä¾‹å¦‚å †å†…å†…å­˜æ³„æ¼ã€CPU 100%ï¼ŒæœåŠ¡è¿›ç¨‹æŒ‚æ‰ç­‰</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ•´ç¯‡æ–‡ç« ä¾§é‡äºä»‹ç»çŸ¥è¯†ç‚¹å’Œç†è®ºï¼Œç¼ºå°‘å®æˆ˜ç¯èŠ‚ï¼Œè¿™é‡Œåˆ†äº«ä¸€äº›ä¼˜è´¨åšå®¢æ–‡ç« ï¼š</p>
<p>ã€Šnetty å †å¤–å†…å­˜æ³„éœ²æ’æŸ¥ç››å®´ã€‹ é—ªç”µä¾ æ‰‹æŠŠæ‰‹å¸¦å¦‚ä½•debugå †å¤–å†…å­˜æ³„æ¼<br>
https://www.jianshu.com/p/4e96beb37935</p>
<p>ã€ŠNettyé˜²æ­¢å†…å­˜æ³„æ¼æªæ–½ã€‹ï¼ŒNettyæƒå¨æŒ‡å—ä½œè€…ï¼Œåä¸ºææ—å³°å†…å­˜æ³„æ¼çŸ¥è¯†åˆ†äº«<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FIusIvjrth_bzvodhOMfMPQ">https://mp.weixin.qq.com/s/IusIvjrth_bzvodhOMfMPQ</a></p>
<p>ã€Šç–‘æ¡ˆè¿½è¸ªï¼šSpring Bootå†…å­˜æ³„éœ²æ’æŸ¥è®°ã€‹ï¼Œç¾å›¢æŠ€æœ¯å›¢é˜Ÿçºªå…µçš„æ¡ˆä¾‹åˆ†äº«<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FaYwIH0TN3nSzNaMR2FN0AA">https://mp.weixin.qq.com/s/aYwIH0TN3nSzNaMR2FN0AA</a></p>
<p>ã€ŠNettyå…¥é—¨ä¸å®æˆ˜ï¼šä»¿å†™å¾®ä¿¡ IM å³æ—¶é€šè®¯ç³»ç»Ÿã€‹ï¼Œé—ªç”µä¾ çš„æ˜é‡‘å°å†Œ(ä»˜è´¹)ï¼Œä¸ªäººå°±æ˜¯å­¦è¿™ä¸ªä¸“æ å…¥é—¨Nettyçš„<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fjuejin.im%2Fbook%2F5b4bc28bf265da0f60130116%3Freferrer%3D598ff735f265da3e1c0f9643">https://juejin.im/book/5b4bc28bf265da0f60130116?referrer=598ff735f265da3e1c0f9643</a></p>
<h2 id="æ–‡ç« å¼•ç”¨">æ–‡ç« å¼•ç”¨</h2>
<p><a href="https://www.jianshu.com/p/8c4e6da0e634">å…¨æ–‡å¼•ç”¨è‡ª</a> : https://www.jianshu.com/p/8c4e6da0e634</p>
<p>ä¸‡ä¸€ä½œè€…åˆ äº†ä¹Ÿå¯æƒœ</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%8E%B0%E8%B1%A1">ç°è±¡</a></li>
<li><a href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0">å †å¤–å†…å­˜é‡Šæ”¾åº•å±‚å®ç°</a>
<ul>
<li><a href="#1-javanio%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE">1. java.nioå †å¤–å†…å­˜é‡Šæ”¾</a></li>
<li><a href="#2netty-nocleaner%E7%AD%96%E7%95%A5">2.Netty noCleanerç­–ç•¥</a></li>
</ul>
</li>
<li><a href="#bytebufrelease%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6">ByteBuf.release()è§¦å‘æœºåˆ¶</a>
<ul>
<li><a href="#1-%E5%85%A5%E7%AB%99%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">1. å…¥ç«™æ¶ˆæ¯å¤„ç†</a></li>
<li><a href="#2-%E5%87%BA%E7%AB%99%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">2. å‡ºç«™æ¶ˆæ¯å¤„ç†</a></li>
<li><a href="#3-release%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">3. release()æ³¨æ„äº‹é¡¹</a></li>
</ul>
</li>
<li><a href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E6%8E%A7%E5%88%B6%E5%8F%82%E6%95%B0">å †å¤–å†…å­˜å¤§å°æ§åˆ¶å‚æ•°</a></li>
<li><a href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7">å †å¤–å†…å­˜ç›‘æ§</a>
<ul>
<li><a href="#1-%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7">1. ä»£ç å·¥å…·</a></li>
<li><a href="#2-netty%E8%87%AA%E5%B8%A6%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7">2. Nettyè‡ªå¸¦å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·</a></li>
<li><a href="#3-%E5%9B%BE%E5%BD%A2%E5%8C%96%E5%B7%A5%E5%85%B7">3. å›¾å½¢åŒ–å·¥å…·</a></li>
</ul>
</li>
<li><a href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E8%AF%8A%E6%96%AD">å †å¤–å†…å­˜æ³„æ¼è¯Šæ–­</a>
<ul>
<li><a href="#1-%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E5%A0%86%E7%A7%AF">1. ä»»åŠ¡é˜Ÿåˆ—å †ç§¯</a></li>
<li><a href="#2-%E9%80%9A%E7%94%A8%E8%AF%8A%E6%96%AD%E6%80%9D%E8%B7%AF">2. é€šç”¨è¯Šæ–­æ€è·¯</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
<li><a href="#%E6%96%87%E7%AB%A0%E5%BC%95%E7%94%A8">æ–‡ç« å¼•ç”¨</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>