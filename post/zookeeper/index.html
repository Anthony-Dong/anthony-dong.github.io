<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Zookeeper - åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¿ƒè„ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/zookeeper/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Zookeeper - åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¿ƒè„</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-10-29</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/zookeeper/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/VGFs7LxPgW/"
								class="tag">ä¸­é—´ä»¶</a> |
							 <a
								href="https://anthony-dong.github.io/tag/YZlAYWOZz21/"
								class="tag">å¤§æ•°æ®</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2556å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">12 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<h2 id="ä»‹ç»">ä»‹ç»</h2>
<figure data-type="image" tabindex="1"><img src="http://zookeeper.apache.org/images/zookeeper_small.gif" alt="" loading="lazy"></figure>
<p>å®˜ç½‘åœ°å€ : http://zookeeper.apache.org/</p>
<p>ä»€ä¹ˆæ˜¯zookeeper</p>
<blockquote>
<p>â€‹	ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services. All of these kinds of services are used in some form or another by distributed applications. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management complexity when the applications are deployed.</p>
<p>zookeeperæ˜¯ä¸€ä¸ªé›†ä¸­å¼çš„æœåŠ¡ , ç”¨äºç»´æŠ¤é…ç½®ä¿¡æ¯ã€å‘½åã€æä¾›åˆ†å¸ƒå¼åŒæ­¥å’Œæä¾›ç»„æœåŠ¡ã€‚</p>
<p>â€‹		æˆ‘å¯¹ä¸ zookeeper çš„ç†è§£ å°±æ˜¯ä»–æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡çš„ä¸€ä¸ªé«˜å¯ç”¨çš„æ³¨å†Œä¸­å¿ƒ,ä»–è‡ªå¸¦å¯¹èŠ‚ç‚¹æ£€æµ‹,ä¸ç”¨ç”¨æˆ·å»åšå¿ƒè·³æ£€æµ‹.ä¿è¯äº†æœåŠ¡çš„å¯ç”¨æ€§.  åŒæ—¶ä»–å¯ä»¥ä¿å­˜ä¸€äº›é…ç½®ä¿¡æ¯,å»åšåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ .</p>
</blockquote>
<h2 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</h2>
<ul>
<li>å•æœºæ­å»º</li>
</ul>
<pre><code class="language-shell">ç½‘å€  :  http://archive.apache.org/dist/zookeeper/ è‡ªå·±ä¸‹è½½æˆ–è€…ç”¨æˆ‘è¿™ä¸ª
wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz

tar -zxvf zookeeper-3.4.10.tar.gz -C /opt/software

è®°å¾—ä¿®æ”¹æƒé™
chown -R admin:admin zookeeper-3.4.10

ç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶,confç›®å½•ä¸‹
cp zoo_sample.cfg zoo.cfg
vim zoo.cfg  ä¿®æ”¹ä¸‹é¢è¿™æ®µ 
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just 
# example sakes.
dataDir=/opt/software/zookeeper-3.4.10/zkData

ç„¶åè¿›å…¥binç›®å½• ç›´æ¥æ‰§è¡Œ 
./zkServer.sh  start 
æŸ¥çœ‹çŠ¶æ€
./zkServer.sh  status
å…³é—­
./zkServer.sh  stop

ä¹Ÿå¯ä»¥å»ºç«‹ è½¯è¿æ¥  ls -s /opt/software/zookeeper-3.4.10/bin/zkServer.sh  /usr/bin/zkServer
</code></pre>
<ul>
<li>é›†ç¾¤æ­å»º</li>
</ul>
<pre><code class="language-shell">ä¿®æ”¹é…ç½®æ–‡ä»¶,åœ¨é…ç½®æ–‡ä»¶æœ€ä¸‹é¢æ·»åŠ  
server.id  =   ip  : é€šä¿¡ç«¯å£å·: é€‰ä¸¾ç«¯å£
server.1=hadoop1:2888:3888
server.2=hadoop2:2888:3888
server.3=hadoop3:2888:3888

ç„¶åè¿›å…¥ä½ çš„ /opt/software/zookeeper-3.4.10/zkData 
æ‰§è¡Œä¸‹é¢è¿™è¡Œ(æ„æ€å°±æ˜¯å‘Šè¯‰zk , ä½ çš„id æ˜¯ 2) è®°å¾—è·Ÿé›†ç¾¤å¯¹åº”èµ·æ¥
echo 2 &gt; myid

ä¿®æ”¹zkçš„bin ç›®å½•ä¸‹çš„ zkENV.sh , å°†ZOO_LOG_DIRçš„æ—¥å¿—ç›®å½•æ”¹æˆè‡ªå·±æ–°å»ºçš„ ,åªæœ‰è¿œç¨‹å¯åŠ¨æ‰éœ€è¦é…ç½®JAVA_HOME
if [ &quot;x${ZOO_LOG_DIR}&quot; = &quot;x&quot; ]
then
    ZOO_LOG_DIR=&quot;/opt/software/zookeeper-3.4.10/logs&quot;
fi


ç„¶åä½ æ‰§è¡Œ zkServer.sh  start  å°±è¡Œäº†, ä¸‰å°æœºå™¨å¯åŠ¨å°±è¡Œ.


å®¢æˆ·ç«¯è¿æ¥ å°±æ˜¯ zkCli.sh
</code></pre>
<ul>
<li>å®¢æˆ·ç«¯å‘½ä»¤</li>
</ul>
<pre><code class="language-shell">ls æŸ¥çœ‹æ–‡ä»¶(zké‡Œæ–‡ä»¶å°±æ˜¯èŠ‚ç‚¹)

ls / watch ç›‘æ§æ ¹èŠ‚ç‚¹ä¸‹çš„å˜åŒ–state (createæ“ä½œ)

create /app content
	-s åˆ›å»ºä¸€ä¸ªå¸¦åºå·çš„èŠ‚ç‚¹ ä¼šç»™ä½ èŠ‚ç‚¹åå­—æ·»åŠ 	ä¸€ä¸ªåºå·
	-e åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹,æ‰§è¡Œé€€å‡º(quit)å°±åˆ é™¤äº†,ç”Ÿå‘½å‘¨æœŸä¸€ä¸ªsession
æ‰€ä»¥ä¸€å…±å››ç§èŠ‚ç‚¹

get /app   è·å–èŠ‚ç‚¹ä¿¡æ¯
get /app watch  å¯ä»¥ç›‘æ§èŠ‚ç‚¹ä¿¡æ¯å˜åŒ–(setæ“ä½œ)
set /app contents  ä¿®æ”¹
stat /app  æŸ¥çœ‹çŠ¶æ€  statç»“æ„ä½“
history  æŸ¥çœ‹æ“ä½œ	çš„è®°å½•
delete  åˆ é™¤æ–‡ä»¶,æ— æ³•åˆ é™¤æœ‰å­èŠ‚ç‚¹çš„
rmr é€’å½’åˆ é™¤
</code></pre>
<h2 id="zké€‰ä¸¾leaderæµç¨‹">ZKé€‰ä¸¾leaderæµç¨‹</h2>
<blockquote>
<p>æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„status :  looking  leader  follower  observer</p>
<p>Lookingï¼šç³»ç»Ÿåˆšå¯åŠ¨æ—¶æˆ–è€…Leaderå´©æºƒåæ­£å¤„äºé€‰ä¸¾çŠ¶æ€</p>
<p>follower  :  å°å¼Ÿ</p>
<p>leader   : é¢†å¯¼</p>
<p>åˆšå¼€å§‹å¯åŠ¨éƒ½ä¸º looking çŠ¶æ€ ,  æ¯å°æœºå™¨å¯åŠ¨ä¼šæŠ•è‡ªå·±ä¸€ç¥¨ , äº’ç›¸é€‰ä¸¾çš„æ—¶å€™é€‰(myidå’Œczid(ç‰ˆæœ¬æœ€æ–°çš„)å¤§çš„)æœºå™¨ , 1  2 3  4  5 é¡ºåºå¯åŠ¨  å½“åˆ°3çš„æ—¶å€™å·²ç»åŠæ•°ä»¥ä¸Šäº†,æ‰€ä»¥ 4 5 ä¼šè·Ÿéš 1 2 3 æŠ• 3 ,æ‰€ä»¥ leaderæ˜¯3</p>
<p>ï¼ˆ1ï¼‰æœåŠ¡å™¨1å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚æœåŠ¡å™¨1æŠ•è‡ªå·±ä¸€ç¥¨ã€‚æ­¤æ—¶æœåŠ¡å™¨1ç¥¨æ•°ä¸€ç¥¨ï¼Œä¸å¤ŸåŠæ•°ä»¥ä¸Šï¼ˆ3ç¥¨ï¼‰ï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨1çŠ¶æ€ä¿æŒä¸ºLOOKINGï¼›</p>
<p>ï¼ˆ2ï¼‰æœåŠ¡å™¨2å¯åŠ¨ï¼Œå†å‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚æœåŠ¡å™¨1å’Œ2åˆ†åˆ«æŠ•è‡ªå·±ä¸€ç¥¨å¹¶äº¤æ¢é€‰ç¥¨ä¿¡æ¯ï¼šæ­¤æ—¶æœåŠ¡å™¨1å‘ç°æœåŠ¡å™¨2çš„IDæ¯”è‡ªå·±ç›®å‰æŠ•ç¥¨æ¨ä¸¾çš„ï¼ˆæœåŠ¡å™¨1ï¼‰å¤§ï¼Œæ›´æ”¹é€‰ç¥¨ä¸ºæ¨ä¸¾æœåŠ¡å™¨2ã€‚æ­¤æ—¶æœåŠ¡å™¨1ç¥¨æ•°0ç¥¨ï¼ŒæœåŠ¡å™¨2ç¥¨æ•°2ç¥¨ï¼Œæ²¡æœ‰åŠæ•°ä»¥ä¸Šç»“æœï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨1ï¼Œ2çŠ¶æ€ä¿æŒLOOKING</p>
<p>ï¼ˆ3ï¼‰æœåŠ¡å™¨3å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚æ­¤æ—¶æœåŠ¡å™¨1å’Œ2éƒ½ä¼šæ›´æ”¹é€‰ç¥¨ä¸ºæœåŠ¡å™¨3ã€‚æ­¤æ¬¡æŠ•ç¥¨ç»“æœï¼šæœåŠ¡å™¨1ä¸º0ç¥¨ï¼ŒæœåŠ¡å™¨2ä¸º0ç¥¨ï¼ŒæœåŠ¡å™¨3ä¸º3ç¥¨ã€‚æ­¤æ—¶æœåŠ¡å™¨3çš„ç¥¨æ•°å·²ç»è¶…è¿‡åŠæ•°ï¼ŒæœåŠ¡å™¨3å½“é€‰Leaderã€‚æœåŠ¡å™¨1ï¼Œ2æ›´æ”¹çŠ¶æ€ä¸ºFOLLOWINGï¼ŒæœåŠ¡å™¨3æ›´æ”¹çŠ¶æ€ä¸ºLEADINGï¼›</p>
<p>ï¼ˆ4ï¼‰æœåŠ¡å™¨4å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚æ­¤æ—¶æœåŠ¡å™¨1ï¼Œ2ï¼Œ3å·²ç»ä¸æ˜¯LOOKINGçŠ¶æ€ï¼Œä¸ä¼šæ›´æ”¹é€‰ç¥¨ä¿¡æ¯ã€‚äº¤æ¢é€‰ç¥¨ä¿¡æ¯ç»“æœï¼šæœåŠ¡å™¨3ä¸º3ç¥¨ï¼ŒæœåŠ¡å™¨4ä¸º1ç¥¨ã€‚æ­¤æ—¶æœåŠ¡å™¨4æœä»å¤šæ•°ï¼Œæ›´æ”¹é€‰ç¥¨ä¿¡æ¯ä¸ºæœåŠ¡å™¨3ï¼Œå¹¶æ›´æ”¹çŠ¶æ€ä¸ºFOLLOWINGï¼›</p>
<p>ï¼ˆ5ï¼‰æœåŠ¡å™¨5å¯åŠ¨ï¼ŒåŒ4ä¸€æ ·å½“å°å¼Ÿã€‚</p>
</blockquote>
<h2 id="zkçš„å†™æ•°æ®æµç¨‹">ZKçš„å†™æ•°æ®æµç¨‹</h2>
<blockquote>
<ol>
<li>å½“clientå‘é€äº†ä¸€æ¡å†™è¯·æ±‚, serveræ¥æ”¶åˆ°å†™è¯·æ±‚,ä¼šå°†è¯·æ±‚ç»™leader,leaderä¼šåŒæ„,æ­¤æ—¶å¹¿æ’­ç»™å…¶ä»–çš„server,å½“æœ‰åŠæ•°ä»¥ä¸ŠserveråŒæ„æ—¶,å°†æ•°æ®å†™å…¥,ç„¶åå‘é€ç»™clineté€šçŸ¥,</li>
<li>ç»†èŠ‚: serveråŒæ„ä¸ä¸åŒæ„ æ˜¯çœ‹æ•°æ®çš„ç‰ˆæœ¬æ˜¯å¦å’Œå†™å…¥æ•°æ®çš„ç‰ˆæœ¬ä¸€è‡´æ€§,ä¸ä¸€è‡´åˆ™é‡å¯å»leaderæ‹‰å»,</li>
</ol>
</blockquote>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-10-29/c77b6bb5-4c9a-4571-8eb7-f5d1bf600539.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h2 id="zabåè®®zookeeper-atomic-broadcast">zabåè®®(zookeeper atomic broadcast)</h2>
<p><a href="https://blog.csdn.net/jin5203344/article/details/53142027">æ–‡ç« é“¾æ¥</a>   https://blog.csdn.net/jin5203344/article/details/53142027</p>
<p>å…¶å®å°±æ˜¯  zké€‰ä¸¾æµç¨‹ å’Œ å†™æ•°æ®æµç¨‹</p>
<h2 id="zookeeper-api-ä½¿ç”¨">Zookeeper  API ä½¿ç”¨</h2>
<h3 id="åˆ›å»ºèŠ‚ç‚¹">åˆ›å»ºèŠ‚ç‚¹</h3>
<p>è®°ä½ Ephemerals cannot have children ä¸´æ—¶èŠ‚ç‚¹ä¸å‡†æœ‰å­èŠ‚ç‚¹ , ä½†æ˜¯æŒä¹…èŠ‚ç‚¹å¯ä»¥æœ‰ä¸´æ—¶èŠ‚ç‚¹</p>
<pre><code>public String create(final String path, byte data[], List&lt;ACL&gt; acl,        CreateMode createMode)

// ä½¿ç”¨ å°±æ˜¯å¦‚ä¸‹ ,è¿™ä¸ªä»£è¡¨çš„å«ä¹‰æ˜¯ å®Œå…¨å¼€æ”¾çš„æƒé™ ,ä¸”æ˜¯ä¸€ä¸ªæ°¸ä¹…èŠ‚ç‚¹
String path = zkCli.create(&quot;/idea&quot;, &quot;HELLO WORLD&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
</code></pre>
<ol>
<li>path  æ˜¯ èŠ‚ç‚¹è·¯å¾„</li>
<li>data  æ˜¯ èŠ‚ç‚¹æ•°æ®</li>
<li>acl  : Access Control List è®¿é—®æ§åˆ¶åˆ—è¡¨ ,  å¯ä»¥é€šè¿‡ <code>zkCli.setACL(path,list, 1);</code>è®¾ç½®æˆ‘ä¹Ÿä¸äº†è§£.</li>
<li>CreateMode  :
<ol>
<li><code>PERSISTENT</code>   : The znode will not be automatically deleted upon client's disconnect.</li>
<li><code>PERSISTENT_SEQUENTIAL</code>   its name will be appended with a <strong>monotonically increasing number</strong>.(å•è°ƒé€’å¢)</li>
<li><code>EPHEMERAL</code>  : The znode will be deleted upon the client's disconnect.</li>
<li><code>EPHEMERAL_SEQUENTIAL</code> :  its name will be appended with a monotonically increasing number.</li>
</ol>
</li>
</ol>
<h3 id="èŠ‚ç‚¹ç±»å‹">èŠ‚ç‚¹ç±»å‹</h3>
<p>ephemeral èŠ‚ç‚¹ ? ä»–çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸€ä¸ªsession  ,å°±æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ä¸€æ¬¡ä¼šè¯</p>
<p>persistent èŠ‚ç‚¹ ? ä»–çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ°¸ä¹…å­˜å‚¨</p>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-10-29/31b60435-ad6c-4d50-9797-a914d4ddad4d.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>æœ€åç»™ä¸€äº›æƒé™ç»„åˆçš„æµ‹è¯•ç»“æœï¼š</p>
<p>è¦ä¿®æ”¹æŸä¸ªèŠ‚ç‚¹çš„ACLå±æ€§ï¼Œå¿…é¡»å…·æœ‰readã€adminäºŒç§æƒé™</p>
<p>è¦åˆ é™¤æŸä¸ªèŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹ï¼Œå¿…é¡»å…·æœ‰å¯¹çˆ¶èŠ‚ç‚¹çš„readæƒé™ï¼Œä»¥åŠçˆ¶èŠ‚ç‚¹çš„deleteæƒé™</p>
<h3 id="èŠ‚ç‚¹çŠ¶æ€">èŠ‚ç‚¹çŠ¶æ€</h3>
<pre><code class="language-shell">[zk: localhost:2181(CONNECTED) 175] get /test/test1
test
cZxid = 0x800000261
ctime = Wed Oct 30 04:32:59 CST 2019
mZxid = 0x800000261
mtime = Wed Oct 30 04:32:59 CST 2019
pZxid = 0x800000261
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x36e1828d3230000
dataLength = 4
numChildren = 0
</code></pre>
<ol>
<li>czxid  : åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡zxid</li>
</ol>
<p>æ¯æ¬¡ä¿®æ”¹ZooKeeperçŠ¶æ€éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªzxidå½¢å¼çš„æ—¶é—´æˆ³ï¼Œä¹Ÿå°±æ˜¯ZooKeeperäº‹åŠ¡IDã€‚</p>
<p>äº‹åŠ¡IDæ˜¯ZooKeeperä¸­æ‰€æœ‰ä¿®æ”¹æ€»çš„æ¬¡åºã€‚æ¯ä¸ªä¿®æ”¹éƒ½æœ‰å”¯ä¸€çš„zxidï¼Œå¦‚æœzxid1å°äºzxid2ï¼Œé‚£ä¹ˆzxid1åœ¨zxid2ä¹‹å‰å‘ç”Ÿã€‚</p>
<p>2ï¼‰ctime - znodeè¢«åˆ›å»ºçš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</p>
<p>3ï¼‰mzxid - znodeæœ€åæ›´æ–°çš„äº‹åŠ¡zxid</p>
<p>4ï¼‰mtime - znodeæœ€åä¿®æ”¹çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</p>
<p>5ï¼‰pZxid-znodeæœ€åæ›´æ–°çš„å­èŠ‚ç‚¹zxid</p>
<p>6ï¼‰cversion - znodeå­èŠ‚ç‚¹å˜åŒ–å·ï¼Œznodeå­èŠ‚ç‚¹ä¿®æ”¹æ¬¡æ•°</p>
<p>7ï¼‰dataversion - znodeæ•°æ®å˜åŒ–å·</p>
<p>8ï¼‰aclVersion - znodeè®¿é—®æ§åˆ¶åˆ—è¡¨çš„å˜åŒ–å·</p>
<p>9ï¼‰ephemeralOwner- å¦‚æœæ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯znodeæ‹¥æœ‰è€…çš„session idã€‚å¦‚æœä¸æ˜¯ä¸´æ—¶èŠ‚ç‚¹åˆ™æ˜¯0ã€‚</p>
<p>10ï¼‰dataLength- znodeçš„æ•°æ®é•¿åº¦</p>
<p>11ï¼‰numChildren - znodeå­èŠ‚ç‚¹æ•°é‡</p>
<h3 id="åˆ é™¤èŠ‚ç‚¹">åˆ é™¤èŠ‚ç‚¹</h3>
<pre><code class="language-java">// ä¹Ÿæ˜¯å¿…é¡»çŸ¥é“ version ç‰ˆæœ¬ 
zkCli.delete(&quot;/idea&quot;, stat.getVersion());
</code></pre>
<h3 id="ä¿®æ”¹èŠ‚ç‚¹">ä¿®æ”¹èŠ‚ç‚¹</h3>
<pre><code>// åé¢æœ‰ä¸ªstat , å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“é»˜è®¤ null ,è¿”å›å€¼ä¸º zNodeæ•°æ®,
byte[] data = zkCli.getData(&quot;/server&quot;, true,null);

// ä¿®æ”¹ èŠ‚ç‚¹ , æ²¡ä¸€æ¬¡ä¿®æ”¹ä¼šä½¿å¾— version+1 ,æ‰€ä»¥éœ€è¦é¦–å…ˆè·å–version ,éœ€è¦è°ƒç”¨
// Stat stat = zkCli.exists(&quot;/server&quot;, false); è¿™ä¸ªå‡½æ•° , æ¥è·å–stat,
Stat Nstat = zkCli.setData(&quot;/server&quot;, &quot;contents2&quot;.getBytes(), stat.getVersion());
</code></pre>
<h3 id="æŸ¥æ‰¾èŠ‚ç‚¹">æŸ¥æ‰¾èŠ‚ç‚¹</h3>
<pre><code class="language-java">// 1. æ³¨å†Œåˆ°å®¢æˆ·ç«¯ç›‘å¬å™¨ä¸Š(true),åŒæ—¶è¿”å›ä¸€ä¸ªlist é›†åˆ, æ”¾ç€ å­èŠ‚ç‚¹
List&lt;String&gt; children = zkCli.getChildren(&quot;/idea&quot;, true);
// 2. è·å–èŠ‚ç‚¹æ•°æ® , éœ€è¦ç©¿ä¸€ä¸ª watcher , ä¹Ÿå¯ä»¥æ³¨å†Œåˆ°å®¢æˆ·ç«¯çš„ç›‘å¬å™¨ä¸Š(true),æˆ–è€…è‡ªå·±åˆ›å»ºç›‘å¬å™¨
byte[] data = zkCli.getData(&quot;/idea&quot;,true, stat);
</code></pre>
<h3 id="å®¢æˆ·ç«¯ä»£ç æµç¨‹">å®¢æˆ·ç«¯ä»£ç æµç¨‹</h3>
<pre><code class="language-java">public class DistributeClient {

    private static String connectString = &quot;hadoop1:2181,hadoop2:2181,hadoop3:2181&quot;;
    private static int sessionTimeout = 2000;
    private ZooKeeper zk = null;
    private String parentNode = &quot;/server&quot;;

    // åˆ›å»ºåˆ°zkçš„å®¢æˆ·ç«¯è¿æ¥
    public void getConnect() throws IOException {
        zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                System.out.println(&quot;ç›‘å¬åˆ°&quot;);
                try {
                    getServerLists();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        });
    }

  
    public void getServerLists() throws Exception {
        List&lt;String&gt; children = zk.getChildren(parentNode,true);
        System.out.println(children);
    }


    public void business() throws Exception {
        Thread.sleep(Long.MAX_VALUE);
    }

    // æ— è„‘è·å–èŠ‚ç‚¹ä¿¡æ¯
    public static void main(String[] args) throws Exception {

        // 1 è·å–zkè¿æ¥
        DistributeClient client = new DistributeClient();
        client.getConnect();

        // 2 è·å–serversçš„å­èŠ‚ç‚¹ä¿¡æ¯ , æ­¤æ—¶ watcher ç›‘å¬åˆ° , ç„¶åwatcheråˆæ‰§è¡Œäº†ä¸ª getServerLists ,æ— ç©·æ— å°½ å“ˆå“ˆå“ˆå“ˆ
        client.getServerLists();

        // 3 ä¸šåŠ¡è¿›ç¨‹å¯åŠ¨
        client.business();
    }
}

</code></pre>
<h3 id="spring-boot-æ•´åˆ-zookeeper">Spring-Boot æ•´åˆ zookeeper</h3>
<p>zk çš„åŸºæœ¬ä¿¡æ¯</p>
<pre><code class="language-java">public class ZookeeperInfo {

    static String CONNECT_STRING = &quot;hadoop1:2181,hadoop2:2181,hadoop3:2181&quot;;

    static int SESSION_TIMEOUT = 2000;

    static String SERVER_PATH = &quot;/test-server&quot;;
}

</code></pre>
<p>zkCli åˆ›å»º</p>
<pre><code class="language-java">@Slf4j
@Configuration
public class ZookeeperConfig {

    private ZooKeeper zooKeeper;

    @Bean
    public ZooKeeper zooKeeper() {
        try {
            zooKeeper = new ZooKeeper(ZookeeperInfo.CONNECT_STRING, ZookeeperInfo.SESSION_TIMEOUT, new Watcher() {
                @Override
                public void process(WatchedEvent event) {
                    // å¾ªç¯ç›‘å¬ , ç±»ä¼¼äºé€’å½’
                    getChild();
                }
            });
        } catch (IOException e) {
            e.printStackTrace();
        }
        return zooKeeper;
    }


    private void getChild() {
        try {
            List&lt;String&gt; children = zooKeeper.getChildren(ZookeeperInfo.SERVER_PATH, true);
            System.out.println(children);
        } catch (KeeperException e) {
            //
        } catch (InterruptedException e) {
            //
        }
    }
}

</code></pre>
<p>spring å®¹å™¨åˆå§‹åŒ–å®Œæˆæ—¶, æ³¨å†Œ çˆ¶èŠ‚ç‚¹ä¿¡æ¯</p>
<pre><code class="language-java">@Slf4j
@Component
public class ZookeeperApplicationListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; {

    @Autowired
    private ZooKeeper zooKeeper;
    
    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {

        Stat stat=null;
        try {
            stat = zooKeeper.exists(ZookeeperInfo.SERVER_PATH, false);
        } catch (KeeperException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }


        // æœåŠ¡å™¨å¯åŠ¨åˆ é™¤èŠ‚ç‚¹
        if (null != stat) {
            try {
                zooKeeper.delete(ZookeeperInfo.SERVER_PATH, stat.getVersion());
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (KeeperException e) {
                e.printStackTrace();
            }
        }

        // åˆ›å»ºèŠ‚ç‚¹
        try {
            zooKeeper.create(ZookeeperInfo.SERVER_PATH,&quot;hello world&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        } catch (KeeperException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }


        // è·å–èŠ‚ç‚¹ children
        try {
            zooKeeper.getChildren(ZookeeperInfo.SERVER_PATH, true);
        } catch (KeeperException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 id="zkå®¢æˆ·ç«¯çš„ç›‘å¬æµç¨‹">ZKå®¢æˆ·ç«¯çš„ç›‘å¬æµç¨‹</h2>
<p>â€‹	æˆ‘ä»¬ä¸Šé¢ä»£ç é‚£ä¸ªç®€å•å®¢æˆ·ç«¯ä»£ç å°±æ˜¯æ‰§è¡Œçš„è¿™ä¸ªæµç¨‹</p>
<figure data-type="image" tabindex="4"><img src="https://tyut.oss-cn-beijing.aliyuncs.com/image/2019-10-29/e770ea97-e960-4787-b62e-95c998009f05.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%BB%8B%E7%BB%8D">ä»‹ç»</a></li>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">å¿«é€Ÿå¼€å§‹</a></li>
<li><a href="#zk%E9%80%89%E4%B8%BEleader%E6%B5%81%E7%A8%8B">ZKé€‰ä¸¾leaderæµç¨‹</a></li>
<li><a href="#zk%E7%9A%84%E5%86%99%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B">ZKçš„å†™æ•°æ®æµç¨‹</a></li>
<li><a href="#zab%E5%8D%8F%E8%AE%AEzookeeper-atomic-broadcast">zabåè®®(zookeeper atomic broadcast)</a></li>
<li><a href="#zookeeper-api-%E4%BD%BF%E7%94%A8">Zookeeper  API ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%8A%82%E7%82%B9">åˆ›å»ºèŠ‚ç‚¹</a></li>
<li><a href="#%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B">èŠ‚ç‚¹ç±»å‹</a></li>
<li><a href="#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81">èŠ‚ç‚¹çŠ¶æ€</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9">åˆ é™¤èŠ‚ç‚¹</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E8%8A%82%E7%82%B9">ä¿®æ”¹èŠ‚ç‚¹</a></li>
<li><a href="#%E6%9F%A5%E6%89%BE%E8%8A%82%E7%82%B9">æŸ¥æ‰¾èŠ‚ç‚¹</a></li>
<li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B">å®¢æˆ·ç«¯ä»£ç æµç¨‹</a></li>
<li><a href="#spring-boot-%E6%95%B4%E5%90%88-zookeeper">Spring-Boot æ•´åˆ zookeeper</a></li>
</ul>
</li>
<li><a href="#zk%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%9B%91%E5%90%AC%E6%B5%81%E7%A8%8B">ZKå®¢æˆ·ç«¯çš„ç›‘å¬æµç¨‹</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>