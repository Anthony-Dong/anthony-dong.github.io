<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title> Netty - è‡ªå¸¦çš„å‡ ä¸ªç¼–è§£ç å™¨ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/netty-zi-dai-de-ji-ge-bian-jie-ma-qi/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223360682" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a> Netty - è‡ªå¸¦çš„å‡ ä¸ªç¼–è§£ç å™¨</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-11-30</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/netty-zi-dai-de-ji-ge-bian-jie-ma-qi/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/fn4lTiaKxHO/"
								class="tag">netty</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">3554å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">17 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<h2 id="1-objectdecoderå’Œobjectencoder-ç¼–è§£ç å™¨">1. ObjectDecoderå’ŒObjectEncoder ç¼–è§£ç å™¨</h2>
<h3 id="1-objectencoder">1. ObjectEncoder</h3>
<blockquote>
<p>An encoder which serializes a Java object into a {@link ByteBuf}.</p>
</blockquote>
<p>å°†ä¸€ä¸ªjavaå¯¹è±¡åºåˆ—åŒ–æˆä¸€ä¸ª ByteBuf å¯¹è±¡  , æ³¨æ„Javaå¯¹è±¡éœ€è¦å®ç°<code>java.io.Serializable</code> æ¥å£</p>
<h3 id="2-objectdecoder">2. ObjectDecoder</h3>
<blockquote>
<p>A decoder which deserializes the received {@link ByteBuf}s into Java objects.</p>
<p>å°†ä¸€ä¸ª ByteBuf ååºåˆ—æˆä¸€ä¸ªjavaå¯¹è±¡ ,  æ³¨æ„Javaå¯¹è±¡éœ€è¦å®ç°<code>java.io.Serializable</code> æ¥å£</p>
</blockquote>
<h3 id="3-å¿«é€Ÿå¼€å§‹">3. å¿«é€Ÿå¼€å§‹</h3>
<p>ç¬¬ä¸€æ­¥ä¸€ä¸ªjavaå¯¹è±¡ å¿…é¡»æ˜¯å®ç°Serializableæ¥å£</p>
<pre><code class="language-java">public class OPack implements Serializable {

    private static final long serialVersionUID = -5734509523963527363L;
    String name;
    String msg;
    
    .... å…¶ä»–çœç•¥ , get , setæ–¹æ³•ä¹‹ç±»çš„
}
</code></pre>
<p>å®¢æˆ·ç«¯æœåŠ¡å™¨éƒ½æ·»åŠ è¿™ä¸¤ä¸ª ç¼–ç å™¨å’Œè§£ç å™¨</p>
<pre><code class="language-java">ch.pipeline().addLast(new ObjectEncoder());

ch.pipeline().addLast(new ObjectDecoder(1004, new ClassResolver() {
    @Override
    public Class&lt;?&gt; resolve(String className) throws ClassNotFoundException {
        return OPack.class;
    }
}));
</code></pre>
<p>è‡ªå·±å†™ä¸€ä¸ª <code>ChannelInboundHandlerAdapter</code>å®ç°<code>channelRead()</code> æ–¹æ³•å°±å¯ä»¥äº† , å¾ˆç®€å• , æˆ–è€… <code>SimpleChannelInboundHandler&lt;T&gt;</code> çš„ <code>channelRead0()</code> æ–¹æ³•,</p>
<h3 id="4-ç¼–è§£ç å™¨æºç åˆ†æ">4. ç¼–è§£ç å™¨æºç åˆ†æ</h3>
<h4 id="1-objectencoder-ç¼–ç å™¨">1. ObjectEncoder ç¼–ç å™¨</h4>
<pre><code class="language-java">public class ObjectEncoder extends MessageToByteEncoder&lt;Serializable&gt; {
    // è¿™æ˜¯ä¸€ä¸ªint çš„ byteæ•°ç»„ , å› ä¸ºintæ˜¯å››ä¸ªå­—èŠ‚
    private static final byte[] LENGTH_PLACEHOLDER = new byte[4];

    @Override
    protected void encode(ChannelHandlerContext ctx, Serializable msg, ByteBuf out) throws Exception {
        // å†™æŒ‡é’ˆ
        int startIdx = out.writerIndex();

        // 
        ByteBufOutputStream bout = new ByteBufOutputStream(out);
        //
        ObjectOutputStream oout = null;
        try {
            // é¦–å…ˆå†™å…¥ä¸€ä¸ª4å­—èŠ‚çš„æ•°ç»„
            bout.write(LENGTH_PLACEHOLDER);
			
            oout = new CompactObjectOutputStream(bout);
            
            // å…¶æ¬¡å†å†™å…¥ä¸€ä¸ªå¯¹è±¡
            oout.writeObject(msg);
            oout.flush();
        } finally {
            ....
        }

        // è·å–å†™æŒ‡é’ˆ
        int endIdx = out.writerIndex();

        // è®¾ç½®é•¿åº¦å€¼
        out.setInt(startIdx, endIdx - startIdx - 4);
    }
}

</code></pre>
<p>è‡ªå·±ç©ä¸€ç© ........</p>
<pre><code class="language-java">ByteBuf out = Unpooled.buffer(1024);

// wæŒ‡é’ˆä½ç½®
int start = out.writerIndex();

// è®¾ç½®ä¸€ä¸ªè¾“å‡ºæµ
ByteBufOutputStream bbos = new ByteBufOutputStream(out);

// é¦–å…ˆå†™ä¸€ä¸ª 4ä¸ªå­—èŠ‚é•¿åº¦çš„æ•°ç»„
bbos.write(new byte[4]);

// å¯¹è±¡æµ
ObjectOutputStream objectOutputStream = new ObjectOutputStream(bbos);

// å†™ä¸€ä¸ªobj
objectOutputStream.writeObject(new OPack(&quot;hhh&quot;, &quot;hhh&quot;));

// W æœ€ç»ˆä½ç½®
int end = out.writerIndex();

// åœ¨bufå¯¹è±¡çš„ start ä½ç½® è®¾ç½®ä¸€ä¸ª intå€¼ä¸º end-start-4 å°±æ˜¯å¯¹è±¡çš„é•¿åº¦ ,æ‰€ä»¥å¯¹è±¡é•¿åº¦å°±ç®—å‡ºæ¥äº†
out.setInt(start, end - start - 4);

System.out.println(&quot;out = &quot; + out);

System.out.println(&quot;out.readInt() = &quot; + out.readInt());

// çœ‹çœ‹è®¡æ•°å¼•ç”¨
System.out.println(&quot;out.refCnt() = &quot; + out.refCnt());
</code></pre>
<p>è¾“å‡º</p>
<pre><code class="language-java">out = UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 117, cap: 1024)
out.readInt() = 113
out.refCnt() = 1
</code></pre>
<h3 id="2-objectdecoder-è§£ç å™¨">2. ObjectDecoder è§£ç å™¨</h3>
<pre><code class="language-java">public class ObjectDecoder extends LengthFieldBasedFrameDecoder {

    private final ClassResolver classResolver;

    public ObjectDecoder(ClassResolver classResolver) {
        this(1048576, classResolver);
    }
	
    // è¿™ä¸ªæ„æ€æ¯å¸§ 1048576 é•¿åº¦
    // é•¿åº¦çš„åç§»é‡ä¸º0 , å ç”¨ 4ä¸ªå­—èŠ‚ , æœ€åå»æ‰å‰é¢çš„4ä¸ªå­—èŠ‚
    public ObjectDecoder(int maxObjectSize, ClassResolver classResolver) {
        super(maxObjectSize, 0, 4, 0, 4);
        this.classResolver = classResolver;
    }

    @Override
    protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception {
        // ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„decode() æ–¹æ³• , è¿”å›çš„æ˜¯å·²ç»æ‰£é™¤äº†æˆ‘ä»¬4ä¸ªå­—èŠ‚é•¿åº¦çš„ ByteBufæ–¹æ³•
        ByteBuf frame = (ByteBuf) super.decode(ctx, in);
        if (frame == null) {
            return null;
        }

        // è¿™ä¸ªä»£ç æœ‰ä¸¤å¤„ ä¸€å¤„æ˜¯é‡Šæ”¾ByteBuf , ä¸€å¤„æ˜¯è½¬æˆä¸€ä¸ªObjectInputStreamå¯¹è±¡
        ObjectInputStream ois = new CompactObjectInputStream(new ByteBufInputStream(frame, true), classResolver);
        try {
            // æœ€åè¯»å–å°±è¡Œäº†
            return ois.readObject();
        } finally {
            ois.close();
        }
    }
}
</code></pre>
<p>æˆ‘è¿™é‡Œæœ‰ä¸€å¼ å›¾ , å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°å‰é¢å˜åŒ– , å˜åŒ–ç‚¹å°±æ˜¯æˆ‘ä¸Šé¢æåˆ°çš„ , æˆ‘ä¼šåœ¨ä¸‹é¢è®²è§£<strong>LengthFieldBasedFrameDecoder</strong> æºç çš„æ—¶å€™å¯¹å…¶åˆ†æ , è¿˜è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ä½ è·å–çš„è®¡æ•°å¼•ç”¨æ­¤æ—¶æ˜¯2 ,è¿™ä¸ªéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ , ä¸Šé¢æ³¨é‡Šæˆ‘å·²ç»æåˆ°äº† ....nettyå·²ç»å¸®æˆ‘ä»¬é‡Šæ”¾äº† ,ä½†æ˜¯æˆ‘debug å‘ç°å¹¶æ²¡æœ‰é‡Šæ”¾,è€Œæ˜¯åé¢æœ‰ä¸€å¤„è¿›è¡Œäº†ä¸€æ¬¡release .</p>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-17/920bee30-4966-4a0c-848c-e46ac27a914c.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h2 id="2-stringencoderå’Œstringdecoder-å­—ç¬¦ä¸²ç¼–è§£ç å™¨">2. StringEncoderå’ŒStringDecoder - å­—ç¬¦ä¸²ç¼–è§£ç å™¨</h2>
<blockquote>
<p>â€‹	è¿™ä¿©å®ç°äº† <code>MessageToMessageEncoder&lt;I&gt;</code> å’Œ <code>MessageToMessageDecoder&lt;I&gt;</code> å®ç°è¿˜æ˜¯è›®ç®€å•çš„</p>
<p>â€‹	StringDecoder å°±æ˜¯å°†ByteBufè½¬æ¢æˆäº† String ,è°ƒç”¨çš„æ˜¯ <code>ByteBuf.toString(charset)</code> æ–¹æ³• ,</p>
<p>â€‹	StringEncoder å°±æ˜¯å°† Stringè½¬æ¢æˆäº† ByteBuf , è°ƒç”¨çš„æ˜¯ <code>ByteBufUtil.encodeString(ctx.alloc(), CharBuffer.wrap(msg), charset)</code> è¿™ä¸ªæ–¹æ³•</p>
</blockquote>
<p>æœåŠ¡å™¨ç«¯ :</p>
<pre><code class="language-java">final StringServerHandler stringServerHandler = new StringServerHandler();

// ç®¡é“ä¸­æ·»åŠ å¤„ç†å™¨
ChannelPipeline pipeline = ch.pipeline();
// æ·»åŠ  å­—ç¬¦ä¸²ç¼–è§£ç å™¨ , 
pipeline.addLast(new StringEncoder(CharsetUtil.UTF_8));
pipeline.addLast(new StringDecoder(CharsetUtil.UTF_8));
// è‡ªå·±å®ç°çš„
pipeline.addLast(&quot;serverHandler&quot;, stringServerHandler);
</code></pre>
<p>æˆ‘ä»¬çš„å¤„ç†å™¨<code>StringServerHandler</code> å®ç°äº† <code>SimpleChannelInboundHandler&lt;String&gt;</code> ,</p>
<pre><code class="language-java">private static class StringServerHandler extends SimpleChannelInboundHandler&lt;String&gt; {
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, String msg) throws Exception {
        logger.info(&quot;[æœåŠ¡å™¨] æ¥æ”¶åˆ°ä¿¡æ¯ : {}&quot;, msg);
        ctx.writeAndFlush(&quot;æœåŠ¡å™¨æ”¶åˆ°ä¿¡æ¯&quot;);
    }
}
</code></pre>
<p>æµ‹è¯•ç”¨ä¾‹ :  å‘ç°OK</p>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-12-19/0dff36ce-e2fd-405c-a4a0-2ab9e881c78c.jpg?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p><code>io.netty.handler.codec.string.StringEncoder</code>  åŸºæœ¬å®ç°ä»£ç </p>
<pre><code class="language-java">@Override
protected void encode(ChannelHandlerContext ctx, CharSequence msg, List&lt;Object&gt; out) throws Exception {
    if (msg.length() == 0) {
        return;
    }

    out.add(ByteBufUtil.encodeString(ctx.alloc(), CharBuffer.wrap(msg), charset));
}
</code></pre>
<p><code>io.netty.handler.codec.string.StringDecoder</code> åŸºæœ¬å®ç°</p>
<pre><code class="language-java">@Override
protected void decode(ChannelHandlerContext ctx, ByteBuf msg, List&lt;Object&gt; out) throws Exception {
    out.add(msg.toString(charset));
}
</code></pre>
<h2 id="3-fixedlengthframedecoder-å®šé•¿è§£ç å™¨">3. FixedLengthFrameDecoder - å®šé•¿è§£ç å™¨</h2>
<h3 id="1-æºç ">1. æºç </h3>
<pre><code class="language-java">public class FixedLengthFrameDecoder extends ByteToMessageDecoder {

    // å®šé•¿
    private final int frameLength;

    public FixedLengthFrameDecoder(int frameLength) {
        checkPositive(frameLength, &quot;frameLength&quot;);
        this.frameLength = frameLength;
    }

    // ByteToMessageDecoder çš„å®ç°æ–¹æ³•
    @Override
    protected final void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception {
        // å…ˆå»æ‰§è¡Œè¿™ä¸ªæ–¹æ³• -- &gt;
        Object decoded = decode(ctx, in);   
        // null ç›´æ¥ä¸ç®¡äº† , ç›´æ¥ä¸¢å…¥ç¼“å†²åŒºäº† 
        if (decoded != null) {
            // ä¸ä¸ºç©ºå°±æ·»åŠ è¿›å»
            out.add(decoded);
        }
    }

    // -- &gt; åˆ°è¿™é‡Œ
    protected Object decode(
            @SuppressWarnings(&quot;UnusedParameters&quot;) ChannelHandlerContext ctx, ByteBuf in) throws Exception {
        
        // å°äºç›´æ¥è¿”å›null
        if (in.readableBytes() &lt; frameLength) {
            return null;
        } else {
            // ç­‰äºæˆ–è€…ç­‰äºå°±æˆªå–å›ºå®šé•¿åº¦
            return in.readRetainedSlice(frameLength);
        }
    }
}
</code></pre>
<h3 id="2-åŸºæœ¬ä½¿ç”¨">2. åŸºæœ¬ä½¿ç”¨</h3>
<pre><code class="language-java">ByteBuf buf = Unpooled.buffer(8);

// 0000 0000 , 0000 0000 , 0010 0111 , 0001 0000
/ 0   0   39   16 
 buf.writeInt(10000);
//0000 0000 , 0000 0000 , 0000 0000 ,  0110 0100
// 0  0  0 100
buf.writeInt(100);

// æˆ‘ä»¬å°†æœåŠ¡å™¨ç«¯ new FixedLengthFrameDecoder(6) é•¿åº¦è°ƒæ•´ä¸º6ä¸ªå­—èŠ‚
// ç„¶åå®¢æˆ·ç«¯å‘é€ä¸¤æ¬¡ç»™æœåŠ¡å™¨ -&gt; è¿ç»­å‘ä¸¤æ¬¡bufå¯¹è±¡
</code></pre>
<p>ç»“æœ :</p>
<pre><code class="language-java">ç¬¬ä¸€æ¬¡  :  0	0	39	16	0	0	
ç¬¬äºŒæ¬¡  :  0	100	 0	 0	39	16	
</code></pre>
<p>æˆ‘ä»¬å‘ç°ç¬¬ä¸€æ¬¡å‘é€è¿‡å»çš„æ•°æ® , åä¸¤ä¸ªå­—èŠ‚åœ¨ç¬¬äºŒæ¬¡å‘é€çš„å‰é¢ä¸¤ä¸ªå­—èŠ‚ , æ­¤æ—¶ æˆ‘ä»¬å°±è‚¯å®šäº† , ç¬¬ä¸€æ¬¡å‘é€è¿‡å»æ²¡æœ‰æ”¶åˆ°çš„åœ¨ç¼“å†²åŒºé‡Œé¢ , è¿™ä¸ªç¼“å†²åŒºæ˜¯æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿æ¥éƒ½ä¼šæœ‰ä¸€ä¸ªä¸è¿™ä¸ªå®¢æˆ·ç«¯æƒ³å¯¹åº”çš„ç¼“å†²åŒº , ä¸æ˜¯å…±åŒç¼“å†²åŒº ...</p>
<h2 id="4-lengthfieldbasedframedecoder-è‡ªå®šä¹‰è§£ç å™¨">4. LengthFieldBasedFrameDecoder - è‡ªå®šä¹‰è§£ç å™¨</h2>
<h3 id="1-æ„é€ æ–¹æ³•">1. æ„é€ æ–¹æ³•</h3>
<pre><code class="language-java">new LengthFieldBasedFrameDecoder(ByteOrder byteOrder, int maxFrameLength, int lengthFieldOffset, int lengthFieldLength,int lengthAdjustment, int initialBytesToStrip, boolean failFast);

// byteOrder  :  å¤§ç«¯\å°ç«¯

// maxFrameLength : å¸§æŒ‡çš„æ„æ€å°±æ˜¯æ¯æ¬¡ä¸€å®¢æˆ·ç«¯åƒæœåŠ¡å™¨å‘é€çš„æ•°æ®åŒ…æ¥æ”¶çš„ç¼“å†²åŒºæœ€å¤§å€¼ , 

// lengthFieldOffset : æ•°æ®åŒ…é•¿åº¦çš„åç§»é‡

// lengthFieldLength : æ•°æ®åŒ…é•¿åº¦çš„é•¿åº¦ ,æ¯”å¦‚shortå°±æ˜¯2ä¸ªå­—èŠ‚ , int å°±æ˜¯4ä¸ªå­—èŠ‚

// lengthAdjustment : æ¯”å¦‚æˆ‘ä»¬è¾“å…¥çš„æ˜¯(10, 0, 2,-2,0), ä¼ å…¥å…¥çš„æ•°æ®æ˜¯[10(short),100(int),1000(int)], é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è°ƒæ•´ä¸€ä¸‹,å°±æ˜¯-2 , è®©é•¿åº¦-2,å°±æ˜¯æˆ‘ä»¬å®é™…çš„æ•°æ®é•¿åº¦ä¸º8 , æ•°æ®ä¸º(100,10000),æ­¤æ—¶æ‰èƒ½æ­£å¸¸è¯»å–

// initialBytesToStrip : è¿”å›çš„ByteBufçš„æ—¶å€™è·³è¿‡çš„å­—èŠ‚æ•°

// failFast : å¿«é€Ÿå¤±è´¥
</code></pre>
<h3 id="2-ç®€å•ä½¿ç”¨">2. ç®€å•ä½¿ç”¨</h3>
<h4 id="1-ç¬¬ä¸€ç§ç®€å•æƒ…å†µ10-0-200">1. ç¬¬ä¸€ç§ç®€å•æƒ…å†µ(10, 0, 2,0,0)</h4>
<pre><code class="language-java">1. æœåŠ¡å™¨ä¸­æ·»åŠ è¿›å» , ç„¶åæ·»åŠ è‡ªå·±çš„Handler
ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(8, 0, 2,0,0));


2. å®¢æˆ·ç«¯å‘é€æ•°æ®
// å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ•°æ®
ByteBuf buf = Unpooled.buffer(10);
// é•¿åº¦ä¸º8 
buf.writeShort(8);
buf.writeInt(10000);
buf.writeInt(100);

3. æœåŠ¡å™¨ç«¯ä»£ç 
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
    if (msg instanceof ByteBuf) {
        ByteBuf messages = (ByteBuf) msg;
        System.out.println(&quot;æ•°æ®é•¿åº¦ = &quot; + messages.readShort());
        System.out.println(&quot;æ•°æ®1 = &quot; + messages.readInt());
        System.out.println(&quot;æ•°æ®2 = &quot; + messages.readInt());
    } else {
        super.channelRead(ctx, msg);
    }
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code class="language-java">æ•°æ®é•¿åº¦ = 8
æ•°æ®1 = 10000
æ•°æ®2 = 100
</code></pre>
<p>ä¸€åˆ‡OK ,</p>
<h4 id="2-ç¬¬äºŒç§æƒ…å†µ10-0-2-20">2. ç¬¬äºŒç§æƒ…å†µ(10, 0, 2,-2,0)</h4>
<pre><code class="language-java">ByteBuf buf = Unpooled.buffer(10);
// é•¿åº¦ä¸º10 ,åŒ…å«é•¿åº¦å­—æ®µ ,æ‰€ä»¥è°ƒæ•´ä¸º -2
buf.writeShort(10);
buf.writeInt(10000);
buf.writeInt(100);

æœåŠ¡å™¨ç«¯ä»£ç ä¸å˜
</code></pre>
<p>è¾“å‡º , è¾“å‡ºæ•°æ®ä¸€è‡´</p>
<pre><code class="language-java">æ•°æ®é•¿åº¦ = 10
æ•°æ®1 = 10000
æ•°æ®2 = 100
</code></pre>
<h4 id="3-ç¬¬ä¸‰ç§æƒ…å†µ-10-0-2-22">3. ç¬¬ä¸‰ç§æƒ…å†µ (10, 0, 2,-2,2)</h4>
<pre><code class="language-java">ByteBuf buf = Unpooled.buffer(10);
// é•¿åº¦ä¸º10 ,åŒ…å«é•¿åº¦å­—æ®µ ,æ‰€ä»¥è°ƒæ•´ä¸º -2
buf.writeShort(10);
buf.writeInt(10000);
buf.writeInt(100);

æœåŠ¡å™¨ç«¯ä»£ç åªæ˜¯å»æ‰é•¿åº¦
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
    if (msg instanceof ByteBuf) {
        ByteBuf messages = (ByteBuf) msg;
        System.out.println(&quot;æ•°æ®1 = &quot; + messages.readInt());
        System.out.println(&quot;æ•°æ®2 = &quot; + messages.readInt());
    } else {
        super.channelRead(ctx, msg);
    }
}
</code></pre>
<p>è¾“å‡º , ç»“æœä¸€è‡´ ,å¾ˆæ­£ç¡® ,æ˜¯ä¸æ˜¯ä¼šç©äº† .........</p>
<pre><code class="language-java">æ•°æ®1 = 10000
æ•°æ®2 = 100
</code></pre>
<h3 id="3-æºç åˆ†æ">3. æºç åˆ†æ :</h3>
<pre><code class="language-java">// æ³¨æ„ in ç›´æ¥å†…å­˜ 
protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception {
    // å¤ªé•¿ä¸¢å¼ƒ , ä¸€å¼€å§‹æ˜¯false
   if (discardingTooLongFrame) {
        discardingTooLongFrame(in);
    }
    
    //  lengthFieldEndOffset = lengthFieldOffset + lengthFieldLength;
    // å¯è¯»é•¿åº¦å°äºé•¿åº¦æœ«ç«¯çš„åç§»é‡ ,ç›´æ¥è¿”å›ç©º
    if (in.readableBytes() &lt; lengthFieldEndOffset) {
        return null;
    }

    // é•¿åº¦çš„çœŸå®åç§»é‡ = ræŒ‡é’ˆ+é•¿åº¦åç§»é‡
    int actualLengthFieldOffset = in.readerIndex() + lengthFieldOffset;

    // æ¯ä¸€å¸§çš„é•¿åº¦ ,å…¶å®è¿™ä¸ªæ–¹æ³•å°±æ˜¯switchè¯­å¥1 2 4 8 é‚£ç§çš„æ ¹æ®ä½ é•¿åº¦å çš„å­—èŠ‚æ•°è¿›è¡Œè¯»å–æ•°æ®é•¿åº¦
    long frameLength = getUnadjustedFrameLength(in, actualLengthFieldOffset, lengthFieldLength, byteOrder);

    // é•¿åº¦å°äº0 
    if (frameLength &lt; 0) {
        failOnNegativeLengthField(in, frameLength, lengthFieldEndOffset);
    }

    // æ¯”å¦‚æˆ‘çš„é•¿åº¦åŒ…å«äº†é•¿åº¦çš„å­—èŠ‚, æ­¤æ—¶å°±éœ€è¦è°ƒæ•´å»å¤„é•¿åº¦æ‰€å çš„å­—èŠ‚
    // æ•°æ®åŒ…çœŸå®é•¿åº¦ = frameLength + è°ƒæ•´çš„é•¿åº¦ + é•¿åº¦æœ«ç«¯åç§»é‡
    frameLength += lengthAdjustment + lengthFieldEndOffset;

    // é•¿åº¦å°äº
    if (frameLength &lt; lengthFieldEndOffset) {
        failOnFrameLengthLessThanLengthFieldEndOffset(in, frameLength, lengthFieldEndOffset);
    }

    // æ•°æ®åŒ…é•¿åº¦å¦‚æœå¤§äºmaxFrameLength ç›´æ¥æŠ›å‡ºå¼‚å¸¸äº†å…¶å®
    if (frameLength &gt; maxFrameLength) {
        exceededFrameLength(in, frameLength);
        return null;
    }
   	....
	
    // è·³è¿‡åˆå§‹åŒ–çš„initialBytesToStrip
    in.skipBytes(initialBytesToStrip);

    // r æŒ‡é’ˆ
    int readerIndex = in.readerIndex();
    // çœŸå®é•¿åº¦  = é•¿åº¦-initialBytesToStrip
    int actualFrameLength = frameLengthInt - initialBytesToStrip;
    
    // è¿™é‡Œä¹Ÿæ˜¯åˆ‡ç‰‡ , ä¼šè®¡æ•°+1 ,åé¢ä¼šè®²åˆ°
    ByteBuf frame = extractFrame(ctx, in, readerIndex, actualFrameLength);
    
    // ä¿®æ”¹readeræŒ‡é’ˆ ä½ç½®
    in.readerIndex(readerIndex + actualFrameLength);
    
    return frame;
}
</code></pre>
<h2 id="5-delimiterbasedframedecoder-è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨">5. DelimiterBasedFrameDecoder - è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨</h2>
<blockquote>
<p>è‡ªå®šä¹‰åˆ†éš”ç¬¦ è§£ç å™¨</p>
</blockquote>
<h3 id="1-æ„é€ æ–¹æ³•-2">1. æ„é€ æ–¹æ³•</h3>
<pre><code class="language-java">new DelimiterBasedFrameDecoder(50, false, true, Unpooled.copiedBuffer(&quot;a&quot;, CharsetUtil.UTF_8))

// maxFrameLength æ¯ä¸€æ¬¡çš„æ•°æ®åŒ…æœ€å¤§å¤šå°‘
// stripDelimiter  æ˜¯å¤Ÿå»é™¤åˆ†éš”ç¬¦
// failFast  å¦‚æœå¼‚å¸¸å¿«é€ŸæŠ›å‡º
// delimiter  åˆ†éš”ç¬¦
</code></pre>
<h3 id="2-ç®€å•ä½¿ç”¨-2">2. ç®€å•ä½¿ç”¨</h3>
<pre><code class="language-java">// 1. æœåŠ¡å™¨ç«¯ , æ·»åŠ è§£ç å™¨
// åˆ†éš”ç¬¦è§£ç å™¨
ch.pipeline().addLast(new DelimiterBasedFrameDecoder(50, false, true, Unpooled.copiedBuffer(&quot;a&quot;, CharsetUtil.UTF_8)));
// å­—ç¬¦ä¸²è§£ç å™¨
ch.pipeline().addLast(new StringDecoder());
// è‡ªå·±çš„è§£ç å™¨
 ch.pipeline().addLast(new MyDecoder());

// channelRead() æ–¹æ³•
if (msg instanceof String) {
	System.out.println(msg);
}

// 2. æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯æ³¨å†Œçš„æ˜¯å¦å‘é€äº† : 
run.channel().writeAndFlush(Unpooled.copiedBuffer(&quot;ä½ å¥½aä½ çœŸçš„å¾ˆæ£’&quot;, CharsetUtil.UTF_8));
run.channel().writeAndFlush(Unpooled.copiedBuffer(&quot;å•Ša&quot;, CharsetUtil.UTF_8));
</code></pre>
<p>è¾“å‡ºç»“æœ :</p>
<pre><code class="language-java">æœåŠ¡å™¨ç«¯è¾“å‡ºç»“æœ : 
ä½ å¥½a
ä½ çœŸçš„å¾ˆæ£’å•Ša
</code></pre>
<p>æˆ‘ä»¬å‘ç° åˆ†éš”ç¬¦æ˜¯åœ¨å¥å°¾åˆ†å‰² , å¦‚æœæ²¡æœ‰åˆ†éš”ç¬¦å¦å¤–ä¸€éƒ¨åˆ†å°±æ”¾å…¥ç¼“å†²åŒºäº†,ç­‰å¾…ä¸‹ä¸€æ¬¡è¯»å–åä¸€èµ·æ”¾å…¥è¿›å».</p>
<h2 id="6-linebasedframedecoder-æŒ‰è¡Œè§£ç å™¨">6. LineBasedFrameDecoder - æŒ‰è¡Œè§£ç å™¨</h2>
<h3 id="1-æ„é€ æ–¹æ³•-3">1. æ„é€ æ–¹æ³•</h3>
<pre><code class="language-java">LineBasedFrameDecoder(final int maxLength, final boolean stripDelimiter, final boolean failFast)
// maxLength : æœ€å¤§å¸§
// failFast : å¿«é€ŸæŠ›å‡ºå¼‚å¸¸
// stripDelimiter : å»é™¤åˆ†éš”ç¬¦
</code></pre>
<h3 id="2-å¿«é€Ÿä½¿ç”¨">2. å¿«é€Ÿä½¿ç”¨</h3>
<pre><code class="language-java">// 1.æ¢è¡Œç¬¦è§£ç å™¨
ch.pipeline().addLast(new LineBasedFrameDecoder(1000, true, true));
// 2. å­—ç¬¦ä¸²è§£ç å™¨
ch.pipeline().addLast(new StringDecoder());
// 3. è‡ªå·±çš„å¤„ç†å™¨
ch.pipeline().addLast(new MyHandler());

æœåŠ¡å™¨ç«¯å‘é€ : 
ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;HELLO,æˆ‘æ˜¯æœåŠ¡å™¨\n&quot;, CharsetUtil.UTF_8));

å®¢æˆ·ç«¯å‘é€ : 
run.channel().writeAndFlush(Unpooled.copiedBuffer(&quot;ä½ å¥½,ä½ çœŸçš„å¾ˆæ£’&quot;, CharsetUtil.UTF_8))
run.channel().writeAndFlush(Unpooled.copiedBuffer(&quot;å•Š,\n&quot;, CharsetUtil.UTF_8))
</code></pre>
<p>è¾“å‡ºç»“æœ :</p>
<pre><code class="language-java">æœåŠ¡å™¨ç«¯ : 
ä½ å¥½,ä½ çœŸçš„å¾ˆæ£’å•Š,

å®¢æˆ·ç«¯: 
HELLO,æˆ‘æ˜¯æœåŠ¡å™¨
</code></pre>
<h3 id="3-åˆ†æ-bufforeachbyteæ–¹æ³•çš„ä½¿ç”¨">3. åˆ†æ - buf.forEachByte()æ–¹æ³•çš„ä½¿ç”¨</h3>
<pre><code class="language-java">ByteBuf buf = Unpooled.buffer(10);

buf.writeCharSequence(&quot;hell\n&quot;, CharsetUtil.UTF_8);

byte x = '\n';

//ByteProcessor.FIND_LF
int i = buf.forEachByte(0, 10, new ByteProcessor() {
    @Override
    public boolean process(byte value) throws Exception {
        //ä¸æƒ³å¾ªç¯ è¿”å› false
        if (value == x) {
            return false;
        }
        // æƒ³ç»§ç»­å¾ªç¯è¿”å› true
        return true;
    }
});

System.out.println(&quot;index : &quot;+i);
</code></pre>
<p>è¾“å‡º :</p>
<pre><code class="language-java">index : 4
</code></pre>
<p>æ‰€ä»¥å¾ˆç®€å•å°±èƒ½å‘ç°æ¢è¡Œç¬¦åœ¨å“ªé‡Œ,ç„¶ååˆ‡å‰²å°±è¡Œäº† .......</p>
<h2 id="7-idlestatehandler-å¿ƒè·³æ£€æµ‹å¤„ç†å™¨">7. IdleStateHandler - å¿ƒè·³æ£€æµ‹å¤„ç†å™¨</h2>
<blockquote>
<p>Triggers an IdleStateEvent when a Channel has not performed read, write, or both operation for a while.</p>
<p>è§¦å‘ä¸€ä¸ª IdleStateEvent  äº‹ä»¶ ,å½“ä¸€ä¸ªchannelåœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ‰§è¡Œ read write æˆ–è€…ä¸¤è€… , æ‰€ä»¥ä»–å±äºä¸€ä¸ªäº‹ä»¶æµ</p>
</blockquote>
<p>å®˜æ–¹æºç ä¸­çš„æ¨èç”¨æ³• , å…¶å®ä¸€èˆ¬ä½¿ç”¨ä¹Ÿæ˜¯å¦‚æ­¤ ,</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ : (READER_IDLE)  No data was received for a while.</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ : (WRITER_IDLE)  No data was sent for a while.</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ : (ALL_IDLE)  No data was either received or sent for a while.</p>
<pre><code class="language-java">public class MyChannelInitializer extends ChannelInitializer&lt;Channel&gt; {
    @Override
   public void initChannel(Channel channel) {
       channel.pipeline().addLast(&quot;idleStateHandler&quot;, new IdleStateHandler(60, 30, 0));
       channel.pipeline().addLast(&quot;myHandler&quot;, new MyHandler());
   }
}

// Handler should handle the IdleStateEvent triggered by IdleStateHandler.
public class MyHandler extends ChannelDuplexHandler {
    @Override
   public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {
       if (evt instanceof IdleStateEvent) {
           IdleStateEvent e = (IdleStateEvent) evt;
           if (e.state() == IdleState.READER_IDLE) {
            
           } else if (e.state() == IdleState.WRITER_IDLE) {
               
           }
       }
   }
}
</code></pre>
<h3 id="1-å¦‚ä½•å»è®¾è®¡ä¸€ä¸ªåˆç†å¿ƒè·³æ£€æµ‹">1. å¦‚ä½•å»è®¾è®¡ä¸€ä¸ªåˆç†å¿ƒè·³æ£€æµ‹</h3>
<pre><code>æ–‡ç« ä¹Ÿæ‰¾ä¸åˆ°äº†, æˆ‘æ˜¯å‚è€ƒä¸€ç¯‡é˜¿é‡ŒDubboçš„æ–‡ç« çš„ , ä»–çš„æ€æƒ³å°±æ˜¯ ä¸»åœ¨äºå®¢æˆ·ç«¯, ä»åœ¨äºæœåŠ¡å™¨ç«¯ ,å› ä¸ºæˆ‘ä»¬çš„æ€æƒ³ä¸€èˆ¬æ˜¯è®©æœåŠ¡å™¨ç«¯å‘é€å¿ƒè·³åŒ…,å®šæ—¶å»æ£€æµ‹,å¦‚æœç´¯è®¡è¾¾åˆ°å‡ æ¬¡æ²¡æœ‰çš„è¯,é‚£ä¹ˆç›´æ¥outæ‰, è¿™æ ·ç»™æˆ‘ä»¬å¸¦æ¥çš„ä¸å¥½å¤„å°±æ˜¯é€»è¾‘å¤æ‚ ,è€ƒè™‘æƒ…å†µå¤ªå¤š , æ‰€ä»¥æ”¹æˆå®¢ä¸»æœä»,ç‰¹åˆ«é€‚ç”¨äºå®¢æˆ·ç«¯å¼€å‘çš„ .

æ€è·¯å¤§è‡´å°±æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ , å®¢æˆ·ç«¯å½“60Sæ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨ç«¯å‘æ¥çš„æ¶ˆæ¯,ä¼šä¸»åŠ¨ç»™æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…, æ­¤æ—¶,å½“æœåŠ¡å™¨ç«¯æ²¡æœ‰æ”¶åˆ°å’Œå‘é€ç»™å®¢æˆ·ç«¯çš„æ—¶é•¿è¶…è¿‡120Sæˆ‘ä»¬å°±æ–­å¼€ä¸å®¢æˆ·ç«¯çš„è¿æ¥ , æ‰€ä»¥æœåŠ¡å™¨ç«¯å¾ˆç®€å•,å®¢æˆ·ç«¯ä¹Ÿå¾ˆç®€å•
</code></pre>
<h4 id="1-æœåŠ¡å™¨ç«¯ä»£ç ">1. æœåŠ¡å™¨ç«¯ä»£ç </h4>
<pre><code class="language-java">@Override
protected void initChannel(SocketChannel socketChannel) throws Exception {

	ChannelPipeline pipeline = socketChannel.pipeline();
	// å¿ƒè·³æ£€æµ‹ , è¯»å†™è¶…æ—¶æ—¶é—´æ˜¯120S , æ²¡æœ‰æ”¶åˆ°ä¹Ÿæ²¡æœ‰å‘é€æ¶ˆæ¯
	pipeline.addLast(&quot;idleStateHandler&quot;, new IdleStateHandler(0, 0, 120));

	// å¿ƒè·³æ£€æµ‹å¤„ç†å™¨
	pipeline.addLast(&quot;serverHeartBeatHandler&quot;, new ServerHeartBeatHandler(listener));

}

// å¤„ç†å™¨é€»è¾‘
public class ServerHeartBeatHandler extends ChannelDuplexHandler {
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {
		// åˆ¤æ–­æ˜¯å¦æ˜¯IdleStateEvent
        if (evt instanceof IdleStateEvent) {
             // å¿ƒè·³æ£€æµ‹æœåŠ¡å™¨ç«¯  è¶…æ—¶ç›´æ¥å…³é—­
             // äº¤ç»™ handlerremoveå¤„ç†
            ctx.close();
        } else {
            //å¦åˆ™ä¸åšå¤„ç†
            super.userEventTriggered(ctx, evt);
        }
    }
}
</code></pre>
<h4 id="2-å®¢æˆ·ç«¯ä»£ç ">2. å®¢æˆ·ç«¯ä»£ç </h4>
<pre><code class="language-java">@Override
protected void initChannel(SocketChannel socketChannel) throws Exception {
    ChannelPipeline pipeline = socketChannel.pipeline();

    // å¿ƒè·³æ£€æµ‹ , å¦‚æœ60Sæˆ‘ä»¬æ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨ä¿¡æ¯,æˆ‘ä»¬å°±å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…
    pipeline.addLast(&quot;nettyHeartBeatHandler&quot;, new IdleStateHandler(60, 0 , 0)

    pipeline.addLast(&quot;heartBeatHandler&quot;, new ClientHeartBeatHandler(listener));
}

//å¤„ç†å™¨
public class ClientHeartBeatHandler extends ChannelDuplexHandler {
    private ChatBootListener listener;
    public ClientHeartBeatHandler(ChatBootListener listener) {
        this.listener = listener;
    }
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {
        if (evt instanceof IdleStateEvent) {
            // å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…
            ctx.channel().writeAndFlush(Constants.HEART_BEAT_NPACK).addListener(new GenericFutureListener&lt;Future&lt;? super Void&gt;&gt;() {
                @Override
                public void operationComplete(Future&lt;? super Void&gt; future) throws Exception {
                    if (future.isSuccess()) {
                    // æˆåŠŸä¸€èˆ¬æ˜¯å‘é€åˆ°äº†ç¼“å†²åŒº , ä½†æ˜¯å¹¶ä¸æ˜¯ä»£è¡¨æœåŠ¡å™¨ç«¯æ”¶åˆ°äº†è¯·æ±‚
                    } else {
                        // TODO: 2019/11/16  å¤±è´¥ ........... çœ‹éœ€æ±‚
                    }
                }
            });
        } else {
            // äº¤ç»™çˆ¶ç±»å¤„ç†
            super.userEventTriggered(ctx, evt);
        }
    }
}
</code></pre>
<h3 id="2-åŸºæœ¬åŸç†">2. åŸºæœ¬åŸç†</h3>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-19/f4cb4318-c7a6-4d9e-97f9-0ae2f95218ed.jpg?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>å°±æ˜¯ ChannelHandlerContext çš„ EventExecutor å®šæœŸå»æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ ,éœ€è¦ä¼ å…¥ä¸€ä¸ªrunnableå¯¹è±¡å’Œä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ ,äººåä¸€ç›´å®šæœŸæ‰§è¡Œ ..........</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-objectdecoder%E5%92%8Cobjectencoder-%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">1. ObjectDecoderå’ŒObjectEncoder ç¼–è§£ç å™¨</a>
<ul>
<li><a href="#1-objectencoder">1. ObjectEncoder</a></li>
<li><a href="#2-objectdecoder">2. ObjectDecoder</a></li>
<li><a href="#3-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">3. å¿«é€Ÿå¼€å§‹</a></li>
<li><a href="#4-%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">4. ç¼–è§£ç å™¨æºç åˆ†æ</a>
<ul>
<li><a href="#1-objectencoder-%E7%BC%96%E7%A0%81%E5%99%A8">1. ObjectEncoder ç¼–ç å™¨</a></li>
</ul>
</li>
<li><a href="#2-objectdecoder-%E8%A7%A3%E7%A0%81%E5%99%A8">2. ObjectDecoder è§£ç å™¨</a></li>
</ul>
</li>
<li><a href="#2-stringencoder%E5%92%8Cstringdecoder-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">2. StringEncoderå’ŒStringDecoder - å­—ç¬¦ä¸²ç¼–è§£ç å™¨</a></li>
<li><a href="#3-fixedlengthframedecoder-%E5%AE%9A%E9%95%BF%E8%A7%A3%E7%A0%81%E5%99%A8">3. FixedLengthFrameDecoder - å®šé•¿è§£ç å™¨</a>
<ul>
<li><a href="#1-%E6%BA%90%E7%A0%81">1. æºç </a></li>
<li><a href="#2-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">2. åŸºæœ¬ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="#4-lengthfieldbasedframedecoder-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%A3%E7%A0%81%E5%99%A8">4. LengthFieldBasedFrameDecoder - è‡ªå®šä¹‰è§£ç å™¨</a>
<ul>
<li><a href="#1-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">1. æ„é€ æ–¹æ³•</a></li>
<li><a href="#2-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8">2. ç®€å•ä½¿ç”¨</a>
<ul>
<li><a href="#1-%E7%AC%AC%E4%B8%80%E7%A7%8D%E7%AE%80%E5%8D%95%E6%83%85%E5%86%B510-0-200">1. ç¬¬ä¸€ç§ç®€å•æƒ…å†µ(10, 0, 2,0,0)</a></li>
<li><a href="#2-%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%83%85%E5%86%B510-0-2-20">2. ç¬¬äºŒç§æƒ…å†µ(10, 0, 2,-2,0)</a></li>
<li><a href="#3-%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5-10-0-2-22">3. ç¬¬ä¸‰ç§æƒ…å†µ (10, 0, 2,-2,2)</a></li>
</ul>
</li>
<li><a href="#3-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">3. æºç åˆ†æ :</a></li>
</ul>
</li>
<li><a href="#5-delimiterbasedframedecoder-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E9%9A%94%E7%AC%A6%E8%A7%A3%E7%A0%81%E5%99%A8">5. DelimiterBasedFrameDecoder - è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨</a>
<ul>
<li><a href="#1-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-2">1. æ„é€ æ–¹æ³•</a></li>
<li><a href="#2-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-2">2. ç®€å•ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="#6-linebasedframedecoder-%E6%8C%89%E8%A1%8C%E8%A7%A3%E7%A0%81%E5%99%A8">6. LineBasedFrameDecoder - æŒ‰è¡Œè§£ç å™¨</a>
<ul>
<li><a href="#1-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-3">1. æ„é€ æ–¹æ³•</a></li>
<li><a href="#2-%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8">2. å¿«é€Ÿä½¿ç”¨</a></li>
<li><a href="#3-%E5%88%86%E6%9E%90-bufforeachbyte%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8">3. åˆ†æ - buf.forEachByte()æ–¹æ³•çš„ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="#7-idlestatehandler-%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B%E5%A4%84%E7%90%86%E5%99%A8">7. IdleStateHandler - å¿ƒè·³æ£€æµ‹å¤„ç†å™¨</a>
<ul>
<li><a href="#1-%E5%A6%82%E4%BD%95%E5%8E%BB%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%90%88%E7%90%86%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B">1. å¦‚ä½•å»è®¾è®¡ä¸€ä¸ªåˆç†å¿ƒè·³æ£€æµ‹</a>
<ul>
<li><a href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E4%BB%A3%E7%A0%81">1. æœåŠ¡å™¨ç«¯ä»£ç </a></li>
<li><a href="#2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81">2. å®¢æˆ·ç«¯ä»£ç </a></li>
</ul>
</li>
<li><a href="#2-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">2. åŸºæœ¬åŸç†</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>