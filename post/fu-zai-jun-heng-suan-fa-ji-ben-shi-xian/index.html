<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>è´Ÿè½½å‡è¡¡ç®—æ³• - åŸºæœ¬å®ç° | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/fu-zai-jun-heng-suan-fa-ji-ben-shi-xian/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>è´Ÿè½½å‡è¡¡ç®—æ³• - åŸºæœ¬å®ç°</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-12-02</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/fu-zai-jun-heng-suan-fa-ji-ben-shi-xian/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/h-oLWzEpzKL/"
								class="tag">ç®—æ³•</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2254å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">9 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	æœ€è¿‘åœ¨æ¯”èµ›ä¸€ä¸ªé¡¹ç›® , æ˜¯ç»™Dubboå†™ä¸€ä¸ªè´Ÿè½½å‡è¡¡æ¥å£ , å…¶å®dubboå·²ç»å®ç°äº†ä¸‹é¢å››ç§, æ‰€ä»¥ä»–åšçš„ä¸æ˜¯è¿™ä¸ªå•é¢è´Ÿè½½å‡è¡¡, éœ€è¦åšåŒå‘è´Ÿè½½å‡è¡¡ , è´Ÿè½½å‡è¡¡çš„æƒé‡å–å†³äºæœåŠ¡ç«¯,æ‰€ä»¥æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¸çŸ¥é“å¦‚ä½•è®¡ç®—æƒé‡, æƒé‡å—åˆ°å¾ˆå¤šå› ç´ å½±å“ ,æ‰€ä»¥å°±éœ€è¦åŠ¨æ€è€ƒè™‘äº†.</p>
</blockquote>
<blockquote>
<p>â€‹	Dubbo æä¾›äº†4ç§è´Ÿè½½å‡è¡¡å®ç°ï¼Œåˆ†åˆ«æ˜¯åŸºäºæƒé‡éšæœºç®—æ³•çš„ RandomLoadBalanceã€åŸºäºæœ€å°‘æ´»è·ƒè°ƒç”¨æ•°ç®—æ³•çš„ LeastActiveLoadBalanceã€åŸºäº hash ä¸€è‡´æ€§çš„ ConsistentHashLoadBalanceï¼Œä»¥åŠåŸºäºåŠ æƒè½®è¯¢ç®—æ³•çš„ RoundRobinLoadBalanceã€‚</p>
</blockquote>
<h2 id="1-randomloadbalance">1. RandomLoadBalance</h2>
<p>RandomLoadBalance æ˜¯<strong>åŠ æƒéšæœºç®—æ³•</strong>çš„å…·ä½“å®ç°ï¼Œå®ƒçš„ç®—æ³•æ€æƒ³å¾ˆç®€å•ã€‚å‡è®¾æˆ‘ä»¬æœ‰<strong>ä¸€ç»„æœåŠ¡å™¨ servers = [A, B, C]ï¼Œä»–ä»¬å¯¹åº”çš„æƒé‡ä¸º weights = [5, 3, 2]ï¼Œæƒé‡æ€»å’Œä¸º10</strong>ã€‚ç°åœ¨æŠŠè¿™äº›æƒé‡å€¼å¹³é“ºåœ¨ä¸€ç»´åæ ‡å€¼ä¸Šï¼Œ[0, 5) åŒºé—´å±äºæœåŠ¡å™¨ Aï¼Œ[5, 8) åŒºé—´å±äºæœåŠ¡å™¨ Bï¼Œ[8, 10) åŒºé—´å±äºæœåŠ¡å™¨ Cã€‚æ¥ä¸‹æ¥é€šè¿‡éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ªèŒƒå›´åœ¨ [0, 10) ä¹‹é—´çš„éšæœºæ•°ï¼Œç„¶åè®¡ç®—è¿™ä¸ªéšæœºæ•°ä¼šè½åˆ°å“ªä¸ªåŒºé—´ä¸Šã€‚æ¯”å¦‚æ•°å­—3ä¼šè½åˆ°æœåŠ¡å™¨ A å¯¹åº”çš„åŒºé—´ä¸Šï¼Œæ­¤æ—¶è¿”å›æœåŠ¡å™¨ A å³å¯ã€‚æƒé‡è¶Šå¤§çš„æœºå™¨ï¼Œåœ¨åæ ‡è½´ä¸Šå¯¹åº”çš„åŒºé—´èŒƒå›´å°±è¶Šå¤§ï¼Œå› æ­¤éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆçš„æ•°å­—å°±ä¼šæœ‰æ›´å¤§çš„æ¦‚ç‡è½åˆ°æ­¤åŒºé—´å†…ã€‚åªè¦éšæœºæ•°ç”Ÿæˆå™¨äº§ç”Ÿçš„éšæœºæ•°åˆ†å¸ƒæ€§å¾ˆå¥½ï¼Œåœ¨ç»è¿‡å¤šæ¬¡é€‰æ‹©åï¼Œæ¯ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­çš„æ¬¡æ•°æ¯”ä¾‹æ¥è¿‘å…¶æƒé‡æ¯”ä¾‹ã€‚æ¯”å¦‚ï¼Œç»è¿‡ä¸€ä¸‡æ¬¡é€‰æ‹©åï¼ŒæœåŠ¡å™¨ A è¢«é€‰ä¸­çš„æ¬¡æ•°å¤§çº¦ä¸º5000æ¬¡ï¼ŒæœåŠ¡å™¨ B è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º3000æ¬¡ï¼ŒæœåŠ¡å™¨ C è¢«é€‰ä¸­çš„æ¬¡æ•°çº¦ä¸º2000æ¬¡ã€‚</p>
<pre><code class="language-java">private &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {

    int len = invokers.size();
    int[] arr = new int[len];
    int count = 0;
    int totalWight = 0;
    for (Invoker&lt;T&gt; invoker : invokers) {
        int wight = invoker.getUrl().getParameter(org.apache.dubbo.common.Constants.WEIGHT_KEY, 1);
        arr[count++] = wight;
        totalWight += wight;
    }

    // éšæœºåç§»é‡
    int offset = ThreadLocalRandom.current().nextInt(totalWight);

    for (int i = 0; i &lt; arr.length; i++) {

        // æ¯”å¦‚ [2 , 3 , 5]  , offset=7 , æ­¤æ—¶ offset-2=5 , offset-3=2 , offset-5=-3 ,æ­¤æ—¶å½“ä»–ä¸ºè´Ÿæ•°æ—¶,è¯´æ˜å°±åœ¨è¿™ä¸ªåŒºé—´å†…, æˆ‘ä»¬æ˜¯å·¦é—­å³å¼€[0,2) ,[2,5) ,[5,10)
        offset -= arr[i];

        // æ­¤æ—¶å·²ç»å°äº0äº†, è¯´æ˜åœ¨è¿™ä¸ªåŒºé—´å†…
        if (offset &lt; 0) {
            // è¿”å›å°±è¡Œäº†
            return invokers.get(i);
        }
    }

    return ... 
}
</code></pre>
<h2 id="2-leastactiveloadbalance">2. LeastActiveLoadBalance</h2>
<p>LeastActiveLoadBalance ç¿»è¯‘è¿‡æ¥æ˜¯<strong>æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡</strong>ã€‚æ´»è·ƒè°ƒç”¨æ•°è¶Šå°ï¼Œè¡¨æ˜è¯¥æœåŠ¡æä¾›è€…æ•ˆç‡è¶Šé«˜ï¼Œå•ä½æ—¶é—´å†…å¯å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚æ­¤æ—¶åº”ä¼˜å…ˆå°†è¯·æ±‚åˆ†é…ç»™è¯¥æœåŠ¡æä¾›è€…ã€‚åœ¨å…·ä½“å®ç°ä¸­ï¼Œæ¯ä¸ªæœåŠ¡æä¾›è€…å¯¹åº”ä¸€ä¸ªæ´»è·ƒæ•° activeã€‚åˆå§‹æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æœåŠ¡æä¾›è€…æ´»è·ƒæ•°å‡ä¸º0ã€‚æ¯æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œæ´»è·ƒæ•°åŠ 1ï¼Œå®Œæˆè¯·æ±‚ååˆ™å°†æ´»è·ƒæ•°å‡1ã€‚åœ¨æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ€§èƒ½å¥½çš„æœåŠ¡æä¾›è€…å¤„ç†è¯·æ±‚çš„é€Ÿåº¦æ›´å¿«ï¼Œå› æ­¤æ´»è·ƒæ•°ä¸‹é™çš„ä¹Ÿè¶Šå¿«ï¼Œæ­¤æ—¶è¿™æ ·çš„æœåŠ¡æä¾›è€…èƒ½å¤Ÿä¼˜å…ˆè·å–åˆ°æ–°çš„æœåŠ¡è¯·æ±‚ã€è¿™å°±æ˜¯æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•çš„åŸºæœ¬æ€æƒ³ã€‚é™¤äº†æœ€å°æ´»è·ƒæ•°ï¼ŒLeastActiveLoadBalance åœ¨å®ç°ä¸Šè¿˜å¼•å…¥äº†æƒé‡å€¼ã€‚æ‰€ä»¥å‡†ç¡®çš„æ¥è¯´ï¼ŒLeastActiveLoadBalance æ˜¯åŸºäºåŠ æƒæœ€å°æ´»è·ƒæ•°ç®—æ³•å®ç°çš„ã€‚ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡æä¾›è€…é›†ç¾¤ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ€§èƒ½ä¼˜å¼‚çš„æœåŠ¡æä¾›è€…ã€‚æŸä¸€æ—¶åˆ»å®ƒä»¬çš„æ´»è·ƒæ•°ç›¸åŒï¼Œæ­¤æ—¶ Dubbo ä¼šæ ¹æ®å®ƒä»¬çš„æƒé‡å»åˆ†é…è¯·æ±‚ï¼Œæƒé‡è¶Šå¤§ï¼Œè·å–åˆ°æ–°è¯·æ±‚çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚å¦‚æœä¸¤ä¸ªæœåŠ¡æä¾›è€…æƒé‡ç›¸åŒï¼Œæ­¤æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªå³å¯ã€‚</p>
<blockquote>
<p>â€‹	è¿™ä¸ªéœ€è¦æˆ‘ä»¬å»ç»´æŠ¤ä¸€ä¸ªæœ€å°è¿æ¥æ•°çš„è®¡ç®—, é…åˆåŠ æƒ ,å½“è¿æ¥æ•°ç›¸åŒçš„æ—¶å€™,é€‰æ‹©åŠ æƒåˆ†æœ€é«˜çš„ ...</p>
</blockquote>
<h2 id="3-consistenthashloadbalance">3. ConsistentHashLoadBalance</h2>
<p>ä¸€è‡´æ€§ hash ç®—æ³•ç”±éº»çœç†å·¥å­¦é™¢çš„ Karger åŠå…¶åˆä½œè€…äº1997å¹´æå‡ºçš„ï¼Œç®—æ³•æå‡ºä¹‹åˆæ˜¯ç”¨äºå¤§è§„æ¨¡ç¼“å­˜ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡ã€‚å®ƒçš„å·¥ä½œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæ ¹æ® ip æˆ–è€…å…¶ä»–çš„ä¿¡æ¯ä¸ºç¼“å­˜èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ª hashï¼Œå¹¶å°†è¿™ä¸ª hash æŠ•å°„åˆ° [0, 232 - 1] çš„åœ†ç¯ä¸Šã€‚å½“æœ‰æŸ¥è¯¢æˆ–å†™å…¥è¯·æ±‚æ—¶ï¼Œåˆ™ä¸ºç¼“å­˜é¡¹çš„ key ç”Ÿæˆä¸€ä¸ª hash å€¼ã€‚ç„¶åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºæˆ–ç­‰äºè¯¥ hash å€¼çš„ç¼“å­˜èŠ‚ç‚¹ï¼Œå¹¶åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸­æŸ¥è¯¢æˆ–å†™å…¥ç¼“å­˜é¡¹ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æŒ‚äº†ï¼Œåˆ™åœ¨ä¸‹ä¸€æ¬¡æŸ¥è¯¢æˆ–å†™å…¥ç¼“å­˜æ—¶ï¼Œä¸ºç¼“å­˜é¡¹æŸ¥æ‰¾å¦ä¸€ä¸ªå¤§äºå…¶ hash å€¼çš„ç¼“å­˜èŠ‚ç‚¹å³å¯ã€‚</p>
<blockquote>
<p>â€‹	è¿™ä¸ªä¸»è¦æ˜¯é hashç®—æ³• , é€šè¿‡hash % æœåŠ¡å™¨æ•°é‡ = æœåŠ¡å™¨ç´¢å¼•</p>
<p>â€‹	Javaä¸­å¯ä»¥ä½¿ç”¨è¿™ä¸ª  :  <code>int identityHashCode = System.identityHashCode(invokers);</code>æ¥è·å–</p>
</blockquote>
<h2 id="4-roundrobinloadbalance">4. RoundRobinLoadBalance</h2>
<p><strong>åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡çš„å®ç° RoundRobinLoadBalance</strong> , æˆ‘é€‰æ‹©çš„å°±æ˜¯è¿™ç§</p>
<p>è¿™é‡Œä»<strong>æœ€ç®€å•çš„è½®è¯¢</strong>å¼€å§‹è®²èµ·ï¼Œæ‰€è°“è½®è¯¢æ˜¯æŒ‡å°†è¯·æ±‚è½®æµåˆ†é…ç»™æ¯å°æœåŠ¡å™¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸‰å°æœåŠ¡å™¨ Aã€Bã€Cã€‚æˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Aï¼Œç¬¬äºŒä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Bï¼Œç¬¬ä¸‰ä¸ªè¯·æ±‚åˆ†é…ç»™æœåŠ¡å™¨ Cï¼Œç¬¬å››ä¸ªè¯·æ±‚å†æ¬¡åˆ†é…ç»™æœåŠ¡å™¨ Aã€‚è¿™ä¸ªè¿‡ç¨‹å°±å«åšè½®è¯¢ã€‚è½®è¯¢æ˜¯ä¸€ç§æ— çŠ¶æ€è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå®ç°ç®€å•ï¼Œé€‚ç”¨äºæ¯å°æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯ä¸‹ã€‚ä½†ç°å®æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯æ¯å°æœåŠ¡å™¨æ€§èƒ½å‡ç›¸è¿‘ã€‚å¦‚æœæˆ‘ä»¬å°†ç­‰é‡çš„è¯·æ±‚åˆ†é…ç»™æ€§èƒ½è¾ƒå·®çš„æœåŠ¡å™¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚</p>
<p>å› æ­¤ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹<strong>è½®è¯¢è¿‡ç¨‹è¿›è¡ŒåŠ æƒ</strong>ï¼Œä»¥è°ƒæ§æ¯å°æœåŠ¡å™¨çš„è´Ÿè½½ã€‚ç»è¿‡åŠ æƒåï¼Œæ¯å°æœåŠ¡å™¨èƒ½å¤Ÿå¾—åˆ°çš„è¯·æ±‚æ•°æ¯”ä¾‹ï¼Œæ¥è¿‘æˆ–ç­‰äºä»–ä»¬çš„æƒé‡æ¯”ã€‚æ¯”å¦‚æœåŠ¡å™¨ Aã€Bã€C æƒé‡æ¯”ä¸º 5:2:1ã€‚é‚£ä¹ˆåœ¨8æ¬¡è¯·æ±‚ä¸­ï¼ŒæœåŠ¡å™¨ A å°†æ”¶åˆ°å…¶ä¸­çš„5æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨ B ä¼šæ”¶åˆ°å…¶ä¸­çš„2æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨ C åˆ™æ”¶åˆ°å…¶ä¸­çš„1æ¬¡è¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æœ‰ä¸ªè¡¨æ ¼ , é»˜è®¤æƒé‡æ˜¯ [5,1,1]</p>
<table>
<thead>
<tr>
<th>è¯·æ±‚ç¼–å·</th>
<th>currentWeight æ•°ç»„</th>
<th>é€‰æ‹©ç»“æœ</th>
<th>å‡å»æƒé‡æ€»å’Œåçš„ currentWeight æ•°ç»„</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>[5, 1, 1]</td>
<td>A</td>
<td>[-2, 1, 1]</td>
</tr>
<tr>
<td>2</td>
<td>[3, 2, 2]</td>
<td>A</td>
<td>[-4, 2, 2]</td>
</tr>
<tr>
<td>3</td>
<td>[1, 3, 3]</td>
<td>B</td>
<td>[1, -4, 3]</td>
</tr>
<tr>
<td>4</td>
<td>[6, -3, 4]</td>
<td>A</td>
<td>[-1, -3, 4]</td>
</tr>
<tr>
<td>5</td>
<td>[4, -2, 5]</td>
<td>C</td>
<td>[4, -2, -2]</td>
</tr>
<tr>
<td>6</td>
<td>[9, -1, -1]</td>
<td>A</td>
<td>[2, -1, -1]</td>
</tr>
<tr>
<td>7</td>
<td>[7, 0, 0]</td>
<td>A</td>
<td>[0, 0, 0]</td>
</tr>
</tbody>
</table>
<p>æ­¤æ—¶ 7 æ¬¡ä¸­AèŠ‚ç‚¹è¢«é€‰ä¸­çš„æ¬¡æ•°æ˜¯ 5 , B æ˜¯1 ,Cæ˜¯1 ,æ‰€ä»¥ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚</p>
<p>è®¡ç®—æ–¹æ³•å¦‚ä¸‹ ,  é¦–å…ˆæœ‰ä¸‰ä¸ªå˜é‡ , è®°å½•äº† currentWeight , effectiveWeight , totalWeight</p>
<pre><code class="language-java"> private class Node {
        private int currentWeight; // å½“å‰æƒé‡
        private int effectiveWeight; // æœ‰æ•ˆæƒé‡,åˆå§‹åŒ–çš„æ—¶å€™ç­‰äºå½“å‰æƒé‡
        private int totalWeight; // æ€»æƒé‡
 }     
</code></pre>
<p>æˆ‘ä»¬å…ˆçœ‹åˆå§‹åŒ– , åˆå§‹åŒ–æ—¶ ,è®¡ç®—æƒé‡</p>
<pre><code class="language-java">æ¯”å¦‚æˆ‘ä»¬çŸ¥é“æƒé‡äº† A : 5 , B : 1 , C : 1
</code></pre>
<p>åˆå§‹åŒ–èŠ‚ç‚¹</p>
<pre><code class="language-java">A : new Node(5, 5, 7)
B : new Node(1, 1, 7)
C : new Node(1, 1, 7)
    
æ­¤æ—¶currentWeightçš„å’Œæ˜¯ : 7    
</code></pre>
<p>å½“ç¬¬ä¸€æ¬¡çš„æ—¶å€™ , AèŠ‚ç‚¹æƒé‡æœ€å¤§ ,æ­¤æ—¶ 5-7=-2, AèŠ‚ç‚¹å˜æˆäº† Node(-2, 5, 7)</p>
<pre><code class="language-java">A : new Node(-2, 5, 7)
B : new Node(1, 1, 7)
C : new Node(1, 1, 7)

æ­¤æ—¶currentWeightçš„å’Œæ˜¯ : 0
</code></pre>
<p>ç„¶åé‡æ–°å›å½’, å›å½’éœ€è¦currentWeight= currentWeight+effectiveWeight</p>
<pre><code>A : new Node(3, 5, 7)
B : new Node(2, 1, 7)
C : new Node(2, 1, 7)

æ­¤æ—¶currentWeightçš„å’Œæ˜¯ : 7 // æ‰€ä»¥åˆå›æ¥äº† .. .. 
</code></pre>
<p><strong>æ€æ ·åšå‘¢ ?</strong></p>
<p>æ­¤æ—¶æˆ‘ä»¬ç”¨ä¸€ä¸ª <code>PriorityQueue&lt;Pair&lt;String, Node&gt;&gt;</code> ç»´æŠ¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ , åŒæ—¶ä½¿ç”¨ <code>Pair&lt;String, Node&gt;</code>ç»´æŠ¤å•ä¸ªèŠ‚ç‚¹</p>
<pre><code class="language-java">1. åˆå§‹åŒ–é˜Ÿåˆ—
PriorityBlockingQueue&lt;Pair&lt;String, Node&gt;&gt; weightQueue = new PriorityBlockingQueue&lt;&gt;(3, (o1, o2) -&gt; o2.getValue().getCurrentWeight() - o1.getValue().getCurrentWeight());


2. éå†æ”¾å…¥æƒé‡
weightQueue.add(new Pair&lt;&gt;(key, new Node(currentWeight, effectiveWeight, totalWeight))); 

3. å½“æ”¾å…¥ä»¥å, æ­¤æ—¶å°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªå½“å‰æƒé‡æœ€å¤§çš„èŠ‚ç‚¹ , å¦‚æœä¸æƒ³ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—, å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªå¤§é¡¶å † ,å¾ˆç®€å•çš„. 
    
// è·å–å½“å‰èŠ‚ç‚¹æƒé‡æœ€å¤§çš„ ,     
Pair&lt;String, Node&gt; hPair = weightQueue.take(); 
// æ­¤æ—¶hPairèŠ‚ç‚¹çš„å€¼åº”å½“æ˜¯ 5 - 7 = -2 
int afterCurrentWeight = value.getCurrentWeight() - value.getTotalWeight();
// è®¾ç½®å€¼
hNode.setCurrentWeight(afterCurrentWeight);

// éå†
for (Pair&lt;String, Node&gt; stringNodePair : weightQueue) {
    //è·å–èŠ‚ç‚¹ 
    Node node = stringNodePair.getValue();
    // å‰©ä½™æ¯ä¸ªèŠ‚ç‚¹å€¼ + æœ‰æ•ˆå€¼ 
    int after = node.getCurrentWeight() + node.getEffectiveWeight();
    
    // è®¾ç½®èŠ‚ç‚¹å€¼ 
    node.setCurrentWeight(after);
}
// ç”±äºæˆ‘ä»¬æ‹¿å‡ºæ¥çš„èŠ‚ç‚¹è¿˜æ²¡æœ‰ é‡æ–°è®¡ç®—, è¿˜è¦è®¡ç®—
hNode.setCurrentWeight(value.getCurrentWeight() + value.getEffectiveWeight());
// é‡æ–°æ”¾å…¥èŠ‚ç‚¹. ... ,é‡æ–°æ’åº
weightQueue.add(hPair);
</code></pre>
<p>å…¶å®è‡ªå·±ç»´æŠ¤çš„è¯å¯ä»¥è¿›è¡Œ heapfyçš„ , æˆ‘ä»¬åªèƒ½ä¾èµ–JDKæä¾›çš„æ•°æ®ç»“æ„è¿›è¡Œçš„è¿™ç§å–å·§æ–¹å¼</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-randomloadbalance">1. RandomLoadBalance</a></li>
<li><a href="#2-leastactiveloadbalance">2. LeastActiveLoadBalance</a></li>
<li><a href="#3-consistenthashloadbalance">3. ConsistentHashLoadBalance</a></li>
<li><a href="#4-roundrobinloadbalance">4. RoundRobinLoadBalance</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>