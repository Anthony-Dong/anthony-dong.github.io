<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Apollo-Client è®¾è®¡æ¶æ„å’ŒSpringé›†æˆåŸç†è§£æ | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/apollo-client-she-ji-jia-gou-jie-xi-he-ying-yong/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223360682" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Apollo-Client è®¾è®¡æ¶æ„å’ŒSpringé›†æˆåŸç†è§£æ</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2019-11-08</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/apollo-client-she-ji-jia-gou-jie-xi-he-ying-yong/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/30KjDURvPf/"
								class="tag">spring</a> |
							 <a
								href="https://anthony-dong.github.io/tag/t2J0gSv9kxo/"
								class="tag">Apollo</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">2227å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">11 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<h2 id="1-apolloå®˜æ–¹ä»‹ç»">1. Apolloå®˜æ–¹ä»‹ç»</h2>
<h3 id="1-åŸºæœ¬æ¶æ„">1. åŸºæœ¬æ¶æ„</h3>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-08/b10e6287-c239-453c-9ce8-b6937848ed49.png" alt="" loading="lazy"></figure>
<p>ä¸Šå›¾ç®€è¦æè¿°äº†Apolloå®¢æˆ·ç«¯çš„å®ç°åŸç†ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¿æŒäº†ä¸€ä¸ªé•¿è¿æ¥ï¼Œä»è€Œèƒ½ç¬¬ä¸€æ—¶é—´è·å¾—é…ç½®æ›´æ–°çš„æ¨é€ã€‚ï¼ˆé€šè¿‡Http Long Pollingå®ç°ï¼‰</li>
<li>å®¢æˆ·ç«¯è¿˜ä¼šå®šæ—¶ä»Apolloé…ç½®ä¸­å¿ƒæœåŠ¡ç«¯æ‹‰å–åº”ç”¨çš„æœ€æ–°é…ç½®ã€‚</li>
<li>å®¢æˆ·ç«¯ä»Apolloé…ç½®ä¸­å¿ƒæœåŠ¡ç«¯è·å–åˆ°åº”ç”¨çš„æœ€æ–°é…ç½®åï¼Œä¼šä¿å­˜åœ¨å†…å­˜ä¸­</li>
<li>å®¢æˆ·ç«¯ä¼šæŠŠä»æœåŠ¡ç«¯è·å–åˆ°çš„é…ç½®åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸€ä»½ï¼Œä»¥å…æœåŠ¡å™¨å®•æœº</li>
<li>åº”ç”¨ç¨‹åºå¯ä»¥ä»Apolloå®¢æˆ·ç«¯è·å–æœ€æ–°çš„é…ç½®ã€è®¢é˜…é…ç½®æ›´æ–°é€šçŸ¥</li>
</ol>
<h3 id="2å’Œspringé›†æˆçš„åŸç†">2.å’ŒSpringé›†æˆçš„åŸç†</h3>
<p>Springä»3.1ç‰ˆæœ¬å¼€å§‹å¢åŠ äº†<code>ConfigurableEnvironment</code>å’Œ<code>PropertySource</code>ï¼š</p>
<ul>
<li>ConfigurableEnvironment
<ul>
<li>Springçš„ApplicationContextä¼šåŒ…å«ä¸€ä¸ªEnvironmentï¼ˆå®ç°ConfigurableEnvironmentæ¥å£ï¼‰ï¼ŒåŒ…å«</li>
</ul>
</li>
<li>PropertySource
<ul>
<li>å±æ€§æºï¼Œå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬çš„application.properties</li>
</ul>
</li>
</ul>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-08/11e976ca-f750-4889-93f1-5e19ae4194ed.png" alt="" loading="lazy"></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPropertySourceä¹‹é—´æ˜¯æœ‰ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªKeyåœ¨å¤šä¸ªproperty sourceä¸­éƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨å‰é¢çš„property sourceä¼˜å…ˆã€‚</p>
<p>æ‰€ä»¥å¯¹ä¸Šå›¾çš„ä¾‹å­ï¼š</p>
<ul>
<li>env.getProperty(â€œkey1â€) -&gt; value1</li>
<li><strong>env.getProperty(â€œkey2â€) -&gt; value2</strong></li>
<li>env.getProperty(â€œkey3â€) -&gt; value4</li>
</ul>
<p>åœ¨ç†è§£äº†ä¸Šè¿°åŸç†åï¼ŒApolloå’ŒSpring/Spring Booté›†æˆçš„æ‰‹æ®µå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼šåœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µï¼ŒApolloä»è¿œç«¯è·å–é…ç½®ï¼Œç„¶åç»„è£…æˆPropertySourceå¹¶æ’å…¥åˆ°ç¬¬ä¸€ä¸ªå³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-08/d093f6f8-dc93-4e74-9f75-071c8579bd97.png" alt="" loading="lazy"></figure>
<p><strong>çŸ¥é“è®¾è®¡æ€è·¯äº†æˆ‘ä»¬å°±å¼€å§‹å§</strong></p>
<h2 id="2-apollo-client-æºç ">2. Apollo-Client æºç </h2>
<p>è¿™é‡Œä»‹æ„çœ‹çœ‹æˆ‘çš„é‚£ä¸€ç¯‡æ–‡ç«   , <a href="https://github.com/Anthony-Dong/spring-example/tree/master/Spring-Boot%E6%95%99%E7%A8%8B/spring-boot-di">æœ¬ç¯‡è‡ªå·±å®ç°çš„æºç é“¾æ¥</a> , å¯ä»¥è¯´è¿˜æ˜¯ä¸é”™çš„ , è™½ç„¶å†™çš„ä¸å’‹å¥½</p>
<h3 id="é¡¹ç›®å›¾">é¡¹ç›®å›¾</h3>
<figure data-type="image" tabindex="4"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-08/612a1d81-7400-470d-bbd1-1c3d850d9e52.png" alt="" loading="lazy"></figure>
<p>è¿™ä¸ªæ˜¯ä¸€ä¸ªå¤§é¢˜çš„ç›®å½•</p>
<h3 id="æ•´ä¸ªè®¾è®¡æ€è·¯">æ•´ä¸ªè®¾è®¡æ€è·¯</h3>
<p>è¿™ä¸ªæ˜¯æˆ‘ç»˜åˆ¶çš„å¸Œæœ›èƒ½çœ‹æ‡‚</p>
<figure data-type="image" tabindex="5"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2019-11-08/f049026b-de86-4dde-a189-4a36ea1caf5f.jpg" alt="" loading="lazy"></figure>
<h3 id="1-apolloapplicationcontextinitializer">1. ApolloApplicationContextInitializer</h3>
<pre><code class="language-java">/**
  Initialize apollo system properties and inject the Apollo config in Spring Boot bootstrap phase Configuration example:
  
 app.id = 100004458
 apollo.bootstrap.enabled = true
 apollo.bootstrap.namespaces = application,FX.apollo
*/

public class ApolloApplicationContextInitializer implements
    ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; , EnvironmentPostProcessor, Ordered {
    // åœ¨SPRING å¯åŠ¨çš„æ—¶å€™å°±åŠ è½½äº† ,æœ€æ—©åŠ è½½çš„
     public void initialize(ConfigurableApplicationContext context) {
         ConfigurableEnvironment environment = context.getEnvironment();
         // åˆå§‹åŒ–ç¯å¢ƒ
         initialize(environment);
     }
    
    // ä¸ºäº†åœ¨SpringåŠ è½½æ—¥å¿—ç³»ç»Ÿé˜¶æ®µä¹‹å‰åŠ è½½Apolloé…ç½®
      public void postProcessEnvironment(ConfigurableEnvironment configurableEnvironment, SpringApplication springApplication) {
      // åˆå§‹åŒ–ç¯å¢ƒ
       initialize(configurableEnvironment);
  }
}
</code></pre>
<p>å®ƒå¯åŠ¨çš„ç›®çš„æ˜¯ :</p>
<p>1 .  åˆå§‹åŒ–apolloç³»ç»Ÿå±æ€§ï¼Œå¹¶åœ¨Spring Bootå¼•å¯¼é˜¶æ®µæ³¨å…¥apolloé…ç½®</p>
<p>2  . ä¸ºäº† ç¬¬ä¸€æ—¶é—´åŠ è½½Configç«¯è¿œç¨‹çš„é…ç½®æ–‡ä»¶<code>Config config = ConfigService.getConfig(namespace);</code>è¿™ä¸ªç±»æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è·å–,åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œçš„ , ç”¨äº application.properties é‡Œé¢å†™çš„é‚£äº›namespaceéƒ½åŠ è½½è¿›å», ç”¨äºå¯åŠ¨Apolloé…ç½®</p>
<h3 id="2apolloautoconfiguration">2.ApolloAutoConfiguration</h3>
<pre><code class="language-java">@Configuration
// æ¡ä»¶æ³¨å…¥ 
@ConditionalOnProperty(PropertySourcesConstants.APOLLO_BOOTSTRAP_ENABLED)
@ConditionalOnMissingBean(PropertySourcesProcessor.class)
public class ApolloAutoConfiguration {

  @Bean
  public ConfigPropertySourcesProcessor configPropertySourcesProcessor() {
      // ä¸»è¦æ˜¯è¿™ä¸ªåˆå§‹åŒ– ConfigPropertySourcesProcessor
    return new ConfigPropertySourcesProcessor();
  }
}

</code></pre>
<p><code>ApolloAutoConfiguration</code>ä»–çš„ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†åˆå§‹åŒ– <code>ConfigPropertySourcesProcessor</code></p>
<h3 id="3-configpropertysourcesprocessor">3. ConfigPropertySourcesProcessor</h3>
<pre><code class="language-java">public class ConfigPropertySourcesProcessor extends PropertySourcesProcessor
    implements BeanDefinitionRegistryPostProcessor {

  private ConfigPropertySourcesProcessorHelper helper = ServiceBootstrap.loadPrimary(ConfigPropertySourcesProcessorHelper.class);

  @Override
  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {
  // è¿™é‡Œçš„ç›®çš„æ˜¯ä¸ºäº† 
    helper.postProcessBeanDefinitionRegistry(registry);
  }
}
</code></pre>
<p><code>ConfigPropertySourcesProcessor</code> ä»–çš„ç›®çš„æœ‰ä¸¤ä¸ª :</p>
<p>1 .  å°±æ˜¯åˆå§‹åŒ– PropertySourcesProcessor</p>
<p>2 .  å°±æ˜¯åˆå§‹åŒ– Processor ,Apolloçš„ä¸€å †ç›‘å¬å™¨å¤„ç†å™¨<code>ApolloProcessor</code></p>
<h3 id="4-propertysourcesprocessor">4. PropertySourcesProcessor</h3>
<p>è¯´åˆ°è¿™ä¸ªæˆ‘ä»¬å¿…é¡»è¦è¯´ä¸€ä¸‹ : <code>@EnableApolloConfig</code> , å…ˆå»çœ‹çœ‹å®ƒå» ,çœ‹å®Œå‡ ä¹å°±æ‡‚äº† ,</p>
<pre><code class="language-java">// Apollo Property Sources processor for Spring Annotation Based Application 
// æ–‡æ¡£ä¸Šè¯´ä»–ä¸»è¦æ˜¯ä¸ºäº†å¤„ç†åŸºäºspringçš„æ³¨è§£
public class PropertySourcesProcessor implements BeanFactoryPostProcessor, EnvironmentAware, PriorityOrdered {
    
   // å¤„ç†é€»è¾‘å’ŒApolloApplicationContextInitializer å®ƒä¸€ç›®ä¸€æ ·
}
</code></pre>
<p>æ‰€ä»¥ çœ‹èµ·æ¥çœŸçš„å¾ˆç®€å•</p>
<h3 id="5-enableapolloconfig">5. @EnableApolloConfig</h3>
<pre><code class="language-java">@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@Documented
@Import(ApolloConfigRegistrar.class)
public @interface EnableApolloConfig {

  String[] value() default {ConfigConsts.NAMESPACE_APPLICATION};

  int order() default Ordered.LOWEST_PRECEDENCE;
}
</code></pre>
<p>å®ƒå‘¢ , å¼•å…¥äº†ä¸€ä¸ª <code>ApolloConfigRegistrar</code> ä¸»è¦ç›®çš„å°±æ˜¯é‚£<code>String[] value()</code> , å…¶å®å°±æ˜¯å¼•å…¥å¤šä¸ªnamespace , è¿™ä¸ªå¾ˆäººæ€§åŒ– , å…¶å®å°±æ˜¯è®©æ³¨è§£å¯¼å…¥ , è„±ç¦»é…ç½®æ–‡ä»¶(ä¾‹å¦‚ application.properties) ,</p>
<h3 id="6-apolloconfigregistrar">6. ApolloConfigRegistrar</h3>
<pre><code class="language-java">public class ApolloConfigRegistrar implements ImportBeanDefinitionRegistrar {

  // SPI ä½¿ç”¨çš„æ˜¯
  private ApolloConfigRegistrarHelper helper = ServiceBootstrap.loadPrimary(ApolloConfigRegistrarHelper.class);

  @Override
  public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
    helper.registerBeanDefinitions(importingClassMetadata, registry);
  }
}

# registerBeanDefinitions() æ–¹æ³•ä¸­ : 
    AnnotationAttributes attributes = AnnotationAttributes     .fromMap(importingClassMetadata.getAnnotationAttributes(EnableApolloConfig.class.getName()));
    String[] namespaces = attributes.getStringArray(&quot;value&quot;);
// å…³é”®åœ¨è¿™é‡Œ 
PropertySourcesProcessor.addNamespaces(Lists.newArrayList(namespaces), order);
</code></pre>
<p>è¿™ä¸ªç±»ç›®çš„ä¹Ÿæ˜¯ä¸¤ä¸ª :</p>
<p>1 .  å°†<code>@EnableApolloConfig</code>æ³¨è§£ä¸Šå†™çš„ <code>namespace</code>æ³¨å…¥åˆ° <code>PropertySourcesProcessor</code>ä¸­</p>
<p>2 . ä¹Ÿæ˜¯åˆå§‹åŒ–ä¸€å † <code>ApolloProcessor</code> ,ä»–ä¹Ÿæ˜¯åšäº†ä¸€äº›åˆ¤æ–­ , æˆ‘ä¹Ÿä¸æ‡‚ä»–ä¸ºå•¥é‡å¤åšåŒæ ·çš„äº‹æƒ… ,å¯èƒ½è€ƒè™‘åˆ°åŠ è½½æ—¶æœºçš„é—®é¢˜ .</p>
<h2 id="3-ç®€å•ä½¿ç”¨">3. ç®€å•ä½¿ç”¨</h2>
<p>æˆ‘è¿™é‡Œç›´æ¥å¤åˆ¶æˆ‘å†™çš„ä»£ç äº†  , æˆ‘æ„Ÿè§‰æ³¨é‡Šå¾ˆè¯¦ç»†</p>
<h3 id="1-å¯åŠ¨æ—¶ä¸ºbeanè®¾ç½®å±æ€§">1. å¯åŠ¨æ—¶ä¸ºbeanè®¾ç½®å±æ€§</h3>
<pre><code class="language-java">/**
 * {@link BeanFactoryPostProcessor} å¯ä»¥è·å–  BeanFactory å¯¹è±¡ æ“ä½œå…ƒä¿¡æ¯ {@link BeanDefinition} , åœ¨ bean åˆå§‹åŒ–ä¹‹å‰æ“ä½œçš„
 *
 * {@link EnvironmentAware} å¯ä»¥è·å–ç¯å¢ƒä¸Šä¸‹æ–‡ , å…¶å®å°±æ˜¯æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶çš„ä¿¡æ¯
 *
 * {@link PriorityOrdered}  è®¾ç½®Beançš„åŠ è½½é¡ºåº , æˆ‘ä»¬è®¾ç½®çš„æ˜¯æœ€é«˜ä¼˜å…ˆçº§
 * @date:2019/11/6 16:26
 * @author: &lt;a href='mailto:fanhaodong516@qq.com'&gt;Anthony&lt;/a&gt;
 */
public class MyBeanFactoryPostProcessor implements EnvironmentAware, PriorityOrdered, BeanFactoryPostProcessor {

    private ConfigurableEnvironment environment;

    // source name
    private final String proName = &quot;AnthonyPropertySources&quot;;


    private final Map&lt;String, Object&gt; map = new ConcurrentHashMap&lt;&gt;();


    public Map&lt;String, Object&gt; getMap() {
        return map;
    }

    private static final Multimap&lt;Integer, String&gt; NAMESPACE_NAMES = LinkedHashMultimap.create();


    public static boolean addNamespaces(Collection&lt;String&gt; namespaces, int order) {

        return NAMESPACE_NAMES.putAll(order,namespaces);
    }


    /**
     * Modify the application context's internal bean factory after its standard
     * initialization. All bean definitions will have been loaded, but no beans
     * will have been instantiated yet. This allows for overriding or adding
     * properties even to eager-initializing beans.
     */
    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {

        Object bean = beanFactory.getBean(&quot;noRegisterService&quot;);

        if (bean instanceof NoRegisterService) {
            NoRegisterService noRegisterService = (NoRegisterService) bean;
            noRegisterService.setValue(&quot;hhhhhhhhhhhhhhh&quot;);
        }


        System.out.println(&quot;==========PropertySourcesProcessor    postProcessBeanFactory=============&quot;);

        Collection&lt;String&gt; strings = NAMESPACE_NAMES.get(Ordered.LOWEST_PRECEDENCE);

        // namespace è¾“å‡º
        strings.forEach(e-&gt;{
//            System.out.println(&quot;namespace : &quot;+e);
        });

        // è·å–pro
        getPro(beanFactory);

        // è®¾ç½®é…ç½®å±æ€§ , å¯ä»¥ç›´æ¥è®¾ç½® å¯¹è±¡çš„å±æ€§  , ä¸ä¾é spring
        setPro(beanFactory);

        
        // åˆå§‹åŒ– bean , ç”¨å­˜åœ¨çš„source åˆå§‹åŒ–å¯¹è±¡
        initWithHivingSource();


        // å¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ª  source  , è¿™é‡Œæœ‰é—®é¢˜, å¥½å¤šsourceä¸å¯ä»¥ä½¿ç”¨ ,ä¼šå‡ºç°ä¸€å †é—®é¢˜
        initWittCustomSource();


        // åˆ¤æ–­ç±»å‹
        /**
         * {@link DefaultListableBeanFactory}  å­˜å‚¨äº†æ‰€æœ‰çš„å…ƒä¿¡æ¯  springçš„å¤§å®¶æ—æ‰€æœ‰å­˜å‚¨çš„ä¿¡æ¯ éƒ½åœ¨é‡Œé¢
         */
        if (beanFactory instanceof DefaultListableBeanFactory) {
            System.out.println(&quot;-----YES , is  DefaultListableBeanFactory--------&quot;);
        }

    }


    /**
     * åˆå§‹åŒ–
     * {@link OriginTrackedMapPropertySource} æ˜¯  application.properties çš„é»˜è®¤åŠ è½½é…ç½® ,å®ƒæ˜¯æœ€ä½ä¼˜å…ˆçº§ ,
     *
     * å…¶å®æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€ä¸ªè®¾ç½® ,å¯æƒœæ˜¯ç§æœ‰çš„ : {@link ConfigurationPropertySourcesPropertySource} å®ƒæ˜¯æœ€é«˜ä¼˜å…ˆçº§ , {name='configurationProperties'} ,ä½†æ˜¯äººå®¶æ˜¯ç§æœ‰çš„
     *
     *  {@link MapPropertySource}   {name='systemProperties'}
     *
     * // spring - boot
     *  OriginTrackedMapPropertySource {name='applicationConfig: [classpath:/application.properties]'}
     *
     *  // spring -cloud
     *  OriginTrackedMapPropertySource {name='applicationConfig: [classpath:/bootstrap.properties]'}
     */
    void initWithHivingSource(){

        System.out.println(&quot;--------initWithHivingSource-----------&quot;);

        PropertySource&lt;?&gt; applicationConfig = environment.getPropertySources().get(&quot;applicationConfig: [classpath:/application.properties]&quot;);

/*
        // è¿™ä¸ªä¼˜å…ˆçº§é«˜
        PropertySource&lt;?&gt; systemProperties = environment.getPropertySources().get(&quot;systemProperties&quot;);
        if (systemProperties instanceof MapPropertySource) {
            MapPropertySource propertySource = (MapPropertySource) systemProperties;
            propertySource.getSource().put(&quot;test.value&quot;, &quot;æˆ‘åˆæ”¹äº†&quot;);
        }*/


        // è¿™ä¸ªä¼˜å…ˆçº§ä½
        if (applicationConfig instanceof OriginTrackedMapPropertySource) {
            OriginTrackedMapPropertySource source = (OriginTrackedMapPropertySource) applicationConfig;
            source.getSource().put(&quot;test.value&quot;, &quot;333333333333&quot;);
        }
    }


    /**
     * å®šä¹‰è‡ªå·±çš„ source , è¿™é‡Œå¾ˆæœ‰ç‚¹å‘ , {@link PropertySource}ä¸èƒ½éšæ„çš„å®šä¹‰ ,
     * æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ {@link MapPropertySource} å¯ä»¥ä½¿ç”¨, æˆ‘ä½¿ç”¨ Apolloå¼€å‘çš„æ—¶å€™,
     * å‘ç° {@link CompositePropertySource} ä¸èƒ½ä½¿ç”¨
     */
    private void initWittCustomSource() {

        System.out.println(&quot;----------initWittCustomSource------------&quot;);

        // å­˜åœ¨æˆ‘ä»¬å°±ä¸æ“ä½œäº†
        if (environment.getPropertySources().contains(proName)) {
            //already initialized
            return ;
        }


        /**
         * åˆ›å»ºä¸€ä¸ª   {@link MapPropertySource}  è¿™ä¸ªå¯ä»¥ä¹ˆé—®é¢˜ ,ä½†æ˜¯å…¶ä»–çš„å´æœ‰é—®é¢˜ .
         * CompositePropertySource
         */
        // name æ˜¯è¿™ä¸ª mapçš„åå­— ---- , key æ˜¯è¿™ä¸ªmapçš„ å±æ€§ , è·Ÿname ä¹ˆè”ç³» ,
        // æ¯”å¦‚ test.key=key  å°±æ˜¯è¿™ä¹ˆç”¨ , ä¸éœ€è¦åŠ  proName.test.key=key

        MapPropertySource propertySource = new MapPropertySource(proName,map);

        map.put(&quot;test.value&quot;, &quot;æˆ‘æ¯”ä½ application.propertiesä¼˜å…ˆçº§é«˜&quot;);
        map.put(&quot;test.key&quot;, &quot;key&quot;);

        map.put(&quot;server.port&quot;, 8098);


        // è®¾ç½®ç¯å¢ƒ , å¯ä»¥éšæ„è®¾ç½®
        // environment.getPropertySources().addBefore(&quot;applicationConfig: [classpath:/application.properties]&quot;, propertySource);

        // è®¾ç½®ç¯å¢ƒ , sheç½®åœ¨ç¬¬ä¸€ä½
        environment.getPropertySources().addFirst(propertySource);
    }


    /**
     * è·å– bean çš„å…ƒä¿¡æ¯
     * {@link BeanDefinition}
     * @param beanFactory
     */
    private void getBeanDefinition(ConfigurableListableBeanFactory beanFactory) {
        // è·å–åå­—
        String[] definitionNames = beanFactory.getBeanDefinitionNames();

        for (String definitionName : definitionNames) {
            // é€šè¿‡åå­—è·å– definition
            BeanDefinition definition = beanFactory.getBeanDefinition(definitionName);
        }
    }




    /**
     * è¿‡æ»¤ bean çš„å­—æ®µ
     * @param beanFactory
     */
    private void filterBean(ConfigurableListableBeanFactory beanFactory) {
        String[] beanNames = beanFactory.getBeanDefinitionNames();
        for (String beanName : beanNames) {
            BeanDefinition definition = beanFactory.getBeanDefinition(beanName);
            StringValueResolver valueResolver = new StringValueResolver() {
                @Override
                public String resolveStringValue(String strVal) {
                    return strVal;
                }
            };
            BeanDefinitionVisitor visitor = new BeanDefinitionVisitor(valueResolver);
            // å¤„ç† bean çš„é…ç½®ä¿¡æ¯
            visitor.visitBeanDefinition(definition);
        }
    }



    /**
     * è®¾ç½®å±æ€§ , å·²çŸ¥ bean æ‰ç”¨
     * @param beanFactory
     */
    private void setPro(ConfigurableListableBeanFactory beanFactory) {

        AbstractBeanDefinition abstractBeanDefinition = (AbstractBeanDefinition) beanFactory.getBeanDefinition(&quot;calculateService&quot;);

        System.out.println(&quot;BeanFactoryPostProcessor  : setPro&quot;);

        MutablePropertyValues pv =  abstractBeanDefinition.getPropertyValues();

        pv.addPropertyValue(&quot;desc&quot;, &quot;Desc is changed from bean factory post processor&quot;);


        abstractBeanDefinition.setScope(BeanDefinition.SCOPE_SINGLETON);
    }



    /**
     * è·å–å±æ€§ , å·²çŸ¥ bean æ‰ç”¨
     * @param beanFactory
     */
    private void getPro(ConfigurableListableBeanFactory beanFactory) {
        BeanDefinition beanDefinition = beanFactory.getBeanDefinition(&quot;calculateService&quot;);
        System.out.println(&quot;BeanFactoryPostProcessor  : getPro&quot;);


        MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();
        PropertyValue[] propertyValues1 = propertyValues.getPropertyValues();

        for (PropertyValue propertyValue : propertyValues1) {
           //
        }
    }


    /**
     * è®¾ç½®ç¯å¢ƒå±æ€§   ä½ è¦çŸ¥é“ springç”±äºæ˜¯ å•ä¾‹å¯¹è±¡ , ä½ çš„ç§æœ‰æˆå‘˜å˜é‡çš„ æ”¹å˜ä¹Ÿä¼šæ”¹å˜æºå¯¹è±¡çš„.
     * @param environment
     */
    @Override
    public void setEnvironment(Environment environment) {
        System.out.println(&quot;==========PropertySourcesProcessor    setEnvironment=============&quot;);

        if (environment instanceof ConfigurableEnvironment) {
            this.environment = (ConfigurableEnvironment) environment;
        }
    }


    /**
     * è®¾ç½®ä¼˜å…ˆçº§ , ä¸ç®¡æœ€é«˜æœ€ä½éƒ½ä¼šåŠ è½½çš„
     * @return
     */
    @Override
    public int getOrder() {
        return Ordered.HIGHEST_PRECEDENCE;
    }

}

</code></pre>
<h3 id="2-å¯åŠ¨åä¿®æ”¹bean">2. å¯åŠ¨åä¿®æ”¹bean</h3>
<pre><code class="language-java">@Component
public class MyBeanPostProcessor implements BeanPostProcessor {

    // å®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥å®Œæ¯•ï¼Œåœ¨è°ƒç”¨æ˜¾ç¤ºçš„åˆå§‹åŒ–ä¹‹å‰å®Œæˆä¸€äº›å®šåˆ¶çš„åˆå§‹åŒ–ä»»åŠ¡
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {

        if (beanName.equals(&quot;calculateService&quot;)) {
            if (bean instanceof CalculateService) {
                System.out.println(&quot;==========MyBeanPostProcessor    postProcessBeforeInitialization=============&quot;);
                CalculateService bean1 = (CalculateService) bean;
                bean1.setDesc(&quot;MyBeanPostProcessor è®¾ç½®çš„å±æ€§&quot;);
            }
        }
        return bean;
    }


    //å®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–å®Œæ¯•æ—¶æ‰§è¡Œ 
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {

        if (beanName.equals(&quot;calculateService&quot;)) {
            if (bean instanceof CalculateService) {
                System.out.println(&quot;==========MyBeanPostProcessor    postProcessAfterInitialization=============&quot;);
            }
        }
        return bean;
    }
}

</code></pre>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-apollo%E5%AE%98%E6%96%B9%E4%BB%8B%E7%BB%8D">1. Apolloå®˜æ–¹ä»‹ç»</a>
<ul>
<li><a href="#1-%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84">1. åŸºæœ¬æ¶æ„</a></li>
<li><a href="#2%E5%92%8Cspring%E9%9B%86%E6%88%90%E7%9A%84%E5%8E%9F%E7%90%86">2.å’ŒSpringé›†æˆçš„åŸç†</a></li>
</ul>
</li>
<li><a href="#2-apollo-client-%E6%BA%90%E7%A0%81">2. Apollo-Client æºç </a>
<ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E5%9B%BE">é¡¹ç›®å›¾</a></li>
<li><a href="#%E6%95%B4%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF">æ•´ä¸ªè®¾è®¡æ€è·¯</a></li>
<li><a href="#1-apolloapplicationcontextinitializer">1. ApolloApplicationContextInitializer</a></li>
<li><a href="#2apolloautoconfiguration">2.ApolloAutoConfiguration</a></li>
<li><a href="#3-configpropertysourcesprocessor">3. ConfigPropertySourcesProcessor</a></li>
<li><a href="#4-propertysourcesprocessor">4. PropertySourcesProcessor</a></li>
<li><a href="#5-enableapolloconfig">5. @EnableApolloConfig</a></li>
<li><a href="#6-apolloconfigregistrar">6. ApolloConfigRegistrar</a></li>
</ul>
</li>
<li><a href="#3-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8">3. ç®€å•ä½¿ç”¨</a>
<ul>
<li><a href="#1-%E5%90%AF%E5%8A%A8%E6%97%B6%E4%B8%BAbean%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7">1. å¯åŠ¨æ—¶ä¸ºbeanè®¾ç½®å±æ€§</a></li>
<li><a href="#2-%E5%90%AF%E5%8A%A8%E5%90%8E%E4%BF%AE%E6%94%B9bean">2. å¯åŠ¨åä¿®æ”¹bean</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>