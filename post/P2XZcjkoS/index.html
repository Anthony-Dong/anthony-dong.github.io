<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Golang - Goroutine &amp; chan  &amp; contextåŒ… | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/P2XZcjkoS/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614224679162" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Golang - Goroutine &amp; chan  &amp; contextåŒ…</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-02-07</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/P2XZcjkoS/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/QVXCurowLbk/"
								class="tag">Golang</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">4221å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">21 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	<code>Goroutine</code>  å’Œ <code>chan</code> æ˜¯golangå¤šçº¿ç¨‹ç¼–ç¨‹çš„æ ¸å¿ƒ ,   contextæ˜¯ä¸Šä¸‹æ–‡, é“¾æ¥ç€ å¤šä¸ªgoroutine å’Œ å¤šä¸ªchan ,åŒæ—¶è¿˜å¯ä»¥ä¿å­˜ä¸Šä¸‹æ–‡æ•°æ®, æ‰€ä»¥ contextåŒ…ä¹Ÿå¾ˆé‡è¦, ä½¿ç”¨ä¹Ÿå¾ˆé‡è¦.</p>
</blockquote>
<h2 id="1-goroutine">1. Goroutine</h2>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œæ¯ä¸€ä¸ªå¹¶å‘çš„æ‰§è¡Œå•å…ƒå«ä½œä¸€ä¸ªgoroutineã€‚Javaä¸­å«åšThread ,å…¶å®æ˜¯ä¸€å›äº‹,å¤§å®¶å¯ä»¥è®¤ä¸ºgoå…³é”®å­—å’Œnew thread().start()  æ˜¯ä¸€ç›®ä¸€æ ·çš„æ•ˆæœæ¥è¯´.  æ‰€ä»¥ä»–æ˜¯å¤„ç†å¹¶å‘ç”¨çš„, ä»–çš„ç”Ÿå‘½å‘¨æœŸç”±Golangåº•å±‚ç®¡ç†.</p>
<pre><code class="language-go">func main() {
    // å¯åŠ¨ä¸€ä¸ªtcpç«¯å£
	listener, _ := net.Listen(&quot;tcp&quot;, &quot;localhost:8888&quot;)
	for {
        //å­¦è¿‡Javaæˆ–è€…å…¶ä»–è¯­è¨€çš„éƒ½çŸ¥é“ , ä¸€ä¸ªæ–°çš„è¿æ¥è¿‡æ¥å…¥å£å°±æ˜¯ä¸€ä¸ªaccept
		conn, _ := listener.Accept()
        // å¤„ç†æ–°è¿æ¥
		handlers(&amp;conn)
	}
}

func handlers(conn *net.Conn) {
    // å…¶å®è¿™ä¸ªæ–¹æ³•ä¸æ‰§è¡Œ, å› ä¸ºå°±ç®—å®¢æˆ·ç«¯æ–­äº†ä¹Ÿä¼šä¸æ–­çš„å†™çš„,å› ä¸ºä¸‹é¢æ˜¯ä¸ªæ­»å¾ªç¯..æ‰€ä»¥å…ˆä¸è€ƒè™‘è¿™ä¸ª,å¤„ç†çš„è¯ä¸€èˆ¬å¾—åšå¿ƒè·³å¤„ç†,æˆ–è€…conn.SetDeadline().
	defer (*conn).Close()
	for {
		io.WriteString(*conn, time.Now().Format(&quot;Mon Jan 2 15:04:05 -0700 MST 2006\n\r&quot;))
		time.Sleep(1 * time.Second)
	}
}
</code></pre>
<p>æ­¤æ—¶æˆ‘ä»¬åˆ†åˆ«ä¿©çª—å£å¼€å¯ <code>telnet localhost 8888</code>  , ä¼šå‘ç°åªä¼šæœ‰ä¸€ä¸ªè¿”å›æ•°æ®, å¦å¤–ä¸€ä¸ªé˜»å¡äº† ä¸ä¼šè¿”å›æ•°æ®, æ˜¯ä¸ºå•¥å‘¢,  Javaæ¥è¯´éƒ½æ˜¯å¼€å¯ä¸€ä¸ª<code>Thread</code>æ¥å¤„ç† handleræ–¹æ³•, è€ŒGolangæ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª <code>GoRoutine</code>,  å…¶å®ç›®çš„éƒ½æ˜¯ä¸€æ ·çš„, åŒºåˆ«ä¸è§£é‡Šäº†.</p>
<p>å› æ­¤æˆ‘ä»¬å°†ä»£ç æ”¹æˆ <code>go handlers(&amp;conn)</code>   , æ­¤æ—¶ä¿©çª—å£éƒ½æ”¶åˆ°æ•°æ®äº† , è¿™å°±æ˜¯ GoRoutine, å¯¹äºGolangæ¥è¯´,è¿™å°±æ˜¯ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹, å¯¹äºwebhttpæœåŠ¡å™¨è¿˜æ˜¯å…¶ä»–éƒ½æ˜¯è¿™ä¸ªæµç¨‹, ä¸ä¸€æ ·çš„è€Œæ˜¯ä¸åŒéœ€æ±‚å°è£…, å¯¹äºJavaæ¥è¯´ä»–å¯èƒ½æœ‰BIO,NIO,AIOç¼–ç¨‹æ¨¡å‹, å¯èƒ½goçš„å¼ºå¤§ä¸éœ€è¦å§,</p>
<p>å®¢æˆ·ç«¯ä»£ç ä¹Ÿå¾ˆç®€å•  , <code>dial</code>  æ„æ€å°±æ˜¯ <code>æ‹¨å·</code> .</p>
<pre><code class="language-go">func main() {
	conn, e := net.Dial(&quot;tcp&quot;, &quot;localhost:8888&quot;)
	if e != nil {
		fmt.Println(&quot;error&quot;)
		os.Exit(1)
	}
	defer func() {
		conn.Close()
		fmt.Println(&quot;å…³é—­è¿æ¥&quot;)
	}()
	out := os.Stdout
	io.Copy(out, conn)
}
</code></pre>
<p>è¿™å°±æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æœåŠ¡å™¨ , å¾ˆç®€å•, ä¸Šè¿°å°±æ˜¯ goroutineçš„ç®€å•ä½¿ç”¨, å¯¹äºå¤§é‡ä¸ç›¸å¹²çš„ä»»åŠ¡ , ä¸ºäº†æä¾›å¹¶å‘æ€§(æ‰§è¡Œæ•ˆç‡), æ‰€ä»¥ä½¿ç”¨goroutine æ˜¯å¾ˆä¸é”™çš„é€‰æ‹© , ä½†æ˜¯æœ‰äº›æ—¶å€™ goroutineä¹‹é—´éœ€è¦åè°ƒ, è¿™æ—¶å€™å°±éœ€è¦ contextäº†, ä¸‹æ–‡ä¼šè®²åˆ° .</p>
<h2 id="2-channels">2. Channels</h2>
<p>channleæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜»å¡é˜Ÿåˆ—, æ ¹æ®ä½ ç¼“å†²çš„å¤§å°å¯èƒ½å­˜åœ¨ å­˜é˜»å¡å’Œå–é˜»å¡ . å¦‚æœä½ å­¦è¿‡Javaçš„BlockingQueueå¾ˆåƒ ,   ä½†æ˜¯Golangä¼šæ£€æµ‹channelæ˜¯å¦å‘ç”Ÿæ­»é”, é˜²æ­¢å†™æ³•ä¸Šå‡ºç°é—®é¢˜.</p>
<p>chançš„æ“ä½œ  :</p>
<pre><code class="language-go">// 1. å®šä¹‰ , ä»£è¡¨è¿™ä¸ªchanç±»å‹ä¸ºint,åªèƒ½å­˜å…¥intç±»å‹æ•°æ®, ç¼“å†²åŒºä¸º0 , chæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡
ch :=make(chan int,0)
// 2. å­˜å…¥æ•°æ®. ç”¨ `&lt;-` è¡¨ç¤º , putæ“ä½œ. 
ch&lt;-1
// 3. è¯»å–æ•°æ®.  ç”¨ `&lt;-` è¡¨ç¤º , è¿”å›ä¿©å‚æ•°, ç¬¬ä¸€ä¸ªæ˜¯è¯»å–çš„æ•°æ®, ç¬¬äºŒä¸ªæ˜¯æˆåŠŸä¸å¦. takeæ“ä½œ. å¦‚æœåªå†™ä¸€ä¸ªæ˜¯ä»£è¡¨è¯»å–è¿”å›çš„æ•°æ®.
x,ok:=&lt;-ch
</code></pre>
<h3 id="æ— ç¼“å†²åŒºçš„chan">æ— ç¼“å†²åŒºçš„chan</h3>
<p>ç”³æ˜ <code>make(chan int)</code> , åé¢æ˜¯ç±»å‹, å°±æ˜¯æœ€å¤šæˆ‘åªèƒ½æ”¾ä¸€ä¸ª. ç±»ä¼¼äºJavaçš„SynchronizedBlockingQueue. æ˜¯ä¸€ä¸ªæ— ç¼“å†²åŒºçš„é˜Ÿåˆ— .</p>
<pre><code class="language-go">func main() {
	ch :=make(chan int,0)

	go func() {
		ch&lt;-1
	}()

	x,ok:=&lt;-ch
	fmt.Println(x,ok)
}
</code></pre>
<p>è¾“å‡º :</p>
<pre><code class="language-go">1 true
</code></pre>
<p>å…¶ä¸­å¯¹äºä¸»çº¿ç¨‹ , golangä¼šæ£€æµ‹chanä½¿ç”¨æ˜¯å¦åˆç†, ä¸ç„¶ä¼šæŠ›å‡º , <code>fatal error: all goroutines are asleep - deadlock!</code> ,æ¯”å¦‚å¯èƒ½å­˜åœ¨ä¸‹é¢çš„ä»£ç .</p>
<pre><code class="language-go">func main() {
	ch := make(chan int, 0)
	&lt;-ch
}
</code></pre>
<p>è¿™ä¸ªä¼šç›´æ¥æŠ›å‡ºä¸Šè¯‰å¼‚å¸¸, å› ä¸ºä¸åˆæ³•. ç®€ç§° <code>deadlock</code> , ä¸ºæ­»é”çš„æ„æ€ , ä»€ä¹ˆæ˜¯æ­»é” , å°±æ˜¯çº¿ç¨‹å¡ç€ä¸åŠ¨äº† , æ²¡æœ‰åŠæ³•æ‹¯æ•‘äº† ,ä½¿ç”¨chan åƒä¸‡è¦æ³¨æ„æ­»é”é—®é¢˜ , å°±ç®—close()æ‰chan, æŠ›å‡ºå¼‚å¸¸,ä¹Ÿä¸èƒ½å‘ç”Ÿæ­»é”(å­çº¿ç¨‹å‘ç”Ÿæ­»é”å¯èƒ½æ€§å¾ˆå¤§çš„) .  ä¸éš¾å‘ç°è¿™ç§æ£€æµ‹æ˜¯æœ‰å¿…è¦çš„, åœ¨ç¨‹åºå¯åŠ¨å‰åšæ£€æµ‹ , æ˜¯ä¸€ç§å¾ˆå¥½çš„ç¼–è¯‘ä¹ æƒ¯.</p>
<h3 id="å…·æœ‰ç¼“å†²åŒºçš„chan">å…·æœ‰ç¼“å†²åŒºçš„chan</h3>
<blockquote>
<p>â€‹	æœ‰ç¼“å†²åŒºçš„chan , ç±»ä¼¼äºJavaçš„ ArrayBlockingQueue.  éœ€è¦æŒ‡å®šä¸€ä¸ªé˜Ÿåˆ—å¤§å°,</p>
</blockquote>
<p>è¿™ä¸ªä»£ç , è®©å¤§å®¶ä½“ä¼šä¸€ä¸‹ chançš„ç¼“å†²åŒºçš„æ¦‚å¿µ. è¿™é‡Œä¼šå¾ªç¯6æ¬¡ , å‘é‡Œé¢æ·»åŠ æ•°æ®, å¦‚æœç¼“å†²åŒºå¤§å°è¿˜æœ‰, å°±ä¼šå­˜å…¥æˆåŠŸ. å¤±è´¥å°±ä¼šè‡ªåŠ¨èµ°default .</p>
<pre><code class="language-go">func main() {
	ch := make(chan int, 5)

	for x := 1; x &lt;= 6; x++ {
		select {
		case ch &lt;- x:
			fmt.Println(&quot;save success &quot;, x)
		default:
			fmt.Println(&quot;save error &quot;,x)
		}
	}
}
</code></pre>
<p>è¾“å‡º :  ç¡®å®æ˜¯ç¼“å†²åŒºå¤§å°åªæœ‰5 .</p>
<pre><code class="language-go">save success  1
save success  2
save success  3
save success  4
save success  5
save error  6
</code></pre>
<h3 id="åªè¯»-åªå†™chan">åªè¯» , åªå†™chan</h3>
<blockquote>
<p>â€‹	è¿™ä¸ªé¢—ç²’åº¦æ›´åŠ é«˜äº†, åªè¯»åªå†™chan.  ä¸€èˆ¬ç”¨æ¥ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’,  ä¸»è¦æ˜¯çœ‹ä¸€äº›æºç ä¼šå†™ä¸€äº› chan&lt;- ä¹‹ç±»çš„, ä¸å¥½ç†è§£. è¿™é‡Œè§£é‡Šä¸€ä¸‹.</p>
</blockquote>
<p>å®ä¾‹åŒ–ä¸€ä¸ªåªè¯»chan . åªè¯»chan,å¦‚æœç”¨åšå†™, ä¼šç›´æ¥ç¨‹åºé”™è¯¯,æ— æ³•ç¼–è¯‘çš„ . å…¶å®å¼€å‘å·¥å…·ä¼šæç¤ºçš„.</p>
<pre><code class="language-go">r:=make(&lt;-chan int)
</code></pre>
<p>å®ä¾‹åŒ–ä¸€ä¸ªåªå†™chan . , åªå†™chan ,å¦‚æœç”¨åšè¯», ä¼šç›´æ¥ç¨‹åºé”™è¯¯,æ— æ³•ç¼–è¯‘çš„</p>
<pre><code class="language-go">w:=make(chan&lt;- int)
</code></pre>
<p>å…¶å®è¿™ä¿© r , w éƒ½æ˜¯ <code>make(chan int)</code> çš„å­ç±», æ‰€ä»¥ä¸å¿…è¦æ‹…å¿ƒ, å‡ºç°é—®é¢˜.</p>
<p>æˆ‘ä»¬ç®€å•çš„ä½¿ç”¨ä¸€ä¸‹.</p>
<pre><code class="language-go">func main() {
    // 1.åˆ›å»ºä¸€ä¸ªch
	ch := make(chan interface{}, 10)
	// 2.å¼€å¯ä¸€ä¸ªgoroutineæ‰§è¡Œreceive
	go func() {
		receive(ch)
	}()
    // 3. å‘é€
	send(ch)
	time.Sleep(time.Second)
}
func receive(read &lt;-chan interface{}) {
	for {
		r := &lt;-read
		fmt.Println(&quot;receive : &quot;, r)
	}
}

func send(write chan&lt;- interface{}) {
	for x := 1; x &lt; 10; x++ {
		write &lt;- x
	}
}
</code></pre>
<p>è¾“å‡º  :</p>
<pre><code class="language-go">receive :  1
...
receive :  9
</code></pre>
<h3 id="å…³é—­-chan">å…³é—­ chan</h3>
<p>æœ‰äº›æƒ…å†µä¸‹éœ€è¦å…³é—­ chan  , é‚£å°±æ¶‰åŠåˆ° chan çš„çŠ¶æ€äº† , è¿™é‡Œæ˜¯å‡ ä¸ªçŠ¶æ€é‡.  <code>æ‰€ä»¥ä¸€èˆ¬åœ¨å†™å…¥(ä¹Ÿå°±æ˜¯senderä¸­)çš„goroutineä¸­æ‰§è¡Œ close æ“ä½œ.</code>  , å…³é—­chan , åªæ˜¯ä¸ºäº†GCçš„æ›´å¥½çš„å›æ”¶.</p>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/20fe4b2d-6a33-449a-be68-8e43406f6147.jpg?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>å…¶å®æŸ¥çœ‹closeçš„æ–¹æ³•. ä¹Ÿæ˜¯æ¨è åªå†™chan</p>
<pre><code class="language-go">func close(c chan&lt;- Type)
</code></pre>
<p>å¦‚ä½•å…³é—­chan .</p>
<pre><code class="language-go">func main() {
	ch := make(chan interface{})

	close(ch)
}
</code></pre>
<p>æ³¨æ„ç‚¹</p>
<blockquote>
<p>closeæ²¡æœ‰makeçš„chanä¼šå¼•èµ·panic , ä¹Ÿå°±æ˜¯è¿›ç¨‹ç›´æ¥é€€å‡º . åœ¨ä½ æ²¡æœ‰æŠ“å–å¼‚å¸¸çš„æƒ…å†µä¸‹.</p>
<p>closeä»¥åä¸èƒ½å†å†™å…¥ï¼Œå†™å…¥ä¼šå‡ºç°panic</p>
<p><strong>closeä¹‹åå¯ä»¥è¯»å–æ•°æ®, å¦‚æœæ²¡æœ‰æ•°æ® ï¼Œåˆ™è¿”å› nil,false</strong></p>
<p>é‡å¤closeä¼šå¼•èµ·panic , çœ‹æƒ…å†µè¦ä¸è¦æŠ“å–.</p>
<p>åªè¯»chanä¸èƒ½close</p>
<p>ä¸æ‰‹åŠ¨	close chanä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå½“æ²¡æœ‰è¢«å¼•ç”¨æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨åƒåœ¾å›æ”¶ã€‚</p>
</blockquote>
<h3 id="select-case-è¯­æ³•">select ... case  è¯­æ³•</h3>
<p>ç®€å•ä½¿ç”¨ :</p>
<pre><code class="language-go">func main() {
	ch1 := make(chan int64)
	ch2 := make(chan int64)
	start := time.Now().UnixNano() / 1e6
	go func() {
		time.Sleep(time.Millisecond * 500)
		ch1 &lt;- time.Now().Unix()
	}()
	go func() {
		time.Sleep(time.Millisecond * 300)
		ch2 &lt;- time.Now().Unix()
	}()

	select {
	case x := &lt;-ch1:
		fmt.Printf(&quot;wait %dms , receive : %d.&quot;, time.Now().UnixNano()/1e6-start, x)
	case x := &lt;-ch2:
		fmt.Printf(&quot;wait %dms , receive : %d.&quot;, time.Now().UnixNano()/1e6-start, x)
	}
}
</code></pre>
<p>è¾“å‡º :</p>
<pre><code class="language-go">wait 301ms , receive : 1581084448.
Process finished with exit code 0
</code></pre>
<p>å¯¹äº : ä¸‹é¢è¿™ä¸ªè¯­å¥ , <strong>ä»–ä¼šä¸æ–­çš„æ‰§è¡Œä¸‹é¢çš„è¯­å¥ä¸€ å’Œ è¯­å¥äºŒ(å¯èƒ½æ˜¯ä¸ªæ–¹æ³•è¿”å›çš„chan, ä¹Ÿå¯èƒ½æ˜¯ä¸ªchan) , ç›´åˆ°æ»¡è¶³putæˆåŠŸæˆ–è€…tackæˆåŠŸ , ä¸ç„¶ä¸æ–­çš„è½®è¯¢</strong>. å½“éƒ½æˆåŠŸå¯ä»¥ä»–ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œ.</p>
<pre><code class="language-go">select {
	case è¯­å¥ä¸€:
    	..
    case è¯­å¥äºŒ:
    	..
}
</code></pre>
<p>ç„¶åå°±æ˜¯ä»– è¿˜æœ‰ä¸€ä¸ª defaultå…³é”®å­—.  è¿™ä¸ªå…³é”®å­—å‘¢ , ä»–ä¼šæ‰§è¡Œå‰ä¿©ä¸ª , å¦‚æœä¿©éƒ½å¤±è´¥, é‚£ä¹ˆç›´æ¥æ‰§è¡Œdefaulté€€å‡ºselectè¯­å¥.</p>
<pre><code class="language-go">select {
	case è¯­å¥ä¸€:
    	..
    case è¯­å¥äºŒ:
    	..
    default:
		...
}
</code></pre>
<h3 id="ç®€å•çš„ä½¿ç”¨chan">ç®€å•çš„ä½¿ç”¨chan</h3>
<blockquote>
<p>â€‹	å¦‚æœæˆ‘ä»¬å­¦äº†chan , ä¸å­¦ä»¥è‡´ç”¨, é‚£ä¹ˆå°±å¾ˆæ‰¯æ·¡ , å­¦äº†ä¸ç”¨å­¦äº†åˆæœ‰å•¥ç”¨</p>
<p>â€‹	è¿™ä¸ªdemo . æ˜¯æˆ‘å†™çš„ä¸€ä¸ªç®€å•çš„ä¾‹å­, æ¯”å¦‚ä¸€ä¸ªè¯·æ±‚, éœ€è¦å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥åˆ°æ•°æ®åº“ä¸­, åŒæ—¶è¿˜è¦åé¦ˆå›ç”¨æˆ·ä¸€äº›ä¿¡æ¯ , æ¯”å¦‚æ´»åŠ¨ä¿¡ä¹‹ç±»çš„, æ‰€ä»¥è¿™ä¿©ä¸å†²çª, å¯ä»¥å¼‚æ­¥æ‰§è¡Œ.</p>
</blockquote>
<pre><code class="language-go">// 1.æŸ¥è¯¢æœåŠ¡
func Query(str string) []string {
	time.Sleep(time.Second * 2)
	return strings.Split(str, &quot;.&quot;)
}
// 2.ä¿å­˜çš„æ•°æ®åº“
func SaveUser() {
	time.Sleep(time.Second * 2)
}
// 2. UseræœåŠ¡
func UserServer(str string) []string {
    // 1.åˆ›å»ºä¸€ä¸ªchan
	ch := make(chan []string)
    // 2. æœ€åå…³é—­, é‡Šæ”¾èµ„æº
    defer close(ch)
    // 3. å¼‚æ­¥æŸ¥è¯¢
	go func() {
		ch &lt;- Query(str)
	}()
    // ç„¶åæˆ‘ä»¬çš„å¤„ç†é€»è¾‘, 
    SaveUser()
    // å¤„ç†å®Œè¿”å›.
	return &lt;-ch
}

func main() {
	start := time.Now().UnixNano() / 1e6
	res := UserServer(&quot;hello.world.!&quot;)
	fmt.Printf(&quot;è€—æ—¶ %dms , æŸ¥è¯¢ç»“æœ : %v.\n&quot;,time.Now().UnixNano()/1e6-start, res)
}
</code></pre>
<p>è¾“å‡º :</p>
<pre><code class="language-go">è€—æ—¶ 2001ms , æŸ¥è¯¢ç»“æœ : [hello world !].
</code></pre>
<p>â€‹	æˆ‘ä»¬å‘ç°ä¸Šè¯‰çš„é—®é¢˜åœ¨å“ª, å¦‚æœæˆ‘æŸ¥è¯¢æ—¶é—´ç‰¹åˆ«é•¿, æ¯”å¦‚ 10m , 20m , éƒ½æ²¡æœ‰è¿”å› . ç”¨æˆ·ä½“éªŒå¥½å—.  æ˜¾ç„¶ä¸å¯æ§çš„ä¸œè¥¿æ˜¯ç¨‹åºç¦æ­¢çš„ ,è¿™æ—¶å€™å°±éœ€è¦ä¼Ÿå¤§çš„<code>contextåŒ…</code>äº†. ä¸‹é¢æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹è¿™ä¸ªåŒ….</p>
<h2 id="3-contextåŒ…">3. contextåŒ…</h2>
<blockquote>
<p>â€‹	<code>context.Context</code>è¿™ä¸ªæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡, ä»–æ˜¯ä¸€ä¸ªé“¾è¡¨å½¢å¼, æœ‰rootèŠ‚ç‚¹, æ ¹èŠ‚ç‚¹ä¸€èˆ¬æ˜¯è®©golangç»™æˆ‘ä»¬æ§åˆ¶çš„, æˆ‘ä»¬åªéœ€è¦å­èŠ‚ç‚¹.  å¯¹äºå¿«é€Ÿå¤±è´¥, ä¹Ÿæ˜¯æ ¹èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹ä¸æ–­å¤±è´¥.</p>
<p>â€‹	contextåŒ… æä¾›äº†å¯¹<code>context.Context</code>çš„æ“ä½œ.</p>
</blockquote>
<h4 id="contextbackground"><code>context.Background()</code></h4>
<pre><code class="language-go">// Background returns a non-nil, empty Context. It is never canceled, has no
// values, and has no deadline. It is typically used by the main function,
// initialization, and tests, and as the top-level Context for incoming
// requests.
func Background() Context {
	return background
}
</code></pre>
<p>ä»–æ˜¯ä¸€ä¸ªæ ¹èŠ‚ç‚¹, å…¶å®å°±æ˜¯ä¸€ä¸ª <code>as the top-level Context</code> , æ‡‚äº†å§ .  ä¸æ¨èè‡ªå·±ä¼ å…¥ä¸€ä¸ªtop-level context.</p>
<h4 id="contextwithtimeout"><code>context.WithTimeout()</code></h4>
<p>æ˜¯åˆ›å»ºä¸€ä¸ª è¶…æ—¶çš„ctx , å½“è¶…æ—¶ä»–çš„ <code>&lt;-ctx.Done()</code> ä¼šè¿”å›ä¸€ä¸ªç©ºæ•°æ®.</p>
<pre><code class="language-go">func main() {
	// ctxæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„å®ç°äº†context.Contextæ¥å£çš„å˜é‡
	ctx, cancel := context.WithTimeout(context.Background(), time.Second*2)
	defer cancel()

	select {
	case &lt;-ctx.Done():
		fmt.Println(&quot;waiting 2 seconds&quot;)
	}
}
// 2såè¾“å‡º : 
// waiting 2 seconds
</code></pre>
<h4 id="contextwithdeadline"><code>context.WithDeadline()</code></h4>
<p>å…¶å®ä¸Šé¢é‚£ä¸ª <code>context.WithTimeout()</code> å…¶å®å°±æ˜¯ <code>time.Now().Add(timeout)</code> , å½“å‰æ—¶é—´åŠ ä¸Šä¸€ä¸ªtimeout , æ‰€ä»¥è¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£.</p>
<pre><code class="language-go">func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {
	return WithDeadline(parent, time.Now().Add(timeout))
}
</code></pre>
<h4 id="contextwithcancel"><code>context.WithCancel()</code></h4>
<p>è¿™ä¸ªå°±æ˜¯æ ¹æ®ä½ çš„è¿›ç¨‹é€€å‡ºä¸å¦ ,å†³å®šçš„, å…¶å®å°±æ˜¯ä½ è°ƒç”¨äº† <code>cancel()</code> æ–¹æ³• , ä¼šå›é€€. å¹¶ä¸æ˜¯ä¸Šé¢é‚£ç§æ ¹æ®æ—¶é—´æ¥æ§åˆ¶ , è¿™ä¸ªæ˜¯æ ¹æ®ä½ æ‰§è¡Œcancelæ–¹æ³•æ¥æ§åˆ¶, æˆ‘ä»¬ç®€å•çš„ä½¿ç”¨ä¸€ä¸‹. å¤§å®¶ä½“ä¼šä¸€ä¸‹.</p>
<pre><code class="language-go">import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;
)
func main() {
	gen := func(ctx context.Context) &lt;-chan int {
		dst := make(chan int)
		n := 1
		go func() {
			for {
				select {
				case &lt;-ctx.Done():
					fmt.Printf(&quot;down&quot;)
					return // returning not to leak the goroutine
				case dst &lt;- n:
					n++
				}
			}
		}()
		return dst
	}

	ctx, cancel := context.WithCancel(context.Background())
	defer func() {
		fmt.Println(&quot;cancel&quot;)
		cancel() // cancel when we are finished consuming integers
		time.Sleep(time.Second)
	}()

	for n := range gen(ctx) {
		fmt.Println(n)
		if n == 5 {
			break
		}
	}
}
</code></pre>
<p>æ¯”å¦‚è¿™ä¸ªä»£ç , æˆ‘ä»¬çœ‹çœ‹è¾“å‡º :</p>
<pre><code class="language-go">1
2
3
4
5
cancel // ç”±äºforæ‰§è¡Œå®Œæ¯•. æ‰€ä»¥ä¸»ç¨‹åºæ‰§è¡Œäº†cancelæ–¹æ³•
down // ç„¶åæˆ‘ä»¬å»¶è¿Ÿäº†1sç§, ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œ.
</code></pre>
<h4 id="contextwithvalue"><code>context.WithValue()</code></h4>
<p>è¿™ä¸ªå°±æ˜¯åœ¨contextä¸Šä¸‹æ–‡ä¸­ä¼ é€’å¯¹è±¡æ•°æ®çš„.  ç„¶åè¿”å›ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å¯¹è±¡.  æ‰€ä»¥å°±æ˜¯ä¸€ä¸ªå­˜å‚¨æ•°æ®çš„ä¸œè¥¿. ä»–å¯ä»¥å­˜å‚¨å¤šä¸ªkvæ•°æ®  . å¹¶ä¸èƒ½åªå­˜ä¸€ä¸ª.</p>
<pre><code class="language-go">import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;
)

func main() {
	// è¿™ä¸ªå†™æ³•æ¯”è¾ƒå¥½ . ä¸æ–­çš„èµ‹å€¼è¿™ä¸ªæŒ‡é’ˆå˜é‡
	var ctx context.Context
	var cancel context.CancelFunc

	ctx, cancel = context.WithTimeout(context.Background(), time.Second*2)
	defer cancel()

	ctx = context.WithValue(ctx, &quot;k1&quot;, &quot;v1&quot;)
	ctx = context.WithValue(ctx, &quot;k2&quot;, &quot;v2&quot;)
	
	fmt.Printf(&quot;k1 : %s\n&quot;, ctx.Value(&quot;k1&quot;).(string))
	fmt.Printf(&quot;k1 : %s\n&quot;, ctx.Value(&quot;k2&quot;).(string))

	select {
	case &lt;-ctx.Done():
		fmt.Println(&quot;waiting 2 seconds&quot;)
	}
}
</code></pre>
<p>è¾“å‡º   :</p>
<pre><code class="language-go">k1 : v1
k1 : v2
waiting 2 seconds
</code></pre>
<h4 id="cancel-æ–¹æ³•"><code>cancel()</code> æ–¹æ³•</h4>
<blockquote>
<p>â€‹	ä»–ä¼šä»ä¸Šåˆ°ä¸‹è°ƒç”¨ .  æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆçœ‹çœ‹</p>
</blockquote>
<pre><code class="language-go">func main() {
	var ctx context.Context
	var cancel context.CancelFunc

	ctx, cancel = context.WithTimeout(context.Background(), time.Second*2)
	defer func() {
		cancel()
		time.Sleep(time.Second)
	}()
	go func() {
		select {
		case &lt;-ctx.Done():
			fmt.Println(&quot;ctx 1 Done&quot;)
		}
	}()

	ctx = context.WithValue(ctx, &quot;k1&quot;, &quot;v1&quot;)
	go func() {
		select {
		case &lt;-ctx.Done():
			fmt.Println(&quot;ctx 2 Done&quot;)
		}
	}()

	ctx = context.WithValue(ctx, &quot;k2&quot;, &quot;v2&quot;)
	go func() {
		select {
		case &lt;-ctx.Done():
			fmt.Println(&quot;ctx 3 Done&quot;)
		}
	}()
}
</code></pre>
<p>è¾“å‡º :  æ‰€ä»¥å°±æ˜¯ä»ä½åˆ°ä¸Š cancel.  (ä»ä¸‹åˆ°ä¸Š)</p>
<pre><code class="language-go">ctx 3 Done
ctx 2 Done
ctx 1 Done
</code></pre>
<p>å¯¹äºä»¥ä¸ŠåŸºæœ¬å°±æ˜¯ golangçš„æ ¸å¿ƒäº† .</p>
<h3 id="è§£å†³æˆ‘ä»¬çš„é—®é¢˜">è§£å†³æˆ‘ä»¬çš„é—®é¢˜ .</h3>
<blockquote>
<p>â€‹	è¿™é‡Œå…¶å®è¿˜æœ‰ä¸€ä¸ªé—®é¢˜, æ— æ³•ä¸­æ–­queryæ‰§è¡Œ.  æˆ–è€…å°±æ˜¯æ— æ³•ç»ˆç«¯goroutineæ‰§è¡Œ.</p>
</blockquote>
<pre><code class="language-go">// 1.æŸ¥è¯¢æœåŠ¡
func Query(str string, ch chan&lt;- []string) {
	time.Sleep(time.Second * 3)
	ch &lt;- strings.Split(str, &quot;.&quot;)
}

// 2.ä¿å­˜çš„æ•°æ®åº“
func SaveUser() {
	time.Sleep(time.Second * 2)
}

// 2. UseræœåŠ¡
func UserServer(str string) ([]string, error) {
	// 1.åˆ›å»ºä¸€ä¸ªchan , æœ‰ä¸€ä¸ªç¼“å†²åŒºçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢æŸ¥è¯¢æœåŠ¡å‘ç”Ÿæ­»é”, æ¯”å¦‚è¯´æˆ‘ä»¬è¶…æ—¶äº†,é‚£ä¹ˆQueryæˆåŠŸæ­»é”
	ch := make(chan []string,1)
	// 2. æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬ä¿å­˜çš„æ—¶é—´æ˜¯ 2s, æ‰€ä»¥æˆ‘ä»¬å…è®¸ç­‰å¾…æœ€é•¿æ—¶é—´ä¸º2s
	ctx, cancel := context.WithTimeout(context.Background(), time.Second*2)
	defer cancel()
	go func() {
		// æ‰§è¡Œquery æ˜¯æ— æ³•ä¸­æ–­çš„, æ‰€ä»¥è¿™é‡Œåªèƒ½ç­‰å¾…æ‰§è¡Œå®Œæ¯•
		Query(str, ch)
	}()
	// ä¿å­˜
	SaveUser()
	select {
	case &lt;-ctx.Done():
		return nil, ctx.Err()
	case rest := &lt;-ch:
		return rest, nil
	}
}
func main() {
	start := time.Now().UnixNano() / 1e6
	res, e := UserServer(&quot;hello.world.!&quot;)
	if e != nil {
		fmt.Println(e, time.Now().UnixNano()/1e6-start, &quot;ms&quot;)
	} else {
		fmt.Printf(&quot;è€—æ—¶ %dms , æŸ¥è¯¢ç»“æœ : %v.\n&quot;, time.Now().UnixNano()/1e6-start, res)
	}
}
</code></pre>
<h3 id="googleå®˜æ–‡å®ä¾‹ä»£ç ">Googleå®˜æ–‡å®ä¾‹ä»£ç . .</h3>
<p><code>com.test/context_example/main.go</code> æ–‡ä»¶ä»£ç </p>
<pre><code class="language-go">import (
	&quot;com.test/context_example/google&quot;
	&quot;com.test/context_example/userip&quot;
	&quot;context&quot;
	&quot;html/template&quot;
	&quot;log&quot;
	&quot;net/http&quot;
	&quot;time&quot;
)

func main() {
	http.HandleFunc(&quot;/search&quot;, handleSearch)
	log.Fatal(http.ListenAndServe(&quot;:8080&quot;, nil))
}

// handleSearch handles URLs like /search?q=golang&amp;timeout=1s by forwarding the
// query to google.Search. If the query param includes timeout, the search is
// canceled after that duration elapses.
func handleSearch(w http.ResponseWriter, req *http.Request) {
	// ctx is the Context for this handler. Calling cancel closes the
	// ctx.Done channel, which is the cancellation signal for requests
	// started by this handler.
	var (
		ctx    context.Context
		cancel context.CancelFunc
	)
	timeout, err := time.ParseDuration(req.FormValue(&quot;timeout&quot;))
	if err == nil {
		// The request has a timeout, so create a context that is
		// canceled automatically when the timeout expires.
		ctx, cancel = context.WithTimeout(context.Background(), timeout)
	} else {
		ctx, cancel = context.WithCancel(context.Background())
	}
	defer cancel() // Cancel ctx as soon as handleSearch returns.

	// Check the search query.
	query := req.FormValue(&quot;q&quot;)
	if query == &quot;&quot; {
		http.Error(w, &quot;no query&quot;, http.StatusBadRequest)
		return
	}

	// Store the user IP in ctx for use by code in other packages.
	userIP, err := userip.FromRequest(req)
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}
	ctx = userip.NewContext(ctx, userIP)

	// Run the Google search and print the results.
	start := time.Now()
	results, err := google.Search(ctx, query)
	elapsed := time.Since(start)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	if err := resultsTemplate.Execute(w, struct {
		Results          google.Results
		Timeout, Elapsed time.Duration
	}{
		Results: results,
		Timeout: timeout,
		Elapsed: elapsed,
	}); err != nil {
		log.Print(err)
		return
	}
}

var resultsTemplate = template.Must(template.New(&quot;results&quot;).Parse(`
&lt;html&gt;
&lt;head/&gt;
&lt;body&gt;
  &lt;ol&gt;
  {{range .Results}}
    &lt;li&gt;{{.Title}} - &lt;a href=&quot;{{.URL}}&quot;&gt;{{.URL}}&lt;/a&gt;&lt;/li&gt;
  {{end}}
  &lt;/ol&gt;
  &lt;p&gt;{{len .Results}} results in {{.Elapsed}}; timeout {{.Timeout}}&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
`))
</code></pre>
<p><code>com.test/context_example/userip/query.go</code>æ–‡ä»¶</p>
<pre><code class="language-go">package userip

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;net&quot;
	&quot;net/http&quot;
)

// FromRequest extracts the user IP address from req, if present.
func FromRequest(req *http.Request) (net.IP, error) {
	ip, _, err := net.SplitHostPort(req.RemoteAddr)
	if err != nil {
		return nil, fmt.Errorf(&quot;userip: %q is not IP:port&quot;, req.RemoteAddr)
	}

	userIP := net.ParseIP(ip)
	if userIP == nil {
		return nil, fmt.Errorf(&quot;userip: %q is not IP:port&quot;, req.RemoteAddr)
	}
	return userIP, nil
}

// The key type is unexported to prevent collisions with context keys defined in
// other packages.
type key int

// userIPkey is the context key for the user IP address.  Its value of zero is
// arbitrary.  If this package defined other context keys, they would have
// different integer values.
const userIPKey key = 0

// NewContext returns a new Context carrying userIP.
func NewContext(ctx context.Context, userIP net.IP) context.Context {
	return context.WithValue(ctx, userIPKey, userIP)
}

// FromContext extracts the user IP address from ctx, if present.
func FromContext(ctx context.Context) (net.IP, bool) {
	// ctx.Value returns nil if ctx has no value for the key;
	// the net.IP type assertion returns ok=false for nil.
	userIP, ok := ctx.Value(userIPKey).(net.IP)
	return userIP, ok
}
</code></pre>
<p><code>com.test/context_example/google/search.go</code>  æ–‡ä»¶ä»£ç </p>
<pre><code class="language-go">package google

import (
	&quot;com.test/context_example/userip&quot;
	&quot;context&quot;
	&quot;encoding/json&quot;
	&quot;net/http&quot;
)

// Results is an ordered list of search results.
type Results []Result

// A Result contains the title and URL of a search result.
type Result struct {
	Title, URL string
}

// Search sends query to Google search and returns the results.
func Search(ctx context.Context, query string) (Results, error) {
	// Prepare the Google Search API request.
	req, err := http.NewRequest(&quot;GET&quot;, &quot;https://ajax.googleapis.com/ajax/services/search/web?v=1.0&quot;, nil)
	if err != nil {
		return nil, err
	}
	q := req.URL.Query()
	q.Set(&quot;q&quot;, query)

	// If ctx is carrying the user IP address, forward it to the server.
	// Google APIs use the user IP to distinguish server-initiated requests
	// from end-user requests.
	if userIP, ok := userip.FromContext(ctx); ok {
		q.Set(&quot;userip&quot;, userIP.String())
	}
	req.URL.RawQuery = q.Encode()

	// Issue the HTTP request and handle the response. The httpDo function
	// cancels the request if ctx.Done is closed.
	var results Results
	err = httpDo(ctx, req, func(resp *http.Response, err error) error {
		if err != nil {
			return err
		}
		defer resp.Body.Close()

		// Parse the JSON search result.
		// https://developers.google.com/web-search/docs/#fonje
		var data struct {
			ResponseData struct {
				Results []struct {
					TitleNoFormatting string
					URL               string
				}
			}
		}
		if err := json.NewDecoder(resp.Body).Decode(&amp;data); err != nil {
			return err
		}
		for _, res := range data.ResponseData.Results {
			results = append(results, Result{Title: res.TitleNoFormatting, URL: res.URL})
		}
		return nil
	})
	// httpDo waits for the closure we provided to return, so it's safe to
	// read results here.
	return results, err
}

// httpDo issues the HTTP request and calls f with the response. If ctx.Done is
// closed while the request or f is running, httpDo cancels the request, waits
// for f to exit, and returns ctx.Err. Otherwise, httpDo returns f's error.
func httpDo(ctx context.Context, req *http.Request, f func(*http.Response, error) error) error {
	// Run the HTTP request in a goroutine and pass the response to f.
	c := make(chan error, 1)
	req = req.WithContext(ctx)

	go func() {
		c &lt;- f(http.DefaultClient.Do(req))
		}()
	select {
	case &lt;-ctx.Done():
		&lt;-c // Wait for f to return.
		return ctx.Err()
	case err := &lt;-c:
		return err
	}
}
</code></pre>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-goroutine">1. Goroutine</a></li>
<li><a href="#2-channels">2. Channels</a>
<ul>
<li><a href="#%E6%97%A0%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84chan">æ— ç¼“å†²åŒºçš„chan</a></li>
<li><a href="#%E5%85%B7%E6%9C%89%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84chan">å…·æœ‰ç¼“å†²åŒºçš„chan</a></li>
<li><a href="#%E5%8F%AA%E8%AF%BB-%E5%8F%AA%E5%86%99chan">åªè¯» , åªå†™chan</a></li>
<li><a href="#%E5%85%B3%E9%97%AD-chan">å…³é—­ chan</a></li>
<li><a href="#select-case-%E8%AF%AD%E6%B3%95">select ... case  è¯­æ³•</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E7%9A%84%E4%BD%BF%E7%94%A8chan">ç®€å•çš„ä½¿ç”¨chan</a></li>
</ul>
</li>
<li><a href="#3-context%E5%8C%85">3. contextåŒ…</a><br>
*
<ul>
<li><a href="#contextbackground"><code>context.Background()</code></a></li>
<li><a href="#contextwithtimeout"><code>context.WithTimeout()</code></a></li>
<li><a href="#contextwithdeadline"><code>context.WithDeadline()</code></a></li>
<li><a href="#contextwithcancel"><code>context.WithCancel()</code></a></li>
<li><a href="#contextwithvalue"><code>context.WithValue()</code></a></li>
<li><a href="#cancel-%E6%96%B9%E6%B3%95"><code>cancel()</code> æ–¹æ³•</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%88%91%E4%BB%AC%E7%9A%84%E9%97%AE%E9%A2%98">è§£å†³æˆ‘ä»¬çš„é—®é¢˜ .</a></li>
<li><a href="#google%E5%AE%98%E6%96%87%E5%AE%9E%E4%BE%8B%E4%BB%A3%E7%A0%81">Googleå®˜æ–‡å®ä¾‹ä»£ç . .</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			// for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
			// 	n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
			// 	for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
			// 		n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
			// 	}
			// }
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:fanhaodong516@gmail.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.github.io ,Github:https://github.com/Anthony-Dong ,Email:fanhaodong516@gmail.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>