<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="shortcut icon"href="https://anthony-dong.github.io/favicon.ico"type="image/x-icon"/><meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="apple-mobile-web-app-capable"content="yes"/><meta name="apple-mobile-web-app-status-bar-style"content="black"/><meta name="format-detection"content="telephone=no"/><meta name="renderer"content="webkit"/><meta name="description"content="Anthony-Dongçš„ä¸ªäººåšå®¢"/><meta charset="UTF-8"/><title>Quartzæ¡†æ¶è®¾è®¡ä»¥åŠåŸç† | Anthony-Dong</title><link href="https://anthony-dong.github.io/styles/main.css"type="text/css"rel="stylesheet"/><script src="https://anthony-dong.github.io/media/js/magnify.min.js"></script>
	<link rel="canonical" href="https://anthony-dong.github.io/post/yaoZolVYC/" />
</head>
<body>
	<div class="progress"></div><style>.progress{background:linear-gradient(to right,#87ceeb var(--scroll),transparent 0);background-repeat:no-repeat;position:fixed;width:100%;height:4px;z-index:1}</style><div class="darkmode-background"></div><div class="darkmode-layer"></div>
<noscript><p class="warn" >æœ¬é¡µé¢éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå¯ç”¨ï¼‰JavaScript</p></noscript><div class="header"><div class="logo_title"><div class="title animated fadeInDown"><a href="https://anthony-dong.github.io"><img alt="logo" style="display:inline-block;" src="https://anthony-dong.github.io/images/avatar.png"/></a><h1 title="Anthony-Dong" class="weaklink shift"><a  href="/">Anthony-Dong</a></h1>

<div class="navbar weaklink">
<div class="normal_nav">
<div class="bitcron_nav_container"><div class="bitcron_nav"><div class="bitcron_nav"><div style="display:flex;justify-content:center;"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul></nav>
<div style="float:right;margin-top:1em"><form id="gridea-search-form" data-update="1578893743252" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="Search..."></form></div>
<div style="margin-left:0.5em;margin-top:1.2em"><input id="switch_default" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
<div class="clear clear_nav_inline_end"></div></div></div><div class="clear clear_nav_end"></div></div></div><div class="hamberger" href="javascript:void(0)" onclick="btn_toggle();"><i class="iconfont icon-category"></i></div></div></div></div>
<div id="hn" class="no-js hidden_nav animated fadeInDown"><div class="bitcron_nav_container"><div class="bitcron_nav"><nav class="mixed_site_nav_wrap site_nav_wrap"><ul class="mixed_site_nav site_nav sm sm-base">	<li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >é¦–é¡µ</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >å½’æ¡£</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >æ ‡ç­¾</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >å…³äº</a></li><li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/link" class="selected active current nav__item" >å‹é“¾</a></li></ul><div class="clear clear_nav_inline_end"></div></nav></div><div class="clear clear_nav_end"></div></div>
<div style="display:flex;justify-content:center;inline-block;text-align:center;margin-top:7%"><div><form id="gridea-search-form-1" data-update="1614223342286" action="/search/index.html"><input class="search-input" autocomplete="off" spellcheck="false" name="q"  placeholder="Search..." /></form></div><div style="margin-left:0.5em"><input id="switch_default_h" onclick="mobileBtn()" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div>
</div></div>
<script>function enableDarkmode(){document.body.classList.add("darkmode"),document.getElementById("switch_default").checked=1,document.getElementById("switch_default_h").checked=1}function removeDarkmode(){document.body.classList.remove("darkmode"),document.getElementById("switch_default").checked=0,document.getElementById("switch_default_h").checked=0}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}cookie=getCookie("darkmode"),"enable"==cookie&&enableDarkmode(),window.matchMedia("(prefers-color-scheme: dark)").matches&&"disable"!==cookie&&(enableDarkmode(),document.cookie="darkmode=enable; path=/");var mobileBtn=function(){1==document.getElementById("switch_default").checked?(enableDarkmode(),document.cookie="darkmode=enable; path=/"):(removeDarkmode(),document.cookie="darkmode=disable; path=/")};</script>

	<div class="main">
		<div class="main-inner">
			<div class="content">
				<article class="post">
					<script src='https://anthony-dong.github.io/media/js/Valine.min.js'></script><style>.v .vlist .vcard .vh .vmeta .vat{font-size:.8125em;color:#9d7873;cursor:pointer;float:right}.v .vlist .vcard .vhead .vsys{display:none}</style ><script type="text/javascript">new Valine(ValineInfo)</script>
					<h2 class="post_title sm_margin"><a>Quartzæ¡†æ¶è®¾è®¡ä»¥åŠåŸç†</a></h2>
					<script>
						function lan() {
							if (document.getElementById("lan").innerText == "ç¹") {
								var s = document.getElementById("tongwenlet_cn");
								if (s != null) {
									document.body.removeChild(s)
								}
								var s = document.createElement("script");
								s.language = "javascript";
								s.type = "text/javascript";
								s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_tw.js";
								s.id = "tongwenlet_cn";
								document.body.appendChild(s);
								document.getElementById("lan").innerHTML = "ç®€"
							} else {
								if (document.getElementById("lan").innerText == "ç°¡") {
									var s = document.getElementById("tongwenlet_cn");
									if (s != null) {
										document.body.removeChild(s)
									}
									var s = document.createElement("script");
									s.language = "javascript";
									s.type = "text/javascript";
									s.src = "https://cdn.jsdelivr.net/gh/qyxtim/Static@1.1/bookmarklet_cn.js";
									s.id = "tongwenlet_cn";
									document.body.appendChild(s);
									document.getElementById("lan").innerHTML = "ç¹"
								}
							}
						};
					</script>
					<section class="post_details"><i class="iconfont icon-calendar"></i><span style="margin-right:15px">
							2020-01-23</span><i class="iconfont icon-browse"></i>
							<span class="leancloud_visitors" style="margin-right:15px" id="/post/yaoZolVYC/">views <i class="leancloud-visitors-count" style="font-style: normal"></i></span>
							<span class="weaklink" style="margin-right:15px"><i class="iconfont icon-category"></i> <a
								href="https://anthony-dong.github.io/tag/tKL7bR-rqBr/"
								class="tag">Quartz</a></span><i class="iconfont icon-caret-down"></i><span
							style="margin-right:15px">3365å­—</span><i
							class="iconfont icon-naozhong"></i><span
							style="margin-right:15px">17 min read</span><a id="lan"
							href="javascript:void(0);" onclick="lan();" title="è°ƒæ•´ç®€ç¹ä½“" style="margin-right:15px;">ç¹</a>
						</section>

						<div style="display:flex">
							<div class="md_block" id="md_block">
								<div class="round-shape-one"></div>
								<blockquote>
<p>â€‹	å‰é¢8èŠ‚éƒ½æ˜¯è¿™ä¸ªæ¡†æ¶çš„å‡ ä¸ªç»„ä»¶ , ç¬¬9èŠ‚è®²çš„æ˜¯å…¨éƒ¨æ‰§è¡Œæµç¨‹,æœ€åä¸€èŠ‚å°±æ˜¯æ€»ç»“äº† .  å¸Œæœ›æœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹ , æå‡ä¸€ä¸‹è‡ªå·± , ä¸éš¾</p>
</blockquote>
<h2 id="1-schedulerfactory">1. SchedulerFactory</h2>
<figure data-type="image" tabindex="1"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/4b2e500b-d6da-463c-99ef-f7499908073e.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<p>æœ‰ä¿©å®ç°ç±», å‰é¢ä¸€èŠ‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯StanderScheduleFactory , å…¶å®å¯¹äºå¿«é€Ÿä½¿ç”¨çš„è¯, DirectScheduleFactory æ¯”è¾ƒå¥½ç”¨ .</p>
<p>å¯åŠ¨ :</p>
<pre><code class="language-java">// ç›´æ¥é»˜è®¤å¯åŠ¨
Scheduler scheduler = StdSchedulerFactory.getDefaultScheduler();

// æˆ–è€…æ‰‹åŠ¨æ³¨å…¥é…ç½®
Properties properties = new Properties();
properties.setProperty(&quot;org.quartz.scheduler.instanceName&quot;, &quot;MyScheduler&quot;);
properties.setProperty(&quot;org.quartz.threadPool.threadCount&quot;, &quot;4&quot;);
properties.setProperty(&quot;org.quartz.jobStore.class&quot;, &quot;org.quartz.simpl.RAMJobStore&quot;);
StdSchedulerFactory factory = new StdSchedulerFactory(properties);
Scheduler scheduler = factory.getScheduler();

// 3. ç³»ç»Ÿä¼ å‚,æŒ‡å®šé…ç½®æ–‡ä»¶ä½ç½® : org.quartz.properties=quartz.properties

//4. ç›´æ¥ä¸ç”¨ä¼ å‚ ,åœ¨Classpathä¸‹é¢å»ºç«‹ä¸€ä¸ª quartz.propertiesæ–‡ä»¶å°±è¡Œäº†. 
</code></pre>
<p>åšäº†ä»€ä¹ˆ ?  é…ç½®å’‹åŠ è½½è¿›å»çš„, å…¶å®å°±åœ¨è¿™é‡Œ <code>org.quartz.impl.StdSchedulerFactory#getDefaultScheduler</code></p>
<p>ä»–é‡Œé¢å®ä¾‹åŒ–äº†ä¸€å † properties , å…·ä½“å®ç°,æˆ‘çœŸçš„è§‰å¾—ä¹ˆå†™, ä»£ç å¤ªç®€å• äº† . ä»–ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°, æ‰€ä»¥ä¸æ€•å› ä¸ºé…ç½®ä¸å†™, å°±å¯åŠ¨é”™è¯¯. æˆ–è€…ä½ ç›´æ¥æ„é€ æ–¹æ³•ä¼ å…¥é…ç½®ä¹Ÿè¡Œ .</p>
<pre><code class="language-java">public static Scheduler getDefaultScheduler() throws SchedulerException {
    StdSchedulerFactory fact = new StdSchedulerFactory();
    return fact.getScheduler();
}
</code></pre>
<p>å¯¹äº <code>org.quartz.impl.StdSchedulerFactory#instantiate()</code> æ–¹æ³•æ¯”è¾ƒæ ¸å¿ƒ  è·å– Scheduleræ ¸å¿ƒæ–¹æ³• ä»£ç æœ‰ä¸Šåƒè¡Œ,ä¸å±•ç¤ºäº† , ä¸»è¦ç›®çš„å°±æ˜¯ åˆå§‹åŒ–ä¸€å †çš„ä¸œè¥¿ , å°è£…ä¸€å †çš„ä¸œè¥¿</p>
<p>ä¸»è¦å°±æ˜¯ä¸‹é¢è¿™å‡ ä¸ª</p>
<pre><code class="language-java">JobStore js = null;
ThreadPool tp = null;
QuartzScheduler qs = null;
DBConnectionManager dbMgr = null;
</code></pre>
<p>è¿™å››ä¸ªéƒ½æœ‰å…±åŒçš„ç‰¹ç‚¹,</p>
<ul>
<li>ç¬¬ä¸€ propertiesæ³¨å…¥å…¨éƒ¨é‡‡ç”¨çš„æ˜¯ setæ–¹æ³•åå°„æ³¨å…¥ , <code>org.quartz.impl.StdSchedulerFactory#setBeanProps</code> è¿™ä¸ªæ–¹æ³•é‡Œ, ä¼šsetæ³¨å…¥è¿›å».</li>
<li>ç¬¬äºŒ å…¨éƒ¨åˆå§‹åŒ–éƒ½æ˜¯ initializeæ–¹æ³•</li>
</ul>
<h2 id="2-jobstore">2. JobStore</h2>
<blockquote>
<p>â€‹	The interface to be implemented by classes that want to provide a Job and Trigger storage mechanism for the org.quartz.core.QuartzScheduler's use.</p>
<p>Storage of Job s and Trigger s should be keyed on the combination of their name and group for uniqueness.</p>
<p>è§£é‡Šå¾ˆæ¸…æ¥š : æä¾› <strong>a Job and Trigger</strong> å­˜å‚¨çš„ç»™QuartzScheduler's ä½¿ç”¨. åŒæ—¶Job s and Triggerçš„keyåº”è¯¥æ˜¯ç‹¬ä¸€æ— äºŒçš„.</p>
</blockquote>
<p><code>org.quartz.spi.JobStore</code> å¾ˆæ˜¾ç„¶å°±æ˜¯å­˜å‚¨æˆ‘ä»¬Jobçš„ä¸œè¥¿, æˆ‘ä»¬å¦‚æœè‡ªå·±ä¸å»å‘Šè¯‰ä»–ç”¨å“ªä¸ª, é»˜è®¤å®ç°çš„æ˜¯ <code>org.quartz.simpl.RAMJobStore</code></p>
<p>ä¸€ä¸ªåŸºäºå†…å­˜çš„å­˜å‚¨, å¾ˆç®€å•ä¸€å †é›†åˆåŒ…ä½å°±è¡Œäº† .  ä¸»è¦æ³¨æ„çš„æ˜¯ ä»–ä¼šå°†<code>Job</code> åŒ…è£…ä¸€ä¸‹ç§°ä¸º <code>JobWrapper</code></p>
<p>ä¸»è¦æ˜¯æ”¯æŒ ä¸‰ç§å­˜å‚¨é…ç½®  :</p>
<ul>
<li>RAM (ç›´æ¥JVMè¿›ç¨‹çš„)</li>
<li>terracotta  (Terracottaæ˜¯ä¸€æ¬¾ç”±ç¾å›½Terracottaå…¬å¸å¼€å‘çš„è‘—åå¼€æº<a href="https://baike.baidu.com/item/Java/85979">Java</a>é›†ç¾¤å¹³å°ã€‚)</li>
<li>JDBC  (MySQL ä¹‹ç±»çš„ ....)</li>
</ul>
<h2 id="3-threadpool">3. ThreadPool</h2>
<blockquote>
<p>The interface to be implemented by classes that want to provide a thread pool for the org.quartz.core.QuartzScheduler's use.</p>
<p>ThreadPool implementation instances should ideally be made for the sole use of Quartz. Most importantly, when the method blockForAvailableThreads() returns a value of 1 or greater, there must still be at least one available thread in the pool when the method runInThread(Runnable) is called a few moments (or many moments) later. If this assumption does not hold true, it may result in extra JobStore queries and updates, and if clustering features are being used, it may result in greater imballance of load.</p>
</blockquote>
<h2 id="4-quartzschedulerresources">4. QuartzSchedulerResources</h2>
<p>è¿™ä¸ªå°±æ˜¯æ•´ä¸ªQuartz çš„æ ¸å¿ƒèµ„æº, æ‰€æœ‰èµ„æºéƒ½åœ¨è¿™é‡Œ.</p>
<h2 id="5-quartzscheduler">5. QuartzScheduler</h2>
<p>æ•´ä¸ªæ¡†æ¶çš„å¿ƒè„ ....</p>
<blockquote>
<p>â€‹	This is the heart of Quartz, an indirect implementation of the Scheduler interface, containing methods to schedule Jobs, register JobListener instances, etc.</p>
<p>â€‹	æ˜¯ quartzçš„æ ¸å¿ƒ, åŒ…å«è°ƒç”¨jobçš„æ–¹æ³•, æ³¨å†Œlistener</p>
</blockquote>
<p>æ„é€ å™¨  , æ‰€ä»¥æŠŠæ ¸å¿ƒèµ„æº <code>QuartzSchedulerResources</code> ä¹Ÿç»™<code>QuartzScheduler</code>äº†</p>
<pre><code class="language-java">public QuartzScheduler(QuartzSchedulerResources resources, long idleWaitTime, @Deprecated long dbRetryInterval){....}
</code></pre>
<h4 id="quartzschedulerresources">QuartzSchedulerResources</h4>
<blockquote>
<p>â€‹	Contains all of the resources (JobStore,ThreadPool, etc.) necessary to create a QuartzScheduler instance.</p>
<p>â€‹	resources èµ„æºç®¡ç†å™¨, åŒ…å«jobå’Œçº¿ç¨‹æ± </p>
</blockquote>
<h4 id="idlewaittime">idleWaitTime</h4>
<blockquote>
<p>â€‹	 When the scheduler finds there is no current trigger to fire, how long  it should wait until checking again...</p>
<p>â€‹	å°±æ˜¯ç­‰å¾…å®ç°, è¿™ä¸ªæ˜¯ä¸ªæ­»å¾ªç¯, å¦‚æœç­‰å¾…æ—¶é—´è¿‡çŸ­, ä¼šç©ºè½¬å¾ˆå¿«, æ‰€ä»¥å°±æ˜¯è¿™ä¸ªæ„æ€, é»˜è®¤æ˜¯ 30S</p>
</blockquote>
<h4 id="dbretryinterval">dbRetryInterval</h4>
<p><code>deprecated</code> åºŸå¼ƒäº†, æ‰€ä»¥å°±æ˜¯äº¤ç»™åˆ«äººç®¡ç†äº† ,</p>
<p>ä¸»è¦å®ç° : å°±ä»–è‡ªå·±....</p>
<figure data-type="image" tabindex="2"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/b7f6a352-f78d-4c66-a1b6-7f7ebee08bed.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h2 id="6-dbconnectionmanager">6. DBConnectionManager</h2>
<blockquote>
<p>â€‹	Manages a collection of ConnectionProviders, and provides transparent access to their connections.</p>
<p>ç®¡ç† ConnectionProviders , æä¾›é€æ˜çš„è¿æ¥è®¿é—® .</p>
</blockquote>
<p>å…¶å®ä»–å°±æ˜¯</p>
<p>JobStore -&gt; DBConnectionManager -&gt; ConnectionProviders  , è¿™ä¸ªå¯ä»¥è¯´æ˜¯æ¡¥æ¥æ¨¡å¼. æœ‰ä¸€ä¸ªç®¡ç†è€…ç®¡ç†è¿æ¥çš„æä¾›è€…, ç„¶åJobStore å¯ä»¥é€šè¿‡ä»–è·å–è¿æ¥.</p>
<h2 id="7-joblistener-å’Œ-triggerlistener">7. JobListener å’Œ  TriggerListener</h2>
<p>é¦–å…ˆä¸€ç‚¹å°±æ˜¯ è¿™äº›éƒ½æ˜¯ <code>ListenerManager</code> è¿›è¡Œç®¡ç†çš„ , ä»–çš„å®ç°ç±»æ—¶ <code>ListenerManagerImpl</code></p>
<p>æˆ‘ä»¬çœ‹çœ‹  JobListener</p>
<blockquote>
<p>â€‹	The interface to be implemented by classes that want to be informed when a JobDetail executes. In general, applications that use a Scheduler will not have use for this mechanism.</p>
<p>â€‹	a JobDetail executes.ä¼šé€šçŸ¥ä½  , é€šå¸¸ä½¿ç”¨Schedulerçš„åº”ç”¨æ˜¯ä¸ä¼šä½¿ç”¨è¿™ä¸ªlistenerçš„</p>
</blockquote>
<pre><code class="language-java">public interface JobListener {
    String getName();

    // Jobè°ƒç”¨å‰
    void jobToBeExecuted(JobExecutionContext context);

    // veto å¦å†³çš„æ„æ€ , ç”± org.quartz.TriggerListener#vetoJobExecution å†³å®š
    void jobExecutionVetoed(JobExecutionContext context);

    // Jobè°ƒç”¨å
    void jobWasExecuted(JobExecutionContext context,
            JobExecutionException jobException);
}
</code></pre>
<pre><code class="language-java">public interface TriggerListener {

    String getName();

    // è§¦å‘Trigger
    void triggerFired(Trigger trigger, JobExecutionContext context);

    // ç¦æ­¢æ‰§è¡ŒJobExecution
    boolean vetoJobExecution(Trigger trigger, JobExecutionContext context);

    // triggerMisfired
    void triggerMisfired(Trigger trigger);

    void triggerComplete(Trigger trigger, JobExecutionContext context,
            CompletedExecutionInstruction triggerInstructionCode);

}
</code></pre>
<p>æ‰§è¡Œæµç¨‹å°±æ˜¯ä¸‹é¢çš„ .</p>
<p>triggerFired  -&gt;</p>
<p>â€‹						vetoJobExecution ? false    -&gt; 	jobToBeExecuted - &gt; è°ƒç”¨Jobæ¥å£ä¸­çš„æ–¹æ³• - &gt; jobWasExecuted</p>
<p>â€‹													 ? true     -&gt;     jobExecutionVetoed</p>
<p>â€‹</p>
<p>ä½¿ç”¨å¾ˆç®€å• å®ç°ä¿©æ¥å£å°±è¡Œäº†,</p>
<pre><code class="language-java">org.quartz.jobListener.j1.class=com.example.springquartz.MyJobListener
// æ¯”å¦‚å±æ€§è®¾ç½®å¯ä»¥è¿™ä¹ˆåš, åªè¦å®ç°setæ–¹æ³•å°±å¯ä»¥
// org.quartz.jobListener.l1.name=MyJobListener

org.quartz.triggerListener.t1.class=com.example.springquartz.MyTriggerListener
</code></pre>
<h2 id="8-scheduler">8. Scheduler</h2>
<blockquote>
<p>â€‹	This is the main interface of a Quartz Scheduler.</p>
<p>è¿™ä¸ªæ˜¯ ä¸€ä¸ªQuartz Schedulerçš„ä¸»æ¥å£ , å¯¹å¤–æš´éœ²çš„å”¯ä¸€æ¥å£, å¯ä»¥æ“ä½œæ‰€æœ‰èµ„æºå¯¹è±¡.  ä¸»è¦åŸå› è¿˜æ˜¯ä»–é‡Œé¢åŒ…å«äº† <code>QuartzScheduler</code> , æ‰€ä»¥å¯ä»¥æ“ä½œå…¶ä»–å¯¹è±¡.</p>
</blockquote>
<p>æˆ‘ä»¬ä¸€èˆ¬æ˜¯ <code>StdSchedule</code></p>
<p>ä¸»è¦å®ç° :</p>
<figure data-type="image" tabindex="3"><img src="https://tyut.oss-accelerate.aliyuncs.com/image/2020-10-11/3a70fb1f-0eaa-40e4-a6cf-f678cc654344.png?x-oss-process=style/template01" alt="" loading="lazy"></figure>
<h2 id="9-æ ¸å¿ƒè¿ä½œæµç¨‹">9.  æ ¸å¿ƒè¿ä½œæµç¨‹ .</h2>
<p><code>QuartzSchedulerResources</code> æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ”¾è¿›å»äº†</p>
<p><code>org.quartz.core.QuartzScheduler#QuartzScheduler</code>  æ˜¯æ‰§è¡Œçš„ä»»åŠ¡çš„æ ¸å¿ƒ , å°±æ˜¯å¿ƒè„ .  ç„¶åäº¤ç»™äº† -&gt; <code>QuartzSchedulerThread</code> è½®è¯¢å¤„ç†</p>
<pre><code class="language-java">public QuartzScheduler(QuartzSchedulerResources resources, long idleWaitTime, @Deprecated long dbRetryInterval)
    throws SchedulerException {
    this.resources = resources;
    if (resources.getJobStore() instanceof JobListener) {
        addInternalJobListener((JobListener)resources.getJobStore());
    }

    // æ ¸å¿ƒå¤„ç†çº¿ç¨‹ - &gt; è¿™ä¸ªå°±æ˜¯æ•´ä¸ªå¿ƒè„ 
    this.schedThread = new QuartzSchedulerThread(this, resources);
    ThreadExecutor schedThreadExecutor = resources.getThreadExecutor();
    // å¿ƒè„å¯åŠ¨ 
    schedThreadExecutor.execute(this.schedThread);
    if (idleWaitTime &gt; 0) {
        this.schedThread.setIdleWaitTime(idleWaitTime);
    }

    jobMgr = new ExecutingJobsManager();
    addInternalJobListener(jobMgr);
    errLogger = new ErrorLogger();
    addInternalSchedulerListener(errLogger);

    signaler = new SchedulerSignalerImpl(this, this.schedThread);

    getLog().info(&quot;Quartz Scheduler v.&quot; + getVersion() + &quot; created.&quot;);
}
</code></pre>
<p><code>org.quartz.core.QuartzSchedulerThread#run</code> -&gt;  è¿™é‡Œæè¿°æ˜¯ <code>The main processing loop of the QuartzSchedulerThread.</code></p>
<p>æˆ‘ä¹Ÿä¸æ¸…æ¥šæ˜¯åšå•¥çš„ , ä½†æ˜¯ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†Jobçš„ , å°è£…Job</p>
<pre><code class="language-java">@Override
public void run() {
    int acquiresFailed = 0;

    while (!halted.get()) {
        try {
            // å› ä¸ºæå‰å¼€å¯äº† , æ‰€ä»¥éœ€è¦ç­‰å¾…çœŸæ­£å¯åŠ¨äº†- &gt; è°ƒç”¨start, æ‰èƒ½ç»§ç»­æ‰§è¡Œ. pausedæš‚åœ.åœ¨
            // org.quartz.core.QuartzScheduler#startæ‰§è¡Œ. 
            // check if we're supposed to pause...
            synchronized (sigLock) {
                while (paused &amp;&amp; !halted.get()) {
                    try {
                        // wait until togglePause(false) is called...
                        sigLock.wait(1000L);
                    } catch (InterruptedException ignore) {
                    }

                    // reset failure counter when paused, so that we don't
                    // wait again after unpausing
                    acquiresFailed = 0;
                }

                if (halted.get()) {
                    break;
                }
            }

            // wait a bit, if reading from job store is consistently
            // failing (e.g. DB is down or restarting)..
            if (acquiresFailed &gt; 1) {
                try {
                    long delay = computeDelayForRepeatedErrors(qsRsrcs.getJobStore(), acquiresFailed);
                    Thread.sleep(delay);
                } catch (Exception ignore) {
                }
            }

            // è¿™é‡Œæ˜¯è·å–æ­£åœ¨ç­‰å¾…çš„ThreadPoolä¸­çš„çº¿ç¨‹ . å¦‚æœæœ‰æ‰§è¡Œ,ä½ è¦çŸ¥é“`QuartzSchedulerResources` æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ”¾è¿›å»äº†
            int availThreadCount = qsRsrcs.getThreadPool().blockForAvailableThreads();
            if(availThreadCount &gt; 0) { // will always be true, due to semantics of blockForAvailableThreads...

                // è·å–å½“å‰æ—¶åˆ»çš„triggers
                List&lt;OperableTrigger&gt; triggers;

                long now = System.currentTimeMillis();

                clearSignaledSchedulingChange();
                try {
                    triggers = qsRsrcs.getJobStore().acquireNextTriggers(
                            now + idleWaitTime, Math.min(availThreadCount, qsRsrcs.getMaxBatchSize()), qsRsrcs.getBatchTimeWindow());
                    acquiresFailed = 0;
                    if (log.isDebugEnabled())
                        log.debug(&quot;batch acquisition of &quot; + (triggers == null ? 0 : triggers.size()) + &quot; triggers&quot;);
                } catch (JobPersistenceException jpe) {
                    if (acquiresFailed == 0) {
                        // æ‰“å°æ—¥å¿—
                        qs.notifySchedulerListenersError(
                            &quot;An error occurred while scanning for the next triggers to fire.&quot;,
                            jpe);
                    }
                    if (acquiresFailed &lt; Integer.MAX_VALUE)
                        acquiresFailed++;
                    continue;
                } catch (RuntimeException e) {
                    if (acquiresFailed == 0) {
                        getLog().error(&quot;quartzSchedulerThreadLoop: RuntimeException &quot;
                                +e.getMessage(), e);
                    }
                    if (acquiresFailed &lt; Integer.MAX_VALUE)
                        acquiresFailed++;
                    continue;
                }

                // è¿™é‡Œå°±æ˜¯å¦‚æœæœ‰triggersç»§ç»­æ‰§è¡Œ
                if (triggers != null &amp;&amp; !triggers.isEmpty()) {
                    now = System.currentTimeMillis();
                    long triggerTime = triggers.get(0).getNextFireTime().getTime();
                    long timeUntilTrigger = triggerTime - now;
                    // è¿™ä¸ªå¤„ç†æ¯”è¾ƒçµæ€§.. æ­»å¾ªç¯, ä½ å·®å¤šä¹…, æˆ‘å°± waitå¤šä¹…
                    while(timeUntilTrigger &gt; 2) {
                        synchronized (sigLock) {
                            if (halted.get()) {
                                break;
                            }
                            if (!isCandidateNewTimeEarlierWithinReason(triggerTime, false)) {
                                try {
                                    // wait
                                    // we could have blocked a long while
                                    // on 'synchronize', so we must recompute
                                    now = System.currentTimeMillis();
                                    timeUntilTrigger = triggerTime - now;
                                    if(timeUntilTrigger &gt;= 1)
                                        sigLock.wait(timeUntilTrigger);
                                } catch (InterruptedException ignore) {
                                }
                            }
                        }
                        if(releaseIfScheduleChangedSignificantly(triggers, triggerTime)) {
                            break;
                        }
                        now = System.currentTimeMillis();
                        timeUntilTrigger = triggerTime - now;
                    }

                    // this happens if releaseIfScheduleChangedSignificantly decided to release triggers
                    // é˜²æ­¢å…¶ä»–å‘ç”Ÿ
                    if(triggers.isEmpty())
                        continue;

                    // åˆå§‹åŒ–ä¸€ä¸ª TriggerFiredResult
                    // set triggers to 'executing'
                    List&lt;TriggerFiredResult&gt; bndles = new ArrayList&lt;TriggerFiredResult&gt;();

                    boolean goAhead = true;
                    synchronized(sigLock) {
                        goAhead = !halted.get();
                    }
                    if(goAhead) {
                        try {
                            List&lt;TriggerFiredResult&gt; res = qsRsrcs.getJobStore().triggersFired(triggers);
                            if(res != null)
                                bndles = res;
                        } catch (SchedulerException se) {
                            qs.notifySchedulerListenersError(
                                    &quot;An error occurred while firing triggers '&quot;
                                            + triggers + &quot;'&quot;, se);
                            //QTZ-179 : a problem occurred interacting with the triggers from the db
                            //we release them and loop again
                            for (int i = 0; i &lt; triggers.size(); i++) {
                                qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));
                            }
                            continue;
                        }

                    }

                    // å¾ªç¯æ‰§è¡Œ
                    for (int i = 0; i &lt; bndles.size(); i++) {
                        // 
                        TriggerFiredResult result =  bndles.get(i);
                        TriggerFiredBundle bndle =  result.getTriggerFiredBundle();
                        Exception exception = result.getException();

                        if (exception instanceof RuntimeException) {
                            getLog().error(&quot;RuntimeException while firing trigger &quot; + triggers.get(i), exception);
                            qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));
                            continue;
                        }

                        // it's possible to get 'null' if the triggers was paused,
                        // blocked, or other similar occurrences that prevent it being
                        // fired at this time...  or if the scheduler was shutdown (halted)
                        if (bndle == null) {
                            qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));
                            continue;
                        }

                        // åˆå§‹åŒ–ä»»åŠ¡ 
                        JobRunShell shell = null;
                        try {
                            // åˆå§‹åŒ–æµç¨‹
                            shell = qsRsrcs.getJobRunShellFactory().createJobRunShell(bndle);
                            shell.initialize(qs);
                        } catch (SchedulerException se) {
                            qsRsrcs.getJobStore().triggeredJobComplete(triggers.get(i), bndle.getJobDetail(), CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_ERROR);
                            continue;
                        }

                        // è¿™é‡Œå°±æ˜¯ä»»åŠ¡æ‰§è¡Œäº†. ... è¿™é‡Œå°±æ¶‰åŠåˆ° -&gt; `org.quartz.simpl.SimpleThreadPool.WorkerThread#run()` è¿™é‡Œäº†
                        if (qsRsrcs.getThreadPool().runInThread(shell) == false) {
                            // this case should never happen, as it is indicative of the
                            // scheduler being shutdown or a bug in the thread pool or
                            // a thread pool being used concurrently - which the docs
                            // say not to do...
                            getLog().error(&quot;ThreadPool.runInThread() return false!&quot;);
                            qsRsrcs.getJobStore().triggeredJobComplete(triggers.get(i), bndle.getJobDetail(), CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_ERROR);
                        }

                    }

                    continue; // while (!halted)
                }
            } else { // if(availThreadCount &gt; 0)
                // should never happen, if threadPool.blockForAvailableThreads() follows contract
                continue; // while (!halted)
            }

            long now = System.currentTimeMillis();
            long waitTime = now + getRandomizedIdleWaitTime();
            long timeUntilContinue = waitTime - now;
            synchronized(sigLock) {
                try {
                  if(!halted.get()) {
                    // QTZ-336 A job might have been completed in the mean time and we might have
                    // missed the scheduled changed signal by not waiting for the notify() yet
                    // Check that before waiting for too long in case this very job needs to be
                    // scheduled very soon
                    if (!isScheduleChanged()) {
                      sigLock.wait(timeUntilContinue);
                    }
                  }
                } catch (InterruptedException ignore) {
                }
            }

        } catch(RuntimeException re) {
            getLog().error(&quot;Runtime error occurred in main trigger firing loop.&quot;, re);
        }
    } // while (!halted)

    // drop references to scheduler stuff to aid garbage collection...
    qs = null;
    qsRsrcs = null;
}
</code></pre>
<p>è¿™ä¸ªæ˜¯å¯åŠ¨å™¨, æˆ‘ä»¬çŸ¥é“å¯åŠ¨å¿…é¡»æ‰§è¡Œä¸€ä¸ª Thread.start , æ‰€ä»¥ä¸å‡ºæ„å¤–, ä¸Šé¢è¿™ä¸ªçº¿ç¨‹ä»–ç»å¯¹æ˜¯å®ˆæŠ¤çº¿ç¨‹, æ‰€æœ‰éƒ½æ˜¯, å› ä¸ºæˆ‘ä»¬startåä¸é˜»å¡, ç›´æ¥GG , JVMé€€å‡º.</p>
<p><code>org.quartz.core.QuartzScheduler#start</code>  -&gt; è¿™é‡Œå¼€å§‹. æ ¸å¿ƒæ˜¯ <code>schedThread.togglePause(false)</code> ,</p>
<pre><code class="language-java">public void start() throws SchedulerException {
    if (shuttingDown|| closed) {
        throw new SchedulerException(
                &quot;The Scheduler cannot be restarted after shutdown() has been called.&quot;);
    }

    // QTZ-212 : calling new schedulerStarting() method on the listeners
    // right after entering start()
    notifySchedulerListenersStarting();

    if (initialStart == null) {
        initialStart = new Date();
        this.resources.getJobStore().schedulerStarted();            
        startPlugins();
    } else {
        resources.getJobStore().schedulerResumed();
    }

    // è¿™é‡Œè®¾ç½®çš„ç›®çš„å°±æ˜¯å°†å®ƒç»§ç»­æ‰§è¡Œ -&gt; `org.quartz.core.QuartzSchedulerThread#run`252å–æ¶ˆæš‚åœ.
    schedThread.togglePause(false);

    getLog().info(
            &quot;Scheduler &quot; + resources.getUniqueIdentifier() + &quot; started.&quot;);

    notifySchedulerListenersStarted();
}
</code></pre>
<p>è°ƒç”¨  <code>qsRsrcs.getThreadPool().runInThread(shell)</code> -&gt;  è°ƒç”¨ <code>org.quartz.simpl.SimpleThreadPool#runInThread</code> -&gt; è¿™ä¸ªç„¶åä¸‹é¢</p>
<pre><code class="language-java">public boolean runInThread(Runnable runnable) {
    if (runnable == null) {
        return false;
    }

    synchronized (nextRunnableLock) {

        handoffPending = true;

        // Wait until a worker thread is available , è¿™é‡Œå°±æ˜¯ç­‰ , ç­‰æœ‰å¯ç”¨çš„çº¿ç¨‹,è¿™é‡Œæˆ‘ä¸ç†è§£ä¸ºå•¥ä¸ä½¿ç”¨é˜Ÿåˆ—... å…¶å®å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—çš„. 
        while ((availWorkers.size() &lt; 1) &amp;&amp; !isShutdown) {
            try {
                nextRunnableLock.wait(500);
            } catch (InterruptedException ignore) {
            }
        }

        if (!isShutdown) {
            // ç­‰åˆ°äº†, æ‹¿ç€ç¬¬ä¸€ä¸ªå¯ç”¨çº¿ç¨‹æ‰§è¡Œ 
            WorkerThread wt = (WorkerThread)availWorkers.removeFirst();
            busyWorkers.add(wt);
            wt.run(runnable);
        } else {
            // If the thread pool is going down, execute the Runnable
            // within a new additional worker thread (no thread from the pool).
            WorkerThread wt = new WorkerThread(this, threadGroup,
                    &quot;WorkerThread-LastJob&quot;, prio, isMakeThreadsDaemons(), runnable);
            busyWorkers.add(wt);
            workers.add(wt);
            wt.start();
        }
        // é‡Šæ”¾é”
        nextRunnableLock.notifyAll();
        handoffPending = false;
    }

    // è¿”å›OK , è¿™é‡Œå…¶å®æ˜¯å¼‚æ­¥çš„ , å› ä¸ºå¤„ç†æµç¨‹äº¤ç»™äº†å­çº¿ç¨‹, ä»–åªæ˜¯è¿”å›äº†ä»–å·²ç»å¤„ç†äº†, ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯çº¿ç¨‹å¤„ç†æ—¶é—´è¿‡é•¿, å°±ä¼šå½±å“å‘¨æœŸæ€§.(æ‰€ä»¥å»ºè®®è®¾ç½®å¤šç‚¹,ä½†æ˜¯ä¹Ÿä¸å¥½,çº¿ç¨‹ä¸€ç›´å¤„äºä¸æ–­è¿è¡Œé˜¶æ®µ)
    return true;
}

</code></pre>
<p>è°ƒç”¨  <code>wt.run(runnable);</code> -&gt; è°ƒç”¨<code>org.quartz.simpl.SimpleThreadPool.WorkerThread#run(java.lang.Runnable)</code> æ‰§è¡Œ runæ–¹æ³•</p>
<pre><code class="language-java">public void run(Runnable newRunnable) {
    synchronized(lock) {
        if(runnable != null) {
            throw new IllegalStateException(&quot;Already running a Runnable!&quot;);
        }

        runnable = newRunnable;
        lock.notifyAll();
    }
}
</code></pre>
<p>ç„¶åæ‰§è¡Œç­‰å¾…ç€çš„çº¿ç¨‹ä¸­ , æ­»æ­»çš„ç­‰å“‡ -&gt;  ç­‰ä¸‹é¢è¿™ä¸ªæ‰§è¡Œ ..</p>
<p><code>org.quartz.simpl.SimpleThreadPool.WorkerThread#run()</code>  æ¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹åˆå§‹åŒ–çš„æ—¶å€™éƒ½æ˜¯åœ¨è¿™é‡Œä¸€ç›´çš„ç­‰å¾…å“‡. ç­‰å“‡ç­‰ , ç­‰å“‡ç­‰.</p>
<pre><code class="language-java">@Override
public void run() {
    boolean ran = false;

    // è½¬ ....
    while (run.get()) {
        try {
            // åŒæ­¥ç­‰å¾…. 500ms , ç›´åˆ°æœ‰ runnable ... å¾ˆå¯æ€œ, å…¶å®åŸºæœ¬å¤§å¤šéƒ½æ˜¯è¿™ä¹ˆå®ç°çš„ eventloop
            synchronized(lock) {
                while (runnable == null &amp;&amp; run.get()) {
                    lock.wait(500);
                }

                if (runnable != null) {
                    ran = true;
                    // å¯åŠ¨ä»»åŠ¡, è¿™é‡Œç›´æ¥å°†Runnableå¯¹è±¡å¯åŠ¨, è€Œä¸æ˜¯new thread(runnable).start,è€Œæ˜¯ç›´æ¥è°ƒç”¨çš„æ–¹å¼. è®©è¿™ä¸ªçº¿ç¨‹å»å¤„ç†. 
                    runnable.run();
                }
            }
        } catch (InterruptedException unblock) {
            // do nothing (loop will terminate if shutdown() was called
            try {
                getLog().error(&quot;Worker thread was interrupt()'ed.&quot;, unblock);
            } catch(Exception e) {
                // ignore to help with a tomcat glitch
            }
        } catch (Throwable exceptionInRunnable) {
            try {
                getLog().error(&quot;Error while executing the Runnable: &quot;,
                    exceptionInRunnable);
            } catch(Exception e) {
                // ignore to help with a tomcat glitch
            }
        } finally {
            synchronized(lock) {
                runnable = null;
            }
            // repair the thread in case the runnable mucked it up...
            if(getPriority() != tp.getThreadPriority()) {
                setPriority(tp.getThreadPriority());
            }

            if (runOnce) {
                   run.set(false);
                clearFromBusyWorkersList(this);
            } else if(ran) {
                ran = false;
                makeAvailable(this);
            }
        }
    }

    //if (log.isDebugEnabled())
    try {
        getLog().debug(&quot;WorkerThread is shut down.&quot;);
    } catch(Exception e) {
        // ignore to help with a tomcat glitch
    }
}
</code></pre>
<h4 id="wait-ä½¿ç”¨">wait ä½¿ç”¨</h4>
<pre><code class="language-java">public class Demo {
    public static final Object OBJECT = new Object();

    public static void main(String[] args) throws InterruptedException {
        long start = System.currentTimeMillis();
        while (true) {
            synchronized (OBJECT) {
                System.out.println(&quot;time : &quot; + (System.currentTimeMillis() - start) + &quot;ms.&quot;);
                OBJECT.wait(1000L);
            }
        }
    }
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code class="language-java">time : 0ms.
time : 1000ms.
time : 2001ms.
time : 3002ms.
time : 4002ms.
time : 5003ms.
</code></pre>
<h2 id="10-æ€»ç»“">10. æ€»ç»“</h2>
<p>Quartzæ¡†æ¶åˆ†æäº†ä¸€æ³¢, ä¸»è¦å°±æ˜¯ç±»ä¼¼äºNIOçš„æ€æƒ³ , ä¸»çº¿ç¨‹ä¸æ–­çš„ç›‘å¬å’Œè½®è¯¢workerçº¿ç¨‹, åŒæ—¶è¿˜è¦ç›‘å¬Trigger , çœ‹çœ‹èƒ½ä¸èƒ½è§¦å‘äº†, å¯ä»¥äº†,æ‰¾ä¸ªé—²ç€çš„workçº¿ç¨‹å»å¤„ç†  ,  æ‰€ä»¥å°±æ˜¯NIOçš„æ€æƒ³.</p>
<p>ä½†æ˜¯æœ‰å‡ ä¸ªé—®é¢˜, å¦‚æœåˆå§‹åŒ–çº¿ç¨‹(workçº¿ç¨‹)è¿‡å¤š, é‚£ä¹ˆè¿™äº›çº¿ç¨‹åœ¨åˆå§‹åŒ–é˜¶æ®µå°±å·²ç»å¯åŠ¨äº† , æ‰€ä»¥å¾ˆæ¶ˆè€—CPUèµ„æº,</p>
<p>å¦‚æœåˆå§‹åŒ–çº¿ç¨‹(workçº¿ç¨‹)è¿‡å°‘  , é‚£ä¹ˆå°±å®¹æ˜“å‘ç”Ÿé˜»å¡çš„ç°è±¡, æ‰€ä»¥ ..................</p>
<p>ä»–çš„è®¾è®¡æ¶æ„è¿˜æ˜¯å¾ˆä¸é”™çš„ , å¯ä»¥è¯´æ˜¯è®¾è®¡æ¨¡å¼, æ•´ä½“çš„è®¾è®¡å®Œå…¨è§£è€¦ . ç›¸å½“nice.  å…¶å®å­¦ä¹ æ¡†æ¶å°±æ˜¯æé«˜è‡ªå·±çš„è®¾è®¡æ€æƒ³, ä¸æ–­çš„å­¦ä¹ ä¸æ–­çš„å‘ç°æ–°å¤§é™† .</p>

								<span id="footnote"></span>
								<div id="warn"></div>
							</div>
							<div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-schedulerfactory">1. SchedulerFactory</a></li>
<li><a href="#2-jobstore">2. JobStore</a></li>
<li><a href="#3-threadpool">3. ThreadPool</a></li>
<li><a href="#4-quartzschedulerresources">4. QuartzSchedulerResources</a></li>
<li><a href="#5-quartzscheduler">5. QuartzScheduler</a><br>
*
<ul>
<li><a href="#quartzschedulerresources">QuartzSchedulerResources</a></li>
<li><a href="#idlewaittime">idleWaitTime</a></li>
<li><a href="#dbretryinterval">dbRetryInterval</a></li>
</ul>
</li>
<li><a href="#6-dbconnectionmanager">6. DBConnectionManager</a></li>
<li><a href="#7-joblistener-%E5%92%8C-triggerlistener">7. JobListener å’Œ  TriggerListener</a></li>
<li><a href="#8-scheduler">8. Scheduler</a></li>
<li><a href="#9-%E6%A0%B8%E5%BF%83%E8%BF%90%E4%BD%9C%E6%B5%81%E7%A8%8B">9.  æ ¸å¿ƒè¿ä½œæµç¨‹ .</a><br>
*
<ul>
<li><a href="#wait-%E4%BD%BF%E7%94%A8">wait ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="#10-%E6%80%BB%E7%BB%93">10. æ€»ç»“</a></li>
</ul>
</li>
</ul>
</div>
						</div>
						<div id="fullPage"><canvas id="canvas"></canvas></div>
				</article>
				<div id="eof"><span>EOF</span></div>
				<div class="round-shape-one"></div>
				<section>
					<div class="doc_comments">
							<div id="valine-container"></div>
					</div>
				</section>
			</div>
		</div>
	</div>
	<script>
		"use strict";
		! function () {
			for (var n = document.getElementsByTagName("pre"), e = n.length, s = 0; s < e; s++) {
				n[s].innerHTML = '<span class="line-number"></span>' + n[s].innerHTML + '<span class="cl"></span>';
				for (var a = n[s].innerHTML.split(/\n/).length, r = 0; r < a - 1; r++) {
					n[s].getElementsByTagName("span")[0].innerHTML += "<span>" + (r + 1) + "</span>"
				}
			}
		}();
		let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");
		window.addEventListener("scroll", event => {
			let fromTop = window.scrollY;
			mainNavLinks.forEach((link, index) => {
				let section = document.getElementById(decodeURI(link.hash).substring(1));
				let nextSection = null
				if (mainNavLinks[index + 1]) {
					nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(
						1));
				}
				if (section.offsetTop <= fromTop) {
					if (nextSection) {
						if (nextSection.offsetTop > fromTop) {
							link.classList.add("currentToc");
						} else {
							link.classList.remove("currentToc");
						}
					} else {
						link.classList.add("currentToc");
					}
				} else {
					link.classList.remove("currentToc");
				}
			});
		});
		var list = document.querySelectorAll(".katex");
		for (var i = 0; i < list.length; i++) {
			list[i].style.display = "unset"
		};
		var h = document.documentElement,
			b = document.body,
			st = "scrollTop",
			sh = "scrollHeight",
			progress = document.querySelector(".progress"),
			scroll;
		document.addEventListener("scroll", function () {
			scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
			progress.style.setProperty("--scroll", scroll + "%")
		});
		var wxScale = new WxScale({
			fullPage: document.querySelector("#fullPage"),
			canvas: document.querySelector("#canvas")
		});
		var imgBox = document.querySelectorAll("#md_block img");
		for (var i = 0; i < imgBox.length; i++) {
			imgBox[i].onclick = function (e) {
				wxScale.start(this)
			}
		};
	</script>
	<style>
		#magnifyImg {
			position: fixed;
			left: 0;
			top: 0;
			text-align: center;
			width: 100%;
			display: none;
			z-index: 9999
		}

		#magnifyImg img {
			object-fit: contain;
			background: #eaecef;
			padding: 15px;
			border-radius: 10px;
			height: auto;
			width: auto;
			vertical-align: middle
		}
	</style>
	<a id="scrollUp"href="#top"style="position: fixed; z-index: 2147483647; display: block;"></a><div class="footer animated fadeInDown"><div class="site_footer"><div class="mysocials"><div class="my_socials"><a href="https://github.com/Anthony-Dong"title="github"><i class="iconfont icon-github"></i></a><a href="fanhaodong516@gmail.com"title="envelope"><i class="iconfont icon-envelope"></i></a></div></div><div class="copyright"id="copyright">You Are My Everything. <a href="mailto:574986060@qq.com" target="blank">Send Email</a>CopyrightÂ©2018-2020<a href="https://anthony-dong.github.io"style="margin:0;">Serence</a>.</div><span style="display: inline;margin-right:15px;">ğŸ‘<strong><span id="count-page">168271</span></strong></span><span id="busuanzi_container_page_pv"style="display: inline;"><span>ğŸ“š<strong>186</strong>posts</span></div></div><script>console.log("\n %c \u26a1Anthony-Dong's Blog:https://anthony-dong.gitee.io ,Github:https://github.com/Anthony-Dong ,Email:574986060@qq.com ,æœ‰äº‹æƒ…æ¬¢è¿è”ç³». \n\n","color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;",);</script>
	<script type="text/javascript" async src="https://anthony-dong.github.io/media/js/prism.js"></script>
</body>
</html>